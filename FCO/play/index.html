<!DOCTYPE html>
<html data-init="no-js">
<head>
<meta charset="UTF-8" />
<title>Free Cities: Origins</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!--

SugarCube (v2.36.1): A free (gratis and libre) story format.

Copyright © 2013–2021 Thomas Michael Edwards <thomasmedwards@gmail.com>.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->
<script id="script-libraries" type="text/javascript">
if(document.head&&document.addEventListener&&document.querySelector&&Object.create&&Object.freeze&&JSON){document.documentElement.setAttribute("data-init", "loading");
/*! @source http://purl.eligrey.com/github/classList.js/blob/1.2.20171210/classList.js */
"document"in self&&("classList"in document.createElement("_")&&(!document.createElementNS||"classList"in document.createElementNS("http://www.w3.org/2000/svg","g"))||!function(t){"use strict";if("Element"in t){var e="classList",n="prototype",i=t.Element[n],s=Object,r=String[n].trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array[n].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},c=function(t,e){this.name=t,this.code=DOMException[t],this.message=e},a=function(t,e){if(""===e)throw new c("SYNTAX_ERR","The token must not be empty.");if(/\s/.test(e))throw new c("INVALID_CHARACTER_ERR","The token must not contain space characters.");return o.call(t,e)},l=function(t){for(var e=r.call(t.getAttribute("class")||""),n=e?e.split(/\s+/):[],i=0,s=n.length;s>i;i++)this.push(n[i]);this._updateClassName=function(){t.setAttribute("class",this.toString())}},u=l[n]=[],h=function(){return new l(this)};if(c[n]=Error[n],u.item=function(t){return this[t]||null},u.contains=function(t){return~a(this,t+"")},u.add=function(){var t,e=arguments,n=0,i=e.length,s=!1;do t=e[n]+"",~a(this,t)||(this.push(t),s=!0);while(++n<i);s&&this._updateClassName()},u.remove=function(){var t,e,n=arguments,i=0,s=n.length,r=!1;do for(t=n[i]+"",e=a(this,t);~e;)this.splice(e,1),r=!0,e=a(this,t);while(++i<s);r&&this._updateClassName()},u.toggle=function(t,e){var n=this.contains(t),i=n?e!==!0&&"remove":e!==!1&&"add";return i&&this[i](t),e===!0||e===!1?e:!n},u.replace=function(t,e){var n=a(t+"");~n&&(this.splice(n,1,e),this._updateClassName())},u.toString=function(){return this.join(" ")},s.defineProperty){var f={get:h,enumerable:!0,configurable:!0};try{s.defineProperty(i,e,f)}catch(p){void 0!==p.number&&-2146823252!==p.number||(f.enumerable=!1,s.defineProperty(i,e,f))}}else s[n].__defineGetter__&&i.__defineGetter__(e,h)}}(self),function(){"use strict";var t=document.createElement("_");if(t.classList.add("c1","c2"),!t.classList.contains("c2")){var e=function(t){var e=DOMTokenList.prototype[t];DOMTokenList.prototype[t]=function(t){var n,i=arguments.length;for(n=0;i>n;n++)t=arguments[n],e.call(this,t)}};e("add"),e("remove")}if(t.classList.toggle("c3",!1),t.classList.contains("c3")){var n=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(t,e){return 1 in arguments&&!this.contains(t)==!e?e:n.call(this,t)}}"replace"in document.createElement("_").classList||(DOMTokenList.prototype.replace=function(t,e){var n=this.toString().split(" "),i=n.indexOf(t+"");~i&&(n=n.slice(i),this.remove.apply(this,n),this.add(e),this.add.apply(this,n.slice(1)))}),t=null}());
/*!
 * https://github.com/es-shims/es5-shim
 * @license es5-shim Copyright 2009-2020 by contributors, MIT License
 * see https://github.com/es-shims/es5-shim/blob/v4.5.14/LICENSE
 */
(function(t,r){"use strict";if(typeof define==="function"&&define.amd){define(r)}else if(typeof exports==="object"){module.exports=r()}else{t.returnExports=r()}})(this,function(){var t=Array;var r=t.prototype;var e=Object;var n=e.prototype;var i=Function;var a=i.prototype;var o=String;var f=o.prototype;var u=Number;var l=u.prototype;var s=r.slice;var c=r.splice;var v=r.push;var h=r.unshift;var p=r.concat;var y=r.join;var d=a.call;var g=a.apply;var w=Math.max;var b=Math.min;var T=n.toString;var m=typeof Symbol==="function"&&typeof Symbol.toStringTag==="symbol";var D;var S=Function.prototype.toString,x=/^\s*class /,O=function isES6ClassFn(t){try{var r=S.call(t);var e=r.replace(/\/\/.*\n/g,"");var n=e.replace(/\/\*[.\s\S]*\*\//g,"");var i=n.replace(/\n/gm," ").replace(/ {2}/g," ");return x.test(i)}catch(a){return false}},E=function tryFunctionObject(t){try{if(O(t)){return false}S.call(t);return true}catch(r){return false}},j="[object Function]",I="[object GeneratorFunction]",D=function isCallable(t){if(!t){return false}if(typeof t!=="function"&&typeof t!=="object"){return false}if(m){return E(t)}if(O(t)){return false}var r=T.call(t);return r===j||r===I};var M;var U=RegExp.prototype.exec,$=function tryRegexExec(t){try{U.call(t);return true}catch(r){return false}},F="[object RegExp]";M=function isRegex(t){if(typeof t!=="object"){return false}return m?$(t):T.call(t)===F};var N;var C=String.prototype.valueOf,k=function tryStringObject(t){try{C.call(t);return true}catch(r){return false}},A="[object String]";N=function isString(t){if(typeof t==="string"){return true}if(typeof t!=="object"){return false}return m?k(t):T.call(t)===A};var R=e.defineProperty&&function(){try{var t={};e.defineProperty(t,"x",{enumerable:false,value:t});for(var r in t){return false}return t.x===t}catch(n){return false}}();var P=function(t){var r;if(R){r=function(t,r,n,i){if(!i&&r in t){return}e.defineProperty(t,r,{configurable:true,enumerable:false,writable:true,value:n})}}else{r=function(t,r,e,n){if(!n&&r in t){return}t[r]=e}}return function defineProperties(e,n,i){for(var a in n){if(t.call(n,a)){r(e,a,n[a],i)}}}}(n.hasOwnProperty);var J=function isPrimitive(t){var r=typeof t;return t===null||r!=="object"&&r!=="function"};var Y=u.isNaN||function isActualNaN(t){return t!==t};var z={ToInteger:function ToInteger(t){var r=+t;if(Y(r)){r=0}else if(r!==0&&r!==1/0&&r!==-(1/0)){r=(r>0||-1)*Math.floor(Math.abs(r))}return r},ToPrimitive:function ToPrimitive(t){var r,e,n;if(J(t)){return t}e=t.valueOf;if(D(e)){r=e.call(t);if(J(r)){return r}}n=t.toString;if(D(n)){r=n.call(t);if(J(r)){return r}}throw new TypeError},ToObject:function(t){if(t==null){throw new TypeError("can't convert "+t+" to object")}return e(t)},ToUint32:function ToUint32(t){return t>>>0}};var Z=function Empty(){};P(a,{bind:function bind(t){var r=this;if(!D(r)){throw new TypeError("Function.prototype.bind called on incompatible "+r)}var n=s.call(arguments,1);var a;var o=function(){if(this instanceof a){var i=g.call(r,this,p.call(n,s.call(arguments)));if(e(i)===i){return i}return this}else{return g.call(r,t,p.call(n,s.call(arguments)))}};var f=w(0,r.length-n.length);var u=[];for(var l=0;l<f;l++){v.call(u,"$"+l)}a=i("binder","return function ("+y.call(u,",")+"){ return binder.apply(this, arguments); }")(o);if(r.prototype){Z.prototype=r.prototype;a.prototype=new Z;Z.prototype=null}return a}});var G=d.bind(n.hasOwnProperty);var H=d.bind(n.toString);var W=d.bind(s);var B=g.bind(s);if(typeof document==="object"&&document&&document.documentElement){try{W(document.documentElement.childNodes)}catch(X){var L=W;var q=B;W=function arraySliceIE(t){var r=[];var e=t.length;while(e-- >0){r[e]=t[e]}return q(r,L(arguments,1))};B=function arraySliceApplyIE(t,r){return q(W(t),r)}}}var K=d.bind(f.slice);var Q=d.bind(f.split);var V=d.bind(f.indexOf);var _=d.bind(v);var tt=d.bind(n.propertyIsEnumerable);var rt=d.bind(r.sort);var et=t.isArray||function isArray(t){return H(t)==="[object Array]"};var nt=[].unshift(0)!==1;P(r,{unshift:function(){h.apply(this,arguments);return this.length}},nt);P(t,{isArray:et});var it=e("a");var at=it[0]!=="a"||!(0 in it);var ot=function properlyBoxed(t){var r=true;var e=true;var n=false;if(t){try{t.call("foo",function(t,e,n){if(typeof n!=="object"){r=false}});t.call([1],function(){"use strict";e=typeof this==="string"},"x")}catch(i){n=true}}return!!t&&!n&&r&&e};P(r,{forEach:function forEach(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=-1;var i=z.ToUint32(e.length);var a;if(arguments.length>1){a=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.forEach callback must be a function")}while(++n<i){if(n in e){if(typeof a==="undefined"){t(e[n],n,r)}else{t.call(a,e[n],n,r)}}}}},!ot(r.forEach));P(r,{map:function map(r){var e=z.ToObject(this);var n=at&&N(this)?Q(this,""):e;var i=z.ToUint32(n.length);var a=t(i);var o;if(arguments.length>1){o=arguments[1]}if(!D(r)){throw new TypeError("Array.prototype.map callback must be a function")}for(var f=0;f<i;f++){if(f in n){if(typeof o==="undefined"){a[f]=r(n[f],f,e)}else{a[f]=r.call(o,n[f],f,e)}}}return a}},!ot(r.map));P(r,{filter:function filter(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i=[];var a;var o;if(arguments.length>1){o=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.filter callback must be a function")}for(var f=0;f<n;f++){if(f in e){a=e[f];if(typeof o==="undefined"?t(a,f,r):t.call(o,a,f,r)){_(i,a)}}}return i}},!ot(r.filter));P(r,{every:function every(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.every callback must be a function")}for(var a=0;a<n;a++){if(a in e&&!(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return false}}return true}},!ot(r.every));P(r,{some:function some(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.some callback must be a function")}for(var a=0;a<n;a++){if(a in e&&(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return true}}return false}},!ot(r.some));var ft=false;if(r.reduce){ft=typeof r.reduce.call("es5",function(t,r,e,n){return n})==="object"}P(r,{reduce:function reduce(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduce callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduce of empty array with no initial value")}var i=0;var a;if(arguments.length>=2){a=arguments[1]}else{do{if(i in e){a=e[i++];break}if(++i>=n){throw new TypeError("reduce of empty array with no initial value")}}while(true)}for(;i<n;i++){if(i in e){a=t(a,e[i],i,r)}}return a}},!ft);var ut=false;if(r.reduceRight){ut=typeof r.reduceRight.call("es5",function(t,r,e,n){return n})==="object"}P(r,{reduceRight:function reduceRight(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduceRight callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduceRight of empty array with no initial value")}var i;var a=n-1;if(arguments.length>=2){i=arguments[1]}else{do{if(a in e){i=e[a--];break}if(--a<0){throw new TypeError("reduceRight of empty array with no initial value")}}while(true)}if(a<0){return i}do{if(a in e){i=t(i,e[a],a,r)}}while(a--);return i}},!ut);var lt=r.indexOf&&[0,1].indexOf(1,2)!==-1;P(r,{indexOf:function indexOf(t){var r=at&&N(this)?Q(this,""):z.ToObject(this);var e=z.ToUint32(r.length);if(e===0){return-1}var n=0;if(arguments.length>1){n=z.ToInteger(arguments[1])}n=n>=0?n:w(0,e+n);for(;n<e;n++){if(n in r&&r[n]===t){return n}}return-1}},lt);var st=r.lastIndexOf&&[0,1].lastIndexOf(0,-3)!==-1;P(r,{lastIndexOf:function lastIndexOf(t){var r=at&&N(this)?Q(this,""):z.ToObject(this);var e=z.ToUint32(r.length);if(e===0){return-1}var n=e-1;if(arguments.length>1){n=b(n,z.ToInteger(arguments[1]))}n=n>=0?n:e-Math.abs(n);for(;n>=0;n--){if(n in r&&t===r[n]){return n}}return-1}},st);var ct=function(){var t=[1,2];var r=t.splice();return t.length===2&&et(r)&&r.length===0}();P(r,{splice:function splice(t,r){if(arguments.length===0){return[]}else{return c.apply(this,arguments)}}},!ct);var vt=function(){var t={};r.splice.call(t,0,0,1);return t.length===1}();P(r,{splice:function splice(t,r){if(arguments.length===0){return[]}var e=arguments;this.length=w(z.ToInteger(this.length),0);if(arguments.length>0&&typeof r!=="number"){e=W(arguments);if(e.length<2){_(e,this.length-t)}else{e[1]=z.ToInteger(r)}}return c.apply(this,e)}},!vt);var ht=function(){var r=new t(1e5);r[8]="x";r.splice(1,1);return r.indexOf("x")===7}();var pt=function(){var t=256;var r=[];r[t]="a";r.splice(t+1,0,"b");return r[t]==="a"}();P(r,{splice:function splice(t,r){var e=z.ToObject(this);var n=[];var i=z.ToUint32(e.length);var a=z.ToInteger(t);var f=a<0?w(i+a,0):b(a,i);var u=arguments.length===0?0:arguments.length===1?i-f:b(w(z.ToInteger(r),0),i-f);var l=0;var s;while(l<u){s=o(f+l);if(G(e,s)){n[l]=e[s]}l+=1}var c=W(arguments,2);var v=c.length;var h;if(v<u){l=f;var p=i-u;while(l<p){s=o(l+u);h=o(l+v);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l+=1}l=i;var y=i-u+v;while(l>y){delete e[l-1];l-=1}}else if(v>u){l=i-u;while(l>f){s=o(l+u-1);h=o(l+v-1);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l-=1}}l=f;for(var d=0;d<c.length;++d){e[l]=c[d];l+=1}e.length=i-u+v;return n}},!ht||!pt);var yt=r.join;var dt;try{dt=Array.prototype.join.call("123",",")!=="1,2,3"}catch(X){dt=true}if(dt){P(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return yt.call(N(this)?Q(this,""):this,r)}},dt)}var gt=[1,2].join(undefined)!=="1,2";if(gt){P(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return yt.call(this,r)}},gt)}var wt=function push(t){var r=z.ToObject(this);var e=z.ToUint32(r.length);var n=0;while(n<arguments.length){r[e+n]=arguments[n];n+=1}r.length=e+n;return e+n};var bt=function(){var t={};var r=Array.prototype.push.call(t,undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();P(r,{push:function push(t){if(et(this)){return v.apply(this,arguments)}return wt.apply(this,arguments)}},bt);var Tt=function(){var t=[];var r=t.push(undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();P(r,{push:wt},Tt);P(r,{slice:function(t,r){var e=N(this)?Q(this,""):this;return B(e,arguments)}},at);var mt=function(){try{[1,2].sort(null)}catch(t){try{[1,2].sort({})}catch(r){return false}}return true}();var Dt=function(){try{[1,2].sort(/a/);return false}catch(t){}return true}();var St=function(){try{[1,2].sort(undefined);return true}catch(t){}return false}();P(r,{sort:function sort(t){if(typeof t==="undefined"){return rt(this)}if(!D(t)){throw new TypeError("Array.prototype.sort callback must be a function")}return rt(this,t)}},mt||!St||!Dt);var xt=!tt({toString:null},"toString");var Ot=tt(function(){},"prototype");var Et=!G("x","0");var jt=function(t){var r=t.constructor;return r&&r.prototype===t};var It={$applicationCache:true,$console:true,$external:true,$frame:true,$frameElement:true,$frames:true,$innerHeight:true,$innerWidth:true,$onmozfullscreenchange:true,$onmozfullscreenerror:true,$outerHeight:true,$outerWidth:true,$pageXOffset:true,$pageYOffset:true,$parent:true,$scrollLeft:true,$scrollTop:true,$scrollX:true,$scrollY:true,$self:true,$webkitIndexedDB:true,$webkitStorageInfo:true,$window:true,$width:true,$height:true,$top:true,$localStorage:true};var Mt=function(){if(typeof window==="undefined"){return false}for(var t in window){try{if(!It["$"+t]&&G(window,t)&&window[t]!==null&&typeof window[t]==="object"){jt(window[t])}}catch(r){return true}}return false}();var Ut=function(t){if(typeof window==="undefined"||!Mt){return jt(t)}try{return jt(t)}catch(r){return false}};var $t=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];var Ft=$t.length;var Nt=function isArguments(t){return H(t)==="[object Arguments]"};var Ct=function isArguments(t){return t!==null&&typeof t==="object"&&typeof t.length==="number"&&t.length>=0&&!et(t)&&D(t.callee)};var kt=Nt(arguments)?Nt:Ct;P(e,{keys:function keys(t){var r=D(t);var e=kt(t);var n=t!==null&&typeof t==="object";var i=n&&N(t);if(!n&&!r&&!e){throw new TypeError("Object.keys called on a non-object")}var a=[];var f=Ot&&r;if(i&&Et||e){for(var u=0;u<t.length;++u){_(a,o(u))}}if(!e){for(var l in t){if(!(f&&l==="prototype")&&G(t,l)){_(a,o(l))}}}if(xt){var s=Ut(t);for(var c=0;c<Ft;c++){var v=$t[c];if(!(s&&v==="constructor")&&G(t,v)){_(a,v)}}}return a}});var At=e.keys&&function(){return e.keys(arguments).length===2}(1,2);var Rt=e.keys&&function(){var t=e.keys(arguments);return arguments.length!==1||t.length!==1||t[0]!==1}(1);var Pt=e.keys;P(e,{keys:function keys(t){if(kt(t)){return Pt(W(t))}else{return Pt(t)}}},!At||Rt);var Jt=new Date(-0xc782b5b342b24).getUTCMonth()!==0;var Yt=new Date(-0x55d318d56a724);var zt=new Date(14496624e5);var Zt=Yt.toUTCString()!=="Mon, 01 Jan -45875 11:59:59 GMT";var Gt;var Ht;var Wt=Yt.getTimezoneOffset();if(Wt<-720){Gt=Yt.toDateString()!=="Tue Jan 02 -45875";Ht=!/^Thu Dec 10 2015 \d\d:\d\d:\d\d GMT[-+]\d\d\d\d(?: |$)/.test(String(zt))}else{Gt=Yt.toDateString()!=="Mon Jan 01 -45875";Ht=!/^Wed Dec 09 2015 \d\d:\d\d:\d\d GMT[-+]\d\d\d\d(?: |$)/.test(String(zt))}var Bt=d.bind(Date.prototype.getFullYear);var Xt=d.bind(Date.prototype.getMonth);var Lt=d.bind(Date.prototype.getDate);var qt=d.bind(Date.prototype.getUTCFullYear);var Kt=d.bind(Date.prototype.getUTCMonth);var Qt=d.bind(Date.prototype.getUTCDate);var Vt=d.bind(Date.prototype.getUTCDay);var _t=d.bind(Date.prototype.getUTCHours);var tr=d.bind(Date.prototype.getUTCMinutes);var rr=d.bind(Date.prototype.getUTCSeconds);var er=d.bind(Date.prototype.getUTCMilliseconds);var nr=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var ir=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var ar=function daysInMonth(t,r){return Lt(new Date(r,t,0))};P(Date.prototype,{getFullYear:function getFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);if(t<0&&Xt(this)>11){return t+1}return t},getMonth:function getMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Xt(this);if(t<0&&r>11){return 0}return r},getDate:function getDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Xt(this);var e=Lt(this);if(t<0&&r>11){if(r===12){return e}var n=ar(0,t+1);return n-e+1}return e},getUTCFullYear:function getUTCFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);if(t<0&&Kt(this)>11){return t+1}return t},getUTCMonth:function getUTCMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);var r=Kt(this);if(t<0&&r>11){return 0}return r},getUTCDate:function getUTCDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);var r=Kt(this);var e=Qt(this);if(t<0&&r>11){if(r===12){return e}var n=ar(0,t+1);return n-e+1}return e}},Jt);P(Date.prototype,{toUTCString:function toUTCString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Vt(this);var r=Qt(this);var e=Kt(this);var n=qt(this);var i=_t(this);var a=tr(this);var o=rr(this);return nr[t]+", "+(r<10?"0"+r:r)+" "+ir[e]+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"}},Jt||Zt);P(Date.prototype,{toDateString:function toDateString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();return nr[t]+" "+ir[e]+" "+(r<10?"0"+r:r)+" "+n}},Jt||Gt);if(Jt||Ht){Date.prototype.toString=function toString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();var i=this.getHours();var a=this.getMinutes();var o=this.getSeconds();var f=this.getTimezoneOffset();var u=Math.floor(Math.abs(f)/60);var l=Math.floor(Math.abs(f)%60);return nr[t]+" "+ir[e]+" "+(r<10?"0"+r:r)+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"+(f>0?"-":"+")+(u<10?"0"+u:u)+(l<10?"0"+l:l)};if(R){e.defineProperty(Date.prototype,"toString",{configurable:true,enumerable:false,writable:true})}}var or=-621987552e5;var fr="-000001";var ur=Date.prototype.toISOString&&new Date(or).toISOString().indexOf(fr)===-1;var lr=Date.prototype.toISOString&&new Date(-1).toISOString()!=="1969-12-31T23:59:59.999Z";var sr=d.bind(Date.prototype.getTime);P(Date.prototype,{toISOString:function toISOString(){if(!isFinite(this)||!isFinite(sr(this))){throw new RangeError("Date.prototype.toISOString called on non-finite value.")}var t=qt(this);var r=Kt(this);t+=Math.floor(r/12);r=(r%12+12)%12;var e=[r+1,Qt(this),_t(this),tr(this),rr(this)];t=(t<0?"-":t>9999?"+":"")+K("00000"+Math.abs(t),0<=t&&t<=9999?-4:-6);for(var n=0;n<e.length;++n){e[n]=K("00"+e[n],-2)}return t+"-"+W(e,0,2).join("-")+"T"+W(e,2).join(":")+"."+K("000"+er(this),-3)+"Z"}},ur||lr);var cr=function(){try{return Date.prototype.toJSON&&new Date(NaN).toJSON()===null&&new Date(or).toJSON().indexOf(fr)!==-1&&Date.prototype.toJSON.call({toISOString:function(){return true}})}catch(t){return false}}();if(!cr){Date.prototype.toJSON=function toJSON(t){var r=e(this);var n=z.ToPrimitive(r);if(typeof n==="number"&&!isFinite(n)){return null}var i=r.toISOString;if(!D(i)){throw new TypeError("toISOString property is not callable")}return i.call(r)}}var vr=Date.parse("+033658-09-27T01:46:40.000Z")===1e15;var hr=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z"))||!isNaN(Date.parse("2012-12-31T23:59:60.000Z"));var pr=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));if(pr||hr||!vr){var yr=Math.pow(2,31)-1;var dr=Y(new Date(1970,0,1,0,0,0,yr+1).getTime());Date=function(t){var r=function Date(e,n,i,a,f,u,l){var s=arguments.length;var c;if(this instanceof t){var v=u;var h=l;if(dr&&s>=7&&l>yr){var p=Math.floor(l/yr)*yr;var y=Math.floor(p/1e3);v+=y;h-=y*1e3}c=s===1&&o(e)===e?new t(r.parse(e)):s>=7?new t(e,n,i,a,f,v,h):s>=6?new t(e,n,i,a,f,v):s>=5?new t(e,n,i,a,f):s>=4?new t(e,n,i,a):s>=3?new t(e,n,i):s>=2?new t(e,n):s>=1?new t(e instanceof t?+e:e):new t}else{c=t.apply(this,arguments)}if(!J(c)){P(c,{constructor:r},true)}return c};var e=new RegExp("^"+"(\\d{4}|[+-]\\d{6})"+"(?:-(\\d{2})"+"(?:-(\\d{2})"+"(?:"+"T(\\d{2})"+":(\\d{2})"+"(?:"+":(\\d{2})"+"(?:(\\.\\d{1,}))?"+")?"+"("+"Z|"+"(?:"+"([-+])"+"(\\d{2})"+":(\\d{2})"+")"+")?)?)?)?"+"$");var n=[0,31,59,90,120,151,181,212,243,273,304,334,365];var i=function dayFromMonth(t,r){var e=r>1?1:0;return n[r]+Math.floor((t-1969+e)/4)-Math.floor((t-1901+e)/100)+Math.floor((t-1601+e)/400)+365*(t-1970)};var a=function toUTC(r){var e=0;var n=r;if(dr&&n>yr){var i=Math.floor(n/yr)*yr;var a=Math.floor(i/1e3);e+=a;n-=a*1e3}return u(new t(1970,0,1,0,0,e,n))};for(var f in t){if(G(t,f)){r[f]=t[f]}}P(r,{now:t.now,UTC:t.UTC},true);r.prototype=t.prototype;P(r.prototype,{constructor:r},true);var l=function parse(r){var n=e.exec(r);if(n){var o=u(n[1]),f=u(n[2]||1)-1,l=u(n[3]||1)-1,s=u(n[4]||0),c=u(n[5]||0),v=u(n[6]||0),h=Math.floor(u(n[7]||0)*1e3),p=Boolean(n[4]&&!n[8]),y=n[9]==="-"?1:-1,d=u(n[10]||0),g=u(n[11]||0),w;var b=c>0||v>0||h>0;if(s<(b?24:25)&&c<60&&v<60&&h<1e3&&f>-1&&f<12&&d<24&&g<60&&l>-1&&l<i(o,f+1)-i(o,f)){w=((i(o,f)+l)*24+s+d*y)*60;w=((w+c+g*y)*60+v)*1e3+h;if(p){w=a(w)}if(-864e13<=w&&w<=864e13){return w}}return NaN}return t.parse.apply(this,arguments)};P(r,{parse:l});return r}(Date)}if(!Date.now){Date.now=function now(){return(new Date).getTime()}}var gr=l.toFixed&&(8e-5.toFixed(3)!=="0.000"||.9.toFixed(0)!=="1"||1.255.toFixed(2)!=="1.25"||(1000000000000000128).toFixed(0)!=="1000000000000000128");var wr={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function multiply(t,r){var e=-1;var n=r;while(++e<wr.size){n+=t*wr.data[e];wr.data[e]=n%wr.base;n=Math.floor(n/wr.base)}},divide:function divide(t){var r=wr.size;var e=0;while(--r>=0){e+=wr.data[r];wr.data[r]=Math.floor(e/t);e=e%t*wr.base}},numToString:function numToString(){var t=wr.size;var r="";while(--t>=0){if(r!==""||t===0||wr.data[t]!==0){var e=o(wr.data[t]);if(r===""){r=e}else{r+=K("0000000",0,7-e.length)+e}}}return r},pow:function pow(t,r,e){return r===0?e:r%2===1?pow(t,r-1,e*t):pow(t*t,r/2,e)},log:function log(t){var r=0;var e=t;while(e>=4096){r+=12;e/=4096}while(e>=2){r+=1;e/=2}return r}};var br=function toFixed(t){var r,e,n,i,a,f,l,s;r=u(t);r=Y(r)?0:Math.floor(r);if(r<0||r>20){throw new RangeError("Number.toFixed called with invalid number of decimals")}e=u(this);if(Y(e)){return"NaN"}if(e<=-1e21||e>=1e21){return o(e)}n="";if(e<0){n="-";e=-e}i="0";if(e>1e-21){a=wr.log(e*wr.pow(2,69,1))-69;f=a<0?e*wr.pow(2,-a,1):e/wr.pow(2,a,1);f*=4503599627370496;a=52-a;if(a>0){wr.multiply(0,f);l=r;while(l>=7){wr.multiply(1e7,0);l-=7}wr.multiply(wr.pow(10,l,1),0);l=a-1;while(l>=23){wr.divide(1<<23);l-=23}wr.divide(1<<l);wr.multiply(1,1);wr.divide(2);i=wr.numToString()}else{wr.multiply(0,f);wr.multiply(1<<-a,0);i=wr.numToString()+K("0.00000000000000000000",2,2+r)}}if(r>0){s=i.length;if(s<=r){i=n+K("0.0000000000000000000",0,r-s+2)+i}else{i=n+K(i,0,s-r)+"."+K(i,s-r)}}else{i=n+i}return i};P(l,{toFixed:br},gr);var Tr=function(){try{return 1..toPrecision(undefined)==="1"}catch(t){return true}}();var mr=l.toPrecision;P(l,{toPrecision:function toPrecision(t){return typeof t==="undefined"?mr.call(this):mr.call(this,t)}},Tr);if("ab".split(/(?:ab)*/).length!==2||".".split(/(.?)(.?)/).length!==4||"tesst".split(/(s)*/)[1]==="t"||"test".split(/(?:)/,-1).length!==4||"".split(/.?/).length||".".split(/()()/).length>1){(function(){var t=typeof/()??/.exec("")[1]==="undefined";var r=Math.pow(2,32)-1;f.split=function(e,n){var i=String(this);if(typeof e==="undefined"&&n===0){return[]}if(!M(e)){return Q(this,e,n)}var a=[];var o=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),f=0,u,l,s,c;var h=new RegExp(e.source,o+"g");if(!t){u=new RegExp("^"+h.source+"$(?!\\s)",o)}var p=typeof n==="undefined"?r:z.ToUint32(n);l=h.exec(i);while(l){s=l.index+l[0].length;if(s>f){_(a,K(i,f,l.index));if(!t&&l.length>1){l[0].replace(u,function(){for(var t=1;t<arguments.length-2;t++){if(typeof arguments[t]==="undefined"){l[t]=void 0}}})}if(l.length>1&&l.index<i.length){v.apply(a,W(l,1))}c=l[0].length;f=s;if(a.length>=p){break}}if(h.lastIndex===l.index){h.lastIndex++}l=h.exec(i)}if(f===i.length){if(c||!h.test("")){_(a,"")}}else{_(a,K(i,f))}return a.length>p?W(a,0,p):a}})()}else if("0".split(void 0,0).length){f.split=function split(t,r){if(typeof t==="undefined"&&r===0){return[]}return Q(this,t,r)}}var Dr=f.replace;var Sr=function(){var t=[];"x".replace(/x(.)?/g,function(r,e){_(t,e)});return t.length===1&&typeof t[0]==="undefined"}();if(!Sr){f.replace=function replace(t,r){var e=D(r);var n=M(t)&&/\)[*?]/.test(t.source);if(!e||!n){return Dr.call(this,t,r)}else{var i=function(e){var n=arguments.length;var i=t.lastIndex;t.lastIndex=0;var a=t.exec(e)||[];t.lastIndex=i;_(a,arguments[n-2],arguments[n-1]);return r.apply(this,a)};return Dr.call(this,t,i)}}}var xr=f.substr;var Or="".substr&&"0b".substr(-1)!=="b";P(f,{substr:function substr(t,r){var e=t;if(t<0){e=w(this.length+t,0)}return xr.call(this,e,r)}},Or);var Er="\t\n\x0B\f\r \xa0\u1680\u2000\u2001\u2002\u2003"+"\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028"+"\u2029\ufeff";var jr="\u200b";var Ir="["+Er+"]";var Mr=new RegExp("^"+Ir+Ir+"*");var Ur=new RegExp(Ir+Ir+"*$");var $r=f.trim&&(Er.trim()||!jr.trim());P(f,{trim:function trim(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}return o(this).replace(Mr,"").replace(Ur,"")}},$r);var Fr=d.bind(String.prototype.trim);var Nr=f.lastIndexOf&&"abc\u3042\u3044".lastIndexOf("\u3042\u3044",2)!==-1;P(f,{lastIndexOf:function lastIndexOf(t){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var r=o(this);var e=o(t);var n=arguments.length>1?u(arguments[1]):NaN;var i=Y(n)?Infinity:z.ToInteger(n);var a=b(w(i,0),r.length);var f=e.length;var l=a+f;while(l>0){l=w(0,l-f);var s=V(K(r,l,a+f),e);if(s!==-1){return l+s}}return-1}},Nr);var Cr=f.lastIndexOf;P(f,{lastIndexOf:function lastIndexOf(t){return Cr.apply(this,arguments)}},f.lastIndexOf.length!==1);if(parseInt(Er+"08")!==8||parseInt(Er+"0x16")!==22){parseInt=function(t){var r=/^[-+]?0[xX]/;return function parseInt(e,n){if(typeof e==="symbol"){""+e}var i=Fr(String(e));var a=u(n)||(r.test(i)?16:10);return t(i,a)}}(parseInt)}if(1/parseFloat("-0")!==-Infinity){parseFloat=function(t){return function parseFloat(r){var e=Fr(String(r));var n=t(e);return n===0&&K(e,0,1)==="-"?-0:n}}(parseFloat)}if(String(new RangeError("test"))!=="RangeError: test"){var kr=function toString(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var t=this.name;if(typeof t==="undefined"){t="Error"}else if(typeof t!=="string"){t=o(t)}var r=this.message;if(typeof r==="undefined"){r=""}else if(typeof r!=="string"){r=o(r)}if(!t){return r}if(!r){return t}return t+": "+r};Error.prototype.toString=kr}if(R){var Ar=function(t,r){if(tt(t,r)){var e=Object.getOwnPropertyDescriptor(t,r);if(e.configurable){e.enumerable=false;Object.defineProperty(t,r,e)}}};Ar(Error.prototype,"message");if(Error.prototype.message!==""){Error.prototype.message=""}Ar(Error.prototype,"name")}if(String(/a/gim)!=="/a/gim"){var Rr=function toString(){var t="/"+this.source+"/";if(this.global){t+="g"}if(this.ignoreCase){t+="i"}if(this.multiline){t+="m"}return t};RegExp.prototype.toString=Rr}});
/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.4
 * see https://github.com/paulmillr/es6-shim/blob/0.35.4/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
(function(e,t){if(typeof define==="function"&&define.amd){define(t)}else if(typeof exports==="object"){module.exports=t()}else{e.returnExports=t()}})(this,function(){"use strict";var e=Function.call.bind(Function.apply);var t=Function.call.bind(Function.call);var r=Array.isArray;var n=Object.keys;var o=function notThunker(t){return function notThunk(){return!e(t,this,arguments)}};var i=function(e){try{e();return false}catch(t){return true}};var a=function valueOrFalseIfThrows(e){try{return e()}catch(t){return false}};var u=o(i);var f=function(){return!i(function(){return Object.defineProperty({},"x",{get:function(){}})})};var s=!!Object.defineProperty&&f();var c=function foo(){}.name==="foo";var l=Function.call.bind(Array.prototype.forEach);var p=Function.call.bind(Array.prototype.reduce);var v=Function.call.bind(Array.prototype.filter);var y=Function.call.bind(Array.prototype.some);var h=function(e,t,r,n){if(!n&&t in e){return}if(s){Object.defineProperty(e,t,{configurable:true,enumerable:false,writable:true,value:r})}else{e[t]=r}};var b=function(e,t,r){l(n(t),function(n){var o=t[n];h(e,n,o,!!r)})};var g=Function.call.bind(Object.prototype.toString);var d=typeof/abc/==="function"?function IsCallableSlow(e){return typeof e==="function"&&g(e)==="[object Function]"}:function IsCallableFast(e){return typeof e==="function"};var m={getter:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}Object.defineProperty(e,t,{configurable:true,enumerable:false,get:r})},proxy:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,{configurable:n.configurable,enumerable:n.enumerable,get:function getKey(){return e[t]},set:function setKey(r){e[t]=r}})},redefine:function(e,t,r){if(s){var n=Object.getOwnPropertyDescriptor(e,t);n.value=r;Object.defineProperty(e,t,n)}else{e[t]=r}},defineByDescriptor:function(e,t,r){if(s){Object.defineProperty(e,t,r)}else if("value"in r){e[t]=r.value}},preserveToString:function(e,t){if(t&&d(t.toString)){h(e,"toString",t.toString.bind(t),true)}}};var O=Object.create||function(e,t){var r=function Prototype(){};r.prototype=e;var o=new r;if(typeof t!=="undefined"){n(t).forEach(function(e){m.defineByDescriptor(o,e,t[e])})}return o};var w=function(e,t){if(!Object.setPrototypeOf){return false}return a(function(){var r=function Subclass(t){var r=new e(t);Object.setPrototypeOf(r,Subclass.prototype);return r};Object.setPrototypeOf(r,e);r.prototype=O(e.prototype,{constructor:{value:r}});return t(r)})};var j=function(){if(typeof self!=="undefined"){return self}if(typeof window!=="undefined"){return window}if(typeof global!=="undefined"){return global}throw new Error("unable to locate global object")};var S=j();var T=S.isFinite;var I=Function.call.bind(String.prototype.indexOf);var E=Function.apply.bind(Array.prototype.indexOf);var P=Function.call.bind(Array.prototype.concat);var C=Function.call.bind(String.prototype.slice);var M=Function.call.bind(Array.prototype.push);var x=Function.apply.bind(Array.prototype.push);var N=Function.call.bind(Array.prototype.shift);var A=Math.max;var R=Math.min;var _=Math.floor;var k=Math.abs;var L=Math.exp;var F=Math.log;var D=Math.sqrt;var z=Function.call.bind(Object.prototype.hasOwnProperty);var q;var W=function(){};var G=S.Map;var H=G&&G.prototype["delete"];var V=G&&G.prototype.get;var B=G&&G.prototype.has;var U=G&&G.prototype.set;var $=S.Symbol||{};var J=$.species||"@@species";var X=Number.isNaN||function isNaN(e){return e!==e};var K=Number.isFinite||function isFinite(e){return typeof e==="number"&&T(e)};var Z=d(Math.sign)?Math.sign:function sign(e){var t=Number(e);if(t===0){return t}if(X(t)){return t}return t<0?-1:1};var Y=function log1p(e){var t=Number(e);if(t<-1||X(t)){return NaN}if(t===0||t===Infinity){return t}if(t===-1){return-Infinity}return 1+t-1===0?t:t*(F(1+t)/(1+t-1))};var Q=function isArguments(e){return g(e)==="[object Arguments]"};var ee=function isArguments(e){return e!==null&&typeof e==="object"&&typeof e.length==="number"&&e.length>=0&&g(e)!=="[object Array]"&&g(e.callee)==="[object Function]"};var te=Q(arguments)?Q:ee;var re={primitive:function(e){return e===null||typeof e!=="function"&&typeof e!=="object"},string:function(e){return g(e)==="[object String]"},regex:function(e){return g(e)==="[object RegExp]"},symbol:function(e){return typeof S.Symbol==="function"&&typeof e==="symbol"}};var ne=function overrideNative(e,t,r){var n=e[t];h(e,t,r,true);m.preserveToString(e[t],n)};var oe=typeof $==="function"&&typeof $["for"]==="function"&&re.symbol($());var ie=re.symbol($.iterator)?$.iterator:"_es6-shim iterator_";if(S.Set&&typeof(new S.Set)["@@iterator"]==="function"){ie="@@iterator"}if(!S.Reflect){h(S,"Reflect",{},true)}var ae=S.Reflect;var ue=String;var fe=typeof document==="undefined"||!document?null:document.all;var se=fe==null?function isNullOrUndefined(e){return e==null}:function isNullOrUndefinedAndNotDocumentAll(e){return e==null&&e!==fe};var ce={Call:function Call(t,r){var n=arguments.length>2?arguments[2]:[];if(!ce.IsCallable(t)){throw new TypeError(t+" is not a function")}return e(t,r,n)},RequireObjectCoercible:function(e,t){if(se(e)){throw new TypeError(t||"Cannot call method on "+e)}return e},TypeIsObject:function(e){if(e===void 0||e===null||e===true||e===false){return false}return typeof e==="function"||typeof e==="object"||e===fe},ToObject:function(e,t){return Object(ce.RequireObjectCoercible(e,t))},IsCallable:d,IsConstructor:function(e){return ce.IsCallable(e)},ToInt32:function(e){return ce.ToNumber(e)>>0},ToUint32:function(e){return ce.ToNumber(e)>>>0},ToNumber:function(e){if(g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return+e},ToInteger:function(e){var t=ce.ToNumber(e);if(X(t)){return 0}if(t===0||!K(t)){return t}return(t>0?1:-1)*_(k(t))},ToLength:function(e){var t=ce.ToInteger(e);if(t<=0){return 0}if(t>Number.MAX_SAFE_INTEGER){return Number.MAX_SAFE_INTEGER}return t},SameValue:function(e,t){if(e===t){if(e===0){return 1/e===1/t}return true}return X(e)&&X(t)},SameValueZero:function(e,t){return e===t||X(e)&&X(t)},IsIterable:function(e){return ce.TypeIsObject(e)&&(typeof e[ie]!=="undefined"||te(e))},GetIterator:function(e){if(te(e)){return new q(e,"value")}var t=ce.GetMethod(e,ie);if(!ce.IsCallable(t)){throw new TypeError("value is not an iterable")}var r=ce.Call(t,e);if(!ce.TypeIsObject(r)){throw new TypeError("bad iterator")}return r},GetMethod:function(e,t){var r=ce.ToObject(e)[t];if(se(r)){return void 0}if(!ce.IsCallable(r)){throw new TypeError("Method not callable: "+t)}return r},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var r=ce.GetMethod(e,"return");if(r===void 0){return}var n,o;try{n=ce.Call(r,e)}catch(i){o=i}if(t){return}if(o){throw o}if(!ce.TypeIsObject(n)){throw new TypeError("Iterator's return method returned a non-object.")}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!ce.TypeIsObject(t)){throw new TypeError("bad iterator")}return t},IteratorStep:function(e){var t=ce.IteratorNext(e);var r=ce.IteratorComplete(t);return r?false:t},Construct:function(e,t,r,n){var o=typeof r==="undefined"?e:r;if(!n&&ae.construct){return ae.construct(e,t,o)}var i=o.prototype;if(!ce.TypeIsObject(i)){i=Object.prototype}var a=O(i);var u=ce.Call(e,a,t);return ce.TypeIsObject(u)?u:a},SpeciesConstructor:function(e,t){var r=e.constructor;if(r===void 0){return t}if(!ce.TypeIsObject(r)){throw new TypeError("Bad constructor")}var n=r[J];if(se(n)){return t}if(!ce.IsConstructor(n)){throw new TypeError("Bad @@species")}return n},CreateHTML:function(e,t,r,n){var o=ce.ToString(e);var i="<"+t;if(r!==""){var a=ce.ToString(n);var u=a.replace(/"/g,"&quot;");i+=" "+r+'="'+u+'"'}var f=i+">";var s=f+o;return s+"</"+t+">"},IsRegExp:function IsRegExp(e){if(!ce.TypeIsObject(e)){return false}var t=e[$.match];if(typeof t!=="undefined"){return!!t}return re.regex(e)},ToString:function ToString(e){return ue(e)}};if(s&&oe){var le=function defineWellKnownSymbol(e){if(re.symbol($[e])){return $[e]}var t=$["for"]("Symbol."+e);Object.defineProperty($,e,{configurable:false,enumerable:false,writable:false,value:t});return t};if(!re.symbol($.search)){var pe=le("search");var ve=String.prototype.search;h(RegExp.prototype,pe,function search(e){return ce.Call(ve,e,[this])});var ye=function search(e){var t=ce.RequireObjectCoercible(this);if(!se(e)){var r=ce.GetMethod(e,pe);if(typeof r!=="undefined"){return ce.Call(r,e,[t])}}return ce.Call(ve,t,[ce.ToString(e)])};ne(String.prototype,"search",ye)}if(!re.symbol($.replace)){var he=le("replace");var be=String.prototype.replace;h(RegExp.prototype,he,function replace(e,t){return ce.Call(be,e,[this,t])});var ge=function replace(e,t){var r=ce.RequireObjectCoercible(this);if(!se(e)){var n=ce.GetMethod(e,he);if(typeof n!=="undefined"){return ce.Call(n,e,[r,t])}}return ce.Call(be,r,[ce.ToString(e),t])};ne(String.prototype,"replace",ge)}if(!re.symbol($.split)){var de=le("split");var me=String.prototype.split;h(RegExp.prototype,de,function split(e,t){return ce.Call(me,e,[this,t])});var Oe=function split(e,t){var r=ce.RequireObjectCoercible(this);if(!se(e)){var n=ce.GetMethod(e,de);if(typeof n!=="undefined"){return ce.Call(n,e,[r,t])}}return ce.Call(me,r,[ce.ToString(e),t])};ne(String.prototype,"split",Oe)}var we=re.symbol($.match);var je=we&&function(){var e={};e[$.match]=function(){return 42};return"a".match(e)!==42}();if(!we||je){var Se=le("match");var Te=String.prototype.match;h(RegExp.prototype,Se,function match(e){return ce.Call(Te,e,[this])});var Ie=function match(e){var t=ce.RequireObjectCoercible(this);if(!se(e)){var r=ce.GetMethod(e,Se);if(typeof r!=="undefined"){return ce.Call(r,e,[t])}}return ce.Call(Te,t,[ce.ToString(e)])};ne(String.prototype,"match",Ie)}}var Ee=function wrapConstructor(e,t,r){m.preserveToString(t,e);if(Object.setPrototypeOf){Object.setPrototypeOf(e,t)}if(s){l(Object.getOwnPropertyNames(e),function(n){if(n in W||r[n]){return}m.proxy(e,n,t)})}else{l(Object.keys(e),function(n){if(n in W||r[n]){return}t[n]=e[n]})}t.prototype=e.prototype;m.redefine(e.prototype,"constructor",t)};var Pe=function(){return this};var Ce=function(e){if(s&&!z(e,J)){m.getter(e,J,Pe)}};var Me=function(e,t){var r=t||function iterator(){return this};h(e,ie,r);if(!e[ie]&&re.symbol(ie)){e[ie]=r}};var xe=function createDataProperty(e,t,r){if(s){Object.defineProperty(e,t,{configurable:true,enumerable:true,writable:true,value:r})}else{e[t]=r}};var Ne=function createDataPropertyOrThrow(e,t,r){xe(e,t,r);if(!ce.SameValue(e[t],r)){throw new TypeError("property is nonconfigurable")}};var Ae=function(e,t,r,n){if(!ce.TypeIsObject(e)){throw new TypeError("Constructor requires `new`: "+t.name)}var o=t.prototype;if(!ce.TypeIsObject(o)){o=r}var i=O(o);for(var a in n){if(z(n,a)){var u=n[a];h(i,a,u,true)}}return i};if(String.fromCodePoint&&String.fromCodePoint.length!==1){var Re=String.fromCodePoint;ne(String,"fromCodePoint",function fromCodePoint(e){return ce.Call(Re,this,arguments)})}var _e={fromCodePoint:function fromCodePoint(e){var t=[];var r;for(var n=0,o=arguments.length;n<o;n++){r=Number(arguments[n]);if(!ce.SameValue(r,ce.ToInteger(r))||r<0||r>1114111){throw new RangeError("Invalid code point "+r)}if(r<65536){M(t,String.fromCharCode(r))}else{r-=65536;M(t,String.fromCharCode((r>>10)+55296));M(t,String.fromCharCode(r%1024+56320))}}return t.join("")},raw:function raw(e){var t=ce.ToObject(e,"bad callSite");var r=ce.ToObject(t.raw,"bad raw value");var n=r.length;var o=ce.ToLength(n);if(o<=0){return""}var i=[];var a=0;var u,f,s,c;while(a<o){u=ce.ToString(a);s=ce.ToString(r[u]);M(i,s);if(a+1>=o){break}f=a+1<arguments.length?arguments[a+1]:"";c=ce.ToString(f);M(i,c);a+=1}return i.join("")}};if(String.raw&&String.raw({raw:{0:"x",1:"y",length:2}})!=="xy"){ne(String,"raw",_e.raw)}b(String,_e);var ke=function repeat(e,t){if(t<1){return""}if(t%2){return repeat(e,t-1)+e}var r=repeat(e,t/2);return r+r};var Le=Infinity;var Fe={repeat:function repeat(e){var t=ce.ToString(ce.RequireObjectCoercible(this));var r=ce.ToInteger(e);if(r<0||r>=Le){throw new RangeError("repeat count must be less than infinity and not overflow maximum string size")}return ke(t,r)},startsWith:function startsWith(e){var t=ce.ToString(ce.RequireObjectCoercible(this));if(ce.IsRegExp(e)){throw new TypeError('Cannot call method "startsWith" with a regex')}var r=ce.ToString(e);var n;if(arguments.length>1){n=arguments[1]}var o=A(ce.ToInteger(n),0);return C(t,o,o+r.length)===r},endsWith:function endsWith(e){var t=ce.ToString(ce.RequireObjectCoercible(this));if(ce.IsRegExp(e)){throw new TypeError('Cannot call method "endsWith" with a regex')}var r=ce.ToString(e);var n=t.length;var o;if(arguments.length>1){o=arguments[1]}var i=typeof o==="undefined"?n:ce.ToInteger(o);var a=R(A(i,0),n);return C(t,a-r.length,a)===r},includes:function includes(e){if(ce.IsRegExp(e)){throw new TypeError('"includes" does not accept a RegExp')}var t=ce.ToString(e);var r;if(arguments.length>1){r=arguments[1]}return I(this,t,r)!==-1},codePointAt:function codePointAt(e){var t=ce.ToString(ce.RequireObjectCoercible(this));var r=ce.ToInteger(e);var n=t.length;if(r>=0&&r<n){var o=t.charCodeAt(r);var i=r+1===n;if(o<55296||o>56319||i){return o}var a=t.charCodeAt(r+1);if(a<56320||a>57343){return o}return(o-55296)*1024+(a-56320)+65536}}};if(String.prototype.includes&&"a".includes("a",Infinity)!==false){ne(String.prototype,"includes",Fe.includes)}if(String.prototype.startsWith&&String.prototype.endsWith){var De=i(function(){return"/a/".startsWith(/a/)});var ze=a(function(){return"abc".startsWith("a",Infinity)===false});if(!De||!ze){ne(String.prototype,"startsWith",Fe.startsWith);ne(String.prototype,"endsWith",Fe.endsWith)}}if(oe){var qe=a(function(){var e=/a/;e[$.match]=false;return"/a/".startsWith(e)});if(!qe){ne(String.prototype,"startsWith",Fe.startsWith)}var We=a(function(){var e=/a/;e[$.match]=false;return"/a/".endsWith(e)});if(!We){ne(String.prototype,"endsWith",Fe.endsWith)}var Ge=a(function(){var e=/a/;e[$.match]=false;return"/a/".includes(e)});if(!Ge){ne(String.prototype,"includes",Fe.includes)}}b(String.prototype,Fe);var He=["\t\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join("");var Ve=new RegExp("(^["+He+"]+)|(["+He+"]+$)","g");var Be=function trim(){return ce.ToString(ce.RequireObjectCoercible(this)).replace(Ve,"")};var Ue=["\x85","\u200b","\ufffe"].join("");var $e=new RegExp("["+Ue+"]","g");var Je=/^[-+]0x[0-9a-f]+$/i;var Xe=Ue.trim().length!==Ue.length;h(String.prototype,"trim",Be,Xe);var Ke=function(e){return{value:e,done:arguments.length===0}};var Ze=function(e){ce.RequireObjectCoercible(e);this._s=ce.ToString(e);this._i=0};Ze.prototype.next=function(){var e=this._s;var t=this._i;if(typeof e==="undefined"||t>=e.length){this._s=void 0;return Ke()}var r=e.charCodeAt(t);var n,o;if(r<55296||r>56319||t+1===e.length){o=1}else{n=e.charCodeAt(t+1);o=n<56320||n>57343?1:2}this._i=t+o;return Ke(e.substr(t,o))};Me(Ze.prototype);Me(String.prototype,function(){return new Ze(this)});var Ye={from:function from(e){var r=this;var n;if(arguments.length>1){n=arguments[1]}var o,i;if(typeof n==="undefined"){o=false}else{if(!ce.IsCallable(n)){throw new TypeError("Array.from: when provided, the second argument must be a function")}if(arguments.length>2){i=arguments[2]}o=true}var a=typeof(te(e)||ce.GetMethod(e,ie))!=="undefined";var u,f,s;if(a){f=ce.IsConstructor(r)?Object(new r):[];var c=ce.GetIterator(e);var l,p;s=0;while(true){l=ce.IteratorStep(c);if(l===false){break}p=l.value;try{if(o){p=typeof i==="undefined"?n(p,s):t(n,i,p,s)}f[s]=p}catch(v){ce.IteratorClose(c,true);throw v}s+=1}u=s}else{var y=ce.ToObject(e);u=ce.ToLength(y.length);f=ce.IsConstructor(r)?Object(new r(u)):new Array(u);var h;for(s=0;s<u;++s){h=y[s];if(o){h=typeof i==="undefined"?n(h,s):t(n,i,h,s)}Ne(f,s,h)}}f.length=u;return f},of:function of(){var e=arguments.length;var t=this;var n=r(t)||!ce.IsCallable(t)?new Array(e):ce.Construct(t,[e]);for(var o=0;o<e;++o){Ne(n,o,arguments[o])}n.length=e;return n}};b(Array,Ye);Ce(Array);q=function(e,t){this.i=0;this.array=e;this.kind=t};b(q.prototype,{next:function(){var e=this.i;var t=this.array;if(!(this instanceof q)){throw new TypeError("Not an ArrayIterator")}if(typeof t!=="undefined"){var r=ce.ToLength(t.length);for(;e<r;e++){var n=this.kind;var o;if(n==="key"){o=e}else if(n==="value"){o=t[e]}else if(n==="entry"){o=[e,t[e]]}this.i=e+1;return Ke(o)}}this.array=void 0;return Ke()}});Me(q.prototype);var Qe=Array.of===Ye.of||function(){var e=function Foo(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&t.length===2}();if(!Qe){ne(Array,"of",Ye.of)}var et={copyWithin:function copyWithin(e,t){var r=ce.ToObject(this);var n=ce.ToLength(r.length);var o=ce.ToInteger(e);var i=ce.ToInteger(t);var a=o<0?A(n+o,0):R(o,n);var u=i<0?A(n+i,0):R(i,n);var f;if(arguments.length>2){f=arguments[2]}var s=typeof f==="undefined"?n:ce.ToInteger(f);var c=s<0?A(n+s,0):R(s,n);var l=R(c-u,n-a);var p=1;if(u<a&&a<u+l){p=-1;u+=l-1;a+=l-1}while(l>0){if(u in r){r[a]=r[u]}else{delete r[a]}u+=p;a+=p;l-=1}return r},fill:function fill(e){var t;if(arguments.length>1){t=arguments[1]}var r;if(arguments.length>2){r=arguments[2]}var n=ce.ToObject(this);var o=ce.ToLength(n.length);t=ce.ToInteger(typeof t==="undefined"?0:t);r=ce.ToInteger(typeof r==="undefined"?o:r);var i=t<0?A(o+t,0):R(t,o);var a=r<0?o+r:r;for(var u=i;u<o&&u<a;++u){n[u]=e}return n},find:function find(e){var r=ce.ToObject(this);var n=ce.ToLength(r.length);if(!ce.IsCallable(e)){throw new TypeError("Array#find: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0,a;i<n;i++){a=r[i];if(o){if(t(e,o,a,i,r)){return a}}else if(e(a,i,r)){return a}}},findIndex:function findIndex(e){var r=ce.ToObject(this);var n=ce.ToLength(r.length);if(!ce.IsCallable(e)){throw new TypeError("Array#findIndex: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0;i<n;i++){if(o){if(t(e,o,r[i],i,r)){return i}}else if(e(r[i],i,r)){return i}}return-1},keys:function keys(){return new q(this,"key")},values:function values(){return new q(this,"value")},entries:function entries(){return new q(this,"entry")}};if(Array.prototype.keys&&!ce.IsCallable([1].keys().next)){delete Array.prototype.keys}if(Array.prototype.entries&&!ce.IsCallable([1].entries().next)){delete Array.prototype.entries}if(Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[ie]){b(Array.prototype,{values:Array.prototype[ie]});if(re.symbol($.unscopables)){Array.prototype[$.unscopables].values=true}}if(c&&Array.prototype.values&&Array.prototype.values.name!=="values"){var tt=Array.prototype.values;ne(Array.prototype,"values",function values(){return ce.Call(tt,this,arguments)});h(Array.prototype,ie,Array.prototype.values,true)}b(Array.prototype,et);if(1/[true].indexOf(true,-0)<0){h(Array.prototype,"indexOf",function indexOf(e){var t=E(this,arguments);if(t===0&&1/t<0){return 0}return t},true)}Me(Array.prototype,function(){return this.values()});if(Object.getPrototypeOf){Me(Object.getPrototypeOf([].values()))}var rt=function(){return a(function(){return Array.from({length:-1}).length===0})}();var nt=function(){var e=Array.from([0].entries());return e.length===1&&r(e[0])&&e[0][0]===0&&e[0][1]===0}();if(!rt||!nt){ne(Array,"from",Ye.from)}var ot=function(){return a(function(){return Array.from([0],void 0)})}();if(!ot){var it=Array.from;ne(Array,"from",function from(e){if(arguments.length>1&&typeof arguments[1]!=="undefined"){return ce.Call(it,this,arguments)}else{return t(it,this,e)}})}var at=-(Math.pow(2,32)-1);var ut=function(e,r){var n={length:at};n[r?(n.length>>>0)-1:0]=true;return a(function(){t(e,n,function(){throw new RangeError("should not reach here")},[]);return true})};if(!ut(Array.prototype.forEach)){var ft=Array.prototype.forEach;ne(Array.prototype,"forEach",function forEach(e){return ce.Call(ft,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.map)){var st=Array.prototype.map;ne(Array.prototype,"map",function map(e){return ce.Call(st,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.filter)){var ct=Array.prototype.filter;ne(Array.prototype,"filter",function filter(e){return ce.Call(ct,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.some)){var lt=Array.prototype.some;ne(Array.prototype,"some",function some(e){return ce.Call(lt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.every)){var pt=Array.prototype.every;ne(Array.prototype,"every",function every(e){return ce.Call(pt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.reduce)){var vt=Array.prototype.reduce;ne(Array.prototype,"reduce",function reduce(e){return ce.Call(vt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.reduceRight,true)){var yt=Array.prototype.reduceRight;ne(Array.prototype,"reduceRight",function reduceRight(e){return ce.Call(yt,this.length>=0?this:[],arguments)},true)}var ht=Number("0o10")!==8;var bt=Number("0b10")!==2;var gt=y(Ue,function(e){return Number(e+0+e)===0});if(ht||bt||gt){var dt=Number;var mt=/^0b[01]+$/i;var Ot=/^0o[0-7]+$/i;var wt=mt.test.bind(mt);var jt=Ot.test.bind(Ot);var St=function(e){var t;if(typeof e.valueOf==="function"){t=e.valueOf();if(re.primitive(t)){return t}}if(typeof e.toString==="function"){t=e.toString();if(re.primitive(t)){return t}}throw new TypeError("No default value")};var Tt=$e.test.bind($e);var It=Je.test.bind(Je);var Et=function(){var e=function Number(t){var r;if(arguments.length>0){r=re.primitive(t)?t:St(t,"number")}else{r=0}if(typeof r==="string"){r=ce.Call(Be,r);if(wt(r)){r=parseInt(C(r,2),2)}else if(jt(r)){r=parseInt(C(r,2),8)}else if(Tt(r)||It(r)){r=NaN}}var n=this;var o=a(function(){dt.prototype.valueOf.call(n);return true});if(n instanceof e&&!o){return new dt(r)}return dt(r)};return e}();Ee(dt,Et,{});b(Et,{NaN:dt.NaN,MAX_VALUE:dt.MAX_VALUE,MIN_VALUE:dt.MIN_VALUE,NEGATIVE_INFINITY:dt.NEGATIVE_INFINITY,POSITIVE_INFINITY:dt.POSITIVE_INFINITY});Number=Et;m.redefine(S,"Number",Et)}var Pt=Math.pow(2,53)-1;b(Number,{MAX_SAFE_INTEGER:Pt,MIN_SAFE_INTEGER:-Pt,EPSILON:2.220446049250313e-16,parseInt:S.parseInt,parseFloat:S.parseFloat,isFinite:K,isInteger:function isInteger(e){return K(e)&&ce.ToInteger(e)===e},isSafeInteger:function isSafeInteger(e){return Number.isInteger(e)&&k(e)<=Number.MAX_SAFE_INTEGER},isNaN:X});h(Number,"parseInt",S.parseInt,Number.parseInt!==S.parseInt);if([,1].find(function(){return true})===1){ne(Array.prototype,"find",et.find)}if([,1].findIndex(function(){return true})!==0){ne(Array.prototype,"findIndex",et.findIndex)}var Ct=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable);var Mt=function ensureEnumerable(e,t){if(s&&Ct(e,t)){Object.defineProperty(e,t,{enumerable:false})}};var xt=function sliceArgs(){var e=Number(this);var t=arguments.length;var r=t-e;var n=new Array(r<0?0:r);for(var o=e;o<t;++o){n[o-e]=arguments[o]}return n};var Nt=function assignTo(e){return function assignToSource(t,r){t[r]=e[r];return t}};var At=function(e,t){var r=n(Object(t));var o;if(ce.IsCallable(Object.getOwnPropertySymbols)){o=v(Object.getOwnPropertySymbols(Object(t)),Ct(t))}return p(P(r,o||[]),Nt(t),e)};var Rt={assign:function(e,t){var r=ce.ToObject(e,"Cannot convert undefined or null to object");return p(ce.Call(xt,1,arguments),At,r)},is:function is(e,t){return ce.SameValue(e,t)}};var _t=Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return e[1]==="y"}}();if(_t){ne(Object,"assign",Rt.assign)}b(Object,Rt);if(s){var kt={setPrototypeOf:function(e,r){var n;var o=function(e,t){if(!ce.TypeIsObject(e)){throw new TypeError("cannot set prototype on a non-object")}if(!(t===null||ce.TypeIsObject(t))){throw new TypeError("can only set prototype to an object or null"+t)}};var i=function(e,r){o(e,r);t(n,e,r);return e};try{n=e.getOwnPropertyDescriptor(e.prototype,r).set;t(n,{},null)}catch(a){if(e.prototype!=={}[r]){return}n=function(e){this[r]=e};i.polyfill=i(i({},null),e.prototype)instanceof e}return i}(Object,"__proto__")};b(Object,kt)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&Object.getPrototypeOf(Object.setPrototypeOf({},null))!==null&&Object.getPrototypeOf(Object.create(null))===null){(function(){var e=Object.create(null);var t=Object.getPrototypeOf;var r=Object.setPrototypeOf;Object.getPrototypeOf=function(r){var n=t(r);return n===e?null:n};Object.setPrototypeOf=function(t,n){var o=n===null?e:n;return r(t,o)};Object.setPrototypeOf.polyfill=false})()}var Lt=!i(function(){return Object.keys("foo")});if(!Lt){var Ft=Object.keys;ne(Object,"keys",function keys(e){return Ft(ce.ToObject(e))});n=Object.keys}var Dt=i(function(){return Object.keys(/a/g)});if(Dt){var zt=Object.keys;ne(Object,"keys",function keys(e){if(re.regex(e)){var t=[];for(var r in e){if(z(e,r)){M(t,r)}}return t}return zt(e)});n=Object.keys}if(Object.getOwnPropertyNames){var qt=!i(function(){return Object.getOwnPropertyNames("foo")});if(!qt){var Wt=typeof window==="object"?Object.getOwnPropertyNames(window):[];var Gt=Object.getOwnPropertyNames;ne(Object,"getOwnPropertyNames",function getOwnPropertyNames(e){var t=ce.ToObject(e);if(g(t)==="[object Window]"){try{return Gt(t)}catch(r){return P([],Wt)}}return Gt(t)})}}if(Object.getOwnPropertyDescriptor){var Ht=!i(function(){return Object.getOwnPropertyDescriptor("foo","bar")});if(!Ht){var Vt=Object.getOwnPropertyDescriptor;ne(Object,"getOwnPropertyDescriptor",function getOwnPropertyDescriptor(e,t){return Vt(ce.ToObject(e),t)})}}if(Object.seal){var Bt=!i(function(){return Object.seal("foo")});if(!Bt){var Ut=Object.seal;ne(Object,"seal",function seal(e){if(!ce.TypeIsObject(e)){return e}return Ut(e)})}}if(Object.isSealed){var $t=!i(function(){return Object.isSealed("foo")});if(!$t){var Jt=Object.isSealed;ne(Object,"isSealed",function isSealed(e){if(!ce.TypeIsObject(e)){return true}return Jt(e)})}}if(Object.freeze){var Xt=!i(function(){return Object.freeze("foo")});if(!Xt){var Kt=Object.freeze;ne(Object,"freeze",function freeze(e){if(!ce.TypeIsObject(e)){return e}return Kt(e)})}}if(Object.isFrozen){var Zt=!i(function(){return Object.isFrozen("foo")});if(!Zt){var Yt=Object.isFrozen;ne(Object,"isFrozen",function isFrozen(e){if(!ce.TypeIsObject(e)){return true}return Yt(e)})}}if(Object.preventExtensions){var Qt=!i(function(){return Object.preventExtensions("foo")});if(!Qt){var er=Object.preventExtensions;ne(Object,"preventExtensions",function preventExtensions(e){if(!ce.TypeIsObject(e)){return e}return er(e)})}}if(Object.isExtensible){var tr=!i(function(){return Object.isExtensible("foo")});if(!tr){var rr=Object.isExtensible;ne(Object,"isExtensible",function isExtensible(e){if(!ce.TypeIsObject(e)){return false}return rr(e)})}}if(Object.getPrototypeOf){var nr=!i(function(){return Object.getPrototypeOf("foo")});if(!nr){var or=Object.getPrototypeOf;ne(Object,"getPrototypeOf",function getPrototypeOf(e){return or(ce.ToObject(e))})}}var ir=s&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&ce.IsCallable(e.get)}();if(s&&!ir){var ar=function flags(){if(!ce.TypeIsObject(this)){throw new TypeError("Method called on incompatible type: must be an object.")}var e="";if(this.global){e+="g"}if(this.ignoreCase){e+="i"}if(this.multiline){e+="m"}if(this.unicode){e+="u"}if(this.sticky){e+="y"}return e};m.getter(RegExp.prototype,"flags",ar)}var ur=s&&a(function(){return String(new RegExp(/a/g,"i"))==="/a/i"});var fr=oe&&s&&function(){var e=/./;e[$.match]=false;return RegExp(e)===e}();var sr=a(function(){return RegExp.prototype.toString.call({source:"abc"})==="/abc/"});var cr=sr&&a(function(){return RegExp.prototype.toString.call({source:"a",flags:"b"})==="/a/b"});if(!sr||!cr){var lr=RegExp.prototype.toString;h(RegExp.prototype,"toString",function toString(){var e=ce.RequireObjectCoercible(this);if(re.regex(e)){return t(lr,e)}var r=ue(e.source);var n=ue(e.flags);return"/"+r+"/"+n},true);m.preserveToString(RegExp.prototype.toString,lr)}if(s&&(!ur||fr)){var pr=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get;var vr=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{};var yr=function(){return this.source};var hr=ce.IsCallable(vr.get)?vr.get:yr;var br=RegExp;var gr=function(){return function RegExp(e,t){var r=ce.IsRegExp(e);var n=this instanceof RegExp;if(!n&&r&&typeof t==="undefined"&&e.constructor===RegExp){return e}var o=e;var i=t;if(re.regex(e)){o=ce.Call(hr,e);i=typeof t==="undefined"?ce.Call(pr,e):t;return new RegExp(o,i)}else if(r){o=e.source;i=typeof t==="undefined"?e.flags:t}return new br(e,t)}}();Ee(br,gr,{$input:true});RegExp=gr;m.redefine(S,"RegExp",gr)}if(s){var dr={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};l(n(dr),function(e){if(e in RegExp&&!(dr[e]in RegExp)){m.getter(RegExp,dr[e],function get(){return RegExp[e]})}})}Ce(RegExp);var mr=1/Number.EPSILON;var Or=function roundTiesToEven(e){return e+mr-mr};var wr=Math.pow(2,-23);var jr=Math.pow(2,127)*(2-wr);var Sr=Math.pow(2,-126);var Tr=Math.E;var Ir=Math.LOG2E;var Er=Math.LOG10E;var Pr=Number.prototype.clz;delete Number.prototype.clz;var Cr={acosh:function acosh(e){var t=Number(e);if(X(t)||e<1){return NaN}if(t===1){return 0}if(t===Infinity){return t}var r=1/(t*t);if(t<2){return Y(t-1+D(1-r)*t)}var n=t/2;return Y(n+D(1-r)*n-1)+1/Ir},asinh:function asinh(e){var t=Number(e);if(t===0||!T(t)){return t}var r=k(t);var n=r*r;var o=Z(t);if(r<1){return o*Y(r+n/(D(n+1)+1))}return o*(Y(r/2+D(1+1/n)*r/2-1)+1/Ir)},atanh:function atanh(e){var t=Number(e);if(t===0){return t}if(t===-1){return-Infinity}if(t===1){return Infinity}if(X(t)||t<-1||t>1){return NaN}var r=k(t);return Z(t)*Y(2*r/(1-r))/2},cbrt:function cbrt(e){var t=Number(e);if(t===0){return t}var r=t<0;var n;if(r){t=-t}if(t===Infinity){n=Infinity}else{n=L(F(t)/3);n=(t/(n*n)+2*n)/3}return r?-n:n},clz32:function clz32(e){var t=Number(e);var r=ce.ToUint32(t);if(r===0){return 32}return Pr?ce.Call(Pr,r):31-_(F(r+.5)*Ir)},cosh:function cosh(e){var t=Number(e);if(t===0){return 1}if(X(t)){return NaN}if(!T(t)){return Infinity}var r=L(k(t)-1);return(r+1/(r*Tr*Tr))*(Tr/2)},expm1:function expm1(e){var t=Number(e);if(t===-Infinity){return-1}if(!T(t)||t===0){return t}if(k(t)>.5){return L(t)-1}var r=t;var n=0;var o=1;while(n+r!==n){n+=r;o+=1;r*=t/o}return n},hypot:function hypot(e,t){var r=0;var n=0;for(var o=0;o<arguments.length;++o){var i=k(Number(arguments[o]));if(n<i){r*=n/i*(n/i);r+=1;n=i}else{r+=i>0?i/n*(i/n):i}}return n===Infinity?Infinity:n*D(r)},log2:function log2(e){return F(e)*Ir},log10:function log10(e){return F(e)*Er},log1p:Y,sign:Z,sinh:function sinh(e){var t=Number(e);if(!T(t)||t===0){return t}var r=k(t);if(r<1){var n=Math.expm1(r);return Z(t)*n*(1+1/(n+1))/2}var o=L(r-1);return Z(t)*(o-1/(o*Tr*Tr))*(Tr/2)},tanh:function tanh(e){var t=Number(e);if(X(t)||t===0){return t}if(t>=20){return 1}if(t<=-20){return-1}return(Math.expm1(t)-Math.expm1(-t))/(L(t)+L(-t))},trunc:function trunc(e){var t=Number(e);return t<0?-_(-t):_(t)},imul:function imul(e,t){var r=ce.ToUint32(e);var n=ce.ToUint32(t);var o=r>>>16&65535;var i=r&65535;var a=n>>>16&65535;var u=n&65535;return i*u+(o*u+i*a<<16>>>0)|0},fround:function fround(e){var t=Number(e);if(t===0||t===Infinity||t===-Infinity||X(t)){return t}var r=Z(t);var n=k(t);if(n<Sr){return r*Or(n/Sr/wr)*Sr*wr}var o=(1+wr/Number.EPSILON)*n;var i=o-(o-n);if(i>jr||X(i)){return r*Infinity}return r*i}};var Mr=function withinULPDistance(e,t,r){return k(1-e/t)/Number.EPSILON<(r||8)};b(Math,Cr);h(Math,"sinh",Cr.sinh,Math.sinh(710)===Infinity);h(Math,"cosh",Cr.cosh,Math.cosh(710)===Infinity);h(Math,"log1p",Cr.log1p,Math.log1p(-1e-17)!==-1e-17);h(Math,"asinh",Cr.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7));h(Math,"asinh",Cr.asinh,Math.asinh(1e300)===Infinity);h(Math,"atanh",Cr.atanh,Math.atanh(1e-300)===0);h(Math,"tanh",Cr.tanh,Math.tanh(-2e-17)!==-2e-17);
h(Math,"acosh",Cr.acosh,Math.acosh(Number.MAX_VALUE)===Infinity);h(Math,"acosh",Cr.acosh,!Mr(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON)));h(Math,"cbrt",Cr.cbrt,!Mr(Math.cbrt(1e-300),1e-100));h(Math,"sinh",Cr.sinh,Math.sinh(-2e-17)!==-2e-17);var xr=Math.expm1(10);h(Math,"expm1",Cr.expm1,xr>22025.465794806718||xr<22025.465794806718);var Nr=Math.round;var Ar=Math.round(.5-Number.EPSILON/4)===0&&Math.round(-.5+Number.EPSILON/3.99)===1;var Rr=mr+1;var _r=2*mr-1;var kr=[Rr,_r].every(function(e){return Math.round(e)===e});h(Math,"round",function round(e){var t=_(e);var r=t===-1?-0:t+1;return e-t<.5?t:r},!Ar||!kr);m.preserveToString(Math.round,Nr);var Lr=Math.imul;if(Math.imul(4294967295,5)!==-5){Math.imul=Cr.imul;m.preserveToString(Math.imul,Lr)}if(Math.imul.length!==2){ne(Math,"imul",function imul(e,t){return ce.Call(Lr,Math,arguments)})}var Fr=function(){var e=S.setTimeout;if(typeof e!=="function"&&typeof e!=="object"){return}ce.IsPromise=function(e){if(!ce.TypeIsObject(e)){return false}if(typeof e._promise==="undefined"){return false}return true};var r=function(e){if(!ce.IsConstructor(e)){throw new TypeError("Bad promise constructor")}var t=this;var r=function(e,r){if(t.resolve!==void 0||t.reject!==void 0){throw new TypeError("Bad Promise implementation!")}t.resolve=e;t.reject=r};t.resolve=void 0;t.reject=void 0;t.promise=new e(r);if(!(ce.IsCallable(t.resolve)&&ce.IsCallable(t.reject))){throw new TypeError("Bad promise constructor")}};var n;if(typeof window!=="undefined"&&ce.IsCallable(window.postMessage)){n=function(){var e=[];var t="zero-timeout-message";var r=function(r){M(e,r);window.postMessage(t,"*")};var n=function(r){if(r.source===window&&r.data===t){r.stopPropagation();if(e.length===0){return}var n=N(e);n()}};window.addEventListener("message",n,true);return r}}var o=function(){var e=S.Promise;var t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}};var i=ce.IsCallable(S.setImmediate)?S.setImmediate:typeof process==="object"&&process.nextTick?process.nextTick:o()||(ce.IsCallable(n)?n():function(t){e(t,0)});var a=function(e){return e};var u=function(e){throw e};var f=0;var s=1;var c=2;var l=0;var p=1;var v=2;var y={};var h=function(e,t,r){i(function(){g(e,t,r)})};var g=function(e,t,r){var n,o;if(t===y){return e(r)}try{n=e(r);o=t.resolve}catch(i){n=i;o=t.reject}o(n)};var d=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.fulfillReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+l],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=s;r.reactionLength=0};var m=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.rejectReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+p],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=c;r.reactionLength=0};var O=function(e){var t=false;var r=function(r){var n;if(t){return}t=true;if(r===e){return m(e,new TypeError("Self resolution"))}if(!ce.TypeIsObject(r)){return d(e,r)}try{n=r.then}catch(o){return m(e,o)}if(!ce.IsCallable(n)){return d(e,r)}i(function(){j(e,r,n)})};var n=function(r){if(t){return}t=true;return m(e,r)};return{resolve:r,reject:n}};var w=function(e,r,n,o){if(e===I){t(e,r,n,o,y)}else{t(e,r,n,o)}};var j=function(e,t,r){var n=O(e);var o=n.resolve;var i=n.reject;try{w(r,t,o,i)}catch(a){i(a)}};var T,I;var E=function(){var e=function Promise(t){if(!(this instanceof e)){throw new TypeError('Constructor Promise requires "new"')}if(this&&this._promise){throw new TypeError("Bad construction")}if(!ce.IsCallable(t)){throw new TypeError("not a valid resolver")}var r=Ae(this,e,T,{_promise:{result:void 0,state:f,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}});var n=O(r);var o=n.reject;try{t(n.resolve,o)}catch(i){o(i)}return r};return e}();T=E.prototype;var P=function(e,t,r,n){var o=false;return function(i){if(o){return}o=true;t[e]=i;if(--n.count===0){var a=r.resolve;a(t)}}};var C=function(e,t,r){var n=e.iterator;var o=[];var i={count:1};var a,u;var f=0;while(true){try{a=ce.IteratorStep(n);if(a===false){e.done=true;break}u=a.value}catch(s){e.done=true;throw s}o[f]=void 0;var c=t.resolve(u);var l=P(f,o,r,i);i.count+=1;w(c.then,c,l,r.reject);f+=1}if(--i.count===0){var p=r.resolve;p(o)}return r.promise};var x=function(e,t,r){var n=e.iterator;var o,i,a;while(true){try{o=ce.IteratorStep(n);if(o===false){e.done=true;break}i=o.value}catch(u){e.done=true;throw u}a=t.resolve(i);w(a.then,a,r.resolve,r.reject)}return r.promise};b(E,{all:function all(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=ce.GetIterator(e);i={iterator:o,done:false};return C(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{ce.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},race:function race(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=ce.GetIterator(e);i={iterator:o,done:false};return x(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{ce.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},reject:function reject(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}var n=new r(t);var o=n.reject;o(e);return n.promise},resolve:function resolve(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}if(ce.IsPromise(e)){var n=e.constructor;if(n===t){return e}}var o=new r(t);var i=o.resolve;i(e);return o.promise}});b(T,{"catch":function(e){return this.then(null,e)},then:function then(e,t){var n=this;if(!ce.IsPromise(n)){throw new TypeError("not a promise")}var o=ce.SpeciesConstructor(n,E);var i;var b=arguments.length>2&&arguments[2]===y;if(b&&o===E){i=y}else{i=new r(o)}var g=ce.IsCallable(e)?e:a;var d=ce.IsCallable(t)?t:u;var m=n._promise;var O;if(m.state===f){if(m.reactionLength===0){m.fulfillReactionHandler0=g;m.rejectReactionHandler0=d;m.reactionCapability0=i}else{var w=3*(m.reactionLength-1);m[w+l]=g;m[w+p]=d;m[w+v]=i}m.reactionLength+=1}else if(m.state===s){O=m.result;h(g,i,O)}else if(m.state===c){O=m.result;h(d,i,O)}else{throw new TypeError("unexpected Promise state")}return i.promise}});y=new r(E);I=T.then;return E}();if(S.Promise){delete S.Promise.accept;delete S.Promise.defer;delete S.Promise.prototype.chain}if(typeof Fr==="function"){b(S,{Promise:Fr});var Dr=w(S.Promise,function(e){return e.resolve(42).then(function(){})instanceof e});var zr=!i(function(){return S.Promise.reject(42).then(null,5).then(null,W)});var qr=i(function(){return S.Promise.call(3,W)});var Wr=function(e){var t=e.resolve(5);t.constructor={};var r=e.resolve(t);try{r.then(null,W).then(null,W)}catch(n){return true}return t===r}(S.Promise);var Gr=s&&function(){var e=0;var t=Object.defineProperty({},"then",{get:function(){e+=1}});Promise.resolve(t);return e===1}();var Hr=function BadResolverPromise(e){var t=new Promise(e);e(3,function(){});this.then=t.then;this.constructor=BadResolverPromise};Hr.prototype=Promise.prototype;Hr.all=Promise.all;var Vr=a(function(){return!!Hr.all([1,2])});if(!Dr||!zr||!qr||Wr||!Gr||Vr){Promise=Fr;ne(S,"Promise",Fr)}if(Promise.all.length!==1){var Br=Promise.all;ne(Promise,"all",function all(e){return ce.Call(Br,this,arguments)})}if(Promise.race.length!==1){var Ur=Promise.race;ne(Promise,"race",function race(e){return ce.Call(Ur,this,arguments)})}if(Promise.resolve.length!==1){var $r=Promise.resolve;ne(Promise,"resolve",function resolve(e){return ce.Call($r,this,arguments)})}if(Promise.reject.length!==1){var Jr=Promise.reject;ne(Promise,"reject",function reject(e){return ce.Call(Jr,this,arguments)})}Mt(Promise,"all");Mt(Promise,"race");Mt(Promise,"resolve");Mt(Promise,"reject");Ce(Promise)}var Xr=function(e){var t=n(p(e,function(e,t){e[t]=true;return e},{}));return e.join(":")===t.join(":")};var Kr=Xr(["z","a","bb"]);var Zr=Xr(["z",1,"a","3",2]);if(s){var Yr=function fastkey(e,t){if(!t&&!Kr){return null}if(se(e)){return"^"+ce.ToString(e)}else if(typeof e==="string"){return"$"+e}else if(typeof e==="number"){if(!Zr){return"n"+e}return e}else if(typeof e==="boolean"){return"b"+e}return null};var Qr=function emptyObject(){return Object.create?Object.create(null):{}};var en=function addIterableToMap(e,n,o){if(r(o)||re.string(o)){l(o,function(e){if(!ce.TypeIsObject(e)){throw new TypeError("Iterator value "+e+" is not an entry object")}n.set(e[0],e[1])})}else if(o instanceof e){t(e.prototype.forEach,o,function(e,t){n.set(t,e)})}else{var i,a;if(!se(o)){a=n.set;if(!ce.IsCallable(a)){throw new TypeError("bad map")}i=ce.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=ce.IteratorStep(i);if(u===false){break}var f=u.value;try{if(!ce.TypeIsObject(f)){throw new TypeError("Iterator value "+f+" is not an entry object")}t(a,n,f[0],f[1])}catch(s){ce.IteratorClose(i,true);throw s}}}}};var tn=function addIterableToSet(e,n,o){if(r(o)||re.string(o)){l(o,function(e){n.add(e)})}else if(o instanceof e){t(e.prototype.forEach,o,function(e){n.add(e)})}else{var i,a;if(!se(o)){a=n.add;if(!ce.IsCallable(a)){throw new TypeError("bad set")}i=ce.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=ce.IteratorStep(i);if(u===false){break}var f=u.value;try{t(a,n,f)}catch(s){ce.IteratorClose(i,true);throw s}}}}};var rn={Map:function(){var e={};var r=function MapEntry(e,t){this.key=e;this.value=t;this.next=null;this.prev=null};r.prototype.isRemoved=function isRemoved(){return this.key===e};var n=function isMap(e){return!!e._es6map};var o=function requireMapSlot(e,t){if(!ce.TypeIsObject(e)||!n(e)){throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+ce.ToString(e))}};var i=function MapIterator(e,t){o(e,"[[MapIterator]]");this.head=e._head;this.i=this.head;this.kind=t};i.prototype={isMapIterator:true,next:function next(){if(!this.isMapIterator){throw new TypeError("Not a MapIterator")}var e=this.i;var t=this.kind;var r=this.head;if(typeof this.i==="undefined"){return Ke()}while(e.isRemoved()&&e!==r){e=e.prev}var n;while(e.next!==r){e=e.next;if(!e.isRemoved()){if(t==="key"){n=e.key}else if(t==="value"){n=e.value}else{n=[e.key,e.value]}this.i=e;return Ke(n)}}this.i=void 0;return Ke()}};Me(i.prototype);var a;var u=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}if(this&&this._es6map){throw new TypeError("Bad construction")}var e=Ae(this,Map,a,{_es6map:true,_head:null,_map:G?new G:null,_size:0,_storage:Qr()});var t=new r(null,null);t.next=t.prev=t;e._head=t;if(arguments.length>0){en(Map,e,arguments[0])}return e};a=u.prototype;m.getter(a,"size",function(){if(typeof this._size==="undefined"){throw new TypeError("size method called on incompatible Map")}return this._size});b(a,{get:function get(e){o(this,"get");var t;var r=Yr(e,true);if(r!==null){t=this._storage[r];if(t){return t.value}else{return}}if(this._map){t=V.call(this._map,e);if(t){return t.value}else{return}}var n=this._head;var i=n;while((i=i.next)!==n){if(ce.SameValueZero(i.key,e)){return i.value}}},has:function has(e){o(this,"has");var t=Yr(e,true);if(t!==null){return typeof this._storage[t]!=="undefined"}if(this._map){return B.call(this._map,e)}var r=this._head;var n=r;while((n=n.next)!==r){if(ce.SameValueZero(n.key,e)){return true}}return false},set:function set(e,t){o(this,"set");var n=this._head;var i=n;var a;var u=Yr(e,true);if(u!==null){if(typeof this._storage[u]!=="undefined"){this._storage[u].value=t;return this}else{a=this._storage[u]=new r(e,t);i=n.prev}}else if(this._map){if(B.call(this._map,e)){V.call(this._map,e).value=t}else{a=new r(e,t);U.call(this._map,e,a);i=n.prev}}while((i=i.next)!==n){if(ce.SameValueZero(i.key,e)){i.value=t;return this}}a=a||new r(e,t);if(ce.SameValue(-0,e)){a.key=+0}a.next=this._head;a.prev=this._head.prev;a.prev.next=a;a.next.prev=a;this._size+=1;return this},"delete":function(t){o(this,"delete");var r=this._head;var n=r;var i=Yr(t,true);if(i!==null){if(typeof this._storage[i]==="undefined"){return false}n=this._storage[i].prev;delete this._storage[i]}else if(this._map){if(!B.call(this._map,t)){return false}n=V.call(this._map,t).prev;H.call(this._map,t)}while((n=n.next)!==r){if(ce.SameValueZero(n.key,t)){n.key=e;n.value=e;n.prev.next=n.next;n.next.prev=n.prev;this._size-=1;return true}}return false},clear:function clear(){o(this,"clear");this._map=G?new G:null;this._size=0;this._storage=Qr();var t=this._head;var r=t;var n=r.next;while((r=n)!==t){r.key=e;r.value=e;n=r.next;r.next=r.prev=t}t.next=t.prev=t},keys:function keys(){o(this,"keys");return new i(this,"key")},values:function values(){o(this,"values");return new i(this,"value")},entries:function entries(){o(this,"entries");return new i(this,"key+value")},forEach:function forEach(e){o(this,"forEach");var r=arguments.length>1?arguments[1]:null;var n=this.entries();for(var i=n.next();!i.done;i=n.next()){if(r){t(e,r,i.value[1],i.value[0],this)}else{e(i.value[1],i.value[0],this)}}}});Me(a,a.entries);return u}(),Set:function(){var e=function isSet(e){return e._es6set&&typeof e._storage!=="undefined"};var r=function requireSetSlot(t,r){if(!ce.TypeIsObject(t)||!e(t)){throw new TypeError("Set.prototype."+r+" called on incompatible receiver "+ce.ToString(t))}};var o;var i=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}if(this&&this._es6set){throw new TypeError("Bad construction")}var e=Ae(this,Set,o,{_es6set:true,"[[SetData]]":null,_storage:Qr()});if(!e._es6set){throw new TypeError("bad set")}if(arguments.length>0){tn(Set,e,arguments[0])}return e};o=i.prototype;var a=function(e){var t=e;if(t==="^null"){return null}else if(t==="^undefined"){return void 0}else{var r=t.charAt(0);if(r==="$"){return C(t,1)}else if(r==="n"){return+C(t,1)}else if(r==="b"){return t==="btrue"}}return+t};var u=function ensureMap(e){if(!e["[[SetData]]"]){var t=new rn.Map;e["[[SetData]]"]=t;l(n(e._storage),function(e){var r=a(e);t.set(r,r)});e["[[SetData]]"]=t}e._storage=null};m.getter(i.prototype,"size",function(){r(this,"size");if(this._storage){return n(this._storage).length}u(this);return this["[[SetData]]"].size});b(i.prototype,{has:function has(e){r(this,"has");var t;if(this._storage&&(t=Yr(e))!==null){return!!this._storage[t]}u(this);return this["[[SetData]]"].has(e)},add:function add(e){r(this,"add");var t;if(this._storage&&(t=Yr(e))!==null){this._storage[t]=true;return this}u(this);this["[[SetData]]"].set(e,e);return this},"delete":function(e){r(this,"delete");var t;if(this._storage&&(t=Yr(e))!==null){var n=z(this._storage,t);return delete this._storage[t]&&n}u(this);return this["[[SetData]]"]["delete"](e)},clear:function clear(){r(this,"clear");if(this._storage){this._storage=Qr()}if(this["[[SetData]]"]){this["[[SetData]]"].clear()}},values:function values(){r(this,"values");u(this);return new f(this["[[SetData]]"].values())},entries:function entries(){r(this,"entries");u(this);return new f(this["[[SetData]]"].entries())},forEach:function forEach(e){r(this,"forEach");var n=arguments.length>1?arguments[1]:null;var o=this;u(o);this["[[SetData]]"].forEach(function(r,i){if(n){t(e,n,i,i,o)}else{e(i,i,o)}})}});h(i.prototype,"keys",i.prototype.values,true);Me(i.prototype,i.prototype.values);var f=function SetIterator(e){this.it=e};f.prototype={isSetIterator:true,next:function next(){if(!this.isSetIterator){throw new TypeError("Not a SetIterator")}return this.it.next()}};Me(f.prototype);return i}()};var nn=S.Set&&!Set.prototype["delete"]&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys);if(nn){S.Set=rn.Set}if(S.Map||S.Set){var on=a(function(){return new Map([[1,2]]).get(1)===2});if(!on){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new G;if(arguments.length>0){en(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,S.Map.prototype);return e};S.Map.prototype=O(G.prototype);h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,G)}var an=new Map;var un=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);e.set(-0,e);return e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}();var fn=an.set(1,2)===an;if(!un||!fn){ne(Map.prototype,"set",function set(e,r){t(U,this,e===0?0:e,r);return this})}if(!un){b(Map.prototype,{get:function get(e){return t(V,this,e===0?0:e)},has:function has(e){return t(B,this,e===0?0:e)}},true);m.preserveToString(Map.prototype.get,V);m.preserveToString(Map.prototype.has,B)}var sn=new Set;var cn=Set.prototype["delete"]&&Set.prototype.add&&Set.prototype.has&&function(e){e["delete"](0);e.add(-0);return!e.has(0)}(sn);var ln=sn.add(1)===sn;if(!cn||!ln){var pn=Set.prototype.add;Set.prototype.add=function add(e){t(pn,this,e===0?0:e);return this};m.preserveToString(Set.prototype.add,pn)}if(!cn){var vn=Set.prototype.has;Set.prototype.has=function has(e){return t(vn,this,e===0?0:e)};m.preserveToString(Set.prototype.has,vn);var yn=Set.prototype["delete"];Set.prototype["delete"]=function SetDelete(e){return t(yn,this,e===0?0:e)};m.preserveToString(Set.prototype["delete"],yn)}var hn=w(S.Map,function(e){var t=new e([]);t.set(42,42);return t instanceof e});var bn=Object.setPrototypeOf&&!hn;var gn=function(){try{return!(S.Map()instanceof S.Map)}catch(e){return e instanceof TypeError}}();if(S.Map.length!==0||bn||!gn){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new G;if(arguments.length>0){en(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Map.prototype);return e};S.Map.prototype=G.prototype;h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,G)}var dn=w(S.Set,function(e){var t=new e([]);t.add(42,42);return t instanceof e});var mn=Object.setPrototypeOf&&!dn;var On=function(){try{return!(S.Set()instanceof S.Set)}catch(e){return e instanceof TypeError}}();if(S.Set.length!==0||mn||!On){var wn=S.Set;S.Set=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}var e=new wn;if(arguments.length>0){tn(Set,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Set.prototype);return e};S.Set.prototype=wn.prototype;h(S.Set.prototype,"constructor",S.Set,true);m.preserveToString(S.Set,wn)}var jn=new S.Map;var Sn=!a(function(){return jn.keys().next().done});if(typeof S.Map.prototype.clear!=="function"||(new S.Set).size!==0||jn.size!==0||typeof S.Map.prototype.keys!=="function"||typeof S.Set.prototype.keys!=="function"||typeof S.Map.prototype.forEach!=="function"||typeof S.Set.prototype.forEach!=="function"||u(S.Map)||u(S.Set)||typeof jn.keys().next!=="function"||Sn||!hn){b(S,{Map:rn.Map,Set:rn.Set},true)}if(S.Set.prototype.keys!==S.Set.prototype.values){h(S.Set.prototype,"keys",S.Set.prototype.values,true)}Me(Object.getPrototypeOf((new S.Map).keys()));Me(Object.getPrototypeOf((new S.Set).keys()));if(c&&S.Set.prototype.has.name!=="has"){var Tn=S.Set.prototype.has;ne(S.Set.prototype,"has",function has(e){return t(Tn,this,e)})}}b(S,rn);Ce(S.Map);Ce(S.Set)}var In=function throwUnlessTargetIsObject(e){if(!ce.TypeIsObject(e)){throw new TypeError("target must be an object")}};var En={apply:function apply(){return ce.Call(ce.Call,null,arguments)},construct:function construct(e,t){if(!ce.IsConstructor(e)){throw new TypeError("First argument must be a constructor.")}var r=arguments.length>2?arguments[2]:e;if(!ce.IsConstructor(r)){throw new TypeError("new.target must be a constructor.")}return ce.Construct(e,t,r,"internal")},deleteProperty:function deleteProperty(e,t){In(e);if(s){var r=Object.getOwnPropertyDescriptor(e,t);if(r&&!r.configurable){return false}}return delete e[t]},has:function has(e,t){In(e);return t in e}};if(Object.getOwnPropertyNames){Object.assign(En,{ownKeys:function ownKeys(e){In(e);var t=Object.getOwnPropertyNames(e);if(ce.IsCallable(Object.getOwnPropertySymbols)){x(t,Object.getOwnPropertySymbols(e))}return t}})}var Pn=function ConvertExceptionToBoolean(e){return!i(e)};if(Object.preventExtensions){Object.assign(En,{isExtensible:function isExtensible(e){In(e);return Object.isExtensible(e)},preventExtensions:function preventExtensions(e){In(e);return Pn(function(){return Object.preventExtensions(e)})}})}if(s){var Cn=function get(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t);if(!n){var o=Object.getPrototypeOf(e);if(o===null){return void 0}return Cn(o,t,r)}if("value"in n){return n.value}if(n.get){return ce.Call(n.get,r)}return void 0};var Mn=function set(e,r,n,o){var i=Object.getOwnPropertyDescriptor(e,r);if(!i){var a=Object.getPrototypeOf(e);if(a!==null){return Mn(a,r,n,o)}i={value:void 0,writable:true,enumerable:true,configurable:true}}if("value"in i){if(!i.writable){return false}if(!ce.TypeIsObject(o)){return false}var u=Object.getOwnPropertyDescriptor(o,r);if(u){return ae.defineProperty(o,r,{value:n})}else{return ae.defineProperty(o,r,{value:n,writable:true,enumerable:true,configurable:true})}}if(i.set){t(i.set,o,n);return true}return false};Object.assign(En,{defineProperty:function defineProperty(e,t,r){In(e);return Pn(function(){return Object.defineProperty(e,t,r)})},getOwnPropertyDescriptor:function getOwnPropertyDescriptor(e,t){In(e);return Object.getOwnPropertyDescriptor(e,t)},get:function get(e,t){In(e);var r=arguments.length>2?arguments[2]:e;return Cn(e,t,r)},set:function set(e,t,r){In(e);var n=arguments.length>3?arguments[3]:e;return Mn(e,t,r,n)}})}if(Object.getPrototypeOf){var xn=Object.getPrototypeOf;En.getPrototypeOf=function getPrototypeOf(e){In(e);return xn(e)}}if(Object.setPrototypeOf&&En.getPrototypeOf){var Nn=function(e,t){var r=t;while(r){if(e===r){return true}r=En.getPrototypeOf(r)}return false};Object.assign(En,{setPrototypeOf:function setPrototypeOf(e,t){In(e);if(t!==null&&!ce.TypeIsObject(t)){throw new TypeError("proto must be an object or null")}if(t===ae.getPrototypeOf(e)){return true}if(ae.isExtensible&&!ae.isExtensible(e)){return false}if(Nn(e,t)){return false}Object.setPrototypeOf(e,t);return true}})}var An=function(e,t){if(!ce.IsCallable(S.Reflect[e])){h(S.Reflect,e,t)}else{var r=a(function(){S.Reflect[e](1);S.Reflect[e](NaN);S.Reflect[e](true);return true});if(r){ne(S.Reflect,e,t)}}};Object.keys(En).forEach(function(e){An(e,En[e])});var Rn=S.Reflect.getPrototypeOf;if(c&&Rn&&Rn.name!=="getPrototypeOf"){ne(S.Reflect,"getPrototypeOf",function getPrototypeOf(e){return t(Rn,S.Reflect,e)})}if(S.Reflect.setPrototypeOf){if(a(function(){S.Reflect.setPrototypeOf(1,{});return true})){ne(S.Reflect,"setPrototypeOf",En.setPrototypeOf)}}if(S.Reflect.defineProperty){if(!a(function(){var e=!S.Reflect.defineProperty(1,"test",{value:1});var t=typeof Object.preventExtensions!=="function"||!S.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})){ne(S.Reflect,"defineProperty",En.defineProperty)}}if(S.Reflect.construct){if(!a(function(){var e=function F(){};return S.Reflect.construct(function(){},[],e)instanceof e})){ne(S.Reflect,"construct",En.construct)}}if(String(new Date(NaN))!=="Invalid Date"){var _n=Date.prototype.toString;var kn=function toString(){var e=+this;if(e!==e){return"Invalid Date"}return ce.Call(_n,this)};ne(Date.prototype,"toString",kn)}var Ln={anchor:function anchor(e){return ce.CreateHTML(this,"a","name",e)},big:function big(){return ce.CreateHTML(this,"big","","")},blink:function blink(){return ce.CreateHTML(this,"blink","","")},bold:function bold(){return ce.CreateHTML(this,"b","","")},fixed:function fixed(){return ce.CreateHTML(this,"tt","","")},fontcolor:function fontcolor(e){return ce.CreateHTML(this,"font","color",e)},fontsize:function fontsize(e){return ce.CreateHTML(this,"font","size",e)},italics:function italics(){return ce.CreateHTML(this,"i","","")},link:function link(e){return ce.CreateHTML(this,"a","href",e)},small:function small(){return ce.CreateHTML(this,"small","","")},strike:function strike(){return ce.CreateHTML(this,"strike","","")},sub:function sub(){return ce.CreateHTML(this,"sub","","")},sup:function sub(){return ce.CreateHTML(this,"sup","","")}};l(Object.keys(Ln),function(e){var r=String.prototype[e];var n=false;if(ce.IsCallable(r)){var o=t(r,"",' " ');var i=P([],o.match(/"/g)).length;n=o!==o.toLowerCase()||i>2}else{n=true}if(n){ne(String.prototype,e,Ln[e])}});var Fn=function(){if(!oe){return false}var e=typeof JSON==="object"&&typeof JSON.stringify==="function"?JSON.stringify:null;if(!e){return false}if(typeof e($())!=="undefined"){return true}if(e([$()])!=="[null]"){return true}var t={a:$()};t[$()]=true;if(e(t)!=="{}"){return true}return false}();var Dn=a(function(){if(!oe){return true}return JSON.stringify(Object($()))==="{}"&&JSON.stringify([Object($())])==="[{}]"});if(Fn||!Dn){var zn=JSON.stringify;ne(JSON,"stringify",function stringify(e){if(typeof e==="symbol"){return}var n;if(arguments.length>1){n=arguments[1]}var o=[e];if(!r(n)){var i=ce.IsCallable(n)?n:null;var a=function(e,r){var n=i?t(i,this,e,r):r;if(typeof n!=="symbol"){if(re.symbol(n)){return Nt({})(n)}else{return n}}};o.push(a)}else{o.push(n)}if(arguments.length>2){o.push(arguments[2])}return zn.apply(this,o)})}return S});
/*! jQuery v3.6.0 | (c) OpenJS Foundation and other contributors | jquery.org/license */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(C,e){"use strict";var t=[],r=Object.getPrototypeOf,s=t.slice,g=t.flat?function(e){return t.flat.call(e)}:function(e){return t.concat.apply([],e)},u=t.push,i=t.indexOf,n={},o=n.toString,v=n.hasOwnProperty,a=v.toString,l=a.call(Object),y={},m=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType&&"function"!=typeof e.item},x=function(e){return null!=e&&e===e.window},E=C.document,c={type:!0,src:!0,nonce:!0,noModule:!0};function b(e,t,n){var r,i,o=(n=n||E).createElement("script");if(o.text=e,t)for(r in c)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function w(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[o.call(e)]||"object":typeof e}var f="3.6.0",S=function(e,t){return new S.fn.init(e,t)};function p(e){var t=!!e&&"length"in e&&e.length,n=w(e);return!m(e)&&!x(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}S.fn=S.prototype={jquery:f,constructor:S,length:0,toArray:function(){return s.call(this)},get:function(e){return null==e?s.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=S.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return S.each(this,e)},map:function(n){return this.pushStack(S.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(s.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(S.grep(this,function(e,t){return(t+1)%2}))},odd:function(){return this.pushStack(S.grep(this,function(e,t){return t%2}))},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:u,sort:t.sort,splice:t.splice},S.extend=S.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||m(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(S.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||S.isPlainObject(n)?n:{},i=!1,a[t]=S.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},S.extend({expando:"jQuery"+(f+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==o.call(e))&&(!(t=r(e))||"function"==typeof(n=v.call(t,"constructor")&&t.constructor)&&a.call(n)===l)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t,n){b(e,{nonce:t&&t.nonce},n)},each:function(e,t){var n,r=0;if(p(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},makeArray:function(e,t){var n=t||[];return null!=e&&(p(Object(e))?S.merge(n,"string"==typeof e?[e]:e):u.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:i.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(p(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g(a)},guid:1,support:y}),"function"==typeof Symbol&&(S.fn[Symbol.iterator]=t[Symbol.iterator]),S.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var d=function(n){var e,d,b,o,i,h,f,g,w,u,l,T,C,a,E,v,s,c,y,S="sizzle"+1*new Date,p=n.document,k=0,r=0,m=ue(),x=ue(),A=ue(),N=ue(),j=function(e,t){return e===t&&(l=!0),0},D={}.hasOwnProperty,t=[],q=t.pop,L=t.push,H=t.push,O=t.slice,P=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},R="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",M="[\\x20\\t\\r\\n\\f]",I="(?:\\\\[\\da-fA-F]{1,6}"+M+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",W="\\["+M+"*("+I+")(?:"+M+"*([*^$|!~]?=)"+M+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+I+"))|)"+M+"*\\]",F=":("+I+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+W+")*)|.*)\\)|)",B=new RegExp(M+"+","g"),$=new RegExp("^"+M+"+|((?:^|[^\\\\])(?:\\\\.)*)"+M+"+$","g"),_=new RegExp("^"+M+"*,"+M+"*"),z=new RegExp("^"+M+"*([>+~]|"+M+")"+M+"*"),U=new RegExp(M+"|>"),X=new RegExp(F),V=new RegExp("^"+I+"$"),G={ID:new RegExp("^#("+I+")"),CLASS:new RegExp("^\\.("+I+")"),TAG:new RegExp("^("+I+"|[*])"),ATTR:new RegExp("^"+W),PSEUDO:new RegExp("^"+F),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+M+"*(even|odd|(([+-]|)(\\d*)n|)"+M+"*(?:([+-]|)"+M+"*(\\d+)|))"+M+"*\\)|)","i"),bool:new RegExp("^(?:"+R+")$","i"),needsContext:new RegExp("^"+M+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+M+"*((?:-\\d)?\\d*)"+M+"*\\)|)(?=[^-]|$)","i")},Y=/HTML$/i,Q=/^(?:input|select|textarea|button)$/i,J=/^h\d$/i,K=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ee=/[+~]/,te=new RegExp("\\\\[\\da-fA-F]{1,6}"+M+"?|\\\\([^\\r\\n\\f])","g"),ne=function(e,t){var n="0x"+e.slice(1)-65536;return t||(n<0?String.fromCharCode(n+65536):String.fromCharCode(n>>10|55296,1023&n|56320))},re=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,ie=function(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},oe=function(){T()},ae=be(function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()},{dir:"parentNode",next:"legend"});try{H.apply(t=O.call(p.childNodes),p.childNodes),t[p.childNodes.length].nodeType}catch(e){H={apply:t.length?function(e,t){L.apply(e,O.call(t))}:function(e,t){var n=e.length,r=0;while(e[n++]=t[r++]);e.length=n-1}}}function se(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&(T(e),e=e||C,E)){if(11!==p&&(u=Z.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return n.push(a),n}else if(f&&(a=f.getElementById(i))&&y(e,a)&&a.id===i)return n.push(a),n}else{if(u[2])return H.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&d.getElementsByClassName&&e.getElementsByClassName)return H.apply(n,e.getElementsByClassName(i)),n}if(d.qsa&&!N[t+" "]&&(!v||!v.test(t))&&(1!==p||"object"!==e.nodeName.toLowerCase())){if(c=t,f=e,1===p&&(U.test(t)||z.test(t))){(f=ee.test(t)&&ye(e.parentNode)||e)===e&&d.scope||((s=e.getAttribute("id"))?s=s.replace(re,ie):e.setAttribute("id",s=S)),o=(l=h(t)).length;while(o--)l[o]=(s?"#"+s:":scope")+" "+xe(l[o]);c=l.join(",")}try{return H.apply(n,f.querySelectorAll(c)),n}catch(e){N(t,!0)}finally{s===S&&e.removeAttribute("id")}}}return g(t.replace($,"$1"),e,n,r)}function ue(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function le(e){return e[S]=!0,e}function ce(e){var t=C.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function fe(e,t){var n=e.split("|"),r=n.length;while(r--)b.attrHandle[n[r]]=t}function pe(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function de(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function he(n){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===n}}function ge(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&ae(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function ve(a){return le(function(o){return o=+o,le(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function ye(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}for(e in d=se.support={},i=se.isXML=function(e){var t=e&&e.namespaceURI,n=e&&(e.ownerDocument||e).documentElement;return!Y.test(t||n&&n.nodeName||"HTML")},T=se.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:p;return r!=C&&9===r.nodeType&&r.documentElement&&(a=(C=r).documentElement,E=!i(C),p!=C&&(n=C.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",oe,!1):n.attachEvent&&n.attachEvent("onunload",oe)),d.scope=ce(function(e){return a.appendChild(e).appendChild(C.createElement("div")),"undefined"!=typeof e.querySelectorAll&&!e.querySelectorAll(":scope fieldset div").length}),d.attributes=ce(function(e){return e.className="i",!e.getAttribute("className")}),d.getElementsByTagName=ce(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),d.getElementsByClassName=K.test(C.getElementsByClassName),d.getById=ce(function(e){return a.appendChild(e).id=S,!C.getElementsByName||!C.getElementsByName(S).length}),d.getById?(b.filter.ID=function(e){var t=e.replace(te,ne);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(te,ne);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=d.getElementsByTagName?function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):d.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},b.find.CLASS=d.getElementsByClassName&&function(e,t){if("undefined"!=typeof t.getElementsByClassName&&E)return t.getElementsByClassName(e)},s=[],v=[],(d.qsa=K.test(C.querySelectorAll))&&(ce(function(e){var t;a.appendChild(e).innerHTML="<a id='"+S+"'></a><select id='"+S+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&v.push("[*^$]="+M+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||v.push("\\["+M+"*(?:value|"+R+")"),e.querySelectorAll("[id~="+S+"-]").length||v.push("~="),(t=C.createElement("input")).setAttribute("name",""),e.appendChild(t),e.querySelectorAll("[name='']").length||v.push("\\["+M+"*name"+M+"*="+M+"*(?:''|\"\")"),e.querySelectorAll(":checked").length||v.push(":checked"),e.querySelectorAll("a#"+S+"+*").length||v.push(".#.+[+~]"),e.querySelectorAll("\\\f"),v.push("[\\r\\n\\f]")}),ce(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=C.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&v.push("name"+M+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&v.push(":enabled",":disabled"),a.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&v.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),v.push(",.*:")})),(d.matchesSelector=K.test(c=a.matches||a.webkitMatchesSelector||a.mozMatchesSelector||a.oMatchesSelector||a.msMatchesSelector))&&ce(function(e){d.disconnectedMatch=c.call(e,"*"),c.call(e,"[s!='']:x"),s.push("!=",F)}),v=v.length&&new RegExp(v.join("|")),s=s.length&&new RegExp(s.join("|")),t=K.test(a.compareDocumentPosition),y=t||K.test(a.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},j=t?function(e,t){if(e===t)return l=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)==(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!d.sortDetached&&t.compareDocumentPosition(e)===n?e==C||e.ownerDocument==p&&y(p,e)?-1:t==C||t.ownerDocument==p&&y(p,t)?1:u?P(u,e)-P(u,t):0:4&n?-1:1)}:function(e,t){if(e===t)return l=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e==C?-1:t==C?1:i?-1:o?1:u?P(u,e)-P(u,t):0;if(i===o)return pe(e,t);n=e;while(n=n.parentNode)a.unshift(n);n=t;while(n=n.parentNode)s.unshift(n);while(a[r]===s[r])r++;return r?pe(a[r],s[r]):a[r]==p?-1:s[r]==p?1:0}),C},se.matches=function(e,t){return se(e,null,null,t)},se.matchesSelector=function(e,t){if(T(e),d.matchesSelector&&E&&!N[t+" "]&&(!s||!s.test(t))&&(!v||!v.test(t)))try{var n=c.call(e,t);if(n||d.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){N(t,!0)}return 0<se(t,C,null,[e]).length},se.contains=function(e,t){return(e.ownerDocument||e)!=C&&T(e),y(e,t)},se.attr=function(e,t){(e.ownerDocument||e)!=C&&T(e);var n=b.attrHandle[t.toLowerCase()],r=n&&D.call(b.attrHandle,t.toLowerCase())?n(e,t,!E):void 0;return void 0!==r?r:d.attributes||!E?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},se.escape=function(e){return(e+"").replace(re,ie)},se.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},se.uniqueSort=function(e){var t,n=[],r=0,i=0;if(l=!d.detectDuplicates,u=!d.sortStable&&e.slice(0),e.sort(j),l){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)e.splice(n[r],1)}return u=null,e},o=se.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else while(t=e[r++])n+=o(t);return n},(b=se.selectors={cacheLength:50,createPseudo:le,match:G,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(te,ne),e[3]=(e[3]||e[4]||e[5]||"").replace(te,ne),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||se.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&se.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return G.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&X.test(n)&&(t=h(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(te,ne).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=m[e+" "];return t||(t=new RegExp("(^|"+M+")"+e+"("+M+"|$)"))&&m(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=se.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(B," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(h,e,t,g,v){var y="nth"!==h.slice(0,3),m="last"!==h.slice(-4),x="of-type"===e;return 1===g&&0===v?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u,l=y!==m?"nextSibling":"previousSibling",c=e.parentNode,f=x&&e.nodeName.toLowerCase(),p=!n&&!x,d=!1;if(c){if(y){while(l){a=e;while(a=a[l])if(x?a.nodeName.toLowerCase()===f:1===a.nodeType)return!1;u=l="only"===h&&!u&&"nextSibling"}return!0}if(u=[m?c.firstChild:c.lastChild],m&&p){d=(s=(r=(i=(o=(a=c)[S]||(a[S]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===k&&r[1])&&r[2],a=s&&c.childNodes[s];while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if(1===a.nodeType&&++d&&a===e){i[h]=[k,s,d];break}}else if(p&&(d=s=(r=(i=(o=(a=e)[S]||(a[S]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===k&&r[1]),!1===d)while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if((x?a.nodeName.toLowerCase()===f:1===a.nodeType)&&++d&&(p&&((i=(o=a[S]||(a[S]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]=[k,d]),a===e))break;return(d-=v)===g||d%g==0&&0<=d/g}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||se.error("unsupported pseudo: "+e);return a[S]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?le(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=P(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:le(function(e){var r=[],i=[],s=f(e.replace($,"$1"));return s[S]?le(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:le(function(t){return function(e){return 0<se(t,e).length}}),contains:le(function(t){return t=t.replace(te,ne),function(e){return-1<(e.textContent||o(e)).indexOf(t)}}),lang:le(function(n){return V.test(n||"")||se.error("unsupported lang: "+n),n=n.replace(te,ne).toLowerCase(),function(e){var t;do{if(t=E?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=n.location&&n.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===a},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:ge(!1),disabled:ge(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return J.test(e.nodeName)},input:function(e){return Q.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:ve(function(){return[0]}),last:ve(function(e,t){return[t-1]}),eq:ve(function(e,t,n){return[n<0?n+t:n]}),even:ve(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:ve(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:ve(function(e,t,n){for(var r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:ve(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=de(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=he(e);function me(){}function xe(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function be(s,e,t){var u=e.dir,l=e.next,c=l||u,f=t&&"parentNode"===c,p=r++;return e.first?function(e,t,n){while(e=e[u])if(1===e.nodeType||f)return s(e,t,n);return!1}:function(e,t,n){var r,i,o,a=[k,p];if(n){while(e=e[u])if((1===e.nodeType||f)&&s(e,t,n))return!0}else while(e=e[u])if(1===e.nodeType||f)if(i=(o=e[S]||(e[S]={}))[e.uniqueID]||(o[e.uniqueID]={}),l&&l===e.nodeName.toLowerCase())e=e[u]||e;else{if((r=i[c])&&r[0]===k&&r[1]===p)return a[2]=r[2];if((i[c]=a)[2]=s(e,t,n))return!0}return!1}}function we(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Te(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function Ce(d,h,g,v,y,e){return v&&!v[S]&&(v=Ce(v)),y&&!y[S]&&(y=Ce(y,e)),le(function(e,t,n,r){var i,o,a,s=[],u=[],l=t.length,c=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)se(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),f=!d||!e&&h?c:Te(c,s,d,n,r),p=g?y||(e?d:l||v)?[]:t:f;if(g&&g(f,p,n,r),v){i=Te(p,u),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(p[u[o]]=!(f[u[o]]=a))}if(e){if(y||d){if(y){i=[],o=p.length;while(o--)(a=p[o])&&i.push(f[o]=a);y(null,p=[],i,r)}o=p.length;while(o--)(a=p[o])&&-1<(i=y?P(e,a):s[o])&&(e[i]=!(t[i]=a))}}else p=Te(p===t?p.splice(l,p.length):p),y?y(null,t,p,r):H.apply(t,p)})}function Ee(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=be(function(e){return e===i},a,!0),l=be(function(e){return-1<P(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!==w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[be(we(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[S]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return Ce(1<s&&we(c),1<s&&xe(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace($,"$1"),t,s<n&&Ee(e.slice(s,n)),n<r&&Ee(e=e.slice(n)),n<r&&xe(e))}c.push(t)}return we(c)}return me.prototype=b.filters=b.pseudos,b.setFilters=new me,h=se.tokenize=function(e,t){var n,r,i,o,a,s,u,l=x[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=_.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=z.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace($," ")}),a=a.slice(n.length)),b.filter)!(r=G[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?se.error(e):x(e,s).slice(0)},f=se.compile=function(e,t){var n,v,y,m,x,r,i=[],o=[],a=A[e+" "];if(!a){t||(t=h(e)),n=t.length;while(n--)(a=Ee(t[n]))[S]?i.push(a):o.push(a);(a=A(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=k+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t==C||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument==C||(T(o),n=!E);while(s=v[a++])if(s(o,t||C,n)){r.push(o);break}i&&(k=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=q.call(r));f=Te(f)}H.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&se.uniqueSort(r)}return i&&(k=h,w=p),c},m?le(r):r))).selector=e}return a},g=se.select=function(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&h(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&E&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(te,ne),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=G.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(te,ne),ee.test(o[0].type)&&ye(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&xe(o)))return H.apply(n,r),n;break}}}return(l||f(e,c))(r,t,!E,n,!t||ee.test(e)&&ye(t.parentNode)||t),n},d.sortStable=S.split("").sort(j).join("")===S,d.detectDuplicates=!!l,T(),d.sortDetached=ce(function(e){return 1&e.compareDocumentPosition(C.createElement("fieldset"))}),ce(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||fe("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),d.attributes&&ce(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||fe("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),ce(function(e){return null==e.getAttribute("disabled")})||fe(R,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),se}(C);S.find=d,S.expr=d.selectors,S.expr[":"]=S.expr.pseudos,S.uniqueSort=S.unique=d.uniqueSort,S.text=d.getText,S.isXMLDoc=d.isXML,S.contains=d.contains,S.escapeSelector=d.escape;var h=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&S(e).is(n))break;r.push(e)}return r},T=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},k=S.expr.match.needsContext;function A(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var N=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function j(e,n,r){return m(n)?S.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?S.grep(e,function(e){return e===n!==r}):"string"!=typeof n?S.grep(e,function(e){return-1<i.call(n,e)!==r}):S.filter(n,e,r)}S.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?S.find.matchesSelector(r,e)?[r]:[]:S.find.matches(e,S.grep(t,function(e){return 1===e.nodeType}))},S.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(S(e).filter(function(){for(t=0;t<r;t++)if(S.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)S.find(e,i[t],n);return 1<r?S.uniqueSort(n):n},filter:function(e){return this.pushStack(j(this,e||[],!1))},not:function(e){return this.pushStack(j(this,e||[],!0))},is:function(e){return!!j(this,"string"==typeof e&&k.test(e)?S(e):e||[],!1).length}});var D,q=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(S.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||D,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:q.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof S?t[0]:t,S.merge(this,S.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:E,!0)),N.test(r[1])&&S.isPlainObject(t))for(r in t)m(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=E.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):m(e)?void 0!==n.ready?n.ready(e):e(S):S.makeArray(e,this)}).prototype=S.fn,D=S(E);var L=/^(?:parents|prev(?:Until|All))/,H={children:!0,contents:!0,next:!0,prev:!0};function O(e,t){while((e=e[t])&&1!==e.nodeType);return e}S.fn.extend({has:function(e){var t=S(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(S.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&S(e);if(!k.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&S.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?S.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?i.call(S(e),this[0]):i.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(S.uniqueSort(S.merge(this.get(),S(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),S.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return h(e,"parentNode")},parentsUntil:function(e,t,n){return h(e,"parentNode",n)},next:function(e){return O(e,"nextSibling")},prev:function(e){return O(e,"previousSibling")},nextAll:function(e){return h(e,"nextSibling")},prevAll:function(e){return h(e,"previousSibling")},nextUntil:function(e,t,n){return h(e,"nextSibling",n)},prevUntil:function(e,t,n){return h(e,"previousSibling",n)},siblings:function(e){return T((e.parentNode||{}).firstChild,e)},children:function(e){return T(e.firstChild)},contents:function(e){return null!=e.contentDocument&&r(e.contentDocument)?e.contentDocument:(A(e,"template")&&(e=e.content||e),S.merge([],e.childNodes))}},function(r,i){S.fn[r]=function(e,t){var n=S.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=S.filter(t,n)),1<this.length&&(H[r]||S.uniqueSort(n),L.test(r)&&n.reverse()),this.pushStack(n)}});var P=/[^\x20\t\r\n\f]+/g;function R(e){return e}function M(e){throw e}function I(e,t,n,r){var i;try{e&&m(i=e.promise)?i.call(e).done(t).fail(n):e&&m(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}S.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},S.each(e.match(P)||[],function(e,t){n[t]=!0}),n):S.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){S.each(e,function(e,t){m(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==w(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return S.each(arguments,function(e,t){var n;while(-1<(n=S.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<S.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},S.extend({Deferred:function(e){var o=[["notify","progress",S.Callbacks("memory"),S.Callbacks("memory"),2],["resolve","done",S.Callbacks("once memory"),S.Callbacks("once memory"),0,"resolved"],["reject","fail",S.Callbacks("once memory"),S.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return S.Deferred(function(r){S.each(o,function(e,t){var n=m(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&m(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,m(t)?s?t.call(e,l(u,o,R,s),l(u,o,M,s)):(u++,t.call(e,l(u,o,R,s),l(u,o,M,s),l(u,o,R,o.notifyWith))):(a!==R&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){S.Deferred.exceptionHook&&S.Deferred.exceptionHook(e,t.stackTrace),u<=i+1&&(a!==M&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(S.Deferred.getStackHook&&(t.stackTrace=S.Deferred.getStackHook()),C.setTimeout(t))}}return S.Deferred(function(e){o[0][3].add(l(0,e,m(r)?r:R,e.notifyWith)),o[1][3].add(l(0,e,m(t)?t:R)),o[2][3].add(l(0,e,m(n)?n:M))}).promise()},promise:function(e){return null!=e?S.extend(e,a):a}},s={};return S.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=s.call(arguments),o=S.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?s.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(I(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||m(i[t]&&i[t].then)))return o.then();while(t--)I(i[t],a(t),o.reject);return o.promise()}});var W=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;S.Deferred.exceptionHook=function(e,t){C.console&&C.console.warn&&e&&W.test(e.name)&&C.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},S.readyException=function(e){C.setTimeout(function(){throw e})};var F=S.Deferred();function B(){E.removeEventListener("DOMContentLoaded",B),C.removeEventListener("load",B),S.ready()}S.fn.ready=function(e){return F.then(e)["catch"](function(e){S.readyException(e)}),this},S.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--S.readyWait:S.isReady)||(S.isReady=!0)!==e&&0<--S.readyWait||F.resolveWith(E,[S])}}),S.ready.then=F.then,"complete"===E.readyState||"loading"!==E.readyState&&!E.documentElement.doScroll?C.setTimeout(S.ready):(E.addEventListener("DOMContentLoaded",B),C.addEventListener("load",B));var $=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===w(n))for(s in i=!0,n)$(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,m(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(S(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},_=/^-ms-/,z=/-([a-z])/g;function U(e,t){return t.toUpperCase()}function X(e){return e.replace(_,"ms-").replace(z,U)}var V=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function G(){this.expando=S.expando+G.uid++}G.uid=1,G.prototype={cache:function(e){var t=e[this.expando];return t||(t={},V(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[X(t)]=n;else for(r in t)i[X(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][X(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(X):(t=X(t))in r?[t]:t.match(P)||[]).length;while(n--)delete r[t[n]]}(void 0===t||S.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!S.isEmptyObject(t)}};var Y=new G,Q=new G,J=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,K=/[A-Z]/g;function Z(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(K,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:J.test(i)?JSON.parse(i):i)}catch(e){}Q.set(e,t,n)}else n=void 0;return n}S.extend({hasData:function(e){return Q.hasData(e)||Y.hasData(e)},data:function(e,t,n){return Q.access(e,t,n)},removeData:function(e,t){Q.remove(e,t)},_data:function(e,t,n){return Y.access(e,t,n)},_removeData:function(e,t){Y.remove(e,t)}}),S.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=Q.get(o),1===o.nodeType&&!Y.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=X(r.slice(5)),Z(o,r,i[r]));Y.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){Q.set(this,n)}):$(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=Q.get(o,n))?t:void 0!==(t=Z(o,n))?t:void 0;this.each(function(){Q.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){Q.remove(this,e)})}}),S.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=Y.get(e,t),n&&(!r||Array.isArray(n)?r=Y.access(e,t,S.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=S.queue(e,t),r=n.length,i=n.shift(),o=S._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){S.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return Y.get(e,n)||Y.access(e,n,{empty:S.Callbacks("once memory").add(function(){Y.remove(e,[t+"queue",n])})})}}),S.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?S.queue(this[0],t):void 0===n?this:this.each(function(){var e=S.queue(this,t,n);S._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&S.dequeue(this,t)})},dequeue:function(e){return this.each(function(){S.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=S.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=Y.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var ee=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,te=new RegExp("^(?:([+-])=|)("+ee+")([a-z%]*)$","i"),ne=["Top","Right","Bottom","Left"],re=E.documentElement,ie=function(e){return S.contains(e.ownerDocument,e)},oe={composed:!0};re.getRootNode&&(ie=function(e){return S.contains(e.ownerDocument,e)||e.getRootNode(oe)===e.ownerDocument});var ae=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&ie(e)&&"none"===S.css(e,"display")};function se(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return S.css(e,t,"")},u=s(),l=n&&n[3]||(S.cssNumber[t]?"":"px"),c=e.nodeType&&(S.cssNumber[t]||"px"!==l&&+u)&&te.exec(S.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)S.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,S.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ue={};function le(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=Y.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&ae(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ue[s])||(o=a.body.appendChild(a.createElement(s)),u=S.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ue[s]=u)))):"none"!==n&&(l[c]="none",Y.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}S.fn.extend({show:function(){return le(this,!0)},hide:function(){return le(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ae(this)?S(this).show():S(this).hide()})}});var ce,fe,pe=/^(?:checkbox|radio)$/i,de=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,he=/^$|^module$|\/(?:java|ecma)script/i;ce=E.createDocumentFragment().appendChild(E.createElement("div")),(fe=E.createElement("input")).setAttribute("type","radio"),fe.setAttribute("checked","checked"),fe.setAttribute("name","t"),ce.appendChild(fe),y.checkClone=ce.cloneNode(!0).cloneNode(!0).lastChild.checked,ce.innerHTML="<textarea>x</textarea>",y.noCloneChecked=!!ce.cloneNode(!0).lastChild.defaultValue,ce.innerHTML="<option></option>",y.option=!!ce.lastChild;var ge={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function ve(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&A(e,t)?S.merge([e],n):n}function ye(e,t){for(var n=0,r=e.length;n<r;n++)Y.set(e[n],"globalEval",!t||Y.get(t[n],"globalEval"))}ge.tbody=ge.tfoot=ge.colgroup=ge.caption=ge.thead,ge.th=ge.td,y.option||(ge.optgroup=ge.option=[1,"<select multiple='multiple'>","</select>"]);var me=/<|&#?\w+;/;function xe(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===w(o))S.merge(p,o.nodeType?[o]:o);else if(me.test(o)){a=a||f.appendChild(t.createElement("div")),s=(de.exec(o)||["",""])[1].toLowerCase(),u=ge[s]||ge._default,a.innerHTML=u[1]+S.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;S.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<S.inArray(o,r))i&&i.push(o);else if(l=ie(o),a=ve(f.appendChild(o),"script"),l&&ye(a),n){c=0;while(o=a[c++])he.test(o.type||"")&&n.push(o)}return f}var be=/^([^.]*)(?:\.(.+)|)/;function we(){return!0}function Te(){return!1}function Ce(e,t){return e===function(){try{return E.activeElement}catch(e){}}()==("focus"===t)}function Ee(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Ee(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=Te;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return S().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=S.guid++)),e.each(function(){S.event.add(this,t,i,r,n)})}function Se(e,i,o){o?(Y.set(e,i,!1),S.event.add(e,i,{namespace:!1,handler:function(e){var t,n,r=Y.get(this,i);if(1&e.isTrigger&&this[i]){if(r.length)(S.event.special[i]||{}).delegateType&&e.stopPropagation();else if(r=s.call(arguments),Y.set(this,i,r),t=o(this,i),this[i](),r!==(n=Y.get(this,i))||t?Y.set(this,i,!1):n={},r!==n)return e.stopImmediatePropagation(),e.preventDefault(),n&&n.value}else r.length&&(Y.set(this,i,{value:S.event.trigger(S.extend(r[0],S.Event.prototype),r.slice(1),this)}),e.stopImmediatePropagation())}})):void 0===Y.get(e,i)&&S.event.add(e,i,we)}S.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Y.get(t);if(V(t)){n.handler&&(n=(o=n).handler,i=o.selector),i&&S.find.matchesSelector(re,i),n.guid||(n.guid=S.guid++),(u=v.events)||(u=v.events=Object.create(null)),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof S&&S.event.triggered!==e.type?S.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(P)||[""]).length;while(l--)d=g=(s=be.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=S.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=S.event.special[d]||{},c=S.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&S.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),S.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Y.hasData(e)&&Y.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(P)||[""]).length;while(l--)if(d=g=(s=be.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=S.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||S.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)S.event.remove(e,d+t[l],n,r,!0);S.isEmptyObject(u)&&Y.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=new Array(arguments.length),u=S.event.fix(e),l=(Y.get(this,"events")||Object.create(null))[u.type]||[],c=S.event.special[u.type]||{};for(s[0]=u,t=1;t<arguments.length;t++)s[t]=arguments[t];if(u.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,u)){a=S.event.handlers.call(this,u,l),t=0;while((i=a[t++])&&!u.isPropagationStopped()){u.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!u.isImmediatePropagationStopped())u.rnamespace&&!1!==o.namespace&&!u.rnamespace.test(o.namespace)||(u.handleObj=o,u.data=o.data,void 0!==(r=((S.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,s))&&!1===(u.result=r)&&(u.preventDefault(),u.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,u),u.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<S(i,this).index(l):S.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(S.Event.prototype,t,{enumerable:!0,configurable:!0,get:m(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[S.expando]?e:new S.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&Se(t,"click",we),!1},trigger:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&Se(t,"click"),!0},_default:function(e){var t=e.target;return pe.test(t.type)&&t.click&&A(t,"input")&&Y.get(t,"click")||A(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},S.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},S.Event=function(e,t){if(!(this instanceof S.Event))return new S.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?we:Te,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&S.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[S.expando]=!0},S.Event.prototype={constructor:S.Event,isDefaultPrevented:Te,isPropagationStopped:Te,isImmediatePropagationStopped:Te,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=we,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=we,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=we,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},S.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},S.event.addProp),S.each({focus:"focusin",blur:"focusout"},function(e,t){S.event.special[e]={setup:function(){return Se(this,e,Ce),!1},trigger:function(){return Se(this,e),!0},_default:function(){return!0},delegateType:t}}),S.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){S.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||S.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),S.fn.extend({on:function(e,t,n,r){return Ee(this,e,t,n,r)},one:function(e,t,n,r){return Ee(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,S(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=Te),this.each(function(){S.event.remove(this,e,n,t)})}});var ke=/<script|<style|<link/i,Ae=/checked\s*(?:[^=]|=\s*.checked.)/i,Ne=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function je(e,t){return A(e,"table")&&A(11!==t.nodeType?t:t.firstChild,"tr")&&S(e).children("tbody")[0]||e}function De(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function qe(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Le(e,t){var n,r,i,o,a,s;if(1===t.nodeType){if(Y.hasData(e)&&(s=Y.get(e).events))for(i in Y.remove(t,"handle events"),s)for(n=0,r=s[i].length;n<r;n++)S.event.add(t,i,s[i][n]);Q.hasData(e)&&(o=Q.access(e),a=S.extend({},o),Q.set(t,a))}}function He(n,r,i,o){r=g(r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=m(d);if(h||1<f&&"string"==typeof d&&!y.checkClone&&Ae.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),He(t,r,i,o)});if(f&&(t=(e=xe(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=S.map(ve(e,"script"),De)).length;c<f;c++)u=e,c!==p&&(u=S.clone(u,!0,!0),s&&S.merge(a,ve(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,S.map(a,qe),c=0;c<s;c++)u=a[c],he.test(u.type||"")&&!Y.access(u,"globalEval")&&S.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?S._evalUrl&&!u.noModule&&S._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")},l):b(u.textContent.replace(Ne,""),u,l))}return n}function Oe(e,t,n){for(var r,i=t?S.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||S.cleanData(ve(r)),r.parentNode&&(n&&ie(r)&&ye(ve(r,"script")),r.parentNode.removeChild(r));return e}S.extend({htmlPrefilter:function(e){return e},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=ie(e);if(!(y.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||S.isXMLDoc(e)))for(a=ve(c),r=0,i=(o=ve(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&pe.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||ve(e),a=a||ve(c),r=0,i=o.length;r<i;r++)Le(o[r],a[r]);else Le(e,c);return 0<(a=ve(c,"script")).length&&ye(a,!f&&ve(e,"script")),c},cleanData:function(e){for(var t,n,r,i=S.event.special,o=0;void 0!==(n=e[o]);o++)if(V(n)){if(t=n[Y.expando]){if(t.events)for(r in t.events)i[r]?S.event.remove(n,r):S.removeEvent(n,r,t.handle);n[Y.expando]=void 0}n[Q.expando]&&(n[Q.expando]=void 0)}}}),S.fn.extend({detach:function(e){return Oe(this,e,!0)},remove:function(e){return Oe(this,e)},text:function(e){return $(this,function(e){return void 0===e?S.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return He(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||je(this,e).appendChild(e)})},prepend:function(){return He(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=je(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return He(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return He(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(S.cleanData(ve(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return S.clone(this,e,t)})},html:function(e){return $(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!ke.test(e)&&!ge[(de.exec(e)||["",""])[1].toLowerCase()]){e=S.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(S.cleanData(ve(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return He(this,arguments,function(e){var t=this.parentNode;S.inArray(this,n)<0&&(S.cleanData(ve(this)),t&&t.replaceChild(e,this))},n)}}),S.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){S.fn[e]=function(e){for(var t,n=[],r=S(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),S(r[o])[a](t),u.apply(n,t.get());return this.pushStack(n)}});var Pe=new RegExp("^("+ee+")(?!px)[a-z%]+$","i"),Re=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=C),t.getComputedStyle(e)},Me=function(e,t,n){var r,i,o={};for(i in t)o[i]=e.style[i],e.style[i]=t[i];for(i in r=n.call(e),t)e.style[i]=o[i];return r},Ie=new RegExp(ne.join("|"),"i");function We(e,t,n){var r,i,o,a,s=e.style;return(n=n||Re(e))&&(""!==(a=n.getPropertyValue(t)||n[t])||ie(e)||(a=S.style(e,t)),!y.pixelBoxStyles()&&Pe.test(a)&&Ie.test(t)&&(r=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=r,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function Fe(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(l){u.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",l.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",re.appendChild(u).appendChild(l);var e=C.getComputedStyle(l);n="1%"!==e.top,s=12===t(e.marginLeft),l.style.right="60%",o=36===t(e.right),r=36===t(e.width),l.style.position="absolute",i=12===t(l.offsetWidth/3),re.removeChild(u),l=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s,u=E.createElement("div"),l=E.createElement("div");l.style&&(l.style.backgroundClip="content-box",l.cloneNode(!0).style.backgroundClip="",y.clearCloneStyle="content-box"===l.style.backgroundClip,S.extend(y,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),s},scrollboxSize:function(){return e(),i},reliableTrDimensions:function(){var e,t,n,r;return null==a&&(e=E.createElement("table"),t=E.createElement("tr"),n=E.createElement("div"),e.style.cssText="position:absolute;left:-11111px;border-collapse:separate",t.style.cssText="border:1px solid",t.style.height="1px",n.style.height="9px",n.style.display="block",re.appendChild(e).appendChild(t).appendChild(n),r=C.getComputedStyle(t),a=parseInt(r.height,10)+parseInt(r.borderTopWidth,10)+parseInt(r.borderBottomWidth,10)===t.offsetHeight,re.removeChild(e)),a}}))}();var Be=["Webkit","Moz","ms"],$e=E.createElement("div").style,_e={};function ze(e){var t=S.cssProps[e]||_e[e];return t||(e in $e?e:_e[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Be.length;while(n--)if((e=Be[n]+t)in $e)return e}(e)||e)}var Ue=/^(none|table(?!-c[ea]).+)/,Xe=/^--/,Ve={position:"absolute",visibility:"hidden",display:"block"},Ge={letterSpacing:"0",fontWeight:"400"};function Ye(e,t,n){var r=te.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function Qe(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(u+=S.css(e,n+ne[a],!0,i)),r?("content"===n&&(u-=S.css(e,"padding"+ne[a],!0,i)),"margin"!==n&&(u-=S.css(e,"border"+ne[a]+"Width",!0,i))):(u+=S.css(e,"padding"+ne[a],!0,i),"padding"!==n?u+=S.css(e,"border"+ne[a]+"Width",!0,i):s+=S.css(e,"border"+ne[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u}function Je(e,t,n){var r=Re(e),i=(!y.boxSizingReliable()||n)&&"border-box"===S.css(e,"boxSizing",!1,r),o=i,a=We(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(Pe.test(a)){if(!n)return a;a="auto"}return(!y.boxSizingReliable()&&i||!y.reliableTrDimensions()&&A(e,"tr")||"auto"===a||!parseFloat(a)&&"inline"===S.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===S.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+Qe(e,t,n||(i?"border":"content"),o,r,a)+"px"}function Ke(e,t,n,r,i){return new Ke.prototype.init(e,t,n,r,i)}S.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=We(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=X(t),u=Xe.test(t),l=e.style;if(u||(t=ze(s)),a=S.cssHooks[t]||S.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=te.exec(n))&&i[1]&&(n=se(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(S.cssNumber[s]?"":"px")),y.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=X(t);return Xe.test(t)||(t=ze(s)),(a=S.cssHooks[t]||S.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=We(e,t,r)),"normal"===i&&t in Ge&&(i=Ge[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),S.each(["height","width"],function(e,u){S.cssHooks[u]={get:function(e,t,n){if(t)return!Ue.test(S.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?Je(e,u,n):Me(e,Ve,function(){return Je(e,u,n)})},set:function(e,t,n){var r,i=Re(e),o=!y.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===S.css(e,"boxSizing",!1,i),s=n?Qe(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-Qe(e,u,"border",!1,i)-.5)),s&&(r=te.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=S.css(e,u)),Ye(0,t,s)}}}),S.cssHooks.marginLeft=Fe(y.reliableMarginLeft,function(e,t){if(t)return(parseFloat(We(e,"marginLeft"))||e.getBoundingClientRect().left-Me(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),S.each({margin:"",padding:"",border:"Width"},function(i,o){S.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+ne[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(S.cssHooks[i+o].set=Ye)}),S.fn.extend({css:function(e,t){return $(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Re(e),i=t.length;a<i;a++)o[t[a]]=S.css(e,t[a],!1,r);return o}return void 0!==n?S.style(e,t,n):S.css(e,t)},e,t,1<arguments.length)}}),((S.Tween=Ke).prototype={constructor:Ke,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||S.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(S.cssNumber[n]?"":"px")},cur:function(){var e=Ke.propHooks[this.prop];return e&&e.get?e.get(this):Ke.propHooks._default.get(this)},run:function(e){var t,n=Ke.propHooks[this.prop];return this.options.duration?this.pos=t=S.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):Ke.propHooks._default.set(this),this}}).init.prototype=Ke.prototype,(Ke.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=S.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){S.fx.step[e.prop]?S.fx.step[e.prop](e):1!==e.elem.nodeType||!S.cssHooks[e.prop]&&null==e.elem.style[ze(e.prop)]?e.elem[e.prop]=e.now:S.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=Ke.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},S.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},S.fx=Ke.prototype.init,S.fx.step={};var Ze,et,tt,nt,rt=/^(?:toggle|show|hide)$/,it=/queueHooks$/;function ot(){et&&(!1===E.hidden&&C.requestAnimationFrame?C.requestAnimationFrame(ot):C.setTimeout(ot,S.fx.interval),S.fx.tick())}function at(){return C.setTimeout(function(){Ze=void 0}),Ze=Date.now()}function st(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=ne[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function ut(e,t,n){for(var r,i=(lt.tweeners[t]||[]).concat(lt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function lt(o,e,t){var n,a,r=0,i=lt.prefilters.length,s=S.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=Ze||at(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:S.extend({},e),opts:S.extend(!0,{specialEasing:{},easing:S.easing._default},t),originalProperties:e,originalOptions:t,startTime:Ze||at(),duration:t.duration,tweens:[],createTween:function(e,t){var n=S.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=X(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=S.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=lt.prefilters[r].call(l,o,c,l.opts))return m(n.stop)&&(S._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return S.map(c,ut,l),m(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),S.fx.timer(S.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}S.Animation=S.extend(lt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return se(n.elem,e,te.exec(t),n),n}]},tweener:function(e,t){m(e)?(t=e,e=["*"]):e=e.match(P);for(var n,r=0,i=e.length;r<i;r++)n=e[r],lt.tweeners[n]=lt.tweeners[n]||[],lt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&ae(e),v=Y.get(e,"fxshow");for(r in n.queue||(null==(a=S._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,S.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],rt.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||S.style(e,r)}if((u=!S.isEmptyObject(t))||!S.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=Y.get(e,"display")),"none"===(c=S.css(e,"display"))&&(l?c=l:(le([e],!0),l=e.style.display||l,c=S.css(e,"display"),le([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===S.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=Y.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&le([e],!0),p.done(function(){for(r in g||le([e]),Y.remove(e,"fxshow"),d)S.style(e,r,d[r])})),u=ut(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?lt.prefilters.unshift(e):lt.prefilters.push(e)}}),S.speed=function(e,t,n){var r=e&&"object"==typeof e?S.extend({},e):{complete:n||!n&&t||m(e)&&e,duration:e,easing:n&&t||t&&!m(t)&&t};return S.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in S.fx.speeds?r.duration=S.fx.speeds[r.duration]:r.duration=S.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){m(r.old)&&r.old.call(this),r.queue&&S.dequeue(this,r.queue)},r},S.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ae).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=S.isEmptyObject(t),o=S.speed(e,n,r),a=function(){var e=lt(this,S.extend({},t),o);(i||Y.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=S.timers,r=Y.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&it.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||S.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=Y.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=S.timers,o=n?n.length:0;for(t.finish=!0,S.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),S.each(["toggle","show","hide"],function(e,r){var i=S.fn[r];S.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(st(r,!0),e,t,n)}}),S.each({slideDown:st("show"),slideUp:st("hide"),slideToggle:st("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){S.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),S.timers=[],S.fx.tick=function(){var e,t=0,n=S.timers;for(Ze=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||S.fx.stop(),Ze=void 0},S.fx.timer=function(e){S.timers.push(e),S.fx.start()},S.fx.interval=13,S.fx.start=function(){et||(et=!0,ot())},S.fx.stop=function(){et=null},S.fx.speeds={slow:600,fast:200,_default:400},S.fn.delay=function(r,e){return r=S.fx&&S.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=C.setTimeout(e,r);t.stop=function(){C.clearTimeout(n)}})},tt=E.createElement("input"),nt=E.createElement("select").appendChild(E.createElement("option")),tt.type="checkbox",y.checkOn=""!==tt.value,y.optSelected=nt.selected,(tt=E.createElement("input")).value="t",tt.type="radio",y.radioValue="t"===tt.value;var ct,ft=S.expr.attrHandle;S.fn.extend({attr:function(e,t){return $(this,S.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){S.removeAttr(this,e)})}}),S.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?S.prop(e,t,n):(1===o&&S.isXMLDoc(e)||(i=S.attrHooks[t.toLowerCase()]||(S.expr.match.bool.test(t)?ct:void 0)),void 0!==n?null===n?void S.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=S.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!y.radioValue&&"radio"===t&&A(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(P);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),ct={set:function(e,t,n){return!1===t?S.removeAttr(e,n):e.setAttribute(n,n),n}},S.each(S.expr.match.bool.source.match(/\w+/g),function(e,t){var a=ft[t]||S.find.attr;ft[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=ft[o],ft[o]=r,r=null!=a(e,t,n)?o:null,ft[o]=i),r}});var pt=/^(?:input|select|textarea|button)$/i,dt=/^(?:a|area)$/i;function ht(e){return(e.match(P)||[]).join(" ")}function gt(e){return e.getAttribute&&e.getAttribute("class")||""}function vt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(P)||[]}S.fn.extend({prop:function(e,t){return $(this,S.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[S.propFix[e]||e]})}}),S.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&S.isXMLDoc(e)||(t=S.propFix[t]||t,i=S.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=S.find.attr(e,"tabindex");return t?parseInt(t,10):pt.test(e.nodeName)||dt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),y.optSelected||(S.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),S.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){S.propFix[this.toLowerCase()]=this}),S.fn.extend({addClass:function(t){var e,n,r,i,o,a,s,u=0;if(m(t))return this.each(function(e){S(this).addClass(t.call(this,e,gt(this)))});if((e=vt(t)).length)while(n=this[u++])if(i=gt(n),r=1===n.nodeType&&" "+ht(i)+" "){a=0;while(o=e[a++])r.indexOf(" "+o+" ")<0&&(r+=o+" ");i!==(s=ht(r))&&n.setAttribute("class",s)}return this},removeClass:function(t){var e,n,r,i,o,a,s,u=0;if(m(t))return this.each(function(e){S(this).removeClass(t.call(this,e,gt(this)))});if(!arguments.length)return this.attr("class","");if((e=vt(t)).length)while(n=this[u++])if(i=gt(n),r=1===n.nodeType&&" "+ht(i)+" "){a=0;while(o=e[a++])while(-1<r.indexOf(" "+o+" "))r=r.replace(" "+o+" "," ");i!==(s=ht(r))&&n.setAttribute("class",s)}return this},toggleClass:function(i,t){var o=typeof i,a="string"===o||Array.isArray(i);return"boolean"==typeof t&&a?t?this.addClass(i):this.removeClass(i):m(i)?this.each(function(e){S(this).toggleClass(i.call(this,e,gt(this),t),t)}):this.each(function(){var e,t,n,r;if(a){t=0,n=S(this),r=vt(i);while(e=r[t++])n.hasClass(e)?n.removeClass(e):n.addClass(e)}else void 0!==i&&"boolean"!==o||((e=gt(this))&&Y.set(this,"__className__",e),this.setAttribute&&this.setAttribute("class",e||!1===i?"":Y.get(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+ht(gt(n))+" ").indexOf(t))return!0;return!1}});var yt=/\r/g;S.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=m(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,S(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=S.map(t,function(e){return null==e?"":e+""})),(r=S.valHooks[this.type]||S.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=S.valHooks[t.type]||S.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(yt,""):null==e?"":e:void 0}}),S.extend({valHooks:{option:{get:function(e){var t=S.find.attr(e,"value");return null!=t?t:ht(S.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!A(n.parentNode,"optgroup"))){if(t=S(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=S.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<S.inArray(S.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),S.each(["radio","checkbox"],function(){S.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<S.inArray(S(e).val(),t)}},y.checkOn||(S.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),y.focusin="onfocusin"in C;var mt=/^(?:focusinfocus|focusoutblur)$/,xt=function(e){e.stopPropagation()};S.extend(S.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||E],d=v.call(e,"type")?e.type:e,h=v.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||E,3!==n.nodeType&&8!==n.nodeType&&!mt.test(d+S.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[S.expando]?e:new S.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:S.makeArray(t,[e]),c=S.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!x(n)){for(s=c.delegateType||d,mt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||E)&&p.push(a.defaultView||a.parentWindow||C)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(Y.get(o,"events")||Object.create(null))[e.type]&&Y.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&V(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!V(n)||u&&m(n[d])&&!x(n)&&((a=n[u])&&(n[u]=null),S.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,xt),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,xt),S.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=S.extend(new S.Event,n,{type:e,isSimulated:!0});S.event.trigger(r,null,t)}}),S.fn.extend({trigger:function(e,t){return this.each(function(){S.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return S.event.trigger(e,t,n,!0)}}),y.focusin||S.each({focus:"focusin",blur:"focusout"},function(n,r){var i=function(e){S.event.simulate(r,e.target,S.event.fix(e))};S.event.special[r]={setup:function(){var e=this.ownerDocument||this.document||this,t=Y.access(e,r);t||e.addEventListener(n,i,!0),Y.access(e,r,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this.document||this,t=Y.access(e,r)-1;t?Y.access(e,r,t):(e.removeEventListener(n,i,!0),Y.remove(e,r))}}});var bt=C.location,wt={guid:Date.now()},Tt=/\?/;S.parseXML=function(e){var t,n;if(!e||"string"!=typeof e)return null;try{t=(new C.DOMParser).parseFromString(e,"text/xml")}catch(e){}return n=t&&t.getElementsByTagName("parsererror")[0],t&&!n||S.error("Invalid XML: "+(n?S.map(n.childNodes,function(e){return e.textContent}).join("\n"):e)),t};var Ct=/\[\]$/,Et=/\r?\n/g,St=/^(?:submit|button|image|reset|file)$/i,kt=/^(?:input|select|textarea|keygen)/i;function At(n,e,r,i){var t;if(Array.isArray(e))S.each(e,function(e,t){r||Ct.test(n)?i(n,t):At(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==w(e))i(n,e);else for(t in e)At(n+"["+t+"]",e[t],r,i)}S.param=function(e,t){var n,r=[],i=function(e,t){var n=m(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!S.isPlainObject(e))S.each(e,function(){i(this.name,this.value)});else for(n in e)At(n,e[n],t,i);return r.join("&")},S.fn.extend({serialize:function(){return S.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=S.prop(this,"elements");return e?S.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!S(this).is(":disabled")&&kt.test(this.nodeName)&&!St.test(e)&&(this.checked||!pe.test(e))}).map(function(e,t){var n=S(this).val();return null==n?null:Array.isArray(n)?S.map(n,function(e){return{name:t.name,value:e.replace(Et,"\r\n")}}):{name:t.name,value:n.replace(Et,"\r\n")}}).get()}});var Nt=/%20/g,jt=/#.*$/,Dt=/([?&])_=[^&]*/,qt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Lt=/^(?:GET|HEAD)$/,Ht=/^\/\//,Ot={},Pt={},Rt="*/".concat("*"),Mt=E.createElement("a");function It(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(P)||[];if(m(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function Wt(t,i,o,a){var s={},u=t===Pt;function l(e){var r;return s[e]=!0,S.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function Ft(e,t){var n,r,i=S.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&S.extend(!0,e,r),e}Mt.href=bt.href,S.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:bt.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(bt.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Rt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":S.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Ft(Ft(e,S.ajaxSettings),t):Ft(S.ajaxSettings,e)},ajaxPrefilter:It(Ot),ajaxTransport:It(Pt),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=S.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?S(y):S.event,x=S.Deferred(),b=S.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=qt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||bt.href)+"").replace(Ht,bt.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(P)||[""],null==v.crossDomain){r=E.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Mt.protocol+"//"+Mt.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=S.param(v.data,v.traditional)),Wt(Ot,v,t,T),h)return T;for(i in(g=S.event&&v.global)&&0==S.active++&&S.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Lt.test(v.type),f=v.url.replace(jt,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Nt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(Tt.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(Dt,"$1"),o=(Tt.test(f)?"&":"?")+"_="+wt.guid+++o),v.url=f+o),v.ifModified&&(S.lastModified[f]&&T.setRequestHeader("If-Modified-Since",S.lastModified[f]),S.etag[f]&&T.setRequestHeader("If-None-Match",S.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+Rt+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=Wt(Pt,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=C.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&C.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),!i&&-1<S.inArray("script",v.dataTypes)&&S.inArray("json",v.dataTypes)<0&&(v.converters["text script"]=function(){}),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(S.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(S.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--S.active||S.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return S.get(e,t,n,"json")},getScript:function(e,t){return S.get(e,void 0,t,"script")}}),S.each(["get","post"],function(e,i){S[i]=function(e,t,n,r){return m(t)&&(r=r||n,n=t,t=void 0),S.ajax(S.extend({url:e,type:i,dataType:r,data:t,success:n},S.isPlainObject(e)&&e))}}),S.ajaxPrefilter(function(e){var t;for(t in e.headers)"content-type"===t.toLowerCase()&&(e.contentType=e.headers[t]||"")}),S._evalUrl=function(e,t,n){return S.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){S.globalEval(e,t,n)}})},S.fn.extend({wrapAll:function(e){var t;return this[0]&&(m(e)&&(e=e.call(this[0])),t=S(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return m(n)?this.each(function(e){S(this).wrapInner(n.call(this,e))}):this.each(function(){var e=S(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=m(t);return this.each(function(e){S(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){S(this).replaceWith(this.childNodes)}),this}}),S.expr.pseudos.hidden=function(e){return!S.expr.pseudos.visible(e)},S.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},S.ajaxSettings.xhr=function(){try{return new C.XMLHttpRequest}catch(e){}};var Bt={0:200,1223:204},$t=S.ajaxSettings.xhr();y.cors=!!$t&&"withCredentials"in $t,y.ajax=$t=!!$t,S.ajaxTransport(function(i){var o,a;if(y.cors||$t&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Bt[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&C.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),S.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),S.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return S.globalEval(e),e}}}),S.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),S.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=S("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),E.head.appendChild(r[0])},abort:function(){i&&i()}}});var _t,zt=[],Ut=/(=)\?(?=&|$)|\?\?/;S.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=zt.pop()||S.expando+"_"+wt.guid++;return this[e]=!0,e}}),S.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Ut.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Ut.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=m(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Ut,"$1"+r):!1!==e.jsonp&&(e.url+=(Tt.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||S.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=C[r],C[r]=function(){o=arguments},n.always(function(){void 0===i?S(C).removeProp(r):C[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,zt.push(r)),o&&m(i)&&i(o[0]),o=i=void 0}),"script"}),y.createHTMLDocument=((_t=E.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===_t.childNodes.length),S.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(y.createHTMLDocument?((r=(t=E.implementation.createHTMLDocument("")).createElement("base")).href=E.location.href,t.head.appendChild(r)):t=E),o=!n&&[],(i=N.exec(e))?[t.createElement(i[1])]:(i=xe([e],t,o),o&&o.length&&S(o).remove(),S.merge([],i.childNodes)));var r,i,o},S.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=ht(e.slice(s)),e=e.slice(0,s)),m(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&S.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?S("<div>").append(S.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},S.expr.pseudos.animated=function(t){return S.grep(S.timers,function(e){return t===e.elem}).length},S.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=S.css(e,"position"),c=S(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=S.css(e,"top"),u=S.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),m(t)&&(t=t.call(e,n,S.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},S.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){S.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===S.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===S.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=S(e).offset()).top+=S.css(e,"borderTopWidth",!0),i.left+=S.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-S.css(r,"marginTop",!0),left:t.left-i.left-S.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===S.css(e,"position"))e=e.offsetParent;return e||re})}}),S.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;S.fn[t]=function(e){return $(this,function(e,t,n){var r;if(x(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),S.each(["top","left"],function(e,n){S.cssHooks[n]=Fe(y.pixelPosition,function(e,t){if(t)return t=We(e,n),Pe.test(t)?S(e).position()[n]+"px":t})}),S.each({Height:"height",Width:"width"},function(a,s){S.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){S.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return $(this,function(e,t,n){var r;return x(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?S.css(e,t,i):S.style(e,t,n,i)},s,n?e:void 0,n)}})}),S.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){S.fn[t]=function(e){return this.on(t,e)}}),S.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)},hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),S.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){S.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}});var Xt=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;S.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),m(e))return r=s.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(s.call(arguments)))}).guid=e.guid=e.guid||S.guid++,i},S.holdReady=function(e){e?S.readyWait++:S.ready(!0)},S.isArray=Array.isArray,S.parseJSON=JSON.parse,S.nodeName=A,S.isFunction=m,S.isWindow=x,S.camelCase=X,S.type=w,S.now=Date.now,S.isNumeric=function(e){var t=S.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},S.trim=function(e){return null==e?"":(e+"").replace(Xt,"")},"function"==typeof define&&define.amd&&define("jquery",[],function(){return S});var Vt=C.jQuery,Gt=C.$;return S.noConflict=function(e){return C.$===S&&(C.$=Gt),e&&C.jQuery===S&&(C.jQuery=Vt),S},"undefined"==typeof e&&(C.jQuery=C.$=S),S});
/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);
/*!
 * imagesLoaded PACKAGED v4.1.4
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */
!function(e,t){"function"==typeof define&&define.amd?define("ev-emitter/ev-emitter",t):"object"==typeof module&&module.exports?module.exports=t():e.EvEmitter=t()}("undefined"!=typeof window?window:this,function(){function e(){}var t=e.prototype;return t.on=function(e,t){if(e&&t){var i=this._events=this._events||{},n=i[e]=i[e]||[];return n.indexOf(t)==-1&&n.push(t),this}},t.once=function(e,t){if(e&&t){this.on(e,t);var i=this._onceEvents=this._onceEvents||{},n=i[e]=i[e]||{};return n[t]=!0,this}},t.off=function(e,t){var i=this._events&&this._events[e];if(i&&i.length){var n=i.indexOf(t);return n!=-1&&i.splice(n,1),this}},t.emitEvent=function(e,t){var i=this._events&&this._events[e];if(i&&i.length){i=i.slice(0),t=t||[];for(var n=this._onceEvents&&this._onceEvents[e],o=0;o<i.length;o++){var r=i[o],s=n&&n[r];s&&(this.off(e,r),delete n[r]),r.apply(this,t)}return this}},t.allOff=function(){delete this._events,delete this._onceEvents},e}),function(e,t){"use strict";"function"==typeof define&&define.amd?define(["ev-emitter/ev-emitter"],function(i){return t(e,i)}):"object"==typeof module&&module.exports?module.exports=t(e,require("ev-emitter")):e.imagesLoaded=t(e,e.EvEmitter)}("undefined"!=typeof window?window:this,function(e,t){function i(e,t){for(var i in t)e[i]=t[i];return e}function n(e){if(Array.isArray(e))return e;var t="object"==typeof e&&"number"==typeof e.length;return t?d.call(e):[e]}function o(e,t,r){if(!(this instanceof o))return new o(e,t,r);var s=e;return"string"==typeof e&&(s=document.querySelectorAll(e)),s?(this.elements=n(s),this.options=i({},this.options),"function"==typeof t?r=t:i(this.options,t),r&&this.on("always",r),this.getImages(),h&&(this.jqDeferred=new h.Deferred),void setTimeout(this.check.bind(this))):void a.error("Bad element for imagesLoaded "+(s||e))}function r(e){this.img=e}function s(e,t){this.url=e,this.element=t,this.img=new Image}var h=e.jQuery,a=e.console,d=Array.prototype.slice;o.prototype=Object.create(t.prototype),o.prototype.options={},o.prototype.getImages=function(){this.images=[],this.elements.forEach(this.addElementImages,this)},o.prototype.addElementImages=function(e){"IMG"==e.nodeName&&this.addImage(e),this.options.background===!0&&this.addElementBackgroundImages(e);var t=e.nodeType;if(t&&u[t]){for(var i=e.querySelectorAll("img"),n=0;n<i.length;n++){var o=i[n];this.addImage(o)}if("string"==typeof this.options.background){var r=e.querySelectorAll(this.options.background);for(n=0;n<r.length;n++){var s=r[n];this.addElementBackgroundImages(s)}}}};var u={1:!0,9:!0,11:!0};return o.prototype.addElementBackgroundImages=function(e){var t=getComputedStyle(e);if(t)for(var i=/url\((['"])?(.*?)\1\)/gi,n=i.exec(t.backgroundImage);null!==n;){var o=n&&n[2];o&&this.addBackground(o,e),n=i.exec(t.backgroundImage)}},o.prototype.addImage=function(e){var t=new r(e);this.images.push(t)},o.prototype.addBackground=function(e,t){var i=new s(e,t);this.images.push(i)},o.prototype.check=function(){function e(e,i,n){setTimeout(function(){t.progress(e,i,n)})}var t=this;return this.progressedCount=0,this.hasAnyBroken=!1,this.images.length?void this.images.forEach(function(t){t.once("progress",e),t.check()}):void this.complete()},o.prototype.progress=function(e,t,i){this.progressedCount++,this.hasAnyBroken=this.hasAnyBroken||!e.isLoaded,this.emitEvent("progress",[this,e,t]),this.jqDeferred&&this.jqDeferred.notify&&this.jqDeferred.notify(this,e),this.progressedCount==this.images.length&&this.complete(),this.options.debug&&a&&a.log("progress: "+i,e,t)},o.prototype.complete=function(){var e=this.hasAnyBroken?"fail":"done";if(this.isComplete=!0,this.emitEvent(e,[this]),this.emitEvent("always",[this]),this.jqDeferred){var t=this.hasAnyBroken?"reject":"resolve";this.jqDeferred[t](this)}},r.prototype=Object.create(t.prototype),r.prototype.check=function(){var e=this.getIsImageComplete();return e?void this.confirm(0!==this.img.naturalWidth,"naturalWidth"):(this.proxyImage=new Image,this.proxyImage.addEventListener("load",this),this.proxyImage.addEventListener("error",this),this.img.addEventListener("load",this),this.img.addEventListener("error",this),void(this.proxyImage.src=this.img.src))},r.prototype.getIsImageComplete=function(){return this.img.complete&&this.img.naturalWidth},r.prototype.confirm=function(e,t){this.isLoaded=e,this.emitEvent("progress",[this,this.img,t])},r.prototype.handleEvent=function(e){var t="on"+e.type;this[t]&&this[t](e)},r.prototype.onload=function(){this.confirm(!0,"onload"),this.unbindEvents()},r.prototype.onerror=function(){this.confirm(!1,"onerror"),this.unbindEvents()},r.prototype.unbindEvents=function(){this.proxyImage.removeEventListener("load",this),this.proxyImage.removeEventListener("error",this),this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype=Object.create(r.prototype),s.prototype.check=function(){this.img.addEventListener("load",this),this.img.addEventListener("error",this),this.img.src=this.url;var e=this.getIsImageComplete();e&&(this.confirm(0!==this.img.naturalWidth,"naturalWidth"),this.unbindEvents())},s.prototype.unbindEvents=function(){this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype.confirm=function(e,t){this.isLoaded=e,this.emitEvent("progress",[this,this.element,t])},o.makeJQueryPlugin=function(t){t=t||e.jQuery,t&&(h=t,h.fn.imagesLoaded=function(e,t){var i=new o(this,e,t);return i.jqDeferred.promise(h(this))})},o.makeJQueryPlugin(),o});
/*! lz-string-1.3.3-min.js | (c) 2013 Pieroxy | Licensed under a WTFPL license */
var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(e){if(e==null)return"";var t="";var n,r,i,s,o,u,a;var f=0;e=LZString.compress(e);while(f<e.length*2){if(f%2==0){n=e.charCodeAt(f/2)>>8;r=e.charCodeAt(f/2)&255;if(f/2+1<e.length)i=e.charCodeAt(f/2+1)>>8;else i=NaN}else{n=e.charCodeAt((f-1)/2)&255;if((f+1)/2<e.length){r=e.charCodeAt((f+1)/2)>>8;i=e.charCodeAt((f+1)/2)&255}else r=i=NaN}f+=3;s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+LZString._keyStr.charAt(s)+LZString._keyStr.charAt(o)+LZString._keyStr.charAt(u)+LZString._keyStr.charAt(a)}return t},decompressFromBase64:function(e){if(e==null)return"";var t="",n=0,r,i,s,o,u,a,f,l,c=0,h=LZString._f;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(c<e.length){u=LZString._keyStr.indexOf(e.charAt(c++));a=LZString._keyStr.indexOf(e.charAt(c++));f=LZString._keyStr.indexOf(e.charAt(c++));l=LZString._keyStr.indexOf(e.charAt(c++));i=u<<2|a>>4;s=(a&15)<<4|f>>2;o=(f&3)<<6|l;if(n%2==0){r=i<<8;if(f!=64){t+=h(r|s)}if(l!=64){r=o<<8}}else{t=t+h(r|i);if(f!=64){r=s<<8}if(l!=64){t+=h(r|o)}}n+=3}return LZString.decompress(t)},compressToUTF16:function(e){if(e==null)return"";var t="",n,r,i,s=0,o=LZString._f;e=LZString.compress(e);for(n=0;n<e.length;n++){r=e.charCodeAt(n);switch(s++){case 0:t+=o((r>>1)+32);i=(r&1)<<14;break;case 1:t+=o(i+(r>>2)+32);i=(r&3)<<13;break;case 2:t+=o(i+(r>>3)+32);i=(r&7)<<12;break;case 3:t+=o(i+(r>>4)+32);i=(r&15)<<11;break;case 4:t+=o(i+(r>>5)+32);i=(r&31)<<10;break;case 5:t+=o(i+(r>>6)+32);i=(r&63)<<9;break;case 6:t+=o(i+(r>>7)+32);i=(r&127)<<8;break;case 7:t+=o(i+(r>>8)+32);i=(r&255)<<7;break;case 8:t+=o(i+(r>>9)+32);i=(r&511)<<6;break;case 9:t+=o(i+(r>>10)+32);i=(r&1023)<<5;break;case 10:t+=o(i+(r>>11)+32);i=(r&2047)<<4;break;case 11:t+=o(i+(r>>12)+32);i=(r&4095)<<3;break;case 12:t+=o(i+(r>>13)+32);i=(r&8191)<<2;break;case 13:t+=o(i+(r>>14)+32);i=(r&16383)<<1;break;case 14:t+=o(i+(r>>15)+32,(r&32767)+32);s=0;break}}return t+o(i+32)},decompressFromUTF16:function(e){if(e==null)return"";var t="",n,r,i=0,s=0,o=LZString._f;while(s<e.length){r=e.charCodeAt(s)-32;switch(i++){case 0:n=r<<1;break;case 1:t+=o(n|r>>14);n=(r&16383)<<2;break;case 2:t+=o(n|r>>13);n=(r&8191)<<3;break;case 3:t+=o(n|r>>12);n=(r&4095)<<4;break;case 4:t+=o(n|r>>11);n=(r&2047)<<5;break;case 5:t+=o(n|r>>10);n=(r&1023)<<6;break;case 6:t+=o(n|r>>9);n=(r&511)<<7;break;case 7:t+=o(n|r>>8);n=(r&255)<<8;break;case 8:t+=o(n|r>>7);n=(r&127)<<9;break;case 9:t+=o(n|r>>6);n=(r&63)<<10;break;case 10:t+=o(n|r>>5);n=(r&31)<<11;break;case 11:t+=o(n|r>>4);n=(r&15)<<12;break;case 12:t+=o(n|r>>3);n=(r&7)<<13;break;case 13:t+=o(n|r>>2);n=(r&3)<<14;break;case 14:t+=o(n|r>>1);n=(r&1)<<15;break;case 15:t+=o(n|r);i=0;break}s++}return LZString.decompress(t)},compress:function(e){if(e==null)return"";var t,n,r={},i={},s="",o="",u="",a=2,f=3,l=2,c="",h=0,p=0,d,v=LZString._f;for(d=0;d<e.length;d+=1){s=e.charAt(d);if(!Object.prototype.hasOwnProperty.call(r,s)){r[s]=f++;i[s]=true}o=u+s;if(Object.prototype.hasOwnProperty.call(r,o)){u=o}else{if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}r[o]=f++;u=String(s)}}if(u!==""){if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}}n=2;for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}while(true){h=h<<1;if(p==15){c+=v(h);break}else p++}return c},decompress:function(e){if(e==null)return"";if(e=="")return null;var t=[],n,r=4,i=4,s=3,o="",u="",a,f,l,c,h,p,d,v=LZString._f,m={string:e,val:e.charCodeAt(0),position:32768,index:1};for(a=0;a<3;a+=1){t[a]=a}l=0;h=Math.pow(2,2);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(n=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 2:return""}t[3]=d;f=u=d;while(true){if(m.index>m.string.length){return""}l=0;h=Math.pow(2,s);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(d=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 2:return u}if(r==0){r=Math.pow(2,s);s++}if(t[d]){o=t[d]}else{if(d===i){o=f+f.charAt(0)}else{return null}}u+=o;t[i++]=f+o.charAt(0);r--;f=o;if(r==0){r=Math.pow(2,s);s++}}}};if(typeof module!=="undefined"&&module!=null){module.exports=LZString}
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/dist/FileSaver.js */
(function(a,b){if("function"==typeof define&&define.amd)define([],b);else if("undefined"!=typeof exports)b();else{b(),a.FileSaver={exports:{}}.exports}})(this,function(){"use strict";function b(a,b){return"undefined"==typeof b?b={autoBom:!1}:"object"!=typeof b&&(console.warn("Deprecated: Expected third argument to be a object"),b={autoBom:!b}),b.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\uFEFF",a],{type:a.type}):a}function c(a,b,c){var d=new XMLHttpRequest;d.open("GET",a),d.responseType="blob",d.onload=function(){g(d.response,b,c)},d.onerror=function(){console.error("could not download file")},d.send()}function d(a){var b=new XMLHttpRequest;b.open("HEAD",a,!1);try{b.send()}catch(a){}return 200<=b.status&&299>=b.status}function e(a){try{a.dispatchEvent(new MouseEvent("click"))}catch(c){var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(b)}}var f="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:void 0,a=/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),g=f.saveAs||("object"!=typeof window||window!==f?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(b,g,h){var i=f.URL||f.webkitURL,j=document.createElement("a");g=g||b.name||"download",j.download=g,j.rel="noopener","string"==typeof b?(j.href=b,j.origin===location.origin?e(j):d(j.href)?c(b,g,h):e(j,j.target="_blank")):(j.href=i.createObjectURL(b),setTimeout(function(){i.revokeObjectURL(j.href)},4E4),setTimeout(function(){e(j)},0))}:"msSaveOrOpenBlob"in navigator?function(f,g,h){if(g=g||f.name||"download","string"!=typeof f)navigator.msSaveOrOpenBlob(b(f,h),g);else if(d(f))c(f,g,h);else{var i=document.createElement("a");i.href=f,i.target="_blank",setTimeout(function(){e(i)})}}:function(b,d,e,g){if(g=g||open("","_blank"),g&&(g.document.title=g.document.body.innerText="downloading..."),"string"==typeof b)return c(b,d,e);var h="application/octet-stream"===b.type,i=/constructor/i.test(f.HTMLElement)||f.safari,j=/CriOS\/[\d]+/.test(navigator.userAgent);if((j||h&&i||a)&&"undefined"!=typeof FileReader){var k=new FileReader;k.onloadend=function(){var a=k.result;a=j?a:a.replace(/^data:[^;]*;/,"data:attachment/file;"),g?g.location.href=a:location=a,g=null},k.readAsDataURL(b)}else{var l=f.URL||f.webkitURL,m=l.createObjectURL(b);g?g.location=m:location.href=m,g=null,setTimeout(function(){l.revokeObjectURL(m)},4E4)}});f.saveAs=g.saveAs=g,"undefined"!=typeof module&&(module.exports=g)});
/*! seedrandom.js v2.3.3 | (c) 2013 David Bau, all rights reserved. | Licensed under a BSD-style license */
!function(a,b,c,d,e,f,g,h,i){function j(a){var b,c=a.length,e=this,f=0,g=e.i=e.j=0,h=e.S=[];for(c||(a=[c++]);d>f;)h[f]=f++;for(f=0;d>f;f++)h[f]=h[g=r&g+a[f%c]+(b=h[f])],h[g]=b;(e.g=function(a){for(var b,c=0,f=e.i,g=e.j,h=e.S;a--;)b=h[f=r&f+1],c=c*d+h[r&(h[f]=h[g=r&g+b])+(h[g]=b)];return e.i=f,e.j=g,c})(d)}function k(a,b){var c,d=[],e=typeof a;if(b&&"object"==e)for(c in a)try{d.push(k(a[c],b-1))}catch(f){}return d.length?d:"string"==e?a:a+"\0"}function l(a,b){for(var c,d=a+"",e=0;e<d.length;)b[r&e]=r&(c^=19*b[r&e])+d.charCodeAt(e++);return n(b)}function m(c){try{return a.crypto.getRandomValues(c=new Uint8Array(d)),n(c)}catch(e){return[+new Date,a,(c=a.navigator)&&c.plugins,a.screen,n(b)]}}function n(a){return String.fromCharCode.apply(0,a)}var o=c.pow(d,e),p=c.pow(2,f),q=2*p,r=d-1,s=c["seed"+i]=function(a,f,g){var h=[],r=l(k(f?[a,n(b)]:null==a?m():a,3),h),s=new j(h);return l(n(s.S),b),(g||function(a,b,d){return d?(c[i]=a,b):a})(function(){for(var a=s.g(e),b=o,c=0;p>a;)a=(a+c)*d,b*=d,c=s.g(1);for(;a>=q;)a/=2,b/=2,c>>>=1;return(a+c)/b},r,this==c)};l(c[i](),b),g&&g.exports?g.exports=s:h&&h.amd&&h(function(){return s})}(this,[],Math,256,6,52,"object"==typeof module&&module,"function"==typeof define&&define,"random");
/*! console_hack.js | (c) 2015 Thomas Michael Edwards | Licensed under SugarCube's Simple BSD license */
!function(){for(var methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"],length=methods.length,noop=function(){},console=window.console=window.console||{};length--;){var method=methods[length];console[method]||(console[method]=noop)}}();
}else{document.documentElement.setAttribute("data-init", "lacking");}
</script>
<style id="style-normalize" type="text/css">/*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}</style>
<style id="style-init-screen" type="text/css">@-webkit-keyframes init-loading-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-o-keyframes init-loading-spin{0%{-o-transform:rotate(0);transform:rotate(0)}100%{-o-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes init-loading-spin{0%{-webkit-transform:rotate(0);-o-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);-o-transform:rotate(360deg);transform:rotate(360deg)}}#init-screen{display:none;z-index:500000;position:fixed;top:0;left:0;height:100%;width:100%;font:28px/1 Helmet,Freesans,sans-serif;font-weight:700;color:#eee;background-color:#111;text-align:center}#init-screen>div{display:none;position:relative;margin:0 auto;max-width:1136px;top:25%}html[data-init=lacking] #init-screen,html[data-init=loading] #init-screen,html[data-init=no-js] #init-screen{display:block}html[data-init=lacking] #init-lacking,html[data-init=no-js] #init-no-js{display:block;padding:0 1em}html[data-init=no-js] #init-no-js{color:red}html[data-init=loading] #init-loading{display:block;border:24px solid transparent;border-radius:50%;border-top-color:#7f7f7f;border-bottom-color:#7f7f7f;width:100px;height:100px;-webkit-animation:init-loading-spin 2s linear infinite;-o-animation:init-loading-spin 2s linear infinite;animation:init-loading-spin 2s linear infinite}html[data-init=loading] #init-loading>div{text-indent:9999em;overflow:hidden;white-space:nowrap}html[data-init=loading] #passages,html[data-init=loading] #ui-bar{display:none}</style>
<style id="style-font" type="text/css">@font-face{font-family:tme-fa-icons;src:url('data:application/octet-stream;base64,d09GRgABAAAAADLAAA8AAAAAWHgAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABWAAAADsAAABUIIslek9TLzIAAAGUAAAAQwAAAFY+IEkIY21hcAAAAdgAAAG8AAAF3rob9jFjdnQgAAADlAAAABMAAAAgBtX/BGZwZ20AAAOoAAAFkAAAC3CKkZBZZ2FzcAAACTgAAAAIAAAACAAAABBnbHlmAAAJQAAAI6gAADv+gJOpzGhlYWQAACzoAAAAMwAAADYY1IZaaGhlYQAALRwAAAAgAAAAJAfCBClobXR4AAAtPAAAAJEAAAFMBfb/0WxvY2EAAC3QAAAAqAAAAKhjiHI5bWF4cAAALngAAAAgAAAAIAFjDA9uYW1lAAAumAAAAY0AAAL94+zEpHBvc3QAADAoAAACHAAAA11cG/YjcHJlcAAAMkQAAAB6AAAAhuVBK7x4nGNgZGBg4GIwYLBjYHJx8wlh4MtJLMljkGJgYYAAkDwymzEnMz2RgQPGA8qxgGkOIGaDiAIAJjsFSAB4nGNgZNZgnMDAysDAVMW0h4GBoQdCMz5gMGRkAooysDIzYAUBaa4pDA4vGF4EMgf9z2KIYg5imAYUZgTJAQDSIQumAHic7dTVbltRAETR7dpNCikzQ8rMzMxt/M39mHnsU1/TfZz5jFpaV7pXJunMDLAZmOqaZjD5y4Tx+uPTyeL5lG2L5zN+L94zG8+ztr7ulXH1fra4bvK9M79xiWW2sNXPbWeFHexkF7vZw172sZ8DHOQQhznCUY5xnBOc5BSnOcNZVjnHeS5wkUtc5gpX/f3r3OAmt7jNHe5yj/s84CGPeMwTnvKM57zgJa94zRve8o73fOAjn/jMF77yje/84Ce/WGPun1zi/2tlXKbp3Xyc44bFyZanSWokJDXOOjXSk/LUSXn+pEwCKTNBaqQqZU5IjX+XMjukTBEp80TKZJEyY6RMGylzR8oEkjKLpEwlKfNJyqSSMrOkTC8pc0zKRJMy26RMOSnzTsrkk7IDpGwDKXtByoaQsiukbA0p+0PKJpGyU6RsFyl7RmosQcrukbKFpOwjKZtJyo6Ssq2k7C0pG0zKLpOy1aTsNymbTsrOk7L9pNwBUi4CKbeBlCtByr0g5XKQckNIuSak3BVSLgwpt4aUq0PK/SHlEpFyk0i5TqTcKVIuFim3i5QrRso9I+WykXLjXOYNzP8BuAPUwHicY2BAAxIQyBz0PwuEARJsA90AeJytVml300YUHXlJnIQsJQstamHExGmwRiZswYAJQbJjIF2crZWgixQ76b7xid/gX/Nk2nPoN35a7xsvJJC053Cak6N3583VzNtlElqS2AvrkZSbL8XU1iaN7DwJ6YZNy1F8KDt7IWWKyd8FURCtltq3HYdERCJQta6wRBD7HlmaZHzoUUbLtqRXTcotPekuW+NBvVXffho6yrE7oaRmM3RoPbIlVRhVokimPVLSpmWo+itJK7y/wsxXzVDCiE4iabwZxtBI3htntMpoNbbjKIpsstwoUiSa4UEUeZTVEufkigkMygfNkPLKpxHlw/yIrNijnFawS7bT/L4vead3OT+xX29RtuRAH8iO7ODsdCVfhFtbYdy0k+0oVBF213dCbNnsVP9mj/KaRgO3KzK90IxgqXyFECs/ocz+IVktnE/5kkejWrKRE0HrZU7sSz6B1uOIKXHNGFnQ3dEJEdT9kjMM9pg+Hvzx3imWCxMCeBzLekclnAgTKWFzNEnaMHJgJWWLKqn1rpg45XVaxFvCfu3a0ZfOaONQd2I8Ww8dWzlRyfFoUqeZTJ3aSc2jKQ2ilHQmeMyvAyg/oklebWM1iZVH0zhmxoREIgIt3EtTQSw7saQpBM2jGb25G6a5di1apMkD9dyj9/TmVri501PaDvSzRn9Wp2I62AvT6WnkL/Fp2uUiRen66Rl+TOJB1gIykS02w5SDB2/9DtLL15YchdcG2O7t8yuofdZE8KQB+xvQHk/VKQlMhZhViFZAYq1rWZbJ1awWqcjUd0OaVr6s0wSKchwXx76Mcf1fMzOWmBK+34nTsyMuPXPtSwjTHHybdT2a16nFcgFxZnlOp1mW7+s0x/IDneZZntfpCEtbp6MsP9RpgeVHOh1jeUELmnTfwZCLMOQCDpAwhKUDQ1hegiEsFQxhuQhDWBZhCMslGMLyYxjCchmGsLysZdXUU0nj2plYBmxCYGKOHrnMReVqKrlUQrtoVGpDnhJulVQUz6p/ZaBePPKGObAWSJfIml8xzpWPRuX41hUtbxo7V8Cx6m8fjvY58VLWi4U/Bf/V1lQlvWLNw5Or8BuGnmwnqjapeHRNl89VPbr+X1RUWAv0G0iFWCjKsmxwZyKEjzqdhmqglUPMbMw8tOt1y5qfw/03MUIWUP34NxQaC9yDTllJWe3grNXX27LcO4NyOBMsSTE38/pW+CIjs9J+kVnKno98HnAFjEpl2GoDrRW82ScxD5neJM8EcVtRNkja2M4EiQ0c84B5850EJmHqqg3kTuGGDfgFYW7BeSdconqjLIfuRezzKKT8W6fiRPaoaIzAs9kbYa/vQspvcQwkNPmlfgxUFaGpGDUV0DRSbqgGX8bZum1Cxg70Iyp2w7Ks4sPHFveVkm0ZhHykiNWjo5/WXqJOqtx+ZhSX752+BcEgNTF/e990cZDKu1rJMkdtA1O3GpVT15pD41WH6uZR9b3j7BM5a5puuiceel/TqtvBxVwssPZtDtJSJhfU9WGFDaLLxaVQ6mU0Se+4BxgWGNDvUIqN/6v62HyeK1WF0XEk307Ut9HnYAz8D9h/R/UD0Pdj6HINLs/3mhOfbvThbJmuohfrp+g3MGutuVm6BtzQdAPiIUetjrjKDXynBnF6pLkc6SHgY90V4gHAJoDF4BPdtYzmUwCj+Yw5PsDnzGHQZA6DLeYw2GbOGsAOcxjsMofBHnMYfMGcdYAvmcMgZA6DiDkMnjAnAHjKHAZfMYfB18xh8A1z7gN8yxwGMXMYJMxhsK/p1jDMLV7QXaC2QVWgA1NPWNzD4lBTZcj+jheG/b1BzP7BIKb+qOn2kPoTLwz1Z4OY+otBTP1V050h9TdeGOrvBjH1D4OY+ky/GMtlBr+MfJcKB5RdbD7n74n3D9vFQLkAAQAB//8AD3icrXsLcFzlleZ//v+++nb37dfte/VotVrdrW5JltuKpO6WJVluPyXbsmOEbGRjO4KVjWPZlsM4QIU4IYGlgCE2yxqKIQkJg2GreKQCTCZb1CZkiswjzOwOmSTATNVWTZLdDUwSMrVDsomD23vOf69assFAqgbk+773P4//nPOdc/5mwNjFl8WjosbaWblmxiOmIlTGYXzb11M7Z2ohAMbZCcZ5iG9prZl4whfwGju05xtttitUdwXYEUgkbQtWga5lC+XBaqJI285qpb8dVEc8Gnm5L5QM/f58yAlB399a7dD0mWAmdAqaMvBmKPKX9TdDwSjod9yhx03FAPcvI6Gk2lV33XoXUtKgL8C6Wa0WSzXbVjhg6JoqIPShCK0FOvOuE48K1V4B1VUQAVevugmP7Fz2CmTzW5/8+ZGP/+Kp7h/8oI4MuOZ7M5B9IvujH2Wf+PnCAjzn8ZK6AieMKRcvXnxWWSWCzGARlPcqtqs21WZzEBFgYIVDAYWzVJIrXBlH+hXGlWNM00GAJmYZ8sKBzTJFVZVppijqDFMVdTIWLa0o5JrdaHusPZGIG1IjFhQGK2mAZEe56kJnR1bTY7ZT7eivFGODBTdma3pHtlCNDVbwmgMHx/aO4R8ffeet5/ZCG6TfuV03IaSJU3oIzKsGO9+5PV+BwU5xqnOQx1aO8fW71yvD9fPn55/fA22PmsaFvfSgwZ8wzPiFvZ2DUMnzJ2hHVDMmHucPsSRrq7UQo4DMAV/AW7CANw/Zru3NIx20bBEpXwukArlxxOPReibaG63/SyQyiftzcBy3k1HuOHgjEgFHnkYfh4VodDJC4138Ff8hv5PlWbrWmm2O6grNEgGNCWGnbFtRm1Z04gzQPPWvkqMWF4eWU8DB267Df+gNe84bBvfRpfNI5Ny5yAmHDh5/PPLuByMlekDS9DsRR73nWHetwBShSO5PqCBQONO4E2wGlSvYZG6gMzeQ09SWFZC0tWION3oOVVXGTbGM+hrAzQj0O25yoN8R8YzzRsaZdzLwhpsGPEm783hAJ9+kq286eDX5pn/VydDjvk7i8EuchU21JJ3DNOqFzeABmywPcNXxhu/wB+3whrqwVw7Cn1j8vPfdDH6O7PR3fDV/Cb85wua/waSit309grZJHHOhHEQ9CA7zTGVCUb0ZvXzc1lrRe5Af+4An0aSL9op0IU9y6vRFtAYGKy7KJGFbQrdg2dXqGAwWilld0zUy9xLqd6A/zeFuy7gzYFmBOwOhZ6NNhZakm8YTI7S1pyM1mM032V26qevXGlzZ8+TKvROlB/BBkO9ACDalB7OZuBnuC5tRcAItpalENNOfhajVH1A2a1HjbHZ4N4r54oWLz4qPoe4jrMo2sonapm5QRQBQ3XycKVxwRRxjQuVCnWc6mrzOZ5FvBiraOmia5FubYRpok8n0ioRTKOQMNbWiszxYWAFZrQ1sB+dDJTFYghzyiBN3oB857ndIAha4Se/+YGUtjAkXXUO2xPE2eoe3TWPeMOXmzNi+j9w1HghvVbSAmu4c6nFac6MgbzXFU2baDr1241+98TfHtU/9t7df+MzU4msmfPYj06Wbw8Gqohda0/FkSyiyvtPGG/FsMKq1pLqmPvndkye/+y+08eYIHEJZpFmJra2Nop/VWuKcCwPvgRhnGlOFps6iIdAEmFVAKh53jblZyBU6nAFdbfX03tGwioZ9oGnEyDSWTQCyFzhoR+s/jdjgWLmc3L2K21zEmXCsM5aDm4g9Ny5v0PZVb+dY9Rcd/sl5eTiPj0nTaeiU+BhhW2qbuzJcUy2Nc2gCrjBkxWCqZiArGgOuwSzjAlDb5L91XfpvfYbpij6ZRIUWYoVcLqC2+UqNLddsMrekY3GZztVl2uQjpl4xjedIM+Uybc/r5viShuHgcgXuwQtpuoMHz8utCe/s8S+Y/7xMaYu2DX1yDrez3lp3cyyKdop+HLcLi878Uh9SKOSlj73cOIUFRVKVKHhaSS9JP452RCcYoJ3w85bz8Ckp9VN4xeZj9atpH4FnPCV4OtiDNIVYCrWwsbauK81VxUlaQnA+riFBisoUsiU0LbQpASCmmRAwg1MNJoH19uQ6WpriUV1jIQjphA5QjosiTfiy1tF+kPJKMTFYpAu6lkx40odnTv7VjYtC/QtTJyGH9HmMnKamGrcaqmaagRsMUwR9WeLmwsQREvIRevSvYa8uVFXo9Sc0w5A8/Rp5+jcxhXLuYAOIx/pbY+ggFp0FV8lNoLNAEQvyDkwBZR9T1ZC6xR0qFgsybix3DJcR7iIGwCsCHHQM0nYKVSBXQZPnqG7KDZiqrn8K524gpN9ghAx42k4GsvF3nohnA0kbnglkC9mrl7h4Db2TommKcVE1QOPRd97K5WJxsKO5nIjHbHtx/og3kK8iWys1he/EkKlqCbFOB6iKQp5Q5Yp6DB0AsjmPvHEFSGsoFraPaVpI2zLc2lmudErjJ/eeQwbKPoRBZulcwhwXYc6i1SdiEpiCF+KrFOIrAzKaHdhQ79tw4MAGuJv4rt8sQQu80jloGnnDfNVJBa+vn1WjSg1d8NHrg44FbTgdJ5+T77yy/gDI5wY7633yTbI7+CdyMDyEL2paDd0BvZjyfIYXH2/H+aqjDfXUisgnk3rFYMePoyZBegWanQpM5hKdlUSU1JnoQH2iG1d90IYADi0JPV2/oxMEeB7apm+aBngFw/ObMjzHzv7dgzyOh48fHZnmO9c8Wv+2RAGwHiP20UNnzx46mvYxyaMixDpZX22lQqQgRDqG4kYcMo92cpypAOo0Ti+iSYXJRGc5l8wvQhPfqpE0SYa7nDwkeQyh26OOlbecqVumoCwJ8+mDm+9/5T4eOyOt+4wk8WjavYTIG+7nD5Li2cWv8zGkMYoz51q2u3Y1JQSwfcumSn9JUxW0CZIWQ5isqKCo8zoGFPybx/lyHD2w4AaCBw7Ap1HIxAaHyZlr1tXG1owMt7h5Ox5QmxF4Iv6vDhaQoTFAYADuYIlnLa7b7RwtiOBDtVK1dbyCMXXxn5azOIIKfLFKaQP9K3HKIMYEQosvhkIWH23TQ9wIpCq9M4WxycnJsQIUYrEJ/bPGuOZohfHVzdmMaAmHm418c7DU3xdoyYPebFktPJtpHu7fefjw4R0VHiNTa06ZUTPe09a1sdTUVNrYtbo3nth11VW7tBa1d/U1a1t71rdG2u1IJNkWDYdbUs0pnnFT+OloWzISsdsjqVpvy9prqrNjed41POfPx2+J7TIXaWP5Wgf5bvToBEvpppQYOXPOJoda4gTQE6TsNK8sAvUSSHBFygfnfM9wL+8aK/Bddv0tZ8SufyKZ7ml7s20iCWdsPpPu4YVaXuur/2M6WX8riReTE21vtPUAnn4iyTxdf0vJ+/QM0pwsUL4D5BmUBQEeXpaU4W6RtExzN1In7eT9qHPpIoUdqAzSrdyHIPo1JNRps1uioCWJyIm2U/JG8oO4aZMXozF8b4RupRd5JJv7Nn8ZeUyxjlrakhJHcwO2gHMUDgGLR0MmS0GrIoMRWos0K81LUnPZYgmkw6sM8HtCoQTaT9y0Wu3f/MZuCYfijhMPhUVQNdL2hY8kMroS/8UvEqqeSfC/xzPV07k3vsqyrL+2ykYnhJjEz45OLIdbu4ncrbrWhImzltU7oqqaXAEdMWiHxPsSdvuF70K6/xf6FejjL13YBvFVP+UXrkwnyelZjBcltoLypQIoEmsoiDUw4C2QFS/I/J6yx5ybWOOqaMad0kJlKo+ElAdLqvRTMqOsgucuM64j3hgHU1H1mIkQ084Oje3eXT1lZwL1nwaD0BZMNfFTcHpv+sf7v6LEo4oZMlRbFNqH9tb60nEN0UkQ0mYawZNpR878eFuD1lWsl/Jb9J5iMbPlDKnkh3raBmS66U1M9Jm5rKUmMel1dKLOcxrVSgf5dJqU4o0g0pJyTlV37x4bytpCATOG8VUT4+m9cPoURiakE34ZMes/wbB0Roun+2p7h9oLSlwzQqZq2eIr+xe2/Rhp5QF8hHn5Hh/FfM9ibs32UrNG+l22ZbrnJ8N+fERAcD6YCp6nuPc2Aq/vWXiMfzKaye/BDfzTLPwe33MT8ns4P/y0uiLBdyZw3qRvNvGZegjF6H+escXvreOnkD7zm7IkADTbJEkU4sdw1jmwzpTj42smHLB82ijenjfx9YsXkccR+B5+I1azGtQk+4maTpnLlsBL75E7O1IPea+mzfPmUwQt00FJoG+nPxN/zruZzZprTljyx2GpXiHdYWBZtcINeB+2xVP16/GT9euDwf00TbqgK5gK7QvCmfp/wPn15WDa3BcM1l/Hy8F9wZQ31nf4Q2IjjrXyG+BnzXnMmqXiTuB5CLa01gINjvb8mesSTwHuSAEtzm8anp+uvwbdprkfhUs0wCNIxH6TP1l/vf6aPDThK0TXI5I+tjj+SX/8wIcaPxWX4y+CqsCiEIiAIzhsKrgfh+6qv+4L4RETPl6/zqMKukki9AA96OseZb3Zk7UKVKxZKt65tpR1J9p1sTGgP5Z4ah+KEzl73R/xEfr+I8H5fchlN/Jr0n0c3fSGkrz+vbhd5m2ZWltThDeKUaKh3WTZXWauS+WomBdMkjGvOCRuT9YfcIZxk0x24/5cT3q8redxe8TpTsLn03b9LIaFo/I0eQ7uxtjQm6rffI4elnTcJfbwX/qRFyG+Vw+SaJdyFIpugk0WXCcnaZFo1323viNAWHZPvk1+ugfjTf2sbcPR5LDT442bhwPj6Z5z9qi9wr8B85Ji51yXb3tISxlpSUtaZEYnFX8ZbHI6C8vk4ll2h5/YdRQbM0CUbSmXHsd5rH5zWz7fBnc/5iA1NLANwyQZ2+5JjiYfQ4mle+BxJA1prT9g+770dv4zTz9RnTPp+JlY4DJKoroOucmyT4fnsGIeFC3H9EtmB+qnGyP6413tPvs4BhIwipskDKakeIg+KKTgbl92JBkkHn1J3c8t+9ia2vBKhMFkGBJtEjrGDIzKE1SeAgTJiDAVRYpKmSGwMlksJor5gUWgjKlXYS0gurS4neaYflXJnaWBUjDKNAVhkWoF1WhHz7uJ2PapE8NHJkulySPD62/qVmLapMq10a997JqvnphQarc8dO3UQ2smYr38pfOWszK6fTs+eBKfHy4j8t2uWNrWnbDx5CNfe+TkxrHVE/EEW4ynxM9H2FhtpAeE2tnGFUH1J4xXChxD5hACLNXbLgOA3WU353rI37Y44SipbwdxwED/mEC0rOmuIzmlGkw7SBzNxZ6NN3519+zXRhV1Uosp3TdtGD68s4eXJo8uzHVtjyXc85gC9MYmRh+euuaRk+vhAG43Tm3RLGW7Clp52Oesq3N7dKVjnW9KxCdWjyFvi/nUs+Ja5CnPxtn+2t4NnVwLrELw76JqDMz1MacMGJoR0I5RVsA1lR/DLEdonLJLQWnOMcSamKlrszLnWWZ3mzcVOjsrnYWynTfVNmQ6aQFxrWtL9SQtgjqsojbxf5lp+qquSF1rVGyk02qZZEEKRkPdlv9ff3LVQ6MTFMas8xSft3fNVbd+vqg1KaF5w7RwBsirUye24UVXDS3oIcj/nz+56mF6qQlUAQ++gGoNytcxFG7P98DWMXMoHIL/6l/Z7p1riv8ko2oiyiru129WsSrmUjO1XdtWc0Pr7miOoWOV9YUQ07WQPmsCisWYDge5puAUAI3NIk6EQACmaQ+BGRaAwOSemV1TH90+vnlDrZBNFOi/nEUlLL96lYx5VZLqB5zDQLFQzGm6KuUX89L6YqxRuaPsCwXYTlJE1EVJt9ycWTo8bereoW7Wv38ewfOzmgI/N42Kn53LatjTxUCv85zbEyg+Y5hTcDddq99M2ysc8/51lABfjZ++8KvSxvUlnpCj7U+mIG3vR8yhXSbXEbaB3cDmatdds4lrhi9Z8hskNo2hkI+RQHWN6fMIUwKGFZiNhDmCNq6BoR1gejCoTzNdD86woB6cPDh33YFr91w99dHJLePr1tp525NylKZkzJtthLplN+ADzhOxjpiN1trRPwb/vhKfqIcMg8Mr3DDqd38o4cM36y9KWa+Tsn7v4/ocj134Vcg2TZsf/ABFKH4tYwrtObZYYxoF3QiQC+PjATwUho5+W8MkQlOOqUDxnlMNjZpsfB8zjJCxZe2afKeTjXeuboqT2XcOlsACB6XROFhWch7AeNy/VsZfx4fO5Aj8EjTVRPjLdtrmTS1NX7Azce6kmjZnnHf+1iuBiG0duzsmQTiZPzfjEoTGAqZ7xqt/nmmai8gXOWb0/sG9z8vyyPNOZjKDf9DlRgmQR93keVlHOU/9RTkfH8W8ieTQzWpsc21DGRM0Xw4soAUWDEDPtMB0oS9I5qeXC0PhMySPyTWjuYFctn9JEgWLp6FSXdz71TeSgzuQBmnXVHPXGqWhIhXkF+H2lQXxVqiSO5OthN9CQQSazmBOhdycwSgoZRJvQ28Yz8SVltDiwd3PUxMLN9De1dWehinH5783RvA9xhpyoHgnWAfGvE3sqtqOFT25rGIoMB4GBa0NAaepg2KYyiwVijQqFKGtopEeUFFYgQCboj0jZ8cCk7U1Q2W3MBBLjMRi0SCKxO0od6gD6Muon6Q35JGLDZS9DEpfLNZTA4aqrmrD0rwHCAO8Cs/Ur4a3J0Lql9WU4RfBJiYySfg+cviqaczLvipt59LuhbjXflPdSuRLUUd/9VV422jRv6SF/NbehYrcQ1p2AZ6jd80L5+kSRwE3WV+OVGTs9GvnU6yLDbJsrZ2aE+iijskqPtuHgTAktgz0r+xtaUaslZRRH6FKlRJrBwO9bK+lef8YXipg7j8GSJjM+GRPmSApRv6n//T4VrH3qqbRaNxoqoxSNMfwD6MV18yPulftrX+xZ7gXeka7vMCPgf2aQ8+N4bPuaKz7lg2LIGjjTT3x4T4jvubPYKL+cFtPTxscwm0DA+yVNaMjbFNt/cE9k+sUpoxgas8Gu1qjhG7GqUu+oAFel8B2gTDcgt+54If2XXv1VVsmVvRkM4m4TnnrYCGLtt5foc4F2rWO/NrIbxENvBHUy0WJBYqEg8hbyklAxoATvupfHMCZ3wAHaASEAFz/Y7pUPh+ZumWK7z65G1KGftgMJro0NbIzrOvbm1sCuhL9tBGKtrof1aLaZkdRjS4zYhzSDTDVw4bldnrPGtubWgKGiH0adR1JuR9VI/qErSgB72HMk0emp2+anr6F7kfTydZ+zdKSO0EdDRuTqaip3xAIjapaLa1aWqg/kmqNQEiXzza3ZFbqId3euezR4Iiqbkj5j7ZEIeTX7X4n9vLvLmKL2mAXILVUp0WPoyLCVJVGQ+/yNlGhjP8PNLq4y9vNy9rPrn+eW36OaPmdX0nTF7EIpu9XPlvW1XMgOiHbSHIL1ji1nsbpBdbAyXtlTRwjSHuCqyJvkjfAVEiMe317oeLEURlNKa/CI7tfVLxLp5qb4tFwUFVYJ3R6/STHqy1Xi1R9RLvvd6lSPIba14rZoo6zwa3w/7L18OGzRwC+N7B52+HD2zYPfA8OP3iIH9kyjkd4Fdwj9x85skUPzfXhQd9cSN96mB+97yjgoYUXvZ7kxYu/UW7mL7Eo+rwKK9byTKWsSWWz6N8VBaZxB5ShgDJZHerscm0J6L1at2fNGPH4CqQNZ+gAGTeaPZVNBB52IJ7nt/uI3N/B0707Do+8vmEH37rpdTLX8eEDd47Xr564Y3aIj+67azM8Q4dwYHjpHbJoOu1/8OkH++lk4s59Y2Lo+tsevG1ukA/N3uHb9f9TbkFebNRET61I/GEuOEtdCkxKcdfISpPptmSn01kdVNF4Y4NjHF1rWnh0cxWZKImsJdKcKPPIkZR5RIoYkcJ7dh665dDOHqV/4jgc2ILXkYz77zgwypGsH1zKst/L+ir6nJVsPdtR2zaC4aQTZC9CR4p0jigDQ6gmexJcUeeXdbS0xY7WslzDdpPF8uryAPX0L+tqoVNFD5QrFi7rbKGXwYnkJGCpwra4XMZe1th6JZcOCL0VgV445HepqL+l5jVdKMHP1VeH89a/WtYaK2/9Z/g4noyFYduzjf6WpSS0FIKDRovrC4aaQ9ZArQ9b1r/K58P0Yhi/4Msl4WPhFbUuzCTBb1OitsjmCVsAn+Qs3eokTJ1FeEQlI1nGXNlfnbS8tcc/sYz4wU8vsbd+lr/UII5u7mncOYBJ+WKc+5jsETe/L03AXCfmN4IlTVnCOYiVSxyWr5h45up7d/Lpu568c7ey4zRcu6yjzk9P3Xvu3im5qb9yaf98ab2AwZIsy0Zrq6nXxkG22zi121ScGiC71IoiZwcZqlAmzUCmvaU5GgkkzaQfoNCjlKimWnxvGhtR5b4r0roYFX59BZLFsvVB5NMRIVAGQ65bJoBsRuaFbLJM/0n3nZCLlZaWYKj+efWy88WezKv+yiG5dKnN23mX2uUJbi5bY+Rc4XgxBrHXGnlYb637gwLPEuXVBmD1ViiIyzgRfl5f9NddvfoB9NDxw0clWD9KV0FbdhMMjzfc+H7uJXEG8fo6Ns4O1q5fU+KCCq16PhXG3JuJcczFw6GwEaLSBXkQwNwF4DgLs1AgHDqA2FToAXEgCDpj+jTudDaDgUmnGsaG9bWx1UOVctJGzBlDf2HJWgZyh1HHkeV53RK5WC6Gc8fr45AzKSByxwlWHShTsxydSgfVLhALUZsXOiS8w0TlVOdJ006bC4ZayA43j7cN9WCqeCgYDTvGJzKnKG0Jn7ou6KSC18Frs8FUk2Jch1frv65/kWLdMMbf2fWfDKac4HFdaYpb8HY9ZDXZhnEylEgHP7t2L6YMcO46M22b111HA113zoFBDJQUpy/WLx6B36K+MxQdmlHBKerm0BIJKqUu68GgoLY0VSpexdChJiDC1WpC9qwK1cQYpS7U0BW0JAzeMrX6P+hRI2Dy4z/hqqmb4gS3jG8GLT77P1Ue5E4wfOFTFoioAS8NYVYZhv9umJapaPV6hct6wHdkHiowcqVYnvUivt5Qa+3vK/X2dBXy2Uy6pclBE4pR4XkwxWHTtq93vH+tv0l2U6pFvbNRePWrv51uBFbBWmgHbw/upXv+0LnRc1AxL/RjLrVgmvx/yP0Fq1KJxarV2A+PHct2HDvWwbvxJIYX60/THfzHrcdGH7shQm/iC2l6E/fXRumtaPU/ybeyx+p34UkVL0LJv9PAUHOomzL1w8q9uZaYoV3SIOoujHBKKii60eKMxhJHXUMgTQW0InVqqErq22AbYN6BHOMkFCMtlpWLDDc/0NM23tYLZ1uGMX5ZrWfPtkQj+chQ61lZiH+gZSiai0Sbz4JhDbeswXd2PSVr8E/twqtr8KXdu690Q2KpI6jHMMuhBjdRdbG9iQslEae6YVhDV7gBdOiHgK4iKtSERkv4yOpAP8ZMpimmNqtSRuUFG50FDD2AeaYRNrasGS0P2LTwuGDncpRJNtZ5Fpev85SVhMY6T3ewBJrtjAFIs8XZi95eSXOXLJkW75wKaXmE7afkst1TsjBDJxP3v3I//kG6Z9R+ce7WnfcfrvHRo6fPnT46CpteTMJZ7yXKMb2XTlHieMpspgUYLz+k3UsJV/LFTWNH7vvT08eHlfWHHtx+69yLSbZMRhHWhDn2SG0oYCC3qE/B0qAKuZqPg+b5XkErlwWmYkKlMkNY2eLmUAqF3OJinmKjrPIhuK1/W/IJ6z8kh5K1D2aK+/UTWqOzkz1fC4xVOgKKKqgjZqKV9nhTGGOgUGnZjiK4Mq8jJFKOMwJ0UxSLdlO/Ymvrtq8H3/UG+nBNcG0e7Vh79xt/yOf37KklDMPYaeyc3LZ1y8hwT671KoP8BApooL9agOqYUm2FATeRptTcdeQGxexmC3pWyw2u5ZSr4l9xsLCKW+DaaeqxVskXZql+XdTggY9NDrcHk331MoTzqZSj3fGlCe3GxJQT6IsGjeBkQOGQO53v+VKSb9E1EVMQ5vKs2/R7axiimWAmiVCh4/MZ1eYrecvvMWx9oa71KppmNkVhBs6G6m+veHkw8amOFi0QFY4pTI7RrikRxSd1jgBaCeytDEHmYSsUN/HTEEyqQVQ6ppY4937ER/nPmMXaWK6W8TvQy1cj+s28wcIlS70LHqQsSoS5rB18abP70ubwv0VMqrRhJALnb2SJXZ76vg7pAPc9++oF2+s8XzLyZUMt/3ajhy35encPGy4n+lIy4Xvvou1JERMJFmTa8zqHldSwlaBa9k6VC63heDzM/3cYttfndDMiKlbIwCN7eV2F8FS61toUNZhCzHltUoKChwg/yah6WVnr8jIXJer+ultoizj14CWn/GfvvEU5uIjTdtnx8nw86K1TlzWF5QsXBhYXGlw+3rLk/5IB/G8+gzZuYUagPa8ByoUaWfiRIuA35I4CrJOMVariLtOCaKD+Ryq3gvWTwSDci1AAfVtQi7zzsmWE4F5Vq/+RPKDe8714vX5SVSVGuXjxa2K/iCyN42qyOkbLkXwt6FIjmt5sRsHC11VB2yANZQl1HL+GWjFC9Em4Vx7Q2oKTeB2+oKkeL3xEkBU015zWlri4VEBrpICIlwZ7Eso2mgSVKs8GLeJN5YsLnmn7Lh7/45KS6ncSg5I/Por8NcaWi7UW27Te2JeyTGPqPg3VS9j2CzJyeznjn1qaGXCrpsq8ro655n7+1zi3WwkBRkGuRl5e3eMyi6L0TvDJcnYwTnM14fWG5Xyh5nXVLya56BmNJRUi25oYoiGRJBGXdaO+Rb1Y9R861mlZYzodsf21K8/wZ1mC8I75Hr9viTsF+fsW5BzxTSO1IFQNz6DJvnC/lPv9L6Ab4KcvfJU6gC94y9NfMP31s7i5XY5RIn6LJqKRxjAKDuOVppiQA65ycUhaEvVeQya8dVuF6uCYKClVFADVGd5FyGt9RTWAAgg50ahiNFm2YkcCarHv3QTW/6Jna0TY0VA0FEpnMkbciKJ0RGSrrMN/XzzKfy7p3saOsq21cUl7FVQ2Dboqxg8D38S4hnxooL2bGRU1qurqAtP1Q1M7xzd3Sd4MKlx9aN7cxtWq/1OQAi25ohrK0s0ilVHwbgmKVNGWD1T/IMmcmd2u68h5MhPsLpW6Mf7ZEUPfceC+0zfhdXy9uTm5cQffujnZrMQFzmZdv+n0HyDOnl33Z4RjOcFoIL338N50IIpBxBEd9+2+7fV+vGGHQ5Y18NCTDw1EwkITYRu/JwZe9fPMI+IfxFUsyjbSqvKhAcwt168pdedsTBbTzZxTnRzRxQyV/if8uggP8y2VcpqWw7iyTmgJOy3GuEu5oK35P5xC0L6GZFag308hopD9/6r3KyoE7rKG5Tqi3D9z8s6TM/3+7mEeeCxiPDanxdWDjxmRxwKIeebmVFVePajGtTl5VaWLcGDdLdMVpbTvxD0n9pWUyvQtew1RfioQFOU/1vU/Lotg4KmyMEz9nnuM2OINTVu8ETPuuUeXPuNZUcFYEmd9rFRbYSxfVUjLiN9dFerqyvd2yKWFBEEB548Fup3m1PWnBQHUERnjyKYur0O1v1pBfvl30u2Hnj4EwydOw/CBOyd23vd4+YefpuUbvHb84elmO9HXD1P3Tq1f48YM5VZ17msH5/d1fPtmWQndeOwTd1EnZNeXbtwsoBRbcbJ29T3T0GbGDO+3J95aen6KxViWDVCHL8i5wsPAxPLfE1FDb55RmQnmCYgrEoijOyX+6KeDoE66Tt5ONjkSgheKBA9LqL6qpqchU0E7QaSYtJ3+irSVimrrmpLJU3ej0gsK6vTRXbdlEXtnb9u17Z9B+Un9m9Hg5rmoE93YF4zCPwZ31H9b/6f6b3cEgzvAgAIYO4IwfMe64Q03nOX3fXzD8Lo7brzrLtiCz85tCkajwb6N0b9LJD738MOfSxTs2x7mj3yGsEgjzzBYB9Xw2hGCYAZOzYWG2uR6nFlvxlJeEZfO732ziNsX84be4ffMGz7/gRmQb1dyTX8Q/dtArU8Hb8Wybmgod53NBlQOilxbg9mPCIstK3sTAzE7O5BMJuTKkvJgwfulBskXM0CBMymXLQrpkSoDMVmJ6aA2QjGG4SJkRk38g5sd61dtYGoQ4St+jHY+U23r4aVWOEjtseoMnDgvfwCEm2+hp6r/X91AK4zYkU3HMVEaxnR3qBfqPzn+/wHPnsOreJxjYGRgYABi1vIsoXh+m68M3MwvgCIMt5YoxkDp2P9f/2exVDAHAbkcDEwgUQAz1Qu/AHicY2BkYGAO+p/FwMBS9v/r/68sFQxAERQQDACh8QbyeJxdT0sVwzAMy49AkAxAkbT3UQiAITGAISmAYQiA9th4ttUs7Q568UeSlVidiwSkB3PUPg+ESd6ZD/+8v7HyrtzwghY89ZB6BcyrYqc6RZhw48YhaA1Wc/v1PQtdeXJ/HppUmFM597nvBVK7D+Z+E8/uQZLBgDyaz3Llvxx02S3c/Hv813JrznryZP4F+6lSfQAAAAAAAAAAUAC2ATABaAGyAfoCJAKwAzYDmgQSBFwExgUyBbQF/AZOBvwHRAe2B/YISgigCPIJGglCCWQJignACgAKQAp2CroLAAtGC4oL8gxcDPINng5iDuYPag/6EF4RIBGGEeQSShKYEyQTbhOyFAoUYhS+FVoVphYoFooXHBeGGFoYnhjGGOwZChlOGXgZrBneGhwaWhqgGtIbLhvyHHQc2B1QHZ4d/wABAAAAUwBtAAYAAAAAAAIAIAAwAHMAAAB2C3AAAAAAeJx1kN9q2zAUh39q0441YxcbjN3tXJWWEcc1lEGvWkLbXZeSu8JUV/6T2VKQlY48w95ifYa9zt6jd/vFESUUYiP5O5/O8ZEE4AP+QWH9nHKsWeEdozXv4A0uIu/Sf488IN9G3sMQPyLv0/+MfICv+BV5iI/4wz+owVtGM/yNrPBZfYm8g/fqW+Rd+svIA/Jd5D18UovI+/S/Ix9gqp4iD3GoniduvvR1WQU5mhxLlmap3C/FUdVWN6IXoXK+k3MpnA2maVySuza0ZlToUZ07292YctFov6k2eWp8VzsrJ0m6qa+NNV4H87Dq1j2WWQiFFN61chX7yNy7mclDUoUwPxuPN/tjAoc5lvCoUaJCgOCI9pjfDGk/BPfMEGaus2pYaDQ0GgtWVP1Kx/ico2BkaQ0zGnKCnHNL09KNuK451721rLqhLfmfht5vzdrmp7Sr3nUfC07YL92afU1r+wrd7/Dh5WwdHrmLjDawanUK3+9acPXqPML7Wq3NaHL6pL+1QHuGMd8t5/8PvPGO3QAAAHicbZLnlpswEIV9DRiwvZtseu89Ib333vvmBWRZYMVC0pHEEufpg8BO/kTncOfTaLgMOtPr97o17P1/baKPACEiDBAjQYohRhhjDevYhu3YwA7sxC7sxh7sxT7sxwEcxCEcxhEcxTEcxwmcxCmcxhmcxTmcxwVcxCVkuIwruIpruI4buIlbuI07uIt7uI8HeIhHeIwneIpneI4XeIlXeI03eIt3eI8P+IhP+Iwv+Ipv+I5N/OiF1hEz9JKxUrtFrDl1lWF9NR9QIikToRaVjUouKxvOmNBjLxnlhgo2DbnM1djLKrNGnGPScSUzItzGv93yPP2bSQSX84z9cqFQdJ56yZRmMhW8mLlJJSaBI0XYPDaZKDUviZmvr6DrNjJMi0WcK1MTM02mqpbZlJtEsNx5SI238jSodJtoS7qv+BpPw67IY9xU+dg5TXjROTWwdGrIOzWhT+uA0jolxqjaZrSOnCF2Nmq16651EYpMm1fakAul9SJQeR5QVYQlk1VkZ8SwoVNFIVjWnKQrlBGdMToftdoZjrs77DajqXKrS02YEFxbbtdWkG0x44JJVUS5aBqKSlJwmhDrmOF2Hv9Wqsy4TNqoKhfmSrrQKuNSL5nvPG6p0s0AkEWkSWVZMy1Kx3ljk03qLuZ14lTmB8gNGmByGrGfjLrhlhJV2f7SaIneNF1ypQNbybBUSgZswQaWEUNngeay1/sD4l/60HicY/DewXAiKGIjI2Nf5AbGnRwMHAzJBRsZWJ02MTAyaIEYm7mYGDkgLD4GMIvNaRfTAaA0J5DN7rSLwQHCZmZw2ajC2BEYscGhI2Ijc4rLRjUQbxdHAwMji0NHckgESEkkEGzmYWLk0drB+L91A0vvRiYGFwAMdiP0AAA=') format('woff')}</style>
<style id="style-core" type="text/css">html{font:16px/1 Helmet,Freesans,sans-serif}#store-area,tw-storydata{display:none!important;z-index:0}.no-transition{-webkit-transition:none!important;-o-transition:none!important;transition:none!important}:-webkit-full-screen{height:100%;width:100%}:-ms-fullscreen{height:100%;width:100%}:fullscreen{height:100%;width:100%}body::-ms-backdrop{background:0 0}:focus{outline:thin dotted}:disabled{cursor:not-allowed!important}body{color:#eee;background-color:#111;overflow:auto}a{cursor:pointer;color:#68d;text-decoration:none;-webkit-transition-duration:.2s;-o-transition-duration:.2s;transition-duration:.2s}a:hover{color:#8af;text-decoration:underline}a.link-broken{color:#c22}a.link-broken:hover{color:#e44}a[disabled],span.link-disabled{color:#aaa;cursor:not-allowed!important;text-decoration:none}area{cursor:pointer}button{cursor:pointer;color:#eee;background-color:#35a;border:1px solid #57c;line-height:normal;padding:.4em;-webkit-transition-duration:.2s;-o-transition-duration:.2s;transition-duration:.2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}button:hover{background-color:#57c;border-color:#79e}button:disabled{background-color:#444;border:1px solid #666}input,select,textarea{color:#eee;background-color:transparent;border:1px solid #444;padding:.4em}select{padding:.34em .4em}input[type=text]{min-width:18em}textarea{min-width:30em;resize:vertical}input[type=checkbox],input[type=file],input[type=radio],select{cursor:pointer}input[type=range]{-webkit-appearance:none;min-height:1.2em}input[type=range]:focus{outline:0}input[type=range]::-webkit-slider-runnable-track{background:#222;border:1px solid #444;border-radius:0;cursor:pointer;height:10px;width:100%}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:18px;margin-top:-5px;width:33px}input[type=range]:focus::-webkit-slider-runnable-track{background:#222}input[type=range]::-moz-range-track{background:#222;border:1px solid #444;border-radius:0;cursor:pointer;height:10px;width:100%}input[type=range]::-moz-range-thumb{background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:18px;width:33px}input[type=range]::-ms-track{background:0 0;border-color:transparent;color:transparent;cursor:pointer;height:10px;width:calc(100% - 1px)}input[type=range]::-ms-fill-lower{background:#222;border:1px solid #444;border-radius:0}input[type=range]::-ms-fill-upper{background:#222;border:1px solid #444;border-radius:0}input[type=range]::-ms-thumb{background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:16px;width:33px}input:not(:disabled):focus,input:not(:disabled):hover,select:not(:disabled):focus,select:not(:disabled):hover,textarea:not(:disabled):focus,textarea:not(:disabled):hover{background-color:#333;border-color:#eee}hr{display:block;height:1px;border:none;border-top:1px solid #eee;margin:1em 0;padding:0}audio,canvas,progress,video{max-width:100%;vertical-align:middle}.error-view{background-color:#511;border-left:.5em solid #c22;display:inline-block;margin:.1em;max-width:100%;padding:0 .25em;position:relative}.error-view>.error-toggle{background-color:transparent;border:none;line-height:inherit;left:0;padding:0;position:absolute;top:0;width:1.75em}.error-view>.error{display:inline-block;margin-left:.25em}.error-view>.error-toggle+.error{margin-left:1.5em}.error-view>.error-source[hidden]{display:none}.error-view>.error-source:not([hidden]){background-color:rgba(0,0,0,.2);display:block;margin:0 0 .25em;overflow-x:auto;padding:.25em}.highlight,.marked{color:#ff0;font-weight:700;font-style:italic}.nobr{white-space:nowrap}.error-view>.error-toggle:before,.error-view>.error:before,[data-icon-after]:after,[data-icon-before]:before,[data-icon]:before,a.link-external:after{font-family:tme-fa-icons!important;font-style:normal;font-weight:900;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}[data-icon]:before{content:attr(data-icon)}[data-icon-before]:before{content:attr(data-icon-before) "\00a0\00a0"}[data-icon-after]:after{content:"\00a0\00a0" attr(data-icon-after)}.error-view>.error-toggle:before{content:"\e81a"}.error-view>.error-toggle.enabled:before{content:"\e818"}.error-view>.error:before{content:"\e80d\00a0\00a0"}a.link-external:after{content:"\00a0\e80e"}</style>
<style id="style-core-display" type="text/css">#story{z-index:10;margin:2.5em}@media screen and (max-width:1136px){#story{margin-right:1.5em}}#passages{max-width:54em;margin:0 auto}</style>
<style id="style-core-passage" type="text/css">.passage{line-height:1.75;text-align:left;-webkit-transition:opacity .4s ease-in;-o-transition:opacity .4s ease-in;transition:opacity .4s ease-in}.passage-in{opacity:0}.passage ol,.passage ul{margin-left:.5em;padding-left:1.5em}.passage table{margin:1em 0;border-collapse:collapse;font-size:100%}.passage caption,.passage td,.passage th,.passage tr{padding:3px}@media (prefers-reduced-motion:reduce){.passage{-webkit-transition:opacity 0s;-o-transition:opacity 0s;transition:opacity 0s}}</style>
<style id="style-core-macro" type="text/css">@-webkit-keyframes cursor-blink{0%{opacity:1}50%{opacity:0}100%{opacity:1}}@-o-keyframes cursor-blink{0%{opacity:1}50%{opacity:0}100%{opacity:1}}@keyframes cursor-blink{0%{opacity:1}50%{opacity:0}100%{opacity:1}}.macro-append-insert,.macro-linkappend-insert,.macro-linkprepend-insert,.macro-linkreplace-insert,.macro-prepend-insert,.macro-repeat-insert,.macro-replace-insert,.macro-timed-insert{-webkit-transition:opacity .4s ease-in;-o-transition:opacity .4s ease-in;transition:opacity .4s ease-in}.macro-append-in,.macro-linkappend-in,.macro-linkprepend-in,.macro-linkreplace-in,.macro-prepend-in,.macro-repeat-in,.macro-replace-in,.macro-timed-in{opacity:0}.macro-type-cursor:after{-webkit-animation:cursor-blink 1s infinite;-o-animation:cursor-blink 1s infinite;animation:cursor-blink 1s infinite;content:"\2590";opacity:1}</style>
<style id="style-ui-dialog" type="text/css">html[data-dialog] body{overflow:hidden}#ui-overlay.open{visibility:visible;-webkit-transition:opacity .2s ease-in;-o-transition:opacity .2s ease-in;transition:opacity .2s ease-in}#ui-overlay:not(.open){-webkit-transition:visibility .2s step-end,opacity .2s ease-in;-o-transition:visibility .2s step-end,opacity .2s ease-in;transition:visibility .2s step-end,opacity .2s ease-in}#ui-overlay{visibility:hidden;opacity:0;z-index:100000;position:fixed;top:-50%;left:-50%;height:200%;width:200%}#ui-dialog.open{display:block;-webkit-transition:opacity .2s ease-in;-o-transition:opacity .2s ease-in;transition:opacity .2s ease-in}#ui-dialog{display:none;opacity:0;z-index:100100;position:fixed;top:50px;margin:0;padding:0}#ui-dialog>*{-webkit-box-sizing:border-box;box-sizing:border-box}#ui-dialog-titlebar{position:relative}#ui-dialog-close{display:block;position:absolute;right:0;top:0;white-space:nowrap}#ui-dialog-body{overflow:auto;min-width:280px;height:92%;height:calc(100% - 2.1em)}@media (prefers-reduced-motion:reduce){#ui-overlay.open{-webkit-transition:opacity 0s;-o-transition:opacity 0s;transition:opacity 0s}#ui-overlay:not(.open){-webkit-transition:opacity 0s;-o-transition:opacity 0s;transition:opacity 0s}#ui-dialog.open{-webkit-transition:opacity 0s;-o-transition:opacity 0s;transition:opacity 0s}}#ui-overlay{background-color:#000}#ui-overlay.open{opacity:.8}#ui-dialog{max-width:66em}#ui-dialog.open{opacity:1}#ui-dialog-titlebar{background-color:#444;min-height:24px}#ui-dialog-title{margin:0;padding:.2em 3.5em .2em .5em;font-size:1.5em;text-align:center;text-transform:uppercase}#ui-dialog-close{cursor:pointer;font-size:120%;margin:0;padding:0;width:3.6em;height:92%;background-color:transparent;border:1px solid transparent;-webkit-transition-duration:.2s;-o-transition-duration:.2s;transition-duration:.2s}#ui-dialog-close:hover{background-color:#b44;border-color:#d66}#ui-dialog-body{background-color:#111;border:1px solid #444;text-align:left;line-height:1.5;padding:1em}#ui-dialog-body>:first-child{margin-top:0}#ui-dialog-body hr{background-color:#444}#ui-dialog-body ul.buttons{margin:0;padding:0;list-style:none}#ui-dialog-body ul.buttons li{display:inline-block;margin:0;padding:.4em .4em 0 0}#ui-dialog-body ul.buttons>li+li>button{margin-left:1em}#ui-dialog-close{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-close{font-family:tme-fa-icons!important;font-style:normal;font-weight:900;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}</style>
<style id="style-ui" type="text/css">#ui-dialog-body.settings [id|=setting-body]>div:first-child{display:table;width:100%}#ui-dialog-body.settings [id|=setting-label]{display:table-cell;padding:.4em 2em .4em 0}#ui-dialog-body.settings [id|=setting-label]+div{display:table-cell;min-width:8em;text-align:right;vertical-align:middle;white-space:nowrap}#ui-dialog-body.list{padding:0}#ui-dialog-body.list ul{margin:0;padding:0;list-style:none;border:1px solid transparent}#ui-dialog-body.list li{margin:0}#ui-dialog-body.list li:not(:first-child){border-top:1px solid #444}#ui-dialog-body.list li a{display:block;padding:.25em .75em;border:1px solid transparent;color:#eee;text-decoration:none}#ui-dialog-body.list li a:hover{background-color:#333;border-color:#eee}#ui-dialog-body.saves{padding:0 0 1px}#ui-dialog-body.saves>:not(:first-child){border-top:1px solid #444}#ui-dialog-body.saves table{border-spacing:0;width:100%}#ui-dialog-body.saves tr:not(:first-child){border-top:1px solid #444}#ui-dialog-body.saves td{padding:.33em .33em}#ui-dialog-body.saves td:first-child{min-width:1.5em;text-align:center}#ui-dialog-body.saves td:nth-child(3){line-height:1.2}#ui-dialog-body.saves td:last-child{text-align:right}#ui-dialog-body.saves .empty{color:#999;speak:none;text-align:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-body.saves .datestamp{font-size:75%;margin-left:1em}#ui-dialog-body.saves ul.buttons li{padding:.4em}#ui-dialog-body.saves ul.buttons>li+li>button{margin-left:.2em}#ui-dialog-body.saves ul.buttons li:last-child{float:right}#ui-dialog-body.settings div[id|=header-body]{margin:1em 0}#ui-dialog-body.settings div[id|=header-body]:first-child{margin-top:0}#ui-dialog-body.settings div[id|=header-body]:not(:first-child){border-top:1px solid #444;padding-top:1em}#ui-dialog-body.settings div[id|=header-body]>*{margin:0}#ui-dialog-body.settings h2[id|=header-heading]{font-size:1.375em}#ui-dialog-body.settings p[id|=header-desc],#ui-dialog-body.settings p[id|=setting-desc]{font-size:87.5%;margin:0 0 0 .5em}#ui-dialog-body.settings div[id|=setting-body]+div[id|=setting-body]{margin:1em 0}#ui-dialog-body.settings [id|=setting-control]{white-space:nowrap}#ui-dialog-body.settings button[id|=setting-control]{color:#eee;background-color:transparent;border:1px solid #444;padding:.4em}#ui-dialog-body.settings button[id|=setting-control]:hover{background-color:#333;border-color:#eee}#ui-dialog-body.settings button[id|=setting-control].enabled{background-color:#282;border-color:#4a4}#ui-dialog-body.settings button[id|=setting-control].enabled:hover{background-color:#4a4;border-color:#6c6}#ui-dialog-body.settings input[type=range][id|=setting-control]{max-width:35vw}#ui-dialog-body.list a,#ui-dialog-body.settings span[id|=setting-input]{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-body.saves button[id=saves-clear]:before,#ui-dialog-body.saves button[id=saves-export]:before,#ui-dialog-body.saves button[id=saves-import]:before,#ui-dialog-body.settings button[id|=setting-control].enabled:after,#ui-dialog-body.settings button[id|=setting-control]:after{font-family:tme-fa-icons!important;font-style:normal;font-weight:900;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#ui-dialog-body.saves button[id=saves-export]:before{content:"\e829\00a0"}#ui-dialog-body.saves button[id=saves-import]:before{content:"\e82a\00a0"}#ui-dialog-body.saves button[id=saves-clear]:before{content:"\e827\00a0"}#ui-dialog-body.settings button[id|=setting-control]:after{content:"\00a0\00a0\e830"}#ui-dialog-body.settings button[id|=setting-control].enabled:after{content:"\00a0\00a0\e831"}</style>
<style id="style-ui-bar" type="text/css">#story{margin-left:20em;-webkit-transition:margin-left .2s ease-in;-o-transition:margin-left .2s ease-in;transition:margin-left .2s ease-in}#ui-bar.stowed~#story{margin-left:4.5em}@media screen and (max-width:1136px){#story{margin-left:19em}#ui-bar.stowed~#story{margin-left:3.5em}}@media screen and (max-width:768px){#story{margin-left:3.5em}}#ui-bar{position:fixed;z-index:50;top:0;left:0;width:17.5em;height:100%;margin:0;padding:0;-webkit-transition:left .2s ease-in;-o-transition:left .2s ease-in;transition:left .2s ease-in}#ui-bar.stowed{left:-15.5em}#ui-bar-tray{position:absolute;top:.2em;left:0;right:0}#ui-bar-body{height:90%;height:calc(100% - 2.5em);margin:2.5em 0;padding:0 1.5em}#ui-bar.stowed #ui-bar-body,#ui-bar.stowed #ui-bar-history{visibility:hidden;-webkit-transition:visibility .2s step-end;-o-transition:visibility .2s step-end;transition:visibility .2s step-end}@media (prefers-reduced-motion:reduce){#story{-webkit-transition:margin-left 0s;-o-transition:margin-left 0s;transition:margin-left 0s}#ui-bar{-webkit-transition:left 0s;-o-transition:left 0s;transition:left 0s}}#ui-bar{background-color:#222;border-right:1px solid #444;text-align:center}#ui-bar a{text-decoration:none}#ui-bar hr{border-color:#444}#ui-bar-history [id|=history],#ui-bar-toggle{font-size:1.2em;line-height:inherit;color:#eee;background-color:transparent;border:1px solid #444}#ui-bar-toggle{display:block;position:absolute;top:0;right:0;border-right:none;padding:.3em .45em .25em}#ui-bar.stowed #ui-bar-toggle{padding:.3em .35em .25em .55em}#ui-bar-toggle:hover{background-color:#444;border-color:#eee}#ui-bar-history{margin:0 auto}#ui-bar-history [id|=history]{padding:.2em .45em .35em}#ui-bar-history #history-jumpto{padding:.2em .665em .35em}#ui-bar-history [id|=history]:not(:first-child){margin-left:1.2em}#ui-bar-history [id|=history]:hover{background-color:#444;border-color:#eee}#ui-bar-history [id|=history]:disabled{color:#444;background-color:transparent;border-color:#444}#ui-bar-body{line-height:1.5;overflow:auto}#ui-bar-body>:not(:first-child){margin-top:2em}#story-title{margin:0;font-size:162.5%}#story-author{margin-top:2em;font-weight:700}#menu ul{margin:1em 0 0;padding:0;list-style:none;border:1px solid #444}#menu ul:empty{display:none}#menu li{margin:0}#menu li:not(:first-child){border-top:1px solid #444}#menu li a{display:block;padding:.25em .75em;border:1px solid transparent;color:#eee;text-transform:uppercase}#menu li a:hover{background-color:#444;border-color:#eee}#menu a,#ui-bar-history [id|=history],#ui-bar-toggle{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#menu-core li[id|=menu-item] a:before,#ui-bar-history [id|=history],#ui-bar-toggle:before{font-family:tme-fa-icons!important;font-style:normal;font-weight:900;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#ui-bar-toggle:before{content:"\e81d"}#ui-bar.stowed #ui-bar-toggle:before{content:"\e81e"}#menu-item-saves a:before{content:"\e82b\00a0"}#menu-item-settings a:before{content:"\e82d\00a0"}#menu-item-restart a:before{content:"\e82c\00a0"}#menu-item-share a:before{content:"\e82f\00a0"}</style>
<style id="style-ui-debug" type="text/css">#debug-bar{background-color:#222;border-left:1px solid #444;border-top:1px solid #444;bottom:0;margin:0;max-height:75%;padding:.5em;position:fixed;right:0;z-index:99900}#debug-bar>div:not([id])+div{margin-top:.5em}#debug-bar>div>label{margin-right:.5em}#debug-bar>div>input[type=text]{min-width:0;width:8em}#debug-bar>div>select{width:15em}#debug-bar-toggle{color:#eee;background-color:#222;border:1px solid #444;height:101%;height:calc(100% + 1px);left:-2em;left:calc(-2em - 1px);position:absolute;top:-1px;width:2em}#debug-bar-toggle:hover{background-color:#333;border-color:#eee}#debug-bar-hint{bottom:.175em;font-size:4.5em;opacity:.33;pointer-events:none;position:fixed;right:.6em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap}#debug-bar-watch{background-color:#222;border-left:1px solid #444;border-top:1px solid #444;bottom:102%;bottom:calc(100% + 1px);font-size:.9em;left:-1px;max-height:650%;max-height:65vh;position:absolute;overflow-x:hidden;overflow-y:scroll;right:0;z-index:99800}#debug-bar-watch[hidden]{display:none}#debug-bar-watch div{color:#999;font-style:italic;margin:1em auto;text-align:center}#debug-bar-watch table{width:100%}#debug-bar-watch tr:nth-child(2n){background-color:rgba(127,127,127,.15)}#debug-bar-watch td{padding:.2em 0}#debug-bar-watch td:first-child+td{padding:.2em .3em .2em .1em}#debug-bar-watch .watch-delete{background-color:transparent;border:none;color:#c00}#debug-bar-watch-all,#debug-bar-watch-none{margin-left:.5em}#debug-bar-views-toggle,#debug-bar-watch-toggle{color:#eee;background-color:transparent;border:1px solid #444;margin-right:1em;padding:.4em}#debug-bar-views-toggle:hover,#debug-bar-watch-toggle:hover{background-color:#333;border-color:#eee}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle,html[data-debug-view] #debug-bar-views-toggle{background-color:#282;border-color:#4a4}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle:hover,html[data-debug-view] #debug-bar-views-toggle:hover{background-color:#4a4;border-color:#6c6}#debug-bar-hint:after,#debug-bar-toggle:before,#debug-bar-views-toggle:after,#debug-bar-watch .watch-delete:before,#debug-bar-watch-add:before,#debug-bar-watch-all:before,#debug-bar-watch-none:before,#debug-bar-watch-toggle:after{font-family:tme-fa-icons!important;font-style:normal;font-weight:900;font-variant:normal;line-height:1;speak:never;text-rendering:auto;text-transform:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}#debug-bar-toggle:before{content:"\e838"}#debug-bar-hint:after{content:"\e838\202f\e822"}#debug-bar-watch .watch-delete:before{content:"\e804"}#debug-bar-watch-add:before{content:"\e805"}#debug-bar-watch-all:before{content:"\e83a"}#debug-bar-watch-none:before{content:"\e827"}#debug-bar-views-toggle:after,#debug-bar-watch-toggle:after{content:"\00a0\00a0\e830"}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle:after,html[data-debug-view] #debug-bar-views-toggle:after{content:"\00a0\00a0\e831"}html[data-debug-view] .debug{padding:.25em;background-color:#234}html[data-debug-view] .debug[title]{cursor:help}html[data-debug-view] .debug.block{display:inline-block;vertical-align:middle}html[data-debug-view] .debug.invalid{text-decoration:line-through}html[data-debug-view] .debug.hidden,html[data-debug-view] .debug.hidden .debug{background-color:#555}html:not([data-debug-view]) .debug.hidden{display:none}html[data-debug-view] .debug[data-name][data-type].nonvoid:after,html[data-debug-view] .debug[data-name][data-type]:before{background-color:rgba(0,0,0,.25);font-family:monospace,monospace;white-space:pre}html[data-debug-view] .debug[data-name][data-type]:before{content:attr(data-name)}html[data-debug-view] .debug[data-name][data-type|=macro]:before{content:"<<" attr(data-name) ">>"}html[data-debug-view] .debug[data-name][data-type|=macro].nonvoid:after{content:"<</" attr(data-name) ">>"}html[data-debug-view] .debug[data-name][data-type|=html]:before{content:"<" attr(data-name) ">"}html[data-debug-view] .debug[data-name][data-type|=html].nonvoid:after{content:"</" attr(data-name) ">"}html[data-debug-view] .debug[data-name][data-type]:not(:empty):before{margin-right:.25em}html[data-debug-view] .debug[data-name][data-type].nonvoid:not(:empty):after{margin-left:.25em}html[data-debug-view] .debug[data-name][data-type|=special],html[data-debug-view] .debug[data-name][data-type|=special]:before{display:block}</style>
</head>
<body>
	<div id="init-screen">
		<div id="init-no-js"><noscript>JavaScript must be enabled to play.</noscript></div>
		<div id="init-lacking"><p>Browser lacks capabilities required to play.</p><p>Upgrade or switch to another browser.</p></div>
		<div id="init-loading"><div>Loading&hellip;</div></div>
	</div>
	<!-- UUID://277E920D-BECE-4796-A59D-C892911819DC// --><tw-storydata name="Free Cities: Origins" startnode="126" creator="Tweego" creator-version="2.1.1+81d1d71" ifid="277E920D-BECE-4796-A59D-C892911819DC" zoom="1" format="SugarCube" format-version="2.36.1" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">/* twine-user-stylesheet #1: "notify.min.css" */
/* notify.min.css, by chapel; for use with notify.js; v1.0.0 */
#notify{position:fixed;display:block;width:16em;right:-20em;top:2em;padding:.5em;background-color:#fff;color:#000;-webkit-transition:right .3s;-moz-transition:right .3s;-o-transition:right .3s;transition:right .3s}#notify.open{right:0}
/* end notify.min.css */
/* twine-user-stylesheet #2: "popover.min.css" */
/* popover.min.css, by chapel; for use with popover.js; v1.0.0 */
#ui-dialog-body.popover{background:0 0;border:0;padding:0}.popover #ui-dialog-titlebar{background:0 0}.popover #ui-dialog-title{display:none}.popover #ui-dialog-close{position:fixed;display:block;top:0;right:0;height:3em}.popover #ui-dialog-close:hover{background-color:transparent;border-color:transparent;color:#c22}#ui-overlay.popover.opaque{opacity:1}#ui-overlay.popover.transparent{opacity:0}#ui-overlay.popover.invert{background-color:#f8f8f8}#ui-dialog-body.popover.invert{color:#111}
/* end popover.min.css */
/* twine-user-stylesheet #3: "speech.min.css" */
/* speech.min.css, by chapel; for use with speech.js */
.say{border:1px solid #eee;overflow:auto}.say img{max-width:20%;float:left;margin-right:1em}.say p:first-of-type{font-weight:700;margin:.2em 0;border-bottom:1px solid #eee}.say p:last-of-type{padding:.5em;margin:0}
/* twine-user-stylesheet #4: "animations.css" */
.fade-in {
    visibility: visible;
    opacity: 1;
    transition: opacity var(--time) linear;
}

.fade-out {
    visibility: hidden;
    opacity: 0;
    transition: visibility 0s var(--time), opacity var(--time) linear;
}
/* twine-user-stylesheet #5: "area.css" */
area.access:hover {

}

area.closed:hover {

}

area.noaccess:hover {
    
}
/* twine-user-stylesheet #6: "attributeselection.css" */
#attribute_selection {
    display: grid;
    column-gap: 25px;
    row-gap: 25px;
    grid-template-columns: repeat(5, 200px);
    grid-template-rows: repeat(2, 165px);
    height: 50%;
    padding: 10px 50px;
}

#attribute_selection .subbackground {
    text-align: center;
    font-weight: normal;
    font-size: smaller;
}

#attribute_selection .subbackground strong {
    font-size: larger;
}

#attribute_selection button {
    margin-top: 5px;
}

#attribute_selection button.selected {
    color: white;
    background-color: #651A1A;
}

#attribute_selection button.disabled {
    background-color: transparent;
    opacity: 0.5;
}

#attribute_selection button.selected.disabled {
    color: white;
    background-color: #651A1A;
    opacity: 1;
}
/* twine-user-stylesheet #7: "backgrounds.css" */
#background {
    width: 1400px;
    height:830px;
    background-repeat:no-repeat;
    background-size:1400px 830px;

    box-sizing: border-box;
    padding: 100px;
    padding-top: 60px;
    padding-bottom: 60px;
    display: inline-block;
}

#background.notext {
    padding: 60px;
}

#background.paper {
    background-image:url('resources/images/backgrounds/paper.jpg');
}

#background.chalkboard {
    background-image:url('resources/images/backgrounds/chalkboard.jpg');
}

#background.paper_border {
    background-image:url('resources/images/backgrounds/paper_border.png');
}

#background.city_border {
    background-image:url('resources/images/backgrounds/city_border.png');
}

#background.bluewood {
    background-image:url('resources/images/backgrounds/bluewood.jpg');
}

.subbackground {
    box-sizing: border-box;
    height: 100%;
    width: 100%;
    display: inline-block;
    padding: 5px;
    font-weight: bold;
    border: solid #5b0d00 2px;
    background-image: url('resources/images/backgrounds/paper_rough.jpg');
    background-repeat: repeat;
    box-shadow:0 2px 3px 1px rgba(0,0,0,0.25);
    overflow-x: hidden;
    overflow-y: auto;
}

/* twine-user-stylesheet #8: "bars.css" */
.chapel-meter {
    border: solid #651A1A 1px;
    /* box-shadow:0 2px 3px 1px rgba(0,0,0,0.25); */
    width: calc(100% - 2px);
    height: 24px;
    margin-top: 2px;
    margin-bottom: 2px;
}
/* twine-user-stylesheet #9: "buttons.css" */
/* GREAT UL VENDOR BELOW */

.passage button {
    margin-right: 2px auto;
    display: inline;
    width: 160px;
    min-height: 42px;
    text-align: center;
    background-color: rgba(114, 0, 0, 0.1);
    font-family: 'Constantia', sans-serif;
    color: #651A1A;
    font-weight: bold;
    letter-spacing: 1px;
    text-decoration: none;
    text-transform: uppercase;
    border: 2px solid #651A1A;
    padding: 7.5px;
    font-size: 95%;
    box-shadow: 0 2px 3px 0px rgba(0,0,0,0.25);
}

.column button {
    margin: 2px;
}

.half button {
    width: 80px;
}

.twoThirds button {
    width: 107px
}

.threeQuarters button {
    width: 120px;
}

.fiveQuarters button {
    width: 200px;
}

.threeHalfs button {
    width: 240px;
}

.passage .double button {
    width: 320px;
}

.passage button:hover {
    color: white;
    background-color: #651A1A;
}

.passage button.disabled  {
    background-color: transparent;
    opacity: 0.5;
}

.passage button.disabled:hover {
    color: #651A1A;
    background-color: transparent;
}

.passage .option button {
    font-weight: normal;
    text-transform: none;
    margin-left: 25px;
    margin-right: 25px;
}

.passage .smalltext button {
    font-size: smaller;
}

.textspeed button {
    width: 65px;
    border: 1px solid #651A1A;
}

.buttonfiller {
    min-height: 42px;
    box-sizing: border-box;
}

.buttonfiller.fiveQuarters {
    min-width: 200px;
}

.equipButton {
    position: absolute;
    height: 42px;
    width: 42px;
}
.equipButton button {
    height: 42px;
    width: 42px;
    max-height: 42px;
    max-width: 42px;
    position: absolute;
}
/* twine-user-stylesheet #10: "charactermenu.css" */
.charside {
    position: absolute;
    height:830px;
    background-image: url('resources/images/backgrounds/paper_rough.jpg');
    background-repeat: repeat;
    box-shadow:0 2px 3px 1px rgba(0,0,0,0.25);
    width: 214px;
    z-index: 2;
    display: inline-block;
    border: solid #5b0d00 2px;
    padding: 2.5px;
    box-sizing: border-box;
}

.charside.left {
    left: 0;
}

.charside.right {
    right: 0;
}

.charside button {
    margin: 2.5px
}

.charside .buttonfiller {
    margin: 2.5px
}

#characterMenuImage {
    height: 459px;
    width: 406.6667px;
    background-size: contain;
    margin-left: -5px;
    margin-bottom: 20px;
}

#playerMenuImage {
    height: 459px;
    width: 406.6667px;
    background-size: contain;
    margin-left: -5px;
    margin-bottom: 20px;
}

.centerDetails {
    grid-column: 1 / span 2;
}

.equipOverlay {
    height: 459px;
    width: 406.6667px;
    z-index: 5;
    position: relative;
    border-color: #5b0d00;
    border-width: 2px;
}
/* twine-user-stylesheet #11: "commodityLog.css" */
/* Style for the main text panel */
#commodityLog.hidden {
    display: none;
}

#commodityLog p {
    margin: 0;
}

#commodity_name {
    font-size: larger;
}
/* twine-user-stylesheet #12: "containers.css" */
/* Basic grid container */

.container {
    display: grid;
}
.container.twoCol {
    column-gap: 10%;
    grid-template-columns: 45% 45%;
}
.list.container.twoCol {
    grid-template-columns: 70% 20%;
}
.container.threeCol {
    column-gap: 5%;
    grid-template-columns: 30% 30% 30%;
}
.container.fourCol {
    column-gap: 4%;
    grid-template-columns: 22% 22% 22% 22%;
}
.container.twoRow {
    row-gap: 8%;
    grid-template-rows: 46% 46%;
}
.container.threeRow {
    row-gap: 5%;
    grid-template-rows: 30% 30% 30%;
}

.main.container {
    column-gap: 30px;
    row-gap: 30px;
    height: 100%;
    width: 100%;
}
.main.container.twoCol {
    grid-template-columns: repeat(2, calc((1280px - 1 * 30px) / 2));
}
.main.container.threeCol {
    grid-template-columns: repeat(3, calc((1280px - 2 * 30px) / 3));
}
.main.container.fourCol {
    grid-template-columns: repeat(4, calc((1280px - 3 * 30px) / 4));
}
.main.container.twoRow {
    grid-template-rows: repeat(2, calc((710px - 1 * 30px) / 2));
}
.main.container.threeRow {
    grid-template-rows: repeat(3, calc((710px - 2 * 30px) / 3));
}

.container .textpassage {
    margin-left: 30px;
    margin-right: 30px;
}

.action.container {
    row-gap: 2px;
    font-weight: normal; height: 100%; width: 100%;
    box-sizing: border-box;
}
.action.container.row {
    grid-template-rows: repeat(var(--rows), 42px);
    padding: calc((202.6666px - (var(--rows) - 1) * 2px - var(--rows) * 42px) / 2)
}
.action.container.col {
    column-gap: calc((938.5px - var(--cols) * 160px - calc(202.6666px - (var(--rows) - 1) * 2px - var(--rows) * 42px)) / (var(--cols) - 1));
    grid-template-columns: repeat(var(--cols), 160px);
}

.action.container.col.longbutton {
    column-gap: calc((938.5px - var(--cols) * 200px - calc(202.6666px - (var(--rows) - 1) * 2px - var(--rows) * 42px)) / (var(--cols) - 1));
    grid-template-columns: repeat(var(--cols), 200px);
}
/* twine-user-stylesheet #13: "core.css" */
body {
    display: flex;
    
    justify-content: center;
    text-align: center;
    align-items: center;
    
    max-height: 100vh;
    min-height: 100vh;
    margin-top: 0em;

    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; 

    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;

}

body.black {
    background-image: url(resources/images/backgrounds/blackwood.jpg);
}

body.paper {
    background-image: url(resources/images/backgrounds/paper.jpg);
}


#passages {
    max-width: none;
}

.passage {
    font-family: Lora, serif;
    font-size: 20px;
    color: #651A1A;
}

.textpassage {
    text-align:justify;  
    text-justify:inter-word;
    font-weight: normal;
}

.popuptext {
    padding: 100px;
    padding-top: 60px;
    text-align:justify;  
    text-justify:inter-word;
    font-weight: normal;
}

/* Text inputs */
input[type=text] {
    color: black;
    background-color: transparent;
}

input[type=text]:focus  {
    background-color: LightGoldenRodYellow;
    border: solid black 1px;
}

textarea:hover, input[type="text"]:hover {
    background: LightGoldenRodYellow;
    border: solid black 1px;
}

#ui-bar {
    display: none;
}

.hidden {
    display: none;
    visibility: hidden;
    opacity: 0;
}

hr {
    border: none;
    border-top: 3px double #333;
    color: #333;
    overflow: visible;
    text-align: center;
    height: 0;
}

hr:after {
    background: transparent;
    content: '§';
    padding: 0 4px;
    position: relative;
    top: -20px;
}

#notify {
    z-index: 10;
}

.fail {
    color: red;
}

.success {
    color: green;
}

.partial {
    color: gold;
}

ul {
    margin-top: 0;
}

.gameversion{
    position: absolute;
    right: 100px;
    bottom: 70px;
    color: #651A1A;
    font-weight: bold;
}

#story a.link-external {
	text-decoration: none;
}
#story a.link-external:after {
	content: "";
}

.message-text {
    font-weight: bold;
}

.message-text p {
    font-weight: normal;
}

#banner {
    background-image: url('resources/images/banner.jpg');
    background-size: contain;
    width: 100%;
    height: 347px;
}

#sample {
    background-image: url('resources/images/sample.png');
    background-size: contain;
    width: 800px;
    height: 385px;
}

* {
    scrollbar-width: thin;
    /*-webkit-user-select: text; 
    user-select: text;*/
}

.list {
    font-weight: normal;
}
/* twine-user-stylesheet #14: "equip.css" */
#head.equipButton {
    top: 14px;
    left: 110px;
}
#headLine {
    position: absolute;
    top: 33px;
    left: 152.5px;
    height: 2px;
    width: 40px;
    background-color: black;
}

#chest.equipButton {
    top: 94px;
    left: 70px;
}
#chestLine {
    position: absolute;
    top: 113px;
    left: 112px;
    height: 2px;
    width: 45px;
    background-color: black;
}

#legs.equipButton {
    top: 204px;
    left: 70px;
}
#legsLine {
    position: absolute;
    top: 223px;
    left: 112px;
    height: 2px;
    width: 55px;
    background-color: black;
}

#feet.equipButton {
    top: 404px;
    left: 90px;
}
#feetLine {
    position: absolute;
    top: 423px;
    left: 132px;
    height: 2px;
    width: 40px;
    background-color: black;
}

#neck.equipButton {
    top: 54px;
    left: 280px;
}
#neckLine {
    position: absolute;
    top: 73px;
    left: 210px;
    height: 2px;
    width: 70px;
    background-color: black;
}

#weapon1.equipButton {
    top: 154px;
    left: 300px;
}
#weapon2.equipButton {
    top: 154px;
    left: 350px;
}
#weaponLine {
    position: absolute;
    top: 195px;
    left: 250px;
    height: 47px;
    width: 70px;
    border-color: black;
    border-width: 2px;
    border-style: solid;
    border-top: none;
    border-left: none;
}

#groin1.equipButton {
    top: 284px;
    left: 270px;
}
#groin2.equipButton {
    top: 284px;
    left: 320px;
}
#groinLine {
    position: absolute;
    top: 246px;
    left: 203px;
    height: 2px;
    width: 66px;
    border-style: solid;
    border-width: 2px;
    border-color: black;
    height: 58px;
    border-top: none;
    border-right: none;
}
/* twine-user-stylesheet #15: "finalization.css" */
#finalization_summary {
    overflow-y: scroll;
}
/* twine-user-stylesheet #16: "logo.css" */

img.logo {
    height: 60vh;
    width: auto;
    margin-top: -20vh;
}

h1.logo {
    font-style: bold;
    font-variant: small-caps;
    font-size: 100px;
    text-align: center;
    color: white;
    margin: 0;
    display: none; 
    margin-top: -20vh;
}

div.license {
    position: relative;
    font-weight: normal;
    top: 640px;
}
img.license {
    height: 30px; 
    width: auto;
    position: absolute;
    left: 30px;
    top: 0px;
}
p.license.title {
    position: absolute;
    left: 135px;
    top: -22px;
}
/* twine-user-stylesheet #17: "mainLog.css" */
/* Style for the main text panel */
.mainLog {
    box-sizing: border-box;
    overflow-y: scroll;
    padding: 14.333px;
    height: 100%;
    width: calc(100% - 200px);
    font-weight: normal;
    text-align: justify;
    float: right;
}


.mainLogImageContainer {
    height: 459px; 
    position: absolute; 
    display: inline-block;
}

.mainLogImage {
    box-sizing: border-box;
    height: 459px;
    width: 200px;
    display: inline-block;
    position: relative;
}

.mainLogCharacterImage {
    height: 100%;
    width: 100%;
    z-index: 2;
    background-size: 200px 459px;
    position: absolute;
    top: 0;
    left: 0;
}

.mainLogContainer {
    grid-row: 1 / span 2; 
    grid-column: 1 / span 3;
    padding: 0;
}

#mainLog.hidden {
    display: none;
}

.mainLog.hidden {
    display: none;
}
/* twine-user-stylesheet #18: "map.css" */
.mapside {
    position: absolute;
    height:830px;
    background-image: url('resources/images/backgrounds/paper_rough.jpg');
    background-repeat: repeat;
    box-shadow:0 2px 3px 1px rgba(0,0,0,0.25);
    width: 214px;
    z-index: 2;
    display: inline-block;
    border: solid #5b0d00 2px;
    padding: 2.5px;
    box-sizing: border-box;
}

.mapside.left {
    left: 0;
}

.mapside.right {
    right: 0;
}

.mapside button {
    margin: 2.5px
}

.mapside .buttonfiller {
    margin: 2.5px
}
/* twine-user-stylesheet #19: "menubar.css" */
.menubar {
    width: 100%;
    margin-top: 5px;
}

.menubar button {
    width: 30px;
    min-height: 30px;
    box-sizing: border-box;
    padding: 0;
    border: 1px solid #651A1A;
    font-size: smaller;
}
/* twine-user-stylesheet #20: "message.css" */
.message-text {
    font-weight: normal;
}

.message-text a {
    font-weight: bold;
}
/* twine-user-stylesheet #21: "saves.css" */
.saves button {
    margin-right: 2px auto;
    display: inline;
    min-width: 80px;
    text-align: center;
    background-color: rgba(114, 0, 0, 0.1);
    font-family: 'Constantia', sans-serif;
    color: #651A1A;
    font-weight: bold;
    letter-spacing: 1px;
    text-decoration: none;
    text-transform: uppercase;
    border: 2px solid #651A1A;
    font-size: 95%;
    box-shadow: 0 2px 3px 0px rgba(0,0,0,0.25);
}

#ui-dialog-body.saves .empty {
    color: #651A1A;
}

#ui-dialog-body.saves tbody td div {
    font-weight: bold;
}

#ui-dialog-body.saves tbody td div.datestamp {
    font-weight: normal;
}

.saves button:hover {
    color: white;
    background-color: #651A1A;
}

.saves button.disabled  {
    background-color: transparent;
    opacity: 0.5;
}

.saves button.disabled:hover {
    color: #651A1A;
    background-color: transparent;
}

#saves-export {
    width: 200px;
}

#saves-import {
    width: 200px;
}

#ui-dialog-body.saves {
    background-image: url('resources/images/backgrounds/paper.jpg');
}

#ui-dialog-body.saves tbody {
    color: #651A1A;
}
/* twine-user-stylesheet #22: "slider.css" */
input[type=range] {
    width: 100%;
    margin: 4.3px 0;
    background-color: transparent;
    -webkit-appearance: none;
    border: none;
}
input[type=range]:hover {
    width: 100%;
    margin: 4.3px 0;
    background-color: transparent;
    -webkit-appearance: none;
    border: none;
}
input[type=range]:focus {
    width: 100%;
    margin: 4.3px 0;
    background-color: transparent;
    -webkit-appearance: none;
    border: none;
    outline: none;
}
input[type=range]::-webkit-slider-runnable-track {
    background: #dddddd;
    border: 0.2px solid #010101;
    border-radius: 1.3px;
    width: 100%;
    height: 8.4px;
    cursor: pointer;
}
input[type=range]::-webkit-slider-thumb {
    margin-top: -4.5px;
    width: 16px;
    height: 17px;
    background: #ffffff;
    border: 1px solid #651a1a;
    border-radius: 4px;
    cursor: pointer;
    -webkit-appearance: none;
}
input[type=range]:focus::-webkit-slider-runnable-track {
    background: #eaeaea;
}
input[type=range]::-moz-range-track {
    background: #dddddd;
    border: 0.2px solid #010101;
    border-radius: 1.3px;
    width: 100%;
    height: 8.4px;
    cursor: pointer;
}
input[type=range]::-moz-range-thumb {
    width: 16px;
    height: 17px;
    background: #ffffff;
    border: 1px solid #651a1a;
    border-radius: 4px;
    cursor: pointer;
}
input[type=range]::-ms-track {
    background: transparent;
    border-color: transparent;
    border-width: 5.3px 0;
    color: transparent;
    width: 100%;
    height: 8.4px;
    cursor: pointer;
}
input[type=range]::-ms-fill-lower {
    background: #d0d0d0;
    border: 0.2px solid #010101;
    border-radius: 2.6px;
}
input[type=range]::-ms-fill-upper {
    background: #dddddd;
    border: 0.2px solid #010101;
    border-radius: 2.6px;
}
input[type=range]::-ms-thumb {
    width: 16px;
    height: 17px;
    background: #ffffff;
    border: 1px solid #651a1a;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 0px;
    /*Needed to keep the Edge thumb centred*/
}
input[type=range]:focus::-ms-fill-lower {
    background: #dddddd;
}
input[type=range]:focus::-ms-fill-upper {
    background: #eaeaea;
}
/*TODO: Use one of the selectors from https://stackoverflow.com/a/20541859/7077589 and figure out
how to remove the virtical space around the range input in IE*/
@supports (-ms-ime-align:auto) {
    /* Pre-Chromium Edge only styles, selector taken from hhttps://stackoverflow.com/a/32202953/7077589 */
    input[type=range] {
        margin: 0;
        /*Edge starts the margin from the thumb, not the track as other browsers do*/
    }
}

#volume-control {
    position:relative; 
    left: -9px;
}
/* twine-user-stylesheet #23: "tooltips.css" */
/* Tooltip container */
.tooltip {
    position: relative;
    display: inline-block;
    border-bottom: 1px dotted #651A1A; /* If you want dots under the hoverable text */
}
  
/* Tooltip text */
.tooltip .tooltiptext {
    visibility: hidden;
    width: 200px;
    background-color: black;
    opacity: 75%;
    color: #fff;
    text-align: center;
    padding: 5px 0;
    border-radius: 6px;
    font-size: smaller;
    position: absolute;
    z-index: 1;
}

.tooltip .tooltiptext.right {
    width: 300px;
    top: -5px;
    left: 105%;
}

.tooltip .tooltiptext.bottom {
    width: 300px;
    top: 100%;
    left: 50%;
    margin-left: -150px; /* Use half of the width (120/2 = 60), to center the tooltip */
}

.tooltip .tooltiptext::after {
    content: " ";
    position: absolute;
    border-width: 5px;
    border-style: solid;
}

.tooltip .tooltiptext.right::after {
    top: 50%;
    right: 100%; /* To the left of the tooltip */
    margin-top: -5px;
    border-color: transparent black transparent transparent;
}

.tooltip .tooltiptext.bottom::after {
    bottom: 100%;  /* At the top of the tooltip */
    left: 50%;
    margin-left: -5px;
    border-color: transparent transparent black transparent;
  }


.tooltip:hover {
    cursor: help;
}

/* Show the tooltip text when you mouse over the tooltip container */
.tooltip:hover .tooltiptext {
    visibility: visible;
}

.tool {
    position: relative;
    display: inline-block;
    border-bottom: 1px dotted #651A1A;
    margin-top: 2px;
}

.tool:hover {
    cursor: pointer;
}</style><script role="script" id="twine-user-script" type="text/twine-javascript">/* twine-user-script #1: "CONSTANTS.js" */
setup.VERSION = "0.0.1.5"
setup.LARI = "¤";
setup.STATS = ['dexterity', 'intelligence', 'manipulation', 'strength', 'tact'];
setup.CONDITIONS = ['health', 'stamina'];
// Ranges from 0 to 100
setup.SKILLS = ['melee', 'ranged', 'survival',
                'education'];
setup.MENTAL_CONDITIONS = ['anger', 'cum_addiction', 'arousal', 'sadness', 'illness', 'suspicion',
                            'rebellion', 'discomfort'];
setup.PHYSICAL_CONDITIONS = ['anal_wear', 'vaginal_wear'];
setup.SLAVE_TRAITS = ['willpower', 'trust', 'obedience'];
// Measure Beauty 0 - 100, weight -100 to 100 (0 is normal), height (cm)
setup.PHYSICAL_TRAITS = ['beauty', 'weight', 'height'];

// Status heirarchy
setup.HEIRARCHY = {
    "unknown": 0,
    "low_slave": 1,
    "slave": 2,
    "high_slave": 3,
    "citizen": 4,
    "rich citizen": 5
}

// Non-measure
Array.prototype.push.apply(setup.PHYSICAL_TRAITS, [
    'eye_color', 'hair_color', 'skin_color', 'ethnicity'
]);

// Sex-related constants
// Ranges from 0 to 100
setup.SEX_SKILLS = ['anal', 'oral', 'vaginal', 'entertainment', 'bondage', 'other']
// Ranges from -100 to 100 describing preference
setup.SEX_PREFS = ['anal', 'oral', 'vaginal']
// Ranges from 0 to 100 describing fetish strength
setup.SEX_FETISHES = ['cum', 'feet', 'exhibitionism', 'pregnancy', 'free_use', 'humiliation']
// Ranging from -100 to 100 describes spectrum
setup.SEX_RANGES = ['sub_dom', 'hate_love_men', 'hate_love_women']

setup.DESCRIPTORS = {
    'beauty': {
        0: "very ugly",
        10: "ugly",
        20: "very unattractive",
        35: "unattractive",
        50: "normal",
        60: "attractive",
        70: "very attractive",
        80: "beautiful",
        90: "perfect",
        95: "angelic"
    },
    'weight': {
        '-100': "emaciated",
        '-75': "dangerously skinny",
        '-25': "underweight",
        '-10': "slim",
        0: "normal",
        10: "plush",
        25: "overweight",
        50: "obese",
        75: "dangerously obese" 
    },
    'gender': {
        0: "male",
        1: "female"
    },
    'obedience': {
        0: "hateful",
        15: "disliking",
        30: "cold",
        50: "ambivalent",
        60: "warm",
        70: "friendly",
        80: "loving",
        90: "devoted"
    },
    'trust': {
        "-100": "terrified",
        "-75": "scared",
        "-50": "highly fearful",
        "-25": "fearful",
        0: "skeptical",
        25: "confiding",
        50: "trustful",
        75: "highly trustful",
        90: "completely trustful"
    },
    'willpower': {
        0: "completely submissive",
        10: "very submissive",
        20: "submissive",
        30: "somewhat submissive",
        40: "slightly submissive",
        50: "normal",
        60: "slightly dominant",
        70: "dominant",
        80: "very dominant",
        90: "completely dominant"
    },
    'education_flavor_text': {
        0: "completely illiterate and naive",
        10: "somewhat educated, reading at a 5 year olds level",
        20: "somewhat educated, reading at a 12 year olds level",
        30: "slightly educated and literate",
        40: "completely literate",
        50: "educated",
        60: "well educated",
        80: "scholar",
        90: "scholar well versed in the ways of the world"
    },
    'intelligence': {
        0: "potato",
        15: "very dumb",
        30: "dumb",
        40: "below average",
        50: "average",
        60: "above average",
        70: "smart",
        80: "very smart",
        90: "brillian",
        95: "peerless"
    },
    'dexterity': {
        0: "hazard",
        15: "accident prone",
        30: "very clumsy",
        40: "clumsy",
        50: "average",
        60: "above average",
        70: "flexible",
        80: "bendy",
        90: "assassin"
    }, 
    'manipulation': {
        0: "socially inept",
        15: "naive",
        40: "below average",
        50: "average",
        60: "above average",
        80: "socially skilled",
        90: "strategist"
    }, 
    'strength' : {
        0: "very nimble",
        15: "nimble",
        30: "very weak",
        40: "weak",
        50: "average",
        60: "strong",
        70: "very strong",
        90: "muscular"
    }, 
    'tact': {
        0: "socially inept",
        15: "naive",
        40: "below average",
        50: "average",
        60: "above average",
        80: "socially skilled",
        90: "strategist"
    },
    'default_pref': {
        "-100": "hates",
        "-75": "highly dislikes",
        "-50": "dislikes",
        "-25": "doesn\'t prefer",
        0: "is disinterested about",
        25: "prefers",
        50: "likes",
        75: "highly likes",
        90: "loves"
    },
    'default_skill': {
        0: "none",
        10: "novice",
        25: "apprentice",
        50: "adept",
        75: "expert",
        90: "master"
    }
};

setup.PRONOUNS = {
    0: {
        "?he" : "he",
        "?him": "him",
        "?his": "his"
    },
    1: {
        "?he" : "she",
        "?him": "her",
        "?his": "her"
    }
};

setup.LIMITS = {
    "ask": 3,
    "request": 2,
    "influence": 3,
    "manipulate": 2,
    "search": 1,
    "molest": 1,
    "fuck": 1
}

// Whether or not gaining is positive
setup.POSITIVES = {
    "player": {
        "obedience": true,
        "willpower": true,
        "trust": true,
    },
    "character": {
        "obedience": true,
        "willpower": false,
        "trust": true,
        "cum_addiction": true,
        "anger": false,
        "suspicion": false
    }
}
for (const stat of setup.STATS) {
    setup.POSITIVES.player[stat] = true;
    setup.POSITIVES.character[stat] = true;
}
for (const condition of setup.CONDITIONS) {
    setup.POSITIVES.player[condition] = true;
    setup.POSITIVES.character[condition] = true;
}
for (const skill of setup.SKILLS) {
    setup.POSITIVES.player[skill] = true;
    setup.POSITIVES.character[skill] = true;
}
for (const skill of setup.SEX_SKILLS) {
    setup.POSITIVES.player[skill] = true;
    setup.POSITIVES.character[skill] = true;
}
for (const fetish of setup.SEX_FETISHES) {
    setup.POSITIVES.player[fetish] = true;
    setup.POSITIVES.character[fetish] = true;
}

/* twine-user-script #2: "Character.js" */
/* Character object which defines a slave */

setup.Character = function(key, randomize=true, cap=20) {
    // Set all default attributes
    this.birthdate = new Date(200, 1, 1, 12, 0);
    this.gender = 1;
    this.first_name = "Jane";
    this.last_name = "Doe";

    this.stats = {};
    for (const stat of setup.STATS) {
        this.stats[stat] = 0;
        if (randomize) {
            this.stats[stat] += dice(1, cap);
        }
    }

    // Conditions such as health and stamina
    this.conditions = {};
    for (const condition of setup.CONDITIONS) {
        this.conditions["max_" + condition] = 70;
        if (randomize) {
            this.conditions["max_" + condition] += dice(1, cap);
        }
        this.conditions[condition] = this.conditions["max_" + condition];
    }

    // Skills
    this.skills = {};
    for (const skill of setup.SKILLS) {
        this.skills[skill] = 0;
        if (randomize) {
            this.skills[skill] += dice(1, cap);
        }
    }

    // Mental conditions such as anger addiction (things that grow and wane over time)
    this.mental_conditions = {};
    for (const condition of setup.MENTAL_CONDITIONS) {
        this.mental_conditions[condition] = 0;
    }

    // Physical conditions
    this.physical_conditions = {};
    for (const condition of setup.PHYSICAL_CONDITIONS) {
        this.physical_conditions[condition] = 0;
    }

    this.slave_traits = {};
    for (const slave_trait of setup.SLAVE_TRAITS) {
        this.slave_traits[slave_trait] = 0;
    }
    // Start off as cold and completely dominant in willpower
    this.slave_traits.obedience = 30;
    this.slave_traits.willpower = 100;

    this.physical_traits = {};
    for (const physical_trait of setup.PHYSICAL_TRAITS) {
        this.physical_traits[physical_trait] = 0;
    }

    // Limits on what actions the player can do per day
    this.daily_limits = clone(setup.LIMITS);
    this.limits = clone(setup.LIMITS);

    // Setup sex-related traits
    this.sex_skills = {};
    for(const sex_skill of setup.SEX_SKILLS) {
        this.sex_skills[sex_skill] = 0;
        if (randomize) {
            this.sex_skills[sex_skill] += dice(1, cap);
        }
    }
    // People generally like regular sex
    this.sex_prefs = {"vaginal": 10};
    for (const sex_pref of setup.SEX_PREFS) {
        if (sex_pref != "vaginal") {
            this.sex_prefs[sex_pref] = -50;
        }
        if (randomize) {
            this.sex_prefs[sex_pref] += parseInt(dice(1, cap) / 2);
        }
    }

    if (randomize) {
        this.is_virgin = (parseInt(dice(1, 2)) == 1);
        this.is_anal_virgin = (parseInt(dice(1, 2)) == 1);
    } else {
        this.is_virgin = true;
        this.is_anal_virgin = true;
    }


    this.sex_fetishes = {};
    for (const sex_fetish of setup.SEX_FETISHES) {
        this.sex_fetishes[sex_fetish] = 0;
        if (randomize) {
            this.sex_fetishes[sex_fetish] += parseInt(dice(1, cap) / 2);
        }
    }
    this.sex_ranges = {};
    for (const sex_range of setup.SEX_RANGES) {
        this.sex_ranges[sex_range] = 0;
    }

    this.flavor_text = "";
    this.titles = new Set();
    this.status = "unknown";
    
    this.is_slave = false;
    this.owner = null;

    // Knowledge about character
    this.stats_known = false;
    this.skills_known = false;
    this.sex_prefs_known = false;
    this.fetishes_known = false;

    // Assignment
    this.assignment = "none";

    // Diet
    this.diet = {
        "amount": "regular",
        "additives": "none"
    };

    // Equipment
    this.equipment = {
        "head": "none",
        "chest": "none",
        "legs": "none",
        "feet": "none",
        "neck": "none",
        "weapon1": "none",
        "weapon2": "none",
        "groin1": "none",
        "groin2": "none"
    }

    if (key instanceof String || typeof key === 'string') {
        this.key = key;
    } else {
        // The input is a dictionary and output of evaluation of JSON.stringify()
        for (var _key in key) {
            if (this[_key] != null && this[_key].constructor == Object) {
                this[_key] = setup.mergeDeep(this[_key], JSON.parse(key[_key]));
            } else {
                this[_key] = JSON.parse(key[_key]);
            }
        }
    }  
}

Object.defineProperty(setup.Character.prototype, "clone", {
    enumerable: false,
    value: function() {
        var ret = new setup.Character(this.key);
        for (var _key in this) {
            ret[_key] = clone(this[_key]);
        }
        return ret;
    }
});

Object.defineProperty(setup.Character.prototype, "toJSON", {
    enumerable: false,
    value: function() {
        var body = "{";
        for (var _key in this) {
            body += ("\"" + _key + "\": \"" + JSON.stringify(this[_key]).replaceAll("\"", "\\\"")) + "\",";
        }
        body += "}";
        return JSON.reviveWrapper("new setup.Character(" + body + ")");
    }
});

Object.defineProperty(setup.Character.prototype, "set_properties", {
    enumerable: false,
    value: function(birthdate, gender, first_name, last_name, is_slave=false, owner=null) {
        this.birthdate = birthdate;
        this.gender = gender;
        this.first_name = first_name;
        this.last_name = last_name;
        this.is_slave = is_slave;
        this.owner = owner;
    }
});

Object.defineProperty(setup.Character.prototype, "reset_limits", {
    enumerable: false,
    value: function() {
        this.limits = clone(this.daily_limits);
    }
});

Object.defineProperty(setup.Character.prototype, "age", {
    enumerable: false,
    value: function() {
        var cur_date = State.variables.gameDate;
        var age = cur_date.getFullYear() - this.birthdate.getFullYear();
        var m = cur_date.getMonth() - this.birthdate.getMonth();
        if (m < 0 || (m === 0 && cur_date.getDate() < this.birthdate.getDate())) {
            age--;
        }
        return age;
    }
});

Object.defineProperty(setup.Character.prototype, "name", {
    enumerable: false,
    value: function() {
        return setup.titleCase(this.first_name) + " " + setup.titleCase(this.last_name);
    }
});

Object.defineProperty(setup.Character.prototype, "get_status", {
    enumerable: false,
    value: function(location=null) {
        if (this.key == "player") {
            if (location == null) {
                location = passage();
            }
            return setup.locations.get_extern_recur_attrib(location, State.variables.location_status);
        } else {
            return this.status;
        }
    }
});

// Gets a property of slave and applies status change on it
Object.defineProperty(setup.Character.prototype, "get_status_prop", {
    enumerable: false,
    value: function(key, pass=null) {
        var status = this.get_status(pass);
        var val = setup.get(this, key);
        if (val == null) {
            return null;
        }

        var delta_val = setup.get(setup.statuses[status], key);
        if (delta_val == null) {
            return val;
        }
        return val + parseFloat(delta_val);
    }
});

Object.defineProperty(setup.Character.prototype, "get_descriptor", {
    enumerable: false,
    value: function(key, val=null) {
        if (val == null) {
            val = setup.get(this, key);
        }
        if (val == null) {
            return null;
        }
        return setup.get_descriptor(key, val);
    }
});

Object.defineProperty(setup.Character.prototype, "toString", {
    enumerable: false,
    value: function(verbose=false) {
        const g = this.gender;
        var ret = "<b>" + this.name() + "</b> is a " + this.age() + " year old " +
            this.get_descriptor("gender") + " <em>" + setup.titleCase(this.get_status()) + "</em>"; 
        if (this.is_slave) {
            ret += " owned by " + setup.titleCase(this.owner);
        }
        ret += ". " + 
            setup.titleCase(setup.PRONOUNS[g]["?his"]) + " face is " + 
            this.get_descriptor("beauty") + ", sporting a " + this.get_descriptor("weight") +
            " frame at " + setup.get(this, "height") + "cm. ";
        ret += setup.titleCase(setup.PRONOUNS[g]["?he"]) + " is " + this.get_descriptor("obedience") +
            " towards you and is " + this.get_descriptor("trust") + " of you. Just glancing at " + 
            setup.PRONOUNS[g]["?him"] + " you can tell " + setup.PRONOUNS[g]["?his"] + " willpower is " + 
            this.get_descriptor("willpower") + ". "
        if (this.mental_conditions.anger > 0) {
            ret += setup.titleCase(setup.PRONOUNS[g]["?he"]) + " is currently upset at you";
            if (this.illness > 0) {
                ret += ", and is ill";
            }
            ret += "."
        } else if (this.mental_conditions.sadness > 0) {
            ret += setup.titleCase(setup.PRONOUNS[g]["?he"]) + " is currently sad";
            if (this.illness > 0) {
                ret += ", and is ill";
            }
            ret += ".";
        }
        if (verbose) {
            ret += "<br><br>";
            ret += setup.titleCase(setup.PRONOUNS[g]["?he"]) + " is " + 
                this.get_descriptor("education_flavor_text", this.skills.education) + ". ";

            if (this.sex_prefs_known) {
            } else {
                ret += setup.titleCase(setup.PRONOUNS[g]["?his"]) + " sexual preferences are " +
                    "currently unknown to you.";
            }
        }

        return ret;
    }
});

Object.defineProperty(setup.Character.prototype, "dialogue", {
    enumerable: false,
    value: function(dialogue) {
        return "<em><b>" + this.first_name + "</b>: \"" + dialogue.trim() + "\"</em><br>";
    }
});

Object.defineProperty(setup.Character.prototype, "get_money", {
    enumerable: false,
    value: function() {
        if (this.key == "player") {
            return setup.round2(UInv.BagHasItem("inventory", "lari") + UInv.BagHasItem("inventory", "tetri") / 100);
        } else {
            return -1;
        }
    }
});

Object.defineProperty(setup.Character.prototype, "image_folder", {
    enumerable: false,
    value: function() {
        return "resources/images/characters/" + this.first_name.toLowerCase() + "/";
    }
});

// Used for determining emotion to display in image
Object.defineProperty(setup.Character.prototype, "get_disposition", {
    enumerable: false,
    value: function() {
        if (this.mental_conditions.anger > 0) {
            return "hateful";
        } else if (this.mental_conditions.sadness > 0 || this.mental_conditions.illness > 0) {
            return "sad";
        }

        var willpower = this.get_descriptor("willpower");
        var obedience = this.get_descriptor("obedience");
        var trust = this.get_descriptor("trust");
        if (willpower == "completely submissive" || willpower == "very submissive") {
            return "submissive";
        } else if (obedience == "devoted" || obedience == "loving") {
            return "devoted";
        } else if (trust == "terrified" || trust == "scared") {
            return "scared";
        } else if (obedience == "friendly" || obedience == "warm") {
            return "warm";
        } else if (obedience == "ambivalent") {
            return "neutral";
        } else if (obedience == "cold" || obedience == "disliking") {
            return "cold";
        } else if (obedience == "hateful") {
            return "hateful";
        }
    }
});

Object.defineProperty(setup.Character.prototype, "get_disposition_text", {
    enumerable: false,
    value: function() {
        if (this.mental_conditions.anger > 0) {
            return "is currently <span style=\'text: red\'>angry</span> at you."
        } else if (this.mental_conditions.sadness > 0 || this.mental_conditions.illness > 0) {
            return "is currently sad.";
        }

        var willpower = this.get_descriptor("willpower");
        var obedience = this.get_descriptor("obedience");
        var trust = this.get_descriptor("trust");
        if (willpower == "completely submissive" || willpower == "very submissive") {
            return "is submissive to you.";
        } else if (obedience == "devoted" || obedience == "loving") {
            return "is devoted to you.";
        } else if (trust == "terrified" || trust == "scared") {
            return "is scared of you.";
        } else if (obedience == "friendly" || obedience == "warm") {
            return "is warm towards you.";
        } else if (obedience == "ambivalent") {
            return "is neutral towards you.";
        } else if (obedience == "cold" || obedience == "disliking") {
            return "is cold to you.";
        } else if (obedience == "hateful") {
            return "is hateful of you.";
        }
    }
});

Object.defineProperty(setup.Character.prototype, "sex_value", {
    enumerable: false,
    value: function() {
        var value = this.physical_traits.beauty;

        for(const sex_skill of setup.SEX_SKILLS) {
            value += this.sex_skills[sex_skill];
        }

        for (const sex_pref of setup.SEX_PREFS) {
            value += this.sex_prefs[sex_pref] / 3;
        }

        for (const sex_fetish of setup.SEX_FETISHES) {
            value += this.sex_fetishes[sex_fetish] / 5;
        }
        return value;
    }
});

Object.defineProperty(setup.Character.prototype, "has_equipped", {
    enumerable: false,
    value: function(item) {
        for (let key in this.equipment) {
            if (this.equipment[key] == item) {
                return key;
            }
        }
        return "none";
    }
});
/* twine-user-script #3: "LocationNode.js" */
/* LocationNode object which defines the locations in game in a tree-structure */ 

setup.LocationNode = function(key) {
    // Declare default values first
    // Children of node
    this.sublocations = {};
    // Key of parent
    this.parent = null;

    // Music associated with location
    this.music = null;
    // Passage associated with location, only for leaf-nodes
    this.passage = null;
    // Name of the location
    this.name = null;

    // When this location is open to player
    // [lower bound hour, upper bound hour]
    this.access_times = [0, 24]

    // Adjacency list of distances
    this.distance = {};

    // Whether or not it's inside
    this.inside = false;

    if (key instanceof String || typeof key === 'string') {
        this.key = key;
    } else {
        // The input is a dictionary and output of evaluation of JSON.stringify()
        for (var _key in key) {
            if (_key != "sublocations") {
                this[_key] = key[_key];
            }
        }

        this.sublocations = {};
        for (var _sublocation in key.sublocations) {
            var temp = new setup.LocationNode(key.sublocations[_sublocation]);
            this.sublocations[_sublocation] = temp;
        }
    }  
}

Object.defineProperty(setup.LocationNode.prototype, "clone", {
    enumerable: false,
    value: function() {
        var ret = new setup.LocationNode(this.key);
        for (var _key in this) {
            if (_key != "sublocations") {
                ret[_key] = this[_key];
            }
        }
    
        for (var _key in this.sublocations) {
            var temp = this.sublocations[_key].clone();
            ret.sublocations[_key] = temp;
        }
    
        return ret;
    }
});

Object.defineProperty(setup.LocationNode.prototype, "toJSON_helper", {
    enumerable: false,
    value: function() {
        var body = "{";
        for (var _key in this) {
            if (_key != "sublocations") {
                if (typeof this[_key] === 'string' || this[_key] instanceof String) {
                    body += ("\"" + _key + "\":" + "\"" + this[_key] + "\"") + ",";
                } else if (Array.isArray(this[_key])) {
                    body += ("\"" + _key + "\":[" + this[_key]) + "],";
                } else if (typeof this[_key] === 'object') {
                    body += ("\"" + _key + "\":" + JSON.stringify(this[_key])) + ",";
                } else {
                    body += ("\"" + _key + "\":" + this[_key]) + ",";
                }
            }
        }
        body += "sublocations:{";
        for (var _key in this.sublocations) {
            body += "\"" + _key + "\":" + this.sublocations[_key].toJSON_helper() + ",";
        }
        body += "}}";
        return "new setup.LocationNode(" + body + ")";
    }
});

Object.defineProperty(setup.LocationNode.prototype, "toJSON", {
    enumerable: false,
    value: function() {
        return JSON.reviveWrapper(this.toJSON_helper());
    }
});

Object.defineProperty(setup.LocationNode.prototype, "get", {
    enumerable: false,
    value: function(key) {
        if (this.key == key) {
            return this;
        } else {
            for (var _key in this.sublocations) {
                var temp = this.sublocations[_key].get(key);
                if (temp != null) {
                    return temp;
                }
            }
            return null;
        }
    }
});


Object.defineProperty(setup.LocationNode.prototype, "has", {
    enumerable: false,
    value: function(key) {
        return this.get(key) != null;
    }
});

// Whether or not player has access
Object.defineProperty(setup.LocationNode.prototype, "has_access", {
    enumerable: false,
    value: function() {
        var gameDate = State.variables.gameDate;
        var ret = State.variables.has_access.has(this.key);
        if (this.access_times[1] < this.access_times[0]) {
            // Through the night
            ret &= (this.access_times[1] <= gameDate.getHours() || gameDate.getHours() <= this.access_times[0]);
        } else {
            ret &= (this.access_times[0] <= gameDate.getHours() && gameDate.getHours() <= this.access_times[1]);
        }
        return ret;
    }
});

Object.defineProperty(setup.LocationNode.prototype, "add_sublocation", {
    enumerable: false,
    value: function(key) {
        var temp = new setup.LocationNode(key);
        temp.parent = this.key;
        this.sublocations[key] = temp;
    }
});

// Get's value of attribute of node key. If null then get's parent (recursively)
// effectively allows inhereted attributes in tree structure
Object.defineProperty(setup.LocationNode.prototype, "get_recur_attrib", {
    enumerable: false,
    value: function(key, attr) {
        if (this.key == key) {
            if (!(attr in this) || this[attr] == null) {
                return "FLAG: NONE";
            }
            return this[attr];
        } else {
            for (var _key in this.sublocations) {
                var temp = this.sublocations[_key].get_recur_attrib(key, attr);
                if (temp != null) {
                    if (temp == "FLAG: NONE") {
                        return (attr in this && this[attr] == null) ? temp : this[attr];
                    } else {
                        return temp;
                    }
                }
            }
            return null;
        }
    }
});

Object.defineProperty(setup.LocationNode.prototype, "get_extern_recur_attrib", {
    enumerable: false,
    value: function(key, dict) {
        if (this.key == key) {
            if (!(this.key in dict) || dict[this.key] == null) {
                return "FLAG: NONE";
            }
            return dict[this.key];
        } else {
            for (var _key in this.sublocations) {
                var temp = this.sublocations[_key].get_extern_recur_attrib(key, dict);
                if (temp != null) {
                    if (temp == "FLAG: NONE") {
                        return (!(this.key in dict) || (this.key in dict && dict[this.key] == null)) ? temp : dict[this.key];
                    } else {
                        return temp;
                    }
                }
            }
            return null;
        }
    }
});

// Get the value of attribute from head to key in reverse order
Object.defineProperty(setup.LocationNode.prototype, "get_path_attrib", {
    enumerable: false,
    value: function(key, attr) {
        if (this.key == key) {
            return [this[attr]];
        } else {
            for (var _key in this.sublocations) {
                var temp = this.sublocations[_key].get_path_attrib(key, attr);
                if (temp != null) {
                    temp.push(this[attr]);
                    return temp;
                }
            }
            return null;
        }
    }
});

Object.defineProperty(setup.LocationNode.prototype, "get_sub_address", {
    enumerable: false,
    value: function(key) {
        var names = this.get_path_attrib(key, "name");
        var ret = "";
        for (var _i = 1; _i < names.length; _i++) {
            if (names[_i] != null) {
                ret += names[_i];
                break;
            }
        }
        for (var _j = _i + 1; _j < names.length; _j++) {
            if (names[_j] != null) {
                ret += ", " + names[_j];
            }
        }
        return ret;
    }
});

Object.defineProperty(setup.LocationNode.prototype, "get_full_address", {
    enumerable: false,
    value: function(key) {
        var names = this.get_path_attrib(key, "name");
        var ret = "";
        for (var _i = 0; _i < names.length; _i++) {
            if (names[_i] != null) {
                ret += names[_i];
                break;
            }
        }
        for (var _j = _i + 1; _j < names.length; _j++) {
            if (names[_j] != null) {
                ret += ", " + names[_j];
            }
        }
        return ret;
    }
});

Object.defineProperty(setup.LocationNode.prototype, "toString", {
    enumerable: false,
    value: function() {
        var ret = this.key + " ("
        for (var _key in this.sublocations) {
            ret += this.sublocations[_key].toString();
        }
        ret += ")"
        return ret;
    }
});

// Adds artificial weight to potential connection between two nodes (doesn't add true edge)
Object.defineProperty(setup.LocationNode.prototype, "add_distance", {
    enumerable: false,
    value: function(key1, key2, dist) {
        var loc1 = this.get(key1);
        var loc2 = this.get(key2);
        if (loc1 != null && loc2 != null) {
            loc1.distance[loc2.key] = dist;
            loc2.distance[loc1.key] = dist;
        }
    }
});


Object.defineProperty(setup.LocationNode.prototype, "goto", {
    enumerable: false,
    value: function(play_sound=null) {
        // If passage doesn't exist go to WIP
        if (tale.has(this.passage)) {
            // Add time if it exists
            if (passage() in this.distance) {
                var dist = this.distance[passage()];
                var mins = parseInt(dist + setup.randint(0, parseInt(dist / 4)) + 1);
                $.wiki("<<addmins " + mins + ">>");
            }

            // Play sound
            if (play_sound != null) {
                $.wiki("<<audio " + play_sound + " play>>");
            }
            // Go to passage
            Engine.play(this.passage);
        } else {
            State.variables.last_visited = passage();
            State.variables.in_menu = true;
            $.wiki("<<saveVars>>");
            Engine.play("WIPMenu");
        }
    }
});
/* twine-user-script #4: "UniversalInventorySystem.js" */
/*
	Universal Inventory System (UInv)
	by HiEv                    v0.9.7.2

	A JavaScript inventory "plugin" for Twine 2 / SugarCube 2.

	Home Page: https://github.com/HiEv/UInv

	v0.5.7 - March 29, 2018 - (preview release 1)
		- 62 functions written out of 108 planned functions
	v0.6.9 - April 6, 2018 - (preview release 2)
		- 28 new functions written + 23 new functions planned
		- some functions renamed to conform to consistent naming style
	v0.7.7 - April 18, 2018 - (preview release 3)
		- 32 new functions written + 27 new functions planned
		- some functions renamed to conform to consistent naming style
		- most previously incomplete functions are now complete
		- lots of debugging and additional error checking done
	v0.8.6 - April 24, 2018 - (preview release 4)
		- 25 new functions written + 13 new functions planned
		- some functions renamed to conform to consistent naming style
		- work on help file started (very preliminary)
	v0.9.1 - May 10, 2018 - (preview release 5)
		- 18 new functions written + 11 new functions planned
		- added default bags
		- major rework of engine to allow deletion of default properties
		- some bugs fixed
	v0.9.2 - May 23, 2018 - (preview release 6)
		- 10 new functions written + 8 new functions planned
		- renamed BagCount to GetBagCount for more consistent naming style
		- moved data sections to bottom to make updating UInv easier
		- some bugs fixed
		- Item Builder added to UInv help file
	v0.9.4 - July 8, 2018 - (preview release 7)
		- 22 new functions written + 19 new functions planned
		- some functions renamed to conform to consistent naming style
		- centralized more functions for display utilities
		- saved a bit more memory/history size
		- handled a potential problem with non-static default properties
		- improved compatibility with other browsers
		- moved utility functions inside UInv namespace
	v0.9.5 - July 23, 2018 - (preview release 8)
		- 12 new functions written + 12 new functions planned
		- revamped error handling to add thrown errors
		- added utility functions for engine detection
		- saved a bit more memory/history size
		- major restructuring of item data
		- added handling of variable items and variable bags
	v0.9.6 - September 25, 2018 - (preview release 9)
		- 31 new functions written + 27 new functions planned
		- major bugfix in SwapItems and many "Tag" functions
		- all utility function names now start lowercase
		- added the ability to cache images for online usage
		- the UInv Safe Save Code has been updated (see help)
		- added option for sending UInv errors to console
		- typing "xyzzy" now toggles console (F12) error log
		- began implementation of display elements
			* table
			* radialMenu
		- began implementation of event handlers
			"general" events:
				* MouseDown
				* MouseUp
			"bag" events:
				* Touched
			"table" events:
				* Accept
				* DragStart
				* Drop
				* DragStop
			"radialMenu" events:
				* Open
				* WedgeClick
				* DisabledWedgeClick
				* Cancel
			"cacheImages" events:
				* Loaded
				* Error
		- added Font Awesome support: https://fontawesome.com/free
		  just add the following line to your stylesheet section:
@import url('https://use.fontawesome.com/releases/v5.3.1/css/all.css');
		  see the "FA_Icons.html" sample for the list of icons
		- jQuery UI is now required to support display elements
		  https://api.jqueryui.com/category/all/
		  just include and load the jquery-ui.css and jquery-ui.js
		  files, along with the "images/ui-*.png" images
	v0.9.7 - December 29, 2018 - (preview release 10)
		- 40 new functions written (including 2 macros) + 38 new functions planned
		- added Pocket/Container functions; items can now contain other items
		- updated existing functions to work with pockets properly
		- updated more functions to support bag name arrays
		- added a <<UInvSet>> macro to shorten calls to multiple UInv functions
		- added a <<UInvTry>> macro to simplify error handling in TwineScript
		- added more ways to add default items to default bags
		- default return value on error was standardized to "undefined"
		- enforced stricter verification of values for item names (must be lowercase, etc...)
		- removed LockUpdates function; use IncrementUpdateLock and DecrementUpdateLock instead
		- removed capitalizeFirstLetter function; use SugarCube's .toUpperFirst() instead
		- discovered a function I wrote and apparently forgot to document anywhere (LOL)
		- renamed the following functions to conform to consistent naming style (aliases added):
			* ArrayHasAllBagProperties to BagHasAllProperties
			* ArrayHasAllItemProperties to ItemHasAllProperties
			* GetBagArrayWithAllProperties to GetBagsArrayWithAllProperties (added an "s")
			* GetHighestBagPropertyValue to GetBagWithHighestPropertyValue
			* GetHighestItemPropertyValue to GetItemWithHighestPropertyValue
			* GetLowestBagPropertyValue to GetBagWithLowestPropertyValue
			* GetLowestItemPropertyValue to GetItemWithLowestPropertyValue
			* SetItemsPropertyValues to SetItemsPropertyValue (removed an "s")
			* UpdateItemProperties to SetItemPropertyValues
		- fixes/improvements to valuesAreEqual, arraysAreEqual, and objectsAreEqual
		- corrected two minor inefficiencies in memory/history usage
		- fixed a few incorrect function names in error messages
		- fixed a problem with items changed to variable type still using default properties
		- fixed a problem where variable type items might not merge when they should
		- fixed GetBagWithHighestPropertyValue and GetBagWithLowestPropertyValue functions
		- fixed a bug in BagHasAllProperties
		- preliminary work on unit/regression testing tool (37 functions fully tested)
		- property values may now be set to "undefined"
		- new/updated general help file sections:
			* Changelog
			* Function Cheat Sheet
			* Basic UInv Functions (incomplete)
			* Error Handling (incomplete)
			* Efficient UInv Coding
			* Arrays vs Generic Objects (major improvements; incomplete)
			* The UInv Data Structure
		- worked on how help file entries should look for UInv functions (see "AddBag")
		- modified UInv structure to support internal-use-only functions and variables
			* this means you'll need to insert your bag, item, and alias definitions this update
		- Over 10,000 non-blank lines of code and comments!  Yay for arbitrary milestones!
	v0.9.7.1 (bugfix) - September 7, 2019 - (preview release 11)
		- 7 new functions written + 5 new functions planned
		- added support for Set and Map objects; UInv now supports all of SugarCube's supported types
		- added an "Idle" event to the "cacheImages" events.
		- fixed a problem the image cache had with some browsers
		- fixed a couple of bugs in the event handler code
			* note: this required some minor changes to the CSS generated for tables
			* Table Builder updated to accomodate CSS changes
		- added another bit of sample code to the UInv_Sample_Code.html file
		- another update to the "UInv Safe Save Code" in the UInv help file
		- numerous help file updates and fixes
	v0.9.7.2 - September 9, 2019 - (preview release 12)
		- 4 new functions written
		- added some missing date, map, and set support
		- added missing documentation for new utility functions to help file
*/

/*
	The next two comments block are to support JavaScript validators such as:
		https://eslint.org/demo/
		http://JSHint.com/
		https://deepscan.io/demo/
		http://beautifytools.com/javascript-validator.php
*/
/* jshint -W014 */
/*
	global UInv, $, setup, clone, opr, safari, Config, Browser, State,
	random, passage, window, document, navigator, alert, console, Image,
	setTimeout, Macro, Scripting, version
*/

/* Increase SugarCube maxLoopIterations if needed. */
if (Config.macros.maxLoopIterations < 2000) {
	Config.macros.maxLoopIterations = 2000;
}

if (setup.ImagePath === undefined) {  /* Do this better later *** */
	setup.ImagePath = "";
}

/* -- Universal Inventory System (UInv) -- */

/* UInvObject: UInv constructor and initialization object. */
function UInvObject () {

	if ((typeof version == "undefined") || (typeof version.title == "undefined") || (version.title != "SugarCube")
		|| (typeof version.major == "undefined") || (version.major < 2)
		|| (typeof version.minor == "undefined") || (version.minor < 8)) {
		throw new Error("UInv requires SugarCube v2.8.0 or greater.  Please upgrade to the latest version of the SugarCube v2 story format");
	}

	/* deepFreeze: Freeze everything in an object's property tree. */
	function deepFreeze (Obj) {
		var value, name, i, propNames = Object.getOwnPropertyNames(Obj);
		/* Freeze the object's child properties before freezing the object. */
		for (i = 0; i < propNames.length; i++) {
			name = propNames[i];
			value = Obj[name];
			Obj[name] = value && typeof value === "object" ? deepFreeze(value) : value;  /* Recursively handle sub-properties, if any exist. */
		}
		return Object.freeze(Obj);
	}

	/* parseUInvLine: Returns a string with "UInv." added in front of any UInv function names in the Txt string, provided that:
			* they're a valid UInv function name (including aliases)
			* they're preceded by a " ", tab, ",", "+", "-", "/", "*", "%", "=", "<", ">", "!", "&", "|", "?", "(", "[", "{", or ":"
			* they're immediately followed by a "(" (the left parenthesis)
			* they're not within a string (within a pair of single or double-quotes)
	*/
	function parseUInvLine (TxtIn) {
		var Prec = [" ", "	", ",", "+", "-", "/", "*", "%", "=", "<", ">", "!", "&", "|", "?", "(", "[", "{", ":"];
		var Group = ["'", '"'];
		TxtIn = TxtIn.trim();
		var TxtOut = "", Word = "", Prv = "+", n = 0, g = -1;
		while (n < TxtIn.length) {
			if (g < 0) {
				if (TxtIn[n] == "(") {
					if (Prec.includes(Prv) && (UInv.isFunction(UInv[Word]) || UInv.isProperty(UInv, Word))) {
						TxtOut += "UInv." + Word;
					} else {
						TxtOut += Word;
					}
					Word = "";
				}
				if (Prec.includes(TxtIn[n])) {
					TxtOut += Word + TxtIn[n];
					Prv = TxtIn[n];
					Word = "";
				} else if (Group.includes(TxtIn[n])) {
					g = Group.indexOf(TxtIn[n]);
					TxtOut += Word;
					Word = TxtIn[n];
				} else {
					Word += TxtIn[n];
				}
			} else {
				Word += TxtIn[n];
				if (TxtIn[n] == Group[g]) {
					Prv = Group[g];
					g = -1;
					TxtOut += Word;
					Word = "";
				}
			}
			n++;
		}
		TxtOut += Word;
		return TxtOut;
	}

	/* Lock the existing property values to prevent accidental changes. */
	deepFreeze(this);

	/* Debugging Feature: Enables directing errors to the console by typing "xyzzy". */
	var UInvDebugTrigger = "";
	$(document).on("keypress", function (ev) {
		UInvDebugTrigger += ev.key;
		if (UInvDebugTrigger.length > 5) {
			UInvDebugTrigger = UInvDebugTrigger.slice(-5);
		}
		if (UInvDebugTrigger === "xyzzy") {
			if (UInv.isUndefined(setup.UInvUserAlertsDebug)) {
				setup.UInvUserAlertsBackup = UInv.GetUserAlerts();
				UInv.SetUserAlerts(UInv.ERROR_SHOW_PASSAGE_NAME + UInv.ERROR_TO_CONSOLE);
				setup.UInvUserAlertsDebug = UInv.ERROR_SHOW_PASSAGE_NAME + UInv.ERROR_TO_CONSOLE;
				alert("UInv: Errors will now be shown in the console window.\nHit F12 to open the console window.");
				console.log("UInv: Error logging enabled.\n$UInvLastErrorMessage = " + State.variables.UInvLastErrorMessage);
			} else {
				UInv.SetUserAlerts(setup.UInvUserAlertsBackup);
				delete setup.UInvUserAlertsBackup;
				console.log("UInv: Error logging reverted to default. (" + setup.UInvUserAlertsDebug + ")");
				alert("UInv: Error logging reverted to default. (" + setup.UInvUserAlertsDebug + ")");
				delete setup.UInvUserAlertsDebug;
			}
		}
	});

	/* Automatically link up UInv display elements when passage is rendered. */
	$(document).on(":passagerender", function (ev) {
		if (!UInv.UpdatesAreLocked()) {
			UInv.UpdateDisplay(ev.content);
		}

		var el = $("#uinv-radial-menu").get(0);
		if (UInv.isUndefined(el)) {
			UInv.InitializeRadialMenu();
		} else {
			if (el.dataset.status == "opened") {  /* Cancel radial menu */
				ev.cancelType = "NewPassage";
				var Ret = UInv.CallEventHandler("radialMenu", "Cancel", ev);  /* radialMenu Cancel event (New passage) */
				if (Ret.keepOpen !== true) {
					el.dataset.status = "closed";
					el.style.transform = "scale(0, 0)";
					el.style.opacity = 0;
				}
				UInv.UpdateDisplay();
			}
		}

		/* Textarea cursor fix for Chrome & Firefox. */
		$(ev.content).find("textarea").mousemove(function (e) {
			var myPos = $(this).offset();
			myPos.bottom = $(this).offset().top + $(this).outerHeight();
			myPos.right = $(this).offset().left + $(this).outerWidth();
			if (myPos.right > e.pageX && e.pageX > myPos.right - 16) {
				if (myPos.bottom > e.pageY && e.pageY > myPos.bottom - 16) {
					if ($(this).css("cursor") != "ns-resize") {
						$(this).css("cursor", "ns-resize");  /* Chrome fix */
					}
				} else {
					if ($(this).prop("clientHeight") < $(this).prop("scrollHeight")) {
						if ($(this).css("cursor") != "default") {
							$(this).css("cursor", "default");  /* Firefox fix */
						}
					} else {
						if ($(this).css("cursor") != "auto") {
							$(this).css("cursor", "auto");
						}
					}
				}
			} else {
				if ($(this).css("cursor") != "auto") {
					$(this).css("cursor", "auto");
				}
			}
		});

	});

	/* <<UInvSet>> macro: This macro wraps each line in <<set (line)>>, adds "UInv." in front of any UInv function calls (including custom aliases), and executes it. */
	/* Usage:
			<<UInvSet>>
				AddBag("backpack")
				AddItem("", "pants")
				SetItemQuantity("", "", 5 + BagHasItem("", ""))
				_Items = GetType(_itemType)
			<</UInvSet>>
	*/
	Macro.add('UInvSet', {
		skipArgs : true,
		tags     : null,
		handler  : function () {
			var Lines = this.payload[0].contents.split("\n"), i, output = "";
			for (i = 0; i < Lines.length; i++) {
				Lines[i] = parseUInvLine(Lines[i]);
				if (Lines[i] != "") {
					output += "<<set " + Lines[i].trim() + ">>";
				}
			}
			$(this.output).wiki(output);
		}
	});

	/* <<UInvTry>> macro: This macro tries to execute a <<set>> macro, adding "UInv." in front of any UInv functions.  Failure is determined by whether or not UInv (or any other code) throws an error. */
	/*                    If it succeeds, the chunk of code between <<UInvTry>> and <<Failure>> will execute normally, and the code between <<Failure>> and <</UInvTry>> will *not* execute. */
	/*                    If there is an error, the chunk of code between <<Failure>> and <</UInvTry>> will execute normally, and the code between <<UInvTry>> and <<Failure>> will *not* execute. */
	/* Usage:
			<<UInvTry "AddBag('backpack')">>\
				Success!
			<<Fail>>\
				Failure: $UInvLastErrorMessage
			<</UInvTry>>\
	*/
	Macro.add('UInvTry', {
		skipArgs : false,
		tags     : ["Fail"],
		handler  : function () {
			if ((this.args.length < 1) || (!UInv.isString(this.args[0]))) {
				throw new Error("<<UInvTry>> macro needs a string of code as an argument to test.");
			}
			if (this.payload.length != 2) {
				throw new Error('<<UInvTry>> macro needs to be set up using the <<UInvTry "(code to try here)">>(success code here)<<Fail>>(failure code here)<</UInvTry>> format.');
			}
			var Action = "_UInvResult = " + parseUInvLine(this.args[0]);
			try {
				var TmpErr = UInv.GetLastError(true);
				Scripting.evalTwineScript(Action);
				if (UInv.GetLastError() === "") {
					if (TmpErr) {
						State.variables.UInvLastErrorMessage = TmpErr;
					}
					/* Success */
					$(this.output).wiki(this.payload[0].contents);
				} else {
					/* Failure */
					$(this.output).wiki(this.payload[1].contents);
				}
			} catch(error) {
				/* Failure */
				State.variables.UInvLastErrorMessage = "SugarCube Error: " + error.message;
				$(this.output).wiki(this.payload[1].contents);
			}
		}
	});
}
UInvObject.prototype = (function () {

	/* UInv Private Functions:  (internal use only)
	   =======================

	   Error: Handle setting $UInvLastErrorMessage to the error string and possibly displaying UInv errors based on the value of $UInvShowAlerts.
	          This can be used for debugging and/or letting users know how to report this error.
	*/
	function UInvError (ErrStr) {
		var AlertMsg = "Error: " + ErrStr, Txt, GUA = UInv.GetUserAlerts();
		if (GUA) {
			if (GUA & UInv.ERROR_SHOW_PASSAGE_NAME) {  /* jshint ignore:line */
				Txt = 'Passage = "' + passage() + '"';
				AlertMsg += "\n" + Txt;
			}
			if (UInv.isProperty(State.variables, "UInvErrorStringAddendum")) {
				Txt = State.variables.UInvErrorStringAddendum;
				AlertMsg += "\n" + Txt;
			}
		}
		State.variables.UInvLastErrorMessage = AlertMsg;
		if (GUA & UInv.ERROR_SHOW_ALERT) {  /* jshint ignore:line */
			alert(AlertMsg);
		}
		if (GUA & UInv.ERROR_TO_CONSOLE) {  /* jshint ignore:line */
			console.log(AlertMsg);
		}
		if (GUA & UInv.ERROR_THROW_ERROR) {  /* jshint ignore:line */
			throw new Error("\nUInv " + State.variables.UInvLastErrorMessage);   /* This must be last because it exits the function here. */
		}
		return GUA;  /* Success */
	}

	/* FixBagName: Returns $UInvCurrentBagName if BagName === "", else returns BagName, or undefined on error. */
	function FixBagName (BagName) {
		if (UInv.isString(BagName)) {
			if ((BagName === "") && UInv.isString(UInv.GetCurrentBagName())) {
				return UInv.GetCurrentBagName();
			}
			return BagName;  /* Success */
		} else {
			UInvError('BagName passed to FixBagName is not a string.');  /* Error */
			return undefined;
		}
	}

	/* ValidateItemName: Returns validated ItemName or undefined on failure. */
	function ValidateItemName (ItemName) {
		if (UInv.isString(ItemName)) {
			var NewItemName = ItemName.toLowerCase();
			if (!UInv.ReservedBagProperties_LC.includes(NewItemName)) {
				return NewItemName;  /* Success */
			} else {
				return undefined;  /* Failure */
			}
		} else {
			return undefined;  /* Failure */
		}
	}

	/* FixItemName: Returns $UInvCurrentItemName if ItemName === "", else returns ItemName, or undefined on error. */
	function FixItemName (ItemName) {
		if (UInv.isString(ItemName)) {
			var NewItemName = ItemName.toLowerCase();  /* fix case since all item names are lowercase */
			if (!UInv.ReservedBagProperties_LC.includes(NewItemName)) {
				if ((NewItemName === "") && UInv.isString(UInv.GetCurrentItemName())) {  /* OOO function call */
					NewItemName = ValidateItemName(UInv.GetCurrentItemName());  /* OOO function call */
					if (NewItemName) {
						return NewItemName;  /* Success */
					} else {
						delete State.variables.UInvCurrentItemName;  /* delete invalid value */
						return "";  /* Success */
					}
				}
				return NewItemName;  /* Success */
			} else {
				UInvError('FixItemName failed.  Illegal item name "' + ItemName + '" used.');  /* Error */
				return undefined;
			}
		} else {
			UInvError('ItemName passed to FixItemName is not a string.');  /* Error */
			return undefined;
		}
	}

	function FixContainerReferences (OldBagName, OldItemName, NewBagName, NewItemName) {
		var PocketNames = UInv.GetItemPocketNameArray(NewBagName, NewItemName);
		if (PocketNames.length > 0) {
			var PocketBag, Containers, i, j;
			for (i = 0; i < PocketNames.length; i++) {  /* Update pockets' references to match the container's new bag and/or item name(s) */
				PocketBag = UInv.GetItemPocketBagName(NewBagName, NewItemName, PocketNames[i]);
				Containers = UInv.GetPocketBagContainerArray(PocketBag);
				for (j = 0; j < Containers.length; j++) {
					if ((Containers[j].ContainerBagName == OldBagName) && (Containers[j].ContainerName == OldItemName) && (Containers[j].PocketName == PocketNames[i])) {
						State.variables.UInvBags[PocketBag].UInvContainer[j].ContainerBagName = NewBagName;
						State.variables.UInvBags[PocketBag].UInvContainer[j].ContainerName = NewItemName;
					}
				}
			}
		}
		return true;  /* Success */
	}

	/* tryIntParse: Attempts to parse strings to integers if Value is a string, returns either a number or undefined if Value isn't a number. */
	/* !!NOTE!! - The return value from this function will not necessarily be an integer.  Values which are already numbers will be returned as-is. */
	function tryIntParse (Value) {
		if (UInv.isString(Value)) {
			if (UInv.isNumber(parseInt(Value, 10))) {
				Value = parseInt(Value, 10);
			}
		}
		if (UInv.isNumber(Value)) {
			return Value;  /* Success */
		}
		return undefined;  /* Unable to parse */
	}

	/* RemoveItemObjectsDefaultProperties: Removes all default properties from Obj.  Returns true on success or undefined on error. */
	/* !!!IMPORTANT!!! - The object passed to this function is directly modified by this function.  Do not pass objects that shouldn't be modified!!! */
	function RemoveItemObjectsDefaultProperties (Obj, DefaultItemType) {
		if (UInv.isGenericObject(Obj)) {
			if (UInv.isString(DefaultItemType)) {
				var DefItem = UInv.GetDefaultItemObject(DefaultItemType);
				if (DefItem) {  /* Delete all properties that are equal to GetDefaultItemObject properties of DefaultItemType. */
					var DefKeys = Object.keys(DefItem), i;
					if ((DefKeys.length > 0) && (!DefKeys.includes("UInvVariableType"))) {
						for (i = 0; i < DefKeys.length; i++) {
							if (!["UInvPocket", "UInvQuantity"].includes(DefKeys[i])) {
								if (UInv.isProperty(Obj, DefKeys[i])) {
									if (UInv.valuesAreEqual(Obj[DefKeys[i]], DefItem[DefKeys[i]])) {  /* OOO function call. (OOO = Out Of Order, meaning that function exists in the code below, instead of above.) */
										delete Obj[DefKeys[i]];  /* Matches default value of GetDefaultItemObject version. */
									}
								}
							}
						}
					}
				}
				return true;  /* Success */
			} else {
				UInvError('DefaultItemType passed to RemoveItemObjectsDefaultProperties is not a string.');  /* Error */
				return undefined;
			}
		} else {
			UInvError('RemoveItemObjectsDefaultProperties failed. Obj is not a generic object.');  /* Error */
			return undefined;
		}
	}

	return {

	/* UInv Public Functions: */
	/* ====================== */

		/* UInv Constructor: */
		/* ================= */

		constructor : UInvObject,

		/* UInv Constants: */
		/* =============== */

		/* Values for UInvMergeItemMethod and UInv.SetMergeItemMethod to determine how UInv handles item collision. */
		MERGE_USE_ONLY_DESTINATION_PROPERTIES : 1,  /* Ignore source properties, just increment destination's quantity. (default) */
		MERGE_USE_ONLY_SOURCE_PROPERTIES : 2,       /* Delete the destination's properties, replace with the source's properties and values, and increment the quantity. */
		MERGE_PREFER_DESTINATION_PROPERTIES : 3,    /* Keep the properties and values in the destination, add any properties and values the source had but the destination didn't, and increment the quantity. */
		MERGE_PREFER_SOURCE_PROPERTIES : 4,         /* Keep the properties and values in the source, add any properties and values the destination had but source the didn't, and increment the quantity. */
		MERGE_RENAME_SOURCE_ITEMNAME : 5,           /* Rename the source's unique identifier so that it's stored separately in the destination bag. */
		MERGE_FAIL_WITH_ERROR : 6,                  /* Fail with an error. */

		/* Values for $UInvShowAlerts, used with SetUserAlerts.  Values can be added together except for ERROR_NONE. */
		ERROR_NONE : false,           /* Do not display any error messages to users. */
		ERROR_SHOW_PASSAGE_NAME : 1,  /* Displays the current passage name in any error messages. */
		ERROR_SHOW_ALERT : 2,         /* Displays a modal dialog box for each error message and pauses execution. */
		ERROR_THROW_ERROR : 4,        /* Throws traditional Twine/SugarCube error messages, instead of silently returning a value which indicates that a UInv error occurred. */
		ERROR_TO_CONSOLE : 8,         /* Outputs any error messages to the console window. */

		/* AP style says that positive integers less than 10 should be written as text.  This array converts values zero through nine a text.  (e.g. UInv.NumText[5] === "five") */
		NumText : ["zero", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"],  /* Used in Display functions. */
		/* AP style says that ordinals from one through nine should be written as text.  This array converts values one through nine to text.  (e.g. UInv.OrdinalText[5] === "fifth") */
		OrdinalText : ["0th", "first", "second", "third", "fourth", "fifth", "sixth", "seventh", "eighth", "ninth"],  /* do not use 0 */
		OrdinalSuffix : ["th", "st", "nd", "rd", "th", "th", "th", "th", "th", "th"],

		/* The default maximum number of images to cache. */
		DefaultMaxCache : 100,
		/* The default maximum number of images to download at the same time using the image cache code. */
		DefaultMaxConcurrent : 5,

		/* Reserved property names within bags. */
		ReservedBagProperties : ["", "-", "UInvTouched", "UInvProperties", "UInvDefaultBagType", "UInvContainer"],
		ReservedBagProperties_LC : ["", "-", "uinvtouched", "uinvproperties", "uinvdefaultbagtype", "uinvcontainer"],  /* lowercase version */
		/* Reserved property names within items. */
		ReservedItemProperties : ["UInvQuantity", "UInvDefaultItemType", "UInvVariableType", "UInvPocket", "UInvCell"],

		/* This is the maximum pocket depth allowed on default items or bags to prevent accidental infinite recursion or exponential explosions. */
		MaximumPocketDepth : 3,


		/* UInv Utility Functions: */
		/* ======================= */

		/* isArray: Returns if a value is an array. */
		isArray : function (Value) {
			return Array.isArray(Value);
		},

		/* isBoolean: Returns if a value is a boolean. */
		isBoolean : function (Value) {
			return typeof Value === "boolean";
		},

		/* isDate: Returns if value is a date object. */
		isDate : function (Value) {
			return UInv.isObject(Value) && Value instanceof Date;
		},

		/* isFunction: Returns if a value is a function. */
		isFunction : function (Value) {
			return typeof Value === "function";
		},

		/* isGenericObject: Returns if a value is a generic object. */
		isGenericObject : function (Value) {
			return UInv.isObject(Value) && Value.constructor === Object;
		},

		/* isInteger: Returns if a value is an integer. */
		isInteger : function (Value) {
			return Number.isInteger(Value);
		},

		/* isMap: Returns if a value is a map. */
		isMap : function (Value) {
			return UInv.isObject(Value) && Value instanceof Map;
		},

		/* isNumber: Returns if a value is a number. */
		isNumber : function (Value) {
			return typeof Value === "number" && Number.isFinite(Value);
		},

		/* isObject: Returns if a value is an object. */
		isObject : function (Value) {
			return !!Value && typeof Value === "object";
		},

		/* isProperty: Returns if Prop is a property of the object Obj. */
		isProperty : function (Obj, Prop) {
			if (UInv.isObject(Obj)) {
				return Obj ? hasOwnProperty.call(Obj, Prop) : false;
			}
			return false;
		},

		/* Returns if a value is a regexp. */
		isRegExp : function (Value) {
			return UInv.isObject(Value) && Value.constructor === RegExp;
		},

		/* isSet: Returns if a value is a set. */
		isSet : function (Value) {
			return UInv.isObject(Value) && Value instanceof Set;
		},

		/* isString: Returns if a value is a string. */
		isString : function (Value) {
			return typeof Value === "string" || Value instanceof String;
		},

		/* isUndefined: Returns if a value is undefined. */
		isUndefined : function (Value) {
			return typeof Value === "undefined";
		},

		/* spread: Returns a Map, Set, or String converted to an array.  If the second parameter is an Array, Map, Set, or String, then the two objects are spread and returned as a single array.
				   If a function is passed as the second parameter, this calls the function with the spread array as parameters and returns that function's value. */
		spread : function (Value, Funct) {
			var arr = [];
			if (UInv.isArray(Value)) {
				arr = clone(Value);
			} else if (UInv.isMap(Value)) {
				/* eslint-disable-next-line no-unused-vars */
				Value.forEach(function(val, key, map) {
					arr.push([key, val]);
				});
			} else if (UInv.isSet(Value)) {
				/* eslint-disable-next-line no-unused-vars */
				Value.forEach(function(val, key, set) {
					arr.push(val);
				});
			} else if (UInv.isString(Value)) {
				arr = Value.split('');
			}
			if (UInv.isFunction(Funct)) {
				return Funct.apply(null, arr);
			} else if (UInv.isObject(Funct)) {
				arr = arr.concat(UInv.spread(Funct));
			}
			return arr;
		},

		/* arraysAreEqual: Check two arrays to see if they're identical.  IgnoreObjectPairs is for internal use to prevent infinite loops of objects. */
		arraysAreEqual : function (Array1, Array2, IgnoreObjectPairs) {
			if (UInv.isArray(Array1) && UInv.isArray(Array2)) {
				var i = 0;
				if (UInv.isUndefined(IgnoreObjectPairs)) {
					IgnoreObjectPairs = [];
				}
				if (IgnoreObjectPairs.length > 0) {
					for (i = 0; i < IgnoreObjectPairs.length; i++) {
						if (((IgnoreObjectPairs[i][0] === Array1) && (IgnoreObjectPairs[i][1] === Array2)) ||
							((IgnoreObjectPairs[i][0] === Array2) && (IgnoreObjectPairs[i][1] === Array1))) {
								return true;  /* Ignores object pairs that have already been checked to prevent infinite loops. */
						}
					}
				}
				IgnoreObjectPairs.push([Array1, Array2]);
				if (Array1.length !== Array2.length) {
					return false;  /* Arrays are not the same length. */
				}
				if (Array1.length > 0) {
					for (i = 0; i < Array1.length; i++) {
						if (!UInv.valuesAreEqual(Array1[i], Array2[i], IgnoreObjectPairs)) {  /* OOO function call. */
							return false;  /* Values or types do not match. */
						}
					}
				}
				return true;  /* All values match. */
			}
			return false;  /* Both are not arrays. */
		},

		/* mapsAreEqual: Returns if two maps contain the same values in the same order.  IgnoreObjectPairs is for internal use to prevent infinite loops of objects. */
		mapsAreEqual : function (Map1, Map2, IgnoreObjectPairs) {
			if (UInv.isMap(Map1) && UInv.isMap(Map2)) {
				if (Map1.size === Map2.size) {
					if (UInv.isUndefined(IgnoreObjectPairs)) {
						IgnoreObjectPairs = [];
					}
					if (IgnoreObjectPairs.length > 0) {
						for (var i = 0; i < IgnoreObjectPairs.length; i++) {
							if (((IgnoreObjectPairs[i][0] === Map1) && (IgnoreObjectPairs[i][1] === Map2)) ||
								((IgnoreObjectPairs[i][0] === Map2) && (IgnoreObjectPairs[i][1] === Map1))) {
									return true;  /* Ignores object pairs that have already been checked to prevent infinite loops. */
							}
						}
					}
					IgnoreObjectPairs.push([Map1, Map2]);
					var a = UInv.spread(Map1), b = UInv.spread(Map2);
					return UInv.arraysAreEqual(a, b, IgnoreObjectPairs);  /* Compares maps. */
				}
			}
			return false;  /* Both are either not maps or are maps of different sizes. */
		},

		/* objectsAreEqual: Check two objects to see if they're identical.  IgnoreObjectPairs is for internal use to prevent infinite loops of objects. */
		objectsAreEqual : function (Obj1, Obj2, IgnoreObjectPairs) {
			if (UInv.isObject(Obj1) && UInv.isObject(Obj2)) {
				var i = 0;
				if (UInv.isUndefined(IgnoreObjectPairs)) {
					IgnoreObjectPairs = [];
				}
				if (IgnoreObjectPairs.length > 0) {
					for (i = 0; i < IgnoreObjectPairs.length; i++) {
						if (((IgnoreObjectPairs[i][0] === Obj1) && (IgnoreObjectPairs[i][1] === Obj2)) ||
							((IgnoreObjectPairs[i][0] === Obj2) && (IgnoreObjectPairs[i][1] === Obj1))) {
								return true;  /* Ignores object pairs that have already been checked to prevent infinite loops. */
						}
					}
				}
				IgnoreObjectPairs.push([Obj1, Obj2]);
				if (UInv.isGenericObject(Obj1) && UInv.isGenericObject(Obj2)) {
					var Keys1 = Object.keys(Obj1).sort(), Keys2 = Object.keys(Obj2).sort();
					if (!UInv.arraysAreEqual(Keys1, Keys2)) {
						return false;  /* Objects have a different number of keys or have different keys. */
					}
					if (Keys1.length > 0) {
						var Key;
						for (i = 0; i < Keys1.length; i++) {
							Key = Keys1[i];
							if (!UInv.valuesAreEqual(Obj1[Key], Obj2[Key], IgnoreObjectPairs)) {  /* OOO function call. */
								return false;  /* Values do not match. */
							}
						}
					}
					return true;  /* All values match. */
				} else {
					return UInv.valuesAreEqual(Obj1, Obj2, IgnoreObjectPairs);  /* Return whether objects match. OOO function call. */
				}
			}
			return false;  /* Both are not objects. */
		},

		/* setsAreEqual: Returns if two sets contain the same values in the same order.  IgnoreObjectPairs is for internal use to prevent infinite loops of objects. */
		setsAreEqual : function (Set1, Set2, IgnoreObjectPairs) {
			if (UInv.isSet(Set1) && UInv.isSet(Set2)) {
				if (Set1.size === Set2.size) {
					if (UInv.isUndefined(IgnoreObjectPairs)) {
						IgnoreObjectPairs = [];
					}
					if (IgnoreObjectPairs.length > 0) {
						for (var i = 0; i < IgnoreObjectPairs.length; i++) {
							if (((IgnoreObjectPairs[i][0] === Set1) && (IgnoreObjectPairs[i][1] === Set2)) ||
								((IgnoreObjectPairs[i][0] === Set2) && (IgnoreObjectPairs[i][1] === Set1))) {
									return true;  /* Ignores object pairs that have already been checked to prevent infinite loops. */
							}
						}
					}
					IgnoreObjectPairs.push([Set1, Set2]);
					var a = UInv.spread(Set1), b = UInv.spread(Set2);
					return UInv.arraysAreEqual(a, b, IgnoreObjectPairs);  /* Compares sets. */
				}
			}
			return false;  /* Both are either not sets or are sets of different sizes. */
		},

		/* setsMatch: Returns if two sets contain matches for all values in any order. */
		setsMatch : function (Set1, Set2) {
			if (UInv.isSet(Set1) && UInv.isSet(Set2)) {
				if (Set1.size === Set2.size) {
					if (Set1.size > 0) {  /* Compare sets. */
						var setIterator = Set1.values();
						var result = setIterator.next();
						while (!result.done) {
							if (!Set2.has(result.value)) return false;  /* Sets do not match. */
							result = setIterator.next();
						}
					}
					return true;  /* Sets match. */
				}
			}
		},

		/* valuesAreEqual: Check two variables to see if they're identical.  This function does not support comparing symbols, functions, or custom types. */
		/*                 IgnoreObjectPairs is for internal use to prevent infinite loops of objects. */
		valuesAreEqual : function (Var1, Var2, IgnoreObjectPairs) {
			if (typeof Var1 === typeof Var2) {
				switch (typeof Var1) {
					/* String */
					case "string":
					/* Number */
					case "number":
					/* Boolean */
					case "boolean":
						return Var1 === Var2;  /* Returns whether variables are equal or not. */
					/* Undefined */
					case "undefined":
						return true;  /* Variables are both undefined. */
					/* Object */
					case "object":
						/* Array Object */
						if (UInv.isArray(Var1) && UInv.isArray(Var2)) {
							return UInv.arraysAreEqual(Var1, Var2, IgnoreObjectPairs);  /* Return whether arrays are equal. */
						/* Generic Object */
						} else if (UInv.isGenericObject(Var1) && UInv.isGenericObject(Var2)) {
							return UInv.objectsAreEqual(Var1, Var2, IgnoreObjectPairs);  /* Return whether generic objects are equal. */
						/* Date Object */
						} else if (UInv.isDate(Var1) && UInv.isDate(Var2)) {
							return (Var1 - Var2) == 0;  /* Returns whether dates are equal. */
						/* Map Object */
						} else if (UInv.isMap(Var1) && UInv.isMap(Var2)) {
							return UInv.mapsAreEqual(Var1, Var2, IgnoreObjectPairs);  /* Return whether maps are equal. */
						/* Set Object */
						} else if (UInv.isSet(Var1) && UInv.isSet(Var2)) {
							return UInv.setsAreEqual(Var1, Var2, IgnoreObjectPairs);  /* Return whether sets are equal. */
						/* Null Object */
						} else if ((Var1 === null) && (Var2 === null)) {
							return true;  /* Objects are both null. */
						}
						return false;  /* Objects either don't match or are of an unsupported type. */
					default:
						return false;  /* Unsupported type. */
				}
			} else {
				return false;  /* Variables are not of the same type. */
			}
		},

		/* arrayHasTag: Returns the number of times Tag is found in array, or undefined if there is an error. */
		arrayHasTag : function (Arr, Tag) {
			if (!UInv.isUndefined(Tag) && UInv.isArray(Arr)) {
				return Arr.count(Tag);
			} else {
				return undefined;  /* Error */
			}
		},

		/* arrayHasAllTags: Returns true if Array1 has an equal or greater number of all tags in TagArray, or undefined if there is an error. */
		arrayHasAllTags : function (Arr, TagArray) {
			if (UInv.isArray(Arr) && UInv.isArray(TagArray)) {
				if (TagArray.length > 0) {
					if (Arr.length >= TagArray.length) {
						var i = 0;
						for (i = 0; i < TagArray.length; i++) {
							if (Arr.count(TagArray[i]) < TagArray.count(TagArray[i])) {
								return false;
							}
						}
					} else {
						return false;  /* Array1 can't have enough tags to satisfy test. */
					}
					return true;
				} else {
					return false;  /* TagArray is empty. */
				}
			} else {
				return undefined;  /* Error */
			}
		},

		/* arrayHasAnyTag: Returns true if Array1 has at least one of the tags in TagArray, or undefined if there is an error. */
		arrayHasAnyTag : function (Arr, TagArray) {
			if (UInv.isArray(Arr) && UInv.isArray(TagArray)) {
				if (TagArray.length > 0) {
					var i = 0;
					for (i = 0; i < TagArray.length; i++) {
						if (Arr.includes(TagArray[i])) {
							return true;
						}
					}
					return false;
				} else {
					return false;  /* TagArray is empty */
				}
			} else {
				return undefined;  /* Error */
			}
		},

		/* isArrayOfType: Test an array to see if all the values in the array are of one type. */
		isArrayOfType : function (Arr, Type) {
			if (UInv.isArray(Arr)) {
				var i = 0;
				if (Arr.length) {
					var funct;
					Type = Type.toLowerCase();
					switch (Type) {
						case "array":
							funct = UInv.isArray;
							break;
						case "boolean":
							funct = UInv.isBoolean;
							break;
						case "date":
							funct = UInv.isBoolean;
							break;
						case "generic object":
							funct = UInv.isGenericObject;
							break;
						case "integer":
							funct = UInv.isInteger;
							break;
						case "map":
							funct = UInv.isMap;
							break;
						case "number":
							funct = UInv.isNumber;
							break;
						case "object":
							funct = UInv.isObject;
							break;
						case "set":
							funct = UInv.isSet;
							break;
						case "string":
							funct = UInv.isString;
							break;
						default:
							return undefined;  /* Error: Unknown type */
					}
					for (i = 0; i < Arr.length; i++) {
						if (!funct(Arr[i])) {
							return false;  /* Array is not all of that type */
						}
					}
					return true;  /* Array is all of that type */
				}
				return false;  /* Array is empty */
			} else {
				return undefined;  /* Error: Not an array */
			}
		},

		/* isArrayOfArrays: Test an array to see if all the values are arrays. */
		isArrayOfArrays : function (Arr) {
			return UInv.isArrayOfType(Arr, "array");
		},

		/* isArrayOfBooleans: Test an array to see if all the values are booleans. */
		isArrayOfBooleans : function (Arr) {
			return UInv.isArrayOfType(Arr, "boolean");
		},

		/* isArrayOfDates: Test an array to see if all the values are dates. */
		isArrayOfDates : function (Arr) {
			return UInv.isArrayOfType(Arr, "date");
		},

		/* isArrayOfGenericObjects: Test an array to see if all the values are generic objects. */
		isArrayOfGenericObjects : function (Arr) {
			return UInv.isArrayOfType(Arr, "generic object");
		},

		/* isArrayOfIntegers: Test an array to see if all the values are integers. */
		isArrayOfIntegers : function (Arr) {
			return UInv.isArrayOfType(Arr, "integer");
		},

		/* isArrayOfMaps: Test an array to see if all the values are maps. */
		isArrayOfMaps : function (Arr) {
			return UInv.isArrayOfType(Arr, "map");
		},

		/* isArrayOfNumbers: Test an array to see if all the values are numbers. */
		isArrayOfNumbers : function (Arr) {
			return UInv.isArrayOfType(Arr, "number");
		},

		/* isArrayOfObjects: Test an array to see if all the values are objects. */
		isArrayOfObjects : function (Arr) {
			return UInv.isArrayOfType(Arr, "object");
		},

		/* isArrayOfSets: Test an array to see if all the values are sets. */
		isArrayOfSets : function (Arr) {
			return UInv.isArrayOfType(Arr, "set");
		},

		/* isArrayOfStrings: Test an array to see if all the values are strings. */
		isArrayOfStrings : function (Arr) {
			return UInv.isArrayOfType(Arr, "string");
		},

		/* combineGenericObjects: Returns a new object that has the combined properties of Obj1 and Obj2, with Obj2's properties preferred when both objects have matching property names. */
		combineGenericObjects : function (Obj1, Obj2) {
			if (UInv.isGenericObject(Obj1) && UInv.isGenericObject(Obj2)) {
				var Result = clone(Obj1), i, Keys = Object.keys(Obj2);
				for (i = 0; i < Keys.length; i++) {
					if (UInv.isObject(Obj2[Keys[i]])) {
						Result[Keys[i]] = clone(Obj2[Keys[i]]);
					} else {
						Result[Keys[i]] = Obj2[Keys[i]];
					}
				}
				return Result;  /* Success */
			} else {
				return undefined;  /* Error: Not generic objects */
			}
		},

		/* getUniqueArray: Returns an array so that all elements of the original array are now unique, or undefined on error. */
		getUniqueArray : function (Arr) {
			if (UInv.isArray(Arr)) {
				var hash = {};
				Arr.forEach( function (value) { hash[value + '::' + typeof value] = value; } );
				return Object.keys(hash).map( function (value) { return hash[value]; } );
			} else {
				return undefined;  /* Error: Not an array */
			}
		},

		/* getArraySortedByOtherArray: Returns UnsortedArray sorted based on ArrayToSortBy and subsorted by UnsortedArray value.  This is a case insensitive sort. */
		/*                             If RemoveDuplicates is true, it also removes any elements where its pair is duplicated in both arrays. */
		getArraySortedByOtherArray : function (UnsortedArray, ArrayToSortBy, RemoveDuplicates) {

			function GreaterThan(A, B) {
				if (UInv.isString(A)) {
					A = A.toLowerCase();
				}
				if (UInv.isString(B)) {
					B = B.toLowerCase();
				}
				return A > B;
			}

			if (UInv.isArray(UnsortedArray) && UInv.isArray(ArrayToSortBy)) {
				if (UnsortedArray.length === ArrayToSortBy.length) {
					var UA = clone(UnsortedArray), ATSB = clone(ArrayToSortBy);
					if (UA.length > 1) {
						var i = 0, j = 0, n = 0, temp, length = ATSB.length, done = true;
						for (i = 0; i < length / 2; i++) {  /* improved cocktail shaker sort with subsorting by unsorted array */
							done = true;
							for (j = i; j < length - i - 1; j++) {
								if (GreaterThan(ATSB[j], ATSB[j + 1]) || ((ATSB[j] === ATSB[j + 1]) && GreaterThan(UA[j], UA[j + 1]))) {
									temp = ATSB[j];
									ATSB[j] = ATSB[j + 1];
									ATSB[j + 1] = temp;
									temp = UA[j];
									UA[j] = UA[j + 1];
									UA[j + 1] = temp;
									done = false;
								}
								n = length - j - 1;
								if (GreaterThan(ATSB[n - 1], ATSB[n]) || ((ATSB[n - 1] === ATSB[n]) && GreaterThan(UA[n - 1], UA[n]))) {
									temp = ATSB[n];
									ATSB[n] = ATSB[n - 1];
									ATSB[n - 1] = temp;
									temp = UA[n];
									UA[n] = UA[n - 1];
									UA[n - 1] = temp;
									done = false;
								}
							}
							if (done) {
								break;
							}
						}
						if (RemoveDuplicates) {
							i = 0;
							while (i < ATSB.length - 1) {
								if ((ATSB[i] === ATSB[i+1]) && (UA[i] === UA[i+1])) {
									ATSB.deleteAt(i);
									UA.deleteAt(i);
								} else {
									++i;
								}
							}
						}
					}
					return UA;  /* Success */
				}
			}
			return undefined;  /* Error - one or both of the first two parameters were not arrays */
		},

		/* getArrayReverseSortedByOtherArray: Returns UnsortedArray reverse sorted based on ArrayToSortBy and subsorted by UnsortedArray value.  This is a case insensitive sort. */
		/*                                    If RemoveDuplicates is true, it also removes any elements where its pair is duplicated in both arrays. */
		getArrayReverseSortedByOtherArray : function (UnsortedArray, ArrayToSortBy, RemoveDuplicates) {

			function GreaterThan(A, B) {
				if (UInv.isString(A)) {
					A = A.toLowerCase();
				}
				if (UInv.isString(B)) {
					B = B.toLowerCase();
				}
				return A > B;
			}

			function LessThan(A, B) {
				if (UInv.isString(A)) {
					A = A.toLowerCase();
				}
				if (UInv.isString(B)) {
					B = B.toLowerCase();
				}
				return A < B;
			}

			if (UInv.isArray(UnsortedArray) && UInv.isArray(ArrayToSortBy)) {
				if (UnsortedArray.length === ArrayToSortBy.length) {
					var UA = clone(UnsortedArray), ATSB = clone(ArrayToSortBy);
					if (UA.length > 1) {
						var i = 0, j = 0, n = 0, temp, length = ATSB.length, done = true;
						for (i = 0; i < length / 2; i++) {  /* improved cocktail shaker sort with subsorting by unsorted array */
							done = true;
							for (j = i; j < length - i - 1; j++) {
								if (LessThan(ATSB[j], ATSB[j + 1]) || ((ATSB[j] === ATSB[j + 1]) && GreaterThan(UA[j], UA[j + 1]))) {
									temp = ATSB[j];
									ATSB[j] = ATSB[j + 1];
									ATSB[j + 1] = temp;
									temp = UA[j];
									UA[j] = UA[j + 1];
									UA[j + 1] = temp;
									done = false;
								}
								n = length - j - 1;
								if (LessThan(ATSB[n - 1], ATSB[n]) || ((ATSB[n - 1] === ATSB[n]) && GreaterThan(UA[n - 1], UA[n]))) {
									temp = ATSB[n];
									ATSB[n] = ATSB[n - 1];
									ATSB[n - 1] = temp;
									temp = UA[n];
									UA[n] = UA[n - 1];
									UA[n - 1] = temp;
									done = false;
								}
							}
							if (done) {
								break;
							}
						}
						if (RemoveDuplicates) {
							i = 0;
							while (i < ATSB.length - 1) {
								if ((ATSB[i] === ATSB[i+1]) && (UA[i] === UA[i+1])) {
									ATSB.deleteAt(i);
									UA.deleteAt(i);
								} else {
									++i;
								}
							}
						}
					}
					return UA;  /* Success */
				}
			}
			return undefined;  /* Error - one or both of the first two parameters were not arrays */
		},

		/* arrayObjectIncludes: Searches an array for generic objects with a property of ObjProperty that == Value. */
		/*                      Returns true if it finds any matches, false when unable to find any matches, and undefined on error. */
		arrayObjectIncludes : function (Arr, ObjProperty, Value) {
			if (UInv.isArray(Arr)) {
				if (Arr.length == 0) {
					return false;  /* Success - empty array */
				}
				if (UInv.isString(ObjProperty)) {
					if (arguments.length >= 3) {
						var i;
						for (i = 0; i < Arr.length; i++) {
							if (UInv.isGenericObject(Arr[i])) {
								if (UInv.isProperty(Arr[i], ObjProperty)) {
									if (Arr[i][ObjProperty] == Value) {
										return true;  /* Success - found match */
									}
								}
							}
						}
					} else {
						return undefined;  /* Error */
					}
				} else {
					return undefined;  /* Error */
				}
			} else {
				return undefined;  /* Error */
			}
			return false;  /* Success - value not found */
		},

		/* integerToOrdinal: Converts an integer to an ordinal string (e.g. "first", "20th", etc...). */
		/*                   Options = "NoOrdinalText", "UseSuperscript", and/or "Capitalize" */
		integerToOrdinal : function (Value, Options) {
			if (UInv.isInteger(Value)) {
				if (UInv.isString(Options)) {  /* turn string into an array of strings */
					Options = [ Options ];
				}
				if (!UInv.isArrayOfStrings(Options)) {  /* turn invalid Options parameter values into an empty array */
					Options = [];
				}
				var i;
				for (i = 0; i < Options.length; i++) {  /* convert any options to lowercase */
					Options[i] = Options[i].toLowerCase();
				}
				if ((!Options.includes("noordinaltext")) && (Value < 10) && (Value > 0)) {
					Value = UInv.OrdinalText[Value];  /* convert number to ordinal text, (e.g. 2 -> second) */
					if (Options.includes("capitalize")) {
						Value = Value.toUpperFirst();
					}
					return Value;
				} else {
					Value = Value.toLocaleString();  /* add commas or local variant */
					var Ending = Value.substring(Value.length - 2), Suffix;
					if (["11", "12", "13"].includes(Ending)) {  /* handle exceptions */
						Suffix = "th";
					} else {
						if (Ending.length > 1) {
							Ending = Ending.substring(1);
							Suffix = UInv.OrdinalSuffix[parseInt(Ending, 10)];  /* get correct suffix */
						}
					}
					if (Options.includes("usesuperscript")) {
						Suffix = "<sup>" + Suffix + "</sup>";  /* make suffix superscripted */
					}
					return Value + Suffix;  /* Success */
				}
			}
			return Value;  /* Does not change non-integers */
		},

		/* numberToAPString: Converts a number to a string that conforms to basic AP writing style guidelines. */
		/*                   For exceptions see: https://writingexplained.org/ap-style/ap-style-numbers */
		numberToAPString : function (Value) {
			function TrimEnd(Val) {
				if (Val.slice(-3) == ".00") {
					Val = Val.slice(0, -3);
				} else if (Val.slice(-1) == "0") {
					Val = Val.slice(0, -1);
				}
				return Val;
			}

			if (UInv.isNumber(Value)) {
				if (Number.isInteger(Value) && (Value < 10) && (Value >= 0)) {
					return UInv.NumText[Value];  /* convert number to number name */
				} else {  /* add "just over", "just under", "about", or "approximately"?  *** */
					if (Value >= Math.pow(10, 15)) {  /* 1 quadrillion */
						return TrimEnd((Value / Math.pow(10, 15)).toFixed(2)) + " quadrillion";
					} else if (Value >= Math.pow(10, 12)) {  /* 1 trillion */
						return TrimEnd((Value / Math.pow(10, 12)).toFixed(2)) + " trillion";
					} else if (Value >= Math.pow(10, 9)) {  /* 1 trillion */
						return TrimEnd((Value / Math.pow(10, 9)).toFixed(2)) + " billion";
					} else if (Value >= Math.pow(10, 6)) {  /* 1 trillion */
						return TrimEnd((Value / Math.pow(10, 6)).toFixed(2)) + " million";
					} else {
						/* return Value.toLocaleString( undefined, { maximumFractionDigits : 2 } );  /* add commas or local variant */
						Value = (Math.round(Value * 100) / 100);  /* Android workaround for not supporting toLocaleString's options parameter */
						return Value.toLocaleString();  /* add commas or local variant */
					}
				}
			}
			return Value;  /* Does not change non-numbers */
		},

		/* addArticle: Returns "a " or "an " followed by the string passed in, based on the first word passed to it.
			If "Caps" isn't set then it will "steal" any capitalization from the first word (e.g. "Hour" returns "An hour").
			If "Caps" is set to "true" then "a"/"an" will be capitalized and "WordIn" will be unchanged (e.g. "Tuesday" returns "A Tuesday").
			If "Caps" is set to "false" then "a"/"an" will be lowercase and "WordIn" will be unchanged (e.g. "Friday" returns "a Friday").
			You should use the "Caps" parameter when the word is a proper noun.
			If the first word starts with more than one capital letter it will be treated as an initialism (e.g. "FBI agent" returns "an FBI agent").
			If the word is an acronym instead of an initialism you should set "Acronym" to "true" to get the correct result (e.g. "FUBAR situation" returns "a FUBAR situation").
		*/
		addArticle : function (WordIn, Caps, Acronym) {
			function CapsFix(start, wrd) {
				if (initialism) {
					if (Caps === true) {
						return start.toUpperFirst() + " " + wrd;
					} else {
						return start + " " + wrd;
					}
				} else {
					if (Caps === true) {
						return start.toUpperFirst() + " " + wrd;
					} else if (Caps === false) {
						return start.toLowerCase() + " " + wrd;
					} else {
						if (ucase) {
							return start.toUpperFirst() + " " + wrd.charAt(0).toLowerCase() + wrd.substring(1, wrd.length);
						} else {
							return start.toLowerCase() + " " + wrd;
						}
					}
				}
			}

			if (!UInv.isString(WordIn)) {
				UInvError('addArticle failed. WordIn parameter is ' + UInv.addArticle(typeof WordIn) +', instead of a string.');  /* Error */
				return undefined;
			}
			if (!UInv.isUndefined(Caps)) {
				Caps = !!Caps;
			}
			if (UInv.isUndefined(Acronym)) {
				Acronym = false;
			} else {
				Acronym = !!Acronym;
			}
			/* Add to this list if it's missing a word which starts with both a consonant sound and a vowel.  Words should be in all lowercase. */
			var acon = ["ewe", "ewer", "once", "one", "onesie", "ouabain", "ouija", "u", "u-boat", "ubiquity", "ufo", "ufologist", "ufology", "uganda", "ugandan", "ukelele", "ukraine", "ukrainian", "ulysses", "unanimity", "unary", "upsilon", "uranium", "uranus", "urea", "ureter", "urethra", "urinal", "urinalysis", "urine", "urology", "us-ian", "usability", "usage", "usanian", "use", "user", "using", "usual", "usurer", "usuress", "usurp", "usurper", "usurping", "usury", "utahn", "ute", "utensil", "uterus", "utile", "utilitarian", "utility", "utilities", "utopia", "uvula", "uvular"];
			/* Add to this list if it's missing a word which starts with both a vowel sound and a consonant.  Words should be in all lowercase. */
			var anvwl = ["8", "f", "h", "heir", "heired", "heiress", "heiring", "heirloom", "herb", "herbal", "herbicide", "herbicidal", "herbivore", "herbivorous", "honest", "honestly", "honesty", "honor", "honorable", "honorary", "honored", "honoree", "honorific", "honoring", "honour", "honourary", "honourable", "honoured", "honouree", "honourific", "honouring", "hour", "hourly", "hourglass", "l", "m", "m", "r", "s", "x"];
			/* Add to this list any words where, if it's the first word, no article need be added.  Words should be in all lowercase.  Typically those words will be possessive nouns (e.g. "joan's" or "james'"). */
			var aanskip = ["a", "an", "her", "his", "it", "its", "my", "our", "that", "the", "their", "this", "your"];
			var initialism = false, i;
			/* Find the first word or number. */
			var word = WordIn.trim();  /* Trim spaces. */
			i = word.search(/[a-z0-9]/i);
			if (i > 0) {
				word = word.substring(i);  /* Trim non-alphanumeric characters off the front. */
			}
			if (word == "") {  /* Nothing left to check, so just return WordIn. */
				return WordIn;
			}
			i = word.search(/[^a-z]/i);
			if (i != 0) {  /* Word starts with a letter. */
				i = word.search(/[A-Z]/);
				if (i == 0) {  /* First character is a capital letter. */
					i = word.substring(1).search(/[A-Z]/);
					if (word.length == 1) {  /* The only letter is capitalized, so assume it's an initial. */
						initialism = true;
					} else if (i == 0) {  /* The first two or more letters are capitalized, so assume it's an initialism or acronym. */
						initialism = true;
						if (Acronym) {
							i = word.search(/[^A-Z]/);
							if (i > 0) {
								word = word.substring(0, i);  /* Trim out all non-capital letters for acronyms. */
							}
						} else {
							word = word.substring(0, 1);  /* Just grab the first letter for initialisms. */
						}
					} else {  /* Mixed case word */
						i = word.substring(1).search(/[^a-z]/i);
						if (i >= 0) {
							word = word.substring(0, i + 1);  /* Trim out everything after the first non-letter. */
						}
						if (word.length == 1) {  /* The only letter is capitalized, so assume it's an initial. */
							initialism = true;
						}
					}
				} else {  /* First character is a lowercase letter. */
					i = word.substring(1).search(/[^a-z]/i);
					if (i >= 0) {
						word = word.substring(0, i + 1);  /* Trim out everything after the first non-letter. */
					}
				}
			} else {  /* Word starts with a number. */
				word = word.substring(0, 1);  /* Just grab the first number. */
			}
			if (word == "") {  /* Nothing left to check, so just return WordIn. */
				return WordIn;
			}
			if (aanskip.includes(word.toLowerCase())) {  /* Check to see if the starting word is already an article or a possessive pronoun. */
				return WordIn;
			}
			var ucase = /^[A-Z]/.test(word);  /* See if the article needs to be capitalized. */
			word = word.toLowerCase();  /* Convert word to lowercase. */
			/* Figure out if the word starts with a vowel or consonant sound. */
			if ((word.indexOf("uni") == 0) || (word.indexOf("eu") == 0)) {  /* Words that start with "eu" and "uni" should have "a" in front. */
				return CapsFix("a", WordIn);
			}
			if (/^[aeiou].*/i.test(word)) {  /* Word starts with a vowel. */
				for (i = 0; i < acon.length; ++i) {
					if (word.length <= 2) {  /* No pluralization tests for short words. */
						if (word == acon[i]) {
							return CapsFix("a", WordIn);  /* Word starts with a consonant sound. */
						}
					} else if ((word == acon[i]) || (word == acon[i] + "s") || (word == acon[i] + "es")) {  /* Word starts with a consonant sound (also checks against plural versions). */
						return CapsFix("a", WordIn);  /* Word starts with a consonant sound. */
					}
				}
				return CapsFix("an", WordIn);  /* Word starts with a vowel sound. */
			} else {  /* Word starts with a consonant. */
				for (i = 0; i < anvwl.length; ++i) {
					if (word.length <= 2) {  /* No pluralization tests for short words. */
						if (word == anvwl[i]) {
							return CapsFix("an", WordIn);  /* Word starts with a vowel sound. */
						}
					} else if ((word == anvwl[i]) || (word == anvwl[i] + "s") || (word == anvwl[i] + "es")) {  /* Word starts with a vowel sound (also checks against plural versions). */
						return CapsFix("an", WordIn);  /* Word starts with a vowel sound. */
					}
				}
			}
			return CapsFix("a", WordIn);  /* Word starts with a consonant sound. */
		},

		/* getRandomHexString: Returns a random hexidecimal string of 6 characters. */
		getRandomHexString : function () {
			var r = random(0, 255).toString(16), g = random(0, 255).toString(16), b = random(0, 255).toString(16);
			if (r.length === 1) {
				r = "0" + r;
			}
			if (g.length === 1) {
				g = "0" + g;
			}
			if (b.length === 1) {
				b = "0" + b;
			}
			return r + g + b;
		},

		/* getObjectProperties: Returns all of the properties and values of an object as a string.  Non-objects get returned unchanged. */
		getObjectProperties : function (Obj, Ext) {
			if (Ext === undefined) {
				Ext = "";
			} else {
				Ext += ".";
			}
			var Txt, i;
			if (UInv.isArray(Obj)) {
				Txt = "[ ";
				for (i = 0; i < Obj.length; i++) {
					if (UInv.isObject(Obj[i])) {
						Txt += UInv.getObjectProperties(Obj[i]);
					} else {
						if (UInv.isString(Obj[i])) {
							Txt += '"' + Obj[i] + '"';
						} else {
							Txt += Obj[i];
						}
						if (i < Obj.length - 1) {
							Txt += ", ";
						}
					}
				}
				if (Obj.length > 0) {
					Txt += " ]";
				} else {
					Txt += "]";
				}
				return Txt;
			} else if (UInv.isObject(Obj)) {
				var Keys = Object.keys(Obj).sort();  /* Sorted to make the output more consistent across browsers */
				Txt = "{ ";
				for (i = 0; i < Keys.length; i++) {
					if (UInv.isObject(Obj[Keys[i]])) {
						Txt += Ext + Keys[i] + " : " + UInv.getObjectProperties(Obj[Keys[i]], Ext + Keys[i]);
					} else {
						if (UInv.isString(Obj[Keys[i]])) {
							Txt += Ext + Keys[i] + ' = "' + Obj[Keys[i]] + '"';
						} else {
							Txt += Ext + Keys[i] + ' = ' + Obj[Keys[i]];
						}
					}
					if (i < Keys.length - 1) {
						Txt += ", ";
					}
				}
				if (Keys.length > 0) {
					Txt += " }";
				} else {
					Txt += "}";
				}
				return Txt;
			} else {
				return Obj;
			}
		},

		/* docHasCSSElement: If document has CSS element "CSSElement", returns the element's CSSStyleDeclaration object, otherwise returns "false". */
		docHasCSSElement : function (CSSElement) {
			var rules, i, j;
			for (i = 0; i < document.styleSheets.length; i++) {
				try {
					rules = document.styleSheets[i].rules;  /* This can throw an error sometimes. */
				} catch(e) {
					rules = undefined;  /* Error thrown */
				}
				if (rules === undefined) {  /* If .rules doesn't exist, try .cssRules */
					try {
						rules = document.styleSheets[i].cssRules;  /* This can throw an error sometimes. */
						if (rules === undefined) {
							rules = [];  /* Neither worked, so no rules. */
						}
					} catch(e) {
						rules = [];  /* Error thrown, so no rules. */
					}
				}
				for (j = 0; j < rules.length; j++) {
					if (rules[j].selectorText !== undefined) {
						if (typeof rules[j].selectorText == "string") {
							if (rules[j].selectorText == CSSElement) {  /* See if CSS selector matches CSSElement string. */
								return rules[j].style;  /* Success - found matching CSS selector. */
							}
						}
					}
				}
			}
			return false;  /* Success - no matching CSS selector found. */
		},

		/* initializeImageCache: Sets up setup.UInvImageCache for image caching. */
		initializeImageCache : function () {
			/* Set up image cache. */
			if (UInv.isUndefined(setup.UInvImageCache)) {
				setup.UInvImageCache = { loading: 0, complete: 0, loaded: 0, errors: 0, waiting: 0, total: 0, maxConcurrent: 5, maxCache: 100, images: [] };
			} else {
				if (UInv.isUndefined(setup.UInvImageCache.loading)) { setup.UInvImageCache.loading = 0; }
				if (UInv.isUndefined(setup.UInvImageCache.complete)) { setup.UInvImageCache.complete = 0; }
				if (UInv.isUndefined(setup.UInvImageCache.loaded)) { setup.UInvImageCache.loaded = 0; }
				if (UInv.isUndefined(setup.UInvImageCache.errors)) { setup.UInvImageCache.errors = 0; }
				if (UInv.isUndefined(setup.UInvImageCache.waiting)) { setup.UInvImageCache.waiting = 0; }
				if (UInv.isUndefined(setup.UInvImageCache.total)) { setup.UInvImageCache.total = 0; }
				if (UInv.isUndefined(setup.UInvImageCache.maxConcurrent)) { setup.UInvImageCache.maxConcurrent = 5; }
				if (UInv.isUndefined(setup.UInvImageCache.maxCache)) { setup.UInvImageCache.maxCache = 100; }
				if (UInv.isUndefined(setup.UInvImageCache.images)) { setup.UInvImageCache.images = []; }
			}
		},

		/* continueLoadingCache: Starts loading any waiting images if maxConcurrent images aren't already loading. */
		continueLoadingCache : function () {
			UInv.initializeImageCache();
			/* Retry loading errors?  Only when everything else is already loaded?  *** */
			if (setup.UInvImageCache.waiting > 0) {
				var Waiting = [], j;
				for (j = 0; j < setup.UInvImageCache.images.length; j++) {
					if (setup.UInvImageCache.images[j].status == "Waiting...") {
						Waiting.push(j);
					}
				}
				while (setup.UInvImageCache.loading < setup.UInvImageCache.maxConcurrent) {
					j = Waiting.shift();  /* Grab the index of the oldest waiting image */
					setup.UInvImageCache.loading++;
					setup.UInvImageCache.waiting--;
					setup.UInvImageCache.images[j].tries++;
					setup.UInvImageCache.images[j].status = "Loading...";
					setup.UInvImageCache.images[j].src = setup.UInvImageCache.images[j].URL;
				}
			}
			if (setup.UInvImageCache.loading == 0) {
				var ev = {};
				ev.complete = setup.UInvImageCache.complete;
				ev.loaded = setup.UInvImageCache.loaded;
				ev.errors = setup.UInvImageCache.errors;
				UInv.CallEventHandler("cacheImages", "Idle", ev);  /* cacheImages Idle event */
			}
		},

		/* flushCachedImages: Allows you to manually unload previously cached images. */
		flushCachedImages : function (Path, ImageName) {
			UInv.initializeImageCache();
			if (UInv.isString(Path)) {
				if (UInv.isString(ImageName)) {
					ImageName = [ImageName];
				}
				if (UInv.isArrayOfStrings(ImageName)) {
					if (UInv.isUndefined(setup.UInvImageCache)) {
						return true;  /* Success - No image cache existed */
					}
					var i, ndx;
					for (i = 0; i < ImageName.length; i++) {
						ndx = setup.UInvImageCache.map( function (obj) { return obj.URL; } ).indexOf(Path + ImageName[i]);
						if (ndx >=0) {
							setup.UInvImageCache.total--;
							$(setup.UInvImageCache.images[ndx]).off();  /* remove event handlers */
							setup.UInvImageCache.images[ndx].IgnoreEvents = true;  /* this should be redundant due to the .off() above */
							if (setup.UInvImageCache.images[ndx].status == "Waiting...") {
								setup.UInvImageCache.waiting--;
							} else if (setup.UInvImageCache[ndx].status == "Loading...") {
								setup.UInvImageCache.loading--;
								setup.UInvImageCache.images[ndx].src = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEAAAAALAAAAAABAAEAAAI=;";  /* transparent GIF to stop image loading */
							} else if (setup.UInvImageCache[ndx].status == "Loaded") {
								setup.UInvImageCache.complete--;
								setup.UInvImageCache.loaded--;
							} else if (setup.UInvImageCache[ndx].status == "Error") {
								setup.UInvImageCache.complete--;
								setup.UInvImageCache.errors--;
							}
							setup.UInvImageCache.deleteAt(ndx);
						}
					}
					UInv.continueLoadingCache();  /* trigger loading any waiting images up to maxConcurrent */
					return true;  /* Success */
				} else {
					UInvError('ImageName passed to flushCachedImages is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Path passed to flushCachedImages is not a string.');  /* Error */
				return undefined;
			}
		},

		/* flushAllCachedImages: Clears out all cached images.  Also lets you set the maximum number of images to cache (defaults to 100) and the */
		/*                       maximum number of images do download concurrently (defaults to 5).  Returns true on success and undefined on error. */
		flushAllCachedImages : function (MaxConcurrent, MaxCache) {
			UInv.initializeImageCache();
			if (UInv.isUndefined(MaxCache)) { MaxCache = UInv.DefaultMaxCache; }
			if (UInv.isUndefined(MaxConcurrent)) { MaxConcurrent = UInv.DefaultMaxConcurrent; }
			if (UInv.isString(MaxCache)) { MaxCache = parseInt(MaxCache, 10); }
			if (UInv.isString(MaxConcurrent)) { MaxConcurrent = parseInt(MaxConcurrent, 10); }
			if (UInv.isInteger(MaxCache)) {
				if (UInv.isInteger(MaxConcurrent)) {
					if (MaxCache < 10) { MaxCache = 10; }
					if (MaxConcurrent < 3) { MaxConcurrent = 3; }
					if (setup.UInvImageCache.images.length > 0) {
						var URLs = [], i;
						for (i = 0; i < setup.UInvImageCache.images.length; i++) {
							URLs.push(setup.UInvImageCache.images[i].URL);
						}
						UInv.flushCachedImages("", URLs);
					}
					setup.UInvImageCache = { loading: 0, complete: 0, loaded: 0, errors: 0, waiting: 0, total: 0, maxConcurrent: MaxConcurrent, maxCache: MaxCache, images: [] };
					var ev = {};
					ev.complete = setup.UInvImageCache.complete;
					ev.loaded = setup.UInvImageCache.loaded;
					ev.errors = setup.UInvImageCache.errors;
					UInv.CallEventHandler("cacheImages", "Idle", ev);  /* cacheImages Idle event */
					return true;  /* Success */
				} else {
					UInvError('MaxConcurrent passed to flushAllCachedImages is not an integer.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('MaxCache passed to flushAllCachedImages is not an integer.');  /* Error */
				return undefined;
			}
		},

		/* getCachedImageObject: Returns a copy of the cached image object.  This way you can access properties like .naturalWidth and .naturalHeight on it. */
		/*                       Returns "null" if image not in cache, or undefined on error. */
		getCachedImageObject : function (Path, ImageName) {
			UInv.initializeImageCache();
			if (UInv.isString(Path)) {
				if (UInv.isString(ImageName)) {
					var ndx = setup.UInvImageCache.images.map( function (obj) { return obj.URL; } ).indexOf(Path + ImageName);
					if (ndx >= 0) {
						return setup.UInvImageCache.images[ndx];  /* Success */
					} else {
						return null;  /* Success - Image not found in cache */
					}
				} else {
					UInvError('ImageName passed to getCachedImageObject is not a string.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Path passed to getCachedImageObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* cacheImages: Allows you to preload images.  You can use the handler to receive notifications about load or error events. */
		/*             NOTE: The cache gets flushed whenever the game is reloaded or restarted.  Do NOT depend on files to exist in the cache. */
		cacheImages : function (Path, ImageName, Handler) {

			function Loaded(event) {  /* eslint-disable-line */
				if (!this.IgnoreEvents) {
					this.status = "Loaded";
					setup.UInvImageCache.loading--;
					setup.UInvImageCache.complete++;
					setup.UInvImageCache.loaded++;
					event.URL = this.URL;
					event.path = this.path;
					event.filename = this.filename;
					event.tries = this.tries;
					event.src = this.src;
					if (UInv.isProperty(this, "imageGroup")) {
						event.imageGroup = this.imageGroup;
					}
					UInv.CallEventHandler("cacheImages", "Loaded", this);  /* cacheImages Loaded event */
					UInv.continueLoadingCache();  /* trigger loading any waiting images up to maxConcurrent */
				}
			}
			function Failure(event) {  /* eslint-disable-line */
				if (!this.IgnoreEvents) {
					this.status = "Error";
					setup.UInvImageCache.loading--;
					setup.UInvImageCache.complete++;
					setup.UInvImageCache.errors++;
					event.URL = this.URL;
					event.path = this.path;
					event.filename = this.filename;
					event.tries = this.tries;
					event.src = this.src;
					if (UInv.isProperty(this, "imageGroup")) {
						event.imageGroup = this.imageGroup;
					}
					var Ret = UInv.CallEventHandler("cacheImages", "Error", this);  /* cacheImages Error event */
					if (Ret.retryLoad !== true) {
						/* Error images are moved towards the start of the image cache so they get flushed first. */
						var x = setup.UInvImageCache.images.map( function (obj) { return obj.URL; } ).indexOf(this.URL);
						var img = setup.UInvImageCache.images.deleteAt(x)[0], n = 0;
						while ((n < setup.UInvImageCache.images.length) && (setup.UInvImageCache.images[n].status != "Error")) {
							n++;
						}
						setup.UInvImageCache.images.splice(setup.UInvImageCache.errors - 1, 0, img);
					} else {  /* Retry loading this image */
						setup.UInvImageCache.loading++;
						setup.UInvImageCache.complete--;
						setup.UInvImageCache.errors--;
						this.status = "Waiting...";
					}
					UInv.continueLoadingCache();  /* trigger loading any waiting images up to maxConcurrent */
				}
			}

			UInv.initializeImageCache();
			if (UInv.isString(Path)) {
				if (UInv.isString(ImageName)) {
					ImageName = [ImageName];
				}
				if (UInv.isArrayOfStrings(ImageName)) {
					if (UInv.isUndefined(setup.UInvImageCache)) {
						setup.UInvImageCache = { loading: 0, complete: 0, loaded: 0, errors: 0, waiting: 0, total: 0, maxConcurrent: UInv.DefaultMaxConcurrent, maxCache: UInv.DefaultMaxCache, images: [] };
					}
					var i = 0, j, done = false, image, ndx, uniqueID = "", HandlerIDs;
					if (UInv.isString(Handler) && (ImageName.length > 0)) {  /* create imageGroup for event handlers */
						uniqueID = "iGrp" + (++i);
						while (!done) {  /* look for existing matching handlers */
							HandlerIDs = UInv.GetMatchingEventHandlersArray("cacheImages", "Loaded", { imageGroup: uniqueID });  /* OOO function call */
							if (HandlerIDs.length > 0) {
								for (j = 0; j < HandlerIDs.length; ++j) {
									/* if (any HandlerIDs have a handler that == Handler) then use current uniqueID, otherwise uniqueID = "iGrp" + (++i); and try again */
									if (UInv.GetEventHandlerByID("cacheImages", "Loaded", HandlerIDs[j]).handler == Handler) {
										done = true;
										break;  /* Break out of for loop */
									}
								}
								if (!done) {  /* try again */
									uniqueID = "iGrp" + (++i);
								}
							} else {  /* uniqueID is unique currently, so keep it */
								done = true;
							}
						}
						UInv.AddEventHandler("cacheImages", "Loaded", Handler, { imageGroup: uniqueID });
						UInv.AddEventHandler("cacheImages", "Error", Handler, { imageGroup: uniqueID });
					}
					for (i = 0; i < ImageName.length; i++) {
						ndx = setup.UInvImageCache.images.map( function (obj) { return obj.URL; } ).indexOf(Path + ImageName[i]);
						if (ndx >= 0) {
							if (["Loaded", "Error"].includes(setup.UInvImageCache.images[ndx].status)) {
								/* shift image at ndx to the front of the "loaded" line (if there is one) so it doesn't get flushed for being old */
								image = setup.UInvImageCache.images.deleteAt(ndx)[0];
								setup.UInvImageCache.images.splice(setup.UInvImageCache.total - setup.UInvImageCache.complete, 0, image);
								if (setup.UInvImageCache.images[ndx].status == "Error") {
									/* retry loading failed image */
									setup.UInvImageCache.images[ndx].status = "Loading...";
									setup.UInvImageCache.errors--;
									setup.UInvImageCache.complete--;
									setup.UInvImageCache.loading++;
									setup.UInvImageCache.images[ndx].IgnoreEvents = true;
									if (uniqueID !== "") {
										setup.UInvImageCache.images[ndx].imageGroup = uniqueID;
									}
									setup.UInvImageCache.images[ndx].src = "";
									delete setup.UInvImageCache.images[ndx].IgnoreEvents;
									setup.UInvImageCache.images[ndx].src = setup.UInvImageCache.URL;
								}
							}  /* don't move "Waiting..." or "Loading..." images, they should already be at the "young" end of the line. */
						} else {
							image = new Image();
							image.path = Path;
							image.filename = ImageName[i];
							image.URL = Path + ImageName[i];
							image.tries = 0;
							if (uniqueID !== "") {
								image.imageGroup = uniqueID;
							}
							setup.UInvImageCache.total++;
							$(image)
								.on("load", Loaded)  /* other events: loadstart onprogress progress loadend */
								.on("error abort", Failure);
							if (setup.UInvImageCache.maxConcurrent > setup.UInvImageCache.loading) {  /* load image */
								setup.UInvImageCache.loading++;
								image.status = "Loading...";
								image.src = Path + ImageName[i];
								setup.UInvImageCache.images.push(image);
							} else {  /* add image to queue */
								setup.UInvImageCache.waiting++;
								image.status = "Waiting...";
								setup.UInvImageCache.images.push(image);
							}
						}
					}
					if (setup.UInvImageCache.images.length > setup.UInvImageCache.maxCache) {  /* Flush oldest images if cache is "full" */
						var OldURLs = setup.UInvImageCache.images.slice(0, setup.UInvImageCache.images.length - setup.UInvImageCache.maxCache).map( function (obj) { return obj.URL; } );
						UInv.flushCachedImages("", OldURLs);
					}
					return true;  /* Success */
				} else {
					UInvError('ImageName passed to cacheImages is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Path passed to cacheImages is not a string.');  /* Error */
				return undefined;
			}
		},

		/* Engine detection code: */
		/* Opera v8.0+ */
		isOpera : function () { return (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(" OPR/") >= 0; },
		/* Firefox v1.0+ */
		isFirefox : function () { return typeof InstallTrigger !== "undefined"; },
		/* Safari v3.0+ "[object HTMLElementConstructor]" */
		isSafari : function () { return /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window.safari || (typeof safari !== "undefined" && safari.pushNotification)); },
		/* Internet Explorer v6-11 */
		isIE : function () { return /*@cc_on!@*/false || !!document.documentMode; },
		/* Edge v20+ */
		isEdge : function () { return !UInv.isIE() && !!window.StyleMedia; },
		/* Chrome v1+ */
		isChrome : function () { return !!window.chrome && !!window.chrome.webstore; },
		/* Blink engine detection */
		isBlink : function () { return (UInv.isChrome() || UInv.isOpera()) && !!window.CSS; },
		/* Android engine detection */
		isAndroid : function () { return Browser.isMobile.Android; },
		/* iOS engine detection */
		isiOS : function () { return Browser.isMobile.iOS; },
		/* BlackBerry engine detection */
		isBlackBerry : function () { return Browser.isMobile.BlackBerry; },
		/* Mobile engine detection */
		isMobile : function () { return ( UInv.isAndroid() || UInv.isiOS() || UInv.isBlackBerry() || Browser.isMobile.Windows ); },
		/* Twine engine detection */
		isTwine : function () { return window.hasOwnProperty("storyFormat"); },


		/* UInv Bag Functions: */
		/* =================== */

		/* GetDefaultBagObject: Returns the Bag object that matches BagType.  If PropertiesOnly is true, then returns default bag properties only. */
		/*                      Returns "null" for unknown bag types, or undefined on error.  Both "undefined" and "null" have "falsey" values. */
		GetDefaultBagObject : function (BagType, PropertiesOnly) {
			if (UInv.isString(BagType)) {
				if ((BagType === "") || (BagType === "-")) {
					/* Do not throw an error here.  This case is used to trigger an "undefined" return if the BagType === "" or "-". */
					return null;  /* Silent failure */
				}
				var BName = BagType.toLowerCase(), BagProperties = UInv.BagData(BName, true);
				if (PropertiesOnly) {
					return BagProperties;  /* Success */
				}
				var BagItems = UInv.BagData(BName, false), Bag = {}, Item = {}, Key = "", i = 0;
				if (UInv.isUndefined(BagProperties) || UInv.isUndefined(BagItems)) {
					return null;  /* Silent failure */
				}
				if (Object.keys(BagProperties).length > 0) {
					Bag = { UInvProperties : BagProperties };
				}
				if (BagItems.length > 0) {
					var ItemName;
					for (i = 0; i < BagItems.length; i++) {
						if (UInv.isString(BagItems[i])) {  /* Handle "String Method" */
							ItemName = ValidateItemName(BagItems[i]);  /* Make sure that the item name on the default bag object is valid */
							if (!UInv.isUndefined(ItemName)) {
								Item = UInv.GetDefaultItemObject(ItemName);  /* OOO function call */
								if (Item) {
									Bag[ItemName] = Item;
								} else {
									UInvError('GetDefaultBagObject failed. Unknown item "' + ItemName + '" on bag of type "' + BagType + '".');  /* Error */
									return undefined;
								}
							} else {
								UInvError('GetDefaultBagObject failed. Invalid item name "' + BagItems[i] + '" on bag of type "' + BagType + '".');  /* Error */
								return undefined;
							}
						} else if (UInv.isGenericObject(BagItems[i])) {  /* Handle "Quantity Method", "Type Method", and "Creation Method" */
							Key = Object.keys(BagItems[i])[0];
							ItemName = ValidateItemName(Key);  /* Make sure that the item name on the default bag object is valid */
							if (!UInv.isUndefined(ItemName)) {
								Item = UInv.GetDefaultItemObject(ItemName);  /* OOO function call */
								if (!Item && !UInv.isGenericObject(BagItems[i][ItemName])) {
									UInvError('GetDefaultBagObject failed. Unknown item type "' + ItemName + '" on bag type "' + BagType + '"..');  /* Error */
									return undefined;
								}
								if (Item && UInv.isInteger(BagItems[i][ItemName])) {  /* Handle "Quantity Method" */
									if (BagItems[i][ItemName] > 1) {
										Item.UInvQuantity = BagItems[i][ItemName];
									}
									Bag[ItemName] = Item;
								} else if (UInv.isGenericObject(BagItems[i][ItemName])) {  /* Handle "Type Method" and "Creation Method" */
									var ItemType = ItemName;
									if (UInv.isProperty(BagItems[i][ItemName], "UInvDefaultItemType")) {
										ItemType = BagItems[i][ItemName].UInvDefaultItemType;
									} else if (!Item) {
										ItemType = "-";
									}
									if (ItemType == "-") {  /* Handle "Creation Method" */
										Bag[ItemName] = BagItems[i][ItemName];
									} else {  /* Handle "Type Method" and "Type+Creation Method" */
										Bag[ItemName] = UInv.combineGenericObjects(UInv.GetDefaultItemObject(ItemType), BagItems[i][ItemName]);
									}
								} else {
									UInvError('GetDefaultBagObject failed. Value of item name "' + Key + '" on bag type "' + BagType + '" must be a "string" or "generic object".');  /* Error */
									return undefined;
								}
							} else {
								UInvError('GetDefaultBagObject failed. Invalid item name "' + Key + '" on bag of type "' + BagType + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('GetDefaultBagObject failed. Unexpected type "' + (typeof BagItems[i]) + '" for item on bag type "' + BagType + '".  Should be "string" or "generic object".');  /* Error */
							return undefined;
						}
					}
				}
				return Bag;  /* Success */
			} else {
				UInvError('BagType passed to GetDefaultBagObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetCurrentBagName: Gets the current bag name if there is one, otherwise returns "". */
		GetCurrentBagName : function () {
			if (UInv.isProperty(State.variables, "UInvCurrentBagName")) {
				return State.variables.UInvCurrentBagName;
			} else {
				return "";
			}
		},

		/* GetBagsArray: Returns an array of all bag names. */
		GetBagsArray : function () {
			return Object.keys(State.variables.UInvBags);  /* Success */
		},

		/* GetBagCount: Returns the number of bags. */
		GetBagCount : function () {
			return UInv.GetBagsArray().length;  /* Success */
		},

		/* BagExists: Returns true if bag exists/all bags in array exist, otherwise returns false, or undefined on error. */
		BagExists : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.isProperty(State.variables.UInvBags, BagName)) {
					State.variables.UInvCurrentBagName = BagName;  /* set $UInvCurrentBagName */
					return true;  /* Success */
				} else {
					return false;  /* Success */
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				var i = 0;
				for (i = 0; i < BagName.length; i++) {
					if (!UInv.BagExists(BagName[i])) {
						return false;  /* Success - bag missing */
					}
				}
				return true;  /* Success - found all bags */
			} else {
				UInvError('Name passed to BagExists is not a string or array of strings.');  /* Error */
				return undefined;
			}
		},

		/* SetCurrentBagName: Sets the UInvCurrentBagName to BagName for use as the default BagName parameter in UInv functions.  Returns true on success or undefined on error. */
		SetCurrentBagName : function (BagName) {
			if (UInv.isString(BagName)) {
				if (BagName === "") {
					if (UInv.isProperty(State.variables, "UInvCurrentBagName")) {
						delete State.variables.UInvCurrentBagName;
					}
				} else {
					if (!UInv.BagExists(BagName)) {  /* $UInvCurrentBagName gets set here */
						UInvError('SetCurrentBagName cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				}
				return true;  /* Success */
			} else {
				UInvError('Name passed to SetCurrentBagName is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetBagUntouched: Sets bag(s) to untouched and returns true, or false if there is an error. */
		SetBagUntouched : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					State.variables.UInvBags[BagName].UInvTouched = false;
					return true;  /* Success */
				} else {
					UInvError('SetBagUntouched cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					var i;
					for (i = 0; i < BagName.length; i++) {
						State.variables.UInvBags[BagName].UInvTouched = false;
					}
					return true;  /* Success */
				} else {
					UInvError('SetBagUntouched failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to SetBagUntouched is not a string or array of strings.');  /* Error */
				return undefined;
			}
		},

		/* CreateBag: Creates a bag named BagName if that bag doesn't exist already.  Returns true if it succeeded. */
		CreateBag : function (BagName) {
			if (UInv.isString(BagName)) {
				if (["", "-"].includes(BagName)) {
					UInvError('CreateBag failed. Invalid bag name "' + BagName + '".');  /* Error */
					return undefined;
				}
				if (UInv.BagExists(BagName)) {
					UInvError('CreateBag cannot create bag "' + BagName + '". Bag already exists with that name.');  /* Error */
					return undefined;
				} else {
					State.variables.UInvBags[BagName] = {};
					if (UInv.GetDefaultBagObject(BagName, true)) {
						State.variables.UInvBags[BagName].UInvDefaultBagType = "-";
					}
					UInv.SetBagUntouched(BagName);
					UInv.SetCurrentBagName(BagName);
					return true;  /* Success */
				}
			} else {
				UInvError('BagName passed to CreateBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetBagTouched: Sets bag(s) to touched and returns true, or false if there is an error. */
		SetBagTouched : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var ev = {};
					ev.bagName = BagName;
					ev.lockCount = UInv.GetUpdateLocks();
					var Ret = UInv.CallEventHandler("bag", "Touched", ev);  /* bag Touched event */
					if (Ret.ignoreTouch !== true) {
						if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvTouched")) {
							delete State.variables.UInvBags[BagName].UInvTouched;
						}
					}
					if (!UInv.UpdatesAreLocked()) {
						UInv.UpdateDisplay();
					}
					return true;  /* Success */
				} else {
					UInvError('SetBagTouched cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					var i;
					UInv.IncrementUpdateLock();
					for (i = 0; i < BagName.length; i++) {
						UInv.SetBagTouched(BagName[i]);
					}
					UInv.DecrementUpdateLock();
					return true;  /* Success */
				} else {
					UInvError('SetBagTouched failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to SetBagTouched is not a string or array of strings.');  /* Error */
				return undefined;
			}
		},

		/* EmptyBag: Deletes all items from bag.  Returns true if successful or undefined on error. */
		EmptyBag : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName);  /* OOO function call */
					if (Items.length > 0) {
						var i = 0;
						UInv.IncrementUpdateLock();  /* Prevent unnecessary updates. */
						for (i = 0; i < Items.length; i++) {
							UInv.DeleteItem(BagName, Items[i]);  /* OOO function call */
						}
						UInv.SetBagTouched(BagName);
						UInv.DecrementUpdateLock();
					}
					UInv.SetCurrentBagName(BagName);
					return true;  /* Success */
				} else {
					UInvError('EmptyBag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to EmptyBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* AddBag: Creates a bag named BagName if that bag doesn't exist already.  Returns true if it succeeded. */
		/*         Items will not be added if the current pocket depth >= the starting pocket depth + UInv.MaximumPocketDepth. */
		AddBag : function (BagName, DefaultBagType, StartDepth, CurrentDepth) {
			if (UInv.isString(BagName)) {
				if ((BagName != "") && (BagName != "-")) {
					if (UInv.isUndefined(DefaultBagType) || UInv.isString(DefaultBagType)) {
						if (UInv.BagExists(BagName)) {
							UInvError('AddBag cannot create bag "' + BagName + '". Bag already exists.');  /* Error */
							return undefined;
						} else {
							var Bag = {}, Tmp, TooDeep = false;
							if (UInv.isUndefined(StartDepth)) {
								StartDepth = 0;
								CurrentDepth = 0;
							} else if (CurrentDepth - StartDepth >= UInv.MaximumPocketDepth) {
								TooDeep = true;  /* This causes GetDefaultBagObject to only return the bag's properties, and not any items in it, to prevent infinite loops and exponential explosions */
							}
							if (UInv.isUndefined(DefaultBagType)) {
								DefaultBagType = BagName;
							}
							Tmp = UInv.GetDefaultBagObject(DefaultBagType, TooDeep);
							if (!Tmp) {
								UInvError('AddBag failed. Unknown bag type "' + DefaultBagType + '".');  /* Error */
								return undefined;
							}
							if (TooDeep) {
								Bag.UInvProperties = Tmp;  /* Don't add items because the pocket is too many levels deep; prevents infinite loops */
							} else {
								Bag = Tmp;
							}
							if (DefaultBagType != BagName) {
								Bag.UInvDefaultBagType = DefaultBagType;
							}
							if (UInv.isProperty(Bag, "UInvProperties")) {
								if (UInv.isProperty(Bag.UInvProperties, "UInvVariableType")) {
									Bag.UInvDefaultBagType = DefaultBagType;  /* bag is of a variable type, so its properties have to be kept as-is */
								} else {
									delete Bag.UInvProperties;  /* clear default properties */
								}
							}
							State.variables.UInvBags[BagName] = Bag;
							var Items = UInv.GetItemsArray(BagName);  /* OOO function call */
							UInv.IncrementUpdateLock();
							if (Items.length > 0) {
								var Quantities = UInv.GetItemsAndQuantitiesObject(BagName), i, ItemType, ItemProperties;  /* OOO function call */
								for (i = 0; i < Items.length; i++) {
									ItemType = UInv.GetItemsDefaultType(BagName, Items[i]);  /* OOO function call */
									if (ItemType !== "-") {  /* add item properly */
										ItemProperties = clone(State.variables.UInvBags[BagName][Items[i]]);
										if (UInv.isProperty(ItemProperties, "UInvPocket")) {
											delete ItemProperties.UInvPocket;
										}
										RemoveItemObjectsDefaultProperties(ItemProperties, ItemType);  /* store non-default properties */
										delete State.variables.UInvBags[BagName][Items[i]];
										UInv.AddItem(BagName, ItemType, Quantities[Items[i]], Items[i], StartDepth, CurrentDepth);  /* OOO function call */
										UInv.SetItemPropertyValues(BagName, Items[i], ItemProperties);  /* restore non-default properties */ /* OOO function call */
									}
								}
							}
							UInv.SetBagUntouched(BagName);
							UInv.SetCurrentBagName(BagName);
							UInv.DecrementUpdateLock();
							return true;  /* Success */
						}
					} else {
						UInvError('DefaultBagType passed to AddBag is not a string.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to AddBag cannot be "-" or "".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to AddBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsDefaultType: Returns bag's default bag type if it has one, "-" if it doesn't, or undefined on error. */
		GetBagsDefaultType : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvDefaultBagType")) {
						return State.variables.UInvBags[BagName].UInvDefaultBagType;
					} else {
						if (UInv.GetDefaultBagObject(BagName, true)) {
							return BagName;
						} else {
							return "-";
						}
					}
				} else {
					UInvError('GetBagsDefaultType failed. Cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetBagsDefaultType is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagCountByDefaultType: Returns the number of unique bag types, bags with no default bag type count as unique bag types. */
		GetBagCountByDefaultType : function () {
			var Tot = 0, Typ, TypLst = [], i;
			var Bags = UInv.GetBagsArray();
			if (Bags.length > 0) {
				for (i = 0; i < Bags.length; i++) {
					Typ = UInv.GetBagsDefaultType(Bags[i]);
					if (Typ === "-") {
						++Tot;
					} else if (TypLst.indexOf(Typ) < 0) {
						TypLst.push(Typ);
						++Tot;
					}
				}
			}
			return Tot;
		},

		/* CopyAllItemsToBag: Copies all items from source to destination. */
		CopyAllItemsToBag : function (SourceBagName, DestinationBagName) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (SourceBagName !== DestinationBagName) {
					if (UInv.BagExists(SourceBagName)) {
						if (UInv.BagExists(DestinationBagName)) {
							var i = 0, Ret, Result = [];
							var Items = UInv.GetItemsArray(SourceBagName);  /* OOO function call */
							if (Items.length > 0) {
								for (i = 0; i < Items.length; i++) {
									Ret = UInv.CopyItem(SourceBagName, DestinationBagName, Items[i]);  /* OOO function call */
									if (Ret === undefined) {
										Result = undefined;
									} else if (!UInv.isBoolean(Result)) {
										Result.push(Ret);
									}
								}
								UInv.SetBagTouched(DestinationBagName);
							}
							UInv.SetCurrentBagName(DestinationBagName);
							return Result;  /* Success or Error  *** */
						} else {
							UInvError('CopyAllItemsToBag cannot find bag "' + DestinationBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('CopyAllItemsToBag cannot find bag "' + SourceBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('CopyAllItemsToBag failed. SourceBagName and DestinationBagName cannot be the same. Value = "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to CopyAllItemsToBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* CopyBag: Creates a new bag named NewBagName if that bag doesn't exist already, and copies ExistingBagName into it. */
		/*          If the existing bag is a pocket, the copy won't be.  Returns true if it succeeded, or undefined on error. */
		CopyBag : function (ExistingBagName, NewBagName) {
			if (UInv.isString(ExistingBagName) && UInv.isString(NewBagName)) {
				ExistingBagName = FixBagName(ExistingBagName);
				NewBagName = FixBagName(NewBagName);
				if (UInv.BagExists(ExistingBagName)) {
					if (!UInv.BagExists(NewBagName)) {
						State.variables.UInvBags[NewBagName] = clone(State.variables.UInvBags[ExistingBagName]);
						if (UInv.isProperty(State.variables.UInvBags[NewBagName], "UInvContainer")) {  /* Bag copies should not be pockets. */
							delete State.variables.UInvBags[NewBagName].UInvContainer;
						}
						var Type = UInv.GetBagsDefaultType(ExistingBagName);
						if (Type !== NewBagName) {
							State.variables.UInvBags[NewBagName].UInvDefaultBagType = Type;
						} else {
							delete State.variables.UInvBags[NewBagName].UInvDefaultBagType;
						}
						var Items = UInv.GetItemsArray(NewBagName);  /* OOO function call */
						if (Items.length > 0) {
							var i = 0;
							UInv.IncrementUpdateLock();  /* Prevent unnecessary updates. */
							for (i = 0; i < Items.length; i++) {
								delete State.variables.UInvBags[NewBagName][Items[i]];
							}
							UInv.CopyAllItemsToBag(ExistingBagName, NewBagName);
							UInv.DecrementUpdateLock();
						}
						UInv.SetBagUntouched(NewBagName);
						return true;  /* Success */
					} else {
						UInvError('CopyBag failed. Bag "' + NewBagName + '" already exists.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('CopyBag failed. Cannot find bag "' + ExistingBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to CopyBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagPropertyArray: Return an array of all bag's property names. */
		GetBagPropertyArray : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Type = UInv.GetBagsDefaultType(BagName);
					var Props = UInv.GetDefaultBagObject(Type, true);
					UInv.SetCurrentBagName(BagName);
					if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvProperties")) {
						if ((Type === "-") || UInv.isProperty(State.variables.UInvBags[BagName].UInvProperties, "UInvVariableType")) {
							return Object.keys(State.variables.UInvBags[BagName].UInvProperties);  /* Success */
						} else {
							return Object.keys(State.variables.UInvBags[BagName].UInvProperties).concatUnique(Object.keys(Props));  /* Success */
						}
					} else if (Type === "-") {
						return [];  /* Success */
					} else {
						return Object.keys(Props);  /* Success */
					}
				} else {
					UInvError('GetBagPropertyArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetBagPropertyArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteBag: Deletes bag entirely.  Return true if successful. */
		DeleteBag : function (BagName) {
			var i;
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.EmptyBag(BagName);
					if (UInv.BagIsPocket(BagName)) {  /* OOO function call */
						var ContainerBagName, ContainerName, PocketName;
						while (UInv.BagIsPocket(BagName)) {  /* Remove pocket from container(s) */
							ContainerBagName = State.variables.UInvBags[BagName].UInvContainer[0].ContainerBagName;
							ContainerName = State.variables.UInvBags[BagName].UInvContainer[0].ContainerName;
							PocketName = State.variables.UInvBags[BagName].UInvContainer[0].PocketName;
							UInv.UnlinkPocketFromContainer(ContainerBagName, ContainerName, PocketName);  /* OOO function */
						}
					}
					if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvProperties")) {
						var Props = Object.keys(State.variables.UInvBags[BagName].UInvProperties);
						if (Props.length > 0) {
							for (i = 0; i < Props.length; i++) {
								delete State.variables.UInvBags[BagName].UInvProperties[Props[i]];
							}
						}
						delete State.variables.UInvBags[BagName].UInvProperties;
					}
					if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvTouched")) {
						delete State.variables.UInvBags[BagName].UInvTouched;
					}
					if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvDefaultBagType")) {
						delete State.variables.UInvBags[BagName].UInvDefaultBagType;
					}
					delete State.variables.UInvBags[BagName];
					return true;  /* Success */
				} else {
					UInvError('DeleteBag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				BagName = UInv.getUniqueArray(BagName);
				if (UInv.BagExists(BagName)) {
					for (i = 0; i < BagName.length; i++) {
						UInv.DeleteBag(BagName[i]);
					}
					return true;  /* Success */
				} else {
					UInvError('Some bags passed to DeleteBag did not exist.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to DeleteBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* RenameBag: Renames CurrentBagName to NewBagName if that bag doesn't exist already.  Returns true if it succeeded. */
		RenameBag : function (CurrentBagName, NewBagName) {
			if (UInv.isString(CurrentBagName) && UInv.isString(NewBagName)) {
				CurrentBagName = FixBagName(CurrentBagName);
				NewBagName = FixBagName(NewBagName);
				if (UInv.BagExists(CurrentBagName)) {
					if (!UInv.BagExists(NewBagName)) {
						var i;
						if (UInv.BagIsPocket(CurrentBagName)) {  /* Rename pocket in container(s) too */ /* OOO function call */
							var ContainerBagName, ContainerName, PocketName;
							for (i = 0; i < State.variables.UInvBags[CurrentBagName].UInvContainer.length; i++) {
								ContainerBagName = State.variables.UInvBags[CurrentBagName].UInvContainer[i].ContainerBagName;
								ContainerName = State.variables.UInvBags[CurrentBagName].UInvContainer[i].ContainerName;
								PocketName = State.variables.UInvBags[CurrentBagName].UInvContainer[i].PocketName;
								State.variables.UInvBags[ContainerBagName][ContainerName].UInvPocket[PocketName] = NewBagName;
							}
						}
						State.variables.UInvBags[NewBagName] = State.variables.UInvBags[CurrentBagName];
						var Items = UInv.GetItemsArray(NewBagName), Pockets, j;  /* OOO function call */
						if (Items.length > 0) {
							for (i = 0; i < Items.length; i++) {  /* Update pocket references on any containers */
								if (UInv.ItemHasPocket(NewBagName, Items[i])) {  /* OOO function call */
									Pockets = UInv.GetItemPocketNameArray(CurrentBagName, Items[i]);  /* OOO function call */
									for (j = 0; j < Pockets.length; j++) {
										UInv.MovePocket(CurrentBagName, Items[i], Pockets[j], NewBagName, Items[i]);  /* OOO function call */
									}
								}
							}
						}
						var Type = UInv.GetBagsDefaultType(CurrentBagName);
						if (Type !== NewBagName) {
							State.variables.UInvBags[NewBagName].UInvDefaultBagType = Type;
						} else {
							delete State.variables.UInvBags[NewBagName].UInvDefaultBagType;
						}
						delete State.variables.UInvBags[CurrentBagName];
						return true;  /* Success */
					} else {
						UInvError('RenameBag failed. Bag "' + NewBagName + '" already exists.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('RenameBag failed. Cannot find bag "' + CurrentBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to RenameBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasProperty: Returns true if bag's property exists, otherwise returns false. */
		BagHasProperty : function (BagName, BagPropertyName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.isString(BagPropertyName)) {
						UInv.SetCurrentBagName(BagName);
						if (UInv.GetBagPropertyArray(BagName).includes(BagPropertyName)) {
							return true;  /* Success */
						} else {
							return false;  /* Success */
						}
					} else if (UInv.isArrayOfStrings(BagPropertyName)) {
						var i = 0, Props = UInv.GetBagPropertyArray(BagName);
						for (i = 0; i < BagPropertyName.length; i++) {
							if (!Props.includes(BagPropertyName[i])) {
								return false;  /* Success */
							}
						}
						return true;  /* Success */
					} else {
						UInvError('BagPropertyName passed to BagHasProperty is not a string or array of strings.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagHasProperty cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to BagHasProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagPropertyValue: Return a bag's property value. */
		GetBagPropertyValue : function (BagName, BagPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasProperty(BagName, BagPropertyName)) {
						UInv.SetCurrentBagName(BagName);
						if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvProperties")) {
							if (UInv.isProperty(State.variables.UInvBags[BagName].UInvProperties, BagPropertyName)) {
								return State.variables.UInvBags[BagName].UInvProperties[BagPropertyName];  /* Success */
							}
						}
						return UInv.GetDefaultBagObject(UInv.GetBagsDefaultType(BagName), true)[BagPropertyName];  /* Success */
					} else {
						UInvError('GetBagPropertyValue cannot find bag property "' + BagPropertyName + '" on bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetBagPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetBagPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetBagPropertyValue: Add or change a bag property and set it to Value.  Returns true if it succeeds, or undefined on error. */
		SetBagPropertyValue : function (BagName, BagPropertyName, Value) {
			if (UInv.isString(BagPropertyName)) {
				if (arguments.length >= 3) {
					if (UInv.isString(BagName)) {
						BagName = FixBagName(BagName);
						if (UInv.BagExists(BagName)) {
							var BagType = UInv.GetBagsDefaultType(BagName), Props = [];
							if (BagPropertyName === "UInvVariableType") {
								if (!UInv.isProperty(State.variables.UInvBags[BagName], "UInvProperties")) {
									State.variables.UInvBags[BagName].UInvProperties = {};
								}
								if (UInv.isProperty(State.variables.UInvBags[BagName].UInvProperties, "UInvVariableType") || (BagType === "-")) {
									State.variables.UInvBags[BagName].UInvProperties.UInvVariableType = Value;
								} else {  /* set bag's default properties */
									State.variables.UInvBags[BagName].UInvProperties = Object.assign({}, UInv.GetDefaultBagObject(BagType, true), State.variables.UInvBags[BagName].UInvProperties);
									State.variables.UInvBags[BagName].UInvProperties.UInvVariableType = Value;
									if (BagType != BagName) {
										State.variables.UInvBags[BagName].UInvDefaultBagType = BagType;
									}
								}
							} else {
								if (!UInv.isProperty(State.variables.UInvBags[BagName], "UInvProperties")) {
									State.variables.UInvBags[BagName].UInvProperties = {};
								}
								State.variables.UInvBags[BagName].UInvProperties[BagPropertyName] = Value;
								if (BagType !== "-") {
									Props = UInv.GetDefaultBagObject(BagType, true);
									if (UInv.isProperty(Props, BagPropertyName) && !UInv.isProperty(Props, "UInvVariableType")) {
										if (Props[BagPropertyName] === State.variables.UInvBags[BagName].UInvProperties[BagPropertyName]) {
											delete State.variables.UInvBags[BagName].UInvProperties[BagPropertyName];
											if (Object.keys(State.variables.UInvBags[BagName].UInvProperties).length === 0) {
												delete State.variables.UInvBags[BagName].UInvProperties;
											}
										}
									}
								}
							}
							UInv.SetCurrentBagName(BagName);
							return true;  /* Success */
						} else {
							UInvError('SetBagPropertyValue cannot find bag "' + BagName + '".');  /* Error */
							return undefined;
						}
					} else if (UInv.isArrayOfStrings(BagName)) {
						if ((BagPropertyName !== "UInvVariableType") || UInv.isString(Value)) {
							if (UInv.BagExists(BagName)) {
								var i = 0, Result = true;
								for (i = 0; i < BagName.length; i++) {
									if (!UInv.SetBagPropertyValue(BagName[i], BagPropertyName, Value)) {
										Result = undefined;
									}
								}
								return Result;  /* Success (or Error, shouldn't happen) */
							} else {
								UInvError('SetBagPropertyValue failed. Invalid bag name in array.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('SetBagPropertyValue failed. The UInvVariableType property can only be set to a string.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('BagName passed to SetBagPropertyValue is not a string or an array of strings.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('SetBagPropertyValue failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to SetBagPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagPropertyObject: Returns object of all properties/values a bag has or undefined on error. */
		GetBagPropertyObject : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Props = UInv.GetBagPropertyArray(BagName), Result = {}, i = 0;
					for (i = 0; i < Props.length; i++) {
						Result[Props[i]] = UInv.GetBagPropertyValue(BagName, Props[i]);
					}
					return Result;  /* Success */
				} else {
					UInvError('GetBagPropertyObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetBagPropertyObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetBagsDefaultType: Changes bag's default type as long as no new properties would be added by doing so.  Returns true on success, false on failure, and undefined on error. */
		SetBagsDefaultType : function (BagName, DefaultBagType) {
			if (UInv.isString(BagName) && UInv.isString(DefaultBagType)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if ((UInv.GetDefaultBagObject(DefaultBagType, true)) || (DefaultBagType === "-")) {
						UInv.SetCurrentBagName(BagName);
						var Props = UInv.GetBagPropertyObject(BagName), DefProps = {};
						if (DefaultBagType !== "-") {
							DefProps = UInv.GetDefaultBagObject(DefaultBagType, true);
							var Keys = Object.keys(DefProps), i = 0;
							if (!UInv.isProperty(DefProps, "UInvVariableType")) {
								for (i = 0; i < Keys.length; i++) {
									if (UInv.isProperty(Props, Keys[i])) {
										if (Props[Keys[i]] === DefProps[Keys[i]]) {
											delete Props[Keys[i]];  /* delete default properties */
										}
									} else {
										if (Keys[i] != "UInvVariableType") {
											return false;  /* Success - Could not change default bag type because default property of that type does not exist on BagBame */
										}
									}
								}
							}
						}
						if ((BagName !== DefaultBagType) || (UInv.isProperty(DefProps, "UInvVariableType"))) {
							State.variables.UInvBags[BagName].UInvDefaultBagType = DefaultBagType;
						}
						if ((BagName === DefaultBagType) && (UInv.isProperty(State.variables.UInvBags[BagName], "UInvDefaultBagType")) && (!UInv.isProperty(DefProps, "UInvVariableType"))) {
							delete State.variables.UInvBags[BagName].UInvDefaultBagType;
						}
						if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvProperties")) {
							delete State.variables.UInvBags[BagName].UInvProperties;
						}
						State.variables.UInvBags[BagName].UInvProperties = Props;
						if (UInv.isProperty(DefProps, "UInvVariableType")) {
							State.variables.UInvBags[BagName].UInvProperties.UInvVariableType = DefProps.UInvVariableType;
						} else if (UInv.isProperty(State.variables.UInvBags[BagName].UInvProperties, "UInvVariableType")) {
							delete State.variables.UInvBags[BagName].UInvProperties.UInvVariableType;
						}
						if (Object.keys(State.variables.UInvBags[BagName].UInvProperties).length === 0) {
							delete State.variables.UInvBags[BagName].UInvProperties;
						}
						return true;  /* Success */
					} else {
						UInvError('SetBagsDefaultType failed. "' + DefaultBagType + '" is not a valid default bag type.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('SetBagsDefaultType cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SetBagsDefaultType is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagPropertyCount: Returns the number of BagName's properties, or undefined if there is an error. */
		BagPropertyCount : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					return UInv.GetBagPropertyArray(BagName).length;  /* Success */
				} else {
					UInvError('BagPropertyCount cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagPropertyCount is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayByProperty: Returns an array of BagNames that have property BagPropertyName. */
		GetBagsArrayByProperty : function (BagPropertyName, BagNameArray) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isUndefined(BagNameArray)) {
					BagNameArray = UInv.GetBagsArray();
				}
				if (UInv.isArrayOfStrings(BagNameArray)) {
					if (UInv.BagExists(BagNameArray)) {
						var i = 0, Result = [];
						for (i = 0; i < BagNameArray.length; i++) {
							if (UInv.BagHasProperty(BagNameArray[i], BagPropertyName)) {
								Result.push(BagNameArray[i]);
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('GetBagsArrayByProperty failed. Invalid bag name within BagNameArray.');  /* Error */
						return undefined;
					}
				} else if ((UInv.isArray(BagNameArray)) && (BagNameArray.length === 0)) {
					return [];  /* Success */
				} else {
					UInvError('BagNameArray passed to GetBagsArrayByProperty is not an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagsArrayByProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagByProperty: Returns a random BagName that has property BagPropertyName. */
		GetBagByProperty : function (BagPropertyName) {
			if (UInv.isString(BagPropertyName)) {
					var Bags = UInv.GetBagsArrayByProperty(BagPropertyName);
					if (Bags.length > 0) {
						var Rnd = random(Bags.length - 1);
						UInv.SetCurrentBagName(Bags[Rnd]);
						return Bags[Rnd];  /* Success */
					} else {
						return "";  /* Success */
					}
			} else {
				UInvError('BagPropertyName passed to GetBagByProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAllProperties: Reurns whether all of the bag's properties are listed in BagPropertyNameArray, false if the bag has no properties, or undefined on error. */
		BagHasAllProperties : function (BagName, BagPropertyNameArray) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.isArrayOfStrings(BagPropertyNameArray)) {
						UInv.SetCurrentBagName(BagName);
						var Props = UInv.GetBagPropertyArray(BagName);
						if (Props.length > 0) {
							var i;
							for (i = 0; i < BagPropertyNameArray.length; i++) {
								if (!Props.includes(BagPropertyNameArray[i])) {
									return false;  /* Success */
								}
							}
							return true;  /* Success */
						}
						return false;  /* Success */
					} else {
						UInvError('BagHasAllProperties failed. BagPropertyNameArray is not an array of strings.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagHasAllProperties cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to BagHasAllProperties is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayWithAllProperties: Returns an array of all bags which have all of the properties in BagPropertyNameArray */
		/*                                (per the BagHasAllProperties function), not including bags with no properties, or return undefined on error. */
		GetBagsArrayWithAllProperties : function (BagPropertyNameArray) {
			if (UInv.isArrayOfStrings(BagPropertyNameArray)) {
				var Bags = UInv.GetBagsArray(), Return = [], i;
				for (i = 0; i < Bags.length; i++) {
					if (UInv.BagHasAllProperties(Bags[i], BagPropertyNameArray)) {
						Return.pushUnique(Bags[i]);
					}
				}
				return Return;  /* Success */
			} else {
				UInvError('GetBagsArrayWithAllProperties failed. BagPropertyNameArray is not an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* CopyBagProperty: Copies a bag property from one bag to another, overwriting the destination if that property is already there. */
		CopyBagProperty : function (SourceBagName, DestinationBagName, BagPropertyName) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName)) {
				DestinationBagName = FixBagName(DestinationBagName);
				SourceBagName = FixBagName(SourceBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						if (UInv.isString(BagPropertyName)) {
							if (UInv.BagHasProperty(SourceBagName, BagPropertyName)) {
								return UInv.SetBagPropertyValue(DestinationBagName, BagPropertyName, UInv.GetBagPropertyValue(SourceBagName, BagPropertyName));
							} else {
								UInvError('CopyBagProperty failed. Bag "' + SourceBagName + '" does not have property "' + BagPropertyName + '".');  /* Error */
								return undefined;
							}
						} else if (UInv.isArrayOfStrings(BagPropertyName)) {
							if (UInv.BagHasAllProperties(SourceBagName, BagPropertyName)) {
								var Result = true, i = 0;
								for (i = 0; i < BagPropertyName.length; i++) {
									if (!UInv.CopyBagProperty(SourceBagName, DestinationBagName, BagPropertyName[i])) {
										Result = undefined;  /* Error */
									}
								}
								return Result;  /* Success (or Error, though this shouldn't fail) */
							} else {
								UInvError('CopyBagProperty failed. Bag "' + SourceBagName + '" does not have all properties in BagPropertyName parameter.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('CopyBagProperty failed. BagPropertyName is not a string or an array of strings.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('CopyBagProperty cannot find bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('CopyBagProperty cannot find bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to CopyBagProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayWherePropertyEquals: Returns an array of all BagNames where BagPropertyName's value === Value, returns [] if none found, or undefined on error. */
		GetBagsArrayWherePropertyEquals : function (BagPropertyName, Value) {
			if (UInv.isString(BagPropertyName)) {
				if (arguments.length >= 2) {
					var Bags = UInv.GetBagsArrayByProperty(BagPropertyName), i = 0, Result = [];
					for (i = 0; i < Bags.length; i++) {
						if (UInv.valuesAreEqual(UInv.GetBagPropertyValue(Bags[i], BagPropertyName), Value)) {
							Result.push(Bags[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetBagsArrayWherePropertyEquals failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagsArrayWherePropertyEquals is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagWherePropertyEquals: Returns a random BagName where BagPropertyName === Value, returns "" if not found, or undefined on error.  Sets that bag as the current bag. */
		GetBagWherePropertyEquals : function (BagPropertyName, Value) {
			if (UInv.isString(BagPropertyName)) {
				if (arguments.length >= 2) {
					var Bags = UInv.GetBagsArrayWherePropertyEquals(BagPropertyName, Value);
					if (Bags.length > 0) {
						var Rnd = random(Bags.length - 1);
						UInv.SetCurrentBagName(Bags[Rnd]);
						return Bags[Rnd];  /* Success */
					} else {
						return "";  /* Success - Not found */
					}
				} else {
					UInvError('GetBagWherePropertyEquals failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagWherePropertyEquals is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayWherePropertyGreaterThan: Returns an array of all BagNames where BagPropertyName > Value, returns [] if none found, or undefined on error. */
		GetBagsArrayWherePropertyGreaterThan : function (BagPropertyName, Value) {
			if (UInv.isString(BagPropertyName)) {
				if (arguments.length >= 2) {
					var Bags = UInv.GetBagsArrayByProperty(BagPropertyName), i = 0, Result = [];
					for (i = 0; i < Bags.length; i++) {
						if (UInv.GetBagPropertyValue(Bags[i], BagPropertyName) > Value) {
							Result.push(Bags[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetBagsArrayWherePropertyGreaterThan failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagsArrayWherePropertyGreaterThan is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagWherePropertyGreaterThan: Returns a random BagName where BagPropertyName > Value, returns "" if not found, or undefined on error.  Sets that bag as the current bag. */
		GetBagWherePropertyGreaterThan : function (BagPropertyName, Value) {
			if (UInv.isString(BagPropertyName)) {
				if (arguments.length >= 2) {
					var Bags = UInv.GetBagsArrayWherePropertyGreaterThan(BagPropertyName, Value);
					if (Bags.length > 0) {
						var Rnd = random(Bags.length - 1);
						UInv.SetCurrentBagName(Bags[Rnd]);
						return Bags[Rnd];  /* Success */
					} else {
						return "";  /* Success - Not found */
					}
				} else {
					UInvError('GetBagWherePropertyGreaterThan failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagWherePropertyGreaterThan is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayWherePropertyLessThan: Returns an array of all BagNames where BagPropertyName < Value, returns [] if none found, or undefined on error. */
		GetBagsArrayWherePropertyLessThan : function (BagPropertyName, Value) {
			if (UInv.isString(BagPropertyName)) {
				if (arguments.length >= 2) {
					var Bags = UInv.GetBagsArrayByProperty(BagPropertyName), i = 0, Result = [];
					for (i = 0; i < Bags.length; i++) {
						if (UInv.GetBagPropertyValue(Bags[i], BagPropertyName) < Value) {
							Result.push(Bags[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetBagsArrayWherePropertyLessThan failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagsArrayWherePropertyLessThan is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagWherePropertyLessThan: Returns a random BagName where BagPropertyName < Value, returns "" if not found, or undefined on error.  Sets that bag as the current bag. */
		GetBagWherePropertyLessThan : function (BagPropertyName, Value) {
			if (UInv.isString(BagPropertyName)) {
				if (arguments.length >= 2) {
					var Bags = UInv.GetBagsArrayWherePropertyLessThan(BagPropertyName, Value);
					if (Bags.length > 0) {
						var Rnd = random(Bags.length - 1);
						UInv.SetCurrentBagName(Bags[Rnd]);
						return Bags[Rnd];  /* Success */
					} else {
						return "";  /* Success - Not found */
					}
				} else {
					UInvError('GetBagWherePropertyLessThan failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagWherePropertyLessThan is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagWithHighestPropertyValue: Returns the BagName with the highest value on BagPropertyName (bags without BagPropertyName are ignored), */
		/*                                 randomly picks one of the highest if multiple bags are tied for highest, "" if none found, or undefined on error. */
		GetBagWithHighestPropertyValue : function (BagPropertyName, BagNameArray) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isUndefined(BagNameArray)) {
					BagNameArray = UInv.GetBagsArray();
				}
				if (UInv.isArrayOfStrings(BagNameArray)) {
					var Bags = UInv.GetBagsArrayByProperty(BagPropertyName, BagNameArray);
					/* var HiVal = Bags.map(o => o[BagPropertyName]).reduce((a, b) => Math.max(a, b)); */
					/* return Bags.filter(o => o[BagPropertyName] === HiVal).random(); */
					if (Bags.length > 0) {
						var HiBags = [ Bags[0] ], HiVal = UInv.GetBagPropertyValue(Bags[0], BagPropertyName);
						if (Bags.length > 1) {
							var i, Value = 0;
							for (i = 1; i < Bags.length; i++) {
								Value = UInv.GetBagPropertyValue(Bags[i], BagPropertyName);
								if (Value > HiVal) {
									HiVal = Value;
									HiBags = [ Bags[i] ];
								} else if (Value === HiVal) {
									HiBags.push(Bags[i]);
								}
							}
						}
						return HiBags[random(HiBags.length - 1)];  /* Success */
					} else {
						return "";  /* Success - Not found */
					}
				} else {
					UInvError('GetBagWithHighestPropertyValue failed. BagNameArray is not an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagWithHighestPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagWithLowestPropertyValue: Returns the BagName with the lowest value on BagPropertyName (bags without BagPropertyName are ignored), */
		/*                                randomly picks one of the lowest if multiple bags are tied for lowest, "" if none found, or undefined on error. */
		GetBagWithLowestPropertyValue : function (BagPropertyName, BagNameArray) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isUndefined(BagNameArray)) {
					BagNameArray = UInv.GetBagsArray();
				}
				if (UInv.isArrayOfStrings(BagNameArray)) {
					var Bags = UInv.GetBagsArrayByProperty(BagPropertyName, BagNameArray);
					if (Bags.length > 0) {
						var LoBags = [ Bags[0] ], LoVal = UInv.GetBagPropertyValue(Bags[0], BagPropertyName);
						if (Bags.length > 1) {
							var i, Value = 0;
							for (i = 1; i < Bags.length; i++) {
								Value = UInv.GetBagPropertyValue(Bags[i], BagPropertyName);
								if (Value < LoVal) {
									LoVal = Value;
									LoBags = [ Bags[i] ];
								} else if (Value === LoVal) {
									LoBags.push(Bags[i]);
								}
							}
						}
						return LoBags[random(LoBags.length - 1)];  /* Success */
					} else {
						return "";  /* Success - Not found */
					}
				} else {
					UInvError('GetBagWithLowestPropertyValue failed. Invalid type passed as BagNameArray property.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagWithLowestPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* AddToBagPropertyValue: Add an amount to a property's value (returns true), create that property if it doesn't exist (returns false), or return undefined if there is an error. */
		AddToBagPropertyValue : function (BagName, BagPropertyName, Amount) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (!UInv.isUndefined(Amount)) {
						Amount = tryIntParse(Amount);
						if (UInv.isNumber(Amount)) {
							if (UInv.BagHasProperty(BagName, BagPropertyName)) {
								if (UInv.isNumber(UInv.GetBagPropertyValue(BagName, BagPropertyName))) {
									UInv.SetBagPropertyValue(BagName, BagPropertyName, UInv.GetBagPropertyValue(BagName, BagPropertyName) + Amount);
									return true;  /* Success */
								} else {
									UInvError('AddToBagPropertyValue failed. Item\'s property value must be a number to add to it.');  /* Error */
									return undefined;
								}
							} else {
								UInv.SetBagPropertyValue(BagName, BagPropertyName, Amount);
								return false;  /* Success */
							}
						} else {
							UInvError('AddToBagPropertyValue failed. Amount must be a number.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('AddToBagPropertyValue failed. Value not defined.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('AddToBagPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to AddToBagPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteBagProperty: Deletes bag property BagPropertyName.  Returns true if successful, otherwise false. */
		DeleteBagProperty : function (BagName, BagPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (UInv.BagHasProperty(BagName, BagPropertyName)) {
						var Type = UInv.GetBagsDefaultType(BagName);
						if (Type !== "-") {
							var Props = UInv.GetDefaultBagObject(Type, true), Keys = Object.keys(Props), i;
							if ((UInv.isProperty(Props, BagPropertyName) && (!UInv.isProperty(Props, "UInvVariableType")))
								/* if the property to be deleted is a default property, change default type and load other properties */
								|| ((BagPropertyName === "UInvVariableType") && (UInv.isProperty(Props, "UInvVariableType")))) {
								/* -or- if it was a variable type bag, change the default type to prevent pulling variable default properties */
								UInv.SetBagsDefaultType(BagName, "-");
							} else if ((BagPropertyName === "UInvVariableType") && (!UInv.isProperty(Props, "UInvVariableType"))) {  /* restore bag as a non-variable type bag */
								for (i = 0; i < Keys.length; i++) {
									if (UInv.isProperty(State.variables.UInvBags[BagName].UInvProperties, Keys[i])) {
										if (UInv.valuesAreEqual(State.variables.UInvBags[BagName].UInvProperties[Keys[i]], Props[Keys[i]])) {
											delete State.variables.UInvBags[BagName].UInvProperties[Keys[i]];
										}
									}
								}
								if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvDefaultBagType") && (State.variables.UInvBags[BagName].UInvDefaultBagType === BagName)) {
									delete State.variables.UInvBags[BagName].UInvDefaultBagType;  /* no longer needed */
								}
							}
						}
						delete State.variables.UInvBags[BagName].UInvProperties[BagPropertyName];
						if (Object.keys(State.variables.UInvBags[BagName].UInvProperties).length === 0) {
							delete State.variables.UInvBags[BagName].UInvProperties;
						}
					}
					return true;  /* Success */
				} else {
					UInvError('DeleteBagProperty cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to DeleteBagProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveAllItemsToBag: Moves all items from source to destination. */
		MoveAllItemsToBag : function (SourceBagName, DestinationBagName) {
			if (UInv.isString(DestinationBagName)) {
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.isString(SourceBagName)) {
					SourceBagName = [ FixBagName(SourceBagName) ];
				}
				if (UInv.BagExists(DestinationBagName)) {
					if (UInv.BagExists(SourceBagName)) {
						var i, j, SrcItems;
						UInv.IncrementUpdateLock();
						for (i = 0; i < SourceBagName.length; i++) {
							if (SourceBagName[i] !== DestinationBagName) {
								SrcItems = UInv.GetItemsArray(SourceBagName[i]);
								for (j = 0; j < SrcItems.length; j++) {
									UInv.MoveItem(SourceBagName[i], DestinationBagName, SrcItems[j]);  /* handle move failure due to pocket protection *** */
								}
							}
						}
						UInv.DecrementUpdateLock();
						return true;  /* Success */
					} else {
						UInvError('MoveAllItemsToBag failed. Invalid bag name SourceBagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveAllItemsToBag cannot find destination bag "' + DestinationBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('DestinationBagName passed to MoveAllItemsToBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MergeBags: Moves all items from source to destination and deletes source. */
		MergeBags : function (SourceBagName, DestinationBagName) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (SourceBagName !== DestinationBagName) {
					if (UInv.BagExists(SourceBagName)) {
						if (UInv.BagExists(DestinationBagName)) {
							var Result = true;
							Result = UInv.MoveAllItemsToBag(SourceBagName, DestinationBagName);
							if (Result) {
								UInv.DeleteBag(SourceBagName);
							}
							return Result;  /* Success */
						} else {
							UInvError('MergeBags cannot find bag "' + DestinationBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MergeBags cannot find bag "' + SourceBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MergeBags failed. SourceBagName and DestinationBagName cannot be the same. Value = "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MergeBags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayWithItem: Returns an array of BagNames that have item (limited to items in BagArray bags if BagArray is passed to function), or undefined if there is an error. */
		GetBagsArrayWithItem : function (ItemName, BagArray) {
			if (UInv.isString(ItemName)) {
				if (UInv.isUndefined(BagArray)) {
					BagArray = UInv.GetBagsArray();
				} else if (UInv.isArrayOfStrings(BagArray)) {
					if (!UInv.BagExists(BagArray)) {
						UInvError('GetBagsArrayWithItem failed. Invalid bag name in BagArray.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagArray passed to GetBagsArrayWithItem is not an array of strings.');  /* Error */
					return undefined;
				}
				var Result = [], i = 0;
				if (BagArray.length > 0) {
					for (i = 0; i < BagArray.length; i++) {
						if (UInv.BagHasItem(BagArray[i], ItemName)) {  /* OOO function call */
							Result.pushUnique(BagArray[i]);
						}
					}
				}
				return Result;  /* Success */
			} else {
				UInvError('ItemName passed to GetBagsArrayWithItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagObject: Returns the full bag object (including UInvDefaultBagType) or undefined on error. */
		GetBagObject : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Result = {}, i = 0, Props = UInv.GetBagPropertyArray(BagName);
					UInv.SetCurrentBagName(BagName);
					Result = clone(State.variables.UInvBags[BagName]);
					Result.UInvDefaultBagType = UInv.GetBagsDefaultType(BagName);
					if (Props.length > 0) {
						if (!UInv.isProperty(Result, "UInvProperties")) {
							Result.UInvProperties = {};
						}
						for (i = 0; i < Props.length; i++) {
							Result.UInvProperties[Props[i]] = UInv.GetBagPropertyValue(BagName, Props[i]);
						}
					}
					Props = UInv.GetItemsArray(BagName);  /* OOO function call */
					if (Props.length > 0) {
						for (i = 0; i < Props.length; i++) {
							Result[Props[i]] = UInv.GetItemObject(BagName, Props[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetBagObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetBagObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* WasTouched: Returns whether the number of items in the bag have changed since creation or since Untouched was last set, or undefined if there is an error. */
		WasTouched : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (UInv.isProperty(State.variables.UInvBags[BagName], "UInvTouched")) {
						return State.variables.UInvBags[BagName].UInvTouched;  /* Success */
					} else {
						return true;  /* Success */
					}
				} else {
					UInvError('WasTouched cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to WasTouched is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetUniqueBagName: Generates and returns an unused bag name ("bagXXHEXX"). */
		GetUniqueBagName : function () {
			var BagName = "bag" + UInv.getRandomHexString();
			while (UInv.BagExists(BagName)) {
				BagName = "bag" + UInv.getRandomHexString();
			}
			return BagName;
		},

		/* BagMatchesDefault: Returns whether bag exactly matches its default version, or undefined on error.  Returns false if the bag does not have a default object. */
		BagMatchesDefault : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Typ = UInv.GetBagsDefaultType(BagName);
					if ((Typ === "-") || UInv.isUndefined(Typ)) {
						return false;  /* Success */
					}
					var BagOb = UInv.GetBagObject(BagName);
					var TmpBag = UInv.GetUniqueBagName();
					UInv.AddBag(TmpBag, Typ);
					if (UInv.WasTouched(BagName)) {
						UInv.SetBagTouched(TmpBag);
					}
					var TmpBagOb = UInv.GetBagObject(TmpBag);
					var Result = UInv.objectsAreEqual(BagOb, TmpBagOb);
					UInv.DeleteBag(TmpBag);
					return Result;  /* Success */
				} else {
					UInvError('BagMatchesDefault cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to BagMatchesDefault is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetTotalBagPropertyValue: Returns the total value of BagPropertyName across all bags, or across all bags in BagNameArray, or undefined on error. */
		GetTotalBagPropertyValue : function (BagPropertyName, BagNameArray) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isUndefined(BagNameArray)) {
					BagNameArray = UInv.GetBagsArray();
				}
				if (UInv.isString(BagNameArray)) {
					BagNameArray = [ BagNameArray ];
				}
				if (UInv.isArrayOfStrings(BagNameArray)) {
					if (UInv.BagExists(BagNameArray)) {
						var Total = 0, Val, i;
						if (BagNameArray.length > 0) {
							for (i = 0; i < BagNameArray.length; i++) {
								if (UInv.BagHasProperty(BagNameArray[i], BagPropertyName)) {
									Val = UInv.GetBagPropertyValue(BagNameArray[i], BagPropertyName);
									if (UInv.isNumber(Val)) {
										Total += Val;
									} else {
										UInvError('GetTotalBagPropertyValue failed.  Property "' + BagPropertyName + '" on bag "' + BagNameArray[i] + '" is not a number.');  /* Error */
										return undefined;
									}
								}
							}
						}
						return Total;  /* Success */
					} else {
						UInvError('GetTotalBagPropertyValue failed.  Bag in BagNameArray does not exist.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetTotalBagPropertyValue failed.  If included, BagNameArray must be a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetTotalBagPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveBagPropertyValueToBag: Moves an amount of a number from one bag's property to another bag's property, limited by the minimum and maximum values. */
		/*                            Deletes the bag or property (depending on DeletionType) if the property's value gets set to DeletionValue.  Returns the destination value or undefined on error. */
		MoveBagPropertyValueToBag : function (SourceBagName, SourceBagPropertyName, DestinationBagName, DestinationBagPropertyName, Amount, MinimumValue, MaximumValue, DeletionValue, DeletionType) {
			if (UInv.isString(SourceBagName) && UInv.isString(SourceBagPropertyName) && UInv.isString(DestinationBagName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						if (UInv.BagHasProperty(SourceBagName, SourceBagPropertyName)) {
							if (UInv.isUndefined(DestinationBagPropertyName)) {
								DestinationBagPropertyName = SourceBagPropertyName;
							}
							if (!UInv.isUndefined(Amount)) {
								Amount = tryIntParse(Amount);
								if (UInv.isNumber(Amount)) {
									var SrcVal = UInv.GetBagPropertyValue(SourceBagName, SourceBagPropertyName);
									SrcVal = tryIntParse(SrcVal);
									if (UInv.isNumber(SrcVal)) {
										var DstVal = 0;
										if (UInv.BagHasProperty(DestinationBagName, DestinationBagPropertyName)) {
											DstVal = UInv.GetBagPropertyValue(DestinationBagName, DestinationBagPropertyName);
											DstVal = tryIntParse(DstVal);
										}
										if (UInv.isNumber(DstVal)) {
											var TmpAmt = Amount;
											if (!UInv.isUndefined(MinimumValue)) {
												MinimumValue = tryIntParse(MinimumValue);
												if (UInv.isUndefined(MinimumValue)) {
													UInvError('MoveBagPropertyValueToBag failed. If used, MinimumValue must be a number.');  /* Error */
													return undefined;
												}
												if (SrcVal - Amount < MinimumValue) {  /* Can't reduce source below minimum */
													Amount = SrcVal - MinimumValue;
												}
												if (DstVal + Amount < MinimumValue) {  /* Can't reduce destination below minimum (for when Amount is negative) */
													Amount = MinimumValue - DstVal;
												}
											}
											if (!UInv.isUndefined(MaximumValue)) {
												MaximumValue = tryIntParse(MaximumValue);
												if (UInv.isUndefined(MaximumValue)) {
													UInvError('MoveBagPropertyValueToBag failed. If used, MaximumValue must be a number.');  /* Error */
													return undefined;
												}
												if ((!UInv.isUndefined(MinimumValue)) && (MinimumValue > MaximumValue)) {
													UInvError('MoveBagPropertyValueToBag failed. When both are used, MaximumValue must be greater than MinimumValue.');  /* Error */
													return undefined;
												}
												if (SrcVal - Amount > MaximumValue) {  /* Can't increase source above maximum (for when Amount is negative) */
													Amount = SrcVal - MaximumValue;
												}
												if (DstVal + Amount > MaximumValue) {  /* Can't increase destination above maximum */
													Amount = MaximumValue - DstVal;
												}
											}
											if (((TmpAmt >= 0) && (Amount > TmpAmt)) || ((TmpAmt < 0) && (Amount < TmpAmt))) {
												UInvError('MoveBagPropertyValueToBag failed. Source (' + SrcVal + ') and/or Destination (' + DstVal + ') values are too far out of MinimumValue (' + MinimumValue + ') and/or MaximumValue (' + MaximumValue + ') range.');  /* Error */
												return undefined;
											}
											if (!UInv.isUndefined(DeletionValue)) {
												DeletionValue = tryIntParse(DeletionValue);
												if (UInv.isUndefined(DeletionValue)) {
													UInvError('MoveBagPropertyValueToBag failed. If used, DeletionValue must be a number.');  /* Error */
													return undefined;
												}
												if (SrcVal - Amount == DeletionValue) {
													if (UInv.isString(DeletionType)) {
														DeletionType = DeletionType.toLowerCase();
													} else {
														DeletionType = "property";
													}
													switch (DeletionType) {
														case "bag":  /* delete bag */
														case "object":  /* delete bag or item */
															UInv.DeleteBag(SourceBagName);
															break;
														case "item":  /* delete item (do nothing in this case) */
															UInv.SetBagPropertyValue(SourceBagName, SourceBagPropertyName, SrcVal - Amount);
															break;
														default:  /* delete property */
															UInv.DeleteBagProperty(SourceBagName, SourceBagPropertyName);
													}
												} else {
													UInv.SetBagPropertyValue(SourceBagName, SourceBagPropertyName, SrcVal - Amount);
												}
												if (DstVal + Amount == DeletionValue) {
													if (UInv.isString(DeletionType)) {
														DeletionType = DeletionType.toLowerCase();
													} else {
														DeletionType = "property";
													}
													switch (DeletionType) {
														case "bag":  /* delete bag */
														case "object":  /* delete bag or item */
															UInv.DeleteBag(DestinationBagName);
															break;
														case "item":  /* delete item (do nothing in this case) */
															UInv.SetBagPropertyValue(DestinationBagName, DestinationBagPropertyName, DstVal + Amount);
															break;
														default:  /* delete property */
															UInv.DeleteBagProperty(DestinationBagName, DestinationBagPropertyName);
													}
												} else {
													UInv.SetBagPropertyValue(DestinationBagName, DestinationBagPropertyName, DstVal + Amount);
												}
												UInv.SetCurrentBagName(DestinationBagName);
												return DstVal + Amount;  /* Success */
											}
											UInv.SetBagPropertyValue(SourceBagName, SourceBagPropertyName, SrcVal - Amount);
											UInv.SetBagPropertyValue(DestinationBagName, DestinationBagPropertyName, DstVal + Amount);
											UInv.SetCurrentBagName(DestinationBagName);
											return DstVal + Amount;  /* Success */
										} else {
											UInvError("MoveBagPropertyValueToBag failed. Destination bag's property value must be a number to add to or subtract from it.");  /* Error */
											return undefined;
										}
									} else {
										UInvError("MoveBagPropertyValueToBag failed. Source bag's property value must be a number to move an Amount of it.");  /* Error */
										return undefined;
									}
								} else {
									UInvError('MoveBagPropertyValueToBag failed. If used, Amount must be a number.');  /* Error */
									return undefined;
								}
							} else {
								var Val = UInv.GetBagPropertyValue(SourceBagName, SourceBagPropertyName);
								UInv.SetBagPropertyValue(DestinationBagName, DestinationBagPropertyName, Val);
								UInv.DeleteBagProperty(SourceBagName, SourceBagPropertyName);
								UInv.SetCurrentBagName(DestinationBagName);
								return Val;  /* Success */
							}
						} else {
							UInvError('MoveBagPropertyValueToBag failed. Source bag "' + SourceBagName + '" does not have property "' + SourceBagPropertyName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveBagPropertyValueToBag cannot find destination bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveBagPropertyValueToBag cannot find source bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveBagPropertyValueToBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveItemPropertyValueToBag: Moves an amount of a number from an item's property to a bag's property, limited by the minimum and maximum values. */
		/*                             Deletes the bag, item, or property (depending on DeletionType) if the property's value gets set to DeletionValue.  Returns the destination value or undefined on error. */
		MoveItemPropertyValueToBag : function (SourceBagName, SourceItemName, SourceItemPropertyName, DestinationBagName, DestinationBagPropertyName, Amount, MinimumValue, MaximumValue, DeletionValue, DeletionType) {
			if (UInv.isString(SourceBagName) && UInv.isString(SourceItemName) && UInv.isString(SourceItemPropertyName) && UInv.isString(DestinationBagName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						SourceItemName = FixItemName(SourceItemName);
						if (UInv.BagHasItem(SourceBagName, SourceItemName)) {  /* OOO function call */
							if (UInv.isUndefined(DestinationBagPropertyName)) {
								DestinationBagPropertyName = SourceItemPropertyName;
							}
							if (UInv.ItemHasProperty(SourceBagName, SourceItemName, SourceItemPropertyName)) {  /* OOO function call */
								if (["UInvDefaultItemType", "UInvPocket"].includes(SourceItemPropertyName)) {
									UInvError('MoveItemPropertyValueToBag failed. SourceItemPropertyName cannot be "' + SourceItemPropertyName + '".');  /* Error */
									return undefined;
								}
								if (SourceItemPropertyName === "UInvQuantity") {
									if ((!UInv.isUndefined(Amount)) && (!UInv.isInteger(Amount))) {
										UInvError("MoveItemPropertyValueToBag failed. Amount must be an integer to move it from an item's UInvQuantity.");  /* Error */
										return undefined;
									}
									MinimumValue = 0;
									DeletionValue = 0;
									if (UInv.isString(DeletionType) && (DeletionType !== "object")) {
										DeletionType = "item";
									}
								}
								if (!UInv.isUndefined(Amount)) {
									Amount = tryIntParse(Amount);
									if (UInv.isNumber(Amount)) {
										var SrcVal = UInv.GetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName);  /* OOO function call */
										SrcVal = tryIntParse(SrcVal);
										if (UInv.isNumber(SrcVal)) {
											var DstVal = 0;
											if (UInv.BagHasProperty(DestinationBagName, DestinationBagPropertyName)) {
												DstVal = UInv.GetBagPropertyValue(DestinationBagName, DestinationBagPropertyName);
												DstVal = tryIntParse(DstVal);
											}
											if (UInv.isNumber(DstVal)) {
												var TmpAmt = Amount;
												if (!UInv.isUndefined(MinimumValue)) {
													MinimumValue = tryIntParse(MinimumValue);
													if (UInv.isUndefined(MinimumValue)) {
														UInvError('MoveItemPropertyValueToBag failed. If used, MinimumValue must be a number.');  /* Error */
														return undefined;
													}
													if (SrcVal - Amount < MinimumValue) {  /* Can't reduce source below minimum */
														Amount = SrcVal - MinimumValue;
													}
													if (DstVal + Amount < MinimumValue) {  /* Can't reduce destination below minimum (for when Amount is negative) */
														Amount = MinimumValue - DstVal;
													}
												}
												if (!UInv.isUndefined(MaximumValue)) {
													MaximumValue = tryIntParse(MaximumValue);
													if (UInv.isUndefined(MaximumValue)) {
														UInvError('MoveItemPropertyValueToBag failed. If used, MaximumValue must be a number.');  /* Error */
														return undefined;
													}
													if ((!UInv.isUndefined(MinimumValue)) && (MinimumValue > MaximumValue)) {
														UInvError('MoveItemPropertyValueToBag failed. When both are used, MaximumValue must be greater than MinimumValue.');  /* Error */
														return undefined;
													}
													if (SrcVal - Amount > MaximumValue) {  /* Can't increase source above maximum (for when Amount is negative) */
														Amount = SrcVal - MaximumValue;
													}
													if (DstVal + Amount > MaximumValue) {  /* Can't increase destination above maximum */
														Amount = MaximumValue - DstVal;
													}
												}
												if (((TmpAmt >= 0) && (Amount > TmpAmt)) || ((TmpAmt < 0) && (Amount < TmpAmt))) {
													UInvError('MoveItemPropertyValueToBag failed. Source (' + SrcVal + ') and/or Destination (' + DstVal + ') values are too far out of MinimumValue (' + MinimumValue + ') and/or MaximumValue (' + MaximumValue + ') range.');  /* Error */
													return undefined;
												}
												if (!UInv.isUndefined(DeletionValue)) {
													DeletionValue = tryIntParse(DeletionValue);
													if (UInv.isUndefined(DeletionValue)) {
														UInvError('MoveItemPropertyValueToBag failed. If used, DeletionValue must be a number.');  /* Error */
														return undefined;
													}
													if (SrcVal - Amount == DeletionValue) {
														if (UInv.isString(DeletionType)) {
															DeletionType = DeletionType.toLowerCase();
														} else {
															DeletionType = "property";
														}
														switch (DeletionType) {
															case "item":  /* delete item */
															case "object":  /* delete bag or item */
																UInv.DeleteItem(SourceBagName, SourceItemName);  /* OOO function call */
																break;
															case "bag":  /* delete bag (do nothing in this case) */
																UInv.SetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName, SrcVal - Amount);  /* OOO function call */
																break;
															default:  /* delete property */
																UInv.DeleteItemProperty(SourceBagName, SourceItemName, SourceItemPropertyName);  /* OOO function call */
														}
													} else {
														UInv.SetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName, SrcVal - Amount);  /* OOO function call */
													}
													if (DstVal + Amount == DeletionValue) {
														if (UInv.isString(DeletionType)) {
															DeletionType = DeletionType.toLowerCase();
														} else {
															DeletionType = "property";
														}
														switch (DeletionType) {
															case "bag":  /* delete bag */
															case "object":  /* delete bag or item */
																UInv.DeleteBag(DestinationBagName);
																break;
															case "item":  /* delete item (do nothing in this case) */
																UInv.SetBagPropertyValue(DestinationBagName, DestinationBagPropertyName, DstVal + Amount);
																break;
															default:  /* delete property */
																UInv.DeleteBagProperty(DestinationBagName, DestinationBagPropertyName);
														}
													} else {
														UInv.SetBagPropertyValue(DestinationBagName, DestinationBagPropertyName, DstVal + Amount);
													}
													UInv.SetCurrentBagName(DestinationBagName);
													return DstVal + Amount;  /* Success */
												}
												UInv.SetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName, SrcVal - Amount);  /* OOO function call */
												UInv.SetBagPropertyValue(DestinationBagName, DestinationBagPropertyName, DstVal + Amount);
												UInv.SetCurrentBagName(DestinationBagName);
												return DstVal + Amount;  /* Success */
											} else {
												UInvError("MoveItemPropertyValueToBag failed. Destination bag's property value must be a number to add to or subtract from it.");  /* Error */
												return undefined;
											}
										} else {
											UInvError("MoveItemPropertyValueToBag failed. Source item's property value must be a number to move an Amount of it.");  /* Error */
											return undefined;
										}
									} else {
										UInvError('MoveItemPropertyValueToBag failed. If used, Amount must be a number.');  /* Error */
										return undefined;
									}
								} else {
									if (["UInvDefaultItemType", "UInvPocket"].includes(SourceItemPropertyName)) {
										UInvError('MoveItemPropertyValueToBag failed. SourceItemPropertyName cannot be "' + SourceItemPropertyName + '".');  /* Error */
										return undefined;
									}
									if (SourceItemPropertyName === "UInvQuantity") {
										UInvError('MoveItemPropertyValueToBag failed. SourceItemPropertyName cannot be "UInvQuantity" unless Amount is set to an Integer.');  /* Error */
										return undefined;
									}
									var Val = UInv.GetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName);  /* OOO function call */
									UInv.SetBagPropertyValue(DestinationBagName, DestinationBagPropertyName, Val);
									UInv.DeleteItemProperty(SourceBagName, SourceItemName, SourceItemPropertyName);  /* OOO function call */
									UInv.SetCurrentBagName(DestinationBagName);
									return Val;  /* Success */
								}
							} else {
								UInvError('MoveItemPropertyValueToBag failed. Item "' + SourceItemName + '" in bag "' + SourceBagName + '" does not have property "' + SourceItemPropertyName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('MoveItemPropertyValueToBag failed. Source bag "' + SourceBagName + '" does not contain item "' + SourceItemName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveItemPropertyValueToBag cannot find destination bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveItemPropertyValueToBag cannot find source bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveItemPropertyValueToBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetRawBagObject: Returns the raw bag object.  FOR INTERNAL/TESTING USE ONLY. */
		GetRawBagObject : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					return State.variables.UInvBags[BagName];  /* Success */
				} else {
					UInvError('GetRawBagObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetRawBagObject is not a string.');  /* Error */
				return undefined;
			}
		},


		/* UInv Pocket/Container Functions: */
		/* ================================ */

		/* GetPocketBagContainerArray: Returns the array of all items that directly contain this pocket, or [] if none do, or undefined on error. */
		/*                             The array will be in the format of: [ { ContainerBagName : "name", ContainerName : "name", PocketName : "name" }, ... ] */
		GetPocketBagContainerArray : function (PocketBagName) {
			if (UInv.isString(PocketBagName)) {
				PocketBagName = FixBagName(PocketBagName);
				if (UInv.BagExists(PocketBagName)) {
					UInv.SetCurrentBagName(PocketBagName);
					if (UInv.isProperty(State.variables.UInvBags[PocketBagName], "UInvContainer")) {
						var Val = State.variables.UInvBags[PocketBagName].UInvContainer;
						if (UInv.isArrayOfGenericObjects(Val)) {
							if (Val.length > 0) {
								return Val;  /* Success */
							} else {
								return [];  /* Success */
							}
						} else {
							return [];  /* Success */
						}
					} else {
						return [];  /* Success */
					}
				} else {
					UInvError('GetPocketBagContainerArray cannot find bag "' + PocketBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetPocketBagContainerArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagIsPocket: Returns how many items the bag is a pocket for, or 0 if none, or undefined on error. */
		BagIsPocket : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					return UInv.GetPocketBagContainerArray(BagName).length;
				} else {
					UInvError('BagIsPocket cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagIsPocket is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemHasPocket: Returns how many pockets the item has, or 0 if none, or undefined on error.  If PocketName is passed, returns whether the item has a pocket with that name. */
		ItemHasPocket : function (BagName, ItemName, PocketName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);  /* OOO function call */
						if (UInv.ItemHasProperty(BagName, ItemName, "UInvPocket")) {  /* OOO function call */
							var Val = UInv.GetItemPropertyValue(BagName, ItemName, "UInvPocket");  /* OOO function call */
							var Keys = Object.keys(Val);
							if (UInv.isUndefined(PocketName)) {
								return Keys.length;  /* Success */
							} else {
								return Keys.includes(PocketName);  /* Success */
							}
						} else {
							if (UInv.isUndefined(PocketName)) {
								return 0;  /* Success - no pockets */
							} else {
								return false;  /* Success - no pockets */
							}
						}
					} else {
						UInvError('ItemHasPocket cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemHasPocket cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemHasPocket is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetPocketDepth: Returns 0 if it's a bag, 1 if it's a pocket, 2 if it's a pocket within a pocket, etc... or undefined on error. */
		GetPocketDepth : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (UInv.BagIsPocket(BagName)) {
						var Bags = UInv.GetPocketBagContainerArray(BagName), BagDepth = 0, i, n;
						for (i = 0; i < Bags.length; i++) {
							n = UInv.GetPocketDepth(Bags[i].ContainerBagName);
							if (UInv.isUndefined(n)) {
								UInvError('Corrupt data. GetPocketDepth cannot find bag "' + Bags[i].ContainerBagName + '", which is listed as the ContainerBagName for the bag "' + BagName + '".');  /* Error */
								return undefined;  /* NOTE: This error should NOT be able to happen if all UInv functions are working properly and the $UInvBags data isn't being changed by the user directly. */
							} else if (n > BagDepth) {
								BagDepth = n;
							}
						}
						return ++BagDepth;  /* Success */
					} else {
						return 0;  /* Success - bag is not a pocket */
					}
				} else {
					UInvError('GetPocketDepth cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetPocketDepth is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemPocketNameArray: Gets an array of pocket names which the item has as pockets, returns [] if it has none, or undefined on error. */
		GetItemPocketNameArray : function (BagName, ItemName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);  /* OOO function call */
						if (UInv.ItemHasPocket(BagName, ItemName)) {
							var Val = UInv.GetItemPropertyValue(BagName, ItemName, "UInvPocket");  /* OOO function call */
							var Keys = Object.keys(Val);
							if (Keys.length > 0) {
								return Keys;  /* Success */
							} else {
								delete State.variables.UInvBags[BagName][ItemName].UInvPocket;  /* delete empty pocket object */
								return [];  /* Success */
							}
						} else {
							return [];  /* Success */
						}
					} else {
						UInvError('GetItemPocketNameArray cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemPocketNameArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemPocketNameArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemPocketObject: Gets an object containing the PocketName-PocketBagName key-value pairs on the item, returns {} if it has none, or undefined on error. */
		GetItemPocketObject : function (BagName, ItemName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);  /* OOO function call */
						if (UInv.ItemHasPocket(BagName, ItemName)) {
							var Val = UInv.GetItemPropertyValue(BagName, ItemName, "UInvPocket");  /* OOO function call */
							var Keys = Object.keys(Val);
							if (Keys.length > 0) {
								return clone(Val);  /* Success */
							} else {
								delete State.variables.UInvBags[BagName][ItemName].UInvPocket;  /* delete empty pocket object */
								return {};  /* Success */
							}
						} else {
							return {};  /* Success */
						}
					} else {
						UInvError('GetItemPocketObject cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemPocketObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemPocketObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemPocketBagArray: Gets an array of bag names which the item has as pockets, returns [] if it has none, or undefined on error. */
		GetItemPocketBagArray : function (BagName, ItemName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);  /* OOO function call */
						if (UInv.ItemHasProperty(BagName, ItemName, "UInvPocket")) {  /* OOO function call */
							var Val = UInv.GetItemPropertyValue(BagName, ItemName, "UInvPocket");  /* OOO function call */
							var Keys = Object.keys(Val);
							if (Keys.length > 0) {
								var Bags = [], i;
								for (i = 0; i < Keys.length; i++) {
									Bags.push(Val[Keys[i]]);
								}
								return Bags;  /* Success */
							} else {
								delete State.variables.UInvBags[BagName][ItemName].UInvPocket;  /* delete empty pocket object */
								return [];  /* Success */
							}
						} else {
							return [];  /* Success */
						}
					} else {
						UInvError('GetItemPocketBagArray cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemPocketBagArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemPocketBagArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasSpecificItem: Returns whether MainBagName (or any pockets on items within MainBagName) contain ItemBagName+ItemName, or undefined on error. */
		BagHasSpecificItem : function (MainBagName, ItemBagName, ItemName) {
			if (UInv.isString(MainBagName) && UInv.isString(ItemBagName) && UInv.isString(ItemName)) {
				ItemBagName = FixBagName(ItemBagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(MainBagName)) {
					if (UInv.BagExists(ItemBagName)) {
						if (UInv.BagHasItem(ItemBagName, ItemName)) {  /* OOO function call */
							UInv.SetCurrentBagName(ItemBagName);
							UInv.SetCurrentItemName(ItemName);  /* OOO function call */
							if ((MainBagName == ItemBagName) && (UInv.BagHasItem(ItemBagName, ItemName))) {  /* OOO function call */
								return true;  /* Success - found item */
							} else {
								var Items = UInv.GetItemsArray(MainBagName);  /* OOO function call */
								var PocketBags, i, j;
								for (i = 0; i < Items.length; i++) {
									PocketBags = UInv.GetItemPocketBagArray(MainBagName, Items[i]);
									if (PocketBags.length > 0) {
										for (j = 0; j < PocketBags.length; j++) {
											if (UInv.BagHasSpecificItem(PocketBags[j], ItemBagName, ItemName)) {
												return true;  /* Success - found item */
											}
										}
									}
								}
								return false;  /* Success - item not found */
							}
						} else {
							UInvError('BagHasSpecificItem cannot find item "' + ItemName + '" in bag "' + ItemBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('BagHasSpecificItem cannot find bag "' + ItemBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagHasSpecificItem cannot find bag "' + MainBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasSpecificItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* AddPocket: Adds a pocket to an existing item.  If the items are stacked, one of the items will get renamed and have a pocket added.  Returns the item's name on success, or undefined on error. */
		AddPocket : function (BagName, ItemName, PocketName, DefaultBagType, StartDepth, CurrentDepth) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(PocketName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						if (!UInv.ItemHasPocket(BagName, ItemName, PocketName)) {
							if (UInv.isUndefined(StartDepth)) {
								StartDepth = UInv.GetPocketDepth(BagName);
							}
							if (UInv.isUndefined(CurrentDepth)) {
								CurrentDepth = StartDepth;
							}
							if (UInv.isString(DefaultBagType)) {
								if (!UInv.GetDefaultBagObject(DefaultBagType, true)) {
									UInvError('AddPocket failed. Unknown bag type "' + DefaultBagType + '".');  /* Error */
									return undefined;
								}
							} else {
								if (!UInv.GetDefaultBagObject(PocketName, true)) {
									UInvError('AddPocket failed. Unknown bag type "' + PocketName + '".');  /* Error */
									return undefined;
								}
								DefaultBagType = PocketName;
							}
							UInv.IncrementUpdateLock();
							if (UInv.BagHasItem(BagName, ItemName) > 1) {  /* If there's more than one, pull an item out of the stack to add a pocket to it */ /* OOO function call */
								var NewItemName = UInv.GetUniqueItemName();  /* OOO function call */
								UInv.RenameItem(BagName, ItemName, NewItemName, 1);  /* OOO function call */
								UInv.SetBagTouched(BagName);
								ItemName = NewItemName;
							}
							var PocketBagName = PocketName;
							if (UInv.BagExists(PocketBagName)) {
								PocketBagName = UInv.GetUniqueBagName();
							}
							UInv.AddBag(PocketBagName, DefaultBagType, StartDepth, CurrentDepth + 1);
							/* Connect pocket to item and vice versa */
							State.variables.UInvBags[PocketBagName].UInvContainer = [ { ContainerBagName : BagName, ContainerName : ItemName, PocketName : PocketName } ];
							if (!UInv.ItemHasPocket(BagName, ItemName)) {
								State.variables.UInvBags[BagName][ItemName].UInvPocket = {};
							}
							State.variables.UInvBags[BagName][ItemName].UInvPocket[PocketName] = PocketBagName;
							UInv.DecrementUpdateLock();
							UInv.SetCurrentBagName(PocketBagName);
							return PocketBagName;
						} else {
							UInvError('AddPocket failed. Pocket "' + PocketName + '" already exists on item.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('AddPocket cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('AddPocket cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to AddPocket is not a string.');  /* Error */
				return undefined;
			}
		},

		/* CreatePocket: Creates a generic pocket on an existing item.  If the items are stacked, one of the items will get renamed and have a pocket added. */
		/*               Returns the item's name on success, or undefined on error. */
		CreatePocket : function (BagName, ItemName, PocketName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(PocketName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (!UInv.ItemHasPocket(BagName, ItemName, PocketName)) {
						if (UInv.BagHasItem(BagName, ItemName) > 1) {  /* Pull an item out of the stack to add a pocket to it */ /* OOO function call */
							UInv.IncrementUpdateLock();
							var NewItemName = UInv.GetUniqueItemName();  /* OOO function call */
							UInv.RenameItem(BagName, ItemName, NewItemName, 1);  /* OOO function call */
							UInv.SetBagTouched(BagName);
							ItemName = NewItemName;
						}
						if (UInv.BagHasItem(BagName, ItemName) == 1) {  /* OOO function call */
							var PocketBagName = PocketName;
							if (UInv.BagExists(PocketName)) {
								PocketBagName = UInv.GetUniqueBagName();
							}
							UInv.CreateBag(PocketBagName);  /* Create new bag as a pocket */
							/* Connect pocket to item and vice versa */
							State.variables.UInvBags[PocketBagName].UInvContainer = [ { ContainerBagName : BagName, ContainerName : ItemName, PocketName : PocketName } ];
							if (!UInv.ItemHasPocket(BagName, ItemName)) {
								State.variables.UInvBags[BagName][ItemName].UInvPocket = {};
							}
							State.variables.UInvBags[BagName][ItemName].UInvPocket[PocketName] = PocketBagName;
							UInv.DecrementUpdateLock();
							UInv.SetCurrentBagName(PocketBagName);
							return PocketBagName;
						} else {
							UInvError('CreatePocket cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('CreatePocket failed. Pocket "' + PocketName + '" already exists on item.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('CreatePocket cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to CreatePocket is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemPocketBagName: Returns the bag name which matches the item's pocket name, or a random pocket bag name if PocketName isn't passed.  Returns false if pocket not found or undefined on error. */
		GetItemPocketBagName : function (BagName, ItemName, PocketName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);  /* OOO function call */
						if (UInv.ItemHasPocket(BagName, ItemName)) {
							if (UInv.isString(PocketName)) {
								if (UInv.isProperty(State.variables.UInvBags[BagName][ItemName].UInvPocket, PocketName)) {
									return State.variables.UInvBags[BagName][ItemName].UInvPocket[PocketName];  /* Success - Return requested pocket bag name */
								} else {
									return false;  /* Success - Pocket not found */
								}
							} else {
								var PocketBagName = UInv.GetItemPocketBagArray(BagName, ItemName);
								return PocketBagName.random();  /* Success - Return random pocket bag name */
							}
						} else {
							return false;  /* Success - No pockets on item */
						}
					} else {
						UInvError('GetItemPocketBagName cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemPocketBagName cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemPocketBagName is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetPocketBagsPocketName: Returns the first PocketName which matches a pocket/bag (PocketBagName) on a particular item, or false if no match is found, or undefined on error. */
		GetPocketBagsPocketName : function (BagName, ItemName, PocketBagName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);  /* OOO function call */
						if (UInv.ItemHasPocket(BagName, ItemName)) {
							var PocketNames = UInv.GetItemPocketNameArray(BagName, ItemName), i;
							for (i = 0; i < PocketNames.length; i++) {
								if (State.variables.UInvBags[BagName][ItemName].UInvPocket[PocketNames[i]] == PocketBagName) {
									return PocketNames[i];  /* Success */
								}
							}
							return false;  /* Success - Pocket not found */
						} else {
							return false;  /* Success - No pockets on item */
						}
					} else {
						UInvError('GetPocketBagsPocketName cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetPocketBagsPocketName cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetPocketBagsPocketName is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeletePocket: Deletes the bag associated with the item's pocket name.  Returns true on success and undefined on error. */
		DeletePocket : function (BagName, ItemName, PocketName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(PocketName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						var PocketBagName = UInv.GetItemPocketBagName(BagName, ItemName, PocketName);
						if (PocketBagName) {
							UInv.SetCurrentBagName(BagName);
							UInv.SetCurrentItemName(ItemName);  /* OOO function call */
							return UInv.DeleteBag(PocketBagName);  /* Success */
						} else {
							UInvError('DeletePocket failed. PocketName "' + PocketName + '" does not exist on container.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('DeletePocket cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('DeletePocket cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to DeletePocket is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetAllBagPockets: Returns an array of all pockets' and sub-pockets's BagNames, plus BagName (unless NoSourceBag == true), or undefined on error. */
		/*                   All BagNames returned in the array will be unique within that array. */
		GetAllBagPockets : function (BagName, NoSourceBag) {
			var Bags = [ BagName ], Pockets, i, j;
			if ((!UInv.isUndefined(NoSourceBag)) && (NoSourceBag == true)) {
				Bags = [];
			}
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName);  /* Get a list of all items in bag */ /* OOO function call */
					for (i = 0; i < Items.length; i++) {
						Pockets = UInv.GetItemPocketBagArray(BagName, Items[i]);  /* Get all pockets on each item */
						if (Pockets.length > 0) {
							Pockets = UInv.GetAllBagPockets(Pockets);  /* Get all pockets within those pockets */
							for (j = 0; j < Pockets.length; j++) {
								Bags.pushUnique(Pockets[j]);  /* Add them all to the list if they aren't already there */
							}
						}
					}
					UInv.SetCurrentBagName(BagName);
					return Bags;  /* Success */
				} else {
					UInvError('GetAllBagPockets cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {  /* Check array of all bags */
					for (i = 0; i < BagName.length; i++) {
						Pockets = UInv.GetAllBagPockets(BagName[i]);  /* Get all pockets within those pockets */
						for (j = 0; j < Pockets.length; j++) {
							Bags.pushUnique(Pockets[j]);  /* Add them all to the list if they aren't already there */
						}
					}
					UInv.SetCurrentBagName(BagName[0]);
					return Bags;  /* Success */
				} else {
					UInvError('GetAllBagPockets failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetAllBagPockets is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* GetAllContainerPockets: Returns an array of all pockets' and sub-pockets's BagNames, or undefined on error.  (All BagNames returned in the array will be unique within that array.) */
		GetAllContainerPockets : function (ContainerBagName, ContainerName) {
			if (UInv.isString(ContainerBagName) && UInv.isString(ContainerName)) {
				ContainerBagName = FixBagName(ContainerBagName);
				ContainerName = FixItemName(ContainerName);
				if (UInv.BagExists(ContainerBagName)) {
					if (UInv.BagHasItem(ContainerBagName, ContainerName)) {  /* OOO function call */
						if (UInv.ItemHasPocket(ContainerBagName, ContainerName)) {
							var PocketBags = UInv.GetItemPocketBagArray(ContainerBagName, ContainerName), CurPockets, AllPockets = [], i, j;
							for (i = 0; i < PocketBags.length; i++) {
								CurPockets = UInv.GetAllBagPockets(PocketBags[i]);
								for (j = 0; j < CurPockets.length; j++) {
									AllPockets.pushUnique(CurPockets[j]);
								}
							}
							return AllPockets;  /* Success */
						} else {
							return [];  /* Success - no pockets */
						}
					} else {
						UInvError('GetAllContainerPockets cannot find item "' + ContainerName + '" in bag "' + ContainerBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetAllContainerPockets cannot find bag "' + ContainerBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetAllContainerPockets is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ContainerHasItem: Returns the total number of items named ItemName in all of container's pockets (does not include the container itself in that count), or undefined on error. */
		ContainerHasItem : function (ContainerBagName, ContainerName, ItemName) {
			if (UInv.isString(ContainerBagName) && UInv.isString(ContainerName)) {
				ContainerBagName = FixBagName(ContainerBagName);
				ContainerName = FixItemName(ContainerName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(ContainerBagName)) {
					if (UInv.BagHasItem(ContainerBagName, ContainerName)) {  /* OOO function call */
						if (UInv.ItemHasPocket(ContainerBagName, ContainerName)) {
							var PocketBags = UInv.GetAllContainerPockets(ContainerBagName, ContainerName), i, n = 0;
							for (i = 0; i < PocketBags.length; i++) {
								n += UInv.BagHasItem(PocketBags[i], ItemName);  /* OOO function call */
							}
							return n;  /* Success */
						} else {
							return 0;  /* Success - no pockets */
						}
					} else {
						UInvError('ContainerHasItem cannot find item "' + ContainerName + '" in bag "' + ContainerBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ContainerHasItem cannot find bag "' + ContainerBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ContainerHasItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ContainerHasPocketBag: Returns whether BagName exists anywhere within the container, or undefined on error. */
		ContainerHasPocketBag : function (ContainerBagName, ContainerName, BagName) {
			if (UInv.isString(ContainerBagName) && UInv.isString(ContainerName)) {
				ContainerBagName = FixBagName(ContainerBagName);
				ContainerName = FixItemName(ContainerName);
				BagName = FixBagName(BagName);
				if (UInv.BagExists(ContainerBagName)) {
					if (UInv.BagHasItem(ContainerBagName, ContainerName)) {  /* OOO function call */
						if (UInv.ItemHasPocket(ContainerBagName, ContainerName)) {
							if (UInv.BagExists(BagName)) {
								var PocketBags = UInv.GetItemPocketBagArray(ContainerBagName, ContainerName), CurPockets, i;
								if (PocketBags.includes(BagName)) {
									return true;  /* Success */
								}
								for (i = 0; i < PocketBags.length; i++) {
									CurPockets = UInv.GetAllBagPockets(PocketBags[i]);
									if (CurPockets.includes(BagName)) {
										return true;  /* Success */
									}
								}
								return false;  /* Success - bag not found in or on container */
							} else {
								return false;  /* Success - bag doesn't exist */
							}
						} else {
							return false;  /* Success - no pockets */
						}
					} else {
						UInvError('ContainerHasPocketBag cannot find item "' + ContainerName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ContainerHasPocketBag cannot find bag "' + ContainerBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ContainerHasPocketBag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* AddExistingBagAsPocket: Adds an existing bag as pocket to an existing item.  If the items are stacked, one of the items will get renamed and has a pocket added. */
		/*                         Returns the item's name on success (in case it had to be changed when unstacking occurred), or undefined on error. */
		AddExistingBagAsPocket : function (BagName, ItemName, PocketName, PocketBagName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(PocketName) && UInv.isString(PocketBagName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				PocketBagName = FixBagName(PocketBagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {  /* OOO function call */
						if (UInv.BagExists(PocketBagName)) {
							if (!UInv.BagHasSpecificItem(PocketBagName, BagName, ItemName)) {
								if (!UInv.ItemHasPocket(BagName, ItemName, PocketName)) {
									UInv.IncrementUpdateLock();
									if (UInv.BagHasItem(BagName, ItemName) > 1) {  /* Pull an item out of the stack to add a pocket to it */ /* OOO function call */
										var NewItemName = UInv.GetUniqueItemName();  /* OOO function call */
										UInv.RenameItem(BagName, ItemName, NewItemName, 1);  /* OOO function call */
										UInv.SetBagTouched(BagName);
										ItemName = NewItemName;
									}
									/* Connect pocket to item and vice versa */
									State.variables.UInvBags[PocketBagName].UInvContainer = [ { ContainerBagName : BagName, ContainerName : ItemName, PocketName : PocketName } ];
									if (!UInv.ItemHasPocket(BagName, ItemName)) {
										State.variables.UInvBags[BagName][ItemName].UInvPocket = {};
									}
									State.variables.UInvBags[BagName][ItemName].UInvPocket[PocketName] = PocketBagName;
									UInv.DecrementUpdateLock();
									UInv.SetCurrentBagName(PocketBagName);
									return ItemName;
								} else {
									UInvError('AddExistingBagAsPocket failed. Pocket "' + PocketName + '" already exists on item.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('AddExistingBagAsPocket failed. Container cannot contain itself.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('AddExistingBagAsPocket cannot find bag "' + PocketBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('AddExistingBagAsPocket cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('AddExistingBagAsPocket cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to AddExistingBagAsPocket is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetContainerIndex: Returns index of container in a bag's UInvContainer array which has the pocket name of PocketName, -1 if not found, or undefined on error. */
		GetContainerIndex : function (BagName, PocketName) {
			if (UInv.isString(BagName) && UInv.isString(PocketName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Containers = UInv.GetPocketBagContainerArray(BagName);
					if (Containers.length > 0) {
						var i;
						for (i = 0; i < Containers.length; i++) {
							if (Containers[i].PocketName == PocketName) {
								return i;  /* Success */
							}
						}
					}
					return -1;  /* Success - PocketName not found */
				} else {
					UInvError('GetContainerIndex cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetContainerIndex is not a string.');  /* Error */
				return undefined;
			}
		},

		/* UnlinkPocketFromContainer: Unlinks a pocket from its container item (and vice versa).  Returns true on success, or undefined on error. */
		UnlinkPocketFromContainer : function (ContainerBagName, ContainerName, PocketName) {
			if (UInv.isString(ContainerBagName) && UInv.isString(ContainerName)) {
				ContainerBagName = FixBagName(ContainerBagName);
				ContainerName = FixItemName(ContainerName);
				if (UInv.BagExists(ContainerBagName)) {
					if (UInv.BagHasItem(ContainerBagName, ContainerName)) {  /* OOO function call */
						if (UInv.isString(PocketName)) {  /* Unlink specific pocket from container */
							var PocketBagName = UInv.GetItemPocketBagName(ContainerBagName, ContainerName, PocketName);
							if (PocketBagName) {
								delete State.variables.UInvBags[ContainerBagName][ContainerName].UInvPocket[PocketName];  /* Unlink pocket from container */
								if (Object.keys(State.variables.UInvBags[ContainerBagName][ContainerName].UInvPocket).length == 0) {
									delete State.variables.UInvBags[ContainerBagName][ContainerName].UInvPocket;
								}
								var PocketIndex = UInv.GetContainerIndex(PocketBagName, PocketName);
								if (PocketIndex >= 0) {  /* Unlink container from pocket */
									State.variables.UInvBags[PocketBagName].UInvContainer.deleteAt(PocketIndex);
									if (State.variables.UInvBags[PocketBagName].UInvContainer.length == 0) {
										delete State.variables.UInvBags[PocketBagName].UInvContainer;
									}
								}
								UInv.SetCurrentBagName(ContainerBagName);
								UInv.SetCurrentItemName(ContainerName);  /* OOO function call */
								return true;  /* Success */
							} else {
								UInvError('UnlinkPocketFromContainer failed. PocketName "' + PocketName + '" does not exist on container.');  /* Error */
								return undefined;
							}
						} else {  /* Unlink ALL pockets from container */
							var Pockets = UInv.GetItemPocketBagArray(ContainerBagName, ContainerName);
							if (Pockets.length > 0) {
								var i;
								for (i = 0; i < Pockets.length; i++) {
									UInv.UnlinkPocketFromContainer(ContainerBagName, ContainerName, Pockets[i]);
								}
							}
							return true;  /* Success */
						}
					} else {
						UInvError('UnlinkPocketFromContainer cannot find item "' + ContainerName + '" in bag "' + ContainerBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('UnlinkPocketFromContainer cannot find bag "' + ContainerBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to UnlinkPocketFromContainer is not a string.');  /* Error */
				return undefined;
			}
		},

		/* UnlinkPocketBagFromContainer: Unlinks a pocket from its container item (and vice versa).  Returns true on success, or undefined on error. */
		UnlinkPocketBagFromContainer : function (ContainerBagName, ContainerName, PocketBagName) {
			if (UInv.isString(ContainerBagName) && UInv.isString(ContainerName) && UInv.isString(PocketBagName)) {
				ContainerBagName = FixBagName(ContainerBagName);
				ContainerName = FixItemName(ContainerName);
				if (UInv.BagExists(ContainerBagName)) {
					if (UInv.BagHasItem(ContainerBagName, ContainerName)) {  /* OOO function call */
						if (UInv.BagExists(PocketBagName)) {
							var PocketName = UInv.GetPocketBagsPocketName(ContainerBagName, ContainerName, PocketBagName);
							if (UInv.isString(PocketName)) {
								return UInv.UnlinkPocketFromContainer(ContainerBagName, ContainerName, PocketName);  /* Success */
							} else {
								UInvError('UnlinkPocketBagFromContainer failed. "' + PocketBagName + '" is not a pocket of "' + ContainerName + '" in bag "' + ContainerBagName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('UnlinkPocketBagFromContainer cannot find bag "' + PocketBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('UnlinkPocketBagFromContainer cannot find item "' + ContainerName + '" in bag "' + ContainerBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('UnlinkPocketBagFromContainer cannot find bag "' + ContainerBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to UnlinkPocketBagFromContainer is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MovePocket: Move a pocket from one container to another.  If the destination item is stacked, one of the items will get renamed and have a pocket added. */
		/*             Returns the item's name on success (in case it had to be changed when unstacking occurred), or undefined on error. */
		MovePocket : function (SourceBagName, SourceItemName, SourcePocketName, DestinationBagName, DestinationItemName, DestinationPocketName) {
			if (UInv.isString(SourceBagName) && UInv.isString(SourceItemName) && UInv.isString(SourcePocketName) && UInv.isString(DestinationBagName)) {
				SourceBagName = FixBagName(SourceBagName);
				SourceItemName = FixItemName(SourceItemName);
				DestinationBagName = FixBagName(DestinationBagName);
				DestinationItemName = FixItemName(DestinationItemName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagHasItem(SourceBagName, SourceItemName)) {  /* OOO function call */
						if (UInv.BagExists(DestinationBagName)) {
							if (UInv.BagHasItem(DestinationBagName, DestinationItemName)) {  /* OOO function call */
								if (UInv.ItemHasPocket(SourceBagName, SourceItemName, SourcePocketName)) {
									if (!UInv.isString(DestinationPocketName)) {
										DestinationPocketName = SourcePocketName;
									}
									if (!UInv.ItemHasPocket(DestinationBagName, DestinationItemName, DestinationPocketName)
										|| (State.variables.UInvBags[SourceBagName] === State.variables.UInvBags[DestinationBagName])) {
										/* Allow exception for RenameBag() where both will reference the same object */
										var PocketBagName = UInv.GetItemPocketBagName(SourceBagName, SourceItemName, SourcePocketName);
										if (UInv.BagHasSpecificItem(PocketBagName, DestinationBagName, DestinationItemName)) {
											UInvError('MovePocket failed. Source pocket cannot contain destination item.');  /* Error */
											return undefined;
										}
										if (UInv.UnlinkPocketFromContainer(SourceBagName, SourceItemName, SourcePocketName)) {
											return UInv.AddExistingBagAsPocket(DestinationBagName, DestinationItemName, DestinationPocketName, PocketBagName);  /* Success */
										}
										UInvError('MovePocket failed. Unable to unlink pocket "' + SourcePocketName + '" from item "' + SourceItemName + '" in bag "' + SourceBagName + '".');  /* Error */
										return undefined;  /* Error - This shouldn't happen */
									} else {
										UInvError('MovePocket failed. Pocket "' + DestinationPocketName + '" already exists on destination item.');  /* Error */
										return undefined;
									}
								} else {
									UInvError('MovePocket failed. Pocket "' + SourceItemName + '" cannot be found.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('MovePocket cannot find item "' + DestinationItemName + '" in bag "' + DestinationBagName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('MovePocket cannot find bag "' + DestinationBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MovePocket cannot find item "' + SourceItemName + '" in bag "' + SourceBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MovePocket cannot find bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MovePocket is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveItemFromPocket: Move an item into a pocket.  If the Quantity parameter isn't set, then move all of that item. */
		MoveItemFromPocket : function (ContainerBagName, ContainerItemName, PocketName, ItemName, DestinationBagName, Quantity) {
			if (UInv.isString(ContainerBagName) && UInv.isString(ContainerItemName) && UInv.isString(PocketName) && UInv.isString(ItemName) && UInv.isString(DestinationBagName)) {
				ContainerBagName = FixBagName(ContainerBagName);
				ContainerItemName = FixItemName(ContainerItemName);
				ItemName = FixItemName(ItemName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(ContainerBagName)) {
					if (UInv.BagHasItem(ContainerBagName, ContainerItemName)) {  /* OOO function call */
						if (UInv.ItemHasPocket(ContainerBagName, ContainerItemName, PocketName)) {
							var PocketBagName = UInv.GetItemPocketBagName(ContainerBagName, ContainerItemName, PocketName);
							var Count = UInv.BagHasItem(PocketBagName, ItemName);  /* OOO function call */
							if (Count) {
								if (UInv.BagExists(DestinationBagName)) {
									if (UInv.ContainerHasPocketBag(PocketBagName, ItemName, DestinationBagName)) {
										UInvError('MoveItemFromPocket failed. Source item cannot be moved inside of itself.');  /* Error */
										return undefined;
									}
									Quantity = tryIntParse(Quantity);
									if (UInv.isNumber(Quantity)) {
										Quantity = Math.round(Quantity);
										if (Quantity < 1) {
											Quantity = 1;
										}
										if (Quantity > Count) {
											Quantity = Count;
										}
									} else {
										Quantity = Count;
									}
									return UInv.MoveItem(PocketBagName, DestinationBagName, ItemName, Quantity);
								} else {
									UInvError('MoveItemFromPocket cannot find bag "' + DestinationBagName + '".');  /* Error */
									return undefined;
								}
							} else {
								UInvError('MoveItemFromPocket cannot find item "' + ItemName + '" in pocket "' + PocketName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('MoveItemFromPocket failed. Pocket "' + PocketName + '" cannot be found.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveItemFromPocket cannot find item "' + ContainerItemName + '" in bag "' + ContainerBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveItemFromPocket cannot find bag "' + ContainerBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveItemFromPocket is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveItemToPocket: Move an item into a pocket.  If the Quantity parameter isn't set, then move all of that item. */
		MoveItemToPocket : function (SourceBagName, SourceItemName, DestinationBagName, DestinationItemName, DestinationPocketName, Quantity) {
			if (UInv.isString(SourceBagName) && UInv.isString(SourceItemName) && UInv.isString(DestinationBagName) && UInv.isString(DestinationItemName) && UInv.isString(DestinationPocketName)) {
				SourceBagName = FixBagName(SourceBagName);
				SourceItemName = FixItemName(SourceItemName);
				DestinationBagName = FixBagName(DestinationBagName);
				DestinationItemName = FixItemName(DestinationItemName);
				if (UInv.BagExists(SourceBagName)) {
					var Count = UInv.BagHasItem(SourceBagName, SourceItemName);  /* OOO function call */
					if (Count) {
						if (UInv.BagExists(DestinationBagName)) {
							if (UInv.BagHasItem(DestinationBagName, DestinationItemName)) {  /* OOO function call */
								if (UInv.ItemHasPocket(DestinationBagName, DestinationItemName, DestinationPocketName)) {
									var DestinationPocketBagName = UInv.GetItemPocketBagName(DestinationBagName, DestinationItemName, DestinationPocketName);
									if (UInv.ContainerHasPocketBag(SourceBagName, SourceItemName, DestinationPocketBagName)) {
										UInvError('MoveItemToPocket failed. Source item cannot be moved inside of itself.');  /* Error */
										return undefined;
									}
									Quantity = tryIntParse(Quantity);
									if (UInv.isNumber(Quantity)) {
										Quantity = Math.round(Quantity);
										if (Quantity < 1) {
											Quantity = 1;
										}
										if (Quantity > Count) {
											Quantity = Count;
										}
									} else {
										Quantity = Count;
									}
									var DestinationPocketBag = UInv.GetItemPocketBagName(DestinationBagName, DestinationItemName, DestinationPocketName);
									return UInv.MoveItem(SourceBagName, DestinationPocketBag, SourceItemName, Quantity);
								} else {
									UInvError('MoveItemToPocket failed. Pocket "' + DestinationPocketName + '" cannot be found.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('MoveItemToPocket cannot find item "' + DestinationItemName + '" in bag "' + DestinationBagName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('MoveItemToPocket cannot find bag "' + DestinationBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveItemToPocket cannot find item "' + SourceItemName + '" in bag "' + SourceBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveItemToPocket cannot find bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveItemToPocket is not a string.');  /* Error */
				return undefined;
			}
		},


		/* UInv Item Functions: */
		/* ==================== */

		/* GetDefaultItemObject: Returns an Item object that matches ItemType. */
		/* Returns "null" for unknown bag types, or undefined on error.  Both "undefined" and "null" have "falsey" values. */
		GetDefaultItemObject : function (ItemType) {
			if (UInv.isString(ItemType)) {
				if ((ItemType === "") || (ItemType === "-")) {
					/* Do not throw an error here.  This case is used to trigger a "null" return if the ItemType === "" or "-". */
					return null;  /* Silent failure */
				}
				var IName = ItemType.toLowerCase();
				if (!["", "-", "uinvtouched", "uinvproperties", "uinvdefaultbagtype", "uinvcontainer"].includes(IName)) {
					var Item = UInv.ItemData(IName);
					if (UInv.isUndefined(Item)) {
						return null;  /* Silent failure */
					}
					if (UInv.isProperty(Item, "UInvQuantity")) {  /* Item should not have a UInvQuantity property. */
						delete Item.UInvQuantity;
					}
					if (UInv.isProperty(Item, "UInvDefaultItemType")) {  /* Item should not have a UInvDefaultItemType property. */
						delete Item.UInvDefaultItemType;
					}
					return Item;  /* Success */
				} else {
					UInvError('GetDefaultItemObject failed. ItemType cannot be "' + ItemType + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('ItemType passed to GetDefaultItemObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetCurrentItemName: Gets the current item name if there is a valid one, otherwise returns "". */
		GetCurrentItemName : function () {
			if (UInv.isProperty(State.variables, "UInvCurrentItemName")) {
				var Value = State.variables.UInvCurrentItemName;
				if (UInv.isString(Value) && !UInv.ReservedBagProperties_LC.includes(Value.toLowerCase())) {
					return Value;  /* Success */
				}
				delete State.variables.UInvCurrentItemName;  /* delete invalid value */
			}
			return "";  /* Success */
		},

		/* SetCurrentItemName: Sets the UInvCurrentItemName to ItemName for use as the default ItemName parameter in UInv functions.  Returns true on success or undefined on error. */
		SetCurrentItemName : function (ItemName) {
			if (UInv.isString(ItemName)) {
				if (ItemName === "") {
					if (UInv.isProperty(State.variables, "UInvCurrentItemName")) {
						delete State.variables.UInvCurrentItemName;
					}
				} else {
					if (!UInv.ReservedBagProperties_LC.includes(ItemName.toLowerCase())) {
						State.variables.UInvCurrentItemName = ItemName;
					} else {
						UInvError('SetCurrentItemName failed.  "' + ItemName + '" is a reserved name which cannot be used as an item name.');  /* Error */
						return undefined;
					}
				}
				return true;  /* Success */
			} else {
				UInvError('ItemName passed to SetCurrentItemName is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasItem: Returns the number of ItemName items in BagName, or undefined if there is an error. */
		BagHasItem : function (BagName, ItemName) {
			if (UInv.isString(ItemName)) {
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					ItemName = FixItemName(ItemName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						if (UInv.isProperty(State.variables.UInvBags[BagName], ItemName)) {
							UInv.SetCurrentItemName(ItemName);
							if (UInv.isProperty(State.variables.UInvBags[BagName][ItemName], "UInvQuantity")) {
								return State.variables.UInvBags[BagName][ItemName].UInvQuantity;  /* Success */
							} else {
								return 1;  /* Success - Default value of UInvQuantity = 1 */
							}
						} else {
							return 0;  /* Not found */
						}
					} else {
						UInvError('BagHasItem cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var i = 0, Result = true;
						for (i = 0; i < BagName.length; i++) {
							Result = UInv.BagHasItem(BagName[i], ItemName);
						}
						return Result;  /* Success */
					} else {
						UInvError('BagHasItem failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to BagHasItem is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('ItemName passed to BagHasItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemExists: Returns true if ItemName is in GetDefaultItem or any bags, otherwise returns false, or undefined on error. */
		ItemExists : function (ItemName) {
			if (UInv.isString(ItemName)) {
				if (UInv.GetDefaultItemObject(ItemName)) {
					return true;  /* Success */
				}
				var Bags = UInv.GetBagsArray(), i = 0;
				if (Bags.length > 0) {
					for (i = 0; i < Bags.length; i++) {
						if (UInv.BagHasItem(Bags[i], ItemName)) {
							return true;  /* Success */
						}
					}
				}
				return false;  /* Success - not found */
			} else {
				UInvError('ItemName passed to ItemExists is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetUniqueItemName: Generates and returns an unused item name ("itemXXHEXX"). */
		GetUniqueItemName : function () {
			var ItemName = "item" + UInv.getRandomHexString();
			while (UInv.ItemExists(ItemName)) {
				ItemName = "item" + UInv.getRandomHexString();
			}
			return ItemName;
		},

		/* GetItemsDefaultType: Returns item's default item type if it has one, "-" if it doesn't, or undefined on error. */
		GetItemsDefaultType : function (BagName, ItemName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						var ItemType = ItemName;
						if (UInv.isProperty(State.variables.UInvBags[BagName][ItemName], "UInvDefaultItemType")) {
							ItemType = State.variables.UInvBags[BagName][ItemName].UInvDefaultItemType;
						} else if (!UInv.GetDefaultItemObject(ItemType)) {
							ItemType = "-";
						}
						return ItemType;
					} else {
						UInvError('GetItemsDefaultType cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemsDefaultType cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsDefaultType is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArray: Returns an array of item names in BagName (not including UInvTouched, UInvProperties, UInvDefaultBagType, or UInvContainer), or undefined if there is an error. */
		GetItemsArray : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = Object.keys(State.variables.UInvBags[BagName]), i;
					for (i = 0; i < UInv.ReservedBagProperties.length; i++) {
						Items.delete(UInv.ReservedBagProperties[i]);
					}
					UInv.SetCurrentBagName(BagName);
					return Items;  /* Success */
				} else {
					UInvError('GetItemsArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemsArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemObject: Returns an item object from BagName that matches ItemName, or undefined if there is an error.  UInvQuantity will try to be the first property on the object. */
		GetItemObject : function (BagName, ItemName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						var ItemObj = UInv.GetDefaultItemObject(UInv.GetItemsDefaultType(BagName, ItemName));
						if (ItemObj && (!UInv.isProperty(ItemObj, "UInvVariableType")) && (!UInv.isProperty(State.variables.UInvBags[BagName][ItemName], "UInvVariableType"))) {
							if (UInv.isProperty(ItemObj, "UInvPocket")) {  /* Don't include default pockets */
								delete ItemObj.UInvPocket;
							}
							var TempObj = clone(State.variables.UInvBags[BagName][ItemName]);
							if (UInv.isProperty(TempObj, "UInvQuantity")) {
								delete TempObj.UInvQuantity;
							}
							ItemObj = Object.assign({ "UInvQuantity" : UInv.BagHasItem(BagName, ItemName) }, ItemObj, TempObj);
						} else {
							ItemObj = clone(State.variables.UInvBags[BagName][ItemName]);
							if (UInv.isProperty(ItemObj, "UInvQuantity")) {
								delete ItemObj.UInvQuantity;
							}
							ItemObj = Object.assign({ "UInvQuantity" : UInv.BagHasItem(BagName, ItemName) }, ItemObj);
						}
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);
						return ItemObj;  /* Success */
					} else {
						UInvError('GetItemObject cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemPropertiesArray: Returns an array of ItemName's item property names from BagName, or undefined if there is an error.  UInvQuantity will be item 0 in array. */
		GetItemPropertiesArray : function (BagName, ItemName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						var ItemList = UInv.GetItemObject(BagName, ItemName), Result = [];
						UInv.SetCurrentItemName(ItemName);
						UInv.SetCurrentBagName(BagName);
						if (ItemList === undefined) {
							return undefined;  /* Error */
						} else {
							Result.push("UInvQuantity");
							if (UInv.isProperty(ItemList, "UInvQuantity")) {
								delete ItemList.UInvQuantity;
							}
							Result = Result.concat(Object.keys(ItemList));
							return Result;  /* Success */
						}
					} else {
						UInvError('GetItemPropertiesArray cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemPropertiesArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemPropertiesArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemHasProperty: Returns whether ItemName in BagName has ItemPropertyName, or undefined if there is an error. */
		ItemHasProperty : function (BagName, ItemName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						UInv.SetCurrentItemName(ItemName);
						UInv.SetCurrentBagName(BagName);
						return UInv.GetItemPropertiesArray(BagName, ItemName).includes(ItemPropertyName);  /* Success */
						/* You can't check State.variables.UInvBags[BagName][ItemName][ItemPropertyName] because that will not be defined for items using a DefaultItem's default property value. */
					} else {
						UInvError('ItemHasProperty cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemHasProperty cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemHasProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayByProperty: Returns an array of all ItemNames in a bag that have property ItemPropertyName. */
		GetItemsArrayByProperty : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName), Result = [], i;
					UInv.SetCurrentBagName(BagName);
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
							Result.push(Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsArrayByProperty cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayByProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemPropertyValue: Returns the value of ItemPropertyName if it exists, otherwise return undefined on error. */
		GetItemPropertyValue : function (BagName, ItemName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						UInv.SetCurrentItemName(ItemName);
						UInv.SetCurrentBagName(BagName);
						if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
							return UInv.GetItemObject(BagName, ItemName)[ItemPropertyName];  /* Success */
						} else {
							UInvError('GetItemPropertyValue cannot find property "' + ItemPropertyName + '" in item "' + ItemName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetItemPropertyValue cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWherePropertyEquals: Returns an array of all items in a bag where ItemPropertyName === Value. */
		GetItemsArrayWherePropertyEquals : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				if (arguments.length >= 3) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						var Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName), Result = [], i = 0;
						UInv.SetCurrentBagName(BagName);
						for (i = 0; i < Items.length; i++) {
							if (UInv.valuesAreEqual(UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName), Value)) {
								Result.push(Items[i]);
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('GetItemsArrayWherePropertyEquals cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemsArrayWherePropertyEquals failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWherePropertyEquals is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAllItems: Returns t/f based on whether the bag has all of the items in the bag, or undefined if there is an error. */
		BagHasAllItems : function (BagName, ItemArray) {
			var i = 0;
			if (UInv.isString(BagName)) {
				if (UInv.isArrayOfStrings(ItemArray)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						for (i = 0; i < ItemArray.length; i++) {
							if (!UInv.BagHasItem(BagName, ItemArray[0])) {
								return false;  /* Success - could not find an item */
							}
						}
						return true;  /* Success - all items found */
					} else {
						UInvError('BagHasAllItems cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemArray passed to BagHasAllItems is not an array of strings.');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					var Result = true;
					for (i = 0; i < BagName.length; i++) {
						Result = UInv.BagHasAllItems(BagName[i], ItemArray);
					}
					return Result;  /* Success */
				} else {
					UInvError('BagHasAllItems failed. Invalid bag name in BagName array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to BagHasAllItems is not a string or array of strings.');  /* Error */
				return undefined;
			}
		},

		/* SetItemsDefaultType: Changes an item's default item type.  Returns true on success. */
		SetItemsDefaultType : function (BagName, ItemName, DefaultItemType) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(DefaultItemType)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						var DefObj = UInv.GetDefaultItemObject(DefaultItemType);
						if (DefObj || (DefaultItemType === "-")) {
							UInv.SetCurrentItemName(ItemName);
							UInv.SetCurrentBagName(BagName);
							var Item = UInv.GetItemObject(BagName, ItemName);
							if (DefaultItemType !== "-") {
								RemoveItemObjectsDefaultProperties(Item, DefaultItemType);
							}
							var VarType = UInv.isProperty(DefObj, "UInvVariableType");
							if (VarType) {
								Item.UInvVariableType = DefObj.UInvVariableType;
							}
							if ((ItemName !== DefaultItemType) || VarType) {
								Item.UInvDefaultItemType = DefaultItemType;
							}
							if ((ItemName === DefaultItemType) && (UInv.isProperty(Item, "UInvDefaultItemType")) && !VarType) {
								delete Item.UInvDefaultItemType;
							}
							delete State.variables.UInvBags[BagName][ItemName];
							State.variables.UInvBags[BagName][ItemName] = Item;
							return true;  /* Success */
						} else {
							UInvError('SetItemsDefaultType failed. "' + DefaultItemType + '" is not a valid default item type.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('SetItemsDefaultType cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('SetItemsDefaultType cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SetItemsDefaultType is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetItemPropertyValue: Set the value of a property on an object (returns true), add that property if it doesn't exist (returns false), or return undefined if there is an error. */
		/*                       Removes property if the value matches the value of the GetDefaultItemObject version of this item.  Does not touch bag unless UInvQuantity changed. */
		SetItemPropertyValue : function (BagName, ItemName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);
						if (arguments.length >= 4) {
							if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
								var ItemType = UInv.GetItemsDefaultType(BagName, ItemName);
								switch (ItemPropertyName) {
								case "UInvQuantity":
									if (UInv.isNumber(Value)) {
										if ((Value > 0) && (Value === Math.round(Value))) {
											if (UInv.BagHasItem(BagName, ItemName) !== Value) {
												if (Value === 1) {
													delete State.variables.UInvBags[BagName][ItemName].UInvQuantity;  /* Defaults to 1 */
												} else {
													if (UInv.ItemHasPocket(BagName, ItemName)) {
														UInvError('SetItemPropertyValue failed on item item "' + ItemName + '" in bag "' + BagName + '". UInvQuantity cannot be above one for items with pockets.');  /* Error */
														return undefined;
													} else {
														State.variables.UInvBags[BagName][ItemName].UInvQuantity = Value;
													}
												}
												UInv.SetBagTouched(BagName);
											}
											return true;  /* Success */
										} else {
											UInvError('SetItemPropertyValue failed. UInvQuantity must be a positive integer.');  /* Error */
											return undefined;
										}
									} else {
										UInvError('SetItemPropertyValue failed. UInvQuantity must be a positive integer.');  /* Error */
									}
									return undefined;
								case "UInvDefaultItemType":
									if ((!UInv.GetDefaultItemObject(Value)) && (Value !== "-")) {
										UInvError('SetItemPropertyValue failed. When setting the UInvDefaultItemType property, the Value parameter must be a valid default item type.');  /* Error */
										return undefined;
									}
									return UInv.SetItemsDefaultType(BagName, ItemName, Value);
								case "UInvVariableType":
									if (UInv.isProperty(State.variables.UInvBags[BagName][ItemName], "UInvVariableType") || (ItemType === "-")) {
										State.variables.UInvBags[BagName][ItemName].UInvVariableType = Value;
									} else {  /* set item's default properties */
										State.variables.UInvBags[BagName][ItemName] = Object.assign({}, UInv.GetDefaultItemObject(ItemType), State.variables.UInvBags[BagName][ItemName]);
										State.variables.UInvBags[BagName].UInvDefaultItemType = ItemType;
										State.variables.UInvBags[BagName][ItemName].UInvVariableType = Value;
									}
									return true;  /* Success */
								case "UInvPocket":
									UInvError('SetItemPropertyValue failed. Pockets should not be manipulated directly. Use Pocket/Container functions instead.');  /* Error */
									return undefined;
								default:
									var Item = UInv.GetDefaultItemObject(ItemType);
									if (Item) {
										if ((UInv.isProperty(Item, ItemPropertyName)) && (!UInv.isProperty(Item, "UInvVariableType"))) {
											if (UInv.valuesAreEqual(Value, Item[ItemPropertyName])) {  /* Matches default value of GetDefaultItemObject version */
												if (UInv.isProperty(State.variables.UInvBags[BagName][ItemName], ItemPropertyName)) {
													delete State.variables.UInvBags[BagName][ItemName][ItemPropertyName];
												}
												return true;  /* Success */
											}
										}
									}
									State.variables.UInvBags[BagName][ItemName][ItemPropertyName] = Value;
									return true;  /* Success */
								}
							} else {
								State.variables.UInvBags[BagName][ItemName][ItemPropertyName] = Value;
								return false;  /* Success */
							}
						} else {
							UInvError('SetItemPropertyValue failed. Value parameter is missing.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('SetItemPropertyValue cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('SetItemPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SetItemPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetItemQuantity: Sets an item's quantity, returns true if successful.  Quantity must be a positive integer. */
		SetItemQuantity : function (BagName, ItemName, Quantity) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						Quantity = tryIntParse(Quantity);
						if (UInv.isNumber(Quantity)) {
							if ((Quantity === Math.round(Quantity)) && (Quantity > 0)) {
								if (UInv.BagHasItem(BagName, ItemName) !== Quantity) {
									if ((UInv.ItemHasPocket(BagName, ItemName)) && (Quantity > 1)) {
										UInvError('SetItemQuantity failed on item item "' + ItemName + '" in bag "' + BagName + '". Quantity cannot be above one for items with pockets.');  /* Error */
										return undefined;
									}
									UInv.SetItemPropertyValue(BagName, ItemName, "UInvQuantity", Quantity);
									UInv.SetBagTouched(BagName);
								}
								return true;  /* Success */
							} else {
								UInvError('Quantity passed to SetItemQuantity must be a positive integer.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('Quantity passed to SetItemQuantity is not a number.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('SetItemQuantity cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('SetItemQuantity cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SetItemQuantity is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteItem: Deletes Quantity items from bag, returns true if successful.  Quantity is an integer, defaults to deleting all items, has a floor of 0, and a max of the item's UInvQuantity. */
		/*             Does not throw an error if ItemName doesn't exist, since that item is basically already deleted. */
		DeleteItem : function (BagName, ItemName, Quantity) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var i = 0;
					if (UInv.isString(ItemName)) {
						ItemName = FixItemName(ItemName);
						if (!UInv.ReservedBagProperties.includes(ItemName)) {
							if (UInv.BagHasItem(BagName, ItemName)) {
								UInv.SetCurrentBagName(BagName);
								var Amt = UInv.BagHasItem(BagName, ItemName);
								if (Amt > 0) {
									Quantity = tryIntParse(Quantity);
									if (UInv.isNumber(Quantity)) {
										Quantity = Math.round(Quantity);
										if (Quantity < 0) {
											Quantity = 0;
										}
										if (Quantity > Amt) {
											Quantity = Amt;
										}
									} else {
										Quantity = Amt;
									}
									if (Quantity > 0) {
										if (Quantity === Amt) {
											var PocketNames = UInv.GetItemPocketNameArray(BagName, ItemName), PocketBag;
											if (PocketNames.length > 0) {  /* Unlink all pockets. */
												for (i = 0; i < PocketNames.length; i++) {
													PocketBag = UInv.GetItemPocketBagName(BagName, ItemName, PocketNames[i]);
													UInv.UnlinkPocketFromContainer(BagName, ItemName, PocketNames[i]);
													if (!UInv.BagIsPocket(PocketBag)) {  /* If the pocket bag isn't a pocket anymore, delete it and all of the items inside it. */
														UInv.DeleteBag(PocketBag);
													}
												}
											}
											delete State.variables.UInvBags[BagName][ItemName];  /* Delete item. */
											UInv.SetBagTouched(BagName);
										} else {
											UInv.SetItemQuantity(BagName, ItemName, UInv.BagHasItem(BagName, ItemName) - Quantity);
											UInv.SetBagTouched(BagName);
											UInv.SetCurrentItemName(ItemName);
										}
									} else {
										UInv.SetCurrentItemName(ItemName);
									}
									return true;  /* Success */
								} else {
									return true;  /* Success - item already didn't exist */
								}
							} else {
								UInvError('Item "' + ItemName + '" passed to DeleteItem do not exist in bag "' + BagName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('DeleteItem failed. ItemName cannot be "' + ItemName + '".');  /* Error */
							return undefined;
						}
					} else if (UInv.isArrayOfStrings(ItemName)) {
						if (UInv.BagHasAllItems(BagName, ItemName)) {
							var Result = true;
							if (ItemName.length > 0) {
								for (i = 0; i < ItemName.length; i++) {
									if (!UInv.DeleteItem(BagName, ItemName[i], Quantity)) {
										Result = undefined;
									}
								}
							}
							return Result;  /* Success (or Error, shouldn't happen) */
						} else {
							UInvError('Some items names passed to DeleteItem do not exist in bag "' + BagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('DeleteItem failed. ItemName is not a string or an array of strings.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('DeleteItem cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to DeleteItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* AddToItemPropertyValue: Add an amount to a property's value (returns true), create that property if it doesn't exist (returns false), or return undefined if there is an error. */
		/*                         Does not touch bag unless UInvQuantity changed.  Deletes item if UInvQuantity would become <= 0. */
		AddToItemPropertyValue : function (BagName, ItemName, ItemPropertyName, Amount) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (!UInv.ReservedBagProperties.includes(ItemName)) {
					if (UInv.BagExists(BagName)) {
						if (UInv.BagHasItem(BagName, ItemName)) {
							if (ItemPropertyName === "UInvDefaultItemType") {
								UInvError('AddToItemPropertyValue cannot be used to modify the value of UInvDefaultItemType. Use SetItemsDefaultType instead.');  /* Error */
								return undefined;
							}
							if (!UInv.isUndefined(Amount)) {
								Amount = tryIntParse(Amount);
								if (UInv.isNumber(Amount)) {
									if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
										var Value = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);
										Value = tryIntParse(Value);
										if (UInv.isNumber(Value)) {
											if (ItemPropertyName === "UInvQuantity") {
												if (Amount === Math.round(Amount)) {
													if (Value + Amount > 0) {
														if ((UInv.ItemHasPocket(BagName, ItemName)) && (Value + Amount > 1)) {
															UInvError('AddToItemPropertyValue failed on item item "' + ItemName + '" in bag "' + BagName + '". Quantity cannot be set above one for items with pockets.');  /* Error */
															return undefined;
														}
														UInv.SetItemQuantity(BagName, ItemName, Value + Amount);
													} else {
														UInv.DeleteItem(BagName, ItemName);
													}
													UInv.SetCurrentItemName(ItemName);
													UInv.SetCurrentBagName(BagName);
													UInv.SetBagTouched(BagName);
													return true;  /* Success */
												} else {
													UInvError('AddToItemPropertyValue failed. Value added to UInvQuantity must be an integer.');  /* Error */
													return undefined;
												}
											} else {
												UInv.SetItemPropertyValue(BagName, ItemName, ItemPropertyName, Value + Amount);
												UInv.SetCurrentItemName(ItemName);
												UInv.SetCurrentBagName(BagName);
												return true;  /* Success */
											}
										} else {
											UInvError('AddToItemPropertyValue failed. ItemPropertyName "' + ItemPropertyName + '" is not a number.');  /* Error */
											return undefined;
										}
									} else {
										UInv.SetItemPropertyValue(BagName, ItemName, ItemPropertyName, Amount);
										UInv.SetCurrentItemName(ItemName);
										UInv.SetCurrentBagName(BagName);
										return false;  /* Success */
									}
								} else {
									UInvError('AddToItemPropertyValue failed. Amount is not a number.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('AddToItemPropertyValue failed. Amount not defined.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('AddToItemPropertyValue cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('AddToItemPropertyValue cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('AddToItemPropertyValue failed. ItemName cannot be "' + ItemName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to AddToItemPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemsMatch: Returns whether all properties exist and match, except UInvQuantity, UInvDefaultItemType, and UInvCell.  Or returns undefined on error. */
		ItemsMatch : function (BagName1, ItemName1, BagName2, ItemName2, PropertyExceptionArray) {
			if (UInv.isString(BagName1) && UInv.isString(ItemName1) && UInv.isString(BagName2) && UInv.isString(ItemName2)) {
				BagName2 = FixBagName(BagName2);
				ItemName2 = FixItemName(ItemName2);
				BagName1 = FixBagName(BagName1);
				ItemName1 = FixItemName(ItemName1);
				if (UInv.BagExists(BagName1)) {
					if (UInv.BagExists(BagName2)) {
						if (UInv.BagHasItem(BagName1, ItemName1)) {
							if (UInv.BagHasItem(BagName2, ItemName2)) {
								var Props1 = [], Props2 = [], i, Value1, Value2;
								UInv.SetCurrentItemName(ItemName1);
								UInv.SetCurrentBagName(BagName1);
								Props1 = UInv.GetItemPropertiesArray(BagName1, ItemName1);
								Props2 = UInv.GetItemPropertiesArray(BagName2, ItemName2);
								Props1.delete("UInvQuantity", "UInvDefaultItemType", "UInvCell");
								Props2.delete("UInvQuantity", "UInvDefaultItemType", "UInvCell");
								if (UInv.isString(PropertyExceptionArray)) {
									PropertyExceptionArray = [ PropertyExceptionArray ];
								}
								if (!UInv.isUndefined(PropertyExceptionArray)) {
									if (UInv.isArrayOfStrings(PropertyExceptionArray)) {
										for (i = 0; i < PropertyExceptionArray.length; i++) {
											Props1.delete(PropertyExceptionArray[i]);
											Props2.delete(PropertyExceptionArray[i]);
										}
									} else {
										UInvError('ItemsMatch failed.  When included, the PropertyExceptionArray must be a string or an array of strings.');  /* Error */
										return undefined;
									}
								}
								Props1 = Props1.sort();
								Props2 = Props2.sort();
								if (UInv.arraysAreEqual(Props1, Props2)) {
									for (i = 0; i < Props1.length; i++) {
										Value1 = UInv.GetItemPropertyValue(BagName1, ItemName1, Props1[i]);
										Value2 = UInv.GetItemPropertyValue(BagName2, ItemName2, Props1[i]);
										if (!UInv.valuesAreEqual(Value1, Value2)) {
											return false;  /* Success */
										}
									}
									return true;  /* Success - all items match */
								} else {
									return false;  /* Success */
								}
							} else {
								UInvError('ItemsMatch cannot find item "' + ItemName2 + '" in bag "' + BagName2 + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('ItemsMatch cannot find item "' + ItemName1 + '" in bag "' + BagName1 + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ItemsMatch cannot find bag "' + BagName2 + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemsMatch cannot find bag "' + BagName1 + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemsMatch is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetMatchingItemsArray: Returns an array of all items in SearchBag that match ItemName (per the ItemsMatch function), not including excluded property names, or undefined on error. */
		GetMatchingItemsArray : function (BagName, ItemName, SearchBag, PropertyExceptionArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.BagExists(SearchBag)) {
							if (UInv.isString(PropertyExceptionArray)) {
								PropertyExceptionArray = [ PropertyExceptionArray ];
							}
							if (!UInv.isUndefined(PropertyExceptionArray)) {
								if (!UInv.isArrayOfStrings(PropertyExceptionArray)) {
									UInvError('GetMatchingItemsArray failed.  When included, the PropertyExceptionArray must be a string or an array of strings.');  /* Error */
									return undefined;
								}
							}
							var Items = UInv.GetItemsArray(SearchBag), Result = [], i;
							UInv.SetCurrentItemName(ItemName);
							UInv.SetCurrentBagName(BagName);
							for (i = 0; i < Items.length; i++) {
								if (UInv.isUndefined(PropertyExceptionArray)) {
									if (UInv.ItemsMatch(BagName, ItemName, SearchBag, Items[i])) {
										Result.push(Items[i]);
									}
								} else {
									if (UInv.ItemsMatch(BagName, ItemName, SearchBag, Items[i], PropertyExceptionArray)) {
										Result.push(Items[i]);
									}
								}
							}
							return Result;  /* Success */
						} else {
							UInvError('GetMatchingItemsArray cannot find bag "' + SearchBag + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetMatchingItemsArray cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetMatchingItemsArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetMatchingItemsArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* CopyItem: Copy item from source to destination, changing the UInvQuantity if that parameter is used.  Uses UInvMergeItemMethod to determine what happens on item collision. */
		CopyItem : function (SourceBagName, DestinationBagName, ItemName, Quantity, NewItemName) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName) && UInv.isString(ItemName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				ItemName = FixItemName(ItemName);
				if (!UInv.ReservedBagProperties.includes(ItemName)) {
					if (UInv.BagExists(SourceBagName)) {
						if (UInv.BagExists(DestinationBagName)) {
							if (UInv.BagHasItem(SourceBagName, ItemName)) {
								if ((!UInv.isUndefined(NewItemName)) || (SourceBagName !== DestinationBagName)) {
									if (UInv.isUndefined(NewItemName)) {
										NewItemName = ItemName;
									}
									if (UInv.isString(NewItemName)) {
										Quantity = tryIntParse(Quantity);
										if (UInv.isNumber(Quantity)) {
											Quantity = Math.round(Quantity);
											if (Quantity < 1) {
												Quantity = 1;
											}
										} else {
											Quantity = UInv.BagHasItem(SourceBagName, ItemName);
										}
										var Item = UInv.GetItemObject(SourceBagName, ItemName), ItemType = UInv.GetItemsDefaultType(SourceBagName, ItemName), i;
										Item.UInvQuantity = Quantity;
										if (UInv.isProperty(Item, "UInvCell")) {  /* Don't copy UInvCell property */
											delete Item.UInvCell;
										}
										if (UInv.ItemHasPocket(SourceBagName, ItemName)) {
											var PocketBagName, Keys = Object.keys(Item.UInvPocket);
											for (i = 0; i < Keys.length; i++) {  /* Copy pockets */
												PocketBagName = UInv.GetUniqueBagName();
												UInv.CopyBag(Item.UInvPocket[Keys[i]], PocketBagName);
												Item.UInvPocket[Keys[i]] = PocketBagName;
												/* Bag PocketBagName will be pointing to a container that doesn't exist yet.  ContainerName is updated in "case UInv.MERGE_RENAME_SOURCE_ITEMNAME:" if needed. */
												State.variables.UInvBags[PocketBagName].UInvContainer = [ { ContainerBagName : DestinationBagName, ContainerName : NewItemName, PocketName : Keys[i] } ];
											}
											Item.UInvQuantity = 1;  /* Items with pockets don't stack  ***  Make more? */
										}
										if (UInv.isProperty(Item, "UInvVariableType")) {
											/* Search items in DestinationBagName that are of the same type to see if any are equal, and if any are, then just increment the first one's quantity. */
											var ItemList = UInv.GetItemsArrayWherePropertyEquals(DestinationBagName, "UInvDefaultItemType", ItemType);
											if (ItemList.length > 0) {
												for (i = 0; i < ItemList.length; i++) {
													if (UInv.ItemsMatch(SourceBagName, ItemName, DestinationBagName, ItemList[i])) {  /* Allow merge if objects match (not including UInvQuantity and UInvCell). */
														UInv.AddToItemPropertyValue(DestinationBagName, ItemList[i], "UInvQuantity", Quantity);
														UInv.SetCurrentItemName(ItemList[i]);
														UInv.SetCurrentBagName(DestinationBagName);
														UInv.SetBagTouched(DestinationBagName);
														return ItemList[i];  /* Success */
													}
												}
											}
										}
										if (UInv.BagHasItem(DestinationBagName, NewItemName)) {
											var Result = NewItemName, SrcKeys = {}, MergeMethod = State.variables.UInvMergeItemMethod;
											if (UInv.ItemHasPocket(SourceBagName, ItemName)) {
												MergeMethod = UInv.MERGE_RENAME_SOURCE_ITEMNAME;
											} else {
												if (UInv.ItemsMatch(SourceBagName, ItemName, DestinationBagName, NewItemName)) {  /* Allow merge if objects match (not including UInvQuantity and UInvCell). */
													UInv.AddToItemPropertyValue(DestinationBagName, NewItemName, "UInvQuantity", Quantity);
													UInv.SetCurrentItemName(NewItemName);
													UInv.SetCurrentBagName(DestinationBagName);
													UInv.SetBagTouched(DestinationBagName);
													return Result;  /* Success */
												}
											}
											if (UInv.isProperty(Item, "UInvVariableType")) {
												/* Variable items use UInv.MERGE_RENAME_SOURCE_ITEMNAME instead of the current merge method. */
												MergeMethod = UInv.MERGE_RENAME_SOURCE_ITEMNAME;
											}
											switch (MergeMethod) {
												case UInv.MERGE_USE_ONLY_SOURCE_PROPERTIES:
													/* Delete the destination's properties, replace with the source's properties and values, and increment the quantity. */
													Item.UInvQuantity += UInv.BagHasItem(DestinationBagName, NewItemName);
													if (!UInv.isProperty(Item, "UInvVariableType")) {
														if (ItemType !== NewItemName) {
															if ((ItemType === "-") && (!UInv.GetDefaultItemObject(NewItemName))) {
																if (UInv.isProperty(Item, "UInvDefaultItemType")) {
																	delete Item.UInvDefaultItemType;
																}
															} else {
																Item.UInvDefaultItemType = ItemType;
															}
														} else if (UInv.isProperty(Item, "UInvDefaultItemType")) {
															delete Item.UInvDefaultItemType;
														}
													}
													UInv.DeleteItem(DestinationBagName, NewItemName);  /* remove destination item */
													RemoveItemObjectsDefaultProperties(Item, ItemType);
													State.variables.UInvBags[DestinationBagName][NewItemName] = Item;  /* overwrite destination item */
													UInv.SetCurrentItemName(NewItemName);
													UInv.SetCurrentBagName(DestinationBagName);
													UInv.SetBagTouched(DestinationBagName);
													break;  /* Success */
												case UInv.MERGE_PREFER_DESTINATION_PROPERTIES:
													/* Keep the properties, values, and type in the destination, add any properties and values the source had but the destination didn't, and increment the quantity. */
													UInv.AddToItemPropertyValue(DestinationBagName, NewItemName, "UInvQuantity", Quantity);
													if (UInv.isProperty(Item, "UInvDefaultItemType")) {
														delete Item.UInvDefaultItemType;
													}
													SrcKeys = Object.keys(Item);
													if (SrcKeys.length > 0) {
														for (i = 0; i < SrcKeys.length; i++) {
															if (UInv.ItemHasProperty(DestinationBagName, NewItemName, SrcKeys[i])) {
																delete Item[SrcKeys[i]];  /* Delete properties from source item that are already on destination item. */
															}
														}
													}
													if (Object.keys(Item).length > 0) {  /* Add remaining keys to destination item */
														Object.assign(State.variables.UInvBags[DestinationBagName][NewItemName], Item);
													}
													UInv.SetCurrentItemName(NewItemName);
													UInv.SetCurrentBagName(DestinationBagName);
													UInv.SetBagTouched(DestinationBagName);
													break;  /* Success */
												case UInv.MERGE_PREFER_SOURCE_PROPERTIES:
													/* Keep the properties and values in the source, add any properties and values the destination had but source the didn't, and increment the quantity. */
													Item.UInvQuantity += UInv.BagHasItem(DestinationBagName, NewItemName);
													if (!UInv.isProperty(Item, "UInvVariableType")) {
														if (ItemType !== NewItemName) {
															if ((ItemType === "-") && (!UInv.GetDefaultItemObject(NewItemName))) {
																if (UInv.isProperty(Item, "UInvDefaultItemType")) {
																	delete Item.UInvDefaultItemType;
																}
															} else {
																Item.UInvDefaultItemType = ItemType;
															}
														} else if (UInv.isProperty(Item, "UInvDefaultItemType")) {
															delete Item.UInvDefaultItemType;
														}
													}
													/* Delete properties from destination item that are already on source item.  This needs to be done due to default properties. */
													SrcKeys = Object.keys(Item);
													for (i = 0; i < SrcKeys.length; i++) {
														if (UInv.ItemHasProperty(DestinationBagName, NewItemName, SrcKeys[i])) {
															if (UInv.isProperty(State.variables.UInvBags[DestinationBagName][NewItemName], SrcKeys[i])) {
																delete State.variables.UInvBags[DestinationBagName][NewItemName][SrcKeys[i]];
															}
														}
													}
													RemoveItemObjectsDefaultProperties(Item, ItemType);
													if (Object.keys(Item).length > 0) {
														Object.assign(State.variables.UInvBags[DestinationBagName][NewItemName], Item);  /* Add keys to destination item, overwriting existing properties */
													}
													UInv.SetCurrentItemName(NewItemName);
													UInv.SetCurrentBagName(DestinationBagName);
													UInv.SetBagTouched(DestinationBagName);
													break;  /* Success */
												case UInv.MERGE_RENAME_SOURCE_ITEMNAME:
													/* Rename the source's unique identifier so that it's stored separately in the destination bag. */
													if (UInv.isProperty(Item, "UInvPocket")) {
														NewItemName = [];  /* Don't look for matches of items that have pockets. */
													} else {
														NewItemName = UInv.GetMatchingItemsArray(SourceBagName, ItemName, DestinationBagName);  /* Look for matches in destination bag */
														while ((NewItemName.length > 0) && (UInv.ItemHasPocket(DestinationBagName, NewItemName[0]))) {  /* Make sure matches don't have pockets. */
															NewItemName.shift();
														}
													}
													if (NewItemName.length == 0) {  /* If there are no matches, rename item */
														NewItemName = UInv.GetUniqueItemName();
														Item.UInvDefaultItemType = ItemType;
														RemoveItemObjectsDefaultProperties(Item, ItemType);
														if (Item.UInvQuantity === 1) {
															delete Item.UInvQuantity;
														}
														State.variables.UInvBags[DestinationBagName][NewItemName] = Item;  /* Copy item SourceBagName/ItemName as DestinationBagName/NewItemName */
													} else {  /* Increase quantity of matching item */
														NewItemName = NewItemName[0];
														UInv.AddToItemPropertyValue(DestinationBagName, NewItemName, "UInvQuantity", Item.UInvQuantity);  /* Increase quantity of existing matching items */
													}
													FixContainerReferences(SourceBagName, ItemName, DestinationBagName, NewItemName);  /* Update pockets' references to match the container's new item name */
													UInv.SetCurrentItemName(NewItemName);
													UInv.SetCurrentBagName(DestinationBagName);
													UInv.SetBagTouched(DestinationBagName);
													Result = NewItemName;
													break;  /* Success */
												case UInv.MERGE_FAIL_WITH_ERROR:  /* Fail with an error. */
													UInvError('CopyItem failed. Item "' + NewItemName + '" already exists in destination bag "' + DestinationBagName + '".');  /* Error */
													Result = undefined;
													break;
												default:  /* UInv.MERGE_USE_ONLY_DESTINATION_PROPERTIES - Ignore source properties, just increment destination quantity. (default) */
													UInv.AddToItemPropertyValue(DestinationBagName, NewItemName, "UInvQuantity", Quantity);
													UInv.SetCurrentItemName(NewItemName);
													UInv.SetCurrentBagName(DestinationBagName);
													UInv.SetBagTouched(DestinationBagName);
													/* Success */
											}
											return Result;  /* Success or Error */
										} else {  /* Destination slot is empty, so copy item there. */
											if (ItemType !== "-") {
												RemoveItemObjectsDefaultProperties(Item, ItemType);
											}
											if (!UInv.isProperty(Item, "UInvVariableType")) {
												if (NewItemName !== ItemType) {
													if ((ItemType === "-") && (!UInv.GetDefaultItemObject(NewItemName))) {
														if (UInv.isProperty(Item, "UInvDefaultItemType")) {
															delete Item.UInvDefaultItemType;
														}
													} else {
														Item.UInvDefaultItemType = ItemType;
													}
												}
												if ((NewItemName === ItemType) && (UInv.isProperty(Item, "UInvDefaultItemType"))) {
													delete Item.UInvDefaultItemType;
												}
											}
											if (Item.UInvQuantity === 1) {
												delete Item.UInvQuantity;
											}
											State.variables.UInvBags[DestinationBagName][NewItemName] = Item;
											UInv.SetCurrentItemName(NewItemName);
											UInv.SetCurrentBagName(DestinationBagName);
											UInv.SetBagTouched(DestinationBagName);
											return NewItemName;  /* Success */
										}
									} else {
										UInvError('NewItemName passed to CopyItem is not a string.');  /* Error */
										return undefined;
									}
								} else {
									UInvError('CopyItem failed. SourceBagName cannot equal DestinationBagName if NewItemName is not set.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('CopyItem cannot find item "' + ItemName + '" in bag "' + SourceBagName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('CopyItem cannot find destination bag "' + DestinationBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('CopyItem cannot find source bag "' + SourceBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('CopyItem failed. ItemName cannot be "' + ItemName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to CopyItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveItem: Move item from source to destination, changing UInvQuantity if that parameter is used.  Use UInvMergeItemMethod to determine what happens on item collision. */
		MoveItem : function (SourceBagName, DestinationBagName, ItemName, Quantity, NewItemName) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName) && UInv.isString(ItemName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				ItemName = FixItemName(ItemName);
				if (!UInv.ReservedBagProperties.includes(ItemName)) {
					if (UInv.BagExists(SourceBagName)) {
						if (UInv.BagExists(DestinationBagName)) {
							if (UInv.BagHasItem(SourceBagName, ItemName)) {
								if (SourceBagName !== DestinationBagName) {
									if (UInv.ItemHasPocket(SourceBagName, ItemName)) {
										if (UInv.ContainerHasPocketBag(SourceBagName, ItemName, DestinationBagName)) {
											UInvError('MoveItem failed. Item cannot be moved inside of itself.');  /* Error */
											return undefined;
										}
									}
									var Count = UInv.BagHasItem(SourceBagName, ItemName);
									Quantity = tryIntParse(Quantity);
									if (UInv.isNumber(Quantity)) {
										Quantity = Math.round(Quantity);
										if (Quantity < 1) {
											Quantity = 1;
										}
										if (Quantity > Count) {
											Quantity = Count;
										}
									} else {
										Quantity = Count;
									}
									if (UInv.isUndefined(NewItemName)) {
										NewItemName = ItemName;
									} else if (UInv.isString(NewItemName)) {
										if (UInv.ReservedBagProperties.includes(NewItemName)) {
											UInvError('MoveItem failed. NewItemName cannot be "' + NewItemName + '".');  /* Error */
											return undefined;
										}
									} else {
										UInvError('NewItemName passed to MoveItem is not a string.');  /* Error */
										return undefined;
									}
									UInv.IncrementUpdateLock();
									var Result;
									if (UInv.ItemHasPocket(SourceBagName, ItemName)) {  /* Move pocketed item */
										if (UInv.BagHasItem(DestinationBagName, NewItemName)) {  /* Rename the item if there's already an item of that name in the destination bag */
											NewItemName = UInv.GetUniqueItemName();
										}
										Result = NewItemName;
										var DefaultType = UInv.GetItemsDefaultType(SourceBagName, ItemName);
										State.variables.UInvBags[DestinationBagName][NewItemName] = State.variables.UInvBags[SourceBagName][ItemName];
										delete State.variables.UInvBags[SourceBagName][ItemName];
										if (NewItemName == DefaultType) {  /* Make sure UInvDefaultItemType is set appropriately */
											if (UInv.isProperty(State.variables.UInvBags[DestinationBagName][NewItemName], "UInvDefaultItemType")) {
												delete State.variables.UInvBags[DestinationBagName][NewItemName].UInvDefaultItemType;
											}
										} else if (DefaultType != "-") {
											State.variables.UInvBags[DestinationBagName][NewItemName].UInvDefaultItemType = DefaultType;
										} else if (UInv.GetDefaultItemObject(DefaultType)) {
											State.variables.UInvBags[DestinationBagName][NewItemName].UInvDefaultItemType = DefaultType;
										} else if (UInv.isProperty(State.variables.UInvBags[DestinationBagName][NewItemName], "UInvDefaultItemType")) {
											delete State.variables.UInvBags[DestinationBagName][NewItemName].UInvDefaultItemType;
										}
										var Pockets = Object.keys(State.variables.UInvBags[DestinationBagName][NewItemName].UInvPocket), PocketBag, Container, i, j;
										for (i = 0; i < Pockets.length; i++) {  /* Update all pockets to refer to the new container location and name */
											PocketBag = State.variables.UInvBags[DestinationBagName][NewItemName].UInvPocket[Pockets[i]];
											Container = State.variables.UInvBags[PocketBag].UInvContainer;
											for (j = 0; j < Container.length; j++) {
												if ((Container[j].ContainerBagName == SourceBagName) && (Container[j].ContainerName == ItemName) && (Container[j].PocketName == Pockets[i])) {
													Container[j].ContainerBagName = DestinationBagName;
													Container[j].ContainerName = NewItemName;
												}
											}
										}
										UInv.SetBagTouched(DestinationBagName);
									} else {
										Result = UInv.CopyItem(SourceBagName, DestinationBagName, ItemName, Quantity, NewItemName);  /* Deals with possible item collisions */
										if (Quantity >= UInv.BagHasItem(SourceBagName, ItemName)) {
											UInv.DeleteItem(SourceBagName, ItemName);
										} else {
											UInv.AddToItemPropertyValue(SourceBagName, ItemName, "UInvQuantity", -Quantity);
										}
									}
									UInv.DecrementUpdateLock();
									UInv.SetCurrentItemName(NewItemName);
									UInv.SetCurrentBagName(DestinationBagName);
									return Result;  /* Success or Error  *** */
								} else {
									UInvError('MoveItem failed. SourceBagName cannot equal DestinationBagName.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('MoveItem cannot find item "' + ItemName + '" in bag "' + SourceBagName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('MoveItem cannot find destination bag "' + DestinationBagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveItem cannot find source bag "' + SourceBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveItem failed. ItemName cannot be "' + ItemName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* RenameItem: Renames an item.  Optional Quantity parameter if you want to rename partial stacks, defaults to all items. */
		RenameItem : function (BagName, CurrentItemName, NewItemName, Quantity) {
			if (UInv.isString(BagName) && UInv.isString(CurrentItemName) && UInv.isString(NewItemName)) {
				BagName = FixBagName(BagName);
				CurrentItemName = FixItemName(CurrentItemName);
				NewItemName = FixItemName(NewItemName);
				if ((!UInv.ReservedBagProperties.includes(CurrentItemName)) && (!UInv.ReservedBagProperties.includes(NewItemName))) {
					if (UInv.BagExists(BagName)) {
						if (UInv.BagHasItem(BagName, CurrentItemName)) {
							if (CurrentItemName === NewItemName) {
								return true;  /* Success - item already has that name */
							} else if (UInv.BagHasItem(BagName, NewItemName) && (State.variables.UInvMergeItemMethod === UInv.MERGE_FAIL_WITH_ERROR)) {
								UInvError('RenameItem failed. Item name "' + NewItemName + '" already exists in bag "' + BagName + '".');  /* Error */
								return undefined;
							} else {
								Quantity = tryIntParse(Quantity);
								if (UInv.isNumber(Quantity)) {
									Quantity = Math.round(Quantity);
									if (Quantity < 1) {
										Quantity = 1;
									}
									if (Quantity > UInv.BagHasItem(BagName, CurrentItemName)) {
										Quantity = UInv.BagHasItem(BagName, CurrentItemName);
									}
								} else {
									Quantity = UInv.BagHasItem(BagName, CurrentItemName);
								}
								var Result;
								if (UInv.ItemHasPocket(BagName, CurrentItemName)) {  /* Rename pocketed item */
									var DefaultType = UInv.GetItemsDefaultType(BagName, CurrentItemName);
									State.variables.UInvBags[BagName][NewItemName] = State.variables.UInvBags[BagName][CurrentItemName];
									delete State.variables.UInvBags[BagName][CurrentItemName];
									if (NewItemName == DefaultType) {  /* Make sure UInvDefaultItemType is set appropriately */
										if (UInv.isProperty(State.variables.UInvBags[BagName][NewItemName], "UInvDefaultItemType")) {
											delete State.variables.UInvBags[BagName][NewItemName].UInvDefaultItemType;
										}
									} else if (DefaultType != "-") {
										State.variables.UInvBags[BagName][NewItemName].UInvDefaultItemType = DefaultType;
									} else if (UInv.GetDefaultItemObject(DefaultType)) {
										State.variables.UInvBags[BagName][NewItemName].UInvDefaultItemType = DefaultType;
									} else if (UInv.isProperty(State.variables.UInvBags[BagName][NewItemName], "UInvDefaultItemType")) {
										delete State.variables.UInvBags[BagName][NewItemName].UInvDefaultItemType;
									}
									var Pockets = Object.keys(State.variables.UInvBags[BagName][NewItemName].UInvPocket), PocketBag, Container, i, j;
									for (i = 0; i < Pockets.length; i++) {  /* Update all pockets to refer to the new container name */
										PocketBag = State.variables.UInvBags[BagName][NewItemName].UInvPocket[Pockets[i]];
										Container = State.variables.UInvBags[PocketBag].UInvContainer;
										for (j = 0; j < Container.length; j++) {
											if ((Container[j].ContainerBagName == BagName) && (Container[j].ContainerName == CurrentItemName) && (Container[j].PocketName == Pockets[i])) {
												Container[j].ContainerName = NewItemName;
											}
										}
									}
									Result = NewItemName;
								} else {
									Result = UInv.CopyItem(BagName, BagName, CurrentItemName, Quantity, NewItemName);
									if (Result) {
										UInv.AddToItemPropertyValue(BagName, CurrentItemName, "UInvQuantity", -Quantity);
										UInv.SetCurrentItemName(Result);
										UInv.SetCurrentBagName(BagName);
									}
								}
								return Result;  /* Success */
							}
						} else {
							UInvError('RenameItem cannot find item "' + CurrentItemName + '" in bag "' + BagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('RenameItem cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('RenameItem failed. Item names cannot be "UInvTouched", "UInvProperties", "UInvDefaultBagType", or "UInvContainer".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to RenameItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetDefaultItemPropertyValue: Returns the default value for item's property, null if property or item isn't found, or undefined if there is an error. */
		GetDefaultItemPropertyValue : function (DefaultItemName, ItemPropertyName) {
			if (UInv.isString(DefaultItemName) && UInv.isString(ItemPropertyName)) {
				var DefItem = UInv.GetDefaultItemObject(DefaultItemName);
				if (DefItem) {
					if (UInv.isProperty(DefItem, ItemPropertyName)) {
						return DefItem[ItemPropertyName];  /* Success */
					} else {
						return null;  /* Success - item not found */
					}
				} else {
					return null;  /* Success - item not found */
				}
			} else {
				UInvError('Name passed to GetDefaultItemPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsAndQuantitiesObject: Returns an object of items and quantities in a bag in the format { item1: quantity1, item2: quantity2, etc... }, or undefined on error. */
		GetItemsAndQuantitiesObject : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName), Result = {}, i = 0;
					for (i = 0; i < Items.length; i++) {
						Result[Items[i]] = UInv.BagHasItem(BagName, Items[i]);
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsAndQuantitiesObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemsAndQuantitiesObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemCount: Returns the number of unique items in a bag (not including UInvTouched, UInvProperties, UInvDefaultBagType, or UInvContainer). */
		GetItemCount : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					return UInv.GetItemsArray(BagName).length;  /* Success */
				} else {
					UInvError('GetItemCount cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					var i = 0, Items = [];
					for (i = 0; i < BagName.length; i++) {
						Items = Items.concatUnique(UInv.GetItemsArray(BagName[i]));
					}
					return Items.length;  /* Success */
				} else {
					UInvError('GetItemCount failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemCount is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* GetItemCountFull: Returns the total number of items in a bag, adding up the UInvQuantity value of each item (not including UInvTouched, UInvProperties, and UInvDefaultBagType). */
		GetItemCountFull : function (BagName) {
			var Tot = 0, i = 0;
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName);
					if (Items.length > 0) {
						for (i = 0; i < Items.length; i++) {
							Tot += UInv.BagHasItem(BagName, Items[i]);
						}
					}
					return Tot;  /* Success */
				} else {
					UInvError('GetItemCountFull cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					for (i = 0; i < BagName.length; i++) {
						Tot += UInv.GetItemCountFull(BagName[i]);
					}
					return Tot;  /* Success */
				} else {
					UInvError('GetItemCountFull failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemCountFull is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* GetItemCountByDefaultType: Returns the number of unique item types in each bag (ignores Quantity), items with a default item type of "-" are each counted as separate unique item types. */
		GetItemCountByDefaultType : function (BagName, IgnoreTypes) {
			var Tot = 0, i = 0;
			if (UInv.isString(BagName)) {
				if (UInv.isUndefined(IgnoreTypes)) {
					IgnoreTypes = [];
				}
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), Typ;
					if (Items.length > 0) {
						if (!UInv.isArray(IgnoreTypes)) {
							IgnoreTypes = [];
						}
						for (i = 0; i < Items.length; i++) {
							Typ = UInv.GetItemsDefaultType(BagName, Items[i]);
							if (Typ === "-") {
								++Tot;
							} else if (IgnoreTypes.indexOf(Typ) < 0) {
								IgnoreTypes.push(Typ);
								++Tot;
							}
						}
					}
					return Tot;  /* Success */
				} else {
					UInvError('GetItemCountByDefaultType cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					var Ign = [];
					for (i = 0; i < BagName.length; i++) {
						Tot += UInv.GetItemCountByDefaultType(BagName[i], Ign);
					}
					return Tot;  /* Success */
				} else {
					UInvError('GetItemCountByDefaultType failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemCountByDefaultType is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* GetItemCountFullByDefaultType: Returns the total number of items in bag(s) (Quantity included) of that DefaultItemType. */
		GetItemCountFullByDefaultType : function (BagName, DefaultItemType) {
			if (UInv.isString(DefaultItemType)) {
				var Tot = 0, i = 0;
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						var Items = UInv.GetItemsArray(BagName);
						if (Items.length > 0) {
							for (i = 0; i < Items.length; i++) {
								if (UInv.GetItemsDefaultType(BagName, Items[i]) === DefaultItemType) {
									Tot += UInv.BagHasItem(BagName, Items[i]);
								}
							}
						}
						return Tot;  /* Success */
					} else {
						UInvError('GetItemCountFullByDefaultType cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						for (i = 0; i < BagName.length; i++) {
							Tot += UInv.GetItemCountFullByDefaultType(BagName[i], DefaultItemType);
						}
						return Tot;  /* Success */
					} else {
						UInvError('GetItemCountFullByDefaultType failed. Invalid bag name in array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to GetItemCountFullByDefaultType is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('DefaultItemType passed to GetItemCountFullByDefaultType is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayByType: Returns an array of all ItemNames in a bag that are of type ItemType. */
		GetItemsArrayByType : function (BagName, ItemType) {
			if (UInv.isString(BagName) && UInv.isString(ItemType)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName), Result = [], i;
					UInv.SetCurrentBagName(BagName);
					for (i = 0; i < Items.length; i++) {
						if (UInv.GetItemPropertyValue(BagName, Items[i], "UInvDefaultItemType") == ItemType) {
							Result.push(Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsArrayByType cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayByType is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemCountWherePropertyEquals: Gets the numer of items in a bag which have a particular property value. */
		GetItemCountWherePropertyEquals : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (arguments.length >= 3) {
						UInv.SetCurrentBagName(BagName);
						return UInv.GetItemsArrayWherePropertyEquals(BagName, ItemPropertyName, Value).length;  /* Success */
					} else {
						UInvError('GetItemCountWherePropertyEquals failed. Value parameter is missing.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemCountWherePropertyEquals cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					if (arguments.length >= 3) {
						var i = 0, Items = [];
						for (i = 0; i < BagName.length; i++) {
							Items = Items.concatUnique(UInv.GetItemsArray(BagName[i]));
						}
						return Items.length;  /* Success */
					} else {
						UInvError('GetItemCountWherePropertyEquals failed. Value parameter is missing.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemCountWherePropertyEquals failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemCountWherePropertyEquals is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWherePropertyGreaterThan: Returns an array of all items in a bag where ItemPropertyName > Value. */
		GetItemsArrayWherePropertyGreaterThan : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				if (arguments.length >= 3) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						var Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName), Result = [], i = 0;
						UInv.SetCurrentBagName(BagName);
						for (i = 0; i < Items.length; i++) {
							if (UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName) > Value) {
								Result.push(Items[i]);
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('GetItemsArrayWherePropertyGreaterThan cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemsArrayWherePropertyGreaterThan failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWherePropertyGreaterThan is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemCountWherePropertyGreaterThan: Gets the numer of items in a bag which have a particular property value greater than Value. */
		GetItemCountWherePropertyGreaterThan : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (arguments.length >= 3) {
						UInv.SetCurrentBagName(BagName);
						return UInv.GetItemsArrayWherePropertyGreaterThan(BagName, ItemPropertyName, Value).length;  /* Success */
					} else {
						UInvError('GetItemCountWherePropertyGreaterThan failed. Value parameter is missing.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemCountWherePropertyGreaterThan cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					if (arguments.length >= 3) {
						var i = 0, Items = [];
						for (i = 0; i < BagName.length; i++) {
							Items = Items.concatUnique(UInv.GetItemsArray(BagName[i]));
						}
						return Items.length;  /* Success */
					} else {
						UInvError('GetItemCountWherePropertyGreaterThan failed. Value parameter is missing.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemCountWherePropertyGreaterThan failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemCountWherePropertyGreaterThan is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWherePropertyLessThan: Returns an array of all items in a bag where ItemPropertyName > Value. */
		GetItemsArrayWherePropertyLessThan : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				if (arguments.length >= 3) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						var Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName), Result = [], i = 0;
						UInv.SetCurrentBagName(BagName);
						for (i = 0; i < Items.length; i++) {
							if (UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName) < Value) {
								Result.push(Items[i]);
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('GetItemsArrayWherePropertyLessThan cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemsArrayWherePropertyLessThan failed. Value parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWherePropertyLessThan is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemCountWherePropertyLessThan: Gets the numer of items in a bag which have a particular property value less than Value. */
		GetItemCountWherePropertyLessThan : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (arguments.length >= 3) {
						UInv.SetCurrentBagName(BagName);
						return UInv.GetItemsArrayWherePropertyLessThan(BagName, ItemPropertyName, Value).length;  /* Success */
					} else {
						UInvError('GetItemCountWherePropertyLessThan failed. Value parameter is missing.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemCountWherePropertyLessThan cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					if (arguments.length >= 3) {
						var i = 0, Items = [];
						for (i = 0; i < BagName.length; i++) {
							Items = Items.concatUnique(UInv.GetItemsArray(BagName[i]));
						}
						return Items.length;  /* Success */
					} else {
						UInvError('GetItemCountWherePropertyLessThan failed. Value parameter is missing.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemCountWherePropertyLessThan failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemCountWherePropertyLessThan is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* GetUniqueItemPropertyValuesArray: Returns an array of unique (string, number, and boolean) values for all items with ItemPropertyName in all bags in BagName/Array, or undefined on error. */
		/*                                   (use GetUniqueItemTagsArray instead for properties which have array values) */
		GetUniqueItemPropertyValuesArray : function (BagName, ItemPropertyName) {
			var i = 0, Items = [];
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Result = [], Value;
					Items = UInv.GetItemsArray(BagName);
					if (Items.length > 0) {
						for (i = 0; i < Items.length; i++) {
							if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
								Value = UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName);
								if (UInv.isString(Value) || UInv.isNumber(Value) || UInv.isBoolean(Value)) {
									Result.push(Value);
								}
							}
						}
					}
					return [].concatUnique(Result);  /* Success */
				} else {
					UInvError('GetUniqueItemPropertyValuesArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					for (i = 0; i < BagName.length; i++) {
						Items = Items.concatUnique(UInv.GetUniqueItemPropertyValuesArray(BagName[i], ItemPropertyName));
					}
					return Items;  /* Success */
				} else {
					UInvError('GetUniqueItemPropertyValuesArray failed. Invalid bag name in array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetUniqueItemPropertyValuesArray is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAnyItem: Returns t/f based on whether the bag has any of the items in the bag, or undefined if there is an error. */
		BagHasAnyItem : function (BagName, ItemArray) {
			var i = 0;
			if (UInv.isString(BagName)) {
				if (UInv.isArrayOfStrings(ItemArray)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						for (i = 0; i < ItemArray.length; i++) {
							if (UInv.BagHasItem(BagName, ItemArray[0])) {
								return true;  /* Success - found an item in the bag */
							}
						}
						return false;  /* Success - no items found */
					} else {
						UInvError('BagHasAnyItem cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemArray passed to BagHasAnyItem is not an array of strings.');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.BagExists(BagName)) {
					var Result = true;
					for (i = 0; i < BagName.length; i++) {
						Result = UInv.BagHasAnyItem(BagName[i], ItemArray);
					}
					return Result;  /* Success */
				} else {
					UInvError('BagHasAnyItem failed. Invalid bag name in BagName array.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to BagHasAnyItem is not a string or array of strings.');  /* Error */
				return undefined;
			}
		},

		/* AddToAllItemsPropertyValue: Adds an amount to a property's value for all of a bag's items which have the property (returns true), or undefined on error. */
		/*                             Does not touch bag unless UInvQuantity changed.  Deletes item if UInvQuantity would become <= 0. */
		AddToAllItemsPropertyValue : function (BagName, ItemPropertyName, Amount) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (ItemPropertyName === "UInvDefaultItemType") {
						UInvError('AddToAllItemsPropertyValue cannot be used to modify the value of UInvDefaultItemType. Use SetItemsDefaultType instead.');  /* Error */
						return undefined;
					}
					if (!UInv.isUndefined(Amount)) {
						Amount = tryIntParse(Amount);
						if (UInv.isNumber(Amount)) {
							if ((ItemPropertyName === "UInvQuantity") && (Amount !== Math.round(Amount))) {
								UInvError('AddToAllItemsPropertyValue failed. Value added to UInvQuantity must be an integer.');  /* Error */
								return undefined;
							} else {
								Amount = Math.round(Amount);
							}
							var Items = UInv.GetItemsArray(BagName), i;
							if ((ItemPropertyName === "UInvQuantity") && (UInv.GetAllBagPockets().length > 1)) {
								UInvError('AddToAllItemsPropertyValue failed. Items with pockets cannot have their quantity increased.');  /* Error */
								return undefined;
							}
							/* pre-error check here *** */
							for (i = 0; i < Items.length; i++) {
								UInv.AddToItemPropertyValue(BagName, Items[i], ItemPropertyName, Amount);
							}
							UInv.SetCurrentBagName(BagName);
							return true;  /* Success */
						} else {
							UInvError('AddToAllItemsPropertyValue failed. Amount is not a number.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('AddToAllItemsPropertyValue failed. Amount not defined.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('AddToAllItemsPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to AddToAllItemsPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* AddItem: Adds item to bag, returns true if successful.  Quantity defaults to 1.  Use UInvMergeItemMethod to determine what happens on item collision. */
		AddItem : function (BagName, ItemType, Quantity, NewItemName, StartDepth, CurrentDepth) {
			if (UInv.isString(BagName) && UInv.isString(ItemType)) {
				BagName = FixBagName(BagName);
				if (!UInv.isUndefined(ValidateItemName(ItemType))) {
					ItemType = FixItemName(ItemType);
					if (UInv.isUndefined(Quantity)) {
						Quantity = 1;
					} else {
						Quantity = tryIntParse(Quantity);
						if (!UInv.isNumber(Quantity)) {
							UInvError('Quantity passed to AddItem is not a number.');  /* Error */
							return undefined;
						}
					}
					if ((Quantity !== Math.round(Quantity)) || (Quantity <= 0)) {
						UInvError('Quantity passed to AddItem must be a positive integer.');  /* Error */
						return undefined;
					}
					if (UInv.BagExists(BagName)) {
						if (UInv.isUndefined(StartDepth)) {
							StartDepth = UInv.GetPocketDepth(BagName);
						}
						if (UInv.isUndefined(CurrentDepth)) {
							CurrentDepth = StartDepth;
						}
						var Item = UInv.GetDefaultItemObject(ItemType), TempBag = "", Result;
						if (Item) {
							if (UInv.isProperty(Item, "UInvPocket")) {
								Quantity = 1;  /* Items with pockets don't stack  ***  Make more? */
							}
							Item.UInvQuantity = Quantity;
							if (UInv.isProperty(Item, "UInvVariableType")) {
								Item.UInvDefaultItemType = ItemType;
							}
							if (UInv.isUndefined(NewItemName)) {
								NewItemName = ItemType;
							} else if (UInv.isString(NewItemName)) {
								NewItemName = FixItemName(NewItemName);
								if (UInv.isUndefined(NewItemName)) {
									return undefined;  /* Error */
								}
							} else {
								UInvError('AddItem failed. NewItemName is not a string.');  /* Error */
								return undefined;
							}
							UInv.IncrementUpdateLock();  /* Prevent unnecessary updates */
							TempBag = UInv.GetUniqueBagName();
							UInv.CreateBag(TempBag);
							if (Item.UInvQuantity === 1) {
								delete Item.UInvQuantity;
							}
							State.variables.UInvBags[TempBag][ItemType] = Item;
							if (UInv.isProperty(Item, "UInvPocket")) {  /* Create actual pockets on item */
								var Pockets = Item.UInvPocket, Keys = Object.keys(Pockets), i;
								var NotVarType = !UInv.isProperty(State.variables.UInvBags[TempBag][ItemType], "UInvVariableType");
								if (NotVarType) {
									State.variables.UInvBags[TempBag][ItemType].UInvVariableType = "x";  /* Temporarily make it a variable type so default pockets don't show for GetItemObject */
								}
								delete State.variables.UInvBags[TempBag][ItemType].UInvPocket;
								for (i = 0; i < Keys.length; i++) {
									if (["-", ""].includes(Pockets[Keys[i]])) {
										UInv.CreatePocket(TempBag, ItemType, Keys[i]);
									} else if (!UInv.AddPocket(TempBag, ItemType, Keys[i], Pockets[Keys[i]], StartDepth, CurrentDepth)) {
										if (UInv.isProperty(State.variables.UInvBags[TempBag][ItemType], "UInvPocket")) {
											delete State.variables.UInvBags[TempBag][ItemType].UInvPocket;
										}
										UInv.DeleteBag(TempBag);
										UInv.DecrementUpdateLock();
										UInvError('AddItem failed. ItemType "' + ItemType + '" has an invalid bag/pocket type of "' + Pockets[Keys[i]] + '".');  /* Error */
										return undefined;
									}
								}
								if (NotVarType) {
									delete State.variables.UInvBags[TempBag][ItemType].UInvVariableType;  /* Make it not a variable type, the way it should be */
								}
							}
							Result = UInv.MoveItem(TempBag, BagName, ItemType, Quantity, NewItemName);  /* Deals with possible item collisions */
							UInv.DeleteBag(TempBag);
							RemoveItemObjectsDefaultProperties(State.variables.UInvBags[BagName][Result], ItemType);
							UInv.SetCurrentBagName(BagName);
							UInv.SetCurrentItemName(ItemType);
							UInv.DecrementUpdateLock();
							return Result;  /* Success */
						} else {
							UInvError('AddItem failed. ItemType "' + ItemType + '" is not a default item.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('AddItem cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('AddItem failed. ItemType cannot be "' + ItemType + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to AddItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* AddItems: Adds an array of items to bag (Quantity = 1 for each), returns true if all items are successfully added. */
		AddItems : function (BagName, ItemArray) {
			if (UInv.isString(BagName)) {
				if (UInv.isArrayOfStrings(ItemArray)) {
					var Result = [], Ret, i;
					BagName = FixBagName(BagName);
					if (ItemArray.length > 0) {
						for (i = 0; i < ItemArray.length; i++) {
							Ret = UInv.AddItem(BagName, ItemArray[i]);
							if (Ret === undefined) {
								Result = undefined;
							} else if (!UInv.isBoolean(Result)) {
								Result.push(Ret);
							}
						}
						return Result;  /* Success or Error  *** */
					} else {
						UInvError('ItemArray passed to AddItems is empty.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemArray passed to AddItems is not an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to AddItems is not a string.');  /* Error */
				return undefined;
			}
		},

		/* CreateItem: Creates an item without linking to a DefaultItemObject.  Quantity defaults to 1. */
		CreateItem : function (BagName, ItemName, Quantity) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				if (!UInv.isUndefined(ValidateItemName(ItemName))) {
					ItemName = FixItemName(ItemName);
					if (UInv.BagExists(BagName)) {
						if (UInv.BagHasItem(BagName, ItemName)) {
							UInvError('CreateItem failed. Item "' + ItemName + '" already exists in bag "' + BagName + '".');  /* Error */
							return undefined;
						} else {
							if (UInv.isUndefined(Quantity)) {
								Quantity = 1;
							} else {
								Quantity = tryIntParse(Quantity);
								if (!UInv.isNumber(Quantity)) {
									UInvError('Quantity passed to CreateItem is not a number.');  /* Error */
									return undefined;
								}
							}
							if ((Quantity === Math.round(Quantity)) && (Quantity > 0)) {
								State.variables.UInvBags[BagName][ItemName] = {};
								if (Quantity > 1) {
									State.variables.UInvBags[BagName][ItemName].UInvQuantity = Quantity;
								}
								if (UInv.GetDefaultItemObject(ItemName)) {
									State.variables.UInvBags[BagName][ItemName].UInvDefaultItemType = "-";
								}
								UInv.SetBagTouched(BagName);
								UInv.SetCurrentBagName(BagName);
								UInv.SetCurrentItemName(ItemName);
								return ItemName;  /* Success */
							} else {
								UInvError('Quantity passed to CreateItem must be a positive integer.');  /* Error */
								return undefined;
							}
						}
					} else {
						UInvError('CreateItem cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('CreateItem failed. ItemName "' + ItemName + '" is not an allowed item name.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to CreateItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemPropertyCount: Returns the number of ItemName's item properties from BagName (including UInvQuantity and UInvDefaultItemType), or undefined if there is an error. */
		GetItemPropertyCount : function (BagName, ItemName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						UInv.SetCurrentItemName(ItemName);
						UInv.SetCurrentBagName(BagName);
						return Object.keys(UInv.GetItemObject(BagName, ItemName)).length;  /* Success */
					} else {
						UInvError('GetItemPropertyCount cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemPropertyCount cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemPropertyCount is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetItemsPropertyValue: Set the value of ItemPropertyName to Value for all items in BagName. */
		SetItemsPropertyValue : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				if (UInv.BagExists(BagName)) {
					if (arguments.length >= 3) {
						var Items = UInv.GetItemsArray(BagName);
						if (Items.length > 0) {
							var i = 0;
							for (i = 0; i < Items.length; i++) {
								UInv.SetItemPropertyValue(BagName, Items[i], ItemPropertyName, Value);
							}
						}
						return true;  /* Success */
					} else {
						UInvError('SetItemsPropertyValue failed. Value parameter is missing.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName "' + BagName + '" passed to SetItemsPropertyValue does not exist.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SetItemsPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetItemPropertyValues: Sets multiple property values on an item, creating those properties if they don't already exist. */
		SetItemPropertyValues : function (BagName, ItemName, ValuesObject) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.isGenericObject(ValuesObject)) {
							var Props = Object.keys(ValuesObject), Result = true;
							if (Props.length > 0) {
								var i = 0;
								for (i = 0; i < Props.length; i++) {
									/* Do some checking to make sure values are valid first  *** */
									if (UInv.SetItemPropertyValue(BagName, ItemName, Props[i], ValuesObject[Props[i]]) === undefined) {
										Result = undefined;
									}
								}
							}
							UInv.SetCurrentItemName(ItemName);
							UInv.SetCurrentBagName(BagName);
							return Result;  /* Success or Error  *** */
						} else {
							UInvError('ValuesObject passed to SetItemPropertyValues is not a generic object.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('SetItemPropertyValues cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName "' + BagName + '" passed to SetItemPropertyValues does not exist.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SetItemPropertyValues is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemPropertyHasValue: Returns true if item's property ===/contains Value, false if it doesn't, otherwise return undefined on error. */
		ItemPropertyHasValue : function (BagName, ItemName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						UInv.SetCurrentItemName(ItemName);
						UInv.SetCurrentBagName(BagName);
						if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
							if (arguments.length >= 4) {
								var Val = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);
								if (typeof(Val) === typeof(Value)) {
									return UInv.valuesAreEqual(Val, Value);  /* Success */
								} else if (UInv.isArray(Val)) {
									return Val.includes(Value);  /* Success */
								} else {
									return false;  /* Success */
								}
							} else {
								UInvError('ItemPropertyHasValue failed. Value parameter is missing.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('ItemPropertyHasValue cannot find property "' + ItemPropertyName + '" in item "' + ItemName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ItemPropertyHasValue cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemPropertyHasValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemPropertyHasValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* CopyItemsByProperty: Copy all items from SourceBagName to DestinationBagName that have the ItemPropertyName, or ItemPropertyName === Value if Value is passed. */
		CopyItemsByProperty : function (SourceBagName, DestinationBagName, ItemPropertyName, Value) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName) && UInv.isString(ItemPropertyName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						if (SourceBagName !== DestinationBagName) {
							if (arguments.length >= 4) {
								var Items = [], Result = [];
								if (UInv.isUndefined(Value)) {
									Items = UInv.GetItemsArrayByProperty(SourceBagName, ItemPropertyName);
								} else {
									Items = UInv.GetItemsArrayWherePropertyEquals(SourceBagName, ItemPropertyName, Value);
								}
								if (Items.length > 0) {
									var i = 0, Ret = "";
									for (i = 0; i < Items.length; i++) {
										Ret = UInv.CopyItem(SourceBagName, DestinationBagName, Items[i]);
										if (Ret === undefined) {
											Result = undefined;
										} else if (!UInv.isBoolean(Result)) {
											Result.push(Ret);
										}
									}
								}
								return Result;  /* Success or Error  *** */
							} else {
								UInvError('CopyItemsByProperty failed. Value parameter is missing.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('CopyItemsByProperty failed. Source and destination bags cannot be the same.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('CopyItemsByProperty cannot find bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('CopyItemsByProperty cannot find bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to CopyItemsByProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteItemsByProperty: Delete all items from BagName that have the ItemProperty, or ItemProperty === Value if Value is passed. */
		DeleteItemsByProperty : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = [];
					if (arguments.length >= 3) {
						Items = UInv.GetItemsArrayWherePropertyEquals(BagName, ItemPropertyName, Value);
					} else {
						Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName);
					}
					return UInv.DeleteItem(BagName, Items);  /* Success */
				} else {
					UInvError('DeleteItemsByProperty cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to DeleteItemsByProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemWithHighestPropertyValue: Returns the ItemName with the highest value of ItemPropertyName in BagName (items without ItemPropertyName are ignored), */
		/*                                  randomly picks one of the highest if multiple items are tied for highest, "" if none found, or undefined on error. */
		GetItemWithHighestPropertyValue : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName);
					if (Items.length > 0) {
						var HiItems = [ Items[0] ], HiVal = UInv.GetItemPropertyValue(BagName, Items[0], ItemPropertyName);
						if (Items.length > 1) {
							var i, Value = 0;
							for (i = 1; i < Items.length; i++) {
								Value = UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName);
								if (Value > HiVal) {
									HiVal = Value;
									HiItems = [ Items[i] ];
								} else if (Value === HiVal) {
									HiItems.push(Items[i]);
								}
							}
						}
						UInv.SetCurrentBagName(BagName);
						return HiItems.random();  /* Success */
					} else {
						return "";  /* Success - Not found */
					}
				} else {
					UInvError('GetItemWithHighestPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemWithHighestPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemWithLowestPropertyValue: Returns the ItemName with the lowest value of ItemPropertyName in BagName (items without ItemPropertyName are ignored), */
		/*                                 randomly picks one of the lowest if multiple items are tied for lowest, "" if none found, or undefined on error. */
		GetItemWithLowestPropertyValue : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName);
					if (Items.length > 0) {
						var LoItems = [ Items[0] ], LoVal = UInv.GetItemPropertyValue(BagName, Items[0], ItemPropertyName);
						if (Items.length > 1) {
							var i, Value = 0;
							for (i = 1; i < Items.length; i++) {
								Value = UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName);
								if (Value < LoVal) {
									LoVal = Value;
									LoItems = [ Items[i] ];
								} else if (Value === LoVal) {
									LoItems.push(Items[i]);
								}
							}
						}
						UInv.SetCurrentBagName(BagName);
						return LoItems.random();  /* Success */
					} else {
						return "";  /* Success - Not found */
					}
				} else {
					UInvError('GetItemWithLowestPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemWithLowestPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetRandomItemPropertyValue: Returns the value of ItemPropertyName for a random item in BagName (items without ItemPropertyName are ignored), "" if none found, or undefined on error. */
		GetRandomItemPropertyValue : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName);
					if (Items.length > 0) {
						return UInv.GetItemPropertyValue(BagName, Items.random(), ItemPropertyName);  /* Success */
					} else {
						return "";  /* Success - Not found */
					}
				} else {
					UInvError('GetRandomItemPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetRandomItemPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetTotalItemPropertyValue: Returns the total of all items' ItemPropertyName values (multiplied by UInvQuantity) added together */
		/*                            (all values must be numbers; items without ItemPropertyName are treated as having a value of zero) */
		GetTotalItemPropertyValue : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName), i = 0, Value = 0, Result = 0;
					if (Items.length > 0) {
						for (i = 1; i < Items.length; i++) {
							if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
								Value = UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName);
								if (UInv.isNumber(Value)) {
									Result += (Value * UInv.BagHasItem(BagName, Items[i]));
								} else {
									UInvError('GetTotalItemPropertyValue failed. All values of ItemPropertyName must be numbers. ("' + Items[i] + '.' + ItemPropertyName + '" is type ' + (typeof Value)  + ')');  /* Error */
									return undefined;
								}
							}
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetTotalItemPropertyValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetTotalItemPropertyValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteItemProperty: Deletes item property ItemPropertyName.  If ItemPropertyName is not passed, then delete all properties on ItemName, except UInvQuantity, and set UInvDefaultItemType to "-". */
		/*                     Cannot delete UInvQuantity, UInvDefaultItemType, or UInvPocket.  Returns true if successful, otherwise false. */
		DeleteItemProperty : function (BagName, ItemName, ItemPropertyName) {
			if (UInv.isString(ItemName)) {
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					ItemName = FixItemName(ItemName);
					if (UInv.BagExists(BagName)) {
						var Quantity = UInv.BagHasItem(BagName, ItemName), Item;
						if (Quantity) {
							if (UInv.isString(ItemPropertyName)) {
								UInv.SetCurrentItemName(ItemName);
								UInv.SetCurrentBagName(BagName);
								if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
									if (UInv.ReservedItemProperties.includes(ItemPropertyName)) {
										UInvError('DeleteItemProperty cannot delete property "' + ItemPropertyName + '". This is a protected property.');  /* Error */
										return undefined;
									}
									if (!UInv.isProperty(State.variables.UInvBags[BagName][ItemName], ItemPropertyName)) {  /* Change item type to "-" so it can remove default properties */
										UInv.SetItemsDefaultType(BagName, ItemName, "-");
									}
									delete State.variables.UInvBags[BagName][ItemName][ItemPropertyName];
									return true;  /* Success */
								} else {
									return true;  /* Success - property already doesn't exist */
								}
							} else if (UInv.isUndefined(ItemPropertyName)) {
								/* Delete all properties except ReservedItemProperties */
								Item = {};
								if (Quantity > 1) {
									Item.UInvQuantity = Quantity;
								}
								if (UInv.GetDefaultItemObject(ItemName)) {
									Item.UInvDefaultItemType = "-";
								}
								if (UInv.isProperty(State.variables.UInvBags[BagName][ItemName], "UInvPocket")) {
									Item.UInvPocket = State.variables.UInvBags[BagName][ItemName].UInvPocket;
								}
								if (UInv.isProperty(State.variables.UInvBags[BagName][ItemName], "UInvCell")) {
									Item.UInvCell = State.variables.UInvBags[BagName][ItemName].UInvCell;
								}
								State.variables.UInvBags[BagName][ItemName] = Item;
								return true;  /* Success */
							} else {
								UInvError('ItemPropertyName passed to DeleteItemProperty is not a string.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('DeleteItemProperty cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('DeleteItemProperty cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var i = 0, Result = true;
						for (i = 0; i < BagName.length; i++) {
							if (!UInv.DeleteItemProperty(BagName[i], ItemName, ItemPropertyName)) {  /* handle errors here better?  *** */
								Result = undefined;
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('DeleteItemProperty failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('DeleteItemProperty cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('ItemName passed to DeleteItemProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveItemsByProperty: Move all items from SourceBagName to DestinationBagName that have the ItemPropertyName, or ItemPropertyName === Value if Value is passed. */
		MoveItemsByProperty : function (SourceBagName, DestinationBagName, ItemPropertyName, Value) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName) && UInv.isString(ItemPropertyName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						if (SourceBagName !== DestinationBagName) {
							if (arguments.length >= 4) {
								var Items = [], Result = true;
								if (UInv.isUndefined(Value)) {
									Items = UInv.GetItemsArrayByProperty(SourceBagName, ItemPropertyName);
								} else {
									Items = UInv.GetItemsArrayWherePropertyEquals(SourceBagName, ItemPropertyName, Value);
								}
								if (Items.length > 0) {
									var i = 0, Ret = "";
									for (i = 0; i < Items.length; i++) {
										Ret = UInv.MoveItem(SourceBagName, DestinationBagName, Items[i]);
										if (UInv.isUndefined(Ret) || UInv.isUndefined(Result)) {
											Result = undefined;
										} else {
											if (UInv.isBoolean(Result)) {
												Result = [ Ret ];
											} else {
												Result.push(Ret);
											}
										}
									}
								}
								return Result;  /* Success or Error  *** */
							} else {
								UInvError('MoveItemsByProperty failed. Value parameter is missing.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('MoveItemsByProperty failed. Source and destination bags cannot be the same.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveItemsByProperty cannot find bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveItemsByProperty cannot find bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveItemsByProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* RenameItemProperty: Renames item property.  Returns true if it succeeds.  Bag is not touched. */
		RenameItemProperty : function (BagName, ItemName, CurrentItemPropertyName, NewItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(CurrentItemPropertyName) && UInv.isString(NewItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (!UInv.ReservedBagProperties.includes(ItemName)) {
					if ((CurrentItemPropertyName !== "UInvQuantity") && (NewItemPropertyName !== "UInvQuantity")) {
						if (UInv.BagExists(BagName)) {
							if (UInv.BagHasItem(BagName, ItemName)) {
								if (UInv.ItemHasProperty(BagName, ItemName, CurrentItemPropertyName)) {
									if (UInv.ItemHasProperty(BagName, ItemName, NewItemPropertyName)) {
										UInvError('RenameItemProperty failed. Property "' + NewItemPropertyName + '" already exists on item "' + ItemName + '".');  /* Error */
										return undefined;
									} else if (CurrentItemPropertyName === NewItemPropertyName) {
										UInvError('RenameItemProperty failed. CurrentItemPropertyName cannot be the same as NewItemPropertyName.');  /* Error */
										return undefined;
									} else {
										UInv.SetCurrentItemName(ItemName);
										UInv.SetCurrentBagName(BagName);
										Object.defineProperty(State.variables.UInvBags[BagName][ItemName], NewItemPropertyName, Object.getOwnPropertyDescriptor(State.variables.UInvBags[BagName][ItemName], CurrentItemPropertyName));
										delete State.variables.UInvBags[BagName][ItemName][CurrentItemPropertyName];
										return true;  /* Success */
									}
								} else {
									UInvError('RenameItemProperty cannot find property "' + CurrentItemPropertyName + '" in item "' + ItemName + '".');  /* Error */
									return undefined;
								}
							} else {
								UInvError('RenameItemProperty cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('RenameItemProperty cannot find bag "' + BagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('RenameItemProperty failed. ItemPropertyName cannot be "UInvQuantity".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('RenameItemProperty failed. ItemName cannot be "' + ItemName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to RenameItemProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetObjectOfItemPropertyValues: Returns an object in the format { ItemName : Value, ... } for each item in bag that has a property of ItemPropertyName. */
		GetObjectOfItemPropertyValues : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName), ItemValues = {}, i = 0;
					UInv.SetCurrentBagName(BagName);
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
							ItemValues[Items[i]] = UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName);
						}
					}
					return ItemValues;  /* Success */
				} else {
					UInvError('GetObjectOfItemPropertyValues cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetObjectOfItemPropertyValues is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetAllPropertyValues: Returns an array of all unique values of the items' ItemPropertyName in a bag. */
		GetAllPropertyValues : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName), Values = [], i = 0;
					UInv.SetCurrentBagName(BagName);
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
							Values.pushUnique(UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName));
						}
					}
					return Values;  /* Success */
				} else {
					UInvError('GetAllPropertyValues cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetAllPropertyValues is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemByProperty: Returns a random item from a bag that has property ItemPropertyName.  Sets that item as the current item. */
		GetItemByProperty : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArrayByProperty(BagName, ItemPropertyName);
					UInv.SetCurrentBagName(BagName);
					if (Items.length > 0) {
						var Rnd = random(Items.length - 1);
						UInv.SetCurrentItemName(Items[Rnd]);
						return Items[Rnd];  /* Success */
					} else {
						return "";  /* Success */
					}
				} else {
					UInvError('GetItemByProperty cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemByProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemByType: Returns a random ItemName from a bag that is of type ItemType.  Sets that item as the current item. */
		GetItemByType : function (BagName, ItemType) {
			if (UInv.isString(BagName) && UInv.isString(ItemType)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArrayByType(BagName, ItemType);
					UInv.SetCurrentBagName(BagName);
					if (Items.length > 0) {
						var Rnd = random(Items.length - 1);
						UInv.SetCurrentItemName(Items[Rnd]);
						return Items[Rnd];  /* Success */
					} else {
						return "";  /* Success */
					}
				} else {
					UInvError('GetItemByType cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemByType is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetRandomItemValue: Returns a random value of an item's ItemPropertyName in a bag if it has that property.  Sets that item as the current item. */
		GetRandomItemValue : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Item = UInv.GetItemByProperty(BagName, ItemPropertyName);
					UInv.SetCurrentBagName(BagName);
					if (Item) {
						UInv.SetCurrentItemName(Item);
						return UInv.GetItemPropertyValue(BagName, Item, ItemPropertyName);  /* Success */
					} else {
						return "";  /* Success */
					}
				} else {
					UInvError('GetRandomItemValue cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetRandomItemValue is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemWherePropertyEquals: Returns a random ItemName from a bag where ItemPropertyName === Value.  Sets that item as the current item. */
		GetItemWherePropertyEquals : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				if (!UInv.isUndefined(Value)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						if (arguments.length >= 3) {
							var Items = UInv.GetItemsArrayWherePropertyEquals(BagName, ItemPropertyName, Value);
							UInv.SetCurrentBagName(BagName);
							if (Items.length > 0) {
								var Rnd = random(Items.length - 1);
								UInv.SetCurrentItemName(Items[Rnd]);
								return Items[Rnd];  /* Success */
							} else {
								return "";  /* Success */
							}
						} else {
							UInvError('GetItemWherePropertyEquals failed. Value parameter is missing.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetItemWherePropertyEquals cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemWherePropertyEquals failed. Value parameter is undefined.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemWherePropertyEquals is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemWherePropertyGreaterThan: Returns a random ItemName from a bag where ItemPropertyName === Value.  Sets that item as the current item. */
		GetItemWherePropertyGreaterThan : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				if (!UInv.isUndefined(Value)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						var Items = UInv.GetItemsArrayWherePropertyGreaterThan(BagName, ItemPropertyName, Value);
						UInv.SetCurrentBagName(BagName);
						if (Items.length > 0) {
							var Rnd = random(Items.length - 1);
							UInv.SetCurrentItemName(Items[Rnd]);
							return Items[Rnd];  /* Success */
						} else {
							return "";  /* Success */
						}
					} else {
						UInvError('GetItemWherePropertyGreaterThan cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemWherePropertyGreaterThan failed. Value parameter is undefined.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemWherePropertyGreaterThan is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemWherePropertyLessThan: Returns a random ItemName from a bag where ItemPropertyName === Value.  Sets that item as the current item. */
		GetItemWherePropertyLessThan : function (BagName, ItemPropertyName, Value) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				if (!UInv.isUndefined(Value)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						var Items = UInv.GetItemsArrayWherePropertyLessThan(BagName, ItemPropertyName, Value);
						UInv.SetCurrentBagName(BagName);
						if (Items.length > 0) {
							var Rnd = random(Items.length - 1);
							UInv.SetCurrentItemName(Items[Rnd]);
							return Items[Rnd];  /* Success */
						} else {
							return "";  /* Success */
						}
					} else {
						UInvError('GetItemWherePropertyLessThan cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemWherePropertyLessThan failed. Value parameter is undefined.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemWherePropertyLessThan is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetRandomItem: Returns a random ItemName from the bag.  Sets that item as the current item. */
		GetRandomItem : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName);
					UInv.SetCurrentBagName(BagName);
					if (Items.length > 0) {
						var Rnd = random(Items.length - 1);
						UInv.SetCurrentItemName(Items[Rnd]);
						return Items[Rnd];  /* Success */
					} else {
						return "";  /* Success */
					}
				} else {
					UInvError('GetRandomItem cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetRandomItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ResetItemProperties: Removes all properties from an item (except UInvQuantity and UInvPocket if it exists).  If DefaultItemType is passed then it loads the default properties of that item. */
		ResetItemProperties : function (BagName, ItemName, DefaultItemType) {
			if (UInv.isString(ItemName)) {
				var i;
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					ItemName = FixItemName(ItemName);
					if (UInv.BagExists(BagName)) {
						var Quantity = UInv.BagHasItem(BagName, ItemName);
						if (Quantity) {
							var hasPockets = false, Pockets, NewPockets, NewItemName;
							if (UInv.isUndefined(DefaultItemType)) {
								DefaultItemType = UInv.GetItemsDefaultType(BagName, ItemName);
								if (DefaultItemType) {
									if (UInv.ItemHasPocket(BagName, ItemName)) {  /* Keep current pockets */
										hasPockets = true;
										Quantity = 1;
										Pockets = UInv.GetItemPocketObject(BagName, ItemName);
										UInv.UnlinkPocketFromContainer(BagName, ItemName);
									}
									UInv.DeleteItem(BagName, ItemName);
									UInv.SetCurrentBagName(BagName);
									UInv.SetCurrentItemName(ItemName);
									NewItemName = UInv.AddItem(BagName, DefaultItemType, Quantity, ItemName);  /* Success */
									if (hasPockets) {  /* Restore pockets */
										if (UInv.ItemHasPocket(BagName, NewItemName)) {  /* Delete new pockets */
											NewPockets = UInv.GetItemPocketNameArray(BagName, NewItemName);
											for (i = 0; i < NewPockets.length; i++) {
												UInv.DeletePocket(BagName, NewItemName, NewPockets[i]);
											}
										}
										NewPockets = Object.keys(Pockets);
										for (i = 0; i < NewPockets.length; i++) {  /* Restore old pockets */
											UInv.AddExistingBagAsPocket(BagName, NewItemName, NewPockets[i], Pockets[NewPockets[i]]);
										}
									}
									return true;  /* Success */
								} else {
									UInvError('ResetItemProperties failed. Item does not have a default type.');  /* Error */
									return undefined;
								}
							} else if (UInv.isString(DefaultItemType)) {
								if (UInv.GetDefaultItemObject(DefaultItemType)) {
									if (UInv.ItemHasPocket(BagName, ItemName)) {  /* Keep current pockets */
										hasPockets = true;
										Quantity = 1;
										Pockets = UInv.GetItemPocketObject(BagName, ItemName);
										UInv.UnlinkPocketFromContainer(BagName, ItemName);
									}
									UInv.DeleteItem(BagName, ItemName);
									NewItemName = UInv.AddItem(BagName, DefaultItemType, Quantity, ItemName);
									if (hasPockets) {  /* Restore pockets */
										if (UInv.ItemHasPocket(BagName, NewItemName)) {  /* Delete new pockets */
											NewPockets = UInv.GetItemPocketNameArray(BagName, NewItemName);
											for (i = 0; i < NewPockets.length; i++) {
												UInv.DeletePocket(BagName, NewItemName, NewPockets[i]);
											}
										}
										NewPockets = Object.keys(Pockets);
										for (i = 0; i < NewPockets.length; i++) {  /* Restore old pockets */
											UInv.AddExistingBagAsPocket(BagName, NewItemName, NewPockets[i], Pockets[NewPockets[i]]);
										}
									}
									return true;  /* Success */
								} else {
									UInvError('ResetItemProperties failed. DefaultItemType "' + DefaultItemType + '" is not a default item.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('DefaultItemType passed to ResetItemProperties is not a string.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('ResetItemProperties cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ResetItemProperties cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var Result = true;
						for (i = 0; i < BagName.length; i++) {
							Result = UInv.ResetItemProperties(BagName[i], ItemName, DefaultItemType);
						}
						return Result;  /* Success */
					} else {
						UInvError('ResetItemProperties failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to ResetItemProperties is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('ItemName passed to ResetItemProperties is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWhereItemNameContains: Returns an array of ItemNames where item's name contains the substring    *** use RegExp matching? */
		GetItemsArrayWhereItemNameContains : function (BagName, SubString) {
			if (UInv.isString(BagName) && UInv.isString(SubString)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName);
					UInv.SetCurrentBagName(BagName);
					if (Items.length > 0) {
						var Result = [], i = 0;
						for (i = 0; i < Items.length; i++) {
							if (Items[i].includes(SubString.toLowerCase())) {
								Result.push(Items[i]);
							}
						}
						return Result;  /* Success */
					} else {
						return [];  /* Success */
					}
				} else {
					UInvError('GetItemsArrayWhereItemNameContains cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Parameter passed to GetItemsArrayWhereItemNameContains is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWherePropertyValueContains: Returns an array of ItemNames where item's ItemPropertyName contains the substring    *** use RegExp matching? */
		GetItemsArrayWherePropertyValueContains : function (BagName, ItemPropertyName, SubString, CaseSensitive) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName) && UInv.isString(SubString)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName);
					UInv.SetCurrentBagName(BagName);
					if (Items.length > 0) {
						var Result = [], i = 0;
						if (UInv.isUndefined(CaseSensitive)) {
							CaseSensitive = false;
						}
						for (i = 0; i < Items.length; i++) {
							if (UInv.ItemHasProperty(BagName, ItemPropertyName)) {
								if (CaseSensitive) {
									if (UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName).includes(SubString)) {
										Result.push(Items[i]);
									}
								} else {
									if (UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName).toLowerCase().includes(SubString.toLowerCase())) {
										Result.push(Items[i]);
									}
								}
							}
						}
						return Result;  /* Success */
					} else {
						return [];  /* Success */
					}
				} else {
					UInvError('GetItemsArrayWherePropertyValueContains cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Parameter passed to GetItemsArrayWherePropertyValueContains is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemPropertyValueObject: Returns an object in the format { ItemName : ItemPropertyName's value, ... } for each item in BagName that has the property ItemPropertyName. */
		/*                             Items that don't have ItemPropertyName are ignored. */
		GetItemPropertyValueObject : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName);
					UInv.SetCurrentBagName(BagName);
					if (Items.length > 0) {
						var Result = {}, i = 0;
						for (i = 0; i < Items.length; i++) {
							if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
								Result[Items[i]] = ItemPropertyName;
							}
						}
						return Result;  /* Success */
					} else {
						return {};  /* Success */
					}
				} else {
					UInvError('GetItemPropertyValueObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Parameter passed to GetItemPropertyValueObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArraySortedByProperty: Returns an array of item names in BagName, sorted by the value in ItemPropertyName (subsorted by ItemName), or by ItemName if ItemPropertyName isn't set. */
		/*         The array is sorted by number or boolean if all item property values are of that type, otherwise it converts non-strings to strings and does a lowercase comparison. */
		/*         Items that don't have ItemPropertyName are ignored. */
		GetItemsArraySortedByProperty : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName);
					UInv.SetCurrentBagName(BagName);
					if (Items.length > 0) {
						if (!UInv.isUndefined(ItemPropertyName)) {
							var Result = [], Key = [], i = 0, temp = [], ChangeType = true;
							temp = UInv.GetAllPropertyValues(BagName, ItemPropertyName);
							if (UInv.isArrayOfNumbers(temp) || UInv.isArrayOfBooleans(temp)) {
								ChangeType = false;
							}
							for (i = 0; i < Items.length; i++) {
								if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
									Result[i] = Items[i];
									temp = UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName);
									if (ChangeType && !UInv.isString(temp)) {
										temp = temp.toString();
									}
									if (UInv.isString(temp)) {
										temp = temp.toLowerCase();
									}
									Key[i] = temp;
								}
							}
							return UInv.getArraySortedByOtherArray(Result, Key);  /* Success */
						} else {
							return Items.sort( function compare(a, b) {  /* String sort function; a & b are item names, so they will always be strings */
								if (a.toLowerCase() < b.toLowerCase()) {
									return -1;
								}
								if (a.toLowerCase() > b.toLowerCase()) {
									return 1;
								}
								return 0;  /* a === b */
							});  /* Success */
						}
					} else {
						return [];  /* Success */
					}
				} else {
					UInvError('GetItemsArraySortedByProperty cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemsArraySortedByProperty is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemCountByFunction: Returns the sum of the values returned by function (function is passed BagName) or undefined on error. */
		GetItemCountByFunction : function (BagName, CountFunction) {
			var tmp;
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.isFunction(CountFunction)) {
						UInv.SetCurrentBagName(BagName);
						tmp = CountFunction(BagName);
						if (UInv.isUndefined(tmp)) {
							UInv.Error("Error: GetItemCountByFunction failed. CountFunction's return value is undefined.");  /* Error */
							return undefined;
						}
						return tmp;  /* Success */
					} else {
						UInvError('CountFunction passed to GetItemCountByFunction is not a function.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemCountByFunction cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else if (UInv.isArrayOfStrings(BagName)) {
				if (UInv.isFunction(CountFunction)) {
					var i = 0, Result = 0;
					if (BagName.length > 0) {
						for (i = 0; i < BagName.length; i++) {
							if (UInv.BagExists(BagName[i])) {
								tmp = CountFunction(BagName);
								if (UInv.isUndefined(tmp)) {
									UInv.Error("Error: GetItemCountByFunction failed. CountFunction's return value is undefined.");  /* Error */
									return undefined;
								}
								Result += tmp;
							} else {
								UInvError('GetItemCountByFunction cannot find bag "' + BagName + '".');  /* Error */
								return undefined;
							}
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('CountFunction passed to GetItemCountByFunction is not a function.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemCountByFunction is not a string or an array of strings.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayByFunction: Returns an array of items where function is true (function is passed BagName and ItemName strings) or undefined on error. */
		GetItemsArrayByFunction : function (BagName, SelectionFunction) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.isFunction(SelectionFunction)) {
						var Items = UInv.GetItemsArray(BagName), i = 0, tmp, Result = [];
						UInv.SetCurrentBagName(BagName);
						if (Items.length > 0) {
							for (i = 0; i < Items.length; i++) {
								tmp = SelectionFunction(BagName, Items[i]);
								if (UInv.isUndefined(tmp)) {
									UInv.Error("Error: GetItemsArrayByFunction failed. SelectionFunction's return value is undefined.");  /* Error */
									return undefined;
								}
								if (tmp) {
									Result.push([Items[i]]);
								}
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('SelectionFunction passed to GetItemsArrayByFunction is not a function.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemsArrayByFunction cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemsArrayByFunction is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArraySortedByFunction: Returns an array of ItemNames sorted by the SortFunction function, or undefined on error. */
		/*                                The SortFunction will be passed the parameters (BagName, ItemName1, ItemName2), and */
		/*                                if the function returns a "truthy" value, then those two items will be swapped in the array. */
		GetItemsArraySortedByFunction : function (BagName, SortFunction) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.isFunction(SortFunction)) {
						var Items = UInv.GetItemsArray(BagName), tmp, i = 0, n = 0, Continue = true;
						UInv.SetCurrentBagName(BagName);
						if (Items.length > 0) {
							while ((n <= Items.length) && Continue) {
								Continue = false;
								for (i = 0; i < Items.length - 1; i++) {
									tmp = SortFunction(BagName, Items[i], Items[i + 1]);
									if (UInv.isUndefined(tmp)) {
										UInv.Error("Error: GetItemsArraySortedByFunction failed. SortFunction's return value is undefined.");  /* Error */
										return undefined;
									}
									if (tmp) {
										Continue = true;
										tmp = Items[i];
										Items[i] = Items[i + 1];
										Items[i + 1] = tmp;
									}
								}
								n++;
							}
						}
						if (n > Items.length) {
							UInvError('GetItemsArraySortedByFunction failed. SortFunction is not returning consistent results.');  /* Error */
							return undefined;
						} else {
							return Items;  /* Success */
						}
					} else {
						UInvError('SortFunction passed to GetItemsArraySortedByFunction is not a function.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemsArraySortedByFunction cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to GetItemsArraySortedByFunction is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemHasAllProperties: Returns whether all of the item's properties are listed in ItemPropertyNameArray, false if the item has no properties, or undefined on error. */
		ItemHasAllProperties : function (BagName, ItemName, ItemPropertyNameArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.isArrayOfStrings(ItemPropertyNameArray)) {
							var Props = UInv.GetItemPropertiesArray(BagName, ItemName);
							if (!UInv.isArray(ItemPropertyNameArray)) {
								ItemPropertyNameArray = [ ItemPropertyNameArray ];
							}
							if ((Props.length > 0) && (ItemPropertyNameArray.length > 0)) {
								var i;
								for (i = 0; i < Props.length; i++) {
									if (!ItemPropertyNameArray.includes(Props[i])) {
										return false;  /* Success */
									}
								}
								return true;  /* Success */
							}
							return false;  /* Success */
						} else {
							UInvError('ItemHasAllProperties failed. ItemPropertyNameArray is not an array of strings.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ItemHasAllProperties cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemHasAllProperties cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemHasAllProperties is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemHasAnyProperties: Returns whether any of the item's properties are listed in ItemPropertyNameArray, false if the item has no properties, or undefined on error. */
		ItemHasAnyProperties : function (BagName, ItemName, ItemPropertyNameArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.isArrayOfStrings(ItemPropertyNameArray)) {
							var Props = UInv.GetItemPropertiesArray(BagName, ItemName);
							if (!UInv.isArray(ItemPropertyNameArray)) {
								ItemPropertyNameArray = [ ItemPropertyNameArray ];
							}
							if ((Props.length > 0) && (ItemPropertyNameArray.length > 0)) {
								var i;
								for (i = 0; i < Props.length; i++) {
									if (ItemPropertyNameArray.includes(Props[i])) {
										return true;  /* Success */
									}
								}
							}
							return false;  /* Success */
						} else {
							UInvError('ItemHasAnyProperties failed. ItemPropertyNameArray is not an array of strings.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ItemHasAnyProperties cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemHasAnyProperties cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemHasAnyProperties is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWithAllProperties: Returns an array of all items which have all of the properties in ItemPropertyNameArray (per the ItemHasAllProperties function), or undefined on error. */
		/*                                 Items which have no properties will not be included. */
		GetItemsArrayWithAllProperties : function (BagName, ItemPropertyNameArray) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.isString(ItemPropertyNameArray)) {
						ItemPropertyNameArray = [ ItemPropertyNameArray ];
					}
					if (UInv.isArrayOfStrings(ItemPropertyNameArray)) {
						var Items = UInv.GetItemsArray(BagName), Result = [], i;
						for (i = 0; i < Items.length; i++) {
							if (UInv.ItemHasAllProperties(BagName, Items[i], ItemPropertyNameArray)) {
								Result.push(Items[i]);
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('GetItemsArrayWithAllProperties failed. ItemPropertyNameArray is not an array of strings.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemsArrayWithAllProperties cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWithAllProperties is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWithoutProperties: Returns an array of ItemNames in BagName that do not have any ItemPropertyName/Array as any of their properties, or undefined on error. */
		GetItemsArrayWithoutProperties : function (BagName, ItemPropertyNameArray) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.isString(ItemPropertyNameArray)) {
						ItemPropertyNameArray = [ ItemPropertyNameArray ];
					}
					if (UInv.isArrayOfStrings(ItemPropertyNameArray)) {
						var Items = UInv.GetItemsArray(BagName), Result = [], i;
						for (i = 0; i < Items.length; i++) {
							if (!UInv.ItemHasAnyProperties(BagName, Items[i], ItemPropertyNameArray)) {
								Result.push(Items[i]);
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('GetItemsArrayWithoutProperties failed. ItemPropertyNameArray is not an array of strings.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemsArrayWithoutProperties cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWithoutProperties is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SwapItemsProperties: Swaps the given properties of two items (except UInvDefaultItemType and UInvVariableType, plus UInvQuantity for items with pockets).  Returns true on success. */
		SwapItemsProperties : function (BagName1, ItemName1, BagName2, ItemName2, ItemPropertyName) {
			if (UInv.isString(BagName1) && UInv.isString(ItemName1) && UInv.isString(BagName2) && UInv.isString(ItemName2)) {
				BagName1 = FixBagName(BagName1);
				ItemName1 = FixItemName(ItemName1);
				BagName2 = FixBagName(BagName2);
				ItemName2 = FixItemName(ItemName2);
				if (UInv.BagExists(BagName1)) {
					if (UInv.BagExists(BagName2)) {
						if (UInv.BagHasItem(BagName1, ItemName1)) {
							if (UInv.BagHasItem(BagName2, ItemName2)) {
								if (UInv.isString(ItemPropertyName)) {
									ItemPropertyName = [ ItemPropertyName ];
								}
								if (UInv.isArrayOfStrings(ItemPropertyName)) {
									ItemPropertyName = UInv.getUniqueArray(ItemPropertyName);  /* Remove duplicates */
									if (!ItemPropertyName.includesAny("UInvDefaultItemType", "UInvVariableType")) {
										if (!(ItemPropertyName.includes("UInvQuantity") && (UInv.ItemHasPocket(BagName1, ItemName1) || UInv.ItemHasPocket(BagName2, ItemName2)))) {
											var i = 0, Val;
											if (ItemPropertyName.length > 0) {
												for (i = 0; i < ItemPropertyName.length; i++) {
													if (UInv.ItemHasProperty(BagName1, ItemName1, ItemPropertyName[i])) {
														if (UInv.ItemHasProperty(BagName2, ItemName2, ItemPropertyName[i])) {
															/* swap item property values */
															Val = UInv.GetItemValue(BagName1, ItemName1, ItemPropertyName[i]);
															UInv.SetItemPropertyValue(BagName1, ItemName1, ItemPropertyName[i], UInv.GetItemValue(BagName2, ItemName2, ItemPropertyName[i]));
															UInv.SetItemPropertyValue(BagName2, ItemName2, ItemPropertyName[i], Val);
															if (ItemPropertyName[i] == "UInvPocket") {  /* Update pockets on both items */
																FixContainerReferences(BagName1, ItemName1, BagName2, ItemName2);
																FixContainerReferences(BagName2, ItemName2, BagName1, ItemName1);
															}
														} else {
															/* move item property */
															UInv.SetItemPropertyValue(BagName2, ItemName2, ItemPropertyName[i], UInv.GetItemValue(BagName1, ItemName1, ItemPropertyName[i]));
															if (ItemPropertyName[i] == "UInvPocket") {  /* Update pockets on item 2 */
																FixContainerReferences(BagName1, ItemName1, BagName2, ItemName2);
															}
															if (["UInvPocket", "UInvCell"].includes(ItemPropertyName[i])) {  /* Delete swapped away property */
																delete State.variables.UInvBags[BagName1][ItemName1][ItemPropertyName[i]];
															} else {
																UInv.DeleteItemProperty(BagName1, ItemName1, ItemPropertyName[i]);
															}
														}
													} else {
														if (UInv.ItemHasProperty(BagName2, ItemName2, ItemPropertyName[i])) {
															/* move item property */
															UInv.SetItemPropertyValue(BagName1, ItemName1, ItemPropertyName[i], UInv.GetItemValue(BagName2, ItemName2, ItemPropertyName[i]));
															if (ItemPropertyName[i] == "UInvPocket") {  /* Update pockets on item 1 */
																FixContainerReferences(BagName2, ItemName2, BagName1, ItemName1);
															}
															if (["UInvPocket", "UInvCell"].includes(ItemPropertyName[i])) {  /* Delete swapped away property */
																delete State.variables.UInvBags[BagName2][ItemName2][ItemPropertyName[i]];
															} else {
																UInv.DeleteItemProperty(BagName2, ItemName2, ItemPropertyName[i]);
															}
														}
													}
												}
											}
											return true;  /* Success */
										} else {
											UInvError('SwapItemsProperties failed. ItemPropertyName cannot be UInvQuantity if either item has pockets.');  /* Error */
											return undefined;
										}
									} else {
										UInvError('SwapItemsProperties failed. ItemPropertyName cannot be UInvDefaultItemType or UInvVariableType.');  /* Error */
										return undefined;
									}
								} else {
									UInvError('SwapItemsProperties failed. ItemPropertyName is not a string or array of strings.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('SwapItemsProperties cannot find item "' + ItemName2 + '" in bag "' + BagName2 + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('SwapItemsProperties cannot find item "' + ItemName1 + '" in bag "' + BagName1 + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('SwapItemsProperties cannot find bag "' + BagName2 + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('SwapItemsProperties cannot find bag "' + BagName1 + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SwapItemsProperties is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SwapItems: Swaps two items, optionally keeps certain item properties un-swapped.  Returns true on success, undefined on error. */
		SwapItems : function (BagName1, ItemName1, BagName2, ItemName2, ExceptItemPropertyName) {
			if (UInv.isString(BagName1) && UInv.isString(ItemName1) && UInv.isString(BagName2) && UInv.isString(ItemName2)) {
				BagName1 = FixBagName(BagName1);
				ItemName1 = FixItemName(ItemName1);
				BagName2 = FixBagName(BagName2);
				ItemName2 = FixItemName(ItemName2);
				if (UInv.BagExists(BagName1)) {
					if (UInv.BagExists(BagName2)) {
						if (UInv.BagHasItem(BagName1, ItemName1)) {
							if (UInv.BagHasItem(BagName2, ItemName2)) {
								if (UInv.isString(ExceptItemPropertyName)) {
									ExceptItemPropertyName = [ ExceptItemPropertyName ];
								}
								if (BagName1 === BagName2) {
									if (UInv.isUndefined(ExceptItemPropertyName)) {
										return true;  /* Success - items already in same bag */
									} else if (UInv.isArrayOfStrings(ExceptItemPropertyName)) {  /* Just swap excepted properties */
										UInv.SwapItemsProperties(BagName1, ItemName1, BagName2, ItemName2, ExceptItemPropertyName);
										return true;  /* Success */
									} else {
										UInvError('SwapItems failed. ExceptItemPropertyName is not a string or array of strings.');  /* Error */
										return undefined;
									}
								} else {
									if (UInv.isUndefined(ExceptItemPropertyName) || UInv.isArrayOfStrings(ExceptItemPropertyName)) {  /* Swap items */
										var TempBag = UInv.GetUniqueBagName(), Item1Obj = {}, Item2Obj = {}, i;
										UInv.IncrementUpdateLock();  /* Prevent unnecessary updates */
										if (UInv.isArrayOfStrings(ExceptItemPropertyName)) {  /* Store excepted properties */
											for (i = 0; i < ExceptItemPropertyName.length; i++) {
												if (UInv.ItemHasProperty(BagName1, ItemName1, ExceptItemPropertyName[i])) {
													Item1Obj[ExceptItemPropertyName[i]] = UInv.GetItemPropertyValue(BagName1, ItemName1, ExceptItemPropertyName[i]);
												}
												if (UInv.ItemHasProperty(BagName2, ItemName2, ExceptItemPropertyName[i])) {
													Item2Obj[ExceptItemPropertyName[i]] = UInv.GetItemPropertyValue(BagName2, ItemName2, ExceptItemPropertyName[i]);
												}
											}
										}
										UInv.CreateBag(TempBag);
										UInv.MoveItem(BagName1, TempBag, ItemName1);
										UInv.MoveItem(BagName2, BagName1, ItemName2);
										UInv.MoveItem(TempBag, BagName2, ItemName1);
										UInv.DeleteBag(TempBag);
										if (UInv.isArrayOfStrings(ExceptItemPropertyName)) {  /* Swap excepted properties */
											for (i = 0; i < ExceptItemPropertyName.length; i++) {
												if (UInv.isProperty(Item2Obj, ExceptItemPropertyName[i])) {
													UInv.SetItemPropertyValue(BagName2, ItemName1, ExceptItemPropertyName[i], Item2Obj[ExceptItemPropertyName[i]]);
												} else if (UInv.ItemHasProperty(BagName2, ItemName1, ExceptItemPropertyName[i])) {
													UInv.DeleteItemProperty(BagName2, ItemName1, ExceptItemPropertyName[i]);
												}
												if (UInv.isProperty(Item1Obj, ExceptItemPropertyName[i])) {
													UInv.SetItemPropertyValue(BagName1, ItemName2, ExceptItemPropertyName[i], Item1Obj[ExceptItemPropertyName[i]]);
												} else if (UInv.ItemHasProperty(BagName1, ItemName2, ExceptItemPropertyName[i])) {
													UInv.DeleteItemProperty(BagName1, ItemName2, ExceptItemPropertyName[i]);
												}
											}
										}
										UInv.DecrementUpdateLock();
										UInv.SetCurrentBagName(BagName1);
										UInv.SetCurrentItemName(ItemName1);
										return true;  /* Success */
									} else {
										UInvError('SwapItems failed. ExceptItemPropertyName is not a string or array of strings.');  /* Error */
										return undefined;
									}
								}
							} else {
								UInvError('SwapItems cannot find item "' + ItemName2 + '" in bag "' + BagName2 + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('SwapItems cannot find item "' + ItemName1 + '" in bag "' + BagName1 + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('SwapItems cannot find bag "' + BagName2 + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('SwapItems cannot find bag "' + BagName1 + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SwapItems is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagItemArrayWhereItemPropertyEquals: Returns an array of [[BagName, ItemName], ...] where the item's ItemPropertyName property == Value (all entries are unique), or undefined on error. */
		GetBagItemArrayWhereItemPropertyEquals : function (BagNameArray, ItemPropertyName, Value) {
			if (UInv.isString(ItemPropertyName)) {
				if (UInv.isString(BagNameArray)) {
					BagNameArray = [ BagNameArray ];
				}
				if (UInv.isArrayOfStrings(BagNameArray)) {
					if (UInv.BagExists(BagNameArray)) {
						if (arguments.length >= 3) {
							var Result = [], Items, Match = {}, i, j;
							for (i = 0; i < BagNameArray.length; i++) {
								Items = UInv.GetItemsArrayWherePropertyEquals(BagNameArray[i], ItemPropertyName, Value);
								for (j = 0; j < Items.length; j++) {
									if (!UInv.isProperty(Match, BagNameArray[i]+Items[j])) {  /* Make sure the item isn't already in the Results array */
										Match[BagNameArray[i]+Items[j]] = true;
										Result.push([BagNameArray[i], Items[j]]);
									}
								}
							}
							return Result;  /* Success */
						} else {
							UInvError('GetBagItemArrayWhereItemPropertyEquals failed.  Value parameter is missing.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetBagItemArrayWhereItemPropertyEquals failed.  Unknown bag in BagNameArray.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagNameArray passed to GetBagItemArrayWhereItemPropertyEquals is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('ItemPropertyName passed to GetBagItemArrayWhereItemPropertyEquals is not a string.');  /* Error */
				return undefined;
			}
		},

		/* RestackItems: Attempts to restack any items which may be stacked incorrectly.  Returns true if any were restacked, false for no changes, and undefined on error. */
		RestackItems : function (BagName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Result = false, Test = true, Start = 0, Items, i, j;
					UInv.IncrementUpdateLock();
					while (Test) {
						Test = false;
						Items = UInv.GetItemsArray(BagName).sort();
						if (Items.length > 1) {
							for (i = Start; i < Items.length - 1; i++) {
								Start = i;  /* So the loop can pick up where it left off */
								for (j = i + 1; j < Items.length; j++) {
									if (UInv.ItemsMatch(BagName, Items[i], BagName, Items[j])) {  /* Merge stacks */
										if ((Items[i].indexOf("item") == 0) && (Items[j].indexOf("item") != 0)) {  /* Prefer item names that do NOT start with "item" */
											UInv.SetItemQuantity(BagName, Items[j], UInv.BagHasItem(BagName, Items[j]) + UInv.BagHasItem(BagName, Items[i]));
											UInv.DeleteItem(BagName, Items[i]);
										} else {  /* default to first item */
											UInv.SetItemQuantity(BagName, Items[i], UInv.BagHasItem(BagName, Items[i]) + UInv.BagHasItem(BagName, Items[j]));
											UInv.DeleteItem(BagName, Items[j]);
										}
										Result = true;
										Test = true;
										break;
									}
								}
								if (Test) {
									break;
								}
							}
						}
					}
					UInv.DecrementUpdateLock();
					UInv.SetCurrentBagName(BagName);
					return Result;
				} else {
					UInvError('RestackItems cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to RestackItems is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveBagPropertyValueToItem: Moves an amount of a number from a bag's property to an item's property, limited by the minimum and maximum values. */
		/*                             Deletes the bag, item, or property (depending on DeletionType) if the property's value gets set to DeletionValue.  Returns the destination value or undefined on error. */
		MoveBagPropertyValueToItem : function (SourceBagName, SourceBagPropertyName, DestinationBagName, DestinationItemName, DestinationItemPropertyName, Amount, MinimumValue, MaximumValue, DeletionValue, DeletionType) {
			if (UInv.isString(SourceBagName) && UInv.isString(SourceBagPropertyName) && UInv.isString(DestinationBagName) && UInv.isString(DestinationItemName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						DestinationItemName = FixItemName(DestinationItemName);
						if (UInv.BagHasItem(DestinationBagName, DestinationItemName)) {
							if (UInv.BagHasProperty(SourceBagName, SourceBagPropertyName)) {
								if (UInv.isUndefined(DestinationItemPropertyName)) {
									DestinationItemPropertyName = SourceBagPropertyName;
								}
								if (["UInvDefaultItemType", "UInvPocket"].includes(DestinationItemPropertyName)) {
									UInvError('MoveBagPropertyValueToItem failed. DestinationItemPropertyName cannot be "' + DestinationItemPropertyName + '".');  /* Error */
									return undefined;
								}
								if (DestinationItemPropertyName === "UInvQuantity") {
									if (!UInv.isInteger(UInv.GetBagPropertyValue(SourceBagName, SourceBagPropertyName))) {
										UInvError("MoveBagPropertyValueToItem failed. Source bag property must be an integer to move it to an item's UInvQuantity.");  /* Error */
										return undefined;
									}
									if ((!UInv.isUndefined(Amount)) && (!UInv.isInteger(Amount))) {
										UInvError("MoveBagPropertyValueToItem failed. Amount must be an integer to move it to an item's UInvQuantity.");  /* Error */
										return undefined;
									}
									MinimumValue = 0;
									DeletionValue = 0;
									if (UInv.isString(DeletionType) && (DeletionType !== "object")) {
										DeletionType = "item";
									}
								}
								if (!UInv.isUndefined(Amount)) {
									Amount = tryIntParse(Amount);
									if (UInv.isNumber(Amount)) {
										var SrcVal = UInv.GetBagPropertyValue(SourceBagName, SourceBagPropertyName);
										SrcVal = tryIntParse(SrcVal);
										if (UInv.isNumber(SrcVal)) {
											var DstVal = 0;
											if (UInv.ItemHasProperty(DestinationBagName, DestinationItemName, DestinationItemPropertyName)) {
												DstVal = UInv.GetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName);
												DstVal = tryIntParse(DstVal);
											}
											if (UInv.isNumber(DstVal)) {
												var TmpAmt = Amount;
												if (!UInv.isUndefined(MinimumValue)) {
													MinimumValue = tryIntParse(MinimumValue);
													if (UInv.isUndefined(MinimumValue)) {
														UInvError('MoveBagPropertyValueToItem failed. If used, MinimumValue must be a number.');  /* Error */
														return undefined;
													}
													if (SrcVal - Amount < MinimumValue) {  /* Can't reduce source below minimum */
														Amount = SrcVal - MinimumValue;
													}
													if (DstVal + Amount < MinimumValue) {  /* Can't reduce destination below minimum (for when Amount is negative) */
														Amount = MinimumValue - DstVal;
													}
												}
												if (!UInv.isUndefined(MaximumValue)) {
													MaximumValue = tryIntParse(MaximumValue);
													if (UInv.isUndefined(MaximumValue)) {
														UInvError('MoveBagPropertyValueToItem failed. If used, MaximumValue must be a number.');  /* Error */
														return undefined;
													}
													if ((!UInv.isUndefined(MinimumValue)) && (MinimumValue > MaximumValue)) {
														UInvError('MoveBagPropertyValueToItem failed. When both are used, MaximumValue must be greater than MinimumValue.');  /* Error */
														return undefined;
													}
													if (SrcVal - Amount > MaximumValue) {  /* Can't increase source above maximum (for when Amount is negative) */
														Amount = SrcVal - MaximumValue;
													}
													if (DstVal + Amount > MaximumValue) {  /* Can't increase destination above maximum */
														Amount = MaximumValue - DstVal;
													}
												}
												if (((TmpAmt >= 0) && (Amount > TmpAmt)) || ((TmpAmt < 0) && (Amount < TmpAmt))) {
													UInvError('MoveBagPropertyValueToItem failed. Source (' + SrcVal + ') and/or Destination (' + DstVal + ') values are too far out of MinimumValue (' + MinimumValue + ') and/or MaximumValue (' + MaximumValue + ') range.');  /* Error */
													return undefined;
												}
												if (!UInv.isUndefined(DeletionValue)) {
													DeletionValue = tryIntParse(DeletionValue);
													if (UInv.isUndefined(DeletionValue)) {
														UInvError('MoveBagPropertyValueToItem failed. If used, DeletionValue must be a number.');  /* Error */
														return undefined;
													}
													if (SrcVal - Amount == DeletionValue) {
														if (UInv.isString(DeletionType)) {
															DeletionType = DeletionType.toLowerCase();
														} else {
															DeletionType = "property";
														}
														switch (DeletionType) {
															case "bag":  /* delete bag */
															case "object":  /* delete bag or item */
																UInv.DeleteBag(SourceBagName);
																break;
															case "item":  /* delete item (do nothing in this case) */
																UInv.SetBagPropertyValue(SourceBagName, SourceBagPropertyName, SrcVal - Amount);
																break;
															default:  /* delete property */
																UInv.DeleteBagProperty(SourceBagName, SourceBagPropertyName);
														}
													} else {
														UInv.SetBagPropertyValue(SourceBagName, SourceBagPropertyName, SrcVal - Amount);
													}
													if (DstVal + Amount == DeletionValue) {
														if (UInv.isString(DeletionType)) {
															DeletionType = DeletionType.toLowerCase();
														} else {
															DeletionType = "property";
														}
														switch (DeletionType) {
															case "item":  /* delete item */
															case "object":  /* delete bag or item */
																UInv.DeleteItem(DestinationBagName, DestinationItemName);
																break;
															case "bag":  /* delete bag (do nothing in this case) */
																UInv.SetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName, DstVal + Amount);
																break;
															default:  /* delete property */
																UInv.DeleteItemProperty(DestinationBagName, DestinationItemName, DestinationItemPropertyName);
														}
													} else {
														UInv.SetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName, DstVal + Amount);
													}
													UInv.SetCurrentBagName(DestinationBagName);
													UInv.SetCurrentItemName(DestinationItemName);
													return DstVal + Amount;  /* Success */
												}
												UInv.SetBagPropertyValue(SourceBagName, SourceBagPropertyName, SrcVal - Amount);
												UInv.SetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName, DstVal + Amount);
												UInv.SetCurrentBagName(DestinationBagName);
												UInv.SetCurrentItemName(DestinationItemName);
												return DstVal + Amount;  /* Success */
											} else {
												UInvError("MoveBagPropertyValueToItem failed. Destination item's property value must be a number to add to or subtract from it.");  /* Error */
												return undefined;
											}
										} else {
											UInvError("MoveBagPropertyValueToItem failed. Source bag's property value must be a number to move an Amount of it.");  /* Error */
											return undefined;
										}
									} else {
										UInvError('MoveBagPropertyValueToItem failed. If used, Amount must be a number.');  /* Error */
										return undefined;
									}
								} else {
									var Val = UInv.GetBagPropertyValue(SourceBagName, SourceBagPropertyName);
									UInv.SetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName, Val);
									UInv.DeleteBagProperty(SourceBagName, SourceBagPropertyName);
									UInv.SetCurrentBagName(DestinationBagName);
									UInv.SetCurrentItemName(DestinationItemName);
									return Val;  /* Success */
								}
							} else {
								UInvError('MoveBagPropertyValueToItem failed. Source bag "' + SourceBagName + '" does not have property "' + SourceBagPropertyName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('MoveBagPropertyValueToItem failed. Destination bag "' + DestinationBagName + '" does not contain item "' + DestinationItemName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveBagPropertyValueToItem cannot find destination bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveBagPropertyValueToItem cannot find source bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveBagPropertyValueToItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveItemPropertyValueToItem: Moves an amount of a number from one item's property to another item's property, limited by the minimum and maximum values. */
		/*                              Deletes the bag, item, or property (depending on DeletionType) if the property's value gets set to DeletionValue.  Returns the destination value or undefined on error. */
		MoveItemPropertyValueToItem : function (SourceBagName, SourceItemName, SourceItemPropertyName, DestinationBagName, DestinationItemName, DestinationItemPropertyName, Amount, MinimumValue, MaximumValue, DeletionValue, DeletionType) {
			if (UInv.isString(SourceBagName) && UInv.isString(SourceItemName) && UInv.isString(SourceItemPropertyName) && UInv.isString(DestinationBagName) && UInv.isString(DestinationItemName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						SourceItemName = FixItemName(SourceItemName);
						if (UInv.BagHasItem(SourceBagName, SourceItemName)) {
							DestinationItemName = FixItemName(DestinationItemName);
							if (UInv.BagHasItem(DestinationBagName, DestinationItemName)) {
								if (UInv.ItemHasProperty(SourceBagName, SourceItemName, SourceItemPropertyName)) {
									if (UInv.isUndefined(DestinationItemPropertyName)) {
										DestinationItemPropertyName = SourceItemPropertyName;
									}
									if (["UInvDefaultItemType", "UInvPocket"].includes(SourceItemPropertyName)) {
										UInvError('MoveItemPropertyValueToItem failed. SourceItemPropertyName cannot be "' + SourceItemPropertyName + '".');  /* Error */
										return undefined;
									}
									if (["UInvDefaultItemType", "UInvPocket"].includes(DestinationItemPropertyName)) {
										UInvError('MoveItemPropertyValueToItem failed. DestinationItemPropertyName cannot be "' + DestinationItemPropertyName + '".');  /* Error */
										return undefined;
									}
									if (DestinationItemPropertyName === "UInvQuantity") {
										if ((!UInv.isUndefined(Amount)) && (!UInv.isInteger(Amount))) {
											UInvError("MoveItemPropertyValueToItem failed. Amount must be an integer to move it to an item's UInvQuantity.");  /* Error */
											return undefined;
										}
										MinimumValue = 0;
										DeletionValue = 0;
										if (UInv.isString(DeletionType) && (DeletionType !== "object")) {
											DeletionType = "item";
										}
									}
									if (!UInv.isUndefined(Amount)) {
										Amount = tryIntParse(Amount);
										if (UInv.isNumber(Amount)) {
											var SrcVal = UInv.GetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName);
											SrcVal = tryIntParse(SrcVal);
											if (UInv.isNumber(SrcVal)) {
												var DstVal = 0;
												if (UInv.ItemHasProperty(DestinationBagName, DestinationItemName, DestinationItemPropertyName)) {
													DstVal = UInv.GetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName);
													DstVal = tryIntParse(DstVal);
												}
												if (UInv.isNumber(DstVal)) {
													var TmpAmt = Amount;
													if (!UInv.isUndefined(MinimumValue)) {
														MinimumValue = tryIntParse(MinimumValue);
														if (UInv.isUndefined(MinimumValue)) {
															UInvError('MoveItemPropertyValueToItem failed. If used, MinimumValue must be a number.');  /* Error */
															return undefined;
														}
														if (SrcVal - Amount < MinimumValue) {  /* Can't reduce source below minimum */
															Amount = SrcVal - MinimumValue;
														}
														if (DstVal + Amount < MinimumValue) {  /* Can't reduce destination below minimum (for when Amount is negative) */
															Amount = MinimumValue - DstVal;
														}
													}
													if (!UInv.isUndefined(MaximumValue)) {
														MaximumValue = tryIntParse(MaximumValue);
														if (UInv.isUndefined(MaximumValue)) {
															UInvError('MoveItemPropertyValueToItem failed. If used, MaximumValue must be a number.');  /* Error */
															return undefined;
														}
														if ((!UInv.isUndefined(MinimumValue)) && (MinimumValue > MaximumValue)) {
															UInvError('MoveItemPropertyValueToItem failed. When both are used, MaximumValue must be greater than MinimumValue.');  /* Error */
															return undefined;
														}
														if (SrcVal - Amount > MaximumValue) {  /* Can't increase source above maximum (for when Amount is negative) */
															Amount = SrcVal - MaximumValue;
														}
														if (DstVal + Amount > MaximumValue) {  /* Can't increase destination above maximum */
															Amount = MaximumValue - DstVal;
														}
													}
													if (((TmpAmt >= 0) && (Amount > TmpAmt)) || ((TmpAmt < 0) && (Amount < TmpAmt))) {
														UInvError('MoveItemPropertyValueToItem failed. Source (' + SrcVal + ') and/or Destination (' + DstVal + ') values are too far out of MinimumValue (' + MinimumValue + ') and/or MaximumValue (' + MaximumValue + ') range.');  /* Error */
														return undefined;
													}
													if (!UInv.isUndefined(DeletionValue)) {
														DeletionValue = tryIntParse(DeletionValue);
														if (UInv.isUndefined(DeletionValue)) {
															UInvError('MoveItemPropertyValueToItem failed. If used, DeletionValue must be a number.');  /* Error */
															return undefined;
														}
														if (SrcVal - Amount == DeletionValue) {
															if (UInv.isString(DeletionType)) {
																DeletionType = DeletionType.toLowerCase();
															} else {
																DeletionType = "property";
															}
															switch (DeletionType) {
																case "item":  /* delete item */
																case "object":  /* delete bag or item */
																	UInv.DeleteItem(SourceBagName);
																	break;
																case "bag":  /* delete bag (do nothing in this case) */
																	UInv.SetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName, SrcVal - Amount);
																	break;
																default:  /* delete property */
																	UInv.DeleteItemProperty(SourceBagName, SourceItemName, SourceItemPropertyName);
															}
														} else {
															UInv.SetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName, SrcVal - Amount);
														}
														if (DstVal + Amount == DeletionValue) {
															if (UInv.isString(DeletionType)) {
																DeletionType = DeletionType.toLowerCase();
															} else {
																DeletionType = "property";
															}
															switch (DeletionType) {
																case "item":  /* delete item */
																case "object":  /* delete bag or item */
																	UInv.DeleteItem(DestinationBagName, DestinationItemName);
																	break;
																case "bag":  /* delete bag (do nothing in this case) */
																	UInv.SetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName, DstVal + Amount);
																	break;
																default:  /* delete property */
																	UInv.DeleteItemProperty(DestinationBagName, DestinationItemName, DestinationItemPropertyName);
															}
														} else {
															UInv.SetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName, DstVal + Amount);
														}
														UInv.SetCurrentBagName(DestinationBagName);
														UInv.SetCurrentItemName(DestinationItemName);
														return DstVal + Amount;  /* Success */
													}
													UInv.SetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName, SrcVal - Amount);
													UInv.SetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName, DstVal + Amount);
													UInv.SetCurrentBagName(DestinationBagName);
													UInv.SetCurrentItemName(DestinationItemName);
													return DstVal + Amount;  /* Success */
												} else {
													UInvError("MoveItemPropertyValueToItem failed. Destination item's property value must be a number to add to or subtract from it.");  /* Error */
													return undefined;
												}
											} else {
												UInvError("MoveItemPropertyValueToItem failed. Source item's property value must be a number to move an Amount of it.");  /* Error */
												return undefined;
											}
										} else {
											UInvError('MoveItemPropertyValueToItem failed. If used, Amount must be a number.');  /* Error */
											return undefined;
										}
									} else {
										var Val = UInv.GetItemPropertyValue(SourceBagName, SourceItemName, SourceItemPropertyName);
										UInv.SetItemPropertyValue(DestinationBagName, DestinationItemName, DestinationItemPropertyName, Val);
										UInv.DeleteItemProperty(SourceBagName, SourceItemName, SourceItemPropertyName);
										UInv.SetCurrentBagName(DestinationBagName);
										UInv.SetCurrentItemName(DestinationItemName);
										return Val;  /* Success */
									}
								} else {
									UInvError('MoveItemPropertyValueToItem failed. Item "' + SourceItemName + '" in bag "' + SourceBagName + '" does not have property "' + SourceItemPropertyName + '".');  /* Error */
									return undefined;
								}
							} else {
								UInvError('MoveItemPropertyValueToItem failed. Destination bag "' + DestinationBagName + '" does not contain item "' + DestinationItemName + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('MoveItemPropertyValueToItem failed. Source bag "' + SourceBagName + '" does not contain item "' + SourceItemName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveItemPropertyValueToItem cannot find destination bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveItemPropertyValueToItem cannot find source bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveItemPropertyValueToItem is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetRawItemObject: Returns the raw item object.  FOR INTERNAL/TESTING USE ONLY. */
		GetRawItemObject : function (BagName, ItemName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);
						return State.variables.UInvBags[BagName][ItemName];  /* Success */
					} else {
						UInvError('GetRawItemObject cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetRawItemObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetRawItemObject is not a string.');  /* Error */
				return undefined;
			}
		},


		/* UInv Tag Functions: */
		/* =================== */

		/* AddBagTag: Add or change a bag property to include BagTag.  If property exists, then the value gets put in an array if it isn't already.  Returns true if it succeeds. */
		AddBagTag : function (BagName, BagPropertyName, BagTag) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						if (!UInv.isUndefined(BagTag)) {
							if (UInv.isArray(BagTag)) {
								var i = 0, AResult = true;
								if (BagTag.length > 0) {
									for (i = 0; i < BagTag.length; i++) {
										if (!UInv.AddBagTag(BagName, BagPropertyName, BagTag[i])) {
											AResult = undefined;
										}
									}
								}
								return AResult;  /* Success (or Error) */
							} else {
								var Value = [];
								if (UInv.BagHasProperty(BagName, BagPropertyName)) {
									Value = UInv.GetBagPropertyValue(BagName, BagPropertyName);
									if (UInv.isArray(Value)) {
										Value.push(BagTag);
									} else {
										Value = [ Value, BagTag ];
									}
								} else {
									Value = [ BagTag ];
								}
								UInv.SetBagPropertyValue(BagName, BagPropertyName, Value);
								return true;  /* Success */
							}
						} else {
							UInvError('AddBagTag failed. BagTag not defined.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('AddBagTag cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var j = 0, BResult = true;
						for (j = 0; j < BagName.length; j++) {
							if (!UInv.AddBagTag(BagName[j], BagPropertyName, BagTag)) {
								BResult = undefined;
							}
						}
						return BResult;  /* Success (or Error) */
					} else {
						UInvError('AddBagTag failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to AddBagTag is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to AddBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* AddItemTag: Add or change a item property to include ItemTag.  If property exists, then the value gets put in an array if it isn't already.  Returns true if it succeeds. */
		AddItemTag : function (BagName, ItemName, ItemPropertyName, ItemTag) {
			if (UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					ItemName = FixItemName(ItemName);
					if (UInv.BagExists(BagName)) {
						if (UInv.BagHasItem(BagName, ItemName)) {
							UInv.SetCurrentItemName(ItemName);
							UInv.SetCurrentBagName(BagName);
							if (!UInv.isUndefined(ItemTag)) {
								if (UInv.isArray(ItemTag)) {
									var i = 0, AResult = true;
									if (ItemTag.length > 0) {
										for (i = 0; i < ItemTag.length; i++) {
											if (!UInv.AddItemTag(BagName, ItemName, ItemPropertyName, ItemTag[i])) {
												AResult = undefined;
											}
										}
									}
									return AResult;  /* Success (or Error) */
								} else {
									var Value = [];
									if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
										Value = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);  /* Handle default item properties */
										if (UInv.isArray(Value)) {
											Value.push(ItemTag);
											UInv.SetItemPropertyValue(BagName, ItemName, ItemPropertyName, Value);
											return true;  /* Success */
										} else {
											Value = [ Value, ItemTag ];
											UInv.SetItemPropertyValue(BagName, ItemName, ItemPropertyName, Value);
											return true;  /* Success */
										}
									} else {
										Value = [ ItemTag ];
										UInv.SetItemPropertyValue(BagName, ItemName, ItemPropertyName, Value);
										return true;  /* Success */
									}
								}
							} else {
								UInvError('AddItemTag failed. ItemTag not defined.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('AddItemTag cannot find item "' + ItemName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('AddItemTag cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var j = 0, BResult = true;
						for (j = 0; j < BagName.length; j++) {
							if (!UInv.AddItemTag(BagName[j], ItemName, ItemPropertyName, ItemTag)) {
								BResult = undefined;
							}
						}
						return BResult;  /* Success (or Error) */
					} else {
						UInvError('AddItemTag failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to AddItemTag is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to AddItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteBagTag: Delete one instance of BagTag from bag property.  Returns true if it succeeds. */
		DeleteBagTag : function (BagName, BagPropertyName, BagTag) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						if (!UInv.isUndefined(BagTag)) {
							if (UInv.BagHasProperty(BagName, BagPropertyName)) {
								if (UInv.isArray(BagTag)) {
									var i = 0, AResult = true;
									if (BagTag.length > 0) {
										for (i = 0; i < BagTag.length; i++) {
											if (!UInv.DeleteBagTag(BagName, BagPropertyName, BagTag[i])) {
												AResult = undefined;
											}
										}
									}
									return AResult;  /* Success (or Error) */
								} else {
									var Value = UInv.GetBagPropertyValue(BagName, BagPropertyName);
									if (UInv.isArray(Value)) {
										if (UInv.arrayHasTag(Value, BagTag)) {
											Value.deleteAt(Value.indexOf(BagTag));
											UInv.SetBagPropertyValue(BagName, BagPropertyName, Value);
										}
									} else if (Value === BagTag) {
										UInv.DeleteBagProperty(BagName, BagPropertyName);
									}
									return true;  /* Success */
								}
							} else {
								return true;  /* Success - bag property not found */
							}
						} else {
							UInvError('DeleteBagTag failed. BagTag not defined.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('DeleteBagTag cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var j = 0, BResult = true;
						for (j = 0; j < BagName.length; j++) {
							if (!UInv.DeleteBagTag(BagName[j], BagPropertyName, BagTag)) {
								BResult = undefined;
							}
						}
						return BResult;  /* Success (or Error) */
					} else {
						UInvError('DeleteBagTag failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to DeleteBagTag is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to DeleteBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteItemTag: Delete one instance of ItemTag from item property.  Returns true if it succeeds. */
		DeleteItemTag : function (BagName, ItemName, ItemPropertyName, ItemTag) {
			if (UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					ItemName = FixItemName(ItemName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);
						if (!UInv.isUndefined(ItemTag)) {
							if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
								if (UInv.isArray(ItemTag)) {
									var i = 0, AResult = true;
									if (ItemTag.length > 0) {
										for (i = 0; i < ItemTag.length; i++) {
											if (!UInv.DeleteItemTag(BagName, ItemName, ItemPropertyName, ItemTag[i])) {
												AResult = undefined;
											}
										}
									}
									return AResult;  /* Success (or Error) */
								} else {
									var Value = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);  /* Handle default item properties */
									if (UInv.isArray(Value)) {
										if (UInv.arrayHasTag(Value, ItemTag)) {
											Value.deleteAt(Value.indexOf(ItemTag));
											UInv.SetItemPropertyValue(BagName, ItemName, ItemPropertyName, Value);
										}
										return true;  /* Success */
									} else {
										if (UInv.valuesAreEqual(Value, ItemTag)) {
											UInv.DeleteItemProperty(BagName, ItemName, ItemPropertyName);
										}
										return true;  /* Success */
									}
								}
							} else {
								return true;  /* Success - ItemPropertyName doesn't exist, so it's already "deleted" */
							}
						} else {
							UInvError('DeleteItemTag failed. ItemTag not defined.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('DeleteItemTag cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var j = 0, BResult = true;
						for (j = 0; j < BagName.length; j++) {
							if (!UInv.DeleteItemTag(BagName[j], ItemName, ItemPropertyName, ItemTag)) {
								BResult = undefined;
							}
						}
						return BResult;  /* Success (or Error) */
					} else {
						UInvError('DeleteItemTag failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to DeleteItemTag is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to DeleteItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasTag: Returns true if bag's property contains the tag. */
		BagHasTag : function (BagName, BagPropertyName, BagTag) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (!UInv.isUndefined(BagTag)) {
						if (UInv.BagHasProperty(BagName, BagPropertyName)) {
							var Value = UInv.GetBagPropertyValue(BagName, BagPropertyName);
							if (UInv.isArray(Value)) {
								return UInv.arrayHasTag(Value, BagTag);  /* Success */
							} else {
								return UInv.valuesAreEqual(Value, BagTag);  /* Success */
							}
						} else {
							return false;  /* Success - tag not on bag */
						}
					} else {
						UInvError('BagHasTag failed. BagTag not defined.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagHasTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemHasTag: Returns true if item's property contains the tag. */
		ItemHasTag : function (BagName, ItemName, ItemPropertyName, ItemTag) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						UInv.SetCurrentBagName(BagName);
						UInv.SetCurrentItemName(ItemName);
						if (!UInv.isUndefined(ItemTag)) {
							if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
								var Value = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);
								if (UInv.isArray(Value)) {
									return UInv.arrayHasTag(Value, ItemTag);  /* Success */
								} else {
									return UInv.valuesAreEqual(Value, ItemTag);  /* Success */
								}
							} else {
								return false;  /* Success - tag not on item */
							}
						} else {
							UInvError('ItemHasTag failed. ItemTag not defined.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ItemHasTag cannot find item "' + ItemName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemHasTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemHasTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemHasAllTags: Returns true if item's property contains the tag. */
		ItemHasAllTags : function (BagName, ItemName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (!UInv.isUndefined(ItemTagArray)) {
							UInv.SetCurrentBagName(BagName);
							UInv.SetCurrentItemName(ItemName);
							if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
								if (UInv.isArray(ItemTagArray)) {
									var i;
									for (i = 0; i < ItemTagArray.length; i++) {
										if (!UInv.ItemHasTag(BagName, ItemName, ItemPropertyName, ItemTagArray[i])) {
											return false;  /* Success */
										}
									}
									return true;  /* Success */
								} else {
									return UInv.ItemHasTag(BagName, ItemName, ItemPropertyName, ItemTagArray);  /* Success */
								}
							} else {
								return false;  /* Success - ItemPropertyName not on item */
							}
						} else {
							UInvError('ItemHasAllTags failed. ItemTagArray not defined.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ItemHasAllTags cannot find item "' + ItemName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemHasAllTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemHasAllTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ItemHasAnyTag: Returns true if item's property contains the tag. */
		ItemHasAnyTag : function (BagName, ItemName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (!UInv.isUndefined(ItemTagArray)) {
							UInv.SetCurrentBagName(BagName);
							UInv.SetCurrentItemName(ItemName);
							if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
								if (UInv.isArray(ItemTagArray)) {
									var i;
									for (i = 0; i < ItemTagArray.length; i++) {
										if (UInv.ItemHasTag(BagName, ItemName, ItemPropertyName, ItemTagArray[i])) {
											return true;  /* Success */
										}
									}
									return false;  /* Success */
								} else {
									return UInv.ItemHasTag(BagName, ItemName, ItemPropertyName, ItemTagArray);  /* Success */
								}
							} else {
								return false;  /* Success - ItemPropertyName not on item */
							}
						} else {
							UInvError('ItemHasAnyTag failed. ItemTagArray not defined.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ItemHasAnyTag cannot find item "' + ItemName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ItemHasAnyTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ItemHasAnyTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetBagTag: Makes sure it has one of or removes all of tag BagTag based on whether Enabled is true or false, respectively.  Returns true on success. */
		SetBagTag : function (BagName, BagPropertyName, BagTag, Enabled) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						if (!UInv.isUndefined(BagTag)) {
							if (UInv.isBoolean(Enabled)) {
								if (UInv.isArray(BagTag)) {
									var i = 0, AResult = true;
									if (BagTag.length > 0) {
										for (i = 0; i < BagTag.length; i++) {
											if (!UInv.SetBagTag(BagName, BagPropertyName, BagTag[i], Enabled)) {
												AResult = undefined;
											}
										}
									}
									return AResult;  /* Success (or Error) */
								} else if (Enabled) {
									if (UInv.BagHasProperty(BagName, BagPropertyName)) {  /* Make sure it has at least one tag of BagTag */
										if (!UInv.BagHasTag(BagName, BagPropertyName, BagTag)) {
											UInv.AddBagTag(BagName, BagPropertyName, BagTag);
										}
									} else {
										UInv.AddBagTag(BagName, BagPropertyName, BagTag);
									}
									return true;  /* Success */
								} else {
									if (UInv.BagHasProperty(BagName, BagPropertyName)) {  /* Make sure it has no tags of BagTag */
										while (UInv.BagHasTag(BagName, BagPropertyName, BagTag)) {
											UInv.DeleteBagTag(BagName, BagPropertyName, BagTag);
										}
									}
									return true;  /* Success */
								}
							} else {
								UInvError('SetBagTag failed. Enabled is not a boolean.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('SetBagTag failed. BagTag not defined.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('SetBagTag cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var j = 0, BResult = true;
						for (j = 0; j < BagName.length; j++) {
							if (!UInv.SetBagTag(BagName[j], BagPropertyName, BagTag, Enabled)) {
								BResult = undefined;
							}
						}
						return BResult;  /* Success (or Error) */
					} else {
						UInvError('SetBagTag failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to SetBagTag is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to SetBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* SetItemTag: Makes sure it has one of or removes all of tag ItemTag based on whether Enabled is true or false, respectively.  Returns true on success. */
		SetItemTag : function (BagName, ItemName, ItemPropertyName, ItemTag, Enabled) {
			if (UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					ItemName = FixItemName(ItemName);
					if (UInv.BagExists(BagName)) {
						if (UInv.BagHasItem(BagName, ItemName)) {
							UInv.SetCurrentItemName(ItemName);
							UInv.SetCurrentBagName(BagName);
							if (!UInv.isUndefined(ItemTag)) {
								if (UInv.isArray(ItemTag)) {
									var i = 0, AResult = true;
									if (ItemTag.length > 0) {
										for (i = 0; i < ItemTag.length; i++) {
											if (!UInv.SetItemTag(BagName, ItemName, ItemPropertyName, ItemTag[i], Enabled)) {
												AResult = undefined;
											}
										}
									}
									return AResult;  /* Success (or Error) */
								} else if (Enabled) {
									if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {  /* Make sure it has at least one tag of ItemTag */
										if (!UInv.ItemHasTag(BagName, ItemName, ItemPropertyName, ItemTag)) {
											UInv.AddItemTag(BagName, ItemName, ItemPropertyName, ItemTag);
										}
									} else {
										UInv.AddItemTag(BagName, ItemName, ItemPropertyName, ItemTag);
									}
									return true;  /* Success */
								} else {
									if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {  /* Make sure it has no tags of ItemTag */
										while (UInv.ItemHasTag(BagName, ItemName, ItemPropertyName, ItemTag)) {
											UInv.DeleteItemTag(BagName, ItemName, ItemPropertyName, ItemTag);
										}
									}
									return true;  /* Success */
								}
							} else {
								UInvError('SetItemTag failed. ItemTag not defined.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('SetItemTag cannot find item "' + ItemName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('SetItemTag cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var j = 0, BResult = true;
						for (j = 0; j < BagName.length; j++) {
							if (!UInv.SetItemTag(BagName[j], ItemName, ItemPropertyName, ItemTag, Enabled)) {
								BResult = undefined;
							}
						}
						return BResult;  /* Success (or Error) */
					} else {
						UInvError('SetItemTag failed. Invalid bag name in BagName array.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to SetItemTag is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to SetItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayByBagTag: Returns an array of bag names for all bags that have BagTag in their BagPropertyName property. */
		GetBagsArrayByBagTag : function (BagPropertyName, BagTag) {
			if (UInv.isString(BagPropertyName)) {
				if (!UInv.isUndefined(BagTag)) {
					var Bags = [], BagList = UInv.GetBagsArray(), i = 0;
					if (BagList.length > 0) {
						for (i = 0; i < BagList.length; i++) {
							if (UInv.BagHasTag(BagList[i], BagPropertyName, BagTag)) {
								Bags.push(BagList[i]);
							}
						}
					}
					return Bags;  /* Success */
				} else {
					UInvError('GetBagsArrayByBagTag failed. BagTag parameter is missing.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetBagsArrayByBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAllBagTags: Returns true if the bag's property's value (which must be an array) has an equal or greater number of all tags in BagTagArray.  (true if BagTagArray is empty) */
		BagHasAllBagTags : function (BagName, BagPropertyName, BagTagArray) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (UInv.BagHasProperty(BagName, BagPropertyName)) {
						if (UInv.isArray(UInv.GetBagPropertyValue(BagPropertyName)) && UInv.isArray(BagTagArray)) {
							return UInv.arrayHasAllTags(UInv.GetBagPropertyValue(BagPropertyName), BagTagArray);
						} else {
							UInv.Error("Error: BagHasAllBagTags failed. Both BagPropertyName's value and BagTagArray parameter must be arrays.");  /* Error */
							return undefined;
						}
					} else {
						UInvError('BagHasAllBagTags cannot find bag property "' + BagPropertyName + '" on bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagHasAllBagTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasAllBagTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAnyBagTag: Returns true if the bag's property's value (which must be an array) has any of the tags in BagTagArray.  (false if BagTagArray is empty) */
		BagHasAnyBagTag : function (BagName, BagPropertyName, BagTagArray) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (UInv.BagHasProperty(BagName, BagPropertyName)) {
						if (UInv.isArray(UInv.GetBagPropertyValue(BagPropertyName)) && UInv.isArray(BagTagArray)) {
							return UInv.arrayHasAnyTag(UInv.GetBagPropertyValue(BagPropertyName), BagTagArray);
						} else {
							UInv.Error("Error: BagHasAnyBagTag failed. Both BagPropertyName's value and BagTagArray parameter must be arrays.");  /* Error */
							return undefined;
						}
					} else {
						UInvError('BagHasAnyBagTag cannot find bag property "' + BagPropertyName + '" on bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagHasAnyBagTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasAnyBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayByAllItemTags: Returns array of item names in bag with all tags. */
		GetItemsArrayByAllItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = [];
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasAllTags(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							Result.push(Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsArrayByAllItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayByAllItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayByAnyItemTag: Returns array of item names in bag with any tags. */
		GetItemsArrayByAnyItemTag : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = [];
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasAnyTag(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							Result.push(Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsArrayByAnyItemTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayByAnyItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWithoutAllItemTags: Returns array of item names in bag without any of the tags. */
		GetItemsArrayWithoutAllItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = [];
					for (i = 0; i < Items.length; i++) {
						if (!UInv.ItemHasAllTags(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							Result.push(Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsArrayWithoutAllItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWithoutAllItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWithoutAnyItemTags: Returns array of item names in bag without any of the tags. */
		GetItemsArrayWithoutAnyItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = [];
					for (i = 0; i < Items.length; i++) {
						if (!UInv.ItemHasAnyTag(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							Result.push(Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsArrayWithoutAnyItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWithoutAnyItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayByItemTag: Returns array of item names in bag which have that tag. */
		GetItemsArrayByItemTag : function (BagName, ItemPropertyName, ItemTag) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = [];
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasTag(BagName, Items[i], ItemPropertyName, ItemTag)) {
							Result.push(Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsArrayByItemTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayByItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayWithItemByBagTag: Returns array of bag names from bags with bag tag and item. */
		GetBagsArrayWithItemByBagTag : function (BagPropertyName, BagTag, ItemName) {
			if (UInv.isString(BagPropertyName) && UInv.isString(ItemName)) {
				var Bags = UInv.GetBagsArray(), i = 0, Result = [];
				if (Bags.length > 0) {
					for (i = 0; i < Bags.length; i++) {
						if (UInv.BagHasTag(Bags[i], BagPropertyName, BagTag) && UInv.BagHasItem(Bags[i], ItemName)) {
							Result.push(Bags[i]);
						}
					}
				}
				return Result;  /* Success */
			} else {
				UInvError('Name passed to GetBagsArrayWithItemByBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagsArrayWithBothBagTags: Returns array of bag names with both tags on their respective bag properties. */
		GetBagsArrayWithBothBagTags : function (BagPropertyName1, BagTag1, BagPropertyName2, BagTag2) {
			if (UInv.isString(BagPropertyName1) && UInv.isString(BagPropertyName2)) {
				var Bags = UInv.GetBagsArray(), i = 0, Result = [];
				if (Bags.length > 0) {
					for (i = 0; i < Bags.length; i++) {
						if (UInv.BagHasTag(Bags[i], BagPropertyName1, BagTag1) && UInv.BagHasTag(Bags[i], BagPropertyName2, BagTag2)) {
							Result.push(Bags[i]);
						}
					}
				}
				return Result;  /* Success */
			} else {
				UInvError('Name passed to GetBagsArrayWithBothBagTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWithBothItemTags: Returns array of item names with both tags on their respective item properties in a bag. */
		GetItemsArrayWithBothItemTags : function (BagName, ItemPropertyName1, ItemTag1, ItemPropertyName2, ItemTag2) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName1) && UInv.isString(ItemPropertyName2)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = [];
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasTag(BagName, Items[i], ItemPropertyName1, ItemTag1) && UInv.ItemHasTag(BagName, Items[i], ItemPropertyName2, ItemTag2)) {
							Result.push(Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetItemsArrayWithBothItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWithBothItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetUniqueBagTagsArray: Returns an array of unique bag tags (no duplicates) for this bag property.  Checks all bags if BagName is undefined. */
		GetUniqueBagTagsArray : function (BagPropertyName, BagName) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isUndefined(BagName)) {
					BagName = UInv.GetBagsArray();
				}
				var Result = [], i = 0;
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						if (UInv.BagHasProperty(BagName, BagPropertyName)) {
							var Tags = UInv.GetBagPropertyValue(BagName, BagPropertyName);
							if (UInv.isArray(Tags)) {
								if (Tags.length > 0) {
									for (i = 0; i < Tags.length; i++) {
										Result.push(Tags[i]);
									}
								}
								return [].concatUnique(Result);  /* Success */
							} else {
								return [ Tags ];  /* Success */
							}
						} else {
							return [];  /* Success */
						}
					} else {
						UInvError('GetUniqueBagTagsArray cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var Tmp;
						if (BagName.length > 0) {
							for (i = 0; i < BagName.length; i++) {
								Tmp = UInv.GetUniqueBagTagsArray(BagPropertyName, BagName[i]);
								if (UInv.isUndefined(Tmp) || UInv.isUndefined(Result)) {
									Result = undefined;
									break;
								} else {
									Result = Result.concatUnique(Tmp);
								}
							}
						}
						return Result;  /* Success (or Error, shouldn't happen) */
					} else {
						UInvError('BagName array passed to GetUniqueBagTagsArray contains an invalid bag name.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to GetUniqueBagTagsArray is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to GetUniqueBagTagsArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetUniqueItemTagsArray: Returns an array unique item tags (no duplicates) for this item property.  Uses all bags if BagName is undefined. */
		GetUniqueItemTagsArray : function (ItemPropertyName, BagName) {
			if (UInv.isString(ItemPropertyName)) {
				if (UInv.isUndefined(BagName)) {
					BagName = UInv.GetBagsArray();
				}
				var Result = [], i = 0;
				if (UInv.isString(BagName)) {
					BagName = FixBagName(BagName);
					if (UInv.BagExists(BagName)) {
						UInv.SetCurrentBagName(BagName);
						if (UInv.GetItemCount(BagName) > 0) {
							var Items = UInv.GetItemsArray(BagName);
							for (i = 0; i < Items.length; i++) {
								if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
									var Tags = UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName);
									if (UInv.isArray(Tags)) {
										Result = Result.concatUnique(Tags);
									} else {
										Result = Result.concatUnique([ Tags ]);
									}
								}
							}
						}
						return Result;  /* Success */
					} else {
						UInvError('GetUniqueItemTagsArray cannot find bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else if (UInv.isArrayOfStrings(BagName)) {
					if (UInv.BagExists(BagName)) {
						var Tmp;
						if (BagName.length > 0) {
							for (i = 0; i < BagName.length; i++) {
								Tmp = UInv.GetUniqueItemTagsArray(ItemPropertyName, BagName[i]);
								if (UInv.isUndefined(Tmp) || UInv.isUndefined(Result)) {
									Result = undefined;
									break;
								} else {
									Result = Result.concatUnique(Tmp);
								}
							}
						}
						return Result;  /* Success (or Error, shouldn't happen) */
					} else {
						UInvError('BagName array passed to GetUniqueItemTagsArray contains an invalid bag name.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('BagName passed to GetUniqueItemTagsArray is not a string or an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('ItemPropertyName passed to GetUniqueItemTagsArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetAllUniqueItemTagsArray: Returns an array of all unique item tags in the ItemPropertName property for all items in bag. */
		GetAllUniqueItemTagsArray : function (BagName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = [], Tags = [];
					if (Items.length > 0) {
						for (i = 0; i < Items.length; i++) {
							if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
								Tags = UInv.GetItemPropertyValue(BagName, Items[i], ItemPropertyName);
								if (UInv.isArray(Tags)) {
									Result = Result.concatUnique(Tags);
								} else {
									Result = Result.concatUnique([ Tags ]);  /* Success */
								}
							}
						}
					}
					return Result;
				} else {
					UInvError('GetAllUniqueItemTagsArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetAllUniqueItemTagsArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAllItemTags: Returns whether bag's items have all ItemTagArray tags in the ItemPropertyName property among its items. */
		BagHasAllItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (!UInv.isArray(ItemTagArray)) {
						ItemTagArray = [ ItemTagArray ];
					}
					var Tags = UInv.GetAllUniqueItemTagsArray(BagName, ItemPropertyName), i = 0, Result = 0;
					for (i = 0; i < ItemTagArray.length; i++) {
						if (Tags.includes(ItemTagArray[i])) {
							Result += 1;
						}
					}
					return Result === ItemTagArray.length;  /* Success */
				} else {
					UInvError('BagHasAllItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasAllItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAnyItemTag: Returns whether any of bag's items have ItemTagArray tag in their ItemPropertyName property. */
		BagHasAnyItemTag : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (!UInv.isArray(ItemTagArray)) {
						ItemTagArray = [ ItemTagArray ];
					}
					var Tags = UInv.GetAllUniqueItemTagsArray(BagName, ItemPropertyName), i = 0;
					for (i = 0; i < ItemTagArray.length; i++) {
						if (Tags.includes(ItemTagArray[i])) {
							return true;  /* Success */
						}
					}
					return false;  /* Success */
				} else {
					UInvError('BagHasAnyItemTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasAnyItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetFullItemCountByAllItemTags: Returns full number of items with all item property tags. */
		GetFullItemCountByAllItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = 0;
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasAllTags(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							Result += UInv.BagHasItem(BagName, Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetFullItemCountByAllItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetFullItemCountByAllItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetFullItemCountByAnyItemTag: Returns full number of items with any item property tags. */
		GetFullItemCountByAnyItemTag : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0, Result = 0;
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasAnyTag(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							Result += UInv.BagHasItem(BagName, Items[i]);
						}
					}
					return Result;  /* Success */
				} else {
					UInvError('GetFullItemCountByAnyItemTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetFullItemCountByAnyItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetBagTagQuantityObject: Returns an object with TagName : TagQuantity pairs.  { "UniqueBagTag1" : QuantityOfBagTag1, ... } */
		GetBagTagQuantityObject : function (BagName, BagPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasProperty(BagName, BagPropertyName)) {
						var Tags = UInv.GetBagPropertyValue(BagName, BagPropertyName);
						UInv.SetCurrentBagName(BagName);
						if (UInv.isArray(Tags)) {
							var UniqueTags = [].concatUnique(Tags), i = 0, Result = {};
							for (i = 0; i < UniqueTags.length; i++) {
								Result[UniqueTags[i]] = Tags.count(UniqueTags[i]);
							}
							return Result;  /* Success */
						} else {
							var Tmp = {};
							Tmp[Tags] = 1;
							return Tmp;  /* Success */
						}
					} else {
						UInvError('GetBagTagQuantityObject failed. Bag "' + BagName + '" does not have property "' + BagPropertyName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetBagTagQuantityObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetBagTagQuantityObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemTagQuantityObject: Returns an object with TagName : TagQuantity pairs.  { "UniqueItemTag1" : QuantityOfItemTag1, ... } */
		GetItemTagQuantityObject : function (BagName, ItemName, ItemPropertyName) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
							var Tags = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);
							UInv.SetCurrentBagName(BagName);
							UInv.SetCurrentItemName(ItemName);
							if (UInv.isArray(Tags)) {
								var UniqueTags = [].concatUnique(Tags), i = 0, Result = {};
								for (i = 0; i < UniqueTags.length; i++) {
									Result[UniqueTags[i]] = Tags.count(UniqueTags[i]);
								}
								return Result;  /* Success */
							} else {
								var Tmp = {};
								Tmp[Tags] = 1;
								return Tmp;  /* Success */
							}
						} else {
							UInvError('GetItemTagQuantityObject failed. Item "' + ItemName + '" does not have property "' + ItemPropertyName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetItemTagQuantityObject cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemTagQuantityObject cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemTagQuantityObject is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasItemByItemTag: Returns true if any item in bag has tag ItemTag, false if none do, or undefined on error. */
		BagHasItemByItemTag : function (BagName, ItemPropertyName, ItemTag) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0;
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasTag(BagName, Items[i], ItemPropertyName, ItemTag)) {
							return true;  /* Success */
						}
					}
					return false;  /* Success */
				} else {
					UInvError('BagHasItemByItemTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasItemByItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasItemWithAllItemTags: Returns true if any items in bag have all tags in ItemTagArray, false if none do, or undefined on error. */
		BagHasItemWithAllItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0;
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasAllTags(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							return true;  /* Success */
						}
					}
					return false;  /* Success */
				} else {
					UInvError('BagHasItemWithAllItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasItemWithAllItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasItemWithAnyItemTag: Returns true if any items in bag have any tags in ItemTagArray, false if none do, or undefined on error. */
		BagHasItemWithAnyItemTag : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0;
					for (i = 0; i < Items.length; i++) {
						if (UInv.ItemHasAnyTag(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							return true;  /* Success */
						}
					}
					return false;  /* Success */
				} else {
					UInvError('BagHasItemWithAnyItemTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasItemWithAnyItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasItemWithoutAllItemTags: Returns true if any items in bag do not have all tags in ItemTagArray, false if none do, or undefined on error. */
		BagHasItemWithoutAllItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0;
					for (i = 0; i < Items.length; i++) {
						if (!UInv.ItemHasAllTags(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							return true;  /* Success */
						}
					}
					return false;  /* Success */
				} else {
					UInvError('BagHasItemWithoutAllItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasItemWithoutAllItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasItemWithoutAnyItemTags: Returns true if any items in bag do not have any tags in ItemTagArray, false if none do, or undefined on error. */
		BagHasItemWithoutAnyItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					var Items = UInv.GetItemsArray(BagName), i = 0;
					for (i = 0; i < Items.length; i++) {
						if (!UInv.ItemHasAnyTag(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
							return true;  /* Success */
						}
					}
					return false;  /* Success */
				} else {
					UInvError('BagHasItemWithoutAnyItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to BagHasItemWithoutAnyItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasItemByBagTag: Returns true if any bags with BagPropertyName/BagTag have item, false if none do, or undefined on error. */
		BagHasItemByBagTag : function (BagPropertyName, BagTag, ItemName) {
			if (UInv.isString(BagPropertyName) && UInv.isString(ItemName)) {
				var Bags = UInv.GetBagsArray(), i = 0;
				if (Bags.length > 0) {
					for (i = 0; i < Bags.length; i++) {
						if (UInv.BagHasTag(Bags[i], BagPropertyName, BagTag) && UInv.BagHasItem(Bags[i], ItemName)) {
							return true;  /* Success */
						}
					}
				}
				return false;  /* Success */
			} else {
				UInvError('Name passed to BagHasItemByBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAllItemsByBagTag: Returns true if any bag with BagPropertyName/BagTag has all of the items in ItemNameArray, false if none do, or undefined on error. */
		BagHasAllItemsByBagTag : function (BagPropertyName, BagTag, ItemNameArray) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isArrayOfStrings(ItemNameArray)) {
					var Bags = UInv.GetBagsArray(), i = 0;
					if (Bags.length > 0) {
						for (i = 0; i < Bags.length; i++) {
							if (UInv.BagHasTag(Bags[i], BagPropertyName, BagTag) && UInv.BagHasAllItems(Bags[i], ItemNameArray)) {
								return true;  /* Success */
							}
						}
					}
					return false;  /* Success */
				} else {
					UInvError('ItemNameArray passed to BagHasAllItemsByBagTag is not an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to BagHasAllItemsByBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* BagHasAnyItemByBagTag: Returns true if any bag with BagPropertyName/BagTag has any of the items in ItemName/Array, false if none do, or undefined on error. */
		BagHasAnyItemByBagTag : function (BagPropertyName, BagTag, ItemNameArray) {
			if (UInv.isString(BagPropertyName)) {
				if (UInv.isArrayOfStrings(ItemNameArray)) {
					var Bags = UInv.GetBagsArray(), i = 0;
					if (Bags.length > 0) {
						for (i = 0; i < Bags.length; i++) {
							if (UInv.BagHasTag(Bags[i], BagPropertyName, BagTag) && UInv.BagHasAnyItems(Bags[i], ItemNameArray)) {
								return true;  /* Success */
							}
						}
					}
					return false;  /* Success */
				} else {
					UInvError('ItemNameArray passed to BagHasAnyItemByBagTag is not an array of strings.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagPropertyName passed to BagHasAnyItemByBagTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* CopyItemsByItemTag: Copy all items from SourceBagName to DestinationBagName which have ItemTag in the items' ItemPropertyName. */
		CopyItemsByItemTag : function (SourceBagName, DestinationBagName, ItemPropertyName, ItemTag) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName) && UInv.isString(ItemPropertyName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						if (SourceBagName !== DestinationBagName) {
							var Items = UInv.GetItemsArrayByItemTag(SourceBagName, ItemPropertyName, ItemTag), Result = [];
							if (Items.length > 0) {
								var i = 0, Ret;
								for (i = 0; i < Items.length; i++) {
									Ret = UInv.CopyItem(SourceBagName, DestinationBagName, Items[i]);
									if (Ret === undefined) {
										Result = undefined;
									} else if (!UInv.isBoolean(Result)) {
										Result.push(Ret);
									}
								}
							}
							return Result;  /* Success or Error  *** */
						} else {
							UInvError('CopyItemsByItemTag failed. Source and destination bags cannot be the same.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('CopyItemsByItemTag cannot find bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('CopyItemsByItemTag cannot find bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to CopyItemsByItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* MoveItemsByItemTag: Move all items from SourceBagName to DestinationBagName which have ItemTag in the items' ItemPropertyName. */
		MoveItemsByItemTag : function (SourceBagName, DestinationBagName, ItemPropertyName, ItemTag) {
			if (UInv.isString(SourceBagName) && UInv.isString(DestinationBagName) && UInv.isString(ItemPropertyName)) {
				SourceBagName = FixBagName(SourceBagName);
				DestinationBagName = FixBagName(DestinationBagName);
				if (UInv.BagExists(SourceBagName)) {
					if (UInv.BagExists(DestinationBagName)) {
						if (SourceBagName !== DestinationBagName) {
							var Items = UInv.GetItemsArrayByItemTag(SourceBagName, ItemPropertyName, ItemTag), Result = true;
							if (Items.length > 0) {
								var i = 0, Ret = "";
								for (i = 0; i < Items.length; i++) {
									Ret = UInv.MoveItem(SourceBagName, DestinationBagName, Items[i]);
									if (UInv.isUndefined(Ret) || UInv.isUndefined(Result)) {
										Result = undefined;
									} else {
										if (UInv.isBoolean(Result)) {
											Result = [ Ret ];
										} else {
											Result.push(Ret);
										}
									}
								}
							}
							return Result;  /* Success */
						} else {
							UInvError('MoveItemsByItemTag failed. Source and destination bags cannot be the same.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('MoveItemsByItemTag cannot find bag "' + DestinationBagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('MoveItemsByItemTag cannot find bag "' + SourceBagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to MoveItemsByItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteItemsByItemTag: Delete all items from BagName which have ItemTag in the items' ItemPropertyName. */
		DeleteItemsByItemTag : function (BagName, ItemPropertyName, ItemTag) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					return UInv.DeleteItem(BagName, UInv.GetItemsArrayByItemTag(BagName, ItemPropertyName, ItemTag));  /* Success */
				} else {
					UInvError('DeleteItemsByItemTag cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to DeleteItemsByItemTag is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetMissingBagTagsArray: Returns an array of all tags in BagTagArray which were not found on the BagPropertyName for that bag, or undefined on error. */
		GetMissingBagTagsArray : function (BagName, BagPropertyName, BagTagArray) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasProperty(BagName, BagPropertyName)) {
						UInv.SetCurrentBagName(BagName);
						var Tags = UInv.GetBagPropertyValue(BagName, BagPropertyName);
						if (!UInv.isArray(Tags)) {
							Tags = [ Tags ];
						}
						if (!UInv.isArray(BagTagArray)) {
							BagTagArray = [ BagTagArray ];
						}
						if (BagTagArray.length > 0) {
							var i = 0, Result = [];
							for (i = 0; i < BagTagArray.length; i++) {
								if (!Tags.includes(BagTagArray[i])) {
									Result.push(BagTagArray[i]);
								}
							}
							return Result;  /* Success */
						} else {
							return [];  /* Success */
						}
					} else {
						UInvError('GetMissingBagTagsArray failed. Bag "' + BagName + '" does not have property "' + BagPropertyName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetMissingBagTagsArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetMissingBagTagsArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetMissingItemTagsArray: Returns an array of all tags in ItemTagArray which were not found on the items' ItemPropertyName in that bag, or undefined on error. */
		GetMissingItemTagsArray : function (BagName, ItemName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
							UInv.SetCurrentBagName(BagName);
							UInv.SetCurrentItemName(ItemName);
							var Tags = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);
							if (!UInv.isArray(Tags)) {
								Tags = [ Tags ];
							}
							if (!UInv.isArray(ItemTagArray)) {
								ItemTagArray = [ ItemTagArray ];
							}
							if (ItemTagArray.length > 0) {
								var i = 0, Result = [];
								for (i = 0; i < ItemTagArray.length; i++) {
									if (!Tags.includes(ItemTagArray[i])) {
										Result.push(ItemTagArray[i]);
									}
								}
								return Result;  /* Success */
							} else {
								return [];  /* Success */
							}
						} else {
							UInvError('GetMissingItemTagsArray failed. Item "' + ItemName + '" does not have property "' + ItemPropertyName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetMissingItemTagsArray cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetMissingItemTagsArray cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetMissingItemTagsArray is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetRandomBagTagFromRange: Returns a random tag from LowIndex to HighIndex (inclusive), returns undefined on error. */
		GetRandomBagTagFromRange : function (BagName, BagPropertyName, HighIndex, LowIndex) {
			if (UInv.isString(BagName) && UInv.isString(BagPropertyName)) {
				if (UInv.isUndefined(LowIndex)) {
					LowIndex = 0;
				}
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasProperty(BagName, BagPropertyName)) {
						var Tags = UInv.GetBagPropertyValue(BagName, BagPropertyName);
						if (UInv.isArray(Tags)) {
							HighIndex = tryIntParse(HighIndex);
							LowIndex = tryIntParse(LowIndex);
							if (UInv.isInteger(HighIndex)) {
								if (UInv.isInteger(LowIndex)) {
									if ((LowIndex >= 0) && (LowIndex <= HighIndex)) {
										if ((HighIndex >= LowIndex) && (HighIndex < Tags.length)) {
											UInv.SetCurrentBagName(BagName);
											return Tags[random(LowIndex, HighIndex)];  /* Success */
										} else {
											UInv.Error("Error: GetRandomBagTagFromRange failed. HighIndex must be >= LowIndex and =< the highest array index for that property's array.");  /* Error */
											return undefined;
										}
									} else {
										UInvError('GetRandomBagTagFromRange failed. LowIndex must be >= 0 and < HighIndex.');  /* Error */
										return undefined;
									}
								} else {
									UInvError('GetRandomBagTagFromRange failed. LowIndex must be an integer.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('GetRandomBagTagFromRange failed. HighIndex must be an integer.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('GetRandomBagTagFromRange failed. Bag property "' + BagPropertyName + '" on bag "' + BagName + '" is not an array.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetRandomBagTagFromRange cannot find property "' + BagPropertyName + '" on bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetRandomBagTagFromRange cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetRandomBagTagFromRange is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetRandomItemTagFromRange: Returns a random tag from LowIndex to HighIndex (inclusive), returns undefined on error. */
		GetRandomItemTagFromRange : function (BagName, ItemName, ItemPropertyName, HighIndex, LowIndex) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				if (UInv.isUndefined(LowIndex)) {
					LowIndex = 0;
				}
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
							var Tags = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);
							if (UInv.isArray(Tags)) {
								HighIndex = tryIntParse(HighIndex);
								LowIndex = tryIntParse(LowIndex);
								if (UInv.isInteger(HighIndex)) {
									if (UInv.isInteger(LowIndex)) {
										if ((LowIndex >= 0) && (LowIndex <= HighIndex)) {
											if ((HighIndex >= LowIndex) && (HighIndex < Tags.length)) {
												UInv.SetCurrentBagName(BagName);
												UInv.SetCurrentItemName(ItemName);
												return Tags[random(LowIndex, HighIndex)];  /* Success */
											} else {
												UInv.Error("Error: GetRandomItemTagFromRange failed. HighIndex must be >= LowIndex and =< the highest array index for that property's array.");  /* Error */
												return undefined;
											}
										} else {
											UInvError('GetRandomItemTagFromRange failed. LowIndex must be >= 0 and < HighIndex.');  /* Error */
											return undefined;
										}
									} else {
										UInvError('GetRandomItemTagFromRange failed. LowIndex must be an integer.');  /* Error */
										return undefined;
									}
								} else {
									UInvError('GetRandomItemTagFromRange failed. HighIndex must be an integer.');  /* Error */
									return undefined;
								}
							} else {
								UInvError('GetRandomItemTagFromRange failed. Item property "' + ItemPropertyName + '" on item "' + ItemName + '" is not an array.');  /* Error */
								return undefined;
							}
						} else {
							UInvError('GetRandomItemTagFromRange cannot find property "' + ItemPropertyName + '" on item "' + ItemName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetRandomItemTagFromRange cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetRandomItemTagFromRange cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetRandomItemTagFromRange is not a string.');  /* Error */
				return undefined;
			}
		},

		/* ArrayHasAllItemTags: Returns whether all of the item's tags exist in ItemTagArray, or undefined on error. */
		ArrayHasAllItemTags : function (BagName, ItemName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
							UInv.SetCurrentBagName(BagName);
							UInv.SetCurrentItemName(ItemName);
							var Tags = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);
							if (!UInv.isArray(Tags)) {
								Tags = [ Tags ];
							}
							if (!UInv.isArray(ItemTagArray)) {
								ItemTagArray = [ ItemTagArray ];
							}
							if ((Tags.length > 0) && (ItemTagArray.length > 0)) {
								var i;
								for (i = 0; i < Tags.length; i++) {
									if (!ItemTagArray.includes(Tags[i])) {
										return false;
									}
								}
								return true;  /* Success */
							} else {
								return false;  /* Success */
							}
						} else {
							UInvError('ArrayHasAllItemTags failed. Item "' + ItemName + '" does not have property "' + ItemPropertyName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('ArrayHasAllItemTags cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('ArrayHasAllItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to ArrayHasAllItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWithAllItemTags: Returns an array of all items which have all of their tags in ItemTagArray (per the ArrayHasAllItemTags function), [] if ItemTagArray or the bag is empty, or undefined on error. */
		GetItemsArrayWithAllItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (!UInv.isArray(ItemTagArray)) {
						ItemTagArray = [ ItemTagArray ];
					}
					var Items = UInv.GetItemsArray(BagName), Result = [];
					if (Items.length > 0) {
						var i;
						for (i = 0; i < Items.length; i++) {
							if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
								if (UInv.ArrayHasAllItemTags(BagName, Items[i], ItemPropertyName, ItemTagArray)) {
									Result.push(Items[i]);
								}
							}
						}
						return Result;  /* Success */
					} else {
						return [];  /* Success */
					}
				} else {
					UInvError('GetItemsArrayWithAllItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWithAllItemTags is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemTagCount: Returns the number of times an exact match for Tag is found in an item's tag array, or undefined on error. */
		GetItemTagCount : function (BagName, ItemName, ItemPropertyName, Tag) {
			if (UInv.isString(BagName) && UInv.isString(ItemName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				ItemName = FixItemName(ItemName);
				if (UInv.BagExists(BagName)) {
					if (UInv.BagHasItem(BagName, ItemName)) {
						if (UInv.ItemHasProperty(BagName, ItemName, ItemPropertyName)) {
							UInv.SetCurrentBagName(BagName);
							UInv.SetCurrentItemName(ItemName);
							var Tags = UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName), Result = 0;
							if (!UInv.isArray(Tags)) {
								Tags = [ Tags ];
							}
							if (Tags.length > 0) {
								var i;
								for (i = 0; i < Tags.length; i++) {
									if (Tags[i] === Tag) {
										Result++;
									}
								}
							}
							return Result;  /* Success */
						} else {
							UInvError('GetItemTagCount failed. Item "' + ItemName + '" does not have property "' + ItemPropertyName + '".');  /* Error */
							return undefined;
						}
					} else {
						UInvError('GetItemTagCount cannot find item "' + ItemName + '" in bag "' + BagName + '".');  /* Error */
						return undefined;
					}
				} else {
					UInvError('GetItemTagCount cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemTagCount is not a string.');  /* Error */
				return undefined;
			}
		},

		/* GetItemsArrayWithMostItemTags: Returns an array of all items in BagName that are tied for the most tags from ItemTagArray in ItemPropertyName. */
		GetItemsArrayWithMostItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			if (UInv.isString(BagName) && UInv.isString(ItemPropertyName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					UInv.SetCurrentBagName(BagName);
					if (!UInv.isArray(ItemTagArray)) {
						ItemTagArray = [ ItemTagArray ];
					}
					var Items = UInv.GetItemsArray(BagName);
					if ((Items.length > 0) && (ItemTagArray.length > 0)) {
						var Result = [], Max = 0, i, j, n;
						for (i = 0; i < Items.length; i++) {
							n = 0;
							if (UInv.ItemHasProperty(BagName, Items[i], ItemPropertyName)) {
								for (j = 0; j < ItemTagArray.length; j++) {
									n += UInv.GetItemTagCount(BagName, Items[i], ItemPropertyName, ItemTagArray[j]);
								}
							}
							if (n === Max) {
								Result.push(Items[i]);  /* Add item to list */
							} else if (n > Max) {
								Result = [ Items[i] ];  /* New winner for most tags */
								Max = n;
							}
						}
						return Result;  /* Success */
					} else {
						return [];  /* Success */
					}
				} else {
					UInvError('GetItemsArrayWithMostItemTags cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Name passed to GetItemsArrayWithMostItemTags is not a string.');  /* Error */
				return undefined;
			}
		},


		/* UInv Display Functions: */
		/* ======================= */

		/* GetUpdateLocks: Returns the number of locks on updates. */
		GetUpdateLocks : function () {
			if (UInv.isProperty(State.variables, "UInvUpdatesAreLocked")) {
				return State.variables.UInvUpdatesAreLocked;  /* Success */
			}
			return 0;  /* Success */
		},

		/* UpdatesAreLocked: Returns whether automatic display updates are locked or not. */
		UpdatesAreLocked : function () {
			return !!UInv.GetUpdateLocks();  /* Success */
		},

		/* IncrementUpdateLock: Increments the update lock count. */
		IncrementUpdateLock : function () {
			State.variables.UInvUpdatesAreLocked = UInv.GetUpdateLocks() + 1;
			return State.variables.UInvUpdatesAreLocked;  /* Success */
		},

		/* DecrementUpdateLock: Increments the update lock count. */
		DecrementUpdateLock : function () {
			if (UInv.GetUpdateLocks()) {
				if (--State.variables.UInvUpdatesAreLocked === 0) {
					$.wiki("<<unset $UInvUpdatesAreLocked>>");
					UInv.UpdateDisplay();
					return 0;  /* Success */
				} else {
					return State.variables.UInvUpdatesAreLocked;  /* Success */
				}
			}
			UInv.UpdateDisplay();
			return 0;  /* Success */
		},

		/* GetMatchingEventHandlersArray: Returns an array of the handler ID of all handlers that match the parameters passed in (Handler and/or Options are optional). */
		GetMatchingEventHandlersArray : function (Group, Evnt, Options, Handler) {
			if (UInv.isString(Group)) {
				if (UInv.isProperty(State.variables.UInvEventHandlers, Group)) {
					if (UInv.isString(Evnt)) {
						if (UInv.isProperty(State.variables.UInvEventHandlers[Group], Evnt)) {
							var Matches = [], HandlerIDs, Opts, i, j, n;
							if (UInv.isUndefined(Handler)) {
								if (UInv.isUndefined(Options)) {  /* Get all items that match group and event names. */
									return Object.keys(State.variables.UInvEventHandlers[Group][Evnt]);  /* Success */
								} else if (Options === false) {  /* Find all matching items that don't have options. */
									HandlerIDs = Object.keys(State.variables.UInvEventHandlers[Group][Evnt]);
									for (i = 0; i < HandlerIDs.length; i++) {
										if (!UInv.isProperty(State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]], "options")) {
											Matches.push(HandlerIDs[i]);
										}
									}
									return Matches;  /* Success */
								} else {  /* Find items that also match all options. */
									HandlerIDs = Object.keys(State.variables.UInvEventHandlers[Group][Evnt]);
									for (i = 0; i < HandlerIDs.length; i++) {
										n = 0;
										if (UInv.isProperty(State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]], "options")) {
											Opts = Object.keys(State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]].options);
											for (j = 0; j < Opts.length; j++) {
												if (UInv.isProperty(Options, Opts[j])) {
													if (State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]].options[Opts[j]] == Options[Opts[j]]) {
														n++;
													} else {
														break;
													}
												} else {
													break;
												}
											}
											if (n == Opts.length) {
												Matches.push(HandlerIDs[i]);
											}
										}
									}
									return Matches;  /* Success */
								}
							} else if (UInv.isString(Handler)) {
								if (UInv.isUndefined(Options)) {  /* Find items that match handler name. */
									HandlerIDs = Object.keys(State.variables.UInvEventHandlers[Group][Evnt]);
									for (i = 0; i < HandlerIDs.length; i++) {
										if (State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]].handler == Handler) {
											Matches.push(HandlerIDs[i]);
										}
									}
								} else if (Options === false) {  /* Find all matching items that don't have options. */
									HandlerIDs = Object.keys(State.variables.UInvEventHandlers[Group][Evnt]);
									for (i = 0; i < HandlerIDs.length; i++) {
										if (State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]].handler == Handler) {
											if (!UInv.isProperty(State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]], "options")) {
												Matches.push(HandlerIDs[i]);
											}
										}
									}
									return Matches;  /* Success */
								} else {  /* Find items that match handler name and all options. */
									HandlerIDs = Object.keys(State.variables.UInvEventHandlers[Group][Evnt]);
									Opts = Object.keys(Options);
									for (i = 0; i < HandlerIDs.length; i++) {
										if (State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]].handler == Handler) {
											n = 0;
											for (j = 0; j < Opts.length; j++) {
												if (UInv.isProperty(State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]], Opts[j])) {
													if (State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]][Opts[j]] == Options[Opts[j]]) {
														n++;
													} else {
														break;
													}
												} else {
													break;
												}
											}
											if (n == Opts.length) {
												Matches.push(HandlerIDs[i]);
											}
										}
									}
								}
								return Matches;  /* Success */
							} else {
								UInvError('Handler passed to GetMatchingEventHandlersArray must be undefined or a string.');  /* Error */
								return undefined;
							}
						} else {
							return [];  /* Success - Event doesn't have any handlers */
						}
					} else {
						UInvError('Event passed to GetMatchingEventHandlersArray must be a string.');  /* Error */
						return undefined;
					}
				} else {
					return [];  /* Success - Group doesn't have any handlers */
				}
			} else {
				UInvError('Group passed to GetMatchingEventHandlersArray must be a string.');  /* Error */
				return undefined;
			}
		},

		/* AddEventHandler: Adds an event handler to UInv that will call the setup function or widget when that UInv event is triggered.
							Returns the random handle ID on success, or undefined on error. */
		AddEventHandler : function (Group, Evnt, Handler, Options) {
			if (UInv.isString(Group)) {
				if (UInv.isString(Evnt)) {
					if (UInv.isString(Handler)) {
						var UInvEvents = {
							general : ["MouseDown", "MouseUp"],
							bag : ["Touched"],
							table : ["Accept", "DragStart", "DragStop", "Drop"],
							radialMenu : ["Open", "WedgeClick", "DisabledWedgeClick", "Cancel"],
							cacheImages : ["Loaded", "Error", "Idle"]
						};
						if (UInv.isProperty(UInvEvents, Group)) {
							if (UInvEvents[Group].includes(Evnt)) {
								if (!UInv.isProperty(State.variables.UInvEventHandlers, Group)) {
									State.variables.UInvEventHandlers[Group] = {};
								}
								if (!UInv.isProperty(State.variables.UInvEventHandlers[Group], Evnt)) {
									State.variables.UInvEventHandlers[Group][Evnt] = {};
								}
								/* Generate unique random handle name */
								var HandleID = "h" + UInv.getRandomHexString();
								while (UInv.isProperty(State.variables.UInvEventHandlers[Group][Evnt], HandleID)) {
									HandleID = "h" + UInv.getRandomHexString();
								}
								if (UInv.isUndefined(Options)) {
									if (UInv.GetMatchingEventHandlersArray(Group, Evnt, undefined, Handler).length === 0) {  /* Add handler */
										if (UInv.isProperty(setup, Handler) && UInv.isFunction(setup[Handler])) {
											State.variables.UInvEventHandlers[Group][Evnt][HandleID] = { handler: Handler, type: "function" };
										} else {
											State.variables.UInvEventHandlers[Group][Evnt][HandleID] = { handler: Handler, type: "widget" };
										}
									} else {
										return UInv.GetMatchingEventHandlersArray(Group, Evnt, undefined, Handler)[0];  /* Success - handler already exists */
									}
								} else {  /* Add handler and options */
									if (UInv.isObject(Options)) {
										if (UInv.GetMatchingEventHandlersArray(Group, Evnt, Options, Handler).length === 0) {  /* Add handler */
											if (UInv.isProperty(setup, Handler) && UInv.isFunction(setup[Handler])) {
												State.variables.UInvEventHandlers[Group][Evnt][HandleID] = { handler: Handler, type: "function", options: clone(Options) };
											} else {
												State.variables.UInvEventHandlers[Group][Evnt][HandleID] = { handler: Handler, type: "widget", options: clone(Options) };
											}
										} else {
											return UInv.GetMatchingEventHandlersArray(Group, Evnt, Options, Handler)[0];  /* Success - handler already exists */
										}
									} else {
										UInvError('Options passed to AddEventHandler must be undefined or an object.');  /* Error */
										return undefined;
									}
								}
								return HandleID;  /* Success */
							} else {
								UInvError('Event "' + Evnt + '" passed to AddEventHandler is not a valid event for group "' + Group + '".');  /* Error */
								return undefined;
							}
						} else {
							UInvError('Group "' + Group + '" passed to AddEventHandler is not a valid group.');  /* Error */
							return undefined;
						}
					} else {
						UInvError('Handler passed to AddEventHandler must be a string.');  /* Error */
						return undefined;
					}
				} else {
					UInvError('Event passed to AddEventHandler must be a string.');  /* Error */
					return undefined;
				}
			} else {
				UInvError('Group passed to AddEventHandler must be a string.');  /* Error */
				return undefined;
			}
		},

		/* GetEventHandlerByID: Returns a UInv handler object if a matching one is found, or null if one doesn't exist, or undefined on error. */
		GetEventHandlerByID : function (Group, Evnt, HandlerID) {
			if (UInv.isString(Group)) {
				if (UInv.isProperty(State.variables.UInvEventHandlers, Group)) {
					if (UInv.isString(Evnt)) {
						if (UInv.isProperty(State.variables.UInvEventHandlers[Group], Evnt)) {
							if (UInv.isString(HandlerID)) {
								if (UInv.isProperty(State.variables.UInvEventHandlers[Group][Evnt], HandlerID)) {
									return clone(State.variables.UInvEventHandlers[Group][Evnt][HandlerID]);
								} else {
									return null;  /* Success - HandlerID not found */
								}
							} else {
								UInvError('HandlerID passed to GetEventHandlerByID must be a string.');  /* Error */
								return undefined;
							}
						} else {
							return null;  /* Success - Event doesn't have any handlers */
						}
					} else {
						UInvError('Event passed to GetEventHandlerByID must be a string.');  /* Error */
						return undefined;
					}
				} else {
					return null;  /* Success - Group doesn't have any handlers */
				}
			} else {
				UInvError('Group passed to GetEventHandlerByID must be a string.');  /* Error */
				return undefined;
			}
		},

		/* CallEventHandlerEx: Triggers any matching event handlers and passes the Values object to them.
							   Returns an array of returned objects from all triggered handlers, or undefined on error. */
		CallEventHandlerEx : function (Group, Evnt, Values) {
			if (UInv.isString(Group)) {
				if (UInv.isProperty(State.variables.UInvEventHandlers, Group)) {
					if (UInv.isString(Evnt)) {
						if (UInv.isProperty(State.variables.UInvEventHandlers[Group], Evnt)) {
							/* verify that Values parameter exists and is valid here *** */
							var Result = [], Ret, Handler, i, HandlerIDs = UInv.GetMatchingEventHandlersArray(Group, Evnt, Values);  /* Get specific matching event handlers */
							if (HandlerIDs.length === 0) {  /* Get general matching event handlers */
								HandlerIDs = UInv.GetMatchingEventHandlersArray(Group, Evnt, false);
							}
							for (i = 0; i < HandlerIDs.length; i++) {
								Handler = UInv.GetEventHandlerByID(Group, Evnt, HandlerIDs[i]);
								Values.eventGroup = Group;
								Values.eventType = Evnt;
								Values.handlerID = HandlerIDs[i];
								if (Handler.type == "function") {
									Ret = setup[Handler.handler](Values);
									if (UInv.isGenericObject(Ret)) {
										Result.push(Ret);
									} else {
										Result.push(undefined);
									}
								} else if (Handler.type == "widget") {
									State.temporary.UInvEvent = Values;
									$.wiki("<<" + Handler.handler + " _UInvEvent>>");
									if (UInv.isProperty(State.temporary, "UInvReturn")) {
										if (UInv.isGenericObject(State.temporary.UInvReturn)) {
											Result.push(State.temporary.UInvReturn);
										} else {
											Result.push(undefined);
										}
										$.wiki("<<unset _UInvReturn>>");
									}
									$.wiki("<<unset _UInvEvent>>");
								}
							}
							return Result;
						} else {
							return [];  /* Success - Event doesn't have any handlers */
						}
					} else {
						UInvError('Event passed to CallEventHandlerEx must be a string.');  /* Error */
						return undefined;
					}
				} else {
					return [];  /* Success - Group doesn't have any handlers */
				}
			} else {
				UInvError('Group passed to CallEventHandlerEx must be a string.');  /* Error */
				return undefined;
			}
		},

		/* CallEventHandler: Triggers any matching event handlers and passes the Values object to them.
							 Returns a generic object from all of the combined returned objects from all triggered handlers, or undefined on error. */
		CallEventHandler : function (Group, Evnt, Values) {
			if (UInv.isString(Group)) {
				if (UInv.isProperty(State.variables.UInvEventHandlers, Group)) {
					if (UInv.isString(Evnt)) {
						if (UInv.isProperty(State.variables.UInvEventHandlers[Group], Evnt)) {
							/* verify that Values parameter exists and is valid here *** */
							var Result = {}, Ret = UInv.CallEventHandlerEx(Group, Evnt, Values);
							if (Ret.length > 0) {
								var i, j, Props;
								for (i = 0; i < Ret.length; i++) {
									if (UInv.isGenericObject(Ret[i])) {
										Props = Object.keys(Ret[i]);
										for (j = 0; j < Props.length; j++) {
											if (UInv.isProperty(Result, Props[j])) {
												switch(Props[j]) {
													case "stopPropagation":
														if (Result.stopPropagation || Ret[i].stopPropagation) {
															Result.stopPropagation = true;  /* Prefer to override default */
														} else {
															Result.stopPropagation = Ret[i].stopPropagation;
														}
														break;
													case "acceptVal":
														if (!Result.acceptVal || !Ret[i].acceptVal) {
															Result.acceptVal = false;  /* Prefer to override default */
														} else {
															Result.acceptVal = Ret[i].acceptVal;
														}
														break;
													case "overrideDefaultAction":
														if (Result.overrideDefaultAction || Ret[i].overrideDefaultAction) {
															Result.overrideDefaultAction = true;  /* Prefer to override default */
														} else {
															Result.overrideDefaultAction = Ret[i].overrideDefaultAction;
														}
														break;
													case "openRadialMenu":
														if (Result.openRadialMenu || Ret[i].openRadialMenu) {
															Result.openRadialMenu = true;  /* Prefer to override default */
														} else {
															Result.openRadialMenu = Ret[i].openRadialMenu;
														}
														break;
													case "radialMenuWedgeItems":
														Result = UInv.combineGenericObjects(Result, Ret[i]);
														break;
													case "radialMenuHandler":  /* modify AddEventHandler to accept an array of handlers, then pass the array created here? *** */
														Result.radialMenuHandler = Ret[i].radialMenuHandler;
														/*
														if (UInv.isArrayOfStrings(Result.radialMenuHandler)) {
															Result.radialMenuHandler.push(Ret[i].radialMenuHandler);
														} else {
															Result.radialMenuHandler = [Result.radialMenuHandler, Ret[i].radialMenuHandler];
														}
														*/
														break;
													case "radialMenuOptions":
														Result = UInv.combineGenericObjects(Result, Ret[i]);
														break;
													case "keepOpen":
														if (Result.keepOpen || Ret[i].keepOpen) {
															Result.keepOpen = true;  /* Prefer to override default */
														} else {
															Result.keepOpen = Ret[i].keepOpen;
														}
														break;
													case "retryLoad":
														if (Result.retryLoad || Ret[i].retryLoad) {
															Result.retryLoad = true;  /* Prefer to override default */
														} else {
															Result.retryLoad = Ret[i].retryLoad;
														}
														break;
													default:
														Result[Props[j]] = Ret[i][Props[j]];
												}
											} else {
												Result[Props[j]] = Ret[i][Props[j]];
											}
										}
									}
								}
							}
							return Result;
						} else {
							return {};  /* Success - Event doesn't have any handlers */
						}
					} else {
						UInvError('Event passed to CallEventHandler must be a string.');  /* Error */
						return undefined;
					}
				} else {
					return {};  /* Success - Group doesn't have any handlers */
				}
			} else {
				UInvError('Group passed to CallEventHandler must be a string.');  /* Error */
				return undefined;
			}
		},

		/* DeleteEventHandler: Deletes any matching event handlers.  Returns the number of deleted handlers, or undefined on error. */
		DeleteEventHandler : function (Group, Evnt, Handler, Options) {
			if (UInv.isString(Group)) {
				if (UInv.isProperty(State.variables.UInvEventHandlers, Group)) {
					if (UInv.isString(Evnt)) {
						if (UInv.isProperty(State.variables.UInvEventHandlers[Group], Evnt)) {
							if (UInv.isProperty(State.variables.UInvEventHandlers[Group][Evnt], Handler)) {
								delete State.variables.UInvEventHandlers[Group][Evnt][Handler];
								return 1;  /* Success - Deleted by HandlerID */
							} else {
								var i, HandlerIDs = UInv.GetMatchingEventHandlersArray(Group, Evnt, Options, Handler);
								for (i = 0; i < HandlerIDs.length; i++) {
									delete State.variables.UInvEventHandlers[Group][Evnt][HandlerIDs[i]];
								}
								return HandlerIDs.length;  /* Success */
							}
						} else {
							return 0;  /* Success - Event doesn't have any handlers */
						}
					} else {
						UInvError('Event passed to DeleteEventHandler must be a string.');  /* Error */
						return undefined;
					}
				} else {
					return 0;  /* Success - Group doesn't have any handlers */
				}
			} else {
				UInvError('Group passed to DeleteEventHandler must be a string.');  /* Error */
				return undefined;
			}
		},

		/* FixTableCells: Makes sure each item is assigned a unique cell.  Tries to make sure items will display in table UInvTable if that parameter is used, assuming there is enough room. */
		FixTableCells : function (BagName, UInvTable) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					var Items = UInv.GetItemsArray(BagName);
					if (Items.length > 0) {
						var i, j, Val, Dups, Cell = 0, MaxCell = Infinity;
						if (!UInv.isUndefined(UInvTable)) {
							if (UInvTable.data("uinv") === "table") {
								if (UInvTable.attr("id") == BagName) {
									i = UInvTable.data("cellrows");
									j = UInvTable.data("cellcolumns");
									if (UInv.isInteger(i) && (i > 0) && UInv.isInteger(j) && (j > 0)) {
										MaxCell = (i * j) - 1;  /* move items if they won't display in current table */
									}
								} else {
									UInvError('UInvTable passed to FixTableCells does not match BagName of "' + BagName + '".');  /* Error */
									return undefined;
								}
							} else {
								UInvError('UInvTable passed to FixTableCells is not a UInv table element.');  /* Error */
								return undefined;
							}
						}
						for (i = 0; i < Items.length; i++) {
							if (UInv.ItemHasProperty(BagName, Items[i], "UInvCell")) {
								/* Make sure there are no duplicates */
								Val = UInv.GetItemPropertyValue(BagName, Items[i], "UInvCell");
								if (Val > MaxCell) {
									/* Move item if it won't display in current table */
									while (UInv.GetItemCountWherePropertyEquals(BagName, "UInvCell", Cell) > 0) {
										++Cell;
									}
									UInv.SetItemPropertyValue(BagName, Items[i], "UInvCell", Cell++);
								} else {
									if (UInv.GetItemCountWherePropertyEquals(BagName, "UInvCell", Val) > 1) {
										/* Unmark duplicates */
										Dups = UInv.GetItemsArrayWherePropertyEquals(BagName, "UInvCell", Val);
										Dups.delete(Items[i]);  /* Current item stays put */
										for (j = 0; j < Dups.length; j++) {
											UInv.DeleteItemProperty(BagName, Dups[j], "UInvCell");
										}
									}
								}
							} else {
								/* Give item a cell */
								while (UInv.GetItemCountWherePropertyEquals(BagName, "UInvCell", Cell) > 0) {
									++Cell;
								}
								UInv.SetItemPropertyValue(BagName, Items[i], "UInvCell", Cell++);
							}
						}
					}
					return true;  /* Success */
				} else {
					UInvError('FixTableCells cannot find bag "' + BagName + '".');  /* Error */
					return undefined;
				}
			} else {
				UInvError('BagName passed to FixTableCells is not a string.');  /* Error */
				return undefined;
			}
		},

		/* InitializeRadialMenu: Create radial menu div element. */
		InitializeRadialMenu : function () {
			var el = document.createElement("div");
			el.id = "uinv-radial-menu";
			el.style.position = "absolute";
			el.style.transition = "transform 200ms ease-in, opacity 200ms ease-in";
			el.style["pointer-events"] = "none";
			el.dataset.status = "closed";
			el.style.transform = "scale(0, 0)";
			el.style.opacity = 0;
			el.style.zIndex = 9999;
			document.body.appendChild(el);
		},

		/* DisplayRadialMenu: Gets radial menu prepared for use. */
		DisplayRadialMenu : function (WedgeItems, Pos, Handler, Options) {
			function getPoint (theta, r, posOffset, negOffset) {
				if (typeof posOffset == "undefined") {
					posOffset = { x: 0, y: 0 };
				}
				if (typeof negOffset == "undefined") {
					negOffset = { x: 0, y: 0 };
				}
				return { x: (r*Math.cos(theta)) + posOffset.x - negOffset.x, y: (r*Math.sin(theta)) + posOffset.y - negOffset.y };
			}
			function wedges (ctr, n, r1, r2, gap, clr) {
				var tGap1 = gap/r1, tGap2 = gap/r2;
				var dTheta = (2*Math.PI)/n, paths = [];
				var theta = (-0.5*Math.PI) - (0.5*dTheta), i, start1, start2, end1, end2, path;
				for (i = 0; i < n; i++) {
					if (WedgeItems[i+1] !== undefined) {
						start1 = getPoint(theta + tGap1, r1, ctr);
						end1 = getPoint((theta + dTheta) - tGap1, r1, ctr, start1);
						start2 = getPoint((theta + dTheta) - tGap2, r2, ctr);
						end2 = getPoint(theta + tGap2, r2, ctr, start2);
						path = '<path d="M' + start1.x + ',' + start1.y + ' a' + r1 + ',' + r1 + ' 0 0,1 ' + end1.x + ',' + end1.y;
						path += ' L' + start2.x + ',' + start2.y + ' a' + r2 + ',' + r2 + ' 0 0,0 ' + end2.x + ',' + end2.y + ' z" fill="';
						if (clr == "mask") {  /* wedge mask */
							path += 'white" />';
						} else if (WedgeItems[i+1].disabled !== true) {  /* clickable wedge */
							path += clr + '" class="uinv-wedge" data-id="' + (i+1) + '" data-data="' + WedgeItems[i+1].data;
							path += '" stroke="' + strokeColor + '" stroke-width="' + strokeWidth + '" pointer-events="auto">';
							if (showTooltips) {  /* deepscan-disable-line */
								path += '<title> ' + WedgeItems[i+1].hint + '</title>';
							}
							path += '<desc>' + WedgeItems[i+1].hint + '</desc></path>';  /* for blind users */
						} else {  /* disabled wedge */
							path += disabledColor + '" class="uinv-disabled-wedge" data-id="' + (i+1) + '" data-data="' + WedgeItems[i+1].data;
							path += '" stroke="' + disabledStrokeColor + '" stroke-width="' + disabledStrokeWidth + '" pointer-events="auto">';
							if (showTooltips) {  /* deepscan-disable-line */
								path += '<title> ' + WedgeItems[i+1].hint + ' (disabled)</title>';
							}
							path += '<desc>' + WedgeItems[i+1].hint + ' (disabled)</desc></path>';  /* for blind users */
						}
						paths.push(path);
					}
					theta += dTheta;
				}
				return paths.join("\n");
			}
			function wedgeClickHandler (ev) {

				function WedgeUpdate (Arr, DataName, Opts) {
					var i, DatNo = -1;
					for (i = 0; i < Arr.length; i++) {
						if (Arr[i].data == DataName) {
							DatNo = i;
							break;
						}
					}
					if (DatNo >=0) {
						var Keys = Object.keys(Opts);
						for (i = 0; i < Keys.length; i++) {
							Arr[DatNo][Keys[i]] = Opts[Keys[i]];
						}
					} else {
						if (UInv.GetUserAlerts() & UInv.ERROR_TO_CONSOLE) {
							console.log('Warning: Nonexistent DataName "' + DataName + '" passed to WedgeUpate.');  /* Throw a proper error here? *** */
						}
					}
					return Arr;
				}

				if (ev.button == 0) {
					var Ret, el, RM = setup.UInvRadialMenuData;
					var Quant = UInv.BagHasItem(RM.srcBag, RM.draggedItem);
					var data = $(this).data("data");
					ev.stopPropagation();
					ev.wedgeID = $(this).data("id");
					ev.wedgeData = data;
					ev.srcBag = RM.srcBag;
					ev.draggedItem = RM.draggedItem;
					ev.oldCellNo = RM.oldCellNo;
					ev.destBag = RM.destBag;
					ev.droppedOnItem = RM.droppedOnItem;
					ev.newCellNo = RM.newCellNo;
					ev.radialMenuWedgeItems = clone(RM.radialMenuWedgeItems);
					ev.pos = clone(RM.pos);
					ev.radialMenuHandler = RM.radialMenuHandler;
					ev.radialMenuOptions = clone(RM.radialMenuOptions);
					if ($(this).hasClass("uinv-wedge")) {
						ev.wedgeDisabled = false;
						Ret = UInv.CallEventHandler("radialMenu", "WedgeClick", ev);  /* radialMenu WedgeClick event */
						if (UInv.isUndefined(Ret.radialMenuWedgeItems)) {
							Ret.radialMenuWedgeItems = clone(RM.radialMenuWedgeItems);
						}
						if (UInv.isUndefined(Ret.radialMenuHandler)) {
							Ret.radialMenuHandler = RM.radialMenuHandler;
						}
						if (UInv.isUndefined(Ret.radialMenuOptions)) {
							Ret.radialMenuOptions = clone(RM.radialMenuOptions);
						}
						if (Ret.overrideDefaultAction !== true) {
							switch(data) {
								case "DropAll":
									UInv.IncrementUpdateLock();
									if (RM.destBag != RM.srcBag) {  /* Move to new bag */
										UInv.MoveItem(RM.srcBag, RM.destBag, RM.draggedItem);  /* handle move failure due to pocket protection *** */
									}
									UInv.SetItemPropertyValue(RM.destBag, RM.draggedItem, "UInvCell", RM.newCellNo);
									UInv.DecrementUpdateLock();
									break;
								case "Drop1":
								case "DropHalf":
								case "DropQuarter":
									UInv.IncrementUpdateLock();
									var TempBag = UInv.GetUniqueBagName(), Amt = 1;
									if (data == "DropHalf") {
										Amt = Math.trunc(Quant * 0.5);
									} else if (data == "DropQuarter") {
										Amt = Math.trunc(Quant * 0.25);
									}
									UInv.CreateBag(TempBag);
									UInv.MoveItem(RM.srcBag, TempBag, RM.draggedItem, Amt);  /* handle move failure due to pocket protection *** */
									UInv.MoveItem(TempBag, RM.destBag, RM.draggedItem);  /* handle move failure due to pocket protection *** */
									UInv.SetItemPropertyValue(RM.destBag, RM.draggedItem, "UInvCell", RM.newCellNo);
									UInv.DeleteBag(TempBag);
									Ret.keepOpen = true;
									UInv.DecrementUpdateLock();
									break;
								case "Take1":
									UInv.IncrementUpdateLock();
									UInv.MoveItem(RM.destBag, RM.srcBag, RM.draggedItem, 1);  /* handle move failure due to pocket protection *** */
									Ret.keepOpen = true;
									UInv.DecrementUpdateLock();
									break;
							}
							Quant = UInv.BagHasItem(RM.srcBag, RM.draggedItem);
							/* Default:
								{ icon: "fa-plus-square", hint: "Drop all (" + Quant + " items)", data: "DropAll" }
								{ icon: "plus-one_white.svg", hint: "Drop one", data: "Drop1" }
								{ icon: "plus-half_white.svg", hint: "Drop half", data: "DropHalf" }
								{ icon: "minus-one_white.svg", hint: "Take one", data: "Take1" }
								{ icon: "plus-quarter_white.svg", hint: "Drop 1/4th", data: "DropQuarter" }
								fa-sync-alt = swap items
								fa-times-circle = cancel radial menu
							*/
							WedgeUpdate(Ret.radialMenuWedgeItems, "DropAll", { hint: "Drop all (" + Quant + " items)" });
							if (Quant == 1) {
								WedgeUpdate(Ret.radialMenuWedgeItems, "Drop1", { disabled: true, hint: "Drop one" });
							} else {
								WedgeUpdate(Ret.radialMenuWedgeItems, "Drop1", { disabled: false, hint: "Drop one (of " + Quant + " items)" });
							}
							if (Quant < 4) {
								WedgeUpdate(Ret.radialMenuWedgeItems, "DropHalf", { disabled: true, hint: "Drop half" });
							} else {
								WedgeUpdate(Ret.radialMenuWedgeItems, "DropHalf", { disabled: false, hint: "Drop half (" + Math.trunc(Quant * 0.5) + " of " + Quant + " items)" });
							}
							if (RM.droppedOnItem !== "") {
								if (!UInv.ItemsMatch(RM.srcBag, RM.draggedItem, RM.destBag, RM.droppedOnItem)) {  /* Don't allow picking up items when they're not the same type */
									WedgeUpdate(Ret.radialMenuWedgeItems, "Take1", { disabled: true, hint: "Pick up one" });
								} else {
									WedgeUpdate(Ret.radialMenuWedgeItems, "Take1", { disabled: false, hint: "Pick up one (of " + UInv.BagHasItem(RM.destBag, RM.droppedOnItem) + " items)" });
								}
							}
							if (Quant < 8) {
								WedgeUpdate(Ret.radialMenuWedgeItems, "DropQuarter", { disabled: true, hint: "Drop 1/4th" });
							} else {
								WedgeUpdate(Ret.radialMenuWedgeItems, "DropQuarter", { disabled: false, hint: "Drop 1/4th (" + Math.trunc(Quant * 0.25) + " of " + Quant + " items)" });
							}
							RM.radialMenuWedgeItems = clone(Ret.radialMenuWedgeItems);
							RM.radialMenuHandler = Ret.radialMenuHandler;
							RM.radialMenuOptions = clone(Ret.radialMenuOptions);
							UInv.DisplayRadialMenu(Ret.radialMenuWedgeItems, Pos, Ret.radialMenuHandler, Ret.radialMenuOptions);
						}
						if (Ret.keepOpen !== true) {
							el = $("#uinv-radial-menu").get(0);
							el.dataset.status = "closed";
							el.style.transform = "scale(0, 0)";
							el.style.opacity = 0;
						}
					} else {
						ev.wedgeDisabled = true;
						Ret = UInv.CallEventHandler("radialMenu", "DisabledWedgeClick", ev);  /* radialMenu DisabledWedgeClick event */
						if (Ret.keepOpen === false) {
							el = $("#uinv-radial-menu").get(0);
							el.dataset.status = "closed";
							el.style.transform = "scale(0, 0)";
							el.style.opacity = 0;
						}
					}
				}
			}

			/*
			var WedgeItems = [{ icon: "menu-burger_white.svg", hint: "Show menu", data: "menu", disabled: true },  // any double-quotes in WedgeItems[#].data need to be escaped ***
						{ icon: "fa-image", hint: "Show image", data: "image" },
						{ icon: "fa-headphones", hint: "Show audio", data: "audio", disabled: true },
						{ icon: "fa-home", hint: "Return to main page", data: "home" },
						,  // handle undefined wedges as blank spaces
						{ icon: "fa-video", hint: "Show video", data: "video" },
						{ icon: "fa-envelope", hint: "Show email", data: "email" }];
			Default Options:
					{
						iconSize: 32, radius: 100, gap: 1, pad: 2, iconColor: "white", showTooltips: true,
						innerGradientColor: "rgb(4,111,191)", innerGradientOpacity: 1, innerGradientOffset: 0,
						outerGradientColor: "rgb(4,111,191)", outerGradientOpacity: 0, outerGradientOffset: 100,
						hoverColor: "rgba(0,144,226,0.3)", strokeColor: "#0090e2", strokeWidth: 0,
						disabledColor: "rgba(128,128,128,0.5)", disabledOpacity: "0.4", disabledStrokeColor: "#0090e2", disabledStrokeWidth: 0
					}
			*/
			/* Radial menu init */
			var div = $("#uinv-radial-menu").get(0);
			if (UInv.isUndefined(div)) {
				UInv.InitializeRadialMenu();
				div = $("#uinv-radial-menu").get(0);
			}
			if (!UInv.isArrayOfObjects(WedgeItems)) {
				UInvError('DisplayRadialMenu failed. WedgeItems parameter is not an array of objects.');  /* Error */
				return undefined;
			}
			if (WedgeItems.length === 0) {
				return true;  /* Success */
			}
			if (UInv.isUndefined(Options) || !UInv.isGenericObject(Options)) {
				Options = {};
			}
			div.radialMenuWedgeItems = WedgeItems;
			div.radialMenuHandler = Handler;
			div.radialMenuOptions = Options;
			var Ret = UInv.CallEventHandler("radialMenu", "Open", div);  /* radialMenu Open event */
			if (UInv.isProperty(Ret, "radialMenuWedgeItems")) {
				WedgeItems = Ret.radialMenuWedgeItems;
			}
			if (UInv.isProperty(Ret, "radialMenuHandler")) {
				Handler = Ret.radialMenuHandler;
			}
			if (UInv.isProperty(Ret, "radialMenuOptions")) {
				Options = Ret.radialMenuOptions;
			}
			if (!UInv.isUndefined(Handler) && UInv.isString(Handler)) {
				UInv.AddEventHandler("radialMenu", "Open", Handler);
				UInv.AddEventHandler("radialMenu", "WedgeClick", Handler);
				UInv.AddEventHandler("radialMenu", "DisabledWedgeClick", Handler);
				UInv.AddEventHandler("radialMenu", "Cancel", Handler);
			}
			var num = WedgeItems.length - 1;  /* num = number of outer ring options */
			var r1M = Options.iconSize ? Options.iconSize : 32;  /* r1M = icon height/width in pixels */
			var r2M = Options.radius ? Options.radius : 100;  /* r2M = radial menu radius in pixels */
			var gapM = Options.gap ? Options.gap : 1;  /* gapM = circle and wedge gap size??? */
			var pad = Options.pad ? Options.pad : 2;  /* pad = circle and wedge margin??? */
			var iconColor = Options.iconColor ? Options.iconColor : "white";
			var showTooltips = Options.showTooltips ? Options.showTooltips : true;
			var innerGradientColor = Options.innerGradientColor ? Options.innerGradientColor : "rgb(4,111,191)";
			var innerGradientOpacity = Options.innerGradientOpacity ? Options.innerGradientOpacity : 1;
			var innerGradientOffset = Options.innerGradientOffset ? Options.innerGradientOffset : 0;
			var outerGradientColor = Options.outerGradientColor ? Options.outerGradientColor : "rgb(4,111,191)";
			var outerGradientOpacity = Options.outerGradientOpacity ? Options.outerGradientOpacity : 0;
			var outerGradientOffset = Options.outerGradientOffset ? Options.outerGradientOffset : 100;
			var hoverColor = Options.hoverColor ? Options.hoverColor : "rgba(0,144,226,0.3)";
			var strokeColor = Options.strokeColor ? Options.strokeColor : "#0090e2";
			var strokeWidth = Options.strokeWidth ? Options.strokeWidth : 0;
			var disabledColor = Options.disabledColor ? Options.disabledColor : "rgba(128,128,128,0.5)";
			var disabledOpacity = Options.disabledOpacity ? Options.disabledOpacity : "0.4";
			var disabledStrokeColor = Options.disabledStrokeColor ? Options.disabledStrokeColor : "#0090e2";
			var disabledStrokeWidth = Options.disabledStrokeWidth ? Options.disabledStrokeWidth : 0;
			var center = { x: r2M + pad, y: r2M + pad };
			var w = (2*r2M) + (2*pad), h = (2*r2M) + (2*pad);
			div.dataset.r = r2M;
			$(div).find(".uinv-wedge").off();
			$(div).find(".uinv-disabled-wedge").off();
			/* Add wedge hover styling */
			if (!UInv.docHasCSSElement(".uinv-wedge:hover")) {
				var styleEl = document.createElement("style");
				styleEl.title = "uinv-hover";
				document.head.appendChild(styleEl);
				var styleSheet = styleEl.sheet;
				styleSheet.insertRule(".uinv-wedge:hover { fill: " + hoverColor + "; }", 0);
			}
			/* Create the radial menu as an SVG element */
			var svg = '<svg id="uinv-radial-menu-svg" style="display: block; width: ' + w + 'px; height: ' + h + 'px;">';
			/* Centered gradient background */
			svg += '<defs><radialGradient id="Gradient" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">';
			svg += '<stop offset="' + innerGradientOffset + '%" style="stop-color:' + innerGradientColor + '; stop-opacity:' + innerGradientOpacity + '" />';
			svg += '<stop offset="' + outerGradientOffset + '%" style="stop-color:' + outerGradientColor + '; stop-opacity:' + outerGradientOpacity + '" />';
			svg += '</radialGradient>';
			/* Radial menu mask so Gradient background is visible */
			svg += '<mask id="Mask">';
			if (WedgeItems[0] !== undefined) {
				svg += '<circle cx="' + center.x + '" cy="' + center.y + '" r="' + (r1M - (2*gapM)) + '" fill="white" />';
			}
			svg += wedges(center, num, r1M, r2M, gapM, "mask") + '</mask></defs>';
			/* Background circle */
			svg += '<circle id="uinv-radial-menu-bkg" cx="' + center.x + '" cy="' + center.y + '" r="' + r2M + '" fill="url(#Gradient)" mask="url(#Mask)" pointer-events="none" />';
			/* Main circle */
			if (WedgeItems[0] !== undefined) {
				svg += '<circle data-id="0" data-data="' + WedgeItems[0].data + '" cx="' + center.x + '" cy="' + center.y + '" r="' + (r1M - (2*gapM)) + '"';
				if (WedgeItems[0].disabled !== true) {
					svg += ' class="uinv-wedge" fill="transparent" stroke="' + strokeColor + '" stroke-width="' + strokeWidth + '" pointer-events="auto">';
					if (showTooltips) {  /* deepscan-disable-line */
						svg += '<title> ' + WedgeItems[0].hint + '</title>';
					}
					svg += '<desc>' + WedgeItems[0].hint + '</desc></circle>';  /* for blind users */
				} else {
					svg += ' class="uinv-disabled-wedge" fill="' + disabledColor + '" stroke="' + disabledStrokeColor + '" stroke-width="' + disabledStrokeWidth + '" pointer-events="auto">';
					if (showTooltips) {  /* deepscan-disable-line */
						svg += '<title> ' + WedgeItems[0].hint + ' (disabled)</title>';
					}
					svg += '<desc>' + WedgeItems[0].hint + ' (disabled)</desc></circle>';  /* for blind users */
				}
			}
			/* Main wedges */
			svg += wedges(center, num, r1M, r2M, gapM, "transparent") + '</svg>';
			div.style.width = w + "px";
			div.style.height = h + "px";
			/* Starting size and opacity */
			div.style.transform = "scale(0, 0)";
			div.style.opacity = 0;
			$(div).html(svg);
			/* Add center icon/image */
			var thetaM = -0.5*Math.PI, el, elCenter, pic, isImg, i;
			for (i = 0; i < WedgeItems.length; i++) {
				isImg = false;
				if (WedgeItems[i] !== undefined) {  /* Add wedge icons/images */
					pic = WedgeItems[i].icon;
					if ((/^fa-*/).test(pic) && !(/\./).test(pic)) {  /* if icon starts with "fa-" and does not contain ".", then assume it's a Font Awesome glyph */
						el = document.createElement("div");
						el.className = "fa " + pic;
					} else {
						isImg = true;
						el = document.createElement("img");
					}
					if (i === 0) {
						elCenter = getPoint(thetaM, 0, center);
					} else {
						elCenter = getPoint(thetaM, (r1M + r2M)/2, center);
					}
					el.style.position = "absolute";
					el.style.color = iconColor;
					el.style.width = r1M + "px";
					el.style.height = r1M + "px";
					el.style.top = Math.round(elCenter.y - (r1M/2)) + "px";
					el.style.left = Math.round(elCenter.x - (r1M/2)) + "px";
					el.style["line-height"] = r1M + "px";
					el.style["font-size"] = r1M + "px";
					el.style["text-align"] = "center";
					el.style["pointer-events"] = "none";
					/* prevent text and images from being highlighted/selected */
					el.style["-webkit-touch-callout"] = "none";  /* iOS Safari */
					el.style["-webkit-user-select"] = "none";  /* Safari */
					el.style["-khtml-user-select"] = "none";  /* Konqueror HTML */
					el.style["-moz-user-select"] = "none";  /* Firefox */
					el.style["-ms-user-select"] = "none";  /* Internet Explorer/Edge */
					el.style["user-select"] = "none";  /* Non-prefixed version, currently supported by Chrome and Opera */
					if (WedgeItems[i].disabled === true) {
						el.style.opacity = disabledOpacity;
					}
					if (isImg) {
						el.src = setup.ImagePath + pic;
					}
					div.appendChild(el);
				}
				if (i !== 0) {
					thetaM += (2*Math.PI)/(WedgeItems.length - 1);
				}
			}
			$(div).find(".uinv-wedge").on("mouseup", wedgeClickHandler);
			$(div).find(".uinv-disabled-wedge").on("mouseup", wedgeClickHandler);
			$(div).css({
				left: Math.round(Pos.x - r2M + window.scrollX) + "px",
				top: Math.round((Pos.y - (2*r2M)) + r2M + window.scrollY) + "px",
				transform: "scale(1, 1)",
				opacity: 1
			});
			div.dataset.status = "opened";
			return true;  /* Success */
		},

		/* DisplayItemList: Displays all items in a bag in a single string.   *** Combine items with identical names if possible */
		DisplayItemList : function (BagName, PluralItemPropertyName, EmptyString, SeparatorString, ConjunctionString, SingleItemPropertyName) {
			if (UInv.isString(BagName)) {
				BagName = FixBagName(BagName);
				if (UInv.BagExists(BagName)) {
					if (!UInv.isString(PluralItemPropertyName)) {
						PluralItemPropertyName = "";
					}
					if (!UInv.isString(EmptyString)) {
						EmptyString = "nothing";
					}
					if (!UInv.isString(SeparatorString)) {
						SeparatorString = ",";
					}
					if (!UInv.isString(ConjunctionString)) {
						ConjunctionString = "and";
					}
					if (!UInv.isString(SingleItemPropertyName)) {
						SingleItemPropertyName = "";
					}
					var Items = UInv.GetItemsArray(BagName);
					if (Items.length > 0) {
						var Result = "", Amt = 0, i;
						UInv.ClearErrors();
						for (i = 0; i < Items.length; i++) {
							if ((i === Items.length - 1) && (i !== 0) && (ConjunctionString !== "")) {
								Result += ConjunctionString + " ";
							}
							Amt = UInv.BagHasItem(BagName, Items[i]);
							if (Amt === 1) {
								if (SingleItemPropertyName === "") {
									Result += Items[i];
								} else {
									if (UInv.ItemHasProperty(BagName, Items[i], SingleItemPropertyName)) {
										Result += UInv.GetItemPropertyValue(BagName, Items[i], SingleItemPropertyName);
										if (UInv.GetLastError() !== "") {
											Result += UInv.GetLastError();
											UInv.ClearErrors();
										}
									} else {
										UInvError('DisplayItemList failed. Cannot find single item property "' + SingleItemPropertyName + '" on item "' + Items[i] + '" in bag "' + BagName + '".');  /* Error */
										Result += Items[i];  /* Use fallback item name */
									}
								}
							} else {
								Amt = UInv.numberToAPString(Amt);
								if (PluralItemPropertyName === "") {
									Result += Amt + " " + Items[i];
								} else {
									if (UInv.ItemHasProperty(BagName, Items[i], PluralItemPropertyName)) {
										Result += Amt + " " + UInv.GetItemPropertyValue(BagName, Items[i], PluralItemPropertyName);
										if (UInv.GetLastError() !== "") {
											Result += UInv.GetLastError();
											UInv.ClearErrors();
										}
									} else {
										UInvError('DisplayItemList failed. Cannot find plural item property "' + PluralItemPropertyName + '" on item "' + Items[i] + '" in bag "' + BagName + '".');  /* Error */
										Result += Items[i];  /* Use fallback item name */
									}
								}
							}
							if (i < Items.length - 1) {
								if (Items.length > 2) {
									Result += SeparatorString + " ";
								} else {
									Result += " ";
								}
							}
						}
						return Result;  /* Success */
					}
					return EmptyString;  /* Success */
				} else {
					UInvError('DisplayItemList cannot find bag "' + BagName + '".');  /* Error */
					return '(Error: DisplayItemList cannot display unknown bag "' + BagName + '".)';
				}
			} else {
				UInvError('BagName passed to DisplayItemList is not a string.');  /* Error */
				return '(Error: DisplayItemList cannot display invalid bag name.)';
			}
		},

		/* DisplayArray: Displays all elements in an array in a single string. */
		DisplayArray : function (YourArray, EmptyString, SeparatorString, ConjunctionString, UseAPNumbers) {
			if (arguments.length < 1)  {
				return "nothing";
			}
			if (!UInv.isArray(YourArray)) {
				YourArray = [ YourArray ];
			}
			if (!UInv.isString(EmptyString)) {
				EmptyString = "nothing";
			}
			if (YourArray.length == 0) {
				return EmptyString;
			}
			if (!UInv.isString(SeparatorString)) {
				SeparatorString = ",";
			}
			if (!UInv.isString(ConjunctionString)) {
				ConjunctionString = "and";
			}
			if (!UInv.isString(UseAPNumbers)) {
				UseAPNumbers = false;
			}
			var Result = "", i;
			for (i = 0; i < YourArray.length; i++) {
				if ((i === YourArray.length - 1) && (i !== 0) && (ConjunctionString !== "")) {
					Result += ConjunctionString + " ";
				}
				if (UInv.isNumber(YourArray[i]) && UseAPNumbers) {
					Result += UInv.numberToAPString(YourArray[i]);
				} else {
					Result += YourArray[i];
				}
				if (i < YourArray.length - 1) {
					if (YourArray.length > 2) {
						Result += SeparatorString + " ";
					} else {
						Result += " ";
					}
				}
			}
			return Result;  /* Success */
		},

		/* UpdateDisplay: Updates the display of any data-uinv="X" HTML elements. */
		UpdateDisplay : function (Container) {

			function AcceptHandler(el) {
				/* This gets called once for each droppable element on DragStart */
				if ($(el).data("uinv") == "item") {
					var SrcBag = $(el).data("bagname");
					var DraggedItem = $(el).data("itemname");
					var DestBag = $(this).data("bagname");
					var NewCellNo = $(this).data("cellno");
					var DroppedOnItem = UInv.GetItemWherePropertyEquals(DestBag, "UInvCell", NewCellNo);
					el.srcBag = SrcBag;
					el.draggedItem = DraggedItem;
					el.destBag = DestBag;
					el.droppedOnItem = DroppedOnItem;
					el.newCellNo = NewCellNo;
					el.acceptVal = $(el).hasClass("dragging");  /* drag indicator */
					var Ret = UInv.CallEventHandler("table", "Accept", el);  /* table Accept event */
					if (UInv.isProperty(Ret, "acceptVal")) {
						return Ret.acceptVal;
					} else {
						return $(el).hasClass("dragging");  /* drag indicator */
					}
				} else {
					return false;
				}
			}

			function DropHandler(event, ui) {
				ui.draggable.position( { of: $(this), my: "center", at: "center" } );
				var SrcBag = ui.draggable.data("bagname");
				var DraggedItem = ui.draggable.data("itemname");
				var OldCellNo = UInv.GetItemPropertyValue(SrcBag, DraggedItem, "UInvCell");
				var DestBag = $(this).data("bagname");
				var NewCellNo = $(this).data("cellno");
				var DroppedOnItem = UInv.GetItemWherePropertyEquals(DestBag, "UInvCell", NewCellNo);
				var Quant = UInv.BagHasItem(SrcBag, DraggedItem);
				var Pos = { x: event.clientX, y: event.clientY };
				var radialMenuWedgeItems = [
					{ icon: "fa-plus-square", hint: "Drop all (" + Quant + " items)", data: "DropAll" },
					{ icon: "plus-one_white.svg", hint: "Drop one", data: "Drop1" },
					{ icon: "plus-half_white.svg", hint: "Drop half", data: "DropHalf" },
					{ icon: "minus-one_white.svg", hint: "Pick up one", data: "Take1" },
					{ icon: "plus-quarter_white.svg", hint: "Drop 1/4th", data: "DropQuarter" }];
				if (Quant == 1) {
					radialMenuWedgeItems[1].disabled = true;
				} else {
					radialMenuWedgeItems[1].hint = "Drop one (of " + Quant + " items)";
				}
				if (Quant < 4) {
					radialMenuWedgeItems[2].disabled = true;
				} else {
					radialMenuWedgeItems[2].hint = "Drop half (" + Math.trunc(Quant * 0.5) + " of " + Quant + " items)";
				}
				if (DroppedOnItem !== "") {
					if (!UInv.ItemsMatch(SrcBag, DraggedItem, DestBag, DroppedOnItem)) {  /* Don't allow merge of items since they're not the same type */
						radialMenuWedgeItems[3].disabled = true;
					} else {
						radialMenuWedgeItems[3].hint = "Pick up one (of " + UInv.BagHasItem(DestBag, DroppedOnItem) + " items)";
					}
				} else {
					radialMenuWedgeItems[3].disabled = true;
				}
				if (Quant < 8) {
					radialMenuWedgeItems[4].disabled = true;
				} else {
					radialMenuWedgeItems[4].hint = "Drop 1/4th (" + Math.trunc(Quant * 0.25) + " of " + Quant + " items)";
				}
				event.srcBag = SrcBag;
				event.draggedItem = DraggedItem;
				event.oldCellNo = OldCellNo;
				event.destBag = DestBag;
				event.droppedOnItem = DroppedOnItem;
				event.newCellNo = NewCellNo;
				event.pos = clone(Pos);
				event.ui = ui;
				event.radialMenuWedgeItems = clone(radialMenuWedgeItems);
				var Ret = UInv.CallEventHandler("table", "Drop", event);  /* table Drop event */
				if (Ret.openRadialMenu === true) {
					if (!UInv.isUndefined(Ret.radialMenuWedgeItems)) {
						if (!UInv.isProperty(Ret, "radialMenuOptions")) {
							Ret.radialMenuOptions = undefined;
						}
						if (!UInv.isProperty(Ret, "radialMenuHandler")) {
							Ret.radialMenuHandler = undefined;
						}
						UInv.DisplayRadialMenu(Ret.radialMenuWedgeItems, Pos, Ret.radialMenuHandler, Ret.radialMenuOptions);
						Ret.overrideDefaultAction = true;
					} else {
						Ret.radialMenuWedgeItems = clone(radialMenuWedgeItems);
					}
				} else {  /* If return values not set, set with defaults. */
					if (UInv.isUndefined(Ret.radialMenuWedgeItems)) {
						Ret.radialMenuWedgeItems = clone(radialMenuWedgeItems);
					}
					if (!UInv.isProperty(Ret, "radialMenuOptions")) {
						Ret.radialMenuOptions = undefined;
					}
					if (!UInv.isProperty(Ret, "radialMenuHandler")) {
						Ret.radialMenuHandler = undefined;
					}
				}
				if (UInv.isProperty(setup, "UInvRadialMenuData")) {
					delete setup.UInvRadialMenuData;
				}
				setup.UInvRadialMenuData = {  /* Store data for radial menu events */
					srcBag: SrcBag,
					draggedItem: DraggedItem,
					oldCellNo: OldCellNo,
					destBag: DestBag,
					droppedOnItem: DroppedOnItem,
					newCellNo: NewCellNo,
					radialMenuWedgeItems: clone(Ret.radialMenuWedgeItems),
					pos: clone(Pos),
					radialMenuHandler: Ret.radialMenuHandler,
					radialMenuOptions: clone(Ret.radialMenuOptions)
				};
				if (Ret.overrideDefaultAction !== true) {
					if (DroppedOnItem !== "") {
						if ((SrcBag != DestBag) || (OldCellNo != NewCellNo)) {  /* Make sure item wasn't dropped back at original location */
							if (UInv.ItemsMatch(SrcBag, DraggedItem, DestBag, DroppedOnItem)) {  /* Merge items since they're the same type */
								if (Quant > 1) {
									UInv.DisplayRadialMenu(radialMenuWedgeItems, Pos);
								} else {
									UInv.IncrementUpdateLock();
									if (DestBag != SrcBag) {  /* Move to new bag */
										UInv.MoveItem(SrcBag, DestBag, DraggedItem);  /* handle move failure due to pocket protection *** */
									}
									UInv.SetItemPropertyValue(DestBag, DraggedItem, "UInvCell", NewCellNo);
									UInv.DecrementUpdateLock();
								}
							} else {  /* Swap items */
								UInv.IncrementUpdateLock();
								UInv.SwapItems(SrcBag, DraggedItem, DestBag, DroppedOnItem, "UInvCell");
								UInv.DecrementUpdateLock();
							}
						}
					} else {  /* Change UInvCell to new cell */
						if ((Quant > 1) && (SrcBag != DestBag)) {
							UInv.DisplayRadialMenu(radialMenuWedgeItems, Pos);
						} else {
							UInv.IncrementUpdateLock();
							if (DestBag != SrcBag) {  /* Move to new bag */
								UInv.MoveItem(SrcBag, DestBag, DraggedItem);  /* handle move failure due to pocket protection *** */
							}
							UInv.SetItemPropertyValue(DestBag, DraggedItem, "UInvCell", NewCellNo);
							UInv.DecrementUpdateLock();
						}
					}
				}
			}

			if (UInv.isUndefined(Container)) {
				Container = $("body").not("tw-storydata *");
			} else {
				Container = $(Container);
			}
			var Matches = Container.find("[data-uinv]");
			if (Matches.length > 0) {
				var i, Table, BagName, CellMargin, BorderMargin, CellRows, x, CellCols, y, Row, RowClass, CellClass, ItemClass, IconClass, TextClass, PadTxt, Count, Item, Txt;
				for (i = 0; i < Matches.length; i++) {
					Count = 0;
					if ($(Matches[i]).data("uinv") === "table") {  /* Update tables */
						Table = $(Matches[i]);
						BagName = Table.attr("id");
						UInv.FixTableCells(BagName, Table);
						CellMargin = Table.data("cellmargin");
						BorderMargin = Table.data("bordermargin");
						CellRows = Table.data("cellrows");
						CellCols = Table.data("cellcolumns");
						RowClass = Table.data("rowclass");
						CellClass = Table.data("cellclass");
						ItemClass = Table.data("itemclass");
						IconClass = Table.data("iconclass");
						TextClass = Table.data("textclass");
						Table.find("[data-uinv='item']").off();  /* Release handlers */
						Table.empty();
						for (x = 0; x < CellRows; x++) {
							Table.append('<div class="' + RowClass + '" id="' + BagName + '-row' + x + '" data-uinv="table-row"></div>');
							Row = Container.find("#" + BagName + "-row" + x);
							for (y = 0; y < CellCols; y++) {
								PadTxt = "";
								if (x === 0) {
									PadTxt = ' margin-top: ' + (BorderMargin + CellMargin) + 'px;';
								}
								if (x === CellRows - 1) {
									PadTxt += ' margin-bottom: ' + (BorderMargin + CellMargin) + 'px;';
								}
								if (y === 0) {
									PadTxt += ' margin-left: ' + (BorderMargin + CellMargin) + 'px;';
								}
								if (y === CellCols - 1) {
									PadTxt += ' margin-right: ' + (BorderMargin + CellMargin) + 'px;';
								}
								Item = UInv.GetItemWherePropertyEquals(BagName, "UInvCell", Count);
								if (Item !== "") {
									Txt = '<span data-uinv="table-cell" class="' + CellClass + '" id="' + BagName + '-cell' + Count + '" data-bagname="' + BagName + '" data-cellno=' + Count++ + ' style="margin: ' + CellMargin + 'px;' + PadTxt + '">';
									Txt += '<div data-uinv="item" class="' + ItemClass + '" id="' + BagName + '-item-' + Item + '" data-bagname="' + BagName + '" data-itemname="' + Item + '">';
									Txt += '<img src="' + setup.ImagePath + UInv.GetItemPropertyValue(BagName, Item, "image") + '" class="' + IconClass + '" id="' + BagName + '-icon-' + Item + '" unselectable="on" onselectstart="return false;">';
									if (UInv.BagHasItem(BagName, Item) > 1) {
										Txt += '<span class="' + TextClass + '" id="' + BagName + '-text' + Count + '" unselectable="on" onselectstart="return false;">' + UInv.BagHasItem(BagName, Item) + '</span>';
									}
									Txt += '</div></span>';
									Row.append(Txt);
								} else {
									Row.append('<span data-uinv="table-cell" class="' + CellClass + '" id="' + BagName + '-cell' + Count + '" data-bagname="' + BagName + '" data-cellno=' + Count++ + ' style="margin: ' + CellMargin + 'px;' + PadTxt + '"></span>');
								}
							}
						}
					}
					/* Add update code for future display objects here. */
				}
				if (UInv.isFunction(Container.find("[data-uinv='table-cell']").droppable)) {
					Container.find("[data-uinv='table-cell']")
						.droppable({  /* see: http://api.jqueryui.com/droppable/ & https://jqueryui.com/droppable/ */
							//scope: "UInv",
							accept: AcceptHandler,
							drop: DropHandler
						});
					Container.find("[data-uinv='item']")
						.on("mousedown touchstart", function (ev) {  /* event handler here?  *** */
							if (ev.button == 0) {
								$(this).addClass("grabbing");
							}
						})
						.on("mouseup touchend", function (ev) {  /* event handler here?  *** */
							if (ev.button == 0) {
								$(this).removeClass("grabbing");
							}
						})
						.draggable({  /* see: https://api.jqueryui.com/draggable/ & https://jqueryui.com/draggable/ */
							revert: "invalid",
							containment: "document",
							//scope: "UInv",
							cursor: "grab",
							snap: false,
							start: function (event, ui) {
								if (event.button == 0) {
									$(this).addClass("grabbing");
									$(this).addClass("dragging");  /* drag indicator */
									if (!UInv.isUndefined(event.target.setCapture)) {
										event.target.setCapture();
									}
									var SrcBag = $(this).data("bagname");
									var DraggedItem = $(this).data("itemname");
									event.srcBag = SrcBag;
									event.draggedItem = DraggedItem;
									event.ui = ui;
									UInv.CallEventHandler("table", "DragStart", event);  /* table DragStart event */
									/*
									var Ret = UInv.CallEventHandler("table", "DragStart", event);  // table DragStart event
									if (Ret.someValue != true) {
									}
									*/
								} else {
									event.preventDefault();
								}
							},
							stop: function (event, ui) {
								$(this).removeClass("grabbing");
								$(this).removeClass("dragging");  /* drag indicator */
								var SrcBag = $(this).data("bagname");
								var DraggedItem = $(this).data("itemname");
								event.srcBag = SrcBag;
								event.draggedItem = DraggedItem;
								event.ui = ui;
								UInv.CallEventHandler("table", "DragStop", event);  /* table DragStop event */
								/*
								var Ret = UInv.CallEventHandler("table", "DragStop", event);  // table DragStop event
								if (Ret.someValue != true) {
								}
								*/
							}
						});
				} else {
					/* Page reload from browser (such as CTRL+F5) caused drag-drop to not get set up properly, so retry. */
					setTimeout(UInv.UpdateDisplay, 100);
				}
			}
			return true;
		},


		/* UInv Other Functions: */
		/* ===================== */

		/* GetUserAlerts: Returns the $UInvShowAlerts value (or false if it doesn't exist). */
		GetUserAlerts : function () {
			if (!UInv.isUndefined(setup.UInvUserAlertsDebug)) {  /* Handle "xyzzy" debug override on reload of save file. */
				if (UInv.isUndefined(State.variables.UInvShowAlerts) || State.variables.UInvShowAlerts !== setup.UInvUserAlertsDebug) {
					setup.UInvUserAlertsBackup = State.variables.UInvShowAlerts;
					UInv.SetUserAlerts(setup.UInvUserAlertsDebug);
					console.log('UInv: Game restarted with console logging enabled through debug override. Type "xyzzy" while on game window to cancel.');
				}
			}
			if (UInv.isProperty(State.variables, "UInvShowAlerts")) {
				return State.variables.UInvShowAlerts;
			}
			return false;
		},

		/* SetUserAlerts: Allows the type of error messages returned by UInv to be controlled.  Returns the current value of $UInvShowAlerts. */
		SetUserAlerts : function (ErrorSetting, ErrorStringAddendum) {
			if (!UInv.isUndefined(ErrorSetting)) {
				if (UInv.isInteger(ErrorSetting)) {
					State.variables.UInvShowAlerts = ErrorSetting;
				} else if (ErrorSetting) {
					State.variables.UInvShowAlerts = UInv.ERROR_THROW_ERROR + UInv.ERROR_SHOW_PASSAGE_NAME;  /* Default */
				} else {
					if (UInv.isProperty(State.variables, "UInvShowAlerts")) {
						delete State.variables.UInvShowAlerts;
					}
				}
			}
			if (!UInv.isUndefined(ErrorStringAddendum)) {
				if (UInv.isString(ErrorStringAddendum) || UInv.isNumber(ErrorStringAddendum) || UInv.isObject(ErrorStringAddendum) || UInv.isBoolean(ErrorStringAddendum)) {
					if (ErrorStringAddendum === "") {
						if (UInv.isProperty(State.variables, "UInvErrorStringAddendum")) {
							delete State.variables.UInvErrorStringAddendum;
						}
					} else {
						State.variables.UInvErrorStringAddendum = ErrorStringAddendum;
					}
				}
			}
			return UInv.GetUserAlerts();
		},

		/* ClearErrors: Sets the error string to "". */
		ClearErrors : function () {
			State.variables.UInvLastErrorMessage = "";
			return true;  /* Success */
		},

		/* GetLastError: Returns the last error string.  Also clears error messages if Clear is set to true. */
		GetLastError : function (Clear) {
			var Err = "";
			if (UInv.isUndefined(Clear)) {
				Clear = false;
			}
			if (UInv.isProperty(State.variables, "UInvLastErrorMessage")) {
				Err = State.variables.UInvLastErrorMessage;
			}
			if (Clear) {
				UInv.ClearErrors();
			}
			return Err;  /* Success */
		},

		/* SetMergeItemMethod: Sets the $UInvMergeItemMethod variable which controls how UInv handles cases where functions attempt to merge two non-equal items. */
		SetMergeItemMethod : function (Method) {
			if (!UInv.isUndefined(Method)) {
				if ((Method >=1) && (Method <= 6)) {
					State.variables.UInvMergeItemMethod = Method;
					return true;  /* Sets merge method */
				} else {
					if (!UInv.isProperty(State.variables, "UInvMergeItemMethod")) {
						State.variables.UInvMergeItemMethod = UInv.MERGE_USE_ONLY_DESTINATION_PROPERTIES;  /* default */
					}
					return false;  /* Value not valid */
				}
			} else {
				if (!UInv.isProperty(State.variables, "UInvMergeItemMethod")) {
					State.variables.UInvMergeItemMethod = UInv.MERGE_USE_ONLY_DESTINATION_PROPERTIES;  /* default */
				}
				return false;  /* Value not valid */
			}
		},

		/* Initialize: Set up variables.  Returns "false" if any were already set, otherwise it returns "true". */
		Initialize : function (ErrorSetting) {

			var ignoredElements = [];  /* Add element names to prevent clicks from triggering events when clicking on those elements.  E.g. ["a", "button"]; */
			function handleMouseDown (ev) {
				var Ret = UInv.CallEventHandler("general", "MouseDown", ev);  /* general MouseDown event */
				if (Ret.stopPropagation === true) {
					ev.stopPropagation();
				}
				if (ev.button == 0) {
					if ((($(ev.target).parents("#story").length > 0) || ($(ev.target).parents().length <= 2))  /* Make sure that the click is in the story area or the background, not on the UI bar */
						&& (ev.clientX < document.documentElement.offsetWidth) && (ev.clientY < document.documentElement.offsetHeight)  /* Ignore clicks on the scrollbar */
						&& !ignoredElements.includes(ev.target.localName))  /* Ignore clicks on certain elements */
					{
						var el = $("#uinv-radial-menu").get(0);
						if (UInv.isUndefined(el)) {
							UInv.InitializeRadialMenu();
						} else {
							if (el.dataset.status == "opened") {  /* Cancel radial menu */
								ev.cancelType = "MouseDown";
								Ret = UInv.CallEventHandler("radialMenu", "Cancel", ev);  /* radialMenu Cancel event (MouseDown) */
								if (Ret.keepOpen !== true) {
									el.dataset.status = "closed md";
									el.style.transform = "scale(0, 0)";
									el.style.opacity = 0;
								}
								UInv.UpdateDisplay();
							}
						}
					}
				}
			}
			function handleMouseUp (ev) {
				if (ev.button == 0) {
					if ((($(ev.target).parents("#story").length > 0) || ($(ev.target).parents().length <= 2))  /* Make sure that the click is in the story area or the background, not on the UI bar */
						&& (ev.clientX < document.documentElement.offsetWidth) && (ev.clientY < document.documentElement.offsetHeight)  /* Ignore clicks on the scrollbar */
						&& !ignoredElements.includes(ev.target.localName))  /* Ignore clicks on certain elements */
					{
						var el = $("#uinv-radial-menu").get(0);
						if (UInv.isUndefined(el)) {
							UInv.InitializeRadialMenu();
						} else {
							if (el.dataset.status == "opened") {  /* Cancel radial menu */
								ev.cancelType = "MouseUp";
								var Ret = UInv.CallEventHandler("radialMenu", "Cancel", ev);  /* radialMenu Cancel event (MouseUp) */
								if (Ret.keepOpen !== true) {
									el.dataset.status = "closed";
									el.style.transform = "scale(0, 0)";
									el.style.opacity = 0;
								}
								UInv.UpdateDisplay();
							} else {
								if (el.dataset.status == "closed md") {
									el.dataset.status = "closed";
								/*
								} else {  // Open radial menu at new location
									$("#event").empty().wiki("Opened");  // pass this to a handler function??? check to see if radial menu should be opened, and get icons and options? ***
									el.dataset.status = "opened";
									var r = parseInt(el.dataset.r, 10);
									el.style.left = Math.round(ev.clientX - r + window.scrollX) + "px";
									el.style.top = Math.round((ev.clientY - (2*r)) + r + window.scrollY) + "px";
									el.style.transform = "scale(1, 1)";
									el.style.opacity = 1;
								*/
								}
							}
						}
					}
				}
			}

			var Result = true;
			if (UInv.isProperty(State.variables, "UInvBags")) {
				delete State.variables.UInvBags;
				State.variables.UInvBags = {};
				Result = false;
			} else {
				State.variables.UInvBags = {};
			}
			if (UInv.isProperty(State.variables, "UInvCurrentBagName")) {
				delete State.variables.UInvCurrentBagName;
				Result = false;
			}
			if (UInv.isProperty(State.variables, "UInvCurrentItemName")) {
				delete State.variables.UInvCurrentItemName;
				Result = false;
			}
			if (UInv.isProperty(State.variables, "UInvErrorStringAddendum")) {
				delete State.variables.UInvErrorStringAddendum;
				Result = false;
			}
			if (UInv.isUndefined(setup.UInvUserAlertsDebug)) {
				if (UInv.isProperty(State.variables, "UInvShowAlerts")) {
					if (UInv.isUndefined(ErrorSetting)) {
						UInv.SetUserAlerts(false);
					} else {
						UInv.SetUserAlerts(ErrorSetting);
					}
					Result = false;
				} else {
					if (ErrorSetting) {
						UInv.SetUserAlerts(ErrorSetting);
					}
				}
			} else {
				UInv.SetUserAlerts(setup.UInvUserAlertsDebug);  /* "xyzzy" debug override */
				if (UInv.isUndefined(ErrorSetting)) {
					setup.UInvUserAlertsBackup = false;
				} else {
					setup.UInvUserAlertsBackup = ErrorSetting;
				}
				console.log('UInv: Game reinitialized with console logging enabled through debug override. Type "xyzzy" while on game window to cancel.');
			}
			if (UInv.isProperty(State.variables, "UInvLastErrorMessage")) {
				Result = false;
			}
			UInv.ClearErrors();
			if (UInv.isProperty(State.variables, "UInvMergeItemMethod")) {
				Result = false;
			}
			UInv.SetMergeItemMethod(UInv.MERGE_USE_ONLY_DESTINATION_PROPERTIES);  /* default */
			if (UInv.isProperty(State.variables, "UInvEventHandlers")) {
				delete State.variables.UInvEventHandlers;
				State.variables.UInvEventHandlers = {};
				Result = false;
			} else {
				State.variables.UInvEventHandlers = {};
			}
			/* Prepare radial menu */
			var div = $("#uinv-radial-menu").get(0);
			if (UInv.isUndefined(div)) {
				UInv.InitializeRadialMenu();
			}
			/* Set up mouse down and up event handlers */
			$(document).on("mousedown", handleMouseDown);
			$(document).on("mouseup", handleMouseUp);
			$("html").css("height", "100%");  /* Make sure the whole window is covered so horizontal scrollbars can be properly detected. */
			return Result;
		},

		/* Version: Return a string showing the version of UInv. */
		Version : function () {
			return "Universal Inventory System (<a href='https://github.com/HiEv/UInv'>UInv</a>) v0.9.7.2 by HiEv";  /* Success */
		},


		/* ------------------------------------------------------ */
		/*  END OF COPY-AND-PASTE SECTION FOR UPDATING UInv CODE  */
		/* --------------------------8<-------------------------- */


		/* UInv Aliases: */
		/* ============= */

		/* Add your own function aliases here.  Make sure they are not named the same as any of the existing functions. */

		AddToBagValue : function (BagName, BagPropertyName, Amount) {
			return UInv.AddToBagPropertyValue(BagName, BagPropertyName, Amount);
		},

		AddToItemValue : function (BagName, ItemName, ItemPropertyName, Amount) {
			return UInv.AddToItemPropertyValue(BagName, ItemName, ItemPropertyName, Amount);
		},

		ArrayHasAllBagProperties : function (BagName, BagPropertyNameArray) {
			return UInv.BagHasAllProperties(BagName, BagPropertyNameArray);
		},

		ArrayHasAllItemProperties : function (BagName, ItemName, ItemPropertyNameArray) {
			return UInv.ItemHasAllProperties(BagName, ItemName, ItemPropertyNameArray);
		},

		BagArray : function () {
			return UInv.GetBagsArray();
		},

		BagCount : function () {
			return UInv.GetBagCount();
		},

		BagsExist : function (BagNameArray) {
			return UInv.BagExists(BagNameArray);
		},

		BagHasAnyBagTags : function (BagName, BagPropertyName, BagTagArray) {
			return UInv.BagHasAnyBagTag(BagName, BagPropertyName, BagTagArray);
		},

		BagHasAnyItemTags : function (BagName, ItemPropertyName, ItemTagArray) {
			return UInv.BagHasAnyItemTag(BagName, ItemPropertyName, ItemTagArray);
		},

		BagHasContainer : function (BagName) {
			return UInv.BagIsPocket(BagName);
		},

		BagHasProperties : function (BagName, BagPropertyNameArray) {
			return UInv.BagHasProperty(BagName, BagPropertyNameArray);
		},

		CopyBagProperties : function (SourceBagName, DestinationBagName, BagPropertyNameArray) {
			return UInv.CopyBagProperty(SourceBagName, DestinationBagName, BagPropertyNameArray);
		},

		GetBagArrayWithAllProperties : function (BagPropertyNameArray) {
			return UInv.GetBagsArrayWithAllProperties(BagPropertyNameArray);
		},

		GetBagValue : function (BagName, BagPropertyName) {
			return UInv.GetBagPropertyValue(BagName, BagPropertyName);
		},

		GetCellsItemName : function (BagName, Cell) {
			return UInv.GetItemWherePropertyEquals(BagName, "UInvCell", Cell);
		},

		GetHighestBagPropertyValue : function (BagPropertyName, BagNameArray) {
			return UInv.GetBagWithHighestPropertyValue(BagPropertyName, BagNameArray);
		},

		GetHighestBagValue : function (BagPropertyName, BagNameArray) {
			return UInv.GetBagWithHighestPropertyValue(BagPropertyName, BagNameArray);
		},

		GetHighestItemPropertyValue : function (BagName, ItemPropertyName) {
			return UInv.GetItemWithHighestPropertyValue(BagName, ItemPropertyName);
		},

		GetLowestBagPropertyValue : function (BagPropertyName, BagNameArray) {
			return UInv.GetBagWithLowestPropertyValue(BagPropertyName, BagNameArray);
		},

		GetLowestBagValue : function (BagPropertyName, BagNameArray) {
			return UInv.GetBagWithLowestPropertyValue(BagPropertyName, BagNameArray);
		},

		GetLowestItemPropertyValue : function (BagName, ItemPropertyName) {
			return UInv.GetItemWithLowestPropertyValue(BagName, ItemPropertyName);
		},

		GetItemQuantity : function (BagName, ItemName) {
			return UInv.BagHasItem(BagName, ItemName);
		},

		GetItemValue : function (BagName, ItemName, ItemPropertyName) {
			return UInv.GetItemPropertyValue(BagName, ItemName, ItemPropertyName);
		},

		HasItem : function (BagName, ItemName) {
			return UInv.BagHasItem(BagName, ItemName);
		},

		ItemHasAnyTags : function (BagName, ItemName, ItemPropertyName, ItemTagArray) {
			return UInv.ItemHasAnyTag(BagName, ItemName, ItemPropertyName, ItemTagArray);
		},

		ItemIsContainer : function (BagName, ItemName, PocketName) {
			return UInv.ItemHasPocket(BagName, ItemName, PocketName);
		},

		ItemQuantity : function (BagName, ItemName) {
			return UInv.BagHasItem(BagName, ItemName);
		},

		SetBagsPropertyValue : function (BagNameArray, BagPropertyName, Value) {
			return UInv.SetBagPropertyValue(BagNameArray, BagPropertyName, Value);
		},

		SetBagsTouched : function (BagNameArray) {
			return UInv.SetBagTouched(BagNameArray);
		},

		SetBagsUntouched : function (BagNameArray) {
			return UInv.SetBagUntouched(BagNameArray);
		},

		SetBagValue : function (BagName, BagPropertyName, Value) {
			return UInv.SetBagPropertyValue(BagName, BagPropertyName, Value);
		},

		SetItemsPropertyValues : function (BagName, ItemPropertyName, Value) {
			return UInv.SetItemsPropertyValue(BagName, ItemPropertyName, Value);
		},

		SetItemValue : function (BagName, ItemName, ItemPropertyName, Value) {
			return UInv.SetItemPropertyValue(BagName, ItemName, ItemPropertyName, Value);
		},

		UpdateItemProperties : function (BagName, ItemName, ValuesObject) {
			return UInv.SetItemPropertyValues(BagName, ItemName, ValuesObject);
		},

		/* End of aliases. */


		/* UInv Developer Data Functions: */
		/* ============================== */

		/* BagData: This is where you set the default properties and/or */
		/*          items for the default bags. */
		BagData : function (DefaultBagType, PropertiesOnly) {
			var BagProperties = {}, BagItems = [];
			switch(DefaultBagType) {

		/*  IMPORTANT!:
			Bag types must be unique strings in all lowercase.
			Bag types cannot be "-" (the minus sign) or "" (an empty string).
			Property names can be upper and/or lowercase strings.
			Property names with spaces in them must be inside quotes.
			Property names are case sensitive, so a property named "XYZ"
			is different from properties named "Xyz" or "xyz".
			Bag and property names cannot start with a number.
			An bag cannot have more than one property with the same name.
			Property values can be strings, numbers, booleans, or arrays.
			Objects and functions are unsupported property value types.
			Multiple successive case lines with no "break;" between them
			will be treated as different bags with the same properties.
			Quote marks inside strings need to have a backslash before
			them.  (e.g. "Bob said, \"Hello.\"")
			Backslashes will also need a backslash before them.

			New bags should be added in the following format:

			case "unique-lowercase-bag-name-string":
				BagProperties = {
						unique-property-name1-string : property-value1,
						unique-property-name2-string : property-value2,
						...
					};
				BagItems = [

						// String Method = 1 item of that type
						"item-name-string1",

						// Quantity Method = Quantity items of that type
						{ item-name-string2 : Quantity },  // Quantity must be an integer

						// Type Method = UInvQuantity items of type UInvDefaultItemType
						{ item-name-string3 : { UInvDefaultItemType : "item-type",  UInvQuantity : Quantity } },

						// Creation Method = UInvQuantity items of type UInvDefaultItemType
						{ item-name-string4 : { UInvQuantity : Quantity,  property-name1 : value1,  ... } },

						...
					];
					// Use the String Method for single items of a default type,
					// the Quantity Method for multiple items of a default type,
					// the Type Method for items whose type doesn't match the item name,
					// or the Creation Method to create items without a default type.
					// All items should be passed as a single array of items.
				break;  // This ends the current "case" statement.

			The BagProperties and BagItems lines are optional.  You can
			leave either of them out if you don't need to set the bag's
			properties or items, respectively.

			For a bag's items, you can add them a couple of ways.  Use the
			String Method (as shown above) for single items of a default type,
			the Quantity Method for multiple items of a default type, the
			Type Method for items whose type doesn't match the item name
			(UInvQuantity defaults to 1 if not included), or the Creation
			Method to create items without a default type.  If you combine the
			Type Method and Creation Method by having "UInvDefaultItemType"
			plus other properties, then it will use the default type and have
			the other properties override that type's default properties.

			Generally it's recommended that you create a default item instead
			of using the Creation Method for adding default items to bags,
			though it can be useful for adding items with no properties, or
			when used in combination with the Type Method.

			Item names must be formatted as described in the ItemData section.

			NOTE: If any of a bag's _properties_ are variable, then in
			BagProperties the property "UInvVariableType" has to be set to
			something (it doesn't matter what).  However, you do *NOT* need
			to add the "UInvVariableType" property if any of the _items_ that
			may be in the bag can vary.

			It's recommended that you list your bags alphabetically both
			to help avoid duplicating names and to make them easier to find
			if you need to modify them later.

			Example bags below can be removed.

		YOUR DEFAULT BAGS GO BELOW THIS LINE.  */

		/* Start of example bags. */

				case "backpack":
					BagProperties = { maxCarryWeight : 100 };  /* This sets the "maxCarryWeight" property of the "backpack" type bag to 20. */
					break;  /* This ends the current "case" statement. */

		/* End of example bags. */

		/* YOUR DEFAULT BAGS GO ABOVE THIS LINE. */

				default:
					return undefined;  /* Bag not found */
			}
			if (PropertiesOnly) {
				return BagProperties;
			} else {
				return BagItems;
			}
		},


		/* ItemData: This is where you set the default properties for the */
		/*           default items. */
		ItemData : (function () {
			var Items = {};

		/*  IMPORTANT!:       --Static Items Information--
			Items with consistent default property values are "static items".
			Items with property values that may vary are "variable items".
			Item names must be unique strings in all lowercase.
			Item names cannot be "uinvtouched", "uinvproperties",
			"uinvdefaultbagtype", "uinvcontainer", "-" (the minus sign),
			or "" (an empty string), they're reserved for use by UInv.
			Property names can be upper and/or lowercase strings.
			Property names with spaces in them must be inside quotes.
			Property names are case sensitive, so a property named "XYZ"
			is different from properties named "Xyz" or "xyz".
			Item and property names cannot start with a number.
			An item cannot have more than one property with the same name.
			An item cannot have a property named "UInvQuantity" or
			"UInvDefaultItemType", they're reserved for use by UInv.
			Property values can be strings, numbers, booleans, or arrays.
			Objects and functions are unsupported property value types.
			Quote marks inside strings need to have a backslash before
			them.  (e.g. "Bob said, \"Hello.\"")
			Backslashes will also need a backslash before them.

			Static items should be added in the following format:

			Items.itemname = { property-name-string1 : property-value1,
							property-name-string2 : property-value2,
							etc...
							};

			"itemname" must be a unique, lowercase, alphanumberic string which
			cannot start with a number.  If it contains a space then it needs
			to be in this format:

			Items['item name'] = { property-name-string1 : property-value1,
								property-name-string2 : property-value2,
								etc...
								};

			If an item's properties are variable, then they should be set in
			the "variable items" section instead (see below).

			It's recommended that you list your items alphabetically both
			to help avoid duplicating names and to make them easier to find
			if you need to modify them later.

			Example items below can be removed.

		YOUR DEFAULT -STATIC ITEMS- GO BELOW THIS LINE.  */

		/* Start of example static items. */

			Items.backpack = {
				type : ["wearable", "container"],
				UInvPocket : { inside: "backpack", "front pocket": "-" },  /* pockets: "inside" and "front pocket" */
				singular : "a backpack",
				plural : "backpacks",
				size : 20,
				description : "A leather satchel with a pocket on the front and sturdy straps so you can wear it on your back."
			};

			Items.lari = {
				name: "Lari",
				type : ["money"],
				singular : "a lari",
				plural : "laris",
				size : 0,
				description : "The main currency used in Nipon. Equal to 100 tetri."
			};

			Items.tetri = {
				name: "Tetri",
				type : ["money"],
				singular : "a tetri",
				plural: "tetris",
				size: 0,
				description : "The main currency used in Nipon. There is 100 tetri to a lari."
			};

			Items.gold = {
				name: "Gold Ingot",
				type: ["commodity"],
				singular : "a gold ingot",
				plural : "gold ingots",
				size: 1,
				description: "A common commodity for trade."
			};

			Items.silver = {
				name: "Silver Ingot",
				type: ["commodity"],
				singular : "a silver ingot",
				plural : "silver ingots",
				size: 1,
				description: "A common commodity for trade."
			};

			Items.iron = {
				name: "Iron Ingot",
				type: ["commodity"],
				singular : "a silver ingot",
				plural : "silver ingots",
				size: 1,
				description: "A common commodity for trade."
			};

			Items.hiroyuki_book = {
				name: "Hiroyuki Family Registry",
				type: ["quest_item"],
				size: 0,
				description: "An old tattered book containing the complete family tree of the \
					Hiroyuki household."
			};
			Items.nipon_transaction_log = {
				name: "Nipon Transaction Log",
				type: ["quest_item"],
				size: 0,
				description: "A stack of papers containing various hard-to-understand tables, graphs \
					and charts. Seems to be related to trade import and export repots."
			};

			Items.hironaka_amulet = {
				name: "Hironaka Amulet",
				type: ["accessory"],
				place: "neck",
				description: "A necklace that can only be unlocked with a key given to all the slaves in the \
					Hiroyuki household."
			};

			Items.strap_on = { 
				name: "Strap On",
				type: ["accessory"], 
				singular: "a strap on", 
				plural: "strap ons", 
				place: "groin", 
				size: 2, 
				description: "A makeshift strap-on penis made of soft silicon."
			};

			Items.leather_chestplate = {
				name: "Leather Chestplate",
				type: ["armor", "leather"],
				place: "chest",
				singular: "a leather chestplate",
				plural: "leather chestplates",
				size: 10,
				description: "A standard leather chestplate for protection against arrows and swords."
			};

		/* End of example static items. */

		/* YOUR DEFAULT -STATIC ITEMS- GO ABOVE THIS LINE. */

			return function (DefaultItemType) {
				if (!UInv.isString(DefaultItemType)) {
					UInvError('ItemData failed. DefaultItemType is not a string.');  /* Error */
					return undefined;
				}
				var Item = undefined;  /* jshint ignore:line */
				switch(DefaultItemType) {

			/*  IMPORTANT!:       --Variable Items Information--
				Items with consistent default property values are "static items".
				Items with property values that may vary are "variable items".
				Item names, property names, and property values for variable
				items must follow the same rules as the static items above.

				If an item's property values are variable, then the property
				"UInvVariableType" has to be set to something (it doesn't
				matter what).

				Variable items should be added in the following format:

				case "itemname":
					// Other code may go here.
					Item = { property-name-string1 : property-value1,
							property-name-string2 : property-value2,
							... };
					break;  // This ends the current "case" statement.

				Example items below can be removed.

			YOUR DEFAULT -VARIABLE ITEMS- GO BELOW THIS LINE.  */

			/* Start of example variable items. */

					case "bow":  /* Gives you a bow with 10 to 20 arrows. */
						Item = { arrows: random(10, 20), type : ["weapon", "ranged", "piercing", "2-handed"], singular : "a bow", plural : "bows", size : 5, image : "bow.png", description : "A bow." };
						break;  /* This ends the current "case" statement. */

					case "rainbow potion":  /* This produces a potion item of a random color. */
						var color = ["red", "orange", "yellow", "green", "blue", "purple"].random();  /* Randomly picks a color. */
						var article = color === "orange" ? "an " : "a ";  /* Sets the "article" variable to "a ", unless the color equals "orange", in that case it sets it to "an ". */
						Item = {
							UInvVariableType : color,  /* Because this item's property values can vary, the "UInvVariableType" property has to be set to something. */
							type : ["potion"],
							singular : article + color + " potion",
							plural : color + " potions",
							size : 1,
							image : "potion" + color.toUpperFirst() + ".png",
							description : article.toUpperFirst() + color + " potion."
						};
						break;  /* This ends the current "case" statement. */

			/* End of example variable items. */

			/* YOUR DEFAULT -VARIABLE ITEMS- GO ABOVE THIS LINE. */

				}
				if (UInv.isUndefined(Item)) {  /* If it's not a variable type... */
					if (UInv.isProperty(Items, DefaultItemType)) {
						return clone(Items[DefaultItemType]);  /* Static item */
					} else {
						return undefined;  /* Item not found */
					}
				} else {  /* If it *is* a variable type... */
					if (!UInv.isProperty(Item, "UInvVariableType")) {  /* Add UInvVariableType property if it's missing. */
						Item.UInvVariableType = true;
					}
					return Item;  /* Variable item */
				}
			};
		})(),

/* OPTIONAL: You can list the names of your default bags here so
             you can find them by searching "UInv.BagList[index]". */
		BagList: ["backpack"],

/* OPTIONAL: You can list the names of your default items here so
             you can find them by searching "UInv.ItemList[index]". */
		ItemList: ["backpack", "lari"]
	};
})();
window.UInv = new UInvObject();  /* Create the UInv object */

/* NOTE:
   It's recommended that you pass "UInv.Initialize" (below) the value
	 of "UInv.ERROR_THROW_ERROR" and/or "UInv.ERROR_TO_CONSOLE" when
	 testing your code.
*/
UInv.Initialize(UInv.ERROR_NONE);  /* Readies UInv variables and events */

/* Uncomment the line following this comment (remove the leading "// ")
   and set it to something else if you prefer a different manner of
	 dealing with item collisions.
*/
// UInv.SetMergeItemMethod(UInv.MERGE_USE_ONLY_DESTINATION_PROPERTIES);

/*
	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	!!                                                             !!
	!!  REMINDER: If you're updating UInv you should only replace  !!
	!!  the code up to the "END OF COPY-AND-PASTE" marker above!   !!
	!!                                                             !!
	!!  DO NOT ACCIDENTALLY OVERWRITE YOUR DEFAULT BAGS & ITEMS!   !!
	!!                                                             !!
	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
*/

/* -- End of Universal Inventory System (UInv) code -- */
/* twine-user-script #5: "assignments.js" */
setup.assignments = {
    "none": {
        "flavor_text": "performed their usual duties."
    },
    "serveShintani": {
        "flavor_text": "served Shintani.",
        "player": {
            "slave_traits": {
                "trust": 2
            }
        }
    },
    "serveYou": {
        "flavor_text": "served you as a maid.",
        "self": {
            "slave_traits": {
                "obedience": -2,
                "min_obedience": 0,
                "willpower": -2,
                "min_willpower": 40
            }
        }
    },
    "solBrothel": {
        "flavor_text": "whored themselves at the Sol Brothel.",
    },
    "fuckToy": {
        "flavor_text": "served as your fuck toy.",
        "self": {
            "slave_traits": {
                "willpower": -2,
                "min_willpower": 40
            },
            "sex_skills": {
                'anal': 0.05, 
                'oral': 0.05, 
                'vaginal': 0.05, 
                'entertainment': 0.05, 
                'other': 0.05
            },
            "understand": {
                "sex_prefs": 0.1,
                "sex_fetishes": 0.05
            }
        }
    },
    "freeTime": {
        "flavor_text": "took time off to relax.",
        "self": {
            "slave_traits": {
                "obedience": 2,
                "willpower": 1
            }
        }
    },
    "study": {
        "flavor_text": "spent time studying.",
        "self": {
            "slave_traits": {
                "obedience": 2,
                "trust": 1,
                "willpower": 1
            },
            "mental_conditions": {
                "rebellion": 1
            },
            "stats": {
                "intelligence": 0.05
            }
        },
        "cost": 25
    },
    "train": {
        "flavor_text": "spent time training.",
        "self": {
            "slave_traits": {
                "obedience": 2,
                "trust": 1,
                "willpower": 1
            },
            "stats": {
                "dexterity": 0.05,
                "strength": 0.05,
            },
            "skills": {
                "melee": 0.05,
                "ranged": 0.05
            }
        },
        "cost": 50
    }
};
/* twine-user-script #6: "core.js" */
$('#ui-bar').remove();
$(document.head).find('#style-ui-bar').remove();
/* twine-user-script #7: "diets.js" */
setup.diets = {
    "amount": {
        "limited": {

        },
        "abundant": {

        }
    },
    "additives": {
        "cumAdded": {
            "flavor_text": "\'s food had a small amount of your cum in every bite, without knowing it, they \
                grew more fond of cum.",
            "self": {
                "mental_conditions": {
                    "cum_addiction": 1
                },
                "sex_fetishes": {
                    "cum": 1
                }
            },
            "player": {
                "conditions": {
                    "stamina": -10
                }
            }
        },
        "cumBased": {
            "flavor_text": "\'s food consisted of only your cum, by the end of the day it was the only taste \
                in their mouth.",
            "player": {
                "conditions": {
                    "stamina": -30
                }
            }
        },
    },
    "serveShintani": {
        "flavor_text": "served Shintani.",
        "player": {
            "slave_traits": {
                "trust": 2
            }
        }
    },
    "serveYou": {
        "flavor_text": "served you as a maid.",
        "self": {
            "slave_traits": {
                "obedience": -2,
                "min_obedience": 0,
                "willpower": -2,
                "min_willpower": 40
            }
        }
    },
    "solBrothel": {
        "flavor_text": "whored themselves at the Sol Brothel.",
    },
    "fuckToy": {
        "flavor_text": "served as your fuck toy.",
        "self": {
            "slave_traits": {
                "willpower": -2,
                "min_willpower": 40
            },
            "sex_skills": {
                'anal': 0.05, 
                'oral': 0.05, 
                'vaginal': 0.05, 
                'entertainment': 0.05, 
                'other': 0.05
            },
            "understand": {
                "sex_prefs": 0.1,
                "sex_fetishes": 0.05
            }
        }
    },
    "freeTime": {
        "flavor_text": "took time off to relax.",
        "self": {
            "slave_traits": {
                "obedience": 2,
                "willpower": 1
            }
        }
    },
    "study": {
        "flavor_text": "spent time studying.",
        "self": {
            "slave_traits": {
                "obedience": 2,
                "trust": 1,
                "willpower": 1
            },
            "mental_conditions": {
                "rebellion": 1
            },
            "stats": {
                "intelligence": 0.05
            }
        },
        "cost": 25
    },
    "train": {
        "flavor_text": "spent time training.",
        "self": {
            "slave_traits": {
                "obedience": 2,
                "trust": 1,
                "willpower": 1
            },
            "stats": {
                "dexterity": 0.05,
                "strength": 0.05,
            },
            "skills": {
                "melee": 0.05,
                "ranged": 0.05
            }
        },
        "cost": 50
    }
};
/* twine-user-script #8: "influence.js" */
/* DEPENDS ON PLAYER - DO NOT RUN UNTIL AFTER INTRO */

setup.influence = {};
setup.init_influence = function() {
    var player = State.variables.player;
    setup.influence = {
        "compliment": {
            "success": [
                [player.dialogue("You know I really admire how hard you work.")],
                [player.dialogue("Hey I just wanted to..."), 
                    "You stop in your tracks when their eyes meet yours.",
                    player.dialogue("Sorry I lost my train of thought, you\'re just so \
                    lovely to look at.")
                ],
                [player.dialogue("Hey I just wanted to..."), 
                    "You stop in your tracks when their eyes meet yours.",
                    player.dialogue("Sorry I just got lost in your eyes for a moment.")
                ],
                [player.dialogue("I\'m really glad I get to spent time with you like this.")],
                [player.dialogue("You\'re my favorite out of everyone here.")],
                [player.dialogue("I was having a bad day but seeing you made everything better.")],
                [player.dialogue("Did you get a new perfume? You smell wonderful.")],
            ],
            "fail": [
                [player.dialogue("You work really hard... I mean of course you do, uh, nevermind.")],
                [player.dialogue("You uh... look nice today.")],
                [player.dialogue("Time with you great, I mean is great... I like spending..."),
                    "Your voice drifts off."],
                [player.dialogue("I was having a bad day and then I saw you..."),
                    "You realize you mispoke when you see their face of offense",
                    player.dialogue("As in now it\'s better! You made my bad day better!")],
                [player.dialogue("You smell nice... Wait that sounds creepy, sorry.")],
                [player.dialogue("Did I ever tell you how beautiful I was? I mean you are?")]
            ]
        },
        "joke": {
            "success": [
                [player.dialogue("You know, the problem with kleptomaniacs is that they always \
                    take things literally.")],
                [player.dialogue("You know, a recent study has found that women who carry a little \
                    extra weight live longer than the men who mention it.")],
                [player.dialogue("A book fell on my head the other day. I only have my shelf to blame though.")],
                [player.dialogue("You know, people who take care of chickens are literally chicken \
                    tenders.")],
                [player.dialogue("One of the cows didn’t produce milk today. It was an udder failure.")],
                [player.dialogue("I just realized, despite the high cost of living, it remains popular.")],
                [player.dialogue("My friend’s bakery burned down last night. Now his business is toast.")],
            ],
            "fail": [
                [player.dialogue("What do you call a uh, ship without a sail? Nevermind.")],
                [player.dialogue("Who is the princess of jokes?... Re-pun-zel."),
                    "Their puzzled face reminds you that the fairytales you grew up with don\'t \
                    exist here."
                ],
                [player.dialogue("So how about that airline food huh?"),
                    "You suddenly remember that while airplanes exist in rarity, \
                    <em>airline food</em> is definitely not canon."
                ],
                [player.dialogue("Knock knock."),
                    "You are met with silence,",
                    player.dialogue("You\'re supposed to say <em>Who\'s there?</em>... nevermind.")
                ]
            ]
        },
        "dirty_comment": {
            "success": [
                [player.dialogue("If you ever need a hand, you\'ll have to take another part of me too.")]
            ],
            "fail": [
                [player.dialogue("I bet you love screaming at night... I mean like, nevermind.")],
                [player.dialogue("Do you like eating pussy? I mean cats... wait no, uh, nevermind.")],
                [player.dialogue("I\'m so horny right now, the horn of... nevermind.")],
                [player.dialogue("I\'d do anything to get you out of your clothes, wait no I mean... uh, nevermind.")]
            ]
        }
    }
}
/* twine-user-script #9: "locations.js" */
setup.locations = new setup.LocationNode("world");
setup.locations.add_sublocation("east");
setup.locations.get("east").name = "East";

/* Nipon */
setup.locations.get("east").add_sublocation("nipon");
setup.locations.get("nipon").name = "Nipon";

    /* Central district of Nipon */
    setup.locations.get("nipon").add_sublocation("niponCentral");
    setup.locations.get("niponCentral").passage = "niponCentral";
    setup.locations.get("niponCentral").name = "Central";

        /* Shintani's home  */
        setup.locations.get("niponCentral").add_sublocation("shintaniHome");
        setup.locations.get("shintaniHome").passage = "shintaniHome";
        setup.locations.get("shintaniHome").name = "Shintani's Home";
        setup.locations.get("shintaniHome").inside = true;
        setup.locations.add_distance("niponCentral", "shintaniHome", 15);

            /* Shintani's home library */
            setup.locations.get("shintaniHome").add_sublocation("shintaniHomeLibrary");
            setup.locations.get("shintaniHomeLibrary").passage = "shintaniHomeLibrary";
            setup.locations.get("shintaniHomeLibrary").name = "Shintani's Library";
            setup.locations.get("shintaniHomeLibrary").inside = true;
            setup.locations.add_distance("shintaniHome", "shintaniHomeLibrary", 3);

        /* Nipon Academy */
        setup.locations.get("niponCentral").add_sublocation("niponAcademy");
        setup.locations.get("niponAcademy").passage = "niponAcademy";
        setup.locations.get("niponAcademy").name = "Academy";
        setup.locations.get("niponAcademy").access_times = [14, 20];
        setup.locations.get("niponAcademy").inside = true;
        setup.locations.add_distance("niponCentral", "niponAcademy", 31);

        /* Nipon Arena */
        setup.locations.get("niponCentral").add_sublocation("niponArena");
        setup.locations.get("niponArena").passage = "niponArena";
        setup.locations.get("niponArena").name = "Arena";
        setup.locations.get("niponArena").access_times = [14, 20];
        setup.locations.add_distance("niponCentral", "niponArena", 27);

        /* Nipon Barracks */
        setup.locations.get("niponCentral").add_sublocation("niponBarracks");
        setup.locations.get("niponBarracks").passage = "niponBarracks";
        setup.locations.get("niponBarracks").name = "Barracks";
        setup.locations.get("niponBarracks").access_times = [7, 20];
        setup.locations.get("niponBarracks").inside = true;
        setup.locations.add_distance("niponCentral", "niponBarracks", 10);

        /* Central Docks  */
        setup.locations.get("niponCentral").add_sublocation("niponCentralDocks");
        setup.locations.get("niponCentralDocks").passage = "niponCentralDocks";
        setup.locations.get("niponCentralDocks").name = "Central Docks";
        setup.locations.get("niponCentralDocks").access_times = [0, 24];
        setup.locations.add_distance("niponCentral", "niponCentralDocks", 25);

        /* Lia's Tower */
        setup.locations.get("niponCentral").add_sublocation("liasTower");
        setup.locations.get("liasTower").passage = "liasTower";
        setup.locations.get("liasTower").name = "Lia\'s Tower";
        setup.locations.get("liasTower").access_times = [20, 24];
        setup.locations.get("liasTower").inside = true;
        setup.locations.add_distance("niponCentral", "liasTower", 30);

        /* Sol Brothel  */
        setup.locations.get("niponCentral").add_sublocation("solBrothel");
        setup.locations.get("solBrothel").passage = "solBrothel";
        setup.locations.get("solBrothel").name = "Sol Brothel";
        setup.locations.get("solBrothel").access_times = [18, 5];
        setup.locations.get("solBrothel").inside = true;
        setup.locations.add_distance("niponCentral", "solBrothel", 10);

        /* Nipon Town Hall */
        setup.locations.get("niponCentral").add_sublocation("niponTownHall");
        setup.locations.get("niponTownHall").passage = "niponTownHall";
        setup.locations.get("niponTownHall").name = "Town Hall";
        setup.locations.get("niponTownHall").access_times = [7, 20];
        setup.locations.get("niponTownHall").inside = true;
        setup.locations.add_distance("niponCentral", "niponTownHall", 23);

        /* Yuki's Gourmet */
        setup.locations.get("niponCentral").add_sublocation("yukisGourmet");
        setup.locations.get("yukisGourmet").passage = "yukisGourmet";
        setup.locations.get("yukisGourmet").name = "Yuki\'s Gourmet";
        setup.locations.get("yukisGourmet").access_times = [11, 22];
        setup.locations.get("yukisGourmet").inside = true;
        setup.locations.add_distance("niponCentral", "yukisGourmet", 13);

    /* Market district of Nipon */
    setup.locations.get("nipon").add_sublocation("niponMarket");
    setup.locations.get("niponMarket").passage = "niponMarket";
    setup.locations.get("niponMarket").name = "Market";
    setup.locations.add_distance("niponMarket", "niponCentral", 60);
    setup.locations.add_distance("niponMarket", "shintaniHome", 75);

        /* Auction House */
        setup.locations.get("niponMarket").add_sublocation("niponAuctionHouse");
        setup.locations.get("niponAuctionHouse").passage = "niponAuctionHouse";
        setup.locations.get("niponAuctionHouse").name = "Auction House";
        setup.locations.get("niponAuctionHouse").access_times = [12, 22];
        setup.locations.get("niponAuctionHouse").inside = true;
        setup.locations.add_distance("niponAuctionHouse", "niponMarket", 10);

        /* Nipon Blacksmith */
        setup.locations.get("niponMarket").add_sublocation("niponBlacksmith");
        setup.locations.get("niponBlacksmith").passage = "niponBlacksmith";
        setup.locations.get("niponBlacksmith").name = "Blacksmith";
        setup.locations.get("niponBlacksmith").access_times = [10, 20];
        setup.locations.get("niponBlacksmith").inside = true;
        setup.locations.add_distance("niponBlacksmith", "niponMarket", 17);

        /* Nipon Farms */
        setup.locations.get("niponMarket").add_sublocation("niponFarms");
        setup.locations.get("niponFarms").passage = "niponFarms";
        setup.locations.get("niponFarms").name = "Farms";
        setup.locations.get("niponFarms").access_times = [0, 24];
        setup.locations.add_distance("niponFarms", "niponMarket", 31);

        /* Market Docks */
        setup.locations.get("niponMarket").add_sublocation("niponMarketDocks");
        setup.locations.get("niponMarketDocks").passage = "niponMarketDocks";
        setup.locations.get("niponMarketDocks").name = "Market Docks";
        setup.locations.get("niponMarketDocks").access_times = [7, 22];
        setup.locations.add_distance("niponMarketDocks", "niponMarket", 14);

        /* Nipon Mines */
        setup.locations.get("niponMarket").add_sublocation("niponMines");
        setup.locations.get("niponMines").passage = "niponMines";
        setup.locations.get("niponMines").name = "Mines";
        setup.locations.get("niponMines").access_times = [7, 22];
        setup.locations.add_distance("niponMines", "niponMarket", 20);

        /* Stalls */
        setup.locations.get("niponMarket").add_sublocation("niponStalls");
        setup.locations.get("niponStalls").passage = "niponStalls";
        setup.locations.get("niponStalls").name = "Stalls";
        setup.locations.get("niponStalls").access_times = [8, 16];
        setup.locations.add_distance("niponStalls", "niponMarket", 5);

        /* Nipon Theater */
        setup.locations.get("niponMarket").add_sublocation("niponTheater");
        setup.locations.get("niponTheater").passage = "niponTheater";
        setup.locations.get("niponTheater").name = "Theater";
        setup.locations.get("niponTheater").access_times = [18, 22];
        setup.locations.add_distance("niponTheater", "niponMarket", 10);

        /* Trade Union */
        setup.locations.get("niponMarket").add_sublocation("niponTradeUnion");
        setup.locations.get("niponTradeUnion").passage = "niponTradeUnion";
        setup.locations.get("niponTradeUnion").name = "Trade Union";
        setup.locations.get("niponTradeUnion").access_times = [7, 18];
        setup.locations.get("niponTradeUnion").inside = true;
        setup.locations.add_distance("niponTradeUnion", "niponMarket", 10);

    /* Slums of Nipon */
    setup.locations.get("nipon").add_sublocation("niponSlums");
    setup.locations.get("niponSlums").passage = "niponSlums";
    setup.locations.get("niponSlums").name = "Slums";
    setup.locations.add_distance("niponSlums", "niponCentral", 80);
    setup.locations.add_distance("niponSlums", "shintaniHome", 95);
    setup.locations.add_distance("niponSlums", "niponMarket", 40);

        /* Camp Grounds */
        setup.locations.get("niponSlums").add_sublocation("niponCampGrounds");
        setup.locations.get("niponCampGrounds").passage = "niponCampGrounds";
        setup.locations.get("niponCampGrounds").name = "Camp Grounds";
        setup.locations.get("niponCampGrounds").access_times = [0, 24];
        setup.locations.add_distance("niponCampGrounds", "niponSlums", 40);

        /* Divine Touch Brothel */
        setup.locations.get("niponSlums").add_sublocation("divineTouchBrothel");
        setup.locations.get("divineTouchBrothel").passage = "divineTouchBrothel";
        setup.locations.get("divineTouchBrothel").name = "Divine Touch";
        setup.locations.get("divineTouchBrothel").access_times = [14, 5];
        setup.locations.get("divineTouchBrothel").inside = true;
        setup.locations.add_distance("divineTouchBrothel", "niponSlums", 20);

        /* Sonder Ville */
        setup.locations.get("niponSlums").add_sublocation("sonderVille");
        setup.locations.get("sonderVille").passage = "sonderVille";
        setup.locations.get("sonderVille").name = "Sonder Ville";
        setup.locations.get("sonderVille").access_times = [0, 24];
        setup.locations.add_distance("divineTouchBrothel", "sonderVille", 15);

        /* Vale Community */
        setup.locations.get("niponSlums").add_sublocation("valeCommunity");
        setup.locations.get("valeCommunity").passage = "valeCommunity";
        setup.locations.get("valeCommunity").name = "Vale Community";
        setup.locations.get("valeCommunity").access_times = [0, 24];
        setup.locations.add_distance("valeCommunity", "niponSlums", 20);

/* Set music for different locations */
setup.locations.get("nipon").music = "bgm_nipon";
setup.locations.get("shintaniHome").music = "bgm_shintaniHome";
/* twine-user-script #10: "articles.min.js" */
// articles.min.js, for SugarCube 2, by Chapel
// v1.0.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var e=new Map,r=["eunuch","eucalyptus","eugenics","eulogy","euphemism","euphony","euphoria","eureka","european","euphemistic","euphonic","euphoric","euphemistically","euphonically","euphorically","heir","heiress","herb","homage","honesty","honor","honour","hour","honest","honorous","honestly","hourly","one","ouija","once","ubiquitous","ugandan","ukrainian","unanimous","unicameral","unified","unique","unisex","universal","urinal","urological","useful","useless","usurious","usurped","utilitarian","utopic","ubiquitously","unanimously","unicamerally","uniquely","universally","urologically","usefully","uselessly","usuriously"],i=["a","an"],t=/[aeiou8]/i,n=/[A-Z]+$/,u=/[UFHLMNRSX]/,a=/[.,\/#!$%\^&\*;:{}=\-_`~()]/g;function o(e){return"a"===e?"an":"a"}function s(r,t,n){var u;return State.length>0?(u="cannot add article override -> needs to be run in StoryInit special passage or earlier",console.error(u),u):t&&"string"==typeof t?(r&&"string"==typeof r&&(r=r.toLowerCase().trim()),i.includes(r)?(t=t.trim(),void(n?e.set(t,{article:r,caseSensitive:!!n}):e.set(t.toLowerCase(),{article:r,caseSensitive:!!n}))):(u='cannot add article override -> invalid article, must be "a" or "an"',console.error(u),u)):(u="cannot add article override -> invalid word",console.error(u),u)}function l(e){var i;return i=t.test(e.first())?"an":"a",function(e,i){return!!r.includes(e.toLowerCase())&&o(i)}(e,i)||function(e,r){return!(!n.test(e)||!u.test(e.first()))&&o(r)}(e,i)||i}function c(r){if(r&&"string"==typeof r){var i=r.trim().split(" ")[0].trim();return function(r){var i=(r=r.trim()).toLowerCase();if(e.has(i)||e.has(r)){var t=e.get(i)||e.get(r);return t.caseSensitive&&!e.has(r)?null:t.article}return null}(i=i.replace(a,""))||l(i)}}function h(e,r){if(!e||"string"!=typeof e)return e;var i=c(e);return(r?i.toUpperFirst():i)+" "+e}setup.articles={find:c,output:h,override:s},Macro.add("setarticle",{handler:function(){var e=s(this.args[0],this.args[1],this.args[2]);e&&"string"==typeof e&&this.error(e)}}),Macro.add(["a","an","A","An"],{handler:function(){var e=this.name.first()===this.name.first().toUpperCase();this.output.append(h(String(this.args[0]),e))}})}();
// end articles.min.js
/* twine-user-script #11: "continue.min.js" */
// continue.min.js, for SugarCube 2, by Chapel
// v1.0.1, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var n=["a",":button",'*[role="button"]',".continue-macro-ignore","#ui-bar","#ui-dialog"],t=0;function o(){$(document).on("click.continue-macro keyup.continue-macro",n.join(", "),(function(n){n.stopPropagation()}))}function e(){if(State.length>0)return!1;var t=[].slice.call(arguments).flatten();return n=n.concat(t),!0}function c(n,o){var e=function(){var n="."+Date.now().toString(36)+"-"+t;return t++,n}();if(o&&"function"==typeof o){var c="click.continue-macro"+e;n&&(c=c+" keyup.continue-macro"+e),$(document).one(c,(function(){o.call(),$(document).off(e)}))}}prehistory["%%continue-expiration"]=function(){t=0},$(document).one(":passagerender",(function(){o()})),Macro.add("ignore",{handler:function(){if(!e(this.args))return this.error("the <<ignore>> macro should only be run from StoryInit or equivalent.")}}),Macro.add("cont",{tags:null,handler:function(){var n,t=this.args.includes("append"),o=this.args.includesAny("key","keypress","press","button"),e=this.payload[0].contents;t&&(n=$(document.createElement("span")).addClass("macro-"+this.name).appendTo(this.output)),c(o,this.createShadowWrapper((function(){t&&n&&n instanceof $?n.wiki(e):$.wiki(e)})))}}),setup.cont=c,setup.cont.ignore=e,setup.cont.reset=function(){var t=[].slice.call(arguments).flatten();n=n.concat(t),$(document).off(".continue-macro"),o()},window.cont=window.cont||setup.cont}();
// end continue.min.js
/* twine-user-script #12: "css-macro.min.js" */
// css-macro.min.js, for SugarCube 2, by Chapel
// v1.0.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";function t(t){if(t.length%2!=0)return"Style rules should be a list of key/value pairs; you've passed an odd number.";var r={};return t.forEach((function(e,n){n%2==0&&(r[e]=t[n+1])})),r}function r(t,r){try{return"string"==typeof r?r:(t instanceof jQuery||(t=$(t)),t.css(r))}catch(t){return t.message}}Macro.add("css",{handler:function(){var e=function(){try{var e,n=[].slice.call(arguments).flatten(),s=n.shift();return"string"==typeof n[0]?e=t(n):"object"==typeof n[0]&&(e=clone(n[0])),r(s,e)}catch(t){return t.message}}(this.args);if("string"==typeof e)return this.error(e)}})}();
// end css-macro.min.js
/* twine-user-script #13: "cycles.min.js" */
// cycles.min.js, for SugarCube 2, by Chapel
// v2.1.1, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var e="%%cycles",t=!0,r="cycles.pause",i="cycles.pause.menu",s="cycles.postdisplay";function n(){return State.variables[e]}function a(e,t){if(!(this instanceof a))return new a(e,t);if(!e||"object"!=typeof e)throw new Error("Cycle() -> invalid definition object");if(!e.name||"string"!=typeof e.name||!e.name.trim())throw new Error("Cycle() -> invalid name");if(this.name=e.name,!e.phases||!Array.isArray(e.phases)||e.phases.length<2)throw new Error("Cycle() -> phases should be an array of at least two strings");if(!e.phases.every((function(e){return e&&"string"==typeof e&&e.trim()})))throw new Error("Cycle() -> each phase should be a valid, non-empty string");this.phases=clone(e.phases),e.period=Number(e.period),(Number.isNaN(e.period)||e.period<1)&&(e.period=1),Number.isInteger(e.period)||(e.period=Math.trunc(e.period)),this.period=e.period,e.increment=Number(e.increment),(Number.isNaN(e.increment)||e.increment<1)&&(e.increment=1),Number.isInteger(e.increment)||(e.increment=Math.trunc(e.increment)),this.increment=e.increment,this.active=void 0===e.active||!!e.active,t=Number(t),(Number.isNaN(t)||t<0)&&(t=0),Number.isInteger(t)||(t=Math.trunc(t)),this.stack=t}State.variables[e]={},Object.assign(a,{is:function(e){return e instanceof a},add:function(e,t){if(!t||"object"!=typeof t)throw new Error("Cycle.add() -> invalid definition object");if(e&&"string"==typeof e&&e.trim())t.name=e;else if(!t.name||"string"!=typeof t.name||!t.name.trim())throw new Error("Cycle.add() -> invalid name");var r=new a(t,0);return n()[t.name]=r,r},has:function(e){var t=n();return t.hasOwnProperty(e)&&a.is(t[e])},get:function(e){return a.has(e)?n()[e]:null},del:function(e){return!!a.has(e)&&(delete n()[e],!0)},check:function(e){if(a.has(e)){var t=[].slice.call(arguments).flatten().slice(1);return a.get(e).check(t)}},clear:function(e){n()},_emit:function(e,t){$(document).trigger({type:":cycle-"+t,cycle:e})},_retrieveCycles:n}),Object.assign(a.prototype,{constructor:a,revive:function(){var e={};return Object.keys(this).forEach((function(t){e[t]=clone(this[t])}),this),e},clone:function(){return new a(this.revive(),this.stack)},toJSON:function(){return JSON.reviveWrapper("new setup.Cycle("+JSON.stringify(this.revive())+", "+this.stack+")")},current:function(){return this.phases[Math.trunc(this.stack/this.period)%this.phases.length]},length:function(){return this.period*this.phases.length},turns:function(){return this.period/this.increment},turnsTotal:function(){return this.length()/this.increment},update:function(e){e=Number(e),Number.isNaN(e)&&(e=this.increment);var t=this.current();return this.stack+=e,this.stack<0&&(this.stack=0),Number.isInteger(this.stack)||(this.stack=Math.trunc(this.stack)),t!==this.current()&&a._emit(this,"change"),this},reset:function(){return this.stack=0,a._emit(this,"reset"),this.update(0)},suspend:function(){var e=this.active;return this.active=!1,e!==this.active&&a._emit(this,"suspend"),this},resume:function(){var e=this.active;return this.active=!0,e!==this.active&&a._emit(this,"resume"),this},toggle:function(){return this.active?this.suspend():this.resume(),this},isSuspended:function(){return!this.active},editIncrement:function(e){return e=Number(e),(!Number.isNaN(e)||e>0)&&(Number.isInteger(e)||(e=Math.trunc(e)),this.increment=e),this.increment},check:function(){var e=[].slice.call(arguments).flatten();return e.includes(this.current())}}),postdisplay[s]=function(){var e;tags().includes(r)||e?e=!1:tags().includes(i)?e=!0:Object.keys(n()).forEach((function(e){var t=a.get(e);t.active&&t.update()}))},setup.Cycle=a,t&&(window.Cycle=window.Cycle||a),Macro.add("newcycle",{tags:["phase"],handler:function(){if(this.args.length<1)return this.error("A cycle must at least be given a name.");if(this.payload.length<2)return this.error("A cycle must be given at least two phases.");var e=this.payload.slice(1).map((function(e){return function(e){if(e.args.length<1)return null;var t=e.args.flatten();return t.every((function(e){return"string"==typeof e}))?t:null}(e)})).flatten();if(e.includes(null))return this.error("Each `<<phase>>` tag must be given a valid name.");try{a.add(this.args[0],{phases:e,period:this.args[1],increment:this.args[2],active:this.args[3]&&"string"==typeof this.args[3]&&"suspend"!==this.args[3].trim()})}catch(e){var t=e.message&&e.message.split("->")[1];return t=!!t&&t.trim(),this.error(t||e.message)}}}),Macro.add("editcycle",{handler:function(){if(this.args.length<1||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("You must name the cycle you wish to act on.");if(this.args.length<2)return this.error("You must provide an action to perform.");var e=a.get(this.args[0]);if(null===e)return this.error('Cannot find a cycle named "'+this.args[0]+'".');if(this.args.includes("suspend")?e.suspend():this.args.includes("toggle")?e.toggle():this.args.includes("resume")&&e.resume(),this.args.includes("increment")){var t=this.args[this.args.indexOf("increment")+1];"number"==typeof t&&e.editIncrement(t)}if(this.args.includesAny("reset","clear")&&e.reset(),this.args.includes("change")){var r=this.args[this.args.indexOf("change")+1];r=Number(r),!Number.isNaN(r)&&Number.isInteger(r)&&e.update(r)}}}),Macro.add("showcycle",{handler:function(){if(this.args.length<1||"string"!=typeof this.args[0]||!this.args[0].trim())return this.error("You must name the cycle you wish to act on.");var e=a.get(this.args[0]);if(null===e)return this.error('Cannot find a cycle named "'+this.args[0]+'".');var t=e.current();this.args.includes("uppercase")?t=t.toUpperCase():this.args.includes("lowercase")?t=t.toLowerCase():this.args.includes("upperfirst")&&(t=t.toUpperFirst()),$(document.createElement("span")).addClass("macro-"+this.name).append(t).appendTo(this.output)}})}();
// end cycles.min.js
/* twine-user-script #14: "dialog-api-macro-set.min.js" */
// dialog-api-macro-set.min.js, for SugarCube 2, by Chapel
// v1.3.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;Macro.add("dialog",{tags:["onopen","onclose"],handler:function(){var t="",s=null,n=null,o=this.args.length>0?this.args[0]:"",e=this.args.length>1?this.args.slice(1).flatten():[];this.payload.forEach((function(o,e){0===e?t=o.contents:"onopen"===o.name?s=s?s+o.contents:o.contents:n=n?n+o.contents:o.contents})),e.push("macro-"+this.name),Dialog.setup(o,e.join(" ")),Dialog.wiki(t),s&&"string"==typeof s&&s.trim()&&$(document).one(":dialogopened",(function(){$.wiki(s)})),n&&"string"==typeof n&&n.trim()&&$(document).one(":dialogclosed",(function(){$.wiki(n)})),Dialog.open()}}),Macro.add("popup",{handler:function(){if(this.args.length<1)return this.error("need at least one argument; the passage to display");if(!Story.has(this.args[0]))return this.error("the passage "+this.args[0]+"does not exist");var t=this.args[0],s=this.args.length>1?this.args[1]:"",n=this.args.length>2?this.args.slice(2).flatten():[];n.push("macro-"+this.name),Dialog.setup(s,n.join(" ")),Dialog.wiki(Story.get(t).processText()),Dialog.open()}}),Macro.add("dialogclose",{skipArgs:!0,handler:function(){Dialog.close()}});
// end dialog-api-macro-set.min.js
/* twine-user-script #15: "disable.min.js" */
// disable.min.js, for SugarCube 2, by Chapel
// v1.0.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var a=["button","fieldset","input","menuitem","optgroup","option","select","textarea"];Macro.add("disable",{tags:null,handler:function(){var t,i,e,s=$(document.createElement("span")).addClass("macro-"+this.name).wiki(this.payload[0].contents);try{t=this.args.raw.trim()?!!Scripting.evalJavaScript(this.args.full):void 0}catch(a){return this.error("bad evaluation: "+a.message)}!function(a,t){a instanceof $||(a=$(a)),a.ariaDisabled(void 0===t||!!t),function(a){a.ariaIsDisabled()?a.addClass("disabled"):a.removeClass("disabled")}(a)}((i=s,e=$(i).find(a.join(",")).first(),e[0]||(e=$(i).children().eq(0))[0]?e:$(i)),t),$(this.output).append(s)}})}();
// end disable.min.js
/* twine-user-script #16: "events.min.js" */
// events.min.js, for SugarCube 2, by Chapel
// v2.0.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;setup.eventMacroNamespace="macro-event",Macro.add("trigger",{handler:function(){var t;return this.args.length>2||0===this.args.length?this.error("incorrect number of arguments"):"string"!=typeof this.args[0]?this.error("first argument should be a string and a valid event type"):(t=this.args[0],void(1===this.args.length||this.args[1]&&"string"==typeof this.args[1]&&"document"===this.args[1].toLowerCase().trim()?$(document):$(this.args[1])).trigger(t))}}),Macro.add(["event","on","one"],{tags:["which"],handler:function(){var t,r,s=this.payload,e="on",n="",a="";return this.args.length>3||0===this.args.length?this.error("incorrect number of arguments"):"string"!=typeof this.args[0]?this.error("first argument should be a string and a valid event type"):(2===this.args.length&&"string"==typeof this.args[1]&&"once"!==this.args[1]&&(n=this.args[1]),(this.args.includes("once")||"one"===this.name)&&(e="one"),t=this.args[0],void $(document)[e](t+"."+setup.eventMacroNamespace,n,(function(t){if(a=s[0].contents,s.length>1)for(r=1;r<s.length;r++)s[r].args.includes(t.which)&&(a+=s[r].contents);new Wikifier(null,a)})))}}),Macro.add("off",{handler:function(){var t;return this.args.length>2||0===this.args.length?this.error("incorrect number of arguments"):"string"!=typeof this.args[0]?this.error("first argument should be a string and a valid event type or namespace"):(t=this.args[0],void(1===this.args.length||this.args[1]&&"string"==typeof this.args[1]&&"document"===this.args[1].toLowerCase().trim()?$(document):$(this.args[1])).off(t))}});
// end events.min.js
/* twine-user-script #17: "fading-macro-set.min.js" */
// fading-macro-set.min.js, for SugarCube 2, by Chapel
// v1.1.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;Macro.add("fadein",{tags:null,handler:function(){var t,a,s=$(document.createElement("span")),e=this.payload[0].contents;if(0===this.args.length)return this.error("no arguments given");t=Util.fromCssTime(this.args[0]),a=this.args.length>1?Util.fromCssTime(this.args[1]):0,s.wiki(e).addClass("macro-"+this.name).appendTo(this.output).hide().delay(a).fadeIn(t)}}),Macro.add("fadeout",{tags:null,handler:function(){var t,a,s=$(document.createElement("span")),e=this.payload[0].contents;if(0===this.args.length)return this.error("no arguments given");t=Util.fromCssTime(this.args[0]),a=this.args.length>1?Util.fromCssTime(this.args[1]):0,s.wiki(e).addClass("macro-"+this.name).appendTo(this.output).delay(a).fadeOut(t)}});
// end fading-macro-set.min.js
/* twine-user-script #18: "first-macro.min.js" */
// first-macro.min.js, for SugarCube 2, by Chapel
// v1.1.1, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;Macro.add("first",{skipArgs:!0,tags:["then","finally"],handler:function(){var a,t=$(document.createElement("span")),n=this.payload[this.payload.length-1],s=visited()-1;a=s<this.payload.length?this.payload[s].contents:"finally"===n.name?n.contents:"",t.wiki(a).addClass("macro-"+this.name).appendTo(this.output)}});
// end first-macro.min.js
/* twine-user-script #19: "fs.min.js" */
// fs.min.js, for SugarCube 2, by Chapel
// v1.1.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){function t(t){return console.error(t),null}function e(e){try{return JSON.stringify(e)}catch(e){return t(e)}}function r(r){try{var a;if(void 0===r)return null;if(null!=(a="string"!=typeof r?e(r):r))return LZString.compressToBase64(a)}catch(e){return t(e)}}function a(e){try{return LZString.decompressFromBase64(e)}catch(e){return t(e)}}function n(e){try{return JSON.parse(e)}catch(r){try{return JSON.parse(a(e))}catch(e){return t(e)}}}function i(e,r){try{if("$"!==r[0]&&"_"!==r[0])throw new Error("Invalid stateful variable");State.setVar?State.setVar(r,clone(e)):"$"===r[0]?State.variables[r.substr(1)]=clone(e):State.temporary[r.substr(1)]=clone(e)}catch(e){return t(e)}}function s(r,a){if("string"!=typeof a&&(a=e(a)),null!=a){(r=r&&"string"==typeof r?Util.slugify(r.trim()).toLowerCase():"file.twinedata").includes(".")||(r+=".twinedata");try{saveAs(new Blob([a],{type:"text/plain;charset=UTF-8"}),r)}catch(e){return t(e)}}}function o(e){var r=e.target.files[0],s=new FileReader,o=e.storyVar||"$fileData",c=e.dataType||"text";$(s).on("load",(function(e){try{var r=e.currentTarget;if(!r.result)return;var s=function(t,e){if(null==e)return null;switch(t){case"json":return n(e);case"base64":case"b64":case"64":return n(a(e));default:return e}}(c,r.result);i(s,o),$(document).trigger({type:":import-macro",success:!0,data:clone(s),raw:r.result,storyVar:o})}catch(e){return i(null,o),$(document).trigger({type:":import-macro",success:!1,data:null,raw:null,storyVar:o}),t(e)}})),s.readAsText(r)}function c(t,e,r,a,n){var i,s=function(t,e,r,a){var n=$(document.createElement(a?"a":"button")).wiki(t),i=$(document.createElement("label")).attr("for","file-import").addClass("upload-file").append(n),s=$(document.createElement("input")).attr({id:"file-import",type:"file","data-format":r}).css("display","none").on("change",(function(t){o(Object.assign(clone(t),{storyVar:e,dataType:$(this).attr("data-format")}))})),c=$(document.createElement("span")).append(i,s);return n.ariaClick((function(){i.trigger("click")})),c}(e,r,a,n);i=t&&"string"==typeof t?$(t):t||"#passages",s.appendTo(i)}setup.fileSystem={config:{defaultText:"Import",renderAsLink:!1},JSON:{stringify:e,parse:n},b64:{compress:r,decompress:a},toState:i,toFile:s,fromFile:o},window.Chapel=window.Chapel||{},Chapel.fileSystem=Chapel.fileSystem||setup.fileSystem,Macro.add("import",{handler:function(){var t=this.output,e=this.args[2],r=this.args[0],a=this.args[1];if(e&&"string"==typeof e||(e=setup.fileSystem.config.defaultText),!r||"string"!=typeof r||"$"!==r[0]&&"_"!==r[0])return this.error("Invalid variable name.");c(t,e,r,a=a&&"string"==typeof a?a.trim():"text",setup.fileSystem.config.renderAsLink)}}),Macro.add("export",{handler:function(){var t=this.args[0],a=this.args[1],n=this.args[2];if(!t)return this.error("No data to save...");n=n&&"string"==typeof n?n.trim():"text",function(t,a,n){var i;switch(n){case"json":i=e(t);break;case"base64":case"b64":case"64":i=r(e(t)||t);break;default:i="string"==typeof t?t:e(t)}s(a,i)}(t,a=a&&"string"==typeof a?a.trim():"file.twinedata",n)}})}();
// end fs.min.js
/* twine-user-script #20: "message-macro.min.js" */
// message-macro.min.js, for SugarCube 2, by Chapel
// v1.0.1, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;setup.messageMacro={},setup.messageMacro.default="Help",Macro.add("message",{tags:null,handler:function(){var e=this.payload[0].contents,a=$(document.createElement("span")),s=$(document.createElement(this.args.includes("btn")?"button":"a")),t=$(document.createElement("span"));s.wiki(this.args.length>0&&"btn"!==this.args[0]?this.args[0]:setup.messageMacro.default).ariaClick(this.createShadowWrapper((function(){a.hasClass("open")?t.css("display","none").empty():t.css("display","block").wiki(e),a.toggleClass("open")}))),a.attr("id","macro-"+this.name+"-"+this.args.join("").replace(/[^A-Za-z0-9]/g,"")).addClass("message-text").append(s).append(t).appendTo(this.output)}});
// end message-macro.min.js
/* twine-user-script #21: "meters.min.js" */
// meters.min.js, for SugarCube 2, by Chapel
// v1.0.1, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var t=!0,e=!1,s=!1,i={full:"#2ECC40",empty:"#FF4136",back:"#DDDDDD",animate:400,easing:"swing",text:"#651A1A",label:"",align:"center"},n=["center","left","right"],r=["swing","linear"];function a(t,e){return t&&"string"==typeof t&&(t=t.toLowerCase().trim())?t:e||""}function o(t){return t<.5?2*t*t:(4-2*t)*t-1}function l(t,e){if(!(this instanceof l))return new l(t,e);var s=clone(i);this.settings=Object.assign(s,t),this.settings.align=a(this.settings.align),this.settings.easing=a(this.settings.easing),n.includes(this.settings.align)||(this.settings.align="center"),r.includes(this.settings.easing)||(this.settings.easing="swing"),e=Number(e),Number.isNaN(e)&&(e=1),e=Math.clamp(e,0,1),this.value=e;var h=$(document.createElement("div")).addClass("chapel-meter").attr({"data-val":e,"data-label":this.settings.label}).css({position:"relative","background-color":this.settings.back,height:this.settings.height,width:this.settings.width,overflow:"hidden"}),g=$(document.createElement("div")).addClass("meter-label").css({top:0,right:0,"font-size":this.settings.height,"font-weight":"bold","line-height":"100%",width:"100%",height:"100%","vertical-align":"middle","text-align":this.settings.align,color:this.settings.text,"z-index":1,position:"relative",bottom:"100%"}).wiki(this.settings.label).appendTo(h),u=$(document.createElement("div")).addClass("meter-top").css({"background-color":this.settings.full,opacity:o(this.value),width:"100%",height:"100%","z-index":0}),c=$(document.createElement("div")).addClass("meter-bottom").css({position:"absolute",top:0,left:0,"background-color":this.settings.empty,opacity:1,width:100*this.value+"%",height:"100%","z-index":0}).append(u).appendTo(h);this.$element=h,this.$bars={top:u,bottom:c},this.$label=g,g.css("font-size",parseInt(h.css("height"),10)<parseInt($(".passage").css("font-size"),10)?h.css("height"):$(".passage").css("font-size")),g.css("line-height",h.css("height"))}Object.assign(l,{_list:new Map,is:function(t){return t instanceof l},has:function(t){return l._list.has(t)&&l.is(l._list.get(t))},get:function(t){return l.has(t)?l._list.get(t):null},del:function(t){l.has(t)&&l._list.delete(t)},add:function(t,s,i){if(!l.has(t)||e){Object.assign(s,{id:t});var n=new l(s,i);return l._list.set(t,n),n}console.error('Meter "'+t+'" already exists.')},_emit:function(t,e){l.is(t)&&t.$element.trigger({type:":"+e,meter:t})}}),Object.assign(l.prototype,{constructor:l,_label:function(t){var e=this;function s(){e.$label.empty().wiki(e.settings.label),e.$label.css("font-size",parseInt(e.$element.css("height"),10)<parseInt(e.$element.parent().css("font-size"),10)?e.$element.css("height"):e.$element.parent().css("font-size")),e.$label.css("line-height",e.$element.css("height"))}return t?setTimeout(s,Engine.minDomActionDelay):s(),this},_width:function(){var t=this;return this.$bars.bottom.animate({width:100*this.value+"%"},this.settings.animate,this.settings.easing,(function(){l._emit(t,"meter-animation-complete")})),this},_color:function(){return this.$bars.top.animate({opacity:o(this.value)},this.settings.animate,this.settings.easing),this},animate:function(){return l._emit(this,"meter-animation-start"),this._color()._width()._label()},val:function(t){return void 0!==t&&(t=Number(t),Number.isNaN(t)&&(t=1),t=Math.clamp(t,0,1),this.value=t,this.animate()),this.value},options:function(t){return t&&"object"==typeof t&&Object.assign(this.settings,t),this.settings},unwrap:function(){return this.$element[0]},place:function(t,e){var s=$(document.createElement("span"));return t instanceof jQuery||(t=$(t)),t[0]||console.warn("meter#place() -> no valid target"),e&&"object"==typeof e&&(e.classes&&(Array.isArray(e.classes)||"string"==typeof e.classes)&&s.addClass(e.classes),e.attr&&"object"==typeof e.attr&&s.attr(e.attr)),t.append(s.append(this.$element)),this._label(!0),this},on:function(t,e){return"function"!=typeof e?this:t&&"string"==typeof t&&t.trim()?(t=t.split(" ").map((function(t){return(t=t.split(".")[0])+".userland"})).join(" "),this.$element.on(t,e),this):this},one:function(t,e){return"function"!=typeof e?this:t&&"string"==typeof t&&t.trim()?(t=t.split(" ").map((function(t){return(t=t.split(".")[0])+".userland"})).join(" "),this.$element.one(t,e),this):this},off:function(t){return t=t&&"string"==typeof t&&t.trim()?t.split(" ").map((function(t){return(t=t.split(".")[0])+".userland"})).join(" "):".userland",this.$element.off(t),this},click:function(t,e){return this.$element.ariaClick(t,e),this},clone:function(){return new l(this.settings,this.value)},toJSON:function(){return JSON.reviveWrapper("new setup.Meter("+JSON.stringify(this.settings)+", "+this.value+")")}}),setup.Meter=l,t&&(window.Meter=window.Meter||l),Macro.add("newmeter",{tags:["colors","sizing","animation","label"],handler:function(){if(State.length>0&&!s)return this.error("The `<<newmeter>>` macro must be called in your `StoryInit` special passage. Seriously. No excuses. --Love, Chapel");if(this.args.length<1)return this.error("The `<<newmeter>>` macro requires at least one argument: a meter name.");var t=this.args[0],i=null,n=null,r=null,a=null;if("string"!=typeof t)return this.error("Invalid meter name.");if(t=t.trim(),l.has(t)&&!e)return this.error('Cannot clobber the existing meter "'+t+'".');this.payload.length&&(i=this.payload.find((function(t){return"colors"===t.name})),n=this.payload.find((function(t){return"sizing"===t.name})),r=this.payload.find((function(t){return"animation"===t.name})),a=this.payload.find((function(t){return"label"===t.name})));var o={};if(i){if(!i.args.length)return this.error("No arguments passed to the `<<colors>>` tag.");switch(i.args.length){case 1:o.empty=i.args[0],o.full="transparent";break;case 2:o.full=i.args[0],o.empty=i.args[1];break;default:o.full=i.args[0],o.empty=i.args[1],o.back=i.args[2]}}if(n){if(!n.args.length)return this.error("No arguments passed to the `<<sizing>>` tag.");o.width=n.args[0],n.args[1]&&(o.height=n.args[1])}if(r){if(!r.args.length)return this.error("No arguments passed to the `<<animation>>` tag.");if("boolean"!=typeof r.args[0]||r.args[0]){if("string"!=typeof r.args[0])return this.error("The argument to the `<<animation>>` tag should be `true`, `false`, or a valid CSS time value.");o.animate=Util.fromCssTime(r.args[0])}else o.animate=0;r.args[1]&&["swing","linear"].includes(r.args[1])&&(o.easing=r.args[1])}if(a){var h=a.args[0];if(!h||"string"!=typeof h)return this.error("The labelText argument for the `<<label>>` tag is required.");o.label=h.trim(),a.args[1]&&"string"==typeof a.args[1]&&(o.text=a.args[1]),a.args[2]&&"string"==typeof a.args[2]&&(o.align=a.args[2])}l.add(t,o,this.args[1])}}),Macro.add("showmeter",{handler:function(){if(this.args.length<1)return this.error("This macro requires at least one argument: the meter's name.");var t=this.args[0];if("string"!=typeof t)return this.error("Invalid meter name.");t=t.trim();var e=l.get(t);if(!e||!l.is(e))return this.error('The meter "'+t+'" does not exist.');"number"==typeof this.args[1]&&e.val(this.args[1]),e.place(this.output,{classes:"macro-"+this.name,attr:{id:"meter-"+Util.slugify(t)}})}}),Macro.add("updatemeter",{handler:function(){if(this.args.length<2)return this.error("This macro requires two arguments: the meter's name and a value.");var t=this.args[0];if("string"!=typeof t)return this.error("Invalid meter name.");t=t.trim();var e=l.get(t);if(!e||!l.is(e))return this.error('The meter "'+t+'" does not exist.');e.val(this.args[1])}})}();
// end meters.min.js
/* twine-user-script #22: "mouseover.min.js" */
// mouseover.min.js, for SugarCube 2, by Chapel
// v1.0.1, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;Macro.add("mouseover",{tags:["onhover","onmouseover","onmousein","onmouseenter","onmouseout"],skipArgs:!0,handler:function(){if(this.payload.length<2)return this.error("No event tag used.");var e={mouseover:[],mousein:[],mouseout:[]},o=$(document.createElement("span")).addClass("macro-"+this.name).wiki(this.payload[0].contents).appendTo(this.output);this.payload.forEach((function(o){switch(o.name){case"onhover":case"onmouseover":e.mouseover.push(o.contents);break;case"onmousein":case"onmouseenter":e.mousein.push(o.contents);break;case"onmouseout":e.mouseout.push(o.contents);break;default:return}})),e.mouseover.length&&o.on("mouseover",this.createShadowWrapper((function(o){$.wiki(e.mouseover.join(" "))}))),e.mousein.length&&o.on("mouseenter",this.createShadowWrapper((function(o){$.wiki(e.mousein.join(" "))}))),e.mouseout.length&&o.on("mouseout",this.createShadowWrapper((function(o){$.wiki(e.mouseout.join(" "))})))}});
// end mouseover.min.js
/* twine-user-script #23: "notify.min.js" */
// notify.min.js, for SugarCube 2, by Chapel
// v1.1.1, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){var s=/\d+m?s$/;function e(s,e,t){"string"==typeof s&&("number"!=typeof e&&(e=!1),$(document).trigger({type:":notify",message:s,delay:e,class:t||""}))}$(document.body).append("<div id='notify'></div>"),$(document).on(":notify",(function(s){s.message&&"string"==typeof s.message&&(s.message.trim(),s.class?"string"==typeof s.class?s.class="open macro-notify "+s.class:Array.isArray(s.class)?s.class="open macro-notify "+s.class.join(" "):s.class="open macro-notify":s.class="open macro-notify",s.delay?("number"!=typeof s.delay&&(s.delay=Number(s.delay)),Number.isNaN(s.delay)&&(s.delay=2e3)):s.delay=2e3,$("#notify").empty().wiki(s.message).addClass(s.class),setTimeout((function(){$("#notify").removeClass()}),s.delay))})),Macro.add("notify",{tags:null,handler:function(){var t=this.payload[0].contents,a=!1,n=!1;if(this.args.length>0){var i=s.test(this.args[0]);"number"==typeof this.args[0]||i?(a=i?Util.fromCssTime(this.args[0]):this.args[0],n=this.args.length>1&&this.args.slice(1).flatten()):n=this.args.flatten().join(" ")}e(t,a,n)}}),setup.notify=e}();
// end notify.min.js
/* twine-user-script #24: "operations.min.js" */
// operations.min.js, for SugarCube 2, by Chapel
// v1.1.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var e=e||{},r=!0,t=!0,n=[0,100];function o(e,r){var t,n=[],o=0,i=1;if("string"==typeof e)n=e.split("d");else if("number"==typeof e&&r)n=[e,r];else{if(!(Array.isArray(e)&&e.length>=2))throw new TypeError("dice(): could not process arguments...");e.length=2,n=e}if(n[0]=Number(n[0]),"string"==typeof n[1]&&"F"===n[1].trim().toUpperCase()?(n[1]=3,i=-1):n[1]=Number(n[1]),n.some((function(e){return Number.isNaN(e)})))throw new TypeError("dice(): could not process arguments...");for(t=0;t<n[0];t++){o+=Math.floor(State.random()*n[1])+i}return o}function i(e,r){if("string"==typeof e){var t=[(n=e.trim().replace(/\s/g,"").match(/(\d+[d][\df]\d*)(.*)/i))[1],Number(n[2])];return o(t[0])+t[1]}return o(e,r);var n}e.dice={roll:i},r&&(window.dice=window.dice||i),Number.prototype.dice||Object.defineProperty(Number.prototype,"dice",{configurable:!0,writable:!0,value:function(e){if(0===this)return 0;if(this<0)throw new TypeError("Number.prototype.dice: cannot roll a negative number of dice!");if(("string"!=typeof e||"F"!==e.trim().toUpperCase())&&(null==e||"number"!=typeof e||e<=0||!Number.isInteger(e)))throw new TypeError("Number.prototype.dice: error in argument");if(!Number.isInteger(this))throw new TypeError("Number.prototype.dice: cannot roll partial dice!");return i(this,e)}}),Number.prototype.fairmath||Object.defineProperty(Number.prototype,"fairmath",{configurable:!0,writable:!0,value:function(e){var r=n;if(this<r[0]||this>r[1])throw new TypeError("Number.prototype.fairmath called on a number that is out of the defined range (the number was "+this+").");if(null==e||"number"!=typeof e||e>100||e<-100||arguments.length<1)throw new TypeError("Number.prototype.fairmath given incorrect argument or an argument that is out of the valid 0-100 range.");if(0===e)return Math.clamp(Math.trunc(this),r[0],r[1]);if(e<0)return e*=-1,Math.clamp(Math.trunc(this-(this-r[0])*(e/r[1])),r[0],r[1]);if(e>0)return Math.clamp(Math.trunc(this+(r[1]-this)*(e/r[1])),r[0],r[1]);throw new Error("Number.prototype.fairmath encountered an unspecified error.")}}),Number.prototype.between||Object.defineProperty(Number.prototype,"between",{configurable:!0,writable:!0,value:function(e,r){if("number"!=typeof e||"number"!=typeof r)throw new TypeError("Number.between() -> both values must be numbers");var t=Number(this);if(e===r)return t===e;if(r<e){var n=r;r=e,e=n}return t>=e&&t<=r}}),Math.fairmath||Object.defineProperty(Math,"fairmath",{configurable:!0,writable:!0,value:function(e,r){return e.fairmath(r)}}),Math.between||Object.defineProperty(Math,"between",{configurable:!0,writable:!0,value:function(e,r,t){return e.between(r,t)}}),t&&(Math.fm||Object.defineProperty(Math,"fm",{configurable:!0,writable:!0,value:function(e,r){return e.fairmath(r)}}),Number.prototype.fm||Object.defineProperty(Number.prototype,"fm",{configurable:!0,writable:!0,value:function(e){return this.fairmath(e)}}),Number.prototype.d||Object.defineProperty(Number.prototype,"d",{configurable:!0,writable:!0,value:function(e){return this.dice(e)}}))}();
// end operations.min.js
/* twine-user-script #25: "playtime.min.js" */
// playtime.min.js, for SugarCube 2, by Chapel
// v2.1.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var e=!0,t="playtime",a="pausetimer";function n(){return Date.now()-State.variables[t]}function r(e){if(e&&!(e<0)&&"number"==typeof e){var t=[];return t.push(Math.floor(e/1e3)%60),t.push(Math.floor(e/6e4)%60),t.push(Math.floor(e/36e5)),t}}State.variables[t]=Date.now(),predisplay["start-playtime"]=function(e){delete predisplay[e],State.variables[t]||(State.variables[t]=Date.now())},prehistory["pause-playtime"]=function(e){tags().includes(a)&&(State.variables[t]+=time())};var i=["h","hr","hrs","hour","hours"],s=["m","min","mins","minute","minutes"],u=["s","sec","secs","second","seconds"];function o(e){return function(e,t){if(e&&Array.isArray(e)&&!(e.length<3)){var a=e[2]<10?"0"+e[2]:""+e[2],n=e[1]<10?"0"+e[1]:""+e[1],r=e[0]<10?"0"+e[0]:""+e[0];return t?"<b>"+a+":"+n+"</b>:"+r:a+":"+n+":"+r}}(r(n()),e)}setup.playTime=function(e){return"string"==typeof e?function(e){var t=n(),a=r(t);return i.includes(e)?a[2]:s.includes(e)?a[1]:u.includes(e)?a[0]:t}(e):o(e)},e&&(window.playTime=window.playTime||setup.playTime),Macro.add("playtime",{handler:function(){var e=this.args.map((function(e){return String(e).trim().toLowerCase()})),t=$(document.createElement("span")),a=o(e.includesAny(["format","f","fmt","b","bold","true"]));t.wiki(a).addClass("macro-"+this.name).appendTo(this.output)}})}();
// end playtime.min.js
/* twine-user-script #26: "popover.min.js" */
// popover.min.js, for SugarCube 2, by Chapel
// v1.0.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";function o(o,i){i=function(){return[].slice.call(arguments).flatten().filter((function(o){return o&&"string"==typeof o&&o.trim()}))||[]}(i),$("#ui-overlay, #ui-dialog").addClass("popover"),$("#ui-overlay, #ui-dialog, #ui-dialog-body").addClass(i),i.includesAny("noclick","no-click")&&$("#ui-overlay").removeClass("ui-close"),Dialog.setup("","popover"),Dialog.wiki(o),Dialog.open(),$(document).one(":dialogclosed",(function(){$("#ui-overlay").addClass("ui-close"),$("#ui-overlay, #ui-dialog").removeClass("popover"),$("#ui-overlay, #ui-dialog, #ui-dialog-body").removeClass(i)}))}Macro.add("popover",{tags:null,handler:function(){o(this.payload[0].contents,this.args)}}),Macro.add("dismisspopover",{skipArgs:!0,handler:function(){$("ui-overlay").hasClass("popover")&&Dialog.close()}}),setup.popover=o}();
// end popover.min.js
/* twine-user-script #27: "preload.min.js" */
// preload.min.js, for SugarCube 2, by Chapel
// v1.0.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";function t(t,e){var n=0,r=t.length;t.forEach((function(t){!function(t,e){var n=new Image;n.onload=e,n.onerror=e,n.src=t}(t,(function(){++n===r&&e()}))}))}function e(){return State.length<=0}function n(){var n=[].slice.call(arguments).flatten(),r=!!e()&&LoadScreen.lock();return t(n,(function(){r&&LoadScreen.unlock(r)})),r}setup.preload=n,setup.preload.force=!1,Macro.add("preload",{handler:function(){if(!e()&&!setup.preload.force)return this.error("Attempting to preload images outside of `StoryInit` or similar can cause performance issues. Set `setup.preload.force` to `true` if you want to do it anyway.");n(this.args.flatten().filter((function(t){return"string"==typeof t})))}})}();
// end preload.min.js
/* twine-user-script #28: "pronouns.min.js" */
// pronouns.min.js, for SugarCube 2, by Chapel
// v1.1.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";if(Template&&Template.add&&"function"==typeof Template.add){var e={name:"gender",showSetting:!0,label:"Gender",desc:"",storyVar:"%%gender",default:"female"},t="#setting-control-"+e.name,r={subjective:["she","he","they"],objective:["her","him","them"],possessive:["hers","his","theirs"],determiner:["her","his","their"],reflexive:["herself","himself","themself"],noun:["woman","man","person"]};e.showSetting&&(Setting.addToggle(e.name,{label:e.label,desc:e.desc&&"string"==typeof e.desc&&e.desc.trim()?e.desc.trim():void 0}),$(document).on(":dialogopen :dialogopened",(function(){$("#ui-dialog-body").hasClass("settings")&&$(t).parent("div").empty().append($(document.createElement("button")).append("Configure...").ariaClick((function(){h()})))})));var a=/^is$/i,n=/^was$/i,s=/^has$/i,i=/oes$/i,o=/^[dl]ies$/i,l=/ies$/i,u=/sses$/i,c=/hes$/i,d=/s$/i,p=/they/i;Template.add(["he","she","they","He","She","They"],(function(){return S(this.name,g().subjective)})),Template.add(["him","her","them","Him","Her","Them"],(function(){return S(this.name,g().objective)})),Template.add(["his","hers","theirs","His","Hers","Theirs"],(function(){return S(this.name,g().possessive)})),Template.add(["his_","her_","their","His_","Her_","Their"],(function(){return S(this.name,g().determiner)})),Template.add(["himself","herself","themself","Himself","Herself","Themself"],(function(){return S(this.name,g().reflexive)})),Template.add(["man","woman","person","Man","Woman","Person"],(function(){return S(this.name,g().noun)})),Template.add(["he-s","she-s","they-re","He-s","She-s","They-re"],(function(){return S(this.name,g().subjective+T("&apos;s","&apos;re",y()))})),Macro.add("pronouns",{skipArgs:!0,handler:function(){h()}}),Macro.add("verb",{handler:function(){var e=y();if(this.args.length<1)return this.error("Please pass at least a singular third person pronoun to this macro.");this.args.includes("plural")&&(e=!0),this.output.append(T(String(this.args[0]),this.args[1]?String(this.args[1]):null,!!e))}}),setup.gender={pronouns:g,setPronouns:function(t){return"string"==typeof t?v(t):"object"==typeof t?function(t){if("object"==typeof t)return State.variables[e.storyVar]=v("male"===e.default?1:0),Object.assign(State.variables[e.storyVar],t)}(t):void 0},dialog:h,pluralize:b},window.gender=window.gender||setup.gender}else alert("Warning, this version of SugarCube does not include the Template API. Please upgrade to v2.29.0 or higher.");function m(){var t=$(document.createElement("div"));var a=Object.keys(r).map((function(t){var a=2;"male"===e.default?a=1:"female"===e.default&&(a=0);var n=State.variables,s=r[t][a];return n[e.storyVar]&&n[e.storyVar][t]&&(s=n[e.storyVar][t]),function(e,t,r){return $(document.createElement("label")).append(e).css("display","block").append($(document.createElement("input")).attr({type:"text",name:t}).css({float:"right","margin-left":"0.2em"}).val(r))}(t.toUpperFirst()+": ","gender-"+t,s)})),n=function(e,t,r){var a=$(document.createElement("select")).attr("name",t).css("float","right");return r.forEach((function(e,t){console.log(t),$(document.createElement("option")).attr("value",String(t)).append(e).appendTo(a)})),$(document.createElement("label")).css("display","block").append(e,a)}("Presets: ","gender-preset",["She/Her","He/Him","They/Them"]).on("change",(function(){var e=Number($(this).find("select").val());Number.isNaN(e)||a.forEach((function(t){var a=t.find("input"),n=a.attr("name").split("-")[1];a.val(r[n][e])}))})),s=n.find("select");State.variables[e.storyVar]?s.val(""):"male"===e.default?s.val("1"):"female"===e.default?s.val("0"):s.val("2");var i,o=$(document.createElement("button")).wiki("Confirm").addClass("gender-confirm").ariaClick({label:"Confirm pronoun selection."},(function(){var t=State.variables;t[e.storyVar]={},a.forEach((function(r){var a=r.find("input"),n=a.attr("name").split("-")[1];t[e.storyVar][n]=a.val().trim().toLowerCase()})),$("#ui-dialog-body").hasClass("reopen")&&UI.settings(),Dialog.close()})),l=(i=[n,"<br>"],a.forEach((function(e){i.push(e),i.push("<br>")})),i.push(o),i);return t.append(l)}function h(){var e,t,r,a;e="Customize Gender",t=m(),r="custom-gender",a=!1,Dialog.isOpen()&&$("#ui-dialog-body").hasClass("settings")&&(a=!0),Dialog.close(),Dialog.setup(e,a?r+" reopen":r),Dialog.append(t),Dialog.open()}function f(e){("number"!=typeof e||Number.isNaN(e)||e>2||e<0)&&(e=0);var t={};return Object.keys(r).forEach((function(a){t[a]=r[a][e]})),t}function g(){return State.variables[e.storyVar]&&State.variables[e.storyVar].subjective?State.variables[e.storyVar]:f("male"===e.default?1:0)}function v(t){var r;switch(t){case"female":r=f(0);break;case"male":r=f(1);break;default:r=f(2)}return State.variables[e.storyVar]=clone(r),r}function b(e){return e&&"string"==typeof e?(e=e.trim(),a.test(e)?e.replace(a,"are"):n.test(e)?e.replace(n,"were"):s.test(e)?e.replace(s,"have"):i.test(e)?e.replace(i,"o"):o.test(e)?e.replace(l,"ie"):l.test(e)?e.replace(l,"y"):u.test(e)?e.replace(u,"ss"):c.test(e)?e.replace(c,"h"):d.test(e)?e.replace(d,""):e):e}function y(){return p.test(g().subjective.trim())}function T(e,t,r){return r?t&&"string"==typeof t?t:b(e):e}function S(e,t){return e.first()===e.first().toUpperCase()?t.toUpperFirst():t}}();
// end pronouns.min.js
/* twine-user-script #29: "simple-inventory.min.js" */
// simple-inventory.min.js, for SugarCube 2, by Chapel
// v2.3.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var r={tryGlobal:!0,defaultStrings:{empty:"The inventory is empty...",listDrop:"Discard",separator:"\n"}};function i(r,i,t,n){$(document).trigger({type:"initialized"===n?":inventory-init":":inventory-update",instance:r,receiving:i,moved:t,context:n})}function t(r){if(r=r?(r=[].slice.call(arguments)).flatten():[],!(this instanceof t))return new t(r);this.inv=r,i(this,null,r=r.length?r:null,"initialized")}Object.assign(t,{is:function(r){return r instanceof t},log:function(r){return t.is(r)?"Inventory.log() -> "+r.toArray().join(" - "):"Inventory.log() -> object is not an inventory..."},removeDuplicates:function(r){if(t.is(r)){var i,n=r.toArray();return i=[],n.forEach((function(r){i.includes(r)||i.push(r)})),i}}}),Object.assign(t.prototype,{transfer:function(r){if(arguments.length<2)return this;if(!t.is(r))return this;for(var n=[].slice.call(arguments),e=[],s=0,a=(n=n.slice(1).flatten()).length;s<a;s++)this.inv.includes(n[s])&&(this.inv.delete(n[s]),e.push(n[s]));return e.length?(r.inv=r.inv.concat(e),i(this,r,e,"transfer"),this):this},has:function(){var r=[].slice.call(arguments).flatten();return!(!r||!r.length)&&this.inv.includesAny(r)},hasAll:function(){var r=[].slice.call(arguments).flatten();return!(!r||!r.length)&&this.inv.includesAll(r)},pickUp:function(r){var t=[].slice.call(arguments).flatten(),n=this;return t&&t.length&&("unique"!==r&&"unique"!==t[0]||(t=function(r){var i=[];return r.forEach((function(r){n.inv.includes(r)||i.includes(r)||i.push(r)})),i}(t=t.splice(1))),this.inv=this.inv.concat(t),i(this,null,t,"pickup")),this},drop:function(){var r,t=[].slice.call(arguments).flatten(),n=this;if(t&&t.length){var e=[];t.forEach((function(i){n.has(i)&&(e.push(i),r=n.inv.indexOf(i),n.inv.deleteAt(r))})),i(this,null,e,"drop")}return this},sort:function(){return this.inv=this.inv.sort(),i(this,null,null,"sort"),this},show:function(i){return i&&"string"==typeof i||(i=r.defaultStrings.separator),this.inv.length?this.inv.join(i):r.defaultStrings.empty},empty:function(){var r=clone(this.inv);return this.inv=[],i(this,null,r,"drop"),this},toArray:function(){return this.inv},count:function(r){if(r&&"string"==typeof r){var i=0;return this.toArray().forEach((function(t){t===r&&i++})),i}return this.toArray().length},isEmpty:function(){return 0===this.toArray().length},linkedList:function(i,n){i&&t.is(i)||(i=!1);var e=this.toArray(),s=this,a=$(document.createElement("span"));return e&&e.length?(e.forEach((function(t,e,o){var l=$(document.createElement("span")),u=$(document.createElement("a")),h=n||r.defaultStrings.drop,c=function(r,i){var t=Math.random().toString(36).substring(7);return arguments.length<2&&(r=Math.random().toString(36).substring(7),i=random(99)),"simple-inv-"+i+"-"+Date.now()+"-"+r.replace(/[^A-Za-z0-9]/g,"")+"-"+t}(t,e);u.wiki(h).addClass("simple-inv drop-link"),u.ariaClick((function(){i?s.transfer(i,t):s.drop(t),$("#"+c).empty()})),l.attr("id",c).addClass("simple-inv link-listing").wiki(t+" ").append(u),e<o.length-1&&l.wiki("<br />"),a.append(l)})),a):(a.wiki(r.defaultStrings.empty),a)},constructor:t,toJSON:function(){return JSON.reviveWrapper("new setup.Inventory("+JSON.stringify(this.inv)+")")},clone:function(){return new t(this.inv)}}),setup.Inventory=t,setup.simpleInv={inventory:t},r.tryGlobal&&(window.Inventory=window.Inventory||t),Macro.add("newinventory",{handler:function(){if(this.args.length<1)return this.error("incorrect number of arguments");var r=this.args[0].trim();if("$"!==r[0]&&"_"!==r[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');Wikifier.setValue(r,new t(this.args.slice(1).flatten()))}}),Macro.add("pickup",{handler:function(){if(this.args.length<2)return this.error("incorrect number of arguments");var r=this.args[0].trim();if("$"!==r[0]&&"_"!==r[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var i=Wikifier.getValue(r);if(!t.is(i))return this.error("variable "+r+" is not an inventory!");i.pickUp(this.args.slice(1).flatten())}}),Macro.add("drop",{handler:function(){if(this.args.length<2)return this.error("incorrect number of arguments");var r=this.args[0].trim();if("$"!==r[0]&&"_"!==r[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var i=Wikifier.getValue(r);if(!t.is(i))return this.error("variable "+r+" is not an inventory!");i.drop(this.args.slice(1).flatten())}}),Macro.add("transfer",{handler:function(){if(this.args.length<3)return this.error("incorrect number of arguments");var r=this.args[0].trim();if("$"!==r[0]&&"_"!==r[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var i=Wikifier.getValue(r);if(!t.is(i))return this.error("variable "+r+" is not an inventory!");var n=this.args[1].trim();if("$"!==n[0]&&"_"!==n[0])return this.error('variable name "'+this.args[1]+'" is missing its sigil ($ or _)');var e=Wikifier.getValue(n);if(!t.is(e))return this.error("variable "+n+" is not an inventory!");i.transfer(e,this.args.slice(2).flatten())}}),Macro.add("dropall",{handler:function(){if(1!==this.args.length)return this.error("incorrect number of arguments");var r=this.args[0].trim();if("$"!==r[0]&&"_"!==r[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var i=Wikifier.getValue(r);if(!t.is(i))return this.error("variable "+r+" is not an inventory!");i.empty()}}),Macro.add("clear","dropall",!1),Macro.add("sort",{handler:function(){if(1!==this.args.length)return this.error("incorrect number of arguments");var r=this.args[0].trim();if("$"!==r[0]&&"_"!==r[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var i=Wikifier.getValue(r);if(!t.is(i))return this.error("variable "+r+" is not an inventory!");i.sort()}}),Macro.add("inventory",{handler:function(){if(this.args.length<1||this.args.length>2)return this.error("incorrect number of arguments");var r=this.args[0].trim();if("$"!==r[0]&&"_"!==r[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var i=Wikifier.getValue(r);if(!t.is(i))return this.error("variable "+r+" is not an inventory!");var n=$(document.createElement("span")),e=!!this.args[1]&&this.args[1];n.wiki(i.show(e)).addClass("macro-"+this.name).appendTo(this.output)}}),Macro.add("linkedinventory",{handler:function(){if(this.args.length<2||this.args.length>3)return this.error("incorrect number of arguments");var r=!1,i="",n=this.args[1].trim(),e="string"==typeof this.args[0]&&this.args[0];if(!e)return this.error("first argument should be the link text");if("$"!==n[0]&&"_"!==n[0])return this.error('variable name "'+this.args[1]+'" is missing its sigil ($ or _)');var s=Util.slugify(n);s=this.name+"-"+s;var a=Wikifier.getValue(n);if(!t.is(a))return this.error("variable "+n+" is not an inventory!");if(this.args.length>2){if("$"!==(i=this.args[2].trim())[0]&&"_"!==i[0])return this.error('variable name "'+this.args[2]+'" is missing its sigil ($ or _)');if(r=Wikifier.getValue(i),!t.is(r))return this.error("variable "+i+" is not an inventory!")}a.linkedList(r,e).attr({id:s,"data-rec":i,"data-self":n,"data-action":e}).addClass("macro-"+this.name).appendTo(this.output)}})}();
// end simple-inventory.min.js
/* twine-user-script #30: "speech.min.js" */
// speech.min.js, for SugarCube 2, by Chapel
// v1.1.1, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var a=new Map;function t(t,e,r){if(void 0===r&&e&&(r=e,e=null),State.length)throw new Error("addCharacter() -> must be called before story starts");t&&r?(a.has(t)&&console.error('addCharacter() -> overwriting character "'+t+'"'),a.set(t,{displayName:e,image:r})):console.error("addCharacter() -> invalid arguments")}function e(t,e,r,s){var n=$(document.createElement("div")).addClass(Util.slugify(e)+" say"),i=a.has(e)?a.get(e).image:null,o=$(document.createElement("img")).attr("src",s||i||"");o.attr("src")&&o.attr("src").trim()&&n.append(o);var c=e.toUpperFirst();return a.has(e)&&a.get(e).displayName&&(c=a.get(e).displayName),n.append($(document.createElement("p")).wiki(c)).append($(document.createElement("p")).wiki(r)),t&&(t instanceof $||(t=$(t)),n.appendTo(t)),n}setup.say=e,setup.addCharacter=t,Macro.add("character",{handler:function(){t(this.args[0],this.args[1],this.args[2])}}),$(document).one(":passagestart",(function(){var t=Array.from(a.keys());t.push("say"),Macro.add(t,{tags:null,handler:function(){"say"!==this.name?e(this.output,this.name,this.payload[0].contents):e(this.output,this.args[0],this.payload[0].contents,this.args[1])}})}))}();
// end speech.min.js
/* twine-user-script #31: "swap-macro-set.min.js" */
// swap-macro-set.min.js, for SugarCube 2, by Chapel
// v1.1.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";var t=!0,a=!0,e="violet",s="red",r="swappable";setup.swap=setup.swap||{};var n=null;function i(a){var e=function(){return a};setup.swap.current=e,t&&(window.swapCurrent=e)}function o(a,o){var p=$(document.createElement("span"));return $(document.createElement("a")).wiki(a).css("color",e).attr({"data-swap-flag":"false","data-orig-content":a,"data-wiki-code":o||""}).addClass(r).appendTo(p).ariaClick((function(a){a.preventDefault();var r=$(this);if("true"===r.attr("data-swap-flag"))r.attr("data-swap-flag","false").css("color",e),n=null;else if(n){var o=n.text(),p=r.text(),l=n.attr("data-wiki-code"),c=r.attr("data-wiki-code");n.attr("data-swap-flag","false").css("color",e).empty().wiki(p),r.attr("data-swap-flag","false").css("color",e).empty().wiki(o),l&&"string"==typeof l&&l.trim()&&(i(p),$.wiki(l)),c&&"string"==typeof c&&c.trim()&&(i(o),$.wiki(c)),setup.swap.current&&"function"==typeof setup.swap.current&&delete setup.swap.current,t&&window.swapCurrent&&"function"==typeof window.swapCurrent&&delete window.swapCurrent,n=null}else n=r,r.attr("data-swap-flag","true").css("color",s)})),p}function p(){n=null,$("a."+r).each((function(){var t=$(this);t.empty().wiki(t.attr("data-orig-content")).attr("data-swap-flag","false").css("color",e)}))}Macro.add("swap",{tags:["onswap"],skipArgs:!0,handler:function(){var t=this.payload[0].contents,a=this.payload[1]?this.payload[1].contents:"",e=this.output,s=this.name;o(t,a).addClass("macro-"+s).appendTo(e)}}),Macro.add("resetswap",{handler:function(){var t=this.args&&this.args[0]&&"string"==typeof this.args[0]?this.args[0]:"Reset";$(document.createElement(a?"button":"a")).wiki(t).ariaClick({label:"Reset all swappable elements."},(function(t){t.preventDefault(),p()})).appendTo(this.output)}}),setup.swap.create=o,setup.swap.reset=p}();
// end swap-macro-set.min.js
/* twine-user-script #32: "type-sim.min.js" */
// type-sim.min.js, for SugarCube 2, by Chapel
// v2.0.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){"use strict";Macro.add("typesim",{tags:null,handler:function(){if(!this.args.length||!this.args[0]||"string"!=typeof this.args[0])return this.error("no text to type out was provided");var t,e=$(document.createElement("span")).addClass("macro"+this.name),n=$(document.createElement("div"));this.payload[0].contents&&this.payload[0].contents.trim()&&(t=this.payload[0].contents),function(t,e,n){if(t&&"string"==typeof t){!e||e instanceof $||(e=$(e));var i=0,s=t.split(""),a=[],o=$(document.createElement("textarea")).addClass("type-sim").on("input.type-sim",(function(){var e=$(this);i=a.push(s[i]),e.val(a.join("")),t.length===a.length&&(e.off("input.type-sim").ariaDisabled(!0),n&&"function"==typeof n&&n(a.join("")),$(document).trigger({type:":type-sim-end",message:a.join("")}))}));e&&e[0]&&e.append(o)}}(this.args[0],e,(function(){n.wiki(t)})),e.append(n).appendTo($(this.output))}})}();
// end type-sim.min.js
/* twine-user-script #33: "ui-macro.min.js" */
// ui-macro.min.js, for SugarCube 2, by Chapel
// v1.0.0, 2021-04-20, 53d1a20e9321b3782a303cf7dbe00f5c51e947db
;!function(){var s={update:UIBar.setStoryElements,stow:UIBar.stow,unstow:UIBar.unstow,toggle:function(){$("#ui-bar").hasClass("stowed")?UIBar.unstow():UIBar.stow()},hide:function(){$("#ui-bar").css("display","none")},show:function(){$("#ui-bar").css("display","block")},kill:function(){$("#ui-bar").css("display","none"),$("#story").css("margin-left","2.5em")},restore:function(){$("#ui-bar").css("display","block"),$("#story").css("margin-left","20em")},jump:UI.jumpto,saves:UI.saves,restart:UI.restart,settings:UI.settings,share:UI.share,aliases:{refresh:"update",reload:"update",destroy:"kill",revive:"restore",jumpto:"jump",save:"saves",load:"saves",setting:"settings",sharing:"share"}},r=Object.keys(s);function t(t){return t&&"string"==typeof t?function(s){return r.includes(s)}(t=t.toLowerCase().trim())||(t=function(r){return s.aliases[r]||null}(t))?(s[t](),!1):'Command "'+t+'" is not a valid command.':"Command is not a string."}Macro.add("ui",{handler:function(){Array.isArray(this.args)&&this.args.length||this.error("No commands passed to macro.");var s,r=function(s){if(!Array.isArray(s))return"Command list error.";var r=[];return s.forEach((function(s){r.push(t(s))})),r}(this.args.flatten());s=(r=r.filter((function(s){return"string"==typeof s}))).join(" "),r.length&&s&&this.error(s)}})}();
// end ui-macro.min.js
/* twine-user-script #34: "volume-slider.min.js" */
// volume slider, by chapel; for sugarcube 2
!function(){function e(e){"number"!=typeof e&&(e=+e),(Number.isNaN(e)||0>e)&&(e=0),e>1&&(e=1)
try{if(!SimpleAudio)throw Error("Cannot access audio API.")
"function"==typeof SimpleAudio.volume?SimpleAudio.volume(e):SimpleAudio.volume=e}catch(t){console.error(t.message,t),$.wiki("<<masteraudio volume "+e+">>")}finally{State.variables.volume=e;return e}}function t(){var t=settings.volume/a.rangeMax
a.current=t.toFixed(2),e(a.current)}var n={},a={current:100,rangeMax:100,step:1,setting:!0}
n.last=a.current,n.start=n.last/a.rangeMax,postdisplay["volume-task"]=function(t){delete postdisplay[t],e(State.variables.volume.toFixed(2))},$(document).on("input","input[name=volume]",function(){var t=$("input[name=volume]").val(),o=t/a.rangeMax
a.current=o.toFixed(2),e(a.current),n.last=t}),Macro.add("volume",{handler:function(){var e=$(document.createElement("span")),t=$(document.createElement("input")),o="macro-"+this.name
t.attr({id:"volume-control",type:"range",name:"volume",min:"0",max:a.rangeMax,step:a.step,value:parseInt(a.rangeMax*State.variables.volume)}),e.append(t).addClass(o).appendTo(this.output)}}),a.setting&&(Setting&&Setting.addRange&&"function"==typeof Setting.addRange?Setting.addRange("volume",{label:"Volume: ",min:0,max:a.rangeMax,step:a.step,"default":a.current,onInit:t,onChange:t}):console.error("This version of SugarCube does not include the `Settings.addRange()` method; please try updating to the latest version of SugarCube."))}()
// end volume slider
/* twine-user-script #35: "math.js" */
// Samples random integer from a to b
setup.randint = function(a, b){
    return Math.floor(Math.random() * (b - a + 1) + a);
}

// Samples from standard normal distribution
setup.randn_bm = function () {
    return Math.sqrt(-2 * Math.log(1 - Math.random())) * Math.cos(2 * Math.PI * Math.random())
}

// Rounds to two digits
setup.round2 = function(n) {
    return Math.round((n + Number.EPSILON) * 100) / 100
}

setup.sigmoid = function(x) {
    return 1 / (1 + Math.exp(-x));
}

// Generates one step of an OU-processes
setup.ou_step = function(x_t, theta, mu, sigma, delta_t) {
    return theta * (mu - x_t) * delta_t + Math.sqrt(delta_t) * sigma * setup.randn_bm();
}

setup.xgcd = function(a, b) {
    var x0 = 0;
    var x1 = 1;
    var y0 = 1;
    var y1 = 0;
    while (a != 0) {
        var q = b;
        var a = b;
        y0 = y1;
        y1 = y0 - q * y1;
        x0 = x1;
        x1 = x0 - q * x1;
    }
    return [b, x0, y0]
}

setup.powMod = function(base, pow, mod){
    var i, result = BigInt(1);
    for ( i = 0; i < pow; i++){
        result *= base;
        result %= mod;
    }
    return result;
}
/* twine-user-script #36: "quests.js" */
setup.quests = {
    "life_of_a_slave": {
        "name": "Life of a Slave",
        "flavor_text": "You do not have the confidence of Shintani. In order to \
            go outside and gather information, you need to raise your status within \
            the household by gaining his trust.",
        "stages": [
            "Raise your status from low slave by maintaining an obedience of above 90",
            "Ask Shintani if he needs any extra help",
            "Raise your status from slave"
        ]
    },
    "the_nipon_economy": {
        "name": "The Nipon Economy",
        "flavor_text": "Shintani has tasked you with turning ¤200 into ¤1000 using any legal \
            means possible within the confines of Nipon. He is both testing your abilities as well \
            as assessing Nipon\'s economy.",
        "stages": [
            "Visit the mines",
            "Visit the trade stalls",
            "Visit the Trade Union",
            "Report to Shintani after accumulating " + setup.LARI + "1000"
        ]
    },
    "knowledge_is_power": {
        "name": "Knowledge is Power",
        "flavor_text": "To better understand Nipon, you need access to the information collected by \
            the Hiroyuki household. That knowledge you predict lies in the locked library.",
        "stages": [
            "Ask Himari about access to the library",
            "Obtain the key by either paying Himari or working at the brothel",
            "Search the library for any important information"
        ]
    },
    "path_to_greatness": {
        "name": "Path to Greatness",
        "flavor_text": "To survive in this harsh world and be prepared for the challenges that await you, \
            you need to train yourself.",
        "stages": [
            "Visit the Nipon Barracks in Central Nipon",
            "Find Emily and pay her the one-time fee or do her a favor",
            "Train at the Nipon Barracks"
        ]
    },
    "path_to_freedom": {

    },
    "power_struggles": {
        "name": "Power Struggles",
        "flavor_text": "There seems to be tension among some of the powers residing in Nipon. You \
            should investigate this as it may be the key to your freedom.",
        "stages": [
            "Meet Lia in her tower in Central Nipon after she gets off work.",
            "Search Shintani\'s library for the Hiroyuki family registry, or inform Shintani about Lia\'s plans (betray Lia).",
            "Search Shintani\'s room for documents, or inform Shintani about Lia\'s plans (betray Lia).",
            "Bring the documents to Lia in her tower.",
            "Wear the Hiroyuki family crest in front of Emily",
            "Visit Emily at her house in the slums"
        ]
    }
};
/* twine-user-script #37: "statuses.js" */
setup.statuses = {};
setup.availstatuses = ['unknown', 'low_slave', 'slave', 'high_slave', 
                        'poor_citizen', 'citizen', 'rich_citizen'];

for (var i = 0; i < setup.availstatuses.length; i++) {
    setup.statuses[setup.availstatuses[i]] = {};
    setup.statuses[setup.availstatuses[i]]['stat_changes'] = {};
    setup.statuses[setup.availstatuses[i]]['condition_changes'] = {};
    setup.statuses[setup.availstatuses[i]]['article'] = "a";

    /* Flavor text only. Not programmically integrated */
    setup.statuses[setup.availstatuses[i]]['extra_changes'] = [];
}

setup.statuses.unknown.article = "an";
setup.statuses.unknown.stat_changes['manipulation'] = -10;
setup.statuses.unknown.stat_changes['tact'] = -10;
setup.statuses.unknown.flavor_text = "\
    you are viewed as an outsider. With so much chaos in this world, \
    you will face significant difficu<ies gaining the trust of the locals.\
";

setup.statuses.low_slave.article = "a";
setup.statuses.low_slave.stat_changes['manipulation'] = -5;
setup.statuses.low_slave.stat_changes['tact'] = -5;
setup.statuses.low_slave.flavor_text = "\
    you are viewed as an outsider. With so much chaos in this world, \
    you will face significant difficu<ies gaining the trust of the locals. \
    Luckily your master gives you some credibility. To move up the ranks in \
    slave-hood you need to increase trust with your master.\
";

setup.statuses.slave.article = "a";
setup.statuses.slave.flavor_text = "\
    you are viewed neutrally. While slaves are the backbone of the economy, \
    they are still regarded as lower than ordinary citizens. \
    Luckily your master gives you some credibility. To move up the ranks in \
    slave-hood you need to increase trust with your master.\
";

setup.statuses.high_slave.article = "a";
setup.statuses.high_slave.stat_changes['manipulation'] = 2;
setup.statuses.high_slave.stat_changes['tact'] = 2;
setup.statuses.high_slave.flavor_text = "\
    you are viewed as an upstanding slave and an envy among slave owners. \
    You will be treated with some level of respect, but ultimately still \
    less than ordinary citizens.\
";
/* twine-user-script #38: "timeout.js" */
function setup_timeout(t){var i;t.setTimeout=window.setTimeout,t.clearTimeout=window.clearTimeout,t.TO=function(){},t.list={},t.settings={eval:!1},t.checkParam=function(i){if(!t.settings.eval&&"string"==typeof i)throw new Error("setTimeout blocked evaluation of string, use a function instead.");if(i)return!0},t.makeFunction=function(i){return function(e){if(e=i.args.slice(),t.settings.eval)e[0]=i.param,e[1]=0,t.setTimeout.apply(window,e);else{if(!t.checkParam(i.param)||!i.param.apply)throw new Error("unsupported param for setTimeout i.e. non-function used.");i.param.apply(window,e.slice(2))}window.clearTimeout(i.tid)}},window.setTimeout=function(i,e){var o,n;if(t.checkParam(i))return i instanceof t.TO?(n=i).args[1]=n.timeout:((n=new t.TO).func=t.makeFunction(n),n.param=i,n.timeout=e,n.args=Array.prototype.slice.call(arguments,0),n.args[0]=n.func),n.tid=t.setTimeout.apply(window,n.args),t.list[n.tid]=n,(o=new Number(n.tid)).clear=window.clearTimeout,o.trigger=window.triggerTimeout,o.update=window.updateTimeout,o},window.clearTimeout=function(i){this instanceof Number&&(i=0+this),window.getTimeout(i)&&(delete t.list[i],t.clearTimeout.call(window,i))},window.getTimeout=function(i){var e;if(e=t.list[i])return e},window.triggerTimeout=function(t){var i;if(this instanceof Number&&(t=0+this),!(i=window.getTimeout(t)))throw new Error("No Timeout found to trigger for ID "+t);window.clearTimeout(t),i.func.call(window)},window.updateTimeout=function(t,i){var e;if(this instanceof Number&&(1==arguments.length&&(i=t),t=0+this),e=window.getTimeout(t))return e.timeout=i,window.clearTimeout(t),window.setTimeout(e);throw new Error("No Timeout found to update for ID "+t)},window.clearAllTimeouts=function(){for(var i in t.list)window.clearTimeout(i)},window.onunload=(i=window.onunload,function(){window.clearAllTimeouts(),t.list={},i&&i.call(window)})}setup_timeout({});
/* twine-user-script #39: "titles.js" */
// Static dictionary for titles
setup.titles = {};
setup.availtitles = ['hearty', 'nimble', 'silver_tongued', 'sharpshooter', 'curious',
    'lost_knowledge', 'well_connected', 'sloth', 'thief', 'night_fox',
    'past_scholar', 'past_slaver', 'past_mercenary', 'past_slave', 
    'past_royal', 'trade_union_patron'];

for (var i = 0; i < setup.availtitles.length; i++) {
    setup.titles[setup.availtitles[i]] = {};
    setup.titles[setup.availtitles[i]]['stat_changes'] = {};
    setup.titles[setup.availtitles[i]]['condition_changes'] = {};
    setup.titles[setup.availtitles[i]]['skill_changes'] = {};
    setup.titles[setup.availtitles[i]]['preposition'] = "As a";
    /* Flavor text only. Not programmically integrated */
    setup.titles[setup.availtitles[i]]['extra_changes'] = [];
}

setup.titles.hearty.condition_changes['health'] = 10;
setup.titles.hearty.condition_changes['stamina'] = 5;
setup.titles.hearty.preposition = "Being";
setup.titles.hearty.flavor_text = "\
    you stood against the harshness of this world without flinching. \
    This solidified both your body and spirit.\
";

setup.titles.nimble.stat_changes['dexterity'] = 5;
setup.titles.nimble.condition_changes['stamina'] = -5;
setup.titles.nimble.preposition = "Being";
setup.titles.nimble.flavor_text = "\
    you evaded the harshes realities of this world, but a consequence of \
    your frame is less energy to take on challenges straight on.\
";

setup.titles.silver_tongued.stat_changes['manipulation'] = 2;
setup.titles.silver_tongued.stat_changes['tact'] = 2;
setup.titles.silver_tongued.extra_changes.push(["Slight increased chance for compliments \
    to be well recieved."]);
setup.titles.silver_tongued.preposition = "Being";
setup.titles.silver_tongued.flavor_text = "\
    you talked your way into great fortunes and out of peril. \
    This gives you an edge when dealing with people.\
";

setup.titles.sharpshooter.skill_changes['ranged'] = 5;
setup.titles.sharpshooter.flavor_text = "\
    you honed your craft with both bows and guns. You view the rifle as an extention \
    of not just your body, but also of your soul.\
";

setup.titles.curious.stat_changes['intelligence'] = 2;
setup.titles.curious.stat_changes['tact'] = 2;
setup.titles.curious.preposition = "Being";
setup.titles.curious.flavor_text = "\
    you often found yourself amonst some of the greatest mysteries of \
    this world. This gives you great insight into how people and reality works.\
";

setup.titles.lost_knowledge.extra_changes.push(["Grants knowledge of the lost touges."]);
setup.titles.lost_knowledge.preposition = "Having";
setup.titles.lost_knowledge.flavor_text = "\
    you are gifted with the ability to read and comprehend the lost touges. \
    You often wonder to yourself why you spent so much effort into understanding languages \
    that no one else seems to know, but perhaps fate may reward you one day.\
";

setup.titles.well_connected.extra_changes.push(["-50% spread when trading commodities."]);
setup.titles.well_connected.preposition = "Being";
setup.titles.well_connected.flavor_text = "\
    you often easily found great deals when trading with people as \
    they knew an investment into you was far more valuable than some extra lari.\
";

setup.titles.sloth.extra_changes.push(["Obedience gain and loss is twice as slow."]);
setup.titles.sloth.flavor_text = "\
    you pride yourself in being able to give the perception of slower change to others. \
    This allows your obedience when being a slave to decay at half the rate, but it also means \
    it is built up at half the rate as well.\
";

setup.titles.thief.extra_changes.push(["Find more loot when stealing."]);
setup.titles.thief.flavor_text = "\
    you know exactly where to look for valuables when searching people\'s room at night. \
    This allows you to find more valuables when committing crimes.\
";

setup.titles.night_fox.extra_changes.push(["-20% suspicion gain while molesting."]);
setup.titles.night_fox.flavor_text = "\
    you can hide in the shadows and keep your movements light. This prevents people \
    from noticing that you are messing with them while asleep.\
";


setup.titles.past_scholar.stat_changes['intelligence'] = 20;
setup.titles.past_scholar.stat_changes['strength'] = -5;
setup.titles.past_scholar.flavor_text = "\
    you spent much of your life engrossed in the books that shaped the \'Old World\' \
    before the dusting. You often spent your time contemplating deep truths, giving \
    you an advantage to learning new things and understanding the inner workings of the world.\
";

setup.titles.past_slaver.stat_changes['manipulation'] = 20;
setup.titles.past_slaver.stat_changes['tact'] = -5;
setup.titles.past_slaver.flavor_text = "\
    you understand the best way to break slaves to your will and make \
    money off of them. You have a much better ability to judge one's weaknesses and \
    exploit them to your will. While this gives you an edge treating humans as products, \
    it also limits your ability to empathize with them.\
";

setup.titles.past_mercenary.stat_changes['intelligence'] = -5;
setup.titles.past_mercenary.stat_changes['dexterity'] = 10;
setup.titles.past_mercenary.stat_changes['strength'] = 10;
setup.titles.past_mercenary.flavor_text = "\
    you spent much of your life training giving you an advantage \
    on the physical side. However, with ideological values drilled into you regarding \
    the value of human life and when to take it, you lost a bit of edge and adaptability \
    to new things.\
";

setup.titles.past_slave.stat_changes['manipulation'] = 10;
setup.titles.past_slave.stat_changes['strength'] = -5;
setup.titles.past_slave.stat_changes['tact'] = 10;
setup.titles.past_slave.flavor_text = "\
    you know how to say the right things to please your master as well \
    as those around you. You have a heighted ability to empathize with others allowing \
    the building on strong relationships. \
";

setup.titles.past_royal.stat_changes['intelligence'] = 10;
setup.titles.past_royal.stat_changes['tact'] = 10;
setup.titles.past_royal.stat_changes['strength'] = -5;
setup.titles.past_royal.flavor_text = "\
    you've spent much of your life navigating both intellectual and \
    political warfare. This gives you high adaptability in both learning new things \
    as well as encountering new and unknown people.\
";

setup.titles.trade_union_patron.stat_changes['intelligence'] = 3;
setup.titles.trade_union_patron.stat_changes['manipulation'] = 1;
setup.titles.trade_union_patron.stat_changes['tact'] = -1;
setup.titles.trade_union_patron.flavor_text = "\
    you've become a central part of the Trade Union\'s business. The trade union while \
    weakly established, thrives in certain settlements. This gives you more information about \
    the local economy as well as some stature. However it further separates you from the common \
    man.\
";
/* twine-user-script #40: "utils.js" */
// Displays change from two values
setup.show_change = function(before, after) {
    if (after > before) {
        return '+' + setup.round2(after - before).toString();
    } else {
        return setup.round2(after - before).toString();
    }
}

// Displays change from two values in an HTML string with colors
setup.show_change_html = function(before, after, positive=true, text=false) {
    var ret = "<span class=";
    if (after > before) {
        if (positive) {
            ret += "\"success\">";
        } else {
            ret += "\"fail\">";
        }
        if (text) {
            return ret + "increased</span>";
        } else {
            return ret + "+" + setup.round2(after - before).toString() + "</span>";
        }
    } else {
        if (positive) {
            ret += "\"fail\">";
        } else {
            ret += "\"success\">";
        }
        if (text) {
            return ret + "decreased</span>";
        } else {
            return ret + setup.round2(after - before).toString() + "</span>";
        }
    }
}

setup.show_money_change_html = function(before, after, positive=true) {
    var ret = "<span class=";
    if (after >= before) {
        if (positive) {
            ret += "\"success\">";
        } else {
            ret += "\"fail\">";
        }
        return ret + "+" + setup.LARI + setup.round2(after - before).toString() + "</span>";
    } else {
        if (positive) {
            ret += "\"fail\">";
        } else {
            ret += "\"success\">";
        }
        return ret + "-" + setup.LARI + Math.abs(setup.round2(after - before)).toString() + "</span>";
    }
}

// Returns a pass roll span
setup.pass = function(stat, put_break=true) {
    var ret = "<span class=\"success\">(" + setup.titleCase(stat) + " roll passed)</span>";
    if (put_break) {
        ret += "<br>"
    }
    return ret;
}

// Returns a pass roll span
setup.fail = function(stat, put_break=true) {
    var ret = "<span class=\"fail\">(" + setup.titleCase(stat) + " roll failed)</span>";
    if (put_break) {
        ret += "<br>"
    }
    return ret;
}

// Returns a partial roll span
setup.partial = function(stat, put_break=true) {
    var ret = "<span class=\"partial\">(" + setup.titleCase(stat) + " roll partially passed)</span>";
    if (put_break) {
        ret += "<br>"
    }
    return ret;
}

// Puts a string in titleCase (first letter capitalized in each word)
setup.titleCase = function(str) {
    str = str.replace(/_/g, ' ');
    var splitStr = str.toLowerCase().split(' ');
    for (var i = 0; i < splitStr.length; i++) {
        splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].substring(1);     
    }
    return splitStr.join(' '); 
}

// Prints date
setup.print_date = function(date) {
    var GameDays = [
		"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"
	];
	var GameMonths = [
		"Jan", "Feb", "Mar", "Apr", "May", "Jun",
		"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
	];

    return String.format("{1} {2}, {3}",
        GameDays[date.getDay()],
        GameMonths[date.getMonth()],
        date.getDate(),
        date.getFullYear()
    );
}

// Prints 12hr time
setup.print_time12hr = function(date) {
    var ret = "";
    if (date.getHours() == 0) {
        ret += "12"
    } else if (date.getHours() > 12) {
        ret += (date.getHours() - 12).toString();
    } else {
        ret += date.getHours().toString();
    }
    ret += ":";

    if (date.getMinutes() < 10) {
        ret += "0"
    }
    ret += date.getMinutes().toString();

    if (date.getHours() >= 12) {
        ret += " PM"
    } else {
        ret += " AM"
    }

    return ret;
}

// Delays by time
setup.delay = function(time) {
    return new Promise(resolve => setTimeout(resolve, time));
}

setup.is_night = function(datetime) {
    return (datetime.getHours() <= 5 || datetime.getHours() >= 20)
}
setup.is_day = function(datetime) {
    return !setup.is_night(datetime);
}

// Gets descriptor given key and value
setup.get_descriptor = function(key, value) {
    if (key in setup.DESCRIPTORS) {
        var max_val = -200;
        var ret = ""
        for (var _key in setup.DESCRIPTORS[key]) {
            var _key_float = parseFloat(_key);
            if (_key_float <= value) {
                if (_key_float > max_val) {
                    max_val = _key_float;
                    ret = setup.DESCRIPTORS[key][_key];
                }
            }
        }
        return ret;
    } else {
        return null;
    }
}

// Gets value of a key recursively, undefined behavior if duplicate keys exist
setup.get = function(obj, key) {
    if (key in obj) {
        return obj[key];
    } else {
        for (var _key in obj) {
            if (typeof obj[_key] === 'object' && !Array.isArray(obj[_key]) && 
                obj[_key] !== null && typeof obj[_key] !== 'string') {
                var temp = setup.get(obj[_key], key);
                if (temp != null) {
                    return temp;
                }
            }
        }
    }
    return null;
}

// Append to the mainLog
setup.mainLog_append = function(data, fadeIn=true, transform=true) {
    if (!(data instanceof jQuery) && transform) {
        var html_data = $("<div></div>");
        html_data.html(data.trim());
    } else {
        var html_data = data;
    }
    if (html_data instanceof jQuery && fadeIn) {   
        html_data.css("display", "none");
    }
    $("#mainLog").append(html_data);
    if (html_data instanceof jQuery && fadeIn) {   
        html_data.fadeIn();
    }
    var elem = document.getElementById("mainLog");
    elem.scrollTop = elem.scrollHeight;
}

setup.mainLog_append_delayed = function(data, to_disable=null, to_hide=null,
        default_time=1000, adaptive=true, words_per_sec=null) {
    State.temporary.done_appending = false;
    if(data == "undefined" || data.length == 0) {
        return;
    }
    if (to_disable != null) {
        var prev_state = [];
        for (var _i = 0; _i < to_disable.length; _i++) {
            // Store previous state
            prev_state.push($(to_disable[_i] + " button").prop("disabled"));
            // Disable
            $(to_disable[_i] + " button").prop("disabled", true);
            $(to_disable[_i] + " button").addClass("disabled");
        }
    }

    if (to_hide != null) {
        var prev_hide = [];
        for (var _i = 0; _i < to_hide.length; _i++) {
            // Store previous state
            prev_hide.push($(to_hide[_i]).hasClass("hidden"));
            // Hide
            $(to_hide[_i]).addClass("hidden");
        }
    }

    if (words_per_sec == null) {
        words_per_sec = State.variables.words_per_sec;
    }

    // Prepend a break
    if (data[0] instanceof String || typeof data[0] === 'string') {
        data[0] = "<br>" + data[0];
    } else if (data[0] instanceof jQuery) {
        data[0].prepend("<br>");
    }

    setup.mainLog_append(data[0]);
    var times = [];
    for (var _i = 0; _i < data.length - 1; _i++) {
        if (adaptive) {
            if (data[_i] instanceof String || typeof data[_i] === 'string') {
                times.push(Math.floor(1000 * $($.parseHTML(data[_i])).text().trim().split(/\s+/).length / words_per_sec));
            } else if (data[_i] instanceof jQuery) {
                times.push(Math.floor(1000 * data[_i].text().trim().split(/\s+/).length / words_per_sec));
            } else {
                times.push(default_time);
            }
        } else {
            times.push(default_time);
        }
    }

    var i = 1;
    function loop() {
        State.temporary.timeout_id = setTimeout(function() {
            setup.mainLog_append(data[i]);
            i++;
            delete State.temporary.timeout_id;
            if (i < data.length) {
                loop();
            } else {
                // Revert disabled buttons to previous state
                if (to_disable != null) {
                    for (var _i = 0; _i < to_disable.length; _i++) {
                        if (!prev_state[_i]) {
                            // Enable
                            $(to_disable[_i] + " button").prop("disabled", false);
                            $(to_disable[_i] + " button").removeClass("disabled");
                        }
                    }
                }

                // Revert hiding to previous state
                if (to_hide != null) {
                    for (var _i = 0; _i < to_hide.length; _i++) {
                        if (!prev_hide[_i]) {
                            // Unhide
                            $(to_hide[_i]).removeClass("hidden");
                        }
                    }
                }
                State.temporary.done_appending = true;
                delete State.temporary.in_dialogue;
            }
        }, times[i - 1])
    }
    if (data.length > 1) {
        loop();
        setTimeout(() => {
            State.temporary.in_dialogue = true;
        }, 10);
    } else {
        // Revert disabled buttons to previous state
        if (to_disable != null) {
            for (var _i = 0; _i < to_disable.length; _i++) {
                if (!prev_state[_i]) {
                    // Enable
                    $(to_disable[_i] + " button").prop("disabled", false);
                    $(to_disable[_i] + " button").removeClass("disabled");
                }
            }
        }

        // Revert hiding to previous state
        if (to_hide != null) {
            for (var _i = 0; _i < to_hide.length; _i++) {
                if (!prev_hide[_i]) {
                    // Unhide
                    $(to_hide[_i]).removeClass("hidden");
                }
            }
        }
        State.temporary.done_appending = true;
    }
}

setup.remove_val = function(array, val) {
    const index = array.indexOf(val);
    if (index > -1) {
        array.splice(index, 1); // 2nd parameter means remove one item only
    }
}

setup.molest_state_to_string = function(molest_state) {
    var states = [];

    if (molest_state.awake) {
        states.push("awake");
        if (molest_state.cum == "hair" || 
            molest_state.cum == "face" ||
            molest_state.cum == "in_mouth") {
            states.push(molest_state.cum);
        }
    } else {
        if (!molest_state.blanket) {
            states.push("noblanket");
            if (!molest_state.bottom) {
                states.push("nobottom");
            }
            if (!molest_state.top) {
                states.push("notop");
            }
        }
        if (molest_state.cum != "none") {
            // Don't render feet
            var render_cum = (molest_state.cum != "feet" && molest_state.cum != "ground");
            // For now don't rending any in's
            render_cum &= (molest_state.cum.split("_")[0] != "in");
            if (molest_state.blanket) {
                if (molest_state.cum != "blanket" ||
                    molest_state.cum != "hair" || 
                    molest_state.cum != "face" || 
                    molest_state.cum != "in_mouth") {
                    render_cum = false;
                }
            } else {
                if (molest_state.cum == "blanket") {
                    render_cum = false;
                }
                if (molest_state.bottom) {
                    if (molest_state.cum == "pussy" || 
                        molest_state.cum == "in_pussy" ||
                        molest_state.cum == "in_ass") {
                        render_cum = false;
                    }
                } else if(molest_state.cum == "bottom") {
                    render_cum = false;
                }
            }
            if (render_cum) {
                states.push(molest_state.cum);
            }
        }
    }
    if (states.length == 0) {
        return "";
    } else {
        return "_" + states.join("_");
    }

}

/**
* Performs a deep merge of objects and returns new object. Does not modify
* objects (immutable) and merges arrays via concatenation.
*
* @param {...object} objects - Objects to merge
* @returns {object} New object with merged key/values
*/
setup.mergeDeep = function(...objects) {
    const isObject = obj => obj && typeof obj === 'object';

    return objects.reduce((prev, obj) => {
        Object.keys(obj).forEach(key => {
            const pVal = prev[key];
            const oVal = obj[key];
            
            if (Array.isArray(pVal) && Array.isArray(oVal)) {
                prev[key] = pVal.concat(...oVal);
            }
            else if (isObject(pVal) && isObject(oVal)) {
                prev[key] = mergeDeep(pVal, oVal);
            }
            else {
                prev[key] = oVal;
            }
        });
        
        return prev;
    }, {});
}

// Changes a string into camel case
setup.camelize = (str) =>  str.toLowerCase().replace(/[^a-zA-Z ]/g, "").replace(/(?:^\w|[A-Z]|\b\w)/g, (ltr, idx) => idx === 0 ? ltr.toLowerCase() : ltr.toUpperCase()).replace(/\s+/g, '');

setup.project_stamina_change = function(minutes, include_rand=false, is_working=null, is_outside=null) {
    let _v = State.variables;
    let _t = State.temporary;
    let player = _v.player;
    let difficulty = _v.difficulty;
    let time_awake = _v.time_awake;
    let mult = 1;
    let delta_stamina = 0;

    if ((is_working != null && is_working) || player.is_working) {
        mult = 3;
    }
    if ((is_outside != null && is_outside) || player.is_outside) {
        mult *= 2;
    }

    if (_t.is_molesting !== "undefined" && _t.is_molesting) {
        mult *= 5;
    }

    if (difficulty > -1 && include_rand) {
        mult *= (1 + setup.randn_bm() / 10 * (difficulty + 1));
    }

    if (!player.is_sleeping) {
        let C = 200 / 1440;
        delta_stamina = mult * minutes * ((3/10 * player.stats.strength - C * time_awake) - C * minutes / 2) / 1440;
    } else {
        delta_stamina = mult * 3 * 50 / 1440 * minutes;
    }
    return delta_stamina;
}</script><tw-passagedata pid="1" name="audioEngine" tags="" position="100,100" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _cur_location = passage()&gt;&gt;
&lt;&lt;set _temp = setup.locations.get_recur_attrib(_cur_location, &quot;music&quot;)&gt;&gt;
&lt;&lt;if def _temp &amp;&amp; _temp != null &amp;&amp; $enable_music&gt;&gt;
    &lt;&lt;if def $playing &amp;&amp; $playing != &quot;none&quot; &amp;&amp; _temp != $playing&gt;&gt;
        &lt;&lt;playlist $playing fadeoverto 0.3 0&gt;&gt;
		&lt;&lt;timed 300ms&gt;&gt;
			&lt;&lt;playlist $playing stop&gt;&gt;
            &lt;&lt;set $playing = _temp&gt;&gt;
            &lt;&lt;playlist _temp volume 1 loop shuffle play&gt;&gt;
		&lt;&lt;/timed&gt;&gt;
    &lt;&lt;else&gt;&gt;
        /* In case load in save to resume */
        &lt;&lt;playlist _temp volume 1 loop shuffle play&gt;&gt;
        &lt;&lt;set $playing = _temp&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="2" name="credits" tags="black" position="225,100" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;background&quot; class=&quot;paper_border&quot;&gt;
    &lt;div class=&quot;container threeCol&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div class=&quot;subbackground&quot;&gt;
            &lt;center&gt;&lt;h3&gt;Music&lt;/h3&gt;&lt;/center&gt;
            &lt;div class=&quot;textpassage&quot; style=&quot;margin-left: 20px; margin-right: 20px&quot;&gt;
                Enderal Soundtrack - &lt;br&gt;
                &lt;div style=&quot;margin-left: 20px&quot;&gt;
                    Marvin Kopp&lt;br&gt;
                    Andreas Makusev&lt;br&gt;
                    Simon W. Autenrieth&lt;br&gt;
                    Sabastian Loebbers&lt;br&gt;
                    Nicolas Samuel Lietzau
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &lt;center&gt;&lt;h3&gt;Inspiration&lt;/h3&gt;&lt;/center&gt;
            &lt;div class=&quot;textpassage&quot; style=&quot;margin-left: 20px; margin-right: 20px&quot;&gt;
                Free Cities - FC Author&lt;br&gt;
                Masters of Raana - GrimDark
            &lt;/div&gt;
            &lt;br&gt;&lt;hr&gt;&lt;br&gt;
            &lt;center&gt;&lt;&lt;button Return Start&gt;&gt;&lt;&lt;/button&gt;&gt;&lt;/center&gt;
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &lt;div class=&quot;license&quot;&gt;
                &lt;a href=&quot;https://creativecommons.org/licenses/by-nc-sa/4.0/&quot;&gt;
                    &lt;img class=&quot;license&quot; src=&quot;resources/images/license.png&quot;&gt;
                &lt;/a&gt;
                &lt;p class=&quot;license title&quot;&gt;Mimus Studios, 2022&lt;/p&gt;
            &lt;/div&gt;
            
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="3" name="WIPMenu" tags="black" position="350,100" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border&quot; style=&quot;position: relative&quot;&gt;
    &lt;center&gt;&lt;h1&gt;Under Construction&lt;/h1&gt;&lt;/center&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
        This passage is still under construction. If you would like to keep up to date with 
        the latest updates you can join the &lt;a href=&quot;https://discord.gg/xrynJUBksW&quot;&gt;Discord&lt;/a&gt;. 
        Or if you would like to alpha test the latest 
        versions you can subscribe to the SubscribeStar.
    &lt;/p&gt;

    &lt;div style=&quot;position: absolute; bottom: 100px; left: calc(50% - 82px);&quot;&gt;
        &lt;&lt;button Back&gt;&gt;
            &lt;&lt;set $in_menu = false&gt;&gt;
            &lt;&lt;goto $last_visited&gt;&gt;
            &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt;  
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="4" name="defaultAsk" tags="" position="475,100" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _choices = 2&gt;&gt;
&lt;&lt;script&gt;&gt;
    var player = State.variables.player;
    var selected = State.variables.characters[State.variables.selected];
    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
    var html = &quot;
        You greet &quot; + setup.titleCase(selected.first_name) + &quot;,&lt;br&gt;&quot; +
        &quot;&lt;em&gt;&lt;b&gt;&quot; + setup.titleCase(player.first_name) + &quot;&lt;/b&gt;: \&quot;I was hoping I could \
        ask you a couple of things?\&quot;&lt;/em&gt;\
        &lt;br&gt;&quot; + setup.titleCase(selected.first_name) + &quot; eyes you up and down, wondering what you want.\
        &lt;br&gt;\
        What would you like to ask about?\
        &lt;ol&gt;\
            &lt;li&gt;&quot; + setup.titleCase(setup.PRONOUNS[selected.gender][&quot;?his&quot;]) +&quot; background.&lt;/li&gt;\
            &lt;li&gt;How &quot; + setup.titleCase(setup.PRONOUNS[selected.gender][&quot;?he&quot;]) + &quot; is doing.&lt;/li&gt;\
        &lt;/ol&gt;\
    &quot;;
    div.html(html);
    setup.mainLog_append(div);
&lt;&lt;/script&gt;&gt;

&lt;&lt;disableactions&gt;&gt;

/* Allow back and leave buttons */
&lt;&lt;removeclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
&lt;&lt;removeclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;

/* Psuedoevent listener for action */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;set _char = $characters[$selected]&gt;&gt;
        &lt;&lt;if _char.limits.ask gt 0&gt;&gt;
            &lt;&lt;set _char.limits.ask -= 1&gt;&gt;
            &lt;&lt;switch _action&gt;&gt;
                &lt;&lt;case 1&gt;&gt;
                    &lt;&lt;run $(&quot;#events1 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events1 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _responses = [$player.dialogue(&quot;So what got you here?&quot;)]&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(
                        &quot;Well we\&#39;ve all got a past, but I\&#39;m not trying to relive that at the moment.&quot;
                    ))&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                &lt;&lt;case 2&gt;&gt;
                    &lt;&lt;run $(&quot;#events2 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events2 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _responses = [$player.dialogue(&quot;How are you?&quot;)]&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(
                        &quot;Good I suppose.&quot;
                    ))&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
            &lt;&lt;/switch&gt;&gt;
            /* Advance time every time an ask is performed */
            &lt;&lt;set _roll = dice(1, 5) + 5&gt;&gt;
            &lt;&lt;addmins _roll&gt;&gt;
            &lt;&lt;unset _roll&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;notify&gt;&gt;Already asked &lt;&lt;= setup.titleCase($characters[$selected].first_name)&gt;&gt; 
            too many things today!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
        &lt;&lt;unset _char&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="5" name="complimentEngine" tags="" position="600,100" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Roll tact for success */
&lt;&lt;set _roll = $player.get_status_prop(&quot;tact&quot;) + 2 * (dice(1, 6 + $difficulty) - $difficulty)
    - _char.mental_conditions.anger + _char.slave_traits.trust / 20
&gt;&gt;
&lt;&lt;set _max_roll = $player.get_status_prop(&quot;tact&quot;) + 2 * 6
    - _char.mental_conditions.anger + _char.slave_traits.trust / 20&gt;&gt;

/* Silver tongue title */
&lt;&lt;if $player.titles.has(&quot;silver_tongued&quot;)&gt;&gt;
    &lt;&lt;set _roll += 1&gt;&gt;
    &lt;&lt;set _max_roll += 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;set _thresh = 25 + 5 * (-1/100 * _char.slave_traits.obedience)&gt;&gt;

&lt;&lt;if _roll gte _thresh&gt;&gt;
    &lt;&lt;set _success = true&gt;&gt;
    &lt;&lt;set _responses = [setup.pass(&quot;tact&quot;, false)]&gt;&gt;
    &lt;&lt;set _responses = _responses.concat( setup.influence.compliment.success.random())&gt;&gt;
    &lt;&lt;if _char.slave_traits.obedience gte 80&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; smiles warmly,&quot;)&gt;&gt;
        &lt;&lt;set _response = _char.dialogue(&quot;Thanks!&quot;) + 
            &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + &quot;Affection&quot; + setup.show_change_html(0, 0.25)
        &gt;&gt;
        &lt;&lt;set _char.slave_traits.obedience += 0.25&gt;&gt;
    &lt;&lt;elseif _char.slave_traits.obedience gte 60&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; smiles warmly,&quot;)&gt;&gt;
        &lt;&lt;set _response = _char.dialogue(&quot;Thanks!&quot;) +
            &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + &quot;Affection&quot; + setup.show_change_html(0, 0.5)
        &gt;&gt;
        &lt;&lt;set _char.slave_traits.obedience += 0.5&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; is momentarily caught off guard,&quot;)&gt;&gt;
        &lt;&lt;set _response = _char.dialogue(&quot;Th... thanks, I guess.&quot;) +
            &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + &quot;Affection &quot; + setup.show_change_html(0, 2)
        &gt;&gt;
        &lt;&lt;set _char.slave_traits.obedience += 2&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;if _char.mental_conditions.sadness gt 0&gt;&gt;
        &lt;&lt;set _response += &quot;Sadness &quot; + setup.show_change_html(0, -5, false)&gt;&gt;
        &lt;&lt;set _char.mental_conditions.sadness -= 5&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;set _response += &quot;).&quot;&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;set _success = false&gt;&gt;
    &lt;&lt;set _responses = [setup.fail(&quot;tact&quot;, false)]&gt;&gt;
    &lt;&lt;set _responses = _responses.concat( setup.influence.compliment.fail.random())&gt;&gt;
    &lt;&lt;set _response = setup.titleCase(_char.first_name) + &quot; looks at you with an \
        unimpressed stare, but luckily it looks like your failed attempt has not \
        lowered her opinion of you.&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Check if was skillful roll */
&lt;&lt;if Math.abs(_max_roll - _thresh) lte 1 &amp;&amp; (_max_roll - _roll) lte 1&gt;&gt;
    &lt;&lt;set _probability = setup.sigmoid(-1 * $difficulty)&gt;&gt;
    &lt;&lt;set _sub_roll = Math.random()&gt;&gt;
    &lt;&lt;if _roll lt _probability&gt;&gt;
        &lt;&lt;set _response += &quot;&lt;br&gt;&lt;br&gt;&quot;&gt;&gt;
        &lt;&lt;if _success&gt;&gt;
            &lt;&lt;set _response += &quot;You can tell that compliment barely passed, but luckily your \
                skill in speechcraft let you prevail. &lt;span style=\&#39;text: green\&#39;&gt;\
                Your tact increased by 1!&lt;/span&gt;&quot;&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _response += &quot;You can tell that compliment almost landed, you\&#39;ll have to \
                work harder next time. &lt;span style=\&#39;text: green\&#39;&gt;\
                Your tact increased by 1!&lt;/span&gt;&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set $player.stats.tact += 1&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;unset _probability&gt;&gt;
    &lt;&lt;unset _sub_roll&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;set _responses.push(_response)&gt;&gt;

&lt;&lt;set _to_round = $selected&gt;&gt;
&lt;&lt;include round&gt;&gt;

&lt;&lt;if def _options&gt;&gt;
    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;script&gt;&gt;
    setup.mainLog_append_delayed(State.temporary.responses, 
        State.variables.buttons, 
        State.variables.buttons_extra);
&lt;&lt;/script&gt;&gt;

&lt;&lt;unset _response&gt;&gt;
&lt;&lt;unset _responses&gt;&gt;
&lt;&lt;unset _to_round&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="6" name="dirtyCommentEngine" tags="" position="725,100" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Roll tact for success */
&lt;&lt;set _roll = $player.get_status_prop(&quot;tact&quot;) + 2 * (dice(1, 6 + $difficulty) - $difficulty)
    - _char.mental_conditions.anger + _char.slave_traits.trust / 20
&gt;&gt;
&lt;&lt;set _max_roll = $player.get_status_prop(&quot;tact&quot;) + 2 * 6
    - _char.mental_conditions.anger + _char.slave_traits.trust / 20&gt;&gt;
&lt;&lt;set _thresh = 27 + 5 * (-1/100 * _char.slave_traits.obedience)&gt;&gt;

&lt;&lt;if _roll gte _thresh&gt;&gt;
    /* For simulation afterwards */
    &lt;&lt;set $to_simulate.add(_char.key)&gt;&gt;

    &lt;&lt;set _success = true&gt;&gt;
    &lt;&lt;set _responses = [setup.pass(&quot;tact&quot;, false)]&gt;&gt;
    &lt;&lt;set _disposition = _char.get_disposition()&gt;&gt;
    &lt;&lt;if _disposition == &quot;submissive&quot; || _disposition == &quot;devoted&quot;&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s develops a slight blush and \
            tightens their legs. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
            &quot; is already aroused just from your comment.&quot;)&gt;&gt;
        &lt;&lt;if _char.sex_fetishes.cum gte 50&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;Please let me have a taste of your cum, I\&#39;ve been \
                thinking about it all day!&quot;))&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;You... you can take me whenever you want.&quot;))&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _response = &quot;(&quot; + setup.titleCase(_char.first_name) + &quot; Arousal &quot; + 
            setup.show_change_html(0, 5) + &quot;).&quot;&gt;&gt;
        &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;if _char.mental_conditions.arousal gte 10&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s already very aroused and \
                your comment takes &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; over the edge. You \
                start to see droplets drip from &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; crotch down &quot; +
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; leg.&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;I don\&#39;t know what has gotten into me, please exuse me.&quot;))&gt;&gt;
            &lt;&lt;set _response = setup.titleCase(_char.first_name) + &quot; hurries off &quot; + 
                &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 3) + 
                &quot;, Willpower &quot; + setup.show_change_html(0, -1, false) + &quot;).&quot;
            &gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 3&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; looks very flustered,&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;Wh..what? I think I have to go.&quot;))&gt;&gt;
            &lt;&lt;set _response = setup.titleCase(_char.first_name) + &quot; hurries off but you know your comment \
                has affected &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; &quot; +
                &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 2) + 
                &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    
&lt;&lt;else&gt;&gt;
    &lt;&lt;set _success = false&gt;&gt;
    &lt;&lt;set _responses = [setup.fail(&quot;tact&quot;, false)]&gt;&gt;
    &lt;&lt;set _responses = _responses.concat( setup.influence.dirty_comment.fail.random())&gt;&gt;
    &lt;&lt;set _response = setup.titleCase(_char.first_name) + &quot; looks at you with an \
        unimpressed stare, but luckily it looks like your failed attempt has not \
        lowered her opinion of you.&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Check if was skillful roll */
&lt;&lt;if Math.abs(_max_roll - _thresh) lte 1 &amp;&amp; (_max_roll - _roll) lte 1&gt;&gt;
    &lt;&lt;set _probability = setup.sigmoid(-1 * $difficulty)&gt;&gt;
    &lt;&lt;set _sub_roll = Math.random()&gt;&gt;
    &lt;&lt;if _roll lt _probability&gt;&gt;
        &lt;&lt;set _response += &quot;&lt;br&gt;&lt;br&gt;&quot;&gt;&gt;
        &lt;&lt;if _success&gt;&gt;
            &lt;&lt;set _response += &quot;You can tell that comment barely passed, but luckily your \
                skill in speechcraft let you prevail. &lt;span style=\&#39;text: green\&#39;&gt;\
                Your tact increased by 1!&lt;/span&gt;&quot;&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _response += &quot;You can tell that comment almost landed, you\&#39;ll have to \
                work harder next time. &lt;span style=\&#39;text: green\&#39;&gt;\
                Your tact increased by 1!&lt;/span&gt;&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set $player.stats.tact += 1&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;unset _probability&gt;&gt;
    &lt;&lt;unset _sub_roll&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;set _responses.push(_response)&gt;&gt;

&lt;&lt;set _to_round = $selected&gt;&gt;
&lt;&lt;include round&gt;&gt;

&lt;&lt;if def _options&gt;&gt;
    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;script&gt;&gt;
    setup.mainLog_append_delayed(State.temporary.responses, 
        State.variables.buttons, 
        State.variables.buttons_extra);
&lt;&lt;/script&gt;&gt;

&lt;&lt;unset _response&gt;&gt;
&lt;&lt;unset _responses&gt;&gt;
&lt;&lt;unset _to_round&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="7" name="influenceEngine" tags="" position="850,100" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;script&gt;&gt;
    var player = State.variables.player;
    var char = State.variables.characters[State.variables.selected];
    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
    var html = &quot;
        You approach &quot; + setup.titleCase(char.first_name) + &quot;,&lt;br&gt;&quot; +
        &quot;&lt;em&gt;&lt;b&gt;&quot; + setup.titleCase(player.first_name) + &quot;&lt;/b&gt;: \&quot;Hey I wanted to discuss some \
        things with you.\&quot;&lt;/em&gt;\
        &lt;br&gt;&quot; + setup.titleCase(char.first_name) + &quot; eyes you up and down, wondering what you want.\
        &lt;br&gt;\
        How would you like to influence &quot; + setup.PRONOUNS[char.gender][&quot;?him&quot;] + &quot;?&quot;;
    State.temporary.options = &quot;&lt;ol&gt;\
        &lt;li&gt;Compliment &quot; + setup.PRONOUNS[char.gender][&quot;?him&quot;] + &quot;.&lt;/li&gt;\
        &lt;li&gt;Tell a joke.&lt;/li&gt;\
        &lt;li&gt;Make a dirty comment.&lt;/li&gt;&quot;;
    if (char.is_slave &amp;&amp; char.owner == &quot;shintani_hiroyuki&quot;) {
        State.temporary.options += &quot;&lt;li&gt;Tell &quot; + setup.PRONOUNS[char.gender][&quot;?him&quot;] + &quot; about your work with Shintani.&lt;/li&gt;&quot;;
    }
    State.temporary.options += &quot;&lt;/ol&gt;&quot;;
    
    if (char.mental_conditions.anger &gt; 0) {
        State.temporary.options = &quot;&lt;div style=\&#39;color: red\&#39;&gt;\
        (&quot; + setup.titleCase(char.first_name) + &quot; will be harder to influence since &quot; + 
        setup.PRONOUNS[char.gender][&quot;?he&quot;] + &quot; is upset)\
        &lt;/div&gt;&quot; + State.temporary.options;
    }
    html += State.temporary.options;
    State.temporary.options = $(State.temporary.options);
    
    div.html(html);
    setup.mainLog_append(div);
&lt;&lt;/script&gt;&gt;

&lt;&lt;set _choices = 4&gt;&gt;
&lt;&lt;disableactions&gt;&gt;

/* Allow back and leave buttons */
&lt;&lt;removeclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
&lt;&lt;removeclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;

/* Psuedoevent listener for action */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;set _char = $characters[$selected]&gt;&gt;
        &lt;&lt;if _char.limits.influence gt 0&gt;&gt;
            &lt;&lt;set _char.limits.influence -= 1&gt;&gt;
            &lt;&lt;switch _action&gt;&gt;
                &lt;&lt;case 1&gt;&gt;
                    &lt;&lt;include complimentEngine&gt;&gt;
                &lt;&lt;case 2&gt;&gt;
                    &lt;&lt;include jokeEngine&gt;&gt;
                &lt;&lt;case 3&gt;&gt;
                    &lt;&lt;include dirtyCommentEngine&gt;&gt;
                &lt;&lt;case 4&gt;&gt;
                    &lt;&lt;set _to_round = $selected&gt;&gt;
                    &lt;&lt;set _responses = [
                        $player.dialogue(&quot;Have you heard about all the work Shintani has me doing?&quot;)
                    ]&gt;&gt;
                    &lt;&lt;set _disposition = _char.get_disposition()&gt;&gt;
                    &lt;&lt;if _disposition == &quot;submissive&quot; || _disposition == &quot;devoted&quot;&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes! Your work has been most impressive thus far!&quot;))&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;if $player.get_status(passage()) == &quot;low_slave&quot;&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(&quot;You mean licking the shit off his boots? \
                                Know your place, you low slave.&quot;))&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;if _char.status == &quot;high_slave&quot; &amp;&amp; $player.get_status(passage()) == &quot;slave&quot;&gt;&gt;
                                &lt;&lt;if $quests.the_nipon_economy.added&gt;&gt;
                                    &lt;&lt;set _responses.push(_char.dialogue(&quot;I honestly don\&#39;t know why Shintani would \
                                        assign you such an important task as testing the economy of Nipon. Don\&#39;t get \
                                        too comfortable and remember your place in front of a high slave.&quot;))&gt;&gt;
                                    &lt;&lt;set _responses.push(&quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + 
                                        setup.show_change_html(0, -2) + &quot;).&quot;)&gt;&gt;
                                    &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                                &lt;&lt;else&gt;&gt;
                                    &lt;&lt;set _responses.push(_char.dialogue(&quot;You mean licking the shit off his boots? \
                                        Know your place in front of a high slave, you slave.&quot;))&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                            &lt;&lt;elseif _char.status == &quot;slave&quot; &amp;&amp; $player.get_status(passage()) == &quot;slave&quot;&gt;&gt;
                                &lt;&lt;if $quests.the_nipon_economy.added&gt;&gt;
                                    &lt;&lt;set _responses.push(_char.dialogue(&quot;I honestly don\&#39;t know why Shintani would \
                                        assign you such an important task as testing the economy of Nipon. Don\&#39;t get \
                                        too comfortable and remember your place in front of a high slave.&quot;))&gt;&gt;
                                    &lt;&lt;set _responses.push(&quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + 
                                        setup.show_change_html(0, -1) + &quot;).&quot;)&gt;&gt;
                                    &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                                &lt;&lt;else&gt;&gt;
                                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Just because you rose through the ranks quickly \
                                        doesn\&#39;t make you any special.&quot;))&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                            &lt;&lt;elseif $player.get_status(passage()) == &quot;high_slave&quot;&gt;&gt;
                                &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes, I heard you were doing quite well, especially \
                                    seeing as how you quickly rose the ranks here.&quot;))&gt;&gt;
                                &lt;&lt;set _responses.push(&quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + 
                                    setup.show_change_html(0, -1) + &quot;).&quot;)&gt;&gt;
                                    &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                            &lt;&lt;elseif _char.status == &quot;low_slave&quot; &amp;&amp; $player.get_status(passage()) == &quot;slave&quot;&gt;&gt;
                                &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes, I heard you were doing quite well, especially \
                                    seeing as how you quickly rose the ranks here.&quot;))&gt;&gt;
                                &lt;&lt;set _responses.push(&quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + 
                                    setup.show_change_html(0, -1) + &quot;).&quot;)&gt;&gt;
                                    &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _responses.push(_options)&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;include round&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _to_round&gt;&gt;
            &lt;&lt;/switch&gt;&gt;
            /* Advance time every time an ask is performed */
            &lt;&lt;set _roll = dice(1, 5) + 5&gt;&gt;
            &lt;&lt;addmins _roll&gt;&gt;
            &lt;&lt;unset _roll&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;notify&gt;&gt;Already influenced &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; 
            too many times today!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
        &lt;&lt;unset _char&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="8" name="jokeEngine" tags="" position="975,100" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Roll tact for success */
&lt;&lt;set _roll = $player.get_status_prop(&quot;tact&quot;) + 2 * (dice(1, 6 + $difficulty) - $difficulty)
    - _char.mental_conditions.anger + _char.slave_traits.trust / 20
&gt;&gt;
&lt;&lt;set _max_roll = $player.get_status_prop(&quot;tact&quot;) + 2 * 6
    - _char.mental_conditions.anger + _char.slave_traits.trust / 20&gt;&gt;
&lt;&lt;set _thresh = 22 + 5 * (-1/100 * _char.slave_traits.obedience)&gt;&gt;

&lt;&lt;if _roll gte _thresh&gt;&gt;
    &lt;&lt;set _success = true&gt;&gt;
    &lt;&lt;set _responses = [setup.pass(&quot;tact&quot;, false)]&gt;&gt;
    &lt;&lt;set _responses = _responses.concat( setup.influence.joke.success.random())&gt;&gt;
    &lt;&lt;if _char.slave_traits.obedience gte 80&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; laughs warmly,&quot;)&gt;&gt;
        &lt;&lt;set _response = _char.dialogue(&quot;You\&#39;re always so funny!&quot;) + 
            &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + &quot;Affection &quot; + setup.show_change_html(0, 0.1) +
            &quot;, Trust &quot; + setup.show_change_html(0, 0.25)
        &gt;&gt;
        &lt;&lt;set _char.slave_traits.obedience += 0.1&gt;&gt;
        &lt;&lt;set _char.slave_traits.trust += 0.25&gt;&gt;
    &lt;&lt;elseif _char.slave_traits.obedience gte 60&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; laughs warmly,&quot;)&gt;&gt;
        &lt;&lt;set _response = _char.dialogue(&quot;You\&#39;re always so funny!&quot;) +
            &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + &quot;Affection &quot; + setup.show_change_html(0, 0.25) +
            &quot;, Trust &quot; + setup.show_change_html(0, 0.5)
        &gt;&gt;
        &lt;&lt;set _char.slave_traits.obedience += 0.25&gt;&gt;
        &lt;&lt;set _char.slave_traits.trust += 0.5&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a slight chuckle, but \
            you can\&#39;t tell if it\&#39;s out of pity.&quot;)&gt;&gt;
        &lt;&lt;set _response = _char.dialogue(&quot;Good one.&quot;) +
            &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + &quot;Affection &quot; + setup.show_change_html(0, 1) +
            &quot;, Trust &quot; + setup.show_change_html(0, 1)
        &gt;&gt;
        &lt;&lt;set _char.slave_traits.obedience += 1&gt;&gt;
        &lt;&lt;set _char.slave_traits.trust += 1&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;if _char.mental_conditions.sadness gt 0&gt;&gt;
        &lt;&lt;set _response += &quot;Sadness &quot; + setup.show_change_html(0, -3, false)&gt;&gt;
        &lt;&lt;set _char.mental_conditions.sadness -= 3&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;set _response += &quot;).&quot;&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;set _success = false&gt;&gt;
    &lt;&lt;set _responses = [setup.fail(&quot;tact&quot;, false)]&gt;&gt;
    &lt;&lt;set _responses = _responses.concat( setup.influence.joke.fail.random())&gt;&gt;
    &lt;&lt;set _response = setup.titleCase(_char.first_name) + &quot; looks at you with an \
        unimpressed stare, but luckily it looks like your failed attempt has not \
        lowered her opinion of you.&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Check if was skillful roll */
&lt;&lt;if Math.abs(_max_roll - _thresh) lte 1 &amp;&amp; (_max_roll - _roll) lte 1&gt;&gt;
    &lt;&lt;set _probability = setup.sigmoid(-1 * $difficulty)&gt;&gt;
    &lt;&lt;set _sub_roll = Math.random()&gt;&gt;
    &lt;&lt;if _roll lt _probability&gt;&gt;
        &lt;&lt;set _response += &quot;&lt;br&gt;&lt;br&gt;&quot;&gt;&gt;
        &lt;&lt;if _success&gt;&gt;
            &lt;&lt;set _response += &quot;You can tell that joke barely passed, but luckily your \
                skill in speechcraft let you prevail. &lt;span style=\&#39;text: green\&#39;&gt;\
                Your tact increased by 1!&lt;/span&gt;&quot;&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _response += &quot;You can tell that joke almost landed, you\&#39;ll have to \
                work harder next time. &lt;span style=\&#39;text: green\&#39;&gt;\
                Your tact increased by 1!&lt;/span&gt;&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set $player.stats.tact += 1&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;unset _probability&gt;&gt;
    &lt;&lt;unset _sub_roll&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;set _responses.push(_response)&gt;&gt;

&lt;&lt;set _to_round = $selected&gt;&gt;
&lt;&lt;include round&gt;&gt;

&lt;&lt;if def _options&gt;&gt;
    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;script&gt;&gt;
    setup.mainLog_append_delayed(State.temporary.responses, 
        State.variables.buttons, 
        State.variables.buttons_extra);
&lt;&lt;/script&gt;&gt;

&lt;&lt;unset _response&gt;&gt;
&lt;&lt;unset _responses&gt;&gt;
&lt;&lt;unset _to_round&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="9" name="molestActions" tags="" position="1100,100" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;molest_actions&quot; class=&quot;action container row col longbutton fiveQuarters smalltext hidden&quot;
         style=&quot;--rows: 4; --cols: 4&quot;&gt;

        @@#molest1;&lt;&lt;button &quot;Remove blanket&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 1&gt;&gt;
                &lt;&lt;if !_is_molesting&gt;&gt;
                    &lt;&lt;set _is_molesting = true&gt;&gt;
                    &lt;&lt;set _char.limits.molest -= 1&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;if _molest_state.blanket&gt;&gt;
                    &lt;&lt;set _molest_state.blanket = false&gt;&gt;
                    &lt;&lt;run $(&quot;#molest1 button&quot;).html(&quot;Put on blanket&quot;)&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _molest_state.blanket = true&gt;&gt;
                    &lt;&lt;run $(&quot;#molest1 button&quot;).html(&quot;Remove blanket&quot;)&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _molest_state_changed = true&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;disable&gt;&gt;
        @@#molest2;&lt;&lt;button &quot;Remove top&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 2&gt;&gt;
                &lt;&lt;if _molest_state.top&gt;&gt;
                    &lt;&lt;set _molest_state.top = false&gt;&gt;
                    &lt;&lt;run $(&quot;#molest2 button&quot;).html(&quot;Put on top&quot;)&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _molest_state.top = true&gt;&gt;
                    &lt;&lt;run $(&quot;#molest2 button&quot;).html(&quot;Remove top&quot;)&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _molest_state_changed = true&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest3;&lt;&lt;button &quot;Remove bottom&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 3&gt;&gt;
                &lt;&lt;if _molest_state.bottom&gt;&gt;
                    &lt;&lt;set _molest_state.bottom = false&gt;&gt;
                    &lt;&lt;run $(&quot;#molest3 button&quot;).html(&quot;Put on bottom&quot;)&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _molest_state.bottom = true&gt;&gt;
                    &lt;&lt;run $(&quot;#molest3 button&quot;).html(&quot;Remove bottom&quot;)&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _molest_state_changed = true&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest4;&lt;&lt;button &quot;Fondle boobs&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 4&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest5;&lt;&lt;button &quot;Finger pussy&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 5&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest6;&lt;&lt;button &quot;Finger ass&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 6&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest7;&lt;&lt;button &quot;Lick pussy&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 7&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest8;&lt;&lt;button &quot;Jack off&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 8&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest9;&lt;&lt;button &quot;Footjob&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 9&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest10;&lt;&lt;button &quot;Blowjob&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 10&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest11;&lt;&lt;button &quot;Fuck pussy&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 11&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;Not enough stamina!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest12;&lt;&lt;button &quot;Fuck ass&quot;&gt;&gt;
            &lt;&lt;if $player.conditions.stamina gt 10&gt;&gt;
                &lt;&lt;set _molest_action = 12&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;

        &lt;&lt;set $molest_buttons = [&quot;#molest_back&quot;, &quot;#molest_leave&quot;]&gt;&gt;
        &lt;&lt;for _i = 1; _i lte 12; _i++&gt;&gt;
            &lt;&lt;set $molest_buttons.push(&quot;#molest&quot; + _i)&gt;&gt;
        &lt;&lt;/for&gt;&gt;

        &lt;div&gt;&lt;/div&gt;
        @@#molest_back;&lt;&lt;button &quot;Back&quot; `passage()`&gt;&gt;
            &lt;&lt;set $enable_menu = true&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@

        &lt;&lt;disable&gt;&gt;
        @@#molest_done;&lt;&lt;button &quot;Done&quot; `passage()`&gt;&gt;
            /* Increase suspicion based on how you left them */
            &lt;&lt;set $_temp_to_log = &quot;You quietly slip out of &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s room.&lt;br&gt;&quot;&gt;&gt;
            &lt;&lt;if !_molest_state.aware&gt;&gt;
                &lt;&lt;if !_molest_state.top || !_molest_state.bottom&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;Because you left &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s clothes \
                        off, &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot;\&#39;ll be much more suspicious and concerned \
                        in the morning (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                        setup.show_change_html(0, 30, false) + &quot;).&lt;br&gt;&quot;
                    &gt;&gt;
                    &lt;&lt;set _char.mental_conditions.suspicion += 30&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _molest_state.cum != &quot;none&quot;&gt;&gt;
                &lt;&lt;if _molest_state.cum == &quot;hair&quot; || 
                     _molest_state.cum == &quot;face&quot; || 
                     _molest_state.cum == &quot;lips&quot; || 
                     _molest_state.cum == &quot;in_mouth&quot;&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;Despite leaving evidence behind, with your cum close to &quot; + 
                        setup.titleCase(_char.first_name) + &quot;\&#39;s nose, &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                        &quot; unconsciously grows more fond of your cum (&quot; + setup.titleCase(_char.first_name) + 
                        &quot;\&#39;s Affection &quot; + setup.show_change_html(0, 1) + &quot;, Cum Fetish &quot; + 
                        setup.show_change_html(0, 1)
                    &gt;&gt;
                    &lt;&lt;if !_molest_state.aware&gt;&gt;
                        &lt;&lt;set $_temp_to_log += &quot;, Suspicion &quot; + setup.show_change_html(0, 10, false)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.suspicion += 10&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;).&lt;br&gt;&quot;&gt;&gt;
                    &lt;&lt;set _char.slave_traits.obedience += 1&gt;&gt;
                    &lt;&lt;set _char.sex_fetishes.cum += 1&gt;&gt;
                &lt;&lt;elseif !_molest_state.aware&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;While your cum shouldn\&#39;t leave much of a trace by the morning &quot; + 
                        setup.titleCase(_char.first_name) + &quot; will still notice something is off (&quot; + 
                        setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                        setup.show_change_html(0, 5, false) + &quot;).&lt;br&gt;&quot;
                    &gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            /* Stop molesting */
            &lt;&lt;set _is_molesting = false&gt;&gt;
            /* Re-enable menu */
            &lt;&lt;set $enable_menu = true&gt;&gt;
            /* Last round for good measure */
            &lt;&lt;set _to_round = _char.key&gt;&gt;
            &lt;&lt;include round&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
    &lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="10" name="molestCumActions" tags="" position="1225,100" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;molest_cum_actions&quot; class=&quot;action container row col longbutton fiveQuarters smalltext hidden&quot;
         style=&quot;--rows: 4; --cols: 4&quot;&gt;

        @@#molest_cum1;&lt;&lt;button &quot;In own pants&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You quickly tuck your cock back and cum into your pants.&quot;
            ]&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#molest_cum2;&lt;&lt;button &quot;In own hand&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You quickly put your hand in front of your cock and catch your cum.&quot;
            ]&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#molest_cum3;&lt;&lt;button &quot;On ground&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You make sure to aim away from &quot; + setup.titleCase(_char.first_name) + &quot; and \
                cum directly onto the ground.&quot;
            ]&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#molest_cum4;&lt;&lt;button &quot;On blanket&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You make sure to aim away from &quot; + setup.titleCase(_char.first_name) + &quot; and \
                cum directly onto the blanket on the ground.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;blanket&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#molest_cum5;&lt;&lt;button &quot;On bottom&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You aim your cum towards &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s bottoms \
                and cum directly onto them.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;bottom&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#molest_cum6;&lt;&lt;button &quot;In hair&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You wrap your cock around &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; +
                _char.physical_traits.hair_color + &quot; hair and cum into it.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;hair&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#molest_cum7;&lt;&lt;button &quot;On face&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You stroke your cock near &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face, \
                unloading your cum onto &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; &quot; + 
                _char.physical_traits.skin_color + &quot; &quot; + 
                _char.physical_traits.ethnicity + &quot; face.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;face&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;disable&gt;&gt;
        @@#molest_cum8;&lt;&lt;button &quot;On chest&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You aim your cock at &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s chest, \
                unloading your cum onto &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; &quot; + 
                _char.physical_traits.skin_color + &quot; chest.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;boobs&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest_cum9;&lt;&lt;button &quot;On pussy&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You aim your cock at &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s pussy, \
                unloading your cum onto &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;pussy&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest_cum10;&lt;&lt;button &quot;In mouth&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You continue thrusting your cock deeper into &quot; + setup.titleCase(_char.first_name) +
                &quot;\&#39;s throat, eventually cumming into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;in_mouth&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest_cum11;&lt;&lt;button &quot;In pussy&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You continue fucking &quot; + setup.titleCase(_char.first_name) +
                &quot;\&#39;s vagina, eventually cumming into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] +
                &quot; pussy.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;in_pussy&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#molest_cum12;&lt;&lt;button &quot;In ass&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You continue fucking &quot; + setup.titleCase(_char.first_name) +
                &quot;\&#39;s ass, eventually cumming into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] +
                &quot; anus.&quot;
            ]&gt;&gt;
            &lt;&lt;set _molest_state.cum = &quot;in_ass&quot;&gt;&gt;
            &lt;&lt;run _button_func()&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;

    &lt;/div&gt;

&lt;&lt;silently&gt;&gt;&lt;&lt;script&gt;&gt;
    State.temporary.button_func = () =&gt; {
        let player = State.variables.player;
        let _t = State.temporary;
        player.mental_conditions.arousal = 0;
        player.conditions.stamina = (player.conditions.stamina - 20).clamp(0, 100);
        _t.molest_state.came = true;
        _t.is_cumming = false;
        _t.print_cum_prompt = false;
        _t.molest_state_changed = true;
        setup.mainLog_append_delayed(State.temporary.responses);
        delete _t.responses;
        $(&quot;#molest_actions&quot;).removeClass(&quot;hidden&quot;);
        $(&quot;#molest_cum_actions&quot;).addClass(&quot;hidden&quot;);
    };
&lt;&lt;/script&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="11" name="molestInfo" tags="" position="100,225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;molest_info&quot; class=&quot;subbackground hidden&quot; style=&quot;grid-row: 1 / span 3; grid-column: 4 / span 1&quot;&gt;
    &lt;div class=&quot;container threeRow&quot; style=&quot;font-weight: normal; height: 100%; width: 100%&quot;&gt;
        &lt;center&gt;
            &lt;h3 style=&quot;margin-bottom:0&quot;&gt;&lt;&lt;= setup.locations.get(passage()).name&gt;&gt;&lt;/h3&gt;
            &lt;p style=&quot;margin: 0&quot;&gt;
                &lt;&lt;= setup.locations.get_sub_address(passage())&gt;&gt;
            &lt;/p&gt;
            &lt;br&gt;
            &lt;div id=&quot;molest_datetime&quot;&gt;
                &lt;&lt;time12hr&gt;&gt;
                &lt;br&gt;
                &lt;&lt;date&gt;&gt;
            &lt;/div&gt;
        &lt;/center&gt;

        &lt;center style=&quot;padding: 20px&quot;&gt;
            &lt;strong id=&quot;molest_info_name&quot;&gt;&lt;/strong&gt;
            &lt;div id=&quot;molest_bars&quot;&gt;&lt;/div&gt;
            &lt;strong&gt;&lt;&lt;= setup.titleCase($player.first_name)&gt;&gt;&lt;/strong&gt;
            &lt;div id=&quot;molest_player_bars&quot;&gt;
                &lt;&lt;showmeter &quot;player_arousal_bar&quot; `$player.mental_conditions.arousal/50`&gt;&gt;
                &lt;&lt;showmeter &quot;player_dexterity_bar&quot; `$player.stats.dexterity/100`&gt;&gt;
            &lt;/div&gt;
        &lt;/center&gt;

        &lt;center&gt;
            &#39;&#39;Time passed&#39;&#39;: &lt;span id=&quot;molest_time&quot;&gt;&lt;/span&gt; minutes
        &lt;/center&gt;

    &lt;/div&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="12" name="molestEngine" tags="" position="225,225" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Cock for male, strap-on for female */
&lt;&lt;set _cock = &quot;cock&quot;&gt;&gt;
&lt;&lt;if $player.gender == 1&gt;&gt;
    &lt;&lt;set _cock = &quot;strap-on&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* For ease of access */
&lt;&lt;set _char = $characters[$selected]&gt;&gt;
&lt;&lt;set _higher_status = ($player.get_status(&quot;nipon&quot;) == &quot;slave&quot; &amp;&amp; _char.status == &quot;low_slave&quot;) ||
    ($player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot; &amp;&amp; _char.status == &quot;slave&quot;) || 
    ($player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot; &amp;&amp; _char.status == &quot;low_slave&quot;)&gt;&gt;

/* Preround for bars */
&lt;&lt;set _to_round = _char.key&gt;&gt;
&lt;&lt;include round&gt;&gt;

&lt;&lt;set _molest_state = {
    &quot;blanket&quot;: true,
    &quot;top&quot;: true,
    &quot;bottom&quot;: true,
    &quot;cum&quot;: &quot;none&quot;,
    &quot;came&quot;: false,
    &quot;aware&quot;: false,
    &quot;awake&quot;: false
}&gt;&gt;

/* Disable menu */
&lt;&lt;set $enable_menu = false&gt;&gt;

/* Time molesting */
&lt;&lt;set _molest_time = 0&gt;&gt;

/* Add target to simulation queue */
&lt;&lt;set $to_simulate.add(_char.key)&gt;&gt;

/* Molesting doesn&#39;t start till we act */
&lt;&lt;set _is_molesting = false&gt;&gt;

/* Pre-cache all images for fast rendering */
&lt;&lt;script&gt;&gt;
    var char = State.temporary.char;
    const preload = [
        &quot;&quot;,
        &quot;_noblanket&quot;,
        &quot;_noblanket_nobottom&quot;,
        &quot;_noblanket_nobottom_notop&quot;,
        &quot;_noblanket_notop&quot;
    ];
    window._ImageCache = preload.map(function (url) {
		var image = document.createElement(&#39;img&#39;);
		image.src = char.image_folder() + &quot;sleeping/&quot; + 
            char.first_name.toLowerCase() + &quot;_sleeping&quot; + url + &quot;.png&quot;;
		return image;
	});
&lt;&lt;/script&gt;&gt;

&lt;&lt;script&gt;&gt;
    var player = State.variables.player;
    var char = State.temporary.char;
    $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
        &quot;url(\&quot;&quot; + char.image_folder() + &quot;sleeping/&quot; + char.first_name.toLowerCase()
        + &quot;_sleeping.png\&quot;)&quot;
    );

    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
    var html = &quot;You approach &quot; + setup.titleCase(char.first_name) + &quot;\&#39;s bed, what do you do?&quot;;
    div.html(html);
    setup.mainLog_append(div);
&lt;&lt;/script&gt;&gt;

/* Show molest ui and atune to character */
&lt;&lt;removeclass &quot;#molest_actions&quot; &quot;hidden&quot;&gt;&gt;
&lt;&lt;run $(&quot;#molest_info_name&quot;).html(setup.titleCase(_char.first_name))&gt;&gt;
&lt;&lt;run $(&quot;#molest_bars&quot;).wiki(&quot;\
    &lt;&lt;showmeter \&quot;char_arousal_bar\&quot; `_char.mental_conditions.arousal/50`&gt;&gt;\
    &lt;&lt;showmeter \&quot;char_suspicion_bar\&quot; `_char.mental_conditions.suspicion/50`&gt;&gt;\
&quot;)&gt;&gt;
&lt;&lt;run $(&quot;#molest_player_bars&quot;).wiki(&quot;\
    &lt;&lt;showmeter \&quot;player_stamina_bar\&quot; `$player.conditions.stamina/$player.conditions.max_stamina`&gt;&gt;\
&quot;)&gt;&gt;
&lt;&lt;run $(&quot;#molest_time&quot;).html(_molest_time)&gt;&gt;
&lt;&lt;removeclass &quot;#molest_info&quot; &quot;hidden&quot;&gt;&gt;

/* Change button text depending on character of molest target */
&lt;&lt;script&gt;&gt;
    let char = State.temporary.char;
    if (char.gender == 0) {
        $(&quot;#molest4 button&quot;).html(&quot;Caress chest&quot;);
        $(&quot;#molest5 button&quot;).html(&quot;Stroke cock&quot;);
        $(&quot;#molest7 button&quot;).html(&quot;Suck cock&quot;);
        $(&quot;#molest11 button&quot;).html(&quot;Ride cock&quot;);
    }
&lt;&lt;/script&gt;&gt;

/* Allow back and leave buttons */
&lt;&lt;removeclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
&lt;&lt;removeclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;

/* 
Psuedoevent listener for changing molest_state for button enabling / disabling as well
as changing the images based on the state
 */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;
    &lt;&lt;if _molest_state_changed !== undefined &amp;&amp; _molest_state_changed&gt;&gt;
        &lt;&lt;if _is_molesting&gt;&gt;
            &lt;&lt;addclass &quot;#molest_back button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#molest_back button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;removeclass &quot;#molest_done button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#molest_done button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;if _molest_state.blanket&gt;&gt;
            /* Not able to do anything with blanket on */
            &lt;&lt;for _i = 2; _i lte 12; _i++&gt;&gt;
                &lt;&lt;addclass `&quot;#molest&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;/for&gt;&gt;
        &lt;&lt;else&gt;&gt;
            /* Enable top and bottom modification */
            &lt;&lt;removeclass &quot;#molest2 button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#molest2 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#molest3 button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#molest3 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;if (!_molest_state.came &amp;&amp; $player.gender == 0) ||
                 (!_molest_state.came &amp;&amp; $player.gender == 1 &amp;&amp; $player.has_equipped(&quot;strap_on&quot;) != &quot;none&quot;)&gt;&gt;
                /* Enalble feet, mouth and self*/
                &lt;&lt;removeclass &quot;#molest8 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest8 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;removeclass &quot;#molest9 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest9 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;removeclass &quot;#molest10 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest10 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;addclass &quot;#molest8 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest8 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#molest9 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest9 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#molest10 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest10 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _molest_state.top&gt;&gt;
                /* Disable all upper actions */
                &lt;&lt;addclass &quot;#molest4 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest4 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;removeclass &quot;#molest4 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest4 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _molest_state.bottom&gt;&gt;
                /* Disable all lower actions */
                &lt;&lt;addclass &quot;#molest5 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest5 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#molest6 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest6 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#molest7 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest7 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#molest11 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest11 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#molest12 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest12 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;removeclass &quot;#molest5 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest5 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;removeclass &quot;#molest6 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest6 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;removeclass &quot;#molest7 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest7 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;if !_molest_state.came &amp;&amp; $player.gender == 0&gt;&gt;
                    &lt;&lt;removeclass &quot;#molest11 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#molest11 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#molest12 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#molest12 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;elseif !_molest_state.came &amp;&amp; $player.gender == 1&gt;&gt;
                    &lt;&lt;removeclass &quot;#molest11 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#molest11 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;if $player.has_equipped(&quot;strap_on&quot;) != &quot;none&quot;&gt;&gt;
                        &lt;&lt;removeclass &quot;#molest12 button&quot; &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#molest12 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;addclass &quot;#molest11 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#molest11 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#molest12 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#molest12 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
            &quot;url(\&quot;&quot; + _char.image_folder() + &quot;sleeping/&quot; + _char.first_name.toLowerCase()
            + &quot;_sleeping&quot; + setup.molest_state_to_string(_molest_state) + &quot;.png\&quot;)&quot;
        )&gt;&gt;
        &lt;&lt;unset _molest_state_changed&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;


/* Global multiplier for suspicion */
&lt;&lt;set _sus_mult = 1&gt;&gt;
&lt;&lt;if $player.titles.has(&quot;night_fox&quot;)&gt;&gt;
    &lt;&lt;set _sus_mult *= 0.8&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Scale by difficulty */
&lt;&lt;set _sus_mult *= (1 + 0.1 * $difficulty)&gt;&gt;
&lt;&lt;set _sus_fail = setup.round2(10 * _sus_mult)&gt;&gt;

/* Multipliers for arousal increase of char based on player skills */
&lt;&lt;set _anal_mult_base = 1 + ($player.sex_skills.anal - 50) / 100&gt;&gt;
&lt;&lt;set _oral_mult_base = 1 + ($player.sex_skills.oral - 50) / 100&gt;&gt;
&lt;&lt;set _vaginal_mult_base = 1 + ($player.sex_skills.vaginal - 50) / 100&gt;&gt;
&lt;&lt;set _other_mult_base = 1 + ($player.sex_skills.other - 50) / 100&gt;&gt;

/* Multipliers for arousal increase of char based on preference */
&lt;&lt;set _anal_mult_base *= 1 + (_char.sex_prefs.anal) / 75&gt;&gt;
&lt;&lt;set _oral_mult_base *= 1 + (_char.sex_prefs.oral) / 75&gt;&gt;
&lt;&lt;set _vaginal_mult_base *= 1 + (_char.sex_prefs.vaginal) / 75&gt;&gt;

/* Psuedoevent listener for _molest_action to update suspicion and arousal */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;
    &lt;&lt;if _molest_action !== undefined&gt;&gt;
        /* Record the last action for cumEngine */
        &lt;&lt;set _last_molest_action = _molest_action&gt;&gt;
        &lt;&lt;set _roll = $player.stats.dexterity + dice(1, 6 + $difficulty) - $difficulty&gt;&gt;
        /* Bypass dislikes if aroused enough */
        &lt;&lt;if _char.mental_conditions.arousal gte 20&gt;&gt;
            &lt;&lt;set _anal_mult = Math.max(1, _anal_mult_base)&gt;&gt;
            &lt;&lt;set _oral_mult = Math.max(1, _oral_mult_base)&gt;&gt;
            &lt;&lt;set _vaginal_mult = Math.max(1, _vaginal_mult_base)&gt;&gt;
            &lt;&lt;set _other_mult = Math.max(1, _other_mult_base)&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _anal_mult = _anal_mult_base&gt;&gt;
            &lt;&lt;set _oral_mult = _oral_mult_base&gt;&gt;
            &lt;&lt;set _vaginal_mult = _vaginal_mult_base&gt;&gt;
            &lt;&lt;set _other_mult = _other_mult_base&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;switch _molest_action&gt;&gt;
        &lt;&lt;case 1&gt;&gt;
            &lt;&lt;if _roll gt 15 || _molest_state.aware&gt;&gt;
                &lt;&lt;if !_molest_state.blanket&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s blanket.&quot;
                    ]&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully put back &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s blanket.&quot;
                    ]&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;if !_molest_state.blanket&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s blanket, \
                        but fumble a bit in doing so (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                        setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;
                    ]&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully put back &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s blanket, \
                        but fumble a bit in doing so (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                        setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;
                    ]&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;case 2&gt;&gt;
            &lt;&lt;if _roll gt 20 || _molest_state.aware&gt;&gt;
                &lt;&lt;if !_molest_state.top&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s top revealing &quot; +
                        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; bare chest.&quot;
                    ]&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully put back &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s top.&quot;
                    ]&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;if !_molest_state.top&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s top, \
                        but fumble a bit in doing so (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                        setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;
                    ]&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully put &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s top, \
                        but fumble a bit in doing so (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                        setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;
                    ]&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;case 3&gt;&gt;
            &lt;&lt;if _roll gt 20 || _molest_state.aware&gt;&gt;
                &lt;&lt;if !_molest_state.bottom&gt;&gt;
                    &lt;&lt;set _response = &quot;\
                        You carefully remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s bottoms revealing &quot; +
                        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; bare \
                    &quot;&gt;&gt;
                    &lt;&lt;if _char.gender == 0&gt;&gt;
                        &lt;&lt;set _response += &quot;cock.&quot;&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _response += &quot;pussy.&quot;&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;if _char.mental_conditions.arousal gte 10&gt;&gt;
                        &lt;&lt;set _response += &quot; You can tell from &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                            &quot; arousal that it\&#39;s already glistening with wetness.&quot;&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _responses = [_response]&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully put back &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s bottoms.&quot;
                    ]&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;if !_molest_state.bottom&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s bottoms, \
                        but fumble a bit in doing so (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                        setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;
                    ]&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You carefully put back &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s bottoms, \
                        but fumble a bit in doing so (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                        setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;
                    ]&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;case 4&gt;&gt;
            &lt;&lt;set _response = &quot;\
                You gently caress &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s chest and you feel &quot; +
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; nipples harden between your fingers&quot;&gt;&gt;
            &lt;&lt;if _roll gt 25 || _molest_state.aware&gt;&gt;   
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;, but you accidentally press a little too hard, stiring &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + 
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;
                &gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 4 * _other_mult&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;case 5&gt;&gt;
            &lt;&lt;if _char.gender == 1&gt;&gt;
                &lt;&lt;set _response = &quot;\
                    You carefully insert your fingers into &quot; + setup.titleCase(_char.first_name) + 
                    &quot;\&#39;s pussy. Your fingers become slick with her juices&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response = &quot;\
                    You carefully start stroking &quot; + setup.titleCase(_char.first_name) + 
                    &quot;\&#39;s cock. Your hand become slick with his precum&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _roll gt 30 || _molest_state.aware&gt;&gt;
                &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;, but you accidentally thrust a bit too hard, making &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; moan&quot; + 
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 7 * _other_mult&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;case 6&gt;&gt;
            &lt;&lt;set _response = &quot;\
                You ease your fingers into &quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s ass. As you move them in and out, you smell a rich aroma of &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;]+ &quot; juices and anus&quot;&gt;&gt;
            &lt;&lt;if _roll gt 40 || _molest_state.aware&gt;&gt;
                &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;, but you accidentally thrust a bit too hard, making &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; moan&quot; + 
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 7 * _other_mult&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;case 7&gt;&gt;
            &lt;&lt;if _char.gender == 1&gt;&gt;
                &lt;&lt;set _response = &quot;\
                    You lower your head in between &quot; + setup.titleCase(_char.first_name) + 
                    &quot;\&#39;s legs and start licking her pussy. You can taste her juices as they slowly \
                    leak into your mouth&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response = &quot;\
                    You lower your head in between &quot; + setup.titleCase(_char.first_name) + 
                    &quot;\&#39;s legs and start sucking his cock. You can taste his precum as they slowly \
                    leak into your mouth&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _roll gt 40 || _molest_state.aware&gt;&gt;
                &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;, but while you were using your mouth to please &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;, your teeth scratched &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; causing &quot; +
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; to moan&quot; + 
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 10 * _vaginal_mult&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;case 8&gt;&gt;
            &lt;&lt;set _response = &quot;\
                You touch yourself while imagining all the things you could do to poor &quot; +
                setup.titleCase(_char.first_name) + &quot; who\&#39;s helplessly unaware of what\&#39;s happening&quot;&gt;&gt;
            &lt;&lt;if _roll gt 15 || _molest_state.aware&gt;&gt;
                &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;, but in your ferver you make too much noise &quot; + 
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 7&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;case 9&gt;&gt;
            &lt;&lt;set _response = &quot;\
                You grab &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s soft &quot; + _char.physical_traits.skin_color + 
                &quot; feet and start stroking your &quot; + _cock + &quot; with it. You push your head gently between &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; toes \
                while licking &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; other foot&quot;&gt;&gt;
            &lt;&lt;if _roll gt 25 || _molest_state.aware&gt;&gt;
                &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;. You accidentally bite too hard on &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; foot &quot; +
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(_sus_fail), false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _foot_mult = 1 + (_char.sex_fetishes.feet / 50)&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 3 * _foot_mult * _other_mult&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;case 10&gt;&gt;
            &lt;&lt;set _response = &quot;\
                You grab &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s head and slow insert your \
                &quot; + _cock + &quot; into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth. You can feel &quot; +
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; warm touch wrap around your member. You \
                carefully slide in and out of &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; throat&quot;&gt;&gt;
            &lt;&lt;if _roll gt 50 || _molest_state.aware&gt;&gt;
                &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;, but you accidentally thrust a bit too hard, making &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; choke a little&quot; + 
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(1.2 * _sus_fail), false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += 1.2 * _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 5 * _oral_mult&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 13&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;case 11&gt;&gt;
            &lt;&lt;if _char.gender == 1&gt;&gt;
                &lt;&lt;set _response = &quot;\
                    You spread &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s legs and slowly insert your \
                    &quot; + _cock + &quot; into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; pussy. You can feel the warm \
                    insides of her vagina wrap around your penis, guiding it with its juices. The air is \
                    surrounded by a lewd smell of mixed bodily fluids&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response = &quot;\
                    You slowly get onto of&quot; + setup.titleCase(_char.first_name) + &quot; and slowly insert his \
                    cock into your ass. You can feel the inside of your anus wrapping around his penis, \
                    guiding it with its juices. The air is surrounded by a lewd smell of mixed bodily fluids&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _roll gt 60 || _molest_state.aware&gt;&gt;
                &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;, but you accidentally thrust a bit too hard, making &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; moan&quot; + 
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(1.5 * _sus_fail), false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += 1.5 * _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 12 * _vaginal_mult&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 15&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;case 12&gt;&gt;
            &lt;&lt;set _response = &quot;\
                You spread &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s ass cheecks and slowly insert your \
                &quot; + _cock + &quot; into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tight ass. &quot; + 
                setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?his&quot;]) + &quot; anus lets out some air, filling the \
                room with a perverted aroma of bodily fluids and sweat&quot;&gt;&gt;
            &lt;&lt;if _roll gt 70&gt;&gt;
                &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _response += &quot;. You accidentally thrust a bit too hard, making &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; moan&quot; + 
                    &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
                    setup.show_change_html(0, setup.round2(2 * _sus_fail), false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.suspicion += 2 * _sus_fail&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 12 * _anal_mult&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 20&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
        &lt;&lt;/switch&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;unset _molest_action&gt;&gt;
        &lt;&lt;set _mins = 1 + dice(1, 4)&gt;&gt;
        &lt;&lt;addmins _mins&gt;&gt;
        &lt;&lt;set _molest_time += _mins&gt;&gt;
        &lt;&lt;run $(&quot;#molest_time&quot;).html(_molest_time)&gt;&gt;
        &lt;&lt;set _to_round = _char.key&gt;&gt;
        &lt;&lt;include round&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;set _is_cumming = false&gt;&gt;
&lt;&lt;set _print_cum_prompt = false&gt;&gt;
/* Psuedoevent listener for arousal and suspicion thresholds */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;
    &lt;&lt;if $player.mental_conditions.arousal gte 50 &amp;&amp; !_is_cumming&gt;&gt;
        &lt;&lt;set _is_cumming = true&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;if _char.mental_conditions.suspicion gte 50 &amp;&amp; !_molest_state.aware &amp;&amp; !_is_cumming&gt;&gt;
        &lt;&lt;set _disposition = _char.get_disposition()&gt;&gt;
        &lt;&lt;switch _disposition&gt;&gt;
        &lt;&lt;case &quot;submissive&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                setup.titleCase(_char.first_name) + &quot; notices that you are molesting &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; but is submissive enough to pretend &quot; + 
                &quot;they are still sleeping (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + 
                setup.show_change_html(0, 10) + &quot;).&quot;
            ]&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;set _char.mental_conditions.suspicion = 0&gt;&gt;
        &lt;&lt;case &quot;devoted&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                setup.titleCase(_char.first_name) + &quot; notices that you are molesting &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; but is devoted enough to pretend &quot; + 
                &quot;they are still sleeping (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + 
                setup.show_change_html(0, 10) + &quot;).&quot;
            ]&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;set _char.mental_conditions.suspicion = 0&gt;&gt;
        &lt;&lt;case &quot;scared&quot;&gt;&gt;
            &lt;&lt;set _responses = [
                setup.titleCase(_char.first_name) + &quot; notices that you are molesting &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; but is scared enough to pretend &quot; + 
                &quot;they are still sleeping (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + 
                setup.show_change_html(0, -5, false) + &quot;).&quot;
            ]&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;set _char.mental_conditions.suspicion = 100&gt;&gt;
        &lt;&lt;default&gt;&gt;
            &lt;&lt;set _molest_state.awake = true&gt;&gt;
            &lt;&lt;set _molest_state_changed = true&gt;&gt;
            &lt;&lt;set _responses = [
                setup.titleCase(_char.first_name) + &quot; wakes up to you molesting &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;,&quot;,
                _char.dialogue(&quot;What the FUCK are you doing?!!&quot;),
                &quot;Caught red-handed, you are a deer in the headlights, what do you do?\
                &lt;ol&gt;\
                    &lt;li&gt;Apologize.&lt;/li&gt;\
                    &lt;li&gt;Quickly dash out of the room.&lt;/li&gt;\
                    &lt;li&gt;Force &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; down and rape &quot; + 
                        setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;.&lt;/li&gt;\
                &lt;/ol&gt;&quot;
            ]&gt;&gt;
            /* Trigger event engine */
            &lt;&lt;removeclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#molest_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 3&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
            &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses, 
                State.variables.buttons);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;set _char.mental_conditions.suspicion = 100&gt;&gt;
            /* Psuedoevent listener for _action */
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;
                &lt;&lt;if def _action&gt;&gt;
                    &lt;&lt;switch _action&gt;&gt;
                    &lt;&lt;case 1&gt;&gt;
                        &lt;&lt;unset _action&gt;&gt;
                        /* Roll for tact */
                        &lt;&lt;set _roll = $player.get_status_prop(&quot;tact&quot;) + 2 * (dice(1, 6 + $difficulty) - $difficulty)&gt;&gt;
                        &lt;&lt;if _roll gte 50&gt;&gt;
                            &lt;&lt;set $_temp_to_log = 
                                setup.pass(&quot;tact&quot;) + 
                                $player.dialogue(&quot;I\&#39;m so sorry, you are just so beautiful I couldn\&#39;t help it. I \
                                    promise this will never happen again!&quot;) + 
                                &quot;While &quot; + setup.titleCase(_char.first_name) + &quot; is still very upset, you can tell \
                                you\&#39;ve smoothed things over somewhat. You quickly leave the room \
                                (&quot; + setup.titleCase(_char.first_name) + 
                                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -5) + 
                                &quot;, Anger &quot; + setup.show_change_html(0, 10, false) + 
                                &quot;, Trust &quot; + setup.show_change_html(0, -5) + &quot;).&quot;
                            &gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                            /* Do not induce fear */
                            &lt;&lt;if _char.slave_traits.trust gt 0&gt;&gt;
                                &lt;&lt;set _char.slave_traits.trust = Math.clamp(_char.slave_traits.trust - 5, 0, 100)&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set $_temp_to_log = 
                                setup.fail(&quot;tact&quot;) + 
                                $player.dialogue(&quot;I\&#39;m so sorry, you are just... so hot, I couldn\&#39;t help it. I \
                                    promise this will never happen again!&quot;) + 
                                setup.titleCase(_char.first_name) + &quot; is very upset and you can tell \
                                you\&#39;ve only made things worse with your bad apology. You quickly leave the room \
                                (&quot; + setup.titleCase(_char.first_name) + 
                                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -15) + 
                                &quot;, Anger &quot; + setup.show_change_html(0, 20, false) + 
                                &quot;, Trust &quot; + setup.show_change_html(0, -15) + &quot;).&quot;
                            &gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                            /* Do not induce fear */
                            &lt;&lt;if _char.slave_traits.trust gt 0&gt;&gt;
                                &lt;&lt;set _char.slave_traits.trust = Math.clamp(_char.slave_traits.trust - 15, 0, 100)&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        /* Stop molesting */
                        &lt;&lt;set _is_molesting = false&gt;&gt;
                        /* Re-enable menu */
                        &lt;&lt;set $enable_menu = true&gt;&gt;
                        /* Last round for good measure */
                        &lt;&lt;set _to_round = _char.key&gt;&gt;
                        &lt;&lt;include round&gt;&gt;
                        &lt;&lt;goto `passage()`&gt;&gt;
                    &lt;&lt;case 2&gt;&gt;
                        &lt;&lt;unset _action&gt;&gt;
                        &lt;&lt;set $_temp_to_log = 
                            &quot;You quickly dash out of the room, leaving sleepy &quot; + 
                            setup.titleCase(_char.first_name) + &quot; to question what really just happened \
                            (&quot; + setup.titleCase(_char.first_name) + 
                            &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -10) + 
                            &quot;, Anger &quot; + setup.show_change_html(0, 15, false) + 
                            &quot;, Trust &quot; + setup.show_change_html(0, -10) + &quot;).&quot;
                        &gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                        /* Do not induce fear */
                        &lt;&lt;if _char.slave_traits.trust gt 0&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust = Math.clamp(_char.slave_traits.trust - 10, 0, 100)&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 25&gt;&gt;
                        /* Stop molesting */
                        &lt;&lt;set _is_molesting = false&gt;&gt;
                        /* Re-enable menu */
                        &lt;&lt;set $enable_menu = true&gt;&gt;
                        /* Last round for good measure */
                        &lt;&lt;set _to_round = _char.key&gt;&gt;
                        &lt;&lt;include round&gt;&gt;
                        &lt;&lt;goto `passage()`&gt;&gt;
                    &lt;&lt;case 3&gt;&gt;
                        &lt;&lt;unset _action&gt;&gt;
                        &lt;&lt;set _roll = $player.stats.strength + dice(1, 6 + $difficulty) - $difficulty&gt;&gt;
                        &lt;&lt;if _roll - _char.stats.strength gte 15&gt;&gt;
                            &lt;&lt;set _responses = [
                                setup.pass(&quot;strength&quot;),
                                &quot;You hold &quot; + setup.titleCase(_char.first_name) + &quot; down and overpower &quot; + 
                                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;,&quot;,
                                $player.dialogue(&quot;Shut the fuck up, and go back to bed. If I even doubt you\&#39;re \
                                    asleep for a single second, I\&#39;ll crush your windpipe.&quot;),
                                setup.titleCase(_char.first_name) + &quot; lays back down with absolute fear (&quot; + 
                                setup.titleCase(_char.first_name) + 
                                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -15) + 
                                &quot;, Anger &quot; + setup.show_change_html(0, 20, false) + 
                                &quot;, Fear &quot; + setup.show_change_html(0, 10) +
                                &quot;, Willpower &quot; + setup.show_change_html(0, -10, false) + &quot;).&quot;
                            ]&gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 10&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.suspicion = 100&gt;&gt;
                            &lt;&lt;set _to_round = _char.key&gt;&gt;
                            &lt;&lt;include round&gt;&gt;
                            &lt;&lt;removeclass &quot;#molest_actions&quot; &quot;hidden&quot;&gt;&gt;
                            &lt;&lt;addclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
                            &lt;&lt;script&gt;&gt;
                                setup.mainLog_append_delayed(State.temporary.responses, 
                                    State.variables.molest_buttons);
                            &lt;&lt;/script&gt;&gt;
                            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                                &lt;&lt;set _molest_state.awake = false&gt;&gt;
                                &lt;&lt;set _molest_state_changed = true&gt;&gt;
                                &lt;&lt;stop&gt;&gt;
                            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                            &lt;&lt;stop&gt;&gt;
                        &lt;&lt;elseif _higher_status&gt;&gt;
                            &lt;&lt;set _responses = [
                                setup.pass(&quot;status&quot;),
                                &quot;You hold &quot; + setup.titleCase(_char.first_name) + &quot; down and remind &quot; + 
                                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; of &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; \
                                place in this household,&quot;,
                                $player.dialogue(&quot;Shut the fuck up, and go back to bed. If I even doubt you\&#39;re \
                                    asleep for a single second, I\&#39;ll crush your windpipe.&quot;),
                                setup.titleCase(_char.first_name) + &quot; lays back down with absolute fear (&quot; + 
                                setup.titleCase(_char.first_name) + 
                                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -15) + 
                                &quot;, Anger &quot; + setup.show_change_html(0, 20, false) + 
                                &quot;, Fear &quot; + setup.show_change_html(0, 10) +
                                &quot;, Willpower &quot; + setup.show_change_html(0, -10, false) + &quot;).&quot;
                            ]&gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 10&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.suspicion = 100&gt;&gt;
                            &lt;&lt;set _to_round = _char.key&gt;&gt;
                            &lt;&lt;include round&gt;&gt;
                            &lt;&lt;removeclass &quot;#molest_actions&quot; &quot;hidden&quot;&gt;&gt;
                            &lt;&lt;addclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
                            &lt;&lt;script&gt;&gt;
                                setup.mainLog_append_delayed(State.temporary.responses, 
                                    State.variables.molest_buttons);
                            &lt;&lt;/script&gt;&gt;
                            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                                &lt;&lt;set _molest_state.awake = false&gt;&gt;
                                &lt;&lt;set _molest_state_changed = true&gt;&gt;
                                &lt;&lt;stop&gt;&gt;
                            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                            &lt;&lt;stop&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set $_temp_to_log = 
                                setup.fail(&quot;strength&quot;) + 
                                &quot;You try to pin &quot; + setup.titleCase(_char.first_name) + &quot; down, but &quot; + 
                                setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; overpowers you in an instant.&lt;br&gt;&quot; +
                                _char.dialogue(&quot;You fucking piece of garbage, let me show you what happens \
                                    when you try something on me.&quot;) +
                                setup.titleCase(_char.first_name) + &quot; proceeds to crush you and kick you in the \
                                genitals. After what seems like forever &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; \
                                shoves you out the door &quot; +
                                &quot;(Health &quot; + setup.show_change_html(0, -20) + 
                                &quot;, Willpower &quot; + setup.show_change_html(0, -10) + &quot;) &quot; + 
                                &quot;(&quot; + setup.titleCase(_char.first_name) + 
                                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -15) + 
                                &quot;, Anger &quot; + setup.show_change_html(0, 20, false) + 
                                &quot;, Trust &quot; + setup.show_change_html(0, -15) + &quot;).&quot;
                            &gt;&gt;
                            &lt;&lt;set $player.conditions.health -= 20&gt;&gt;
                            &lt;&lt;set $player.slave_traits.willpower -= 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                            /* Do not induce fear */
                            &lt;&lt;if _char.slave_traits.trust gt 0&gt;&gt;
                                &lt;&lt;set _char.slave_traits.trust = Math.clamp(_char.slave_traits.trust - 15, 0, 100)&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                            /* Stop molesting */
                            &lt;&lt;set _is_molesting = false&gt;&gt;
                            /* Re-enable menu */
                            &lt;&lt;set $enable_menu = true&gt;&gt;
                            /* Last round for good measure */
                            &lt;&lt;set _to_round = _char.key&gt;&gt;
                            &lt;&lt;include round&gt;&gt;
                            &lt;&lt;goto `passage()`&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/switch&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/switch&gt;&gt;
        &lt;&lt;set _molest_state.aware = true&gt;&gt;
        &lt;&lt;set _sus_mult = 0&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;if _char.mental_conditions.arousal gte 50 &amp;&amp; !_molest_state.awake&gt;&gt;
            &lt;&lt;set _response =
                setup.titleCase(_char.first_name) + &quot;\&#39;s body jolts, letting out multiples \
                moans. &quot; + setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?he&quot;]) + &quot; orgasm \
                squirting some liquid onto the bed. This fills the already lewd air with an \
                even stronger aroma of bodily fluids.&quot;
            &gt;&gt;
            &lt;&lt;if _last_molest_action == 5 || 
                 _last_molest_action == 7 || 
                 _last_molest_action == 11&gt;&gt;
                &lt;&lt;if _char.gender == 1&gt;&gt;
                    &lt;&lt;set _response += &quot; Making &quot; + setup.titleCase(_char.first_name) + &quot; orgasm \
                        by direct contact with her pussy increased her preference for vaginal sex \
                        (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Vaginal Preference &quot; + 
                        setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                    &lt;&lt;set _char.sex_prefs.vaginal += 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _response += &quot; Making &quot; + setup.titleCase(_char.first_name) + &quot; orgasm \
                        by direct contact with his cock increased his preference for sex \
                        (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Sex Drive &quot; + 
                        setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;elseif _last_molest_action == 6 || 
                     _last_molest_action == 12&gt;&gt;
                &lt;&lt;set _response += &quot; Making &quot; + setup.titleCase(_char.first_name) + &quot; orgasm \
                    through &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; ass increased &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; preference for anal sex \
                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Anal Preference &quot; + 
                    setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.sex_prefs.anal += 1&gt;&gt;
            &lt;&lt;elseif _last_molest_action == 9&gt;&gt;
                &lt;&lt;set _response += &quot; Making &quot; + setup.titleCase(_char.first_name) + &quot; orgasm \
                    through &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; feet increased &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; fetish for feet \
                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Foot Fetish &quot; + 
                    setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.sex_fetishes.feet += 1&gt;&gt;
            &lt;&lt;elseif _last_molest_action == 10&gt;&gt;
                &lt;&lt;set _response += &quot; Making &quot; + setup.titleCase(_char.first_name) + &quot; orgasm \
                    through &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth increased &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; preference for oral sex \
                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Oral Preference &quot; + 
                    setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.sex_prefs.oral += 1&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal = 0&gt;&gt;
            &lt;&lt;set _responses = [_response]&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;unset _response&gt;&gt;
            &lt;&lt;unset _responses&gt;&gt;
            &lt;&lt;set _to_round = _char.key&gt;&gt;
            &lt;&lt;include round&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;if $player.mental_conditions.arousal gte 50 &amp;&amp; !_molest_state.awake &amp;&amp; !_print_cum_prompt&gt;&gt;
            &lt;&lt;set _print_cum_prompt = true&gt;&gt;
            &lt;&lt;set _responses = [&quot;Molesting &quot; + setup.titleCase(_char.first_name) + &quot; is too much for you \
                and you have to cum immediately!&quot;]&gt;&gt;
            /* Toggle cum options based on last action and molest state */
            &lt;&lt;if !_molest_state.top&gt;&gt;
                &lt;&lt;removeclass &quot;#molest_cum8 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest_cum8 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _molest_state.bottom&gt;&gt;
                &lt;&lt;removeclass &quot;#molest_cum5 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest_cum5 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;removeclass &quot;#molest_cum9 button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest_cum9 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _last_molest_action == 10 || _last_molest_action == 11 || _last_molest_action == 12&gt;&gt;
                &lt;&lt;removeclass `&quot;#molest_cum&quot; + _last_molest_action + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#molest_cum&quot; + _last_molest_action + &quot; button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;unset _responses&gt;&gt;
            &lt;&lt;removeclass &quot;#molest_cum_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#molest_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="13" name="requestEngine" tags="" position="350,225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;script&gt;&gt;
    var player = State.variables.player;
    var char = State.variables.characters[State.variables.selected];
    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
    var html = &quot;
        You approach &quot; + setup.titleCase(char.first_name) + &quot;,&lt;br&gt;&quot; +
        &quot;&lt;em&gt;&lt;b&gt;&quot; + setup.titleCase(player.first_name) + &quot;&lt;/b&gt;: \&quot;Hey I wanted to discuss some \
        things with you.\&quot;&lt;/em&gt;\
        &lt;br&gt;&quot; + setup.titleCase(char.first_name) + &quot; eyes you up and down, wondering what you want.\
        &lt;br&gt;\
        What would you like to request from &quot; + setup.PRONOUNS[char.gender][&quot;?him&quot;] + &quot;?&quot;;
    State.temporary.options = &quot;&lt;ol&gt;\
        &lt;li id=\&quot;li1\&quot;&gt;A hug.&lt;/li&gt;\
        &lt;li id=\&quot;li2\&quot;&gt;A strip tease.&lt;/li&gt;\
        &lt;li id=\&quot;li3\&quot;&gt;A handjob.&lt;/li&gt;\
        &lt;li id=\&quot;li4\&quot;&gt;A footjob.&lt;/li&gt;\
        &lt;li id=\&quot;li5\&quot;&gt;A blowjob.&lt;/li&gt;\
        &lt;li id=\&quot;li6\&quot;&gt;Vaginal sex.&lt;/li&gt;\
        &lt;li id=\&quot;li7\&quot;&gt;Anal sex.&lt;/li&gt;&quot;;
    State.temporary.options += &quot;&lt;/ol&gt;&quot;;
    
    if (char.mental_conditions.anger &gt; 0) {
        State.temporary.options = &quot;&lt;div style=\&#39;color: red\&#39;&gt;\
        (&quot; + setup.titleCase(char.first_name) + &quot; will be less prone to agree to requests since &quot; + 
        setup.PRONOUNS[char.gender][&quot;?he&quot;] + &quot; is upset)\
        &lt;/div&gt;&quot; + State.temporary.options;
    }
    html += State.temporary.options;
    State.temporary.options = $(State.temporary.options);
    
    div.html(html);
    setup.mainLog_append(div);
&lt;&lt;/script&gt;&gt;

&lt;&lt;set _disable_buttons = false&gt;&gt;
&lt;&lt;disableactions _options&gt;&gt;

&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;set _char = $characters[$selected]&gt;&gt;
        &lt;&lt;notify&gt;&gt;UNDER CONSTRUCTION&lt;&lt;/notify&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
        &lt;&lt;unset _char&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;script&gt;&gt;

&lt;&lt;/script&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="14" name="searchEngine" tags="" position="475,225" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Decrease search limit */
    &lt;&lt;set _char.limits.search -= 1&gt;&gt;
    &lt;&lt;set _delta_trust = 0&gt;&gt;
    /* Roll for dexterity */
    &lt;&lt;set _roll = $player.stats.dexterity + dice(1, 6 + $difficulty) - $difficulty - _char.mental_conditions.suspicion&gt;&gt;
    &lt;&lt;if _roll gte 80&gt;&gt;
        /* Finds a modest amount of lari + a percentage of inventory lari */
        &lt;&lt;set $_temp_to_log = setup.pass(&quot;dexterity&quot;)&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;You search around &quot; + setup.titleCase(_char.first_name) +
            &quot;\&#39;s room finding a most of the lari before &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
            &quot; notices something is wrong. You were luckily able to quickly exit the room in \
            before they saw anyone in their room&quot;&gt;&gt;
        &lt;&lt;set _delta_sus = 0&gt;&gt;
        &lt;&lt;set _found_lari = dice(1, 50 - $difficulty)&gt;&gt;
        &lt;&lt;set _found_lari += Math.clamp(0.05 * UInv.BagHasItem(_char.key, &quot;lari&quot;), 0, 50)&gt;&gt;
    &lt;&lt;elseif _roll gte 50&gt;&gt;
        /* Finds a modest amount of lari */
        &lt;&lt;set $_temp_to_log = setup.partial(&quot;dexterity&quot;)&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;You search around &quot; + setup.titleCase(_char.first_name) +
            &quot;\&#39;s room finding a modest amount of lari before &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
            &quot; notices something is wrong. You were luckily able to quickly exit the room in \
            before they saw anyone in their room&quot;&gt;&gt;
        &lt;&lt;set _delta_sus = 1&gt;&gt;
        &lt;&lt;set _found_lari = dice(1, 50 - $difficulty)&gt;&gt;
    &lt;&lt;elseif _roll gte 25&gt;&gt;
        /* Finds a couple of lari */
        &lt;&lt;set $_temp_to_log = setup.partial(&quot;dexterity&quot;)&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;You try searching around &quot; + setup.titleCase(_char.first_name) +
            &quot;\&#39;s room but only find a couple lari before &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
            &quot; notices something is wrong. You were luckily able to quickly exit the room in \
            before they saw anyone in their room&quot;&gt;&gt;
        &lt;&lt;set _delta_sus = 5&gt;&gt;
        &lt;&lt;set _found_lari = dice(1, 10 - $difficulty)&gt;&gt;
    &lt;&lt;elseif _roll gte 15&gt;&gt;
        /* Fail to find anything */
        &lt;&lt;set $_temp_to_log = setup.fail(&quot;dexterity&quot;)&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;You try searching around &quot; + setup.titleCase(_char.first_name) +
            &quot;\&#39;s room but can\&#39;t find anything before &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
            &quot; notices something is wrong. You were luckily able to quickly exit the room in \
            before they saw anyone in their room&quot;&gt;&gt;
        &lt;&lt;set _delta_sus = 10&gt;&gt;
    &lt;&lt;else&gt;&gt;
        /* Wakes up target */
        &lt;&lt;set $_temp_to_log = setup.fail(&quot;dexterity&quot;)&gt;&gt;
        &lt;&lt;if _char.mental_conditions.suspicion gt 50&gt;&gt;
            &lt;&lt;set $_temp_to_log += &quot;You try searching around &quot; + setup.titleCase(_char.first_name) +
                &quot;\&#39;s room but make too much noise. Already suspicios, &quot; + setup.titleCase(_char.first_name) + 
                &quot; catches you red handed, pushing you out the room&quot;&gt;&gt;
            &lt;&lt;set _delta_trust = -5&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $_temp_to_log += &quot;You try searching around &quot; + setup.titleCase(_char.first_name) +
                &quot;\&#39;s room but make too much noise, luckily you quickly sneak out before they see \
                who you are&quot;&gt;&gt;
             &lt;&lt;set _delta_sus = 20&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _found_lari = 0&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;if _delta_sus lt 0&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot; (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Suspicion &quot; + 
            setup.show_change_html(0, _delta_sus, false)&gt;&gt;
        &lt;&lt;set _char.mental_conditions.suspicion += _delta_sus&gt;&gt;
        &lt;&lt;set $to_simulate.add(_char.key)&gt;&gt;
        &lt;&lt;if _delta_trust lt 0&gt;&gt;
            &lt;&lt;set $_temp_to_log += &quot;, &quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;elseif _delta_trust lt 0&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;if _delta_trust lt 0&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;Trust &quot; + 
            setup.show_change_html(0, _delta_trust)&gt;&gt;
        &lt;&lt;set _char.slave_traits.trust -= 5&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;set $_temp_to_log += &quot;)&quot;&gt;&gt;

    &lt;&lt;if $player.titles.has(&quot;thief&quot;)&gt;&gt;
        &lt;&lt;set _found_lari *= (1 + randomFloat(0.2))&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;set _found_lari = setup.round2(_found_lari)&gt;&gt;
    &lt;&lt;if _found_lari gt 0&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot; (Lari &quot; + setup.show_change_html(0, _found_lari) + &quot;)&quot;&gt;&gt;
        &lt;&lt;addmoney _found_lari&gt;&gt;
        &lt;&lt;audio coins_sound play&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;set $_temp_to_log += &quot;.&quot;&gt;&gt;

    &lt;&lt;set _to_round = _char.key&gt;&gt;
    &lt;&lt;include round&gt;&gt;

    /* For quest &quot;power struggles&quot; */
    &lt;&lt;if _char.key == &quot;shintani_hiroyuki&quot; &amp;&amp; $quests.power_struggles.stage lte 2 &amp;&amp;  _roll gte 25&gt;&gt;
        &lt;&lt;if $quests.power_struggles.stage == 1&gt;&gt;
            &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;You search through Shintani\&#39;s office and find a large stack of \
                what seems to be transaction logs. Unfortunatly you have no idea which ones are the correct ones \
                perhaps you should look for some clues in the library first.&quot;&gt;&gt;
        &lt;&lt;elseif $quests.power_struggles.stage == 2&gt;&gt;
            &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;You search through Shintani\&#39;s office and find a large stack of \
                transaction logs. You quickly leaf through them to find one with a watermark matching the \
                symbol on the inside of the Registry from the library. You quickly grab this and slip out.&lt;br&gt;\
                &lt;span class=\&quot;success\&quot;&gt;(Acquired Nipon Transaction Logs)&lt;/span&gt;&quot;&gt;&gt;
            &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;nipon_transaction_log&quot;)&gt;&gt;
            &lt;&lt;set $quests.power_struggles.stage == 3&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* Attaining strap-on from Himari */
    &lt;&lt;if _char.key == &quot;himari_hironaka&quot; &amp;&amp;  _roll gte 25 &amp;&amp; UInv.BagHasItem(&quot;inventory&quot;, &quot;strap_on&quot;) == 0&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;You find in a tattered old box a large strap-on made of soft silicon.&lt;br&gt;\
            &lt;span class=\&quot;success\&quot;&gt;(Acquired Strap On)&lt;/span&gt;&quot;&gt;&gt;
        &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;strap_on&quot;)&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;goto `passage()`&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="15" name="sexActions" tags="" position="600,225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;sex_actions&quot; class=&quot;action container row col longbutton fiveQuarters smalltext hidden&quot;
    style=&quot;--rows: 4; --cols: 4&quot;&gt;

    @@#sex1;&lt;&lt;button &quot;Caress&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You try to hug &quot; + setup.titleCase(_char.first_name) + &quot; but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; recoils, shaking &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; head.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;caress&quot;, 0, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [
                    &quot;You wrap &quot; + setup.titleCase(_char.first_name) + &quot; in your arms and hold &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + 
                    &quot; tightly in your arms.&quot;
                ]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes are fixed far away, apprehensive about what\&#39;s to \
                        come next.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes are fixed onto yours, both excited and nervous about what\&#39;s to \
                        come next.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _mins = 1 + dice(1, 1)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You wrap &quot; + setup.titleCase(_char.first_name) + &quot; in your arms and hold &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + 
                        &quot; tightly in your arms.&quot;
                    ]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes are fixed far away, apprehensive about what\&#39;s to \
                            come next.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 1&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes are fixed onto yours, both excited and nervous about what\&#39;s to \
                            come next.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _mins = 1 + dice(1, 1)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex2;&lt;&lt;button &quot;Kiss&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You try to kiss &quot; + setup.titleCase(_char.first_name) + &quot; but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; recoils, pulling back in shock.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;kiss&quot;, 5, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [
                    &quot;You kiss &quot; + setup.titleCase(_char.first_name) + &quot; sticking your tongue into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                    &quot; mouth.&quot;
                ]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes are glaze over with tears as &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                        &quot; mouth is continually assaulted and filled with your saliva.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 2&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; responds by also pushing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tongue into your mouth \
                        creating a wet sensual dance of saliva.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 2&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You kiss &quot; + setup.titleCase(_char.first_name) + &quot; sticking your tongue into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                        &quot; mouth.&quot;
                    ]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes are glaze over with tears as &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                            &quot; mouth is continually assaulted and filled with your saliva.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 2&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; responds by also pushing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tongue into your mouth \
                            creating a wet sensual dance of saliva.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
                        &lt;&lt;set $player.mental_conditions.arousal += 2&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex3;&lt;&lt;button &quot;Undress&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You start taking off &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s clothes but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; pulls away, clearly not comfortable being completely naked in front of you.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;undress&quot;, 15, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [
                    &quot;You ferociously undress &quot; + setup.titleCase(_char.first_name) + &quot; revealing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                    &quot; &quot; + _char.physical_traits.skin_color + &quot; skin.&quot;
                ]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes jolt down and &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                        &quot; uses &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; arms and hands to try to cover as much skin as possible.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 3&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; helps you undress &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;self. As &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] +
                        &quot; clothes come off you can already smell the lewd juices coalescing.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 2&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _sex_state.top = false&gt;&gt;
                &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                &lt;&lt;set _mins = 2 + dice(1, 2)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You ferociously undress &quot; + setup.titleCase(_char.first_name) + &quot; revealing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                        &quot; &quot; + _char.physical_traits.skin_color + &quot; skin.&quot;
                    ]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes jolt down and &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                            &quot; uses &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; arms and hands to try to cover as much skin as possible.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 3&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; helps you undress &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;self. As &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] +
                            &quot; clothes come off you can already smell the lewd juices coalescing.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
                        &lt;&lt;set $player.mental_conditions.arousal += 2&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _sex_state.top = false&gt;&gt;
                    &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                    &lt;&lt;set _mins = 2 + dice(1, 2)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex4;&lt;&lt;button &quot;Remove top&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You start slowly taking off &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s top but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; pulls away, clearly not comfortable bearing their chest in front of you.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;top&quot;, 7, _query_str)&gt;&gt;
                &lt;&lt;set _str = &quot;You remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s top revealing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                    &quot; &quot; + _char.physical_traits.skin_color + &quot; &quot;&gt;&gt;
                &lt;&lt;if _char.gender == 0&gt;&gt;
                    &lt;&lt;set _str += &quot;chest.&quot;&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _str += &quot;perky boobs.&quot;&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _responses = [_str]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes jolt down and &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                        &quot; uses &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; arms and hands to try to cover as much skin as possible.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 2&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 0.3&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; removes &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; top with a lustful k in &quot; + 
                        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot;eyes.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 1.5&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 1.5&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _sex_state.top = false&gt;&gt;
                &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _str = &quot;You remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s top revealing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                        &quot; &quot; + _char.physical_traits.skin_color + &quot; &quot;&gt;&gt;
                    &lt;&lt;if _char.gender == 0&gt;&gt;
                        &lt;&lt;set _str += &quot;chest.&quot;&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _str += &quot;perky boobs.&quot;&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _responses = [_str]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes jolt down and &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                            &quot; uses &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; arms and hands to try to cover as much skin as possible.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 2&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 0.3&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; removes &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; top with a lustful look in &quot; + 
                            setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot;eyes.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 1.5&gt;&gt;
                        &lt;&lt;set $player.mental_conditions.arousal += 1.5&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _sex_state.top = false&gt;&gt;
                    &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex5;&lt;&lt;button &quot;Remove bottoms&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You start slowly taking off &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s bottoms but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; pulls away, clearly not comfortable bearing their genitals in front of you.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;bottom&quot;, 12, _query_str)&gt;&gt;
                &lt;&lt;set _str = &quot;You remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s bottom revealing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                    &quot; &quot; + _char.physical_traits.skin_color + &quot; &quot;&gt;&gt;
                &lt;&lt;if _char.gender == 1&gt;&gt;
                    &lt;&lt;set _str += &quot;pussy.&quot;&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _str += &quot;cock.&quot;&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _responses = [_str]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes jolt down and &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                        &quot; uses &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; arms and hands to try to cover as much skin as possible.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 2&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 0.3&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; removes &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; bottoms revealing a \
                        precum dripping down &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; legs. The air fills with a smell of sexual opulence.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 1.5&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 1.5&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _str = &quot;You remove &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s bottom revealing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                        &quot; &quot; + _char.physical_traits.skin_color + &quot; &quot;&gt;&gt;
                    &lt;&lt;if _char.gender == 1&gt;&gt;
                        &lt;&lt;set _str += &quot;pussy.&quot;&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _str += &quot;cock.&quot;&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _responses = [_str]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes jolt down and &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                            &quot; uses &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; arms and hands to try to cover as much skin as possible.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 2&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 0.3&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; removes &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; bottoms revealing a \
                            precum dripping down &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; legs. The air fills with a smell of sexual opulence.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 1&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 1.5&gt;&gt;
                        &lt;&lt;set $player.mental_conditions.arousal += 1.5&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                    &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;disable&gt;&gt;
    @@#sex6;&lt;&lt;button &quot;Fondel boobs&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You reach for &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; +
                _char_chest + &quot;, but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; pulls away in reflex, clearly uncomfortable with being groped.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;fondel&quot;, 15, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You cup your hands on &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + _char.physical_traits.skin_color + 
                    &quot; &quot; + _char_chest + &quot;, interlacing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; nipples in your fingers.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes glaze over with tears as &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                        &quot; gets forcefully groped.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 3&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as their nipples harden under your touch.&quot;)&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 2&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 2.5&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 1&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You cup your hands on &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + _char.physical_traits.skin_color + 
                        &quot; &quot; + _char_chest + &quot;, interlacing &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; nipples in your fingers.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s eyes glaze over with tears as &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                            &quot; gets forcefully groped.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 3&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as their nipples harden under your touch.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 2&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 2.5&gt;&gt;
                        &lt;&lt;set $player.mental_conditions.arousal += 1&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
    @@#sex7;&lt;&lt;button &quot;Finger pussy&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You slide your hand down &quot; + setup.titleCase(_char.first_name) + &quot; body then back up &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; leg, approaching &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; &quot;&gt;&gt;
            &lt;&lt;if _char.gender == 0&gt;&gt;
                &lt;&lt;set _query_str += &quot;cock,&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _query_str += &quot;pussy,&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _query_str += &quot; but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; pushes your hand away, clearly uninterested in you \
                groping &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; &quot;&gt;&gt;
            &lt;&lt;if _char.gender == 0&gt;&gt;
                &lt;&lt;set _query_str += &quot;penis.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _query_str += &quot;vagina.&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _query_action(&quot;finger&quot;, 20, _query_str)&gt;&gt;
                &lt;&lt;if _char.gender == 0&gt;&gt;
                    /* TODO: Implement for male */
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your fingers one-by-one into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet \
                        pussy, sliding over her clitorus making her slightly squirm.&quot;]&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;if _char.gender == 0&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Under construction for males.&quot;)&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Tears drip down &quot; + setup.titleCase(_char.first_name) + &quot; face as she can\&#39;t help but moan \
                            and feel pleasure from your touch.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please stop it, I\&#39;m begging you...&quot;))&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?his&quot;]) + &quot; pleading gets interrupted by a moan.&quot;)&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    
                    &lt;&lt;set _char.mental_conditions.discomfort += 3&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;if _char.gender == 0&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Under construction for males.&quot;)&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as squelshing sounds of her pussy \
                            echo through the air.&quot;)&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 2&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 1&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _mins = 2 + dice(1, 3)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;if _char.gender == 0&gt;&gt;
                        /* TODO: Implement for male */
                        &lt;&lt;set _responses = []&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses = [&quot;You insert your fingers one-by-one into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet \
                            pussy, sliding over her clitorus making her slightly squirm.&quot;]&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;if _char.gender == 0&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Under construction for males.&quot;)&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Tears drip down &quot; + setup.titleCase(_char.first_name) + &quot; face as she can\&#39;t help but moan \
                                and feel pleasure from your touch.&quot;)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(&quot;Please stop it, I\&#39;m begging you...&quot;))&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?his&quot;]) + &quot; pleading gets interrupted by a moan.&quot;)&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        
                        &lt;&lt;set _char.mental_conditions.discomfort += 3&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;if _char.gender == 0&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Under construction for males.&quot;)&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as squelshing sounds of her pussy \
                                echo through the air.&quot;)&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 2&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                        &lt;&lt;set $player.mental_conditions.arousal += 1&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _mins = 2 + dice(1, 3)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
    @@#sex8;&lt;&lt;button &quot;Lick pussy&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You lower your head down inbetween &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s legs but&quot; + 
                setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; quickly closes them, weary of your attempt at licking &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;]&gt;&gt;
            &lt;&lt;if _char.gender == 0&gt;&gt;
                &lt;&lt;set _query_str += &quot; cock.&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _query_str += &quot; pussy.&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if _query_action(&quot;lick&quot;, 25, _query_str)&gt;&gt;
                &lt;&lt;if _char.gender == 0&gt;&gt;
                    /* TODO: Implement for male */
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You plunge your tongue into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s pussy, tasting \
                        her aroma and all of her juices.&quot;]&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;if _char.gender == 0&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Under construction for males.&quot;)&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Tears drip down &quot; + setup.titleCase(_char.first_name) + &quot; face as she can\&#39;t help but moan \
                            and feel pleasure from your tongue swirling in her pussy.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please stop it, I\&#39;m begging you... not... there...&quot;))&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?his&quot;]) + &quot; pleading gets interrupted by several moans as she bites \
                            her lips to stop from screaming.&quot;)&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    
                    &lt;&lt;set _char.mental_conditions.discomfort += 2&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 6&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;if _char.gender == 0&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Under construction for males.&quot;)&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; bites her lip to stop herself from screaming out in pleasure,&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Ohhh yess!! Just like that, don\&#39;t stop!&quot;))&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 6&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 10&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 3&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;if _char.gender == 0&gt;&gt;
                        /* TODO: Implement for male */
                        &lt;&lt;set _responses = []&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses = [&quot;You plunge your tongue into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s pussy, tasting \
                            her aroma and all of her juices.&quot;]&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;if _char.gender == 0&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Under construction for males.&quot;)&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Tears drip down &quot; + setup.titleCase(_char.first_name) + &quot; face as she can\&#39;t help but moan \
                                and feel pleasure from your tongue swirling in her pussy.&quot;)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(&quot;Please stop it, I\&#39;m begging you... not... there...&quot;))&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?his&quot;]) + &quot; pleading gets interrupted by several moans as she bites \
                                her lips to stop from screaming.&quot;)&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        
                        &lt;&lt;set _char.mental_conditions.discomfort += 2&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 6&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;if _char.gender == 0&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Under construction for males.&quot;)&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; bites her lip to stop herself from screaming out in pleasure,&quot;)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(&quot;Ohhh yess!! Just like that, don\&#39;t stop!&quot;))&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 6&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 10&gt;&gt;
                        &lt;&lt;set $player.mental_conditions.arousal += 3&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;
    @@#sex9;&lt;&lt;button &quot;Footjob&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You grab &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + _char.physical_traits.skin_color + 
                &quot;feet and position your &quot; + _cock + &quot; between them, but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; pulls back, \
                clearly uncomfortable.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;footjob&quot;, 30, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You slide your wet &quot; + _cock + &quot; between &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s feet and \
                    toes which have become wet with your spit and precum.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;if _char.sex_fetishes.feet gt 30&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s looks at you with dead eyes, but having a foot fetish, &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                            &quot; is secretly getting very turned on.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s looks at you with dead eyes, and hates that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                            &quot; is being humiliated like this.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 4&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;if _char.sex_fetishes.feet gt 30&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as their toes get fucked by you.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; enjoys having their feet be used as sex objects.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
                        &lt;&lt;set _char.sex_fetishes.feet += 1&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort -= 2&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You slide your wet &quot; + _cock + &quot; between &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s feet and \
                        toes which have become wet with your spit and precum.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.feet gt 30&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s looks at you with dead eyes, but having a foot fetish, &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                                &quot; is secretly getting very turned on.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s looks at you with dead eyes, and hates that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                                &quot; is being humiliated like this.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.discomfort += 4&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 0.5&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.feet gt 30&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as their toes get fucked by you.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; enjoys having their feet be used as sex objects.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
                            &lt;&lt;set _char.sex_fetishes.feet += 1&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort -= 2&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                    &lt;&lt;set _mins = 1 + dice(1, 2)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex10;&lt;&lt;button &quot;Oral sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You grab your &quot; + _cock + &quot; out of your pants and pull &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + 
                _char.physical_traits.hair_color + &quot; hair to line up &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; head, but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; clearly tries to pull way, not fond of the idea of giving you a blowjob.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;oral&quot;, 40, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s mouth.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face, but being a cumslut, &quot; + setup.PRONOUNS[_char.gender][&quot;?she&quot;] + &quot; looks \
                            forward to being filled with your cum.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face as you start to orally rape &quot; +
                            setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.oral -= 1&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as your precum touches their tongue. As \
                            a cumslut they are gushing wet just thinking about your cum.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please give me your cum; I want to bath and be filled with it!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; takes in your &quot; + _cock + &quot; with hunger in &quot; + 
                            setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 3&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;set _open_menu = &quot;#sex_oral_actions&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.last_action = &quot;oral&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                    &lt;&lt;set _sex_state.top = false&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s mouth.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face, but being a cumslut, &quot; + setup.PRONOUNS[_char.gender][&quot;?she&quot;] + &quot; looks \
                                forward to being filled with your cum.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face as you start to orally rape &quot; +
                                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                            &lt;&lt;set _char.sex_prefs.oral -= 1&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as your precum touches their tongue. As \
                                a cumslut they are gushing wet just thinking about your cum.&quot;)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(&quot;Please give me your cum; I want to bath and be filled with it!&quot;))&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; takes in your &quot; + _cock + &quot; with hunger in &quot; + 
                                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 3&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;set _open_menu = &quot;#sex_oral_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;oral&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                        &lt;&lt;set _sex_state.top = false&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;disable&gt;&gt;
    @@#sex11;&lt;&lt;button &quot;Vaginal sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You grab your &quot; + _cock + &quot; out of your pants and line it up with &quot; + setup.titleCase(_char.first_name) +
                &quot;\&#39;s vagina.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;vaginal&quot;, 50, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet pussy.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Anything but that! Please!...&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
                    &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                    &lt;&lt;set _char.slave_traits.trust -= 7&gt;&gt;
                    &lt;&lt;set _char.sex_prefs.vaginal -= 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck me!&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;set _open_menu = &quot;#sex_vaginal_actions&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.last_action = &quot;vaginal&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                    &lt;&lt;set _sex_state.top = false&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet pussy.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Anything but that! Please!...&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 7&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.vaginal -= 1&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck me!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;set _open_menu = &quot;#sex_vaginal_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;vaginal&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                        &lt;&lt;set _sex_state.top = false&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
    @@#sex12;&lt;&lt;button &quot;Anal sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You grab your &quot; + _cock + &quot; out of your pants and line it up with &quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s asshole.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;anal&quot;, 65, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s tight asshole.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Not my ass, it hurts so much! Please!...&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 20&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
                    &lt;&lt;set _char.slave_traits.obedience -= 20&gt;&gt;
                    &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
                    &lt;&lt;set _char.sex_prefs.anal -= 2&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck my ass!&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 8&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 15&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;set _open_menu = &quot;#sex_anal_actions&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.last_action = &quot;anal&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                    &lt;&lt;set _sex_state.top = false&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s tight asshole.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Not my ass, it hurts so much! Please!...&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 20&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 20&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.anal -= 2&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck my ass!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 8&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 15&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;set _open_menu = &quot;#sex_anal_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;anal&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.bottom = false&gt;&gt;
                        &lt;&lt;set _sex_state.top = false&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;

    &lt;div&gt;&lt;/div&gt;
    @@#sex_back;&lt;&lt;button &quot;Back&quot; `passage()`&gt;&gt;
        &lt;&lt;set $enable_menu = true&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@

    &lt;&lt;disable&gt;&gt;
    @@#sex_done;&lt;&lt;button &quot;Done&quot; `passage()`&gt;&gt;
        &lt;&lt;if _sex_state.orgasm&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties.&lt;br&gt;&quot; + _char.dialogue(&quot;That was great, let\&#39;s do that again sometime...&quot;) + 
                &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection &quot; + setup.show_change_html(0, 5) + &quot;)&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += 5&gt;&gt;
        &lt;&lt;elseif _char.mental_conditions.arousal gt 20 &amp;&amp; _char.mental_conditions.discomfort lt _char.mental_conditions.arousal&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] +
                &quot; found the experience quite pleasurable (&quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, (_char.mental_conditions.arousal - _char.mental_conditions.discomfort) / 10) + &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += (_char.mental_conditions.arousal - _char.mental_conditions.discomfort) / 10&gt;&gt;
        &lt;&lt;elseif _char.mental_conditions.discomfort gt _char.mental_conditions.arousal&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] +
                &quot; did not find the experience pleasurable (&quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, _char.mental_conditions.arousal - _char.mental_conditions.discomfort) + &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += (_char.mental_conditions.arousal - _char.mental_conditions.discomfort)&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties.&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        /* Re-enable menu */
        &lt;&lt;set $enable_menu = true&gt;&gt;
        &lt;&lt;set $to_simulate.add(_char.key)&gt;&gt;
        /* Last round for good measure */
        &lt;&lt;set _to_round = _char.key&gt;&gt;
        &lt;&lt;include round&gt;&gt;
        &lt;&lt;run _get_changes()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;

    /* Specifications for logging */
    &lt;&lt;set _sex_buttons = [&quot;#sex_back&quot;, &quot;#sex_done&quot;,
                          &quot;#sex_oral_back&quot;, &quot;#sex_oral_done&quot;,
                          &quot;#sex_vaginal_back&quot;, &quot;#sex_vaginal_done&quot;,
                          &quot;#sex_anal_back&quot;, &quot;#sex_anal_done&quot;,
                          &quot;#sex_vaginal_oral&quot;, &quot;#sex_vaginal_anal&quot;,
                          &quot;#sex_anal_oral&quot;, &quot;#sex_anal_vaginal&quot;,
                          &quot;#sex_oral_vaginal&quot;, &quot;#sex_oral_anal&quot;]&gt;&gt;
    &lt;&lt;for _i = 1; _i lte 12; _i++&gt;&gt;
        &lt;&lt;set _sex_buttons.push(&quot;#sex&quot; + _i)&gt;&gt;
        &lt;&lt;set _sex_buttons.push(&quot;#sex_oral&quot; + _i)&gt;&gt;
        &lt;&lt;set _sex_buttons.push(&quot;#sex_vaginal&quot; + _i)&gt;&gt;
        &lt;&lt;set _sex_buttons.push(&quot;#sex_anal&quot; + _i)&gt;&gt;
    &lt;&lt;/for&gt;&gt;

&lt;/div&gt;

/* Include the other actions */
&lt;&lt;include sexOralActions&gt;&gt;
&lt;&lt;include sexVaginalActions&gt;&gt;
&lt;&lt;include sexAnalActions&gt;&gt;
&lt;&lt;include sexRejectionActions&gt;&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;script&gt;&gt;
    var _t = State.temporary;
    _t.calc_thresh = (action) =&gt; {
        let char = State.temporary.char;
        let player = State.variables.player;
        let thresh = (char.slave_traits.obedience - 60 + 
                      char.slave_traits.trust - 
                      char.mental_conditions.anger + 
                      char.mental_conditions.arousal * (3 - State.variables.difficulty) -
                      char.mental_conditions.discomfort);
        if (action == &quot;oral&quot; || action == &quot;vaginal&quot; || action == &quot;anal&quot;) {
            thresh += player.sex_skills[action] + char.sex_prefs[action];
        } else {

        }
        if (_t.sex_state.orgasm) {
            thresh += 1000;
        }
        return thresh;
    };
    _t.query_action = (action, modifier, text) =&gt; {
        _t.check_fucking();
        let sex_state = _t.sex_state;
        _t.thresh = modifier - _t.calc_thresh(action);
        if (sex_state.rape || (action in sex_state.boundaries &amp;&amp; sex_state.boundaries[action]) || _t.thresh &lt; 0) {
            sex_state.boundaries[action] = true;
            return true;
        } else {
            if (text !== &quot;undefined&quot;) {
                if (!_t.is_fucking) {
                    setup.mainLog_append_delayed([text + &quot;&lt;br&gt;&quot; +  _t.char.dialogue(&quot;Uh, what the fuck are you doing?&quot;)]);
                } else {
                    setup.mainLog_append_delayed([text + &quot;&lt;br&gt;&quot; + _t.char.dialogue(&quot;Um... no.&quot;)]);
                }
            }
            _t.rejection_processed = false;
            _t.action = action;
            $.wiki(&quot;&lt;&lt;include sexRejectionEngine&gt;&gt;&quot;);
            return false;
        }
    };
    _t.update_state = () =&gt; {
        let _t = State.temporary;
        let char = _t.char;
        let player = State.variables.player;
        if (_t.is_fucking) {
            $(&quot;#sex_back button&quot;).addClass(&quot;disabled&quot;);
            $(&quot;#sex_back button&quot;).prop(&quot;disabled&quot;, true);
            $(&quot;#sex_done button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#sex_done button&quot;).prop(&quot;disabled&quot;, false);
        }
        if (!_t.sex_state.top) {
            $(&quot;#sex4 button&quot;).addClass(&quot;disabled&quot;);
            $(&quot;#sex4 button&quot;).prop(&quot;disabled&quot;, true);
            $(&quot;#sex6 button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#sex6 button&quot;).prop(&quot;disabled&quot;, false);
        }
        if (!_t.sex_state.bottom) {
            $(&quot;#sex5 button&quot;).addClass(&quot;disabled&quot;);
            $(&quot;#sex5 button&quot;).prop(&quot;disabled&quot;, true);
            $(&quot;#sex7 button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#sex7 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#sex8 button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#sex8 button&quot;).prop(&quot;disabled&quot;, false);
            if (player.gender == 0) {
                if (char.gender != 0) {
                    $(&quot;#sex11 button&quot;).removeClass(&quot;disabled&quot;);
                    $(&quot;#sex11 button&quot;).prop(&quot;disabled&quot;, false);
                }
                $(&quot;#sex12 button&quot;).removeClass(&quot;disabled&quot;);
                $(&quot;#sex12 button&quot;).prop(&quot;disabled&quot;, false);
            } else {
                if (char.gender == 0 &amp;&amp; (player.has_equipped(&quot;strap-on&quot;) != &quot;none&quot;)) {
                    $(&quot;#sex12 button&quot;).removeClass(&quot;disabled&quot;);
                    $(&quot;#sex12 button&quot;).prop(&quot;disabled&quot;, false);
                }
            }
        }
        if (!_t.sex_state.top &amp;&amp; !_t.sex_state.bottom) {
            $(&quot;#sex3 button&quot;).addClass(&quot;disabled&quot;);
            $(&quot;#sex3 button&quot;).prop(&quot;disabled&quot;, true);
        }
    };
    $(&quot;#sex_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
        var self = $(event.currentTarget);
        if (self.html() != &quot;Back&quot; &amp;&amp; self.html() != &quot;Done&quot;) {
            let _t = State.temporary;
            let char = _t.char;
            let player = State.variables.player;
            _t.to_round = _t.char.key;
            $.wiki(&quot;&lt;&lt;include round&gt;&gt;&quot;);
            $.wiki(&quot;&lt;&lt;include updateBars&gt;&gt;&quot;);
        }
    });
    _t.check_fucking = () =&gt; {
        let _t = State.temporary;
        let char = _t.char;
        if (!_t.is_fucking) {
            _t.is_fucking = true;
            char.limits.fuck -= 1;
        }
    };
    _t.check_arousal = () =&gt; {
        let _t = State.temporary;
        let char = _t.char;
        let player = State.variables.player;
        _t.update_state();
        if (char.mental_conditions.arousal &gt; 50) {
            if (_t.sex_state.last_action in char.sex_prefs) {
                char.sex_prefs[_t.sex_state.last_action] += 1;
            }
        }
        if (player.mental_conditions.arousal &gt; 50 &amp;&amp; char.mental_conditions.arousal &gt; 50) {
            let str = &quot;This pushes both you and &quot; + setup.titleCase(char.first_name) + &quot; off the edge, resulting \
                in a simultaneous orgasm of euphoria.&quot;;
            if (player.gender == 0) {
                str += &quot; You quickly grab your cock and need to cum.&quot;;
                _t.is_cumming = true;
            }
            _t.responses.push(str);
            str = &quot;Fuck that was so good!&quot;;
            if (player.gender == 0) {
                str += &quot; Give it to me!&quot;;
            }
            _t.responses.push(char.dialogue(str));
            _t.responses.push(&quot;Where do you cum?&quot;);
            _t.sex_state.orgasm = true;
            char.mental_conditions.arousal = 0;
            char.conditions.stamina -= 30;
            let loop = () =&gt; {
                setTimeout(() =&gt; {
                    if (_t.done_appending !== &quot;undefined&quot; &amp;&amp; _t.done_appending) {
                        $(_t.open_menu).addClass(&quot;hidden&quot;);
                        $(&quot;#action_bar&quot;).wiki(&quot;&lt;&lt;include sexCumActions&gt;&gt;&quot;);
                    } else {
                        loop();
                    }
                }, 20);
            };
            setTimeout(() =&gt; {
                loop();
            }, 50);
        } else if (player.mental_conditions.arousal &gt; 50) {
            let str = &quot;This pushes both you off the edge, making you move into orgasm.&quot;;
            if (player.gender == 0) {
                str += &quot; You quickly grab your cock and need to cum.&quot;;
                _t.is_cumming = true;
            }
            _t.responses.push(str);
            _t.responses.push(&quot;Where do you cum?&quot;);
            let loop = () =&gt; {
                setTimeout(() =&gt; {
                    if (_t.done_appending !== &quot;undefined&quot; &amp;&amp; _t.done_appending) {
                        $(_t.open_menu).addClass(&quot;hidden&quot;);
                        $(&quot;#action_bar&quot;).wiki(&quot;&lt;&lt;include sexCumActions&gt;&gt;&quot;);
                    } else {
                        loop();
                    }
                }, 20);
            };
            setTimeout(() =&gt; {
                loop();
            }, 50);
        } else if (char.mental_conditions.arousal &gt; 50) {
            _t.responses.push(&quot;This pushes &quot; + setup.titleCase(char.first_name) + &quot; off the edge, making &quot; + 
                setup.PRONOUNS[char.gender][&quot;?him&quot;] + &quot; orgasm immediately.&quot;);
            _t.responses.push(char.dialogue(&quot;Fuck that was so good!&quot;));
            _t.sex_state.orgasm = true;
            char.mental_conditions.arousal = 0;
            char.conditions.stamina -= 30;
        }
        char.conditions.stamina -= 5 * (1 + State.variables.difficulty / 10);

        setup.mainLog_append_delayed(_t.responses, _t.sex_buttons);
        delete _t.responses;
    };
    _t.get_changes = () =&gt; {
        let _t = State.temporary;
        let char = _t.char;
        let prechar = _t.prechar;
        let ret = &quot;&lt;div&gt;&lt;b&gt;&quot; + setup.titleCase(char.first_name) + &quot; Changes&lt;/b&gt;&quot;;
        let change_str = &quot;&lt;ul&gt;&quot;;
        for (let condition of setup.CONDITIONS) {
            if (char.conditions[condition] != prechar.conditions[condition]) {
                if (condition in setup.POSITIVES.character) {
                    change_str += &quot;&lt;li&gt;&quot; + setup.titleCase(condition) + &quot;: &quot; + 
                        setup.show_change_html(prechar.conditions[condition], char.conditions[condition],
                            setup.POSITIVES.character[condition])
                } else {
                    change_str += &quot;&lt;li&gt;&quot; + setup.titleCase(condition) + &quot;: &quot; + 
                        setup.show_change(prechar.conditions[condition], char.conditions[condition])
                }
            }
        }
        for (let slave_trait of setup.SLAVE_TRAITS) {
            if (char.slave_traits[slave_trait] != prechar.slave_traits[slave_trait]) {
                let tit = setup.titleCase(slave_trait);
                if (slave_trait == &quot;obedience&quot;) {
                    tit = &quot;Affection&quot;;
                }
                if (slave_trait == &quot;trust&quot; &amp;&amp; (char.slave_traits[slave_trait] &gt; prechar.slave_traits[slave_trait])) {
                    change_str += &quot;&lt;li&gt;&quot; + tit + &quot;: &quot; + setup.show_change_html(prechar.slave_traits[slave_trait], char.slave_traits[slave_trait]);
                } else {
                    if (slave_trait in setup.POSITIVES.character) {
                        change_str += &quot;&lt;li&gt;&quot; + tit + &quot;: &quot; + setup.show_change_html(prechar.slave_traits[slave_trait], char.slave_traits[slave_trait],
                            setup.POSITIVES.character[slave_trait]);
                    } else {
                        change_str += &quot;&lt;li&gt;&quot; + tit + &quot;: &quot; + setup.show_change(prechar.slave_traits[slave_trait], char.slave_traits[slave_trait]);
                    }
                }
                change_str += &quot;&lt;/li&gt;&quot;;
            }
        }
        for (let condition of setup.MENTAL_CONDITIONS) {
            if (condition == &quot;arousal&quot;) {
                continue;
            }
            if (char.mental_conditions[condition] != prechar.mental_conditions[condition]) {
                if (condition in setup.POSITIVES.character) {
                    change_str += &quot;&lt;li&gt;&quot; + setup.titleCase(condition) + &quot;: &quot; + 
                        setup.show_change_html(prechar.mental_conditions[condition], char.mental_conditions[condition],
                            setup.POSITIVES.character[condition]);
                } else {
                    change_str += &quot;&lt;li&gt;&quot; + setup.titleCase(condition) + &quot;: &quot; + 
                        setup.show_change(prechar.mental_conditions[condition], char.mental_conditions[condition]);
                }
                change_str += &quot;&lt;/li&gt;&quot;;
            }
        }
        for (let sex_pref of setup.SEX_PREFS) {
            if (char.sex_prefs[sex_pref] != prechar.sex_prefs[sex_pref]) {
                if (sex_pref in setup.POSITIVES.character) {
                    change_str += &quot;&lt;li&gt;&quot; + setup.titleCase(sex_pref) + &quot; Preference: &quot; + 
                        setup.show_change_html(prechar.sex_prefs[sex_pref], char.sex_prefs[sex_pref],
                            setup.POSITIVES.character[sex_pref]);
                } else {
                    change_str += &quot;&lt;li&gt;&quot; + setup.titleCase(sex_pref) + &quot; Preference: &quot; + 
                        setup.show_change(prechar.sex_prefs[sex_pref], char.sex_prefs[sex_pref]);
                }
                change_str += &quot;&lt;/li&gt;&quot;;
            }
        }
        for (let sex_fetish of setup.SEX_FETISHES) {
            if (char.sex_fetishes[sex_fetish] != prechar.sex_fetishes[sex_fetish]) {
                if (sex_fetish in setup.POSITIVES.character) {
                    change_str += &quot;&lt;li&gt;&quot; + setup.titleCase(sex_fetish) + &quot; Fetish: &quot; + 
                        setup.show_change_html(prechar.sex_fetishes[sex_fetish], char.sex_fetishes[sex_fetish],
                            setup.POSITIVES.character[sex_fetish]);
                } else {
                    change_str += &quot;&lt;li&gt;&quot; + setup.titleCase(sex_fetish) + &quot; Fetish: &quot; + 
                        setup.show_change(prechar.sex_fetishes[sex_fetish], char.sex_fetishes[sex_fetish]);
                }
                change_str += &quot;&lt;/li&gt;&quot;;
            }
        }
        change_str += &quot;&lt;/ul&gt;&lt;/div&gt;&quot;;
        ret += change_str;
        State.variables._temp_to_log += ret;
    };

&lt;&lt;/script&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="16" name="sexAnalActions" tags="" position="725,225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;sex_anal_actions&quot; class=&quot;action container row col longbutton fiveQuarters smalltext hidden&quot;
    style=&quot;--rows: 4; --cols: 4&quot;&gt;

    @@#sex_anal1;&lt;&lt;button &quot;Continue&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;anal&quot;, 65)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You continue fucking &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s ass. As you thrust in and out \
                air is pumped into her anal cavity,&quot;
            ]&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(either([
                    &quot;Please stop you\&#39;re going to tear me apart!&quot;,
                    &quot;It hurts! It hurts!!&quot;,
                    &quot;Just fucking kill me already please just end it!&quot;
                ])))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                &lt;&lt;set _char.sex_prefs.anal -= 0.5&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(either([
                    &quot;Yes! Please keep fucking me just like that!&quot;,
                    &quot;Fuck me harder!&quot;,
                    &quot;Please don\&#39;t stop!&quot;,
                    &quot;Ahhh fuck that\&#39;s so good!&quot;
                ])))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_anal2;&lt;&lt;button &quot;Choke&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;anal&quot;, 70)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;As you continue fucking &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s ass, you put your hands around &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + 
                &quot; neck restricting her breath.&quot;
            ]&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s face grows red and tears stream down &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                    &quot; cheek,&quot;)&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(either([
                    &quot;What the fuck! Let go of me!&quot;,
                    &quot;It hurts! It hurts!!&quot;,
                    &quot;Just fucking kill me already please just end it, choke me to death right here.&quot;
                ])))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                &lt;&lt;set _char.sex_prefs.anal -= 0.5&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s face grows red and &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                    &quot; eyes roll back in bliss,&quot;)&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(either([
                    &quot;Yes! Choke me daddy, harder!&quot;,
                    &quot;Fuck me harder!&quot;,
                    &quot;Ack... Fuck... Keep going.&quot;,
                    &quot;Ahhh fuck that\&#39;s so good!&quot;
                ])))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_anal3;&lt;&lt;button &quot;Insult&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;anal&quot;, 75)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You continue thrusting in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s ass.&quot;
            ]&gt;&gt;
            &lt;&lt;set _responses.push($player.dialogue(either([
                &quot;You\&#39;re such a fucking disgusting little whore.&quot;,
                &quot;You little bitch aren\&#39;t worth anything except a little piece of shit for me to fuck.&quot;,
                &quot;Take it you fucking cunt.&quot;,
                &quot;I bet this is the only reason anyone keeps you around, you fucking shit.&quot;,
                &quot;You\&#39;re nothing just a little fuck toy aren\&#39;t you?&quot;
            ])))&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(&quot;You can tell from the tears forming in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s eyes that \
                    you went too far.&quot;)&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;What the fu...&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Yeah, that\&#39;s right, ahhhh!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?he&quot;]) + &quot; gets cut off by your continual pounding of &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; ass.&quot;)&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_anal4;&lt;&lt;button &quot;Spit in mouth&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;anal&quot;, 80)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;As you continue thrusting in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s ass, you force open &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth and spit into it.&quot;
            ]&gt;&gt;
            &lt;&lt;set _responses.push($player.dialogue(either([
                &quot;Drink my fucking spit you ugly pig.&quot;,
                &quot;You like that you disgusting piece of shit?&quot;,
                &quot;You\&#39;re nothing, just a piece of trash to spit and cum on.&quot;
            ])))&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(&quot;You can tell from the tears forming in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s eyes that \
                    you went too far.&quot;)&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;What the fu...&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Yeah, that\&#39;s right, give me more I deser...&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?he&quot;]) + &quot; gets cut off by your continual pounding of &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; ass.&quot;)&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_anal5;&lt;&lt;button &quot;Slap&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;anal&quot;, 85)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;As you are drilling &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet pussy you slap &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + 
                &quot; across  the face.&quot;
            ]&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Ow what the fuck! That fucking hurt!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Oh my god yes! Punish me! Slap me more like a little whore!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_anal6;&lt;&lt;button &quot;Spank&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;anal&quot;, 70)&gt;&gt;
            &lt;&lt;set _responses = [$player.dialogue(either([
                &quot;You\&#39;re such a bad little whore.&quot;,
                &quot;You\&#39;ve been naughty and need to be punished.&quot;,
            ]))]&gt;&gt;
            &lt;&lt;set _responses.push(
                &quot;You start spanking &quot; + setup.titleCase(_char.first_name) + &quot; ass until it\&#39;s red,&quot;
            )&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Ow! Stop that hurts!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Oh my god yes! Punish me!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_anal_vaginal;&lt;&lt;button &quot;Oral sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You take your &quot; + _cock + &quot; out of &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s asshole and pull &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + 
                _char.physical_traits.hair_color + &quot; hair to line up &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; head, but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; clearly tries to pull way, not fond of the idea of giving you a blowjob.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;oral&quot;, 40, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s juices into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face, but being a cumslut, &quot; + setup.PRONOUNS[_char.gender][&quot;?she&quot;] + &quot; looks \
                            forward to being filled with your cum.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face as you start to orally rape &quot; +
                            setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.oral -= 1&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as your precum touches their tongue. As \
                            a cumslut they are gushing wet just thinking about your cum.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please give me your cum; I want to bath and be filled with it!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; takes in your &quot; + _cock + &quot; with hunger in &quot; + 
                            setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 3&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s juices into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face, but being a cumslut, &quot; + setup.PRONOUNS[_char.gender][&quot;?she&quot;] + &quot; looks \
                                forward to being filled with your cum.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face as you start to orally rape &quot; +
                                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                            &lt;&lt;set _char.sex_prefs.oral -= 1&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as your precum touches their tongue. As \
                                a cumslut they are gushing wet just thinking about your cum.&quot;)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(&quot;Please give me your cum; I want to bath and be filled with it!&quot;))&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; takes in your &quot; + _cock + &quot; with hunger in &quot; + 
                                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 3&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/repeat&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_anal_anal;&lt;&lt;button &quot;Vaginal sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You pull your &quot; + _cock + &quot; out of &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s asshole and line it up with &quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;vaginal&quot;, 50, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s anal juices into &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; wet pussy.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Anything but that! Please!...&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
                    &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                    &lt;&lt;set _char.slave_traits.trust -= 7&gt;&gt;
                    &lt;&lt;set _char.sex_prefs.vaginal -= 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck me!&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;set _open_menu = &quot;#sex_vaginal_actions&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.last_action = &quot;vaginal&quot;&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s anal juices into &quot; + 
                        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; wet pussy.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Anything but that! Please!...&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 7&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.vaginal -= 1&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck me!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;set _open_menu = &quot;#sex_vaginal_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;vaginal&quot;&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@

    &lt;div style=&quot;grid-row: 4; grid-column: 2&quot;&gt;
    @@#sex_anal_back;&lt;&lt;button &quot;Back&quot;&gt;&gt;
        &lt;&lt;run setup.mainLog_append_delayed([&quot;You take your &quot; + _cock + &quot; out of &quot; + 
            setup.titleCase(_char.first_name) + &quot;\&#39;s ass.&quot;])&gt;&gt;
        &lt;&lt;removeclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 3&quot;&gt;
    @@#sex_anal_done;&lt;&lt;button &quot;Done&quot; `passage()`&gt;&gt;
        &lt;&lt;if _sex_state.orgasm&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties.&lt;br&gt;&quot; + _char.dialogue(&quot;That was great, let\&#39;s do that again sometime...&quot;) + 
                &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection &quot; + setup.show_change_html(0, 5) + &quot;)&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += 5&gt;&gt;
        &lt;&lt;elseif _char.mental_conditions.arousal gt 20 &amp;&amp; _char.mental_conditions.discomfort lt _char.mental_conditions.arousal&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] +
                &quot; found the experience quite pleasurable (&quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, (_char.mental_conditions.arousal - _char.mental_conditions.discomfort) / 10) + &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += (_char.mental_conditions.arousal - _char.mental_conditions.discomfort) / 10&gt;&gt;
        &lt;&lt;elseif _char.mental_conditions.discomfort gt _char.mental_conditions.arousal&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] +
                &quot; did not find the experience pleasurable (&quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, _char.mental_conditions.arousal - _char.mental_conditions.discomfort) + &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += (_char.mental_conditions.arousal - _char.mental_conditions.discomfort)&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties.&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        /* Re-enable menu */
        &lt;&lt;set $enable_menu = true&gt;&gt;
        &lt;&lt;set $to_simulate.add(_char.key)&gt;&gt;
        /* Last round for good measure */
        &lt;&lt;set _to_round = _char.key&gt;&gt;
        &lt;&lt;include round&gt;&gt;
        &lt;&lt;run _get_changes()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;#sex_anal_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
        var self = $(event.currentTarget);
        if (self.html() != &quot;Back&quot; &amp;&amp; self.html() != &quot;Done&quot;) {
            let _t = State.temporary;
            let char = _t.char;
            let player = State.variables.player;
            _t.to_round = _t.char.key;
            $.wiki(&quot;&lt;&lt;include round&gt;&gt;&quot;);
            $.wiki(&quot;&lt;&lt;include updateBars&gt;&gt;&quot;);
        }
    });
&lt;&lt;/script&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="17" name="sexCumActions" tags="" position="850,225" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;sex_cum_actions&quot; class=&quot;action container row col longbutton fiveQuarters smalltext&quot;
         style=&quot;--rows: 4; --cols: 4&quot;&gt;

        @@#sex_cum1;&lt;&lt;button &quot;On ground&quot;&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You pull back and cum all over the ground. &quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#sex_cum2;&lt;&lt;button &quot;On face&quot;&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;cum&quot;, 100)&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You cum all over &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face. &quot;&gt;&gt;
            &lt;&lt;if _thresh gt 0&gt;&gt;

            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _char.sex_fetishes.cum += 1&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#sex_cum3;&lt;&lt;button &quot;In mouth&quot;&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;cum&quot;, 100)&gt;&gt;
             &lt;&lt;if _thresh gt 0&gt;&gt;
            
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _char.sex_fetishes.cum += 1&gt;&gt;
                &lt;&lt;set _char.mental_conditions.cum_addition += 1&gt;&gt;
            &lt;&lt;/if&gt;&gt;            
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;disable&gt;&gt;
        @@#sex_cum4;&lt;&lt;button &quot;In throat&quot;&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;cum&quot;, 100)&gt;&gt;
             &lt;&lt;if _thresh gt 0&gt;&gt;
            
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _char.sex_fetishes.cum += 1&gt;&gt;
                &lt;&lt;set _char.mental_conditions.cum_addition += 1&gt;&gt;
            &lt;&lt;/if&gt;&gt;            
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#sex_cum5;&lt;&lt;button &quot;In pussy&quot;&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You cum directly into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s pussy. &quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;&lt;&lt;disable&gt;&gt;
        @@#sex_cum6;&lt;&lt;button &quot;In ass&quot;&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You cum directly into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s ass. &quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;

    &lt;/div&gt;

    &lt;&lt;for _i = 1; _i lte 6; _i++&gt;&gt;
        &lt;&lt;set _sex_buttons.push(&quot;#sex_cum&quot; + _i)&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    &lt;&lt;timed 50ms&gt;&gt;
        &lt;&lt;if _sex_state.last_action == &quot;oral&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#sex_cum4 button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#sex_cum4 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
        &lt;&lt;elseif _sex_state.last_action == &quot;vaginal&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#sex_cum5 button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#sex_cum5 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
        &lt;&lt;elseif _sex_state.last_action == &quot;anal&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#sex_cum6 button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#sex_cum6 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;script&gt;&gt;
            $(&quot;#sex_cum_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, () =&gt; {
                let _t = State.temporary;
                let _v = State.variables;
                let char = _t.char;
                let sex_state = _t.sex_state;
                let player = _v.player;
                if (sex_state.orgasm) {
                    _v._temp_to_log += &quot;You leave &quot; + setup.titleCase(char.first_name) + &quot; to &quot; + 
                        setup.PRONOUNS[char.gender][&quot;?his&quot;] + &quot; duties.&lt;br&gt;&quot; + char.dialogue(&quot;That was great, let\&#39;s do that again sometime...&quot;) + 
                        &quot;(&quot; + setup.titleCase(char.first_name) + &quot;\&#39;s Affection &quot; + setup.show_change_html(0, 5) + &quot;)&quot;;
                    char.slave_traits.obedience += 5;
                } else if (char.mental_conditions.arousal &gt; 20 &amp;&amp; char.mental_conditions.discomfort &lt; char.mental_conditions.arousal) {
                    _v._temp_to_log += &quot;You leave &quot; + setup.titleCase(char.first_name) + &quot; to &quot; + 
                        setup.PRONOUNS[char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[char.gender][&quot;?he&quot;] +
                        &quot; found the experience quite pleasurable (&quot; + setup.titleCase(char.first_name) + 
                        &quot;\&#39;s Affection &quot; + setup.show_change_html(0, (char.mental_conditions.arousal - char.mental_conditions.discomfort) / 10) + &quot;).&quot;;
                    char.slave_traits.obedience += (char.mental_conditions.arousal - char.mental_conditions.discomfort) / 10;
                } else if (char.mental_conditions.discomfort &gt; char.mental_conditions.arousal) {
                    _v._temp_to_log += &quot;You leave &quot; + setup.titleCase(char.first_name) + &quot; to &quot; + 
                        setup.PRONOUNS[char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[char.gender][&quot;?he&quot;] +
                        &quot; did not find the experience pleasurable (&quot; + setup.titleCase(char.first_name) + 
                        &quot;\&#39;s Affection &quot; + setup.show_change_html(0, char.mental_conditions.arousal - char.mental_conditions.discomfort) + &quot;).&quot;;
                    char.slave_traits.obedience += (char.mental_conditions.arousal - char.mental_conditions.discomfort);
                } else {
                    _v._temp_to_log += &quot;You leave &quot; + setup.titleCase(char.first_name) + &quot; to &quot; + 
                        setup.PRONOUNS[char.gender][&quot;?his&quot;] + &quot; duties.&quot;;
                }
                player.mental_conditions.arousal = 0;
                _v.enable_menu = true;
                _v.to_simulate.add(char.key);
                _t.to_round = char.key;
                $.wiki(&quot;&lt;&lt;include round&gt;&gt;&quot;);
                _t.get_changes();
                $.wiki(&quot;&lt;&lt;goto `passage()`&gt;&gt;&quot;);
            });
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="18" name="sexInfo" tags="" position="975,225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;sex_info&quot; class=&quot;subbackground hidden&quot; style=&quot;grid-row: 1 / span 3; grid-column: 4 / span 1&quot;&gt;
    &lt;div class=&quot;container threeRow&quot; style=&quot;font-weight: normal; height: 100%; width: 100%&quot;&gt;
        &lt;center&gt;
            &lt;h3 style=&quot;margin-bottom:0&quot;&gt;&lt;&lt;= setup.locations.get(passage()).name&gt;&gt;&lt;/h3&gt;
            &lt;p style=&quot;margin: 0&quot;&gt;
                &lt;&lt;= setup.locations.get_sub_address(passage())&gt;&gt;
            &lt;/p&gt;
            &lt;br&gt;
            &lt;div id=&quot;sex_datetime&quot;&gt;
                &lt;&lt;time12hr&gt;&gt;
                &lt;br&gt;
                &lt;&lt;date&gt;&gt;
            &lt;/div&gt;
        &lt;/center&gt;

        &lt;center style=&quot;padding: 20px&quot;&gt;
            &lt;strong id=&quot;sex_info_name&quot;&gt;&lt;/strong&gt;
            &lt;div id=&quot;sex_bars&quot;&gt;&lt;/div&gt;
            &lt;strong&gt;&lt;&lt;= setup.titleCase($player.first_name)&gt;&gt;&lt;/strong&gt;
            &lt;div id=&quot;sex_player_bars&quot;&gt;
                &lt;&lt;showmeter &quot;player_arousal_bar&quot; `$player.mental_conditions.arousal/50`&gt;&gt;
            &lt;/div&gt;
        &lt;/center&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="19" name="sexOralActions" tags="" position="1100,225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;sex_oral_actions&quot; class=&quot;action container row col longbutton fiveQuarters smalltext hidden&quot;
    style=&quot;--rows: 4; --cols: 4&quot;&gt;

    @@#sex_oral1;&lt;&lt;button &quot;Continue&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;oral&quot;, 40)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You continue fucking &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face. As you thrust in and out \
                saliva drips from her mouth,&quot;
            ]&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(either([
                    &quot;Hurk... ack... Please... ack... stop... please...&quot;,
                    &quot;I can\&#39;t... ack... breath... stop...&quot;,
                ])))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 2&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 3&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 2&gt;&gt;
                &lt;&lt;set _char.slave_traits.trust -= 0.5&gt;&gt;
                &lt;&lt;set _char.sex_prefs.oral -= 0.5&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(either([
                    &quot;MMmmmm, you taste so good!&quot;,
                    &quot;I love choking on your cock!&quot;,
                    &quot;Mmmm... ack... don\&#39;t... hurk... stop...&quot;
                ])))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_oral2;&lt;&lt;button &quot;Deep throat&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;oral&quot;, 75)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You push &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s head all the way to the base of your &quot; + _cock + &quot; and \
                hold &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; down.&quot;
            ]&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(either([
                    &quot;Hurk... ack... Please... ack... stop... please...&quot;,
                    &quot;I can\&#39;t... ack... breath... stop...&quot;,
                ])))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 7&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                &lt;&lt;set _char.sex_prefs.oral -= 2&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(either([
                    &quot;MMmmmm, you taste so good!&quot;,
                    &quot;I love choking on your cock!&quot;,
                    &quot;Mmmm... ack... don\&#39;t... hurk... stop...&quot;
                ])))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set $player.mental_conditions.arousal += 15&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_oral3;&lt;&lt;button &quot;Insult&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;oral&quot;, 45)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You continue thrusting into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s mouth.&quot;
            ]&gt;&gt;
            &lt;&lt;set _responses.push($player.dialogue(either([
                &quot;You\&#39;re such a fucking disgusting little whore.&quot;,
                &quot;You little bitch aren\&#39;t worth anything except a little piece of shit for me to fuck.&quot;,
                &quot;Take it you fucking cunt.&quot;,
                &quot;I bet this is the only reason anyone keeps you around, you fucking shit.&quot;,
                &quot;You\&#39;re nothing just a little fuck toy aren\&#39;t you?&quot;
            ])))&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(&quot;You can tell from the tears forming in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s eyes that \
                    you went too far.&quot;)&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;What the fu...&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Yeah, that\&#39;s rig...&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?he&quot;]) + &quot; gets cut off by your continual pounding of &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; wet pussy.&quot;)&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_oral4;&lt;&lt;button &quot;Spit in mouth&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;oral&quot;, 50)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You momentarily take your &quot; + _cock + &quot; out of &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s mouth and spit into it.&quot;
            ]&gt;&gt;
            &lt;&lt;set _responses.push($player.dialogue(either([
                &quot;Drink my fucking spit you ugly pig.&quot;,
                &quot;You like that you disgusting piece of shit?&quot;,
                &quot;You\&#39;re nothing, just a piece of trash to spit and cum on.&quot;
            ])))&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(&quot;You can tell from the tears forming in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s eyes that \
                    you went too far.&quot;)&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;What the fu...&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Yeah, that\&#39;s right, give me more I deser...&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?he&quot;]) + &quot; gets cut off by you shoving your &quot; + _cock + 
                &quot; back into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth.&quot;)&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_oral5;&lt;&lt;button &quot;Slap&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;oral&quot;, 55)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;As you are face fucking &quot; + setup.titleCase(_char.first_name) + &quot;, you slap &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + 
                &quot; across the face.&quot;
            ]&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Ow what the fuck! That fucking hurt!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Oh my god yes! Punish me! Slap me more like a little whore!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_oral6;&lt;&lt;button &quot;Spank&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;set _thresh = _calc_thresh(&quot;oral&quot;, 45)&gt;&gt;
            &lt;&lt;set _responses = [$player.dialogue(either([
                &quot;You\&#39;re such a bad little whore.&quot;,
                &quot;You\&#39;ve been naughty and need to be punished.&quot;,
            ]))]&gt;&gt;
            &lt;&lt;set _responses.push(
                &quot;You start spanking &quot; + setup.titleCase(_char.first_name) + &quot; ass until it\&#39;s red,&quot;
            )&gt;&gt;
            &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Ow! Stop that hurts!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses.push(_char.dialogue(&quot;Oh my god yes! Punish me!&quot;))&gt;&gt;
                &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;run _check_arousal()&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_oral_vaginal;&lt;&lt;button &quot;Vaginal sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You pull your &quot; + _cock + &quot; out of &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s mouth and line it up with &quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;vaginal&quot;, 50, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s saliva into &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; wet pussy.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Anything but that! Please!...&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
                    &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                    &lt;&lt;set _char.slave_traits.trust -= 7&gt;&gt;
                    &lt;&lt;set _char.sex_prefs.vaginal -= 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck me!&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;set _open_menu = &quot;#sex_vaginal_actions&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.last_action = &quot;vaginal&quot;&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s saliva into &quot; + 
                        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; wet pussy.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Anything but that! Please!...&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 7&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.vaginal -= 1&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck me!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;set _open_menu = &quot;#sex_vaginal_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;vaginal&quot;&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_oral_anal;&lt;&lt;button &quot;Anal sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 5&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You grab your &quot; + _cock + &quot; out of &quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s mouth and line it up with &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; asshole.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;anal&quot;, 65, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s saliva into &quot; +
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tight asshole.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Not my ass, it hurts so much! Please!...&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 20&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
                    &lt;&lt;set _char.slave_traits.obedience -= 20&gt;&gt;
                    &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
                    &lt;&lt;set _char.sex_prefs.anal -= 2&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck my ass!&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 8&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 15&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;set _open_menu = &quot;#sex_anal_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;anal&quot;&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s saliva into &quot; +
                        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tight asshole.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Not my ass, it hurts so much! Please!...&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 20&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 20&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.anal -= 2&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck my ass!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 8&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 15&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;set _open_menu = &quot;#sex_anal_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;anal&quot;&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@

    &lt;div style=&quot;grid-row: 4; grid-column: 2&quot;&gt;
    @@#sex_oral_back;&lt;&lt;button &quot;Back&quot;&gt;&gt;
        &lt;&lt;run setup.mainLog_append_delayed([&quot;You take your &quot; + _cock + &quot; out of &quot; + 
            setup.titleCase(_char.first_name) + &quot;\&#39;s mouth.&quot;])&gt;&gt;
        &lt;&lt;removeclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 3&quot;&gt;
    @@#sex_oral_done;&lt;&lt;button &quot;Done&quot; `passage()`&gt;&gt;
        &lt;&lt;if _sex_state.orgasm&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties.&lt;br&gt;&quot; + _char.dialogue(&quot;That was great, let\&#39;s do that again sometime...&quot;) + 
                &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection &quot; + setup.show_change_html(0, 5) + &quot;)&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += 5&gt;&gt;
        &lt;&lt;elseif _char.mental_conditions.arousal gt 20 &amp;&amp; _char.mental_conditions.discomfort lt _char.mental_conditions.arousal&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] +
                &quot; found the experience quite pleasurable (&quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, (_char.mental_conditions.arousal - _char.mental_conditions.discomfort) / 10) + &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += (_char.mental_conditions.arousal - _char.mental_conditions.discomfort) / 10&gt;&gt;
        &lt;&lt;elseif _char.mental_conditions.discomfort gt _char.mental_conditions.arousal&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] +
                &quot; did not find the experience pleasurable (&quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, _char.mental_conditions.arousal - _char.mental_conditions.discomfort) + &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += (_char.mental_conditions.arousal - _char.mental_conditions.discomfort)&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties.&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        /* Re-enable menu */
        &lt;&lt;set $enable_menu = true&gt;&gt;
        &lt;&lt;set $to_simulate.add(_char.key)&gt;&gt;
        /* Last round for good measure */
        &lt;&lt;set _to_round = _char.key&gt;&gt;
        &lt;&lt;include round&gt;&gt;
        &lt;&lt;run _get_changes()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;



&lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;#sex_oral_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
        var self = $(event.currentTarget);
        if (self.html() != &quot;Back&quot; &amp;&amp; self.html() != &quot;Done&quot;) {
            let _t = State.temporary;
            let char = _t.char;
            let player = State.variables.player;
            _t.to_round = _t.char.key;
            $.wiki(&quot;&lt;&lt;include round&gt;&gt;&quot;);
            $.wiki(&quot;&lt;&lt;include updateBars&gt;&gt;&quot;);
        }
    });
&lt;&lt;/script&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="20" name="sexRejectionActions" tags="" position="1225,225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;sex_rejection_actions&quot; class=&quot;action container row col longbutton fiveQuarters smalltext hidden&quot;
    style=&quot;--rows: 4; --cols: 4&quot;&gt;

    @@#sexRejection1;&lt;&lt;button &quot;Nevermind&quot;&gt;&gt;
        &lt;&lt;set _rejection_response = false&gt;&gt;
        &lt;&lt;set _responses = [
            $player.dialogue(&quot;Nevermind.&quot;)
        ]&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
     @@#sexRejection2;&lt;&lt;button &quot;Convince&quot;&gt;&gt;
        &lt;&lt;set _roll = dice(1, $player.stats.manipulation + $difficulty) - $difficulty&gt;&gt;
        &lt;&lt;if _roll gt _thresh&gt;&gt;
            &lt;&lt;set _rejection_response = true&gt;&gt;
            &lt;&lt;set _responses = [
                setup.pass(&quot;manipulation&quot;),
                $player.dialogue(&quot;Come on... it\&#39;s me...&quot;),
                _char.dialogue(&quot;Hm... okay... you\&#39;ve convinced me.&quot;)
            ]&gt;&gt;
            &lt;&lt;set _sex_state.boundaries[_action] = true&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _rejection_response = false&gt;&gt;
            &lt;&lt;if _sex_state.convince_num == 0&gt;&gt;
                &lt;&lt;set _responses = [
                    setup.fail(&quot;manipulation&quot;),
                    $player.dialogue(&quot;Come on... it\&#39;s me...&quot;)
                ]&gt;&gt;
                &lt;&lt;if _is_fucking&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;No... maybe next time, but not right now.&quot;))&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Are you joking?&quot;))&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;elseif _sex_state.convince_num == 1&gt;&gt;
                &lt;&lt;set _responses = [
                    setup.fail(&quot;manipulation&quot;),
                    $player.dialogue(&quot;Come on... it\&#39;s me...&quot;),
                    _char.dialogue(&quot;Stop trying to push my boundaries.&quot;),
                    &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Anger &quot; + setup.show_change_html(0, 3, false) + 
                    &quot;, Willpower &quot; + setup.show_change_html(0, 1, false) + &quot;).&quot;
                ]&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 3&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower += 1&gt;&gt;
            &lt;&lt;elseif _sex_state.convince_num == 2&gt;&gt;
                &lt;&lt;set _responses = [
                    setup.fail(&quot;manipulation&quot;),
                    $player.dialogue(&quot;Come on... it\&#39;s me...&quot;),
                    _char.dialogue(&quot;I told you to quit pushing me, I\&#39;m warning you.&quot;),
                    &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Anger &quot; + setup.show_change_html(0, 5, false) + 
                    &quot;, Willpower &quot; + setup.show_change_html(0, 4, false) + &quot;).&quot;
                ]&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower += 4&gt;&gt;
            &lt;&lt;elseif _sex_state.convince_num gt 2&gt;&gt;
                &lt;&lt;set $_temp_to_log = _char.dialogue(&quot;Get the fuck away from me!&quot;) + 
                    setup.titleCase(_char.first_name) + &quot; pushes you and walks away (&quot; + setup.titleCase(_char.first_name) + 
                    &quot;\&#39;s Anger &quot; + setup.show_change_html(0, 10, false) + 
                    &quot;, Willpower &quot; + setup.show_change_html(0, 6, false) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                &lt;&lt;set _char.slave_traits.willpower += 6&gt;&gt;
                /* Re-enable menu */
                &lt;&lt;set $enable_menu = true&gt;&gt;
                /* Last round for good measure */
                &lt;&lt;set _to_round = _char.key&gt;&gt;
                &lt;&lt;include round&gt;&gt;
                &lt;&lt;goto `passage()`&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _sex_state.convince_num += 1&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sexRejection3;&lt;&lt;button &quot;Use Force&quot;&gt;&gt;
        &lt;&lt;if _higher_status&gt;&gt;
            &lt;&lt;set _sex_state.rape = true&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You look &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; dead in the eyes, reminding &quot; +
                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; of your status. Tears weld up in &quot; +
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes as &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; sinks down and complies (&quot; + 
                setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -15) + 
                &quot;, Anger &quot; + setup.show_change_html(0, 20, false) + 
                &quot;, Fear &quot; + setup.show_change_html(0, 10) +
                &quot;, Willpower &quot; + setup.show_change_html(0, -10, false) + &quot;).&quot;
            ]&gt;&gt;
            &lt;&lt;set _rejection_response = true&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _roll = $player.stats.strength + dice(1, 6 + $difficulty) - $difficulty&gt;&gt;
            &lt;&lt;if _roll - _char.stats.strength gte 15&gt;&gt;
                &lt;&lt;set _sex_state.rape = true&gt;&gt;
                &lt;&lt;set _responses = [
                    &quot;You quickly overpower &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; making it obvious that if &quot; +
                    setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; resisted anymore it would put &quot; +
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; life in danger (&quot; + 
                    setup.titleCase(_char.first_name) + 
                    &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -15) + 
                    &quot;, Anger &quot; + setup.show_change_html(0, 20, false) + 
                    &quot;, Fear &quot; + setup.show_change_html(0, 10) +
                    &quot;, Willpower &quot; + setup.show_change_html(0, -10, false) + &quot;).&quot;
                ]&gt;&gt;
                &lt;&lt;set _rejection_response = true&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;set $_temp_to_log = 
                    setup.fail(&quot;strength&quot;) + 
                    &quot;You try to pin &quot; + setup.titleCase(_char.first_name) + &quot; down, but &quot; + 
                    setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; overpowers you in an instant.&lt;br&gt;&quot; +
                    _char.dialogue(&quot;You fucking piece of garbage, let me show you what happens \
                        when you try something on me.&quot;) +
                    setup.titleCase(_char.first_name) + &quot; proceeds to crush you and kick you in the \
                    genitals. After what seems like forever &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; \
                    shoves you away &quot; +
                    &quot;(Health &quot; + setup.show_change_html(0, -20) + 
                    &quot;, Willpower &quot; + setup.show_change_html(0, -10) + &quot;) &quot; + 
                    &quot;(&quot; + setup.titleCase(_char.first_name) + 
                    &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -15) + 
                    &quot;, Anger &quot; + setup.show_change_html(0, 20, false) + 
                    &quot;, Trust &quot; + setup.show_change_html(0, -15) + &quot;).&quot;
                &gt;&gt;
                &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;set $player.conditions.health -= 20&gt;&gt;
                &lt;&lt;set $player.slave_traits.willpower -= 10&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
                /* Do not induce fear */
                &lt;&lt;if _char.slave_traits.trust gt 0&gt;&gt;
                    &lt;&lt;set _char.slave_traits.trust = Math.clamp(_char.slave_traits.trust - 15, 0, 100)&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                /* Re-enable menu */
                &lt;&lt;set $enable_menu = true&gt;&gt;
                /* Last round for good measure */
                &lt;&lt;set _to_round = _char.key&gt;&gt;
                &lt;&lt;include round&gt;&gt;
                &lt;&lt;run _get_changes()&gt;&gt;
                &lt;&lt;goto `passage()`&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;if _rape&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience -= 15&gt;&gt;
            &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 10&gt;&gt;
            &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
            &lt;&lt;set _char.mental_conditions.suspicion = 100&gt;&gt;
            &lt;&lt;set _to_round = _char.key&gt;&gt;
            &lt;&lt;include round&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
&lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;#sex_rejection_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
        let _t = State.temporary;
        setup.mainLog_append_delayed(_t.responses, _t.sex_buttons);
        let loop = () =&gt; {
            setTimeout(() =&gt; {
                if (_t.done_appending != &quot;undefined&quot; &amp;&amp; _t.done_appending) {
                    _t.rejection_processed = true;
                    $(_t.open_menu).removeClass(&quot;hidden&quot;);
                    $(&quot;#sex_rejection_actions&quot;).addClass(&quot;hidden&quot;);
                    delete _t.action;
                } else {
                    loop();
                }
            }, 20);
        };
        loop();
    });
&lt;&lt;/script&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="21" name="sexRejectionEngine" tags="" position="100,350" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Hide sex actions and show UI */
&lt;&lt;removeclass &quot;#sex_rejection_actions&quot; &quot;hidden&quot;&gt;&gt;
&lt;&lt;addclass _open_menu &quot;hidden&quot;&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="22" name="sexEngine" tags="" position="225,350" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _char = $characters[$selected]&gt;&gt;
/* Preround for bars */
&lt;&lt;set _to_round = _char.key&gt;&gt;
&lt;&lt;include round&gt;&gt;

/* Presex copy of character for assessing changes */
&lt;&lt;set _prechar = clone(_char)&gt;&gt;

/* Disable menu */
&lt;&lt;set $enable_menu = false&gt;&gt;

/* Show sex ui and atune to character */
&lt;&lt;run $(&quot;#action_bar&quot;).wiki(&quot;&lt;&lt;include sexActions&gt;&gt;&quot;)&gt;&gt;
&lt;&lt;set _open_menu = &quot;#sex_actions&quot;&gt;&gt;
&lt;&lt;removeclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;

&lt;&lt;run $(&quot;#sex_info_name&quot;).html(setup.titleCase(_char.first_name))&gt;&gt;
&lt;&lt;run $(&quot;#sex_bars&quot;).wiki(&quot;\
    &lt;&lt;showmeter \&quot;char_anger_bar\&quot; `_char.mental_conditions.anger/100`&gt;&gt;\
    &lt;&lt;showmeter \&quot;char_arousal_bar\&quot; `_char.mental_conditions.arousal/50`&gt;&gt;\
    &lt;&lt;showmeter \&quot;char_discomfort_bar\&quot; `_char.mental_conditions.discomfort/50`&gt;&gt;\
    &lt;&lt;showmeter \&quot;char_stamina_bar\&quot; `_char.conditions.stamina/_char.conditions.max_stamina`&gt;&gt;\
    &lt;&lt;showmeter \&quot;char_willpower_bar\&quot; `_char.slave_traits.willpower/100`&gt;&gt;\
&quot;)&gt;&gt;
&lt;&lt;run $(&quot;#sex_player_bars&quot;).wiki(&quot;\
    &lt;&lt;showmeter \&quot;player_stamina_bar\&quot; `$player.conditions.stamina/$player.conditions.max_stamina`&gt;&gt;\
&quot;)&gt;&gt;
&lt;&lt;removeclass &quot;#sex_info&quot; &quot;hidden&quot;&gt;&gt;

/* Whether player is higher status than player */
&lt;&lt;set _higher_status = ($player.get_status(&quot;nipon&quot;) == &quot;slave&quot; &amp;&amp; _char.status == &quot;low_slave&quot;) ||
    ($player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot; &amp;&amp; _char.status == &quot;slave&quot;) || 
    ($player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot; &amp;&amp; _char.status == &quot;low_slave&quot;)&gt;&gt;

/* Cock for male, strap-on for female */
&lt;&lt;set _cock = &quot;cock&quot;&gt;&gt;
&lt;&lt;if $player.gender == 1&gt;&gt;
    &lt;&lt;set _cock = &quot;strap-on&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;set _char_cock = &quot;cock&quot;&gt;&gt;
&lt;&lt;if _char.gender == 1&gt;&gt;
    &lt;&lt;set _char_cock = &quot;strap-on&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;set _chest = &quot;chest&quot;&gt;&gt;
&lt;&lt;if $player.gender == 1&gt;&gt;
    &lt;&lt;set _chest = &quot;boobs&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;set _char_chest = &quot;chest&quot;&gt;&gt;
&lt;&lt;if _char.gender == 1&gt;&gt;
    &lt;&lt;set _char_chest = &quot;boobs&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Whether the sex as started */
&lt;&lt;set _is_fucking = false&gt;&gt;

&lt;&lt;set _sex_state = {
    &quot;rape&quot;: false,
    &quot;top&quot;: true,
    &quot;bottom&quot;: true,
    &quot;convince_num&quot;: 0,
    &quot;boundaries&quot;: {
        &quot;kiss&quot;: false,
        &quot;fondel&quot;: false,
        &quot;finger&quot;: false,
        &quot;lick&quot;: false,
        &quot;footjob&quot;: false,
        &quot;oral&quot;: false,
        &quot;vaginal&quot;: false,
        &quot;anal&quot;: false
    },
    &quot;orgasm&quot;: false,
    &quot;last_action&quot;: &quot;none&quot;
}&gt;&gt;

/* TODO: Implement for males */

/* Initial prompt for user action */
&lt;&lt;set _responses = [&quot;You approach &quot; + setup.titleCase(_char.first_name) + &quot; with a lustful look in your eye,&quot;]&gt;&gt;
&lt;&lt;run setup.mainLog_append_delayed(_responses)&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="23" name="sexVaginalActions" tags="" position="350,350" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;sex_vaginal_actions&quot; class=&quot;action container row col longbutton fiveQuarters smalltext hidden&quot;
    style=&quot;--rows: 4; --cols: 4&quot;&gt;

    @@#sex_vaginal1;&lt;&lt;button &quot;Continue&quot;&gt;&gt;
        &lt;&lt;set _thresh = _calc_thresh(&quot;vaginal&quot;, 50)&gt;&gt;
        &lt;&lt;set _responses = [
            &quot;You continue fucking &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet pussy. As you thrust in and out \
            the air fills with a scent of opulent lewdness.&quot;
        ]&gt;&gt;
        &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(either([
                &quot;Please stop it! It hurts so mu...&quot;,
                &quot;I beg you to stop! I promise I\&#39;ll be a better sla...&quot;,
            ])))&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s begging is interrupted by a moan.&quot;)&gt;&gt;
            &lt;&lt;set _char.mental_conditions.anger += 2&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 2&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience -= 2&gt;&gt;
            &lt;&lt;set _char.slave_traits.trust -= 0.5&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(either([
                &quot;Yes yes yes yes yes, don\&#39;t stop!!&quot;,
                &quot;Fuck me harder!&quot;,
                &quot;Give it to me, please fill me up!&quot;
            ])))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
        &lt;&lt;run _check_arousal()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_vaginal2;&lt;&lt;button &quot;Choke&quot;&gt;&gt;
        &lt;&lt;set _thresh = _calc_thresh(&quot;vaginal&quot;, 55)&gt;&gt;
        &lt;&lt;set _responses = [
            &quot;As you continue fucking &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s pussy, you put your hands around &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + 
            &quot; neck restricting &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; breath.&quot;
        ]&gt;&gt;
        &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s face grows red and tears stream down &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                &quot; cheek,&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(either([
                &quot;What the fuck! Let go of me!&quot;,
                &quot;It hurts! It hurts!!&quot;,
                &quot;Just fucking kill me already please just end it, choke me to death right here.&quot;
            ])))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
            &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
            &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
            &lt;&lt;set _char.sex_prefs.vaginal -= 0.5&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot;\&#39;s face grows red and &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
                &quot; eyes roll back in bliss,&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(either([
                &quot;Yes! Choke me daddy, harder!&quot;,
                &quot;Fuck me harder!&quot;,
                &quot;Ack... Fuck... Keep going.&quot;,
                &quot;Ahhh fuck that\&#39;s so good!&quot;
            ])))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
        &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
        &lt;&lt;run _check_arousal()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_vaginal3;&lt;&lt;button &quot;Insult&quot;&gt;&gt;
        &lt;&lt;set _thresh = _calc_thresh(&quot;vaginal&quot;, 60)&gt;&gt;
        &lt;&lt;set _responses = [
            &quot;You continue thrusting &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s pussy.&quot;
        ]&gt;&gt;
        &lt;&lt;set _responses.push($player.dialogue(either([
            &quot;You\&#39;re such a fucking disgusting little whore.&quot;,
            &quot;You little bitch aren\&#39;t worth anything except a little piece of shit for me to fuck.&quot;,
            &quot;Take it you fucking cunt.&quot;,
            &quot;I bet this is the only reason anyone keeps you around, you fucking shit.&quot;,
            &quot;You\&#39;re nothing just a little fuck toy aren\&#39;t you?&quot;
        ])))&gt;&gt;
        &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
            &lt;&lt;set _responses.push(&quot;You can tell from the tears forming in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s eyes that \
                you went too far.&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;What the fu...&quot;))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
            &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;Yeah, that\&#39;s right, ahhhh!&quot;))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?he&quot;]) + &quot; gets cut off by your continual pounding of &quot; + 
            setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; wet pussy.&quot;)&gt;&gt;
        &lt;&lt;run _check_arousal()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_vaginal4;&lt;&lt;button &quot;Spit in mouth&quot;&gt;&gt;
        &lt;&lt;set _thresh = _calc_thresh(&quot;anal&quot;, 65)&gt;&gt;
        &lt;&lt;set _responses = [
            &quot;As you continue thrusting in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet pussy, you force open &quot; + 
            setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth and spit into it.&quot;
        ]&gt;&gt;
        &lt;&lt;set _responses.push($player.dialogue(either([
            &quot;Drink my fucking spit you ugly pig.&quot;,
            &quot;You like that you disgusting piece of shit?&quot;,
            &quot;You\&#39;re nothing, just a piece of trash to spit and cum on.&quot;
        ])))&gt;&gt;
        &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
            &lt;&lt;set _responses.push(&quot;You can tell from the tears forming in &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s eyes that \
                you went too far.&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;What the fu...&quot;))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
            &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;Yeah, that\&#39;s right, give me more I deser...&quot;))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _responses.push(setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?he&quot;]) + &quot; gets cut off by your continual pounding of &quot; + 
            setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; vagina.&quot;)&gt;&gt;
        &lt;&lt;run _check_arousal()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_vaginal5;&lt;&lt;button &quot;Slap&quot;&gt;&gt;
        &lt;&lt;set _thresh = _calc_thresh(&quot;anal&quot;, 85)&gt;&gt;
        &lt;&lt;set _responses = [
            &quot;As you are drilling &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet pussy you slap &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + 
            &quot; across  the face.&quot;
        ]&gt;&gt;
        &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;Ow what the fuck! That fucking hurt!&quot;))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
            &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;Oh my god yes! Punish me! Slap me more like a little whore!&quot;))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;run _check_arousal()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_vaginal6;&lt;&lt;button &quot;Spank&quot;&gt;&gt;
        &lt;&lt;set _thresh = _calc_thresh(&quot;vaginal&quot;, 55)&gt;&gt;
        &lt;&lt;set _responses = [$player.dialogue(either([
            &quot;You\&#39;re such a bad little whore.&quot;,
            &quot;You\&#39;ve been naughty and need to be punished.&quot;,
        ]))]&gt;&gt;
        &lt;&lt;set _responses.push(
            &quot;You start spanking &quot; + setup.titleCase(_char.first_name) + &quot; ass until it\&#39;s red,&quot;
        )&gt;&gt;
        &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;Ow! Stop that hurts!&quot;))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.anger += 5&gt;&gt;
            &lt;&lt;set _char.mental_conditions.discomfort += 5&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience -= 5&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _responses.push(_char.dialogue(&quot;Oh my god yes! Punish me!&quot;))&gt;&gt;
            &lt;&lt;set _char.mental_conditions.arousal += 7&gt;&gt;
            &lt;&lt;set _char.slave_traits.willpower -= 3&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;run _check_arousal()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_vaginal_oral;&lt;&lt;button &quot;Oral sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 10&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 10&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You take your &quot; + _cock + &quot; out of &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s wet pussy and pull &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s &quot; + 
                _char.physical_traits.hair_color + &quot; hair to line up &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; head, but &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                &quot; clearly tries to pull way, not fond of the idea of giving you a blowjob.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;oral&quot;, 40, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s juices into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face, but being a cumslut, &quot; + setup.PRONOUNS[_char.gender][&quot;?she&quot;] + &quot; looks \
                            forward to being filled with your cum.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face as you start to orally rape &quot; +
                            setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.oral -= 1&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as your precum touches their tongue. As \
                            a cumslut they are gushing wet just thinking about your cum.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please give me your cum; I want to bath and be filled with it!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; takes in your &quot; + _cock + &quot; with hunger in &quot; + 
                            setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes.&quot;)&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 3&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;set _open_menu = &quot;#sex_oral_actions&quot;&gt;&gt;
                    &lt;&lt;set _sex_state.last_action = &quot;oral&quot;&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s juices into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face, but being a cumslut, &quot; + setup.PRONOUNS[_char.gender][&quot;?she&quot;] + &quot; looks \
                                forward to being filled with your cum.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Tears stream down &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s face as you start to orally rape &quot; +
                                setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.discomfort += 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 2&gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 2&gt;&gt;
                            &lt;&lt;set _char.sex_prefs.oral -= 1&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.cum gt 30&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; lets out a moan of bliss as your precum touches their tongue. As \
                                a cumslut they are gushing wet just thinking about your cum.&quot;)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(&quot;Please give me your cum; I want to bath and be filled with it!&quot;))&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 5&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; takes in your &quot; + _cock + &quot; with hunger in &quot; + 
                                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes.&quot;)&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 3&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 10&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_oral_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;set _open_menu = &quot;#sex_oral_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;oral&quot;&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/repeat&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#sex_vaginal_anal;&lt;&lt;button &quot;Anal sex&quot;&gt;&gt;
        &lt;&lt;if $player.conditions.stamina lt 10&gt;&gt;
            &lt;&lt;notify&gt;&gt;You are too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;elseif _char.conditions.stamina lt 10&gt;&gt;
            &lt;&lt;notify&gt;&gt;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; is too tired!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _query_str = &quot;You grab your &quot; + _cock + &quot; out of &quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s wet pussy and line it up with &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; asshole.&quot;&gt;&gt;
            &lt;&lt;if _query_action(&quot;anal&quot;, 65, _query_str)&gt;&gt;
                &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s pussy juices into &quot; +
                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tight asshole.&quot;]&gt;&gt;
                &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Not my ass, it hurts so much! Please!...&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.discomfort += 20&gt;&gt;
                    &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
                    &lt;&lt;set _char.slave_traits.obedience -= 20&gt;&gt;
                    &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
                    &lt;&lt;set _char.sex_prefs.anal -= 2&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck my ass!&quot;))&gt;&gt;
                    &lt;&lt;set _char.mental_conditions.arousal += 8&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $player.mental_conditions.arousal += 15&gt;&gt;
                &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                &lt;&lt;addmins _mins&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;removeclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;addclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                    &lt;&lt;set _open_menu = &quot;#sex_anal_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;anal&quot;&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
            &lt;&lt;else&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if _rejection_processed&gt;&gt;
                &lt;&lt;if _rejection_response&gt;&gt;
                    &lt;&lt;set _responses = [&quot;You insert your &quot; + _cock + &quot; slick with &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s pussy juices into &quot; +
                        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tight asshole.&quot;]&gt;&gt;
                    &lt;&lt;if _sex_state.rape &amp;&amp; _thresh gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; screams and chokes on her tears.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Please! please! Not my ass, it hurts so much! Please!...&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.anger += 20&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.discomfort += 20&gt;&gt;
                        &lt;&lt;set _char.slave_traits.willpower -= 5&gt;&gt;
                        &lt;&lt;set _char.slave_traits.obedience -= 20&gt;&gt;
                        &lt;&lt;set _char.slave_traits.trust -= 10&gt;&gt;
                        &lt;&lt;set _char.sex_prefs.anal -= 2&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses.push(setup.titleCase(_char.first_name) + &quot; pulls you in and begs for more.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(&quot;Yes yes! Please fuck my ass!&quot;))&gt;&gt;
                        &lt;&lt;set _char.mental_conditions.arousal += 8&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set $player.mental_conditions.arousal += 15&gt;&gt;
                    &lt;&lt;set _mins = 3 + dice(1, 4)&gt;&gt;
                    &lt;&lt;addmins _mins&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;removeclass &quot;#sex_anal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;addclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
                        &lt;&lt;set _open_menu = &quot;#sex_anal_actions&quot;&gt;&gt;
                        &lt;&lt;set _sex_state.last_action = &quot;anal&quot;&gt;&gt;
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _rejection_processed&gt;&gt;
                &lt;&lt;unset _rejection_response&gt;&gt;
                &lt;&lt;run _check_arousal()&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@

    &lt;div style=&quot;grid-row: 4; grid-column: 2&quot;&gt;
    @@#sex_vaginal_back;&lt;&lt;button &quot;Back&quot;&gt;&gt;
        &lt;&lt;run setup.mainLog_append_delayed([&quot;You take your &quot; + _cock + &quot; out of &quot; + 
            setup.titleCase(_char.first_name) + &quot;\&#39;s pussy.&quot;])&gt;&gt;
        &lt;&lt;removeclass &quot;#sex_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#sex_vaginal_actions&quot; &quot;hidden&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 3&quot;&gt;
    @@#sex_vaginal_done;&lt;&lt;button &quot;Done&quot; `passage()`&gt;&gt;
        &lt;&lt;if _sex_state.orgasm&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties.&lt;br&gt;&quot; + _char.dialogue(&quot;That was great, let\&#39;s do that again sometime...&quot;) + 
                &quot;(&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection &quot; + setup.show_change_html(0, 5) + &quot;)&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += 5&gt;&gt;
        &lt;&lt;elseif _char.mental_conditions.arousal gt 20 &amp;&amp; _char.mental_conditions.discomfort lt _char.mental_conditions.arousal&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] +
                &quot; found the experience quite pleasurable (&quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, (_char.mental_conditions.arousal - _char.mental_conditions.discomfort) / 10) + &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += (_char.mental_conditions.arousal - _char.mental_conditions.discomfort) / 10&gt;&gt;
        &lt;&lt;elseif _char.mental_conditions.discomfort gt _char.mental_conditions.arousal&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties. You can tell that &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] +
                &quot; did not find the experience pleasurable (&quot; + setup.titleCase(_char.first_name) + 
                &quot;\&#39;s Affection &quot; + setup.show_change_html(0, _char.mental_conditions.arousal - _char.mental_conditions.discomfort) + &quot;).&quot;&gt;&gt;
            &lt;&lt;set _char.slave_traits.obedience += (_char.mental_conditions.arousal - _char.mental_conditions.discomfort)&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $_temp_to_log = &quot;You leave &quot; + setup.titleCase(_char.first_name) + &quot; to &quot; + 
                setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties.&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        /* Re-enable menu */
        &lt;&lt;set $enable_menu = true&gt;&gt;
        &lt;&lt;set $to_simulate.add(_char.key)&gt;&gt;
        /* Last round for good measure */
        &lt;&lt;set _to_round = _char.key&gt;&gt;
        &lt;&lt;include round&gt;&gt;
        &lt;&lt;run _get_changes()&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;#sex_vaginal_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
        var self = $(event.currentTarget);
        if (self.html() != &quot;Back&quot; &amp;&amp; self.html() != &quot;Done&quot;) {
            let _t = State.temporary;
            let char = _t.char;
            let player = State.variables.player;
            _t.to_round = _t.char.key;
            $.wiki(&quot;&lt;&lt;include round&gt;&gt;&quot;);
            $.wiki(&quot;&lt;&lt;include updateBars&gt;&gt;&quot;);
        }
    });
&lt;&lt;/script&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="24" name="assignmentEngine" tags="" position="475,350" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Check if player can pay costs first */
&lt;&lt;for _idx, _to_simulate range $to_simulate_day&gt;&gt;
    &lt;&lt;set _char = $characters[_to_simulate]&gt;&gt;
    &lt;&lt;if _char.assignment != &quot;none&quot;&gt;&gt;
        &lt;&lt;set _slave_changes[_to_simulate].flavor_text += &quot;Today &quot; + _char.name() + &quot; &quot; + 
            setup.assignments[_char.assignment].flavor_text + &quot; &quot;&gt;&gt;
        &lt;&lt;set _slave_changes[_to_simulate].cost += 25 * setup.HEIRARCHY[_char.status]&gt;&gt;
        &lt;&lt;if (&quot;cost&quot; in setup.assignments[_char.assignment])&gt;&gt;
            &lt;&lt;set _slave_changes[_to_simulate].cost += setup.assignments[_char.assignment].cost&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _total_profit -= _slave_changes[_to_simulate].cost&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Special charges */
&lt;&lt;for _idx, _to_simulate range $to_simulate_day&gt;&gt;
    &lt;&lt;set _char = $characters[_to_simulate]&gt;&gt;
    &lt;&lt;if _char.assignment == &quot;solBrothel&quot;&gt;&gt;
        &lt;&lt;set _sex_value = setup.round2(_char.sex_value().clamp(0, 1000))&gt;&gt;
        &lt;&lt;set _slave_changes[_to_simulate].cost += 0.4 * _sex_value&gt;&gt;
        &lt;&lt;set _total_profit += 0.4 * _sex_value&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* If not enough money, no changes occur and roles reset */
&lt;&lt;if _total_profit lt 0 &amp;&amp; Math.abs(_total_profit) gt $player.get_money()&gt;&gt;
    &lt;&lt;set _afford = false&gt;&gt;
    &lt;&lt;for _idx, _to_simulate range $to_simulate_day&gt;&gt;
        &lt;&lt;set _char = $characters[_to_simulate]&gt;&gt;
        &lt;&lt;set _char.assignment = &quot;none&quot;&gt;&gt;
    &lt;&lt;/for&gt;&gt;
&lt;&lt;else&gt;&gt;
    /* Generic changes */
    &lt;&lt;for _idx, _to_simulate range $to_simulate_day&gt;&gt;
        &lt;&lt;set _char = $characters[_to_simulate]&gt;&gt;
        &lt;&lt;if _char.assignment != &quot;none&quot;&gt;&gt;
            /* Begin by adding and performing all non-special rolls */
            &lt;&lt;if (&quot;self&quot; in setup.assignments[_char.assignment])&gt;&gt;
                &lt;&lt;for _key, _val range setup.assignments[_char.assignment].self&gt;&gt;
                    &lt;&lt;for _sub_key, _sub_val range _val&gt;&gt;
                        &lt;&lt;if _key == &quot;understand&quot;&gt;&gt;
                            &lt;&lt;if _char[_sub_key + &quot;_known&quot;]&gt;&gt;
                                &lt;&lt;continue&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
                                &lt;&lt;if _roll lt _sub_val&gt;&gt;
                                    &lt;&lt;set _char[_sub_key + &quot;_known&quot;] = true&gt;&gt;
                                    &lt;&lt;if _sub_key == &quot;sex_prefs&quot;&gt;&gt;
                                        &lt;&lt;set _flavor_name = &quot;sexual preferences&quot;&gt;&gt;
                                    &lt;&lt;else&gt;&gt;
                                        &lt;&lt;set _flavor_name = &quot;sexual fetishes&quot;&gt;&gt;
                                    &lt;&lt;/if&gt;&gt;
                                    &lt;&lt;set _slave_changes[_to_simulate].special.push(
                                        &quot;&lt;span class=\&quot;success\&quot;&gt;You learned &quot; + setup.titleCase(_char.first_name) + 
                                        &quot;\&#39;s &quot; + _flavor_name + &quot;.&lt;/span&gt;&quot;
                                    )&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;if _sub_key.startsWith(&quot;min&quot;) || _sub_key.startsWith(&quot;max&quot;)&gt;&gt;
                                &lt;&lt;continue&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;if Math.abs(_sub_val) gte 1&gt;&gt;
                                &lt;&lt;set _delta = _sub_val&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                /* Simulate probability */
                                &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
                                &lt;&lt;if _roll lt Math.abs(_sub_val)&gt;&gt;
                                    &lt;&lt;set _delta = Math.sign(_sub_val)&gt;&gt;
                                &lt;&lt;else&gt;&gt;
                                    &lt;&lt;set _delta = 0&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                            &lt;&lt;/if&gt;&gt;

                            /* Do straight addition with clamping */
                            &lt;&lt;set _prev = _char[_key][_sub_key]&gt;&gt;
                            
                            &lt;&lt;if (&quot;min_&quot; + _sub_key) in setup.assignments[_char.assignment].self[_key] &amp;&amp; _delta lt 0&gt;&gt;
                                &lt;&lt;if _prev gt setup.assignments[_char.assignment].self[_key][&quot;min_&quot; + _sub_key]&gt;&gt;
                                    &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;
                                    &lt;&lt;set _char[_key][_sub_key] = _char[_key][_sub_key].clamp(setup.assignments[_char.assignment].self[_key][&quot;min_&quot; + _sub_key], 100)&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                            &lt;&lt;elseif _delta lt 0&gt;&gt;
                                /* No minimum */
                                &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;
                            &lt;&lt;elseif (&quot;max_&quot; + _sub_key) in setup.assignments[_char.assignment].self&gt;&gt;
                                /* _delta &gt; 0 */
                                &lt;&lt;if _prev lt setup.assignments[_char.assignment].self[_key][&quot;max_&quot; + _sub_key]&gt;&gt;
                                    &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;
                                    &lt;&lt;set _char[_key][_sub_key] = _char[_key][_sub_key].clamp(-100, setup.assignments[_char.assignment].self[_key][&quot;max_&quot; + _sub_key])&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                /* No maximum */
                                &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;
                            &lt;&lt;/if&gt;&gt;

                            /* Push in change */
                            &lt;&lt;if !(_sub_key in _slave_changes[_to_simulate].self[_key])&gt;&gt;
                                &lt;&lt;set _slave_changes[_to_simulate].self[_key][_sub_key] = 0&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;if _char[_key][_sub_key] - _prev != 0&gt;&gt;
                                &lt;&lt;set _slave_changes[_to_simulate].self[_key][_sub_key] += _char[_key][_sub_key] - _prev&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if (&quot;player&quot; in setup.assignments[_char.assignment])&gt;&gt;
                &lt;&lt;for _key, _val range setup.assignments[_char.assignment].player&gt;&gt;
                    &lt;&lt;for _sub_key, _sub_val range _val&gt;&gt;
                        &lt;&lt;if _sub_key.startsWith(&quot;min&quot;) || _sub_key.startsWith(&quot;max&quot;)&gt;&gt;
                            &lt;&lt;continue&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;if Math.abs(_sub_val) gte 1&gt;&gt;
                            &lt;&lt;set _delta = _sub_val&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            /* Simulate probability */
                            &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
                            &lt;&lt;if _roll lt Math.abs(_sub_val)&gt;&gt;
                                &lt;&lt;set _delta = Math.sign(_sub_val)&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set _delta = 0&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                        &lt;&lt;/if&gt;&gt;

                        /* Do straight addition with clamping */
                        &lt;&lt;set $player[_key][_sub_key] += _delta&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/for&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="25" name="dietEngine" tags="" position="600,350" size="100,100">&lt;&lt;nobr&gt;&gt;
/* TODO: Implement amount of food for later */
&lt;&lt;for _idx, _to_simulate range $to_simulate_day&gt;&gt;
    &lt;&lt;set _char = $characters[_to_simulate]&gt;&gt;
    &lt;&lt;if _char.diet.additives != &quot;none&quot;&gt;&gt;
        &lt;&lt;set _slave_changes[_to_simulate].flavor_text +=  setup.titleCase(_char.first_name) + &quot; &quot; + 
            setup.diets.additives[_char.diet.additives].flavor_text + &quot; &quot;&gt;&gt;
        /* Begin by adding and performing all non-special rolls */
        &lt;&lt;if (&quot;self&quot; in setup.diets.additives[_char.diet.additives])&gt;&gt;
            &lt;&lt;for _key, _val range setup.diets.additives[_char.diet.additives].self&gt;&gt;
                &lt;&lt;for _sub_key, _sub_val range _val&gt;&gt;
                    &lt;&lt;if _sub_key.startsWith(&quot;min&quot;) || _sub_key.startsWith(&quot;max&quot;)&gt;&gt;
                        &lt;&lt;continue&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;if Math.abs(_sub_val) gte 1&gt;&gt;
                        &lt;&lt;set _delta = _sub_val&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        /* Simulate probability */
                        &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
                        &lt;&lt;if _roll lt Math.abs(_sub_val)&gt;&gt;
                            &lt;&lt;set _delta = Math.sign(_sub_val)&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _delta = 0&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/if&gt;&gt;

                    /* Do straight addition with clamping */
                    &lt;&lt;set _prev = _char[_key][_sub_key]&gt;&gt;
                    &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;

                    &lt;&lt;if (&quot;min_&quot; + _sub_key) in setup.diets.additives[_char.diet.additives].self[_key] &amp;&amp; _delta lt 0&gt;&gt;
                        &lt;&lt;if _prev gt setup.diets.additives[_char.diet.additives].self[_key][&quot;min_&quot; + _sub_key]&gt;&gt;
                            &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;
                            &lt;&lt;set _char[_key][_sub_key] = _char[_key][_sub_key].clamp(setup.diets.additives[_char.diet.additives].self[_key][&quot;min_&quot; + _sub_key], 100)&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;elseif _delta lt 0&gt;&gt;
                        /* No minimum */
                        &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;
                    &lt;&lt;elseif (&quot;max_&quot; + _sub_key) in setup.diets.additives[_char.diet.additives].self&gt;&gt;
                        /* _delta &gt; 0 */
                        &lt;&lt;if _prev lt setup.diets.additives[_char.diet.additives].self[_key][&quot;max_&quot; + _sub_key]&gt;&gt;
                            &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;
                            &lt;&lt;set _char[_key][_sub_key] = _char[_key][_sub_key].clamp(-100, setup.diets.additives[_char.diet.additives].self[_key][&quot;max_&quot; + _sub_key])&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        /* No maximum */
                        &lt;&lt;set _char[_key][_sub_key] += _delta&gt;&gt;
                    &lt;&lt;/if&gt;&gt;

                    /* Push in change */
                    &lt;&lt;if !(_sub_key in _slave_changes[_to_simulate].self[_key])&gt;&gt;
                        &lt;&lt;set _slave_changes[_to_simulate].self[_key][_sub_key] = 0&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;if _char[_key][_sub_key] - _prev != 0&gt;&gt;
                        &lt;&lt;set _slave_changes[_to_simulate].self[_key][_sub_key] += _char[_key][_sub_key] - _prev&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;&lt;/for&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;if (&quot;player&quot; in setup.diets.additives[_char.diet.additives])&gt;&gt;
            &lt;&lt;for _key, _val range setup.diets.additives[_char.diet.additives].player&gt;&gt;
                &lt;&lt;for _sub_key, _sub_val range _val&gt;&gt;
                    &lt;&lt;if _sub_key.startsWith(&quot;min&quot;) || _sub_key.startsWith(&quot;max&quot;)&gt;&gt;
                        &lt;&lt;continue&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;if Math.abs(_sub_val) gte 1&gt;&gt;
                        &lt;&lt;set _delta = _sub_val&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        /* Simulate probability */
                        &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
                        &lt;&lt;if _roll lt Math.abs(_sub_val)&gt;&gt;
                            &lt;&lt;set _delta = Math.sign(_sub_val)&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _delta = 0&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/if&gt;&gt;

                    /* Do straight addition with clamping */
                    &lt;&lt;set $player[_key][_sub_key] += _delta&gt;&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;&lt;/for&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        /* Now for special diet additives */
        &lt;&lt;if _char.diet.additives == &quot;cumBased&quot;&gt;&gt;
            &lt;&lt;if _char.sex_fetishes.cum gt 50&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience += 1&gt;&gt;
                &lt;&lt;set _slave_changes[_to_simulate].self.slave_traits.obedience += 1&gt;&gt;
                &lt;&lt;set _char.mental_conditions.cum_addiction += 3&gt;&gt;
                &lt;&lt;set _slave_changes[_to_simulate].self.mental_conditions.cum_addiction += 3&gt;&gt;
                &lt;&lt;set _char.sex_fetishes.cum += 2&gt;&gt;
                &lt;&lt;set _slave_changes[_to_simulate].self.sex_fetishes.cum += 2&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                &lt;&lt;set _slave_changes[_to_simulate].self.slave_traits.obedience -= 10&gt;&gt;
                &lt;&lt;set _char.mental_conditions.cum_addiction -= 3&gt;&gt;
                &lt;&lt;set _slave_changes[_to_simulate].self.mental_conditions.cum_addiction -= 3&gt;&gt;
                &lt;&lt;set _char.sex_fetishes.cum -= 3&gt;&gt;
                &lt;&lt;set _slave_changes[_to_simulate].self.sex_fetishes.cum -= 3&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;


&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="26" name="slaveEngine" tags="" position="725,350" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _slave_changes = {}&gt;&gt;
&lt;&lt;set _total_profit = 0&gt;&gt;
&lt;&lt;set _afford = true&gt;&gt;
/* Remove slaves who are at default setting */
&lt;&lt;set _to_delete = []&gt;&gt;
&lt;&lt;for _idx, _to_simulate range $to_simulate_day&gt;&gt;
    &lt;&lt;set _char = $characters[_to_simulate]&gt;&gt;
    &lt;&lt;if _char.assignment == &quot;none&quot; &amp;&amp;
         _char.diet.amount == &quot;regular&quot; &amp;&amp;
         _char.diet.additives == &quot;none&quot;&gt;&gt;
        &lt;&lt;set _to_delete.push(_to_simulate)&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set _slave_changes[_to_simulate] = {
            &quot;self&quot;: {
                &quot;slave_traits&quot;: {},
                &quot;conditions&quot;: {},
                &quot;mental_conditions&quot;: {},
                &quot;sex_skills&quot;: {},
                &quot;skills&quot;: {},
                &quot;sex_prefs&quot;: {},
                &quot;sex_fetishes&quot;: {},
            },
            &quot;cost&quot;: 0,
            &quot;special&quot;: [],
            &quot;flavor_text&quot;: &quot;&quot;
        }&gt;&gt;
        &lt;&lt;for _idx2, _key range Object.keys(_slave_changes[_to_simulate].self)&gt;&gt;
            &lt;&lt;for _idx3, _val2 range setup[_key.toUpperCase()]&gt;&gt;
                &lt;&lt;set _slave_changes[_to_simulate].self[_key][_val2] = 0&gt;&gt;
            &lt;&lt;/for&gt;&gt;
        &lt;&lt;/for&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;
&lt;&lt;for _idx, _to_del range _to_delete&gt;&gt;
    &lt;&lt;set $to_simulate_day.delete(_to_del)&gt;&gt;
    &lt;&lt;run delete $player.finances.slaves[_to_del]&gt;&gt;
&lt;&lt;/for&gt;&gt;
&lt;&lt;unset _to_delete&gt;&gt;

/* Simulate */
&lt;&lt;include assignmentEngine&gt;&gt;
&lt;&lt;include dietEngine&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="27" name="characterDynamics" tags="" position="850,350" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _temp = new Date($gameDate)&gt;&gt;
&lt;&lt;set _temp.setMinutes(_temp.getMinutes() - $_to_advance)&gt;&gt;
&lt;&lt;if (_temp.getDay() != $gameDate.getDay() &amp;&amp; $gameDate.getHours() gte 7) ||
     (_temp.getDay() == $gameDate.getDay() &amp;&amp; $gameDate.getHours() gte 7 &amp;&amp; _temp.getHours() lt 7)&gt;&gt;
    &lt;&lt;set $player.mental_conditions.arousal = 0&gt;&gt;
    &lt;&lt;for _key, _val range $characters&gt;&gt;
        &lt;&lt;run _val.reset_limits()&gt;&gt;
        &lt;&lt;set _val.conditions.stamina += 50 + _val.stats.strength&gt;&gt;
        &lt;&lt;set _to_round = _key&gt;&gt;
        &lt;&lt;include round&gt;&gt;
    &lt;&lt;/for&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;unset _temp&gt;&gt;

&lt;&lt;set _to_delete = []&gt;&gt;
&lt;&lt;for _idx, _to_simulate range $to_simulate&gt;&gt;
    &lt;&lt;set $characters[_to_simulate].mental_conditions.anger += -10 / 1440 * $_to_advance&gt;&gt;
    &lt;&lt;set $characters[_to_simulate].mental_conditions.sadness += -10 / 1440 * $_to_advance&gt;&gt;
    &lt;&lt;set $characters[_to_simulate].mental_conditions.arousal += -30 / 1440 * $_to_advance&gt;&gt;
    &lt;&lt;set $characters[_to_simulate].mental_conditions.discomfort += -30 / 1440 * $_to_advance&gt;&gt;
    &lt;&lt;set $characters[_to_simulate].mental_conditions.illness += -10 / 1440 * $_to_advance&gt;&gt;

    &lt;&lt;if _is_molesting&gt;&gt;
        &lt;&lt;set _delta_suspicion = (100 - $player.stats.dexterity) / 120 * $_to_advance&gt;&gt;
        &lt;&lt;if def _sus_mult&gt;&gt;
            &lt;&lt;set _delta_suspicion *= _sus_mult&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set $characters[_to_simulate].mental_conditions.suspicion += _delta_suspicion&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set $characters[_to_simulate].mental_conditions.suspicion += -25 / 1440 * $_to_advance&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;set _to_round = _to_simulate&gt;&gt;
    &lt;&lt;include round&gt;&gt;

    &lt;&lt;if $characters[_to_simulate].mental_conditions.anger == 0 &amp;&amp;
         $characters[_to_simulate].mental_conditions.sadness == 0 &amp;&amp;
         $characters[_to_simulate].mental_conditions.arousal == 0 &amp;&amp;
         $characters[_to_simulate].mental_conditions.discomfort == 0 &amp;&amp;
         $characters[_to_simulate].mental_conditions.illness == 0 &amp;&amp;
         $characters[_to_simulate].mental_conditions.suspicion == 0&gt;&gt;
        &lt;&lt;set _to_delete.push(_to_simulate)&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;for _idx, _to_del range _to_delete&gt;&gt;
    &lt;&lt;set $to_simulate.delete(_to_del)&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;unset _to_del&gt;&gt;
&lt;&lt;unset _to_delete&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="28" name="commodityDynamics" tags="" position="975,350" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _year_start = new Date($gameDate.getFullYear(), 0, 0)&gt;&gt;
&lt;&lt;set _diff = $gameDate - _year_start&gt;&gt;
&lt;&lt;set _day = _diff / (1000 * 60 * 60 * 24)&gt;&gt;

&lt;&lt;for _key, _val range $commodities&gt;&gt;
    &lt;&lt;if _val.type == &quot;semi-stable&quot;&gt;&gt;
        &lt;&lt;set _sigma = _val.stable_price * _val.sigma_ratio&gt;&gt;
        &lt;&lt;set _mu = _sigma * Math.sin(2 * Math.PI / 356 * _day + _val.mu_phase) + _val.stable_price&gt;&gt;
        &lt;&lt;set _theta = Math.exp(-1 * $difficulty)&gt;&gt;
        &lt;&lt;set _days_left = $_to_advance / (60 * 24)&gt;&gt;
        &lt;&lt;for _days_left gte 1 / 24&gt;&gt;
            &lt;&lt;set $commodities[_key].price += setup.ou_step($commodities[_key].price, _theta, _mu, _sigma, 1/24)&gt;&gt;
            &lt;&lt;set _days_left -= 1/24&gt;&gt;
        &lt;&lt;/for&gt;&gt;
        &lt;&lt;set $commodities[_key].price += setup.ou_step($commodities[_key].price, _theta, _mu, _sigma, _days_left)&gt;&gt;

        &lt;&lt;unset _theta&gt;&gt;
        &lt;&lt;unset _mu&gt;&gt;
        &lt;&lt;unset _sigma&gt;&gt;
        &lt;&lt;unset _days_left&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;unset _year_start&gt;&gt;
&lt;&lt;unset _diff&gt;&gt;
&lt;&lt;unset _day&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="29" name="conditionDynamics" tags="" position="1100,350" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;if $player.is_working || $player.is_slaving&gt;&gt;
    &lt;&lt;set $_mult = 3&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;set $_mult = 1&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $player.is_outside&gt;&gt;
    &lt;&lt;set $_mult *= 2&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if (def _is_molesting &amp;&amp; _is_molesting) ||
     (def _is_fucking &amp;&amp; _is_fucking)&gt;&gt;
    &lt;&lt;set $_mult *= 5&gt;&gt;
    &lt;&lt;if def _is_fucking &amp;&amp; _is_fucking&gt;&gt;
        &lt;&lt;if _sex_state.rape&gt;&gt;
            /* Expend more energy when raping */
            &lt;&lt;set $_mult *= 1.1&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if $difficulty gt -1&gt;&gt;
    &lt;&lt;set $_mult *= (1 + setup.randn_bm() / 10 * ($difficulty + 1))&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if !$player.is_sleeping&gt;&gt;
    /* Decay while not sleeping */
    /* d Health = -100 / 1440 * 1[stamina == 0] dt (in minutes) */
    &lt;&lt;if $player.conditions.stamina == 0&gt;&gt;
        &lt;&lt;script&gt;&gt;
            const mult = State.variables._mult;
            var player = State.variables.player;
            var _to_advance = State.variables._to_advance;
            var delta_health = mult * -100 / 1440 * _to_advance;
            player.conditions.health = player.conditions.health + delta_health;
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* d Stamina = (3 / 10 * strength - time_awake / 1440 * 300) / 1440 dt (in minutes) */
    /* delta Stamina = delta_t * mult * ((3/10 * strength - C * time_awake) - C * delta_t / 2) / 1440 */
    &lt;&lt;script&gt;&gt;
        const mult = State.variables._mult;
        var player = State.variables.player;
        const time_awake = State.variables.time_awake;
        var _to_advance = State.variables._to_advance;
        const C = 200 / 1440;
        var delta_stamina = mult * _to_advance * ((3/10 * player.stats.strength - C * time_awake) - C * _to_advance / 2) / 1440;
        player.conditions.stamina = player.conditions.stamina + delta_stamina;
    &lt;&lt;/script&gt;&gt;

    /* Accumulate time awake */
    &lt;&lt;set $time_awake += $_to_advance&gt;&gt;

&lt;&lt;else&gt;&gt;
    /* Recover while sleeping */
    /* d Health = 3 * (3 / 10 * strength + 20) / 1440 dt */
    &lt;&lt;script&gt;&gt;
        const mult = State.variables._mult;
        var player = State.variables.player;
        var _to_advance = State.variables._to_advance;
        var delta_health = mult * 3 * (3 / 10 * player.stats.strength + 20) / 1440 * _to_advance;
        player.conditions.health = player.conditions.health + delta_health;
    &lt;&lt;/script&gt;&gt;

    /* d Stamina = 3 * 50 / 1440 dt */
    &lt;&lt;script&gt;&gt;
        const mult = State.variables._mult;
        var player = State.variables.player;
        var _to_advance = State.variables._to_advance;
        var delta_stamina = mult * 3 * 50 / 1440 * _to_advance;
        player.conditions.stamina = player.conditions.stamina + delta_stamina;
    &lt;&lt;/script&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Player death */
&lt;&lt;if $player.conditions.health lte 0&gt;&gt;
    &lt;&lt;goto &quot;deathMenu&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="30" name="datetime" tags="widget" position="1225,350" size="100,100">/*
	Date &amp; Time Widget Setup
*/
&lt;&lt;nobr&gt;&gt;
&lt;&lt;set
	window.GameDays to [
		&quot;Sun&quot;, &quot;Mon&quot;, &quot;Tue&quot;, &quot;Wed&quot;, &quot;Thu&quot;, &quot;Fri&quot;, &quot;Sat&quot;
	];
	window.GameMonths to [
		&quot;Jan&quot;, &quot;Feb&quot;, &quot;Mar&quot;, &quot;Apr&quot;, &quot;May&quot;, &quot;Jun&quot;,
		&quot;Jul&quot;, &quot;Aug&quot;, &quot;Sep&quot;, &quot;Oct&quot;, &quot;Nov&quot;, &quot;Dec&quot;
	];

	/*
		Below we have to use the multi-parameter version of the Date
		constructor, rather than the date string version, because the
		date string version treats a missing timezone offset as UTC.
		While there are ways to determine players&#39; timezone offsets,
		so they could be added to a date string, it&#39;s more convenient
		simply to use the multi-parameter constructor.

		The point of this is so that you can simply initialize the game
		world clock to whatever date and time you wish without having to
		worry about the players&#39; timezone offsets, while still ensuring
		that they all see the same game world dates and times.
	*/
	/* params: year , month(0-based) , day , hour(24H) , minute [, second ] */
	$gameDate to new Date(200, 1, 1, 12, 0); /* e.g. Mar 17, 2015 03:24 */
&gt;&gt;


/* Updates datetime element */
&lt;&lt;widget &quot;updatetime&quot;&gt;&gt;
	/* Update money as well (why not) */
	&lt;&lt;script&gt;&gt;
		var player = State.variables.player;
		var gameDate = State.variables.gameDate;
		var time_element;
		if (State.temporary.is_molesting) {
			time_element = $(&quot;#molest_datetime&quot;);
		} else {
			time_element = $(&quot;#datetime&quot;);
		}
		if (time_element.length) {
			var temp = &quot;&lt;div id=\&quot;datetime\&quot;&gt;&quot;;
			temp += setup.print_time12hr(gameDate);
			temp += &quot;&lt;br&gt;&quot;;
			temp += setup.print_date(gameDate);
			temp += &quot;&lt;/div&gt;&quot;;
			time_element[0].innerHTML = temp;
		}

		var money_element = $(&quot;#money&quot;);
		if (money_element.length) {
			var temp = &quot;&lt;div id=\&quot;money\&quot;&gt;&quot;;
			temp += &quot;&lt;b&gt;Money&lt;/b&gt;: ¤&quot; + player.get_money() + &quot;&lt;/div&gt;&quot;;
			money_element[0].innerHTML = temp;
		}
	&lt;&lt;/script&gt;&gt;

&lt;&lt;/widget&gt;&gt;

/*
	Date &amp; Time Advancement Widget Definitions
*/
/* Adds the specified number of minutes. */
&lt;&lt;widget &quot;addmins&quot;&gt;&gt;
	&lt;&lt;script&gt;&gt;
		var to_add = State.variables.args[0];
		State.variables.gameDate.setMinutes(State.variables.gameDate.getMinutes() + to_add);
		State.variables._to_advance = to_add;
	&lt;&lt;/script&gt;&gt;

	/* Simulate dynamics */
	&lt;&lt;include slaveTraitDynamics&gt;&gt;
	&lt;&lt;include conditionDynamics&gt;&gt;
	&lt;&lt;include characterDynamics&gt;&gt;
	&lt;&lt;include commodityDynamics&gt;&gt;

	/* Round values */
	&lt;&lt;include round&gt;&gt;

	/* Update time */
	&lt;&lt;updatetime&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Adds the specified number of hours. */
&lt;&lt;widget &quot;addhours&quot;&gt;&gt;
	&lt;&lt;addmins `$args[0] * 60`&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Adds the specified number of days. */
&lt;&lt;widget &quot;adddays&quot;&gt;&gt;
	&lt;&lt;addhours `$args[0] * 24`&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Goes to next day. */
&lt;&lt;widget &quot;advanceday&quot;&gt;&gt;
	&lt;&lt;script&gt;&gt;
		var cur_date = State.variables.gameDate;
		var dest = new Date(cur_date.getTime());

		if (cur_date.getHours() &lt; 7) {
			dest.setHours(7);
		} else {
			dest.setHours(dest.getHours() + 24);
			dest.setHours(7);
		}
		dest.setMinutes(0);
		var diff = (dest - cur_date) / (1000 * 60);
		State.variables._to_advance = diff;
	&lt;&lt;/script&gt;&gt;
	&lt;&lt;addmins $_to_advance&gt;&gt;
&lt;&lt;/widget&gt;&gt;


/*
	Date &amp; Time Printing Widget Definitions
*/
/* Prints the current date (&quot;{weekday} {month} {day}, {year}&quot;). */
&lt;&lt;widget &quot;date&quot;&gt;&gt;
	&lt;&lt;print setup.print_date($gameDate)&gt;&gt;
&lt;&lt;/widget&gt;&gt;


&lt;&lt;widget &quot;year&quot;&gt;&gt;
	&lt;&lt;print String.format(&quot;{3}&quot;,
		GameDays[$gameDate.getDay()],
		GameMonths[$gameDate.getMonth()],
		$gameDate.getDate(),
		$gameDate.getFullYear()
	)&gt;&gt;
&lt;&lt;/widget&gt;&gt;


/* Prints the current time (12H). */
&lt;&lt;widget &quot;time12hr&quot;&gt;&gt;
	&lt;&lt;print setup.print_time12hr($gameDate)&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Prints the current time (24H). */
&lt;&lt;widget &quot;time24hr&quot;&gt;&gt;
	&lt;&lt;if $gameDate.getHours() lt 10&gt;&gt;0&lt;&lt;/if&gt;&gt;&lt;&lt;print $gameDate.getHours()&gt;&gt;:
	&lt;&lt;if $gameDate.getMinutes() lt 10&gt;&gt;0&lt;&lt;/if&gt;&gt;&lt;&lt;print $gameDate.getMinutes()&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="31" name="slaveTraitDynamics" tags="" position="100,475" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;if $player.is_slave&gt;&gt;

    &lt;&lt;if $player.is_slaving&gt;&gt;
        &lt;&lt;set $_mult = 2&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;if !(&quot;hours_worked&quot; in $player)&gt;&gt;
            &lt;&lt;set $player.hours_worked = 0&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;if $player.is_sleeping &amp;&amp; $player.conditions.stamina lt 20 &amp;&amp; $player.hours_worked gte 4&gt;&gt;
            &lt;&lt;set $_mult = 0&gt;&gt;
            &lt;&lt;set $_obedient_sleep = true&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $_mult = -1&gt;&gt;
            &lt;&lt;set $_obedient_sleep = false&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;if !$player.is_home&gt;&gt;
        &lt;&lt;set $_mult = -1&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;if $difficulty gt -1&gt;&gt;
        &lt;&lt;set $_mult *= (1 + setup.randn_bm() / 10 * ($difficulty + 1))&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* Apply sloth title */
    &lt;&lt;if $player.titles.has(&quot;sloth&quot;)&gt;&gt;
        &lt;&lt;set _obedience_mult = 0.5&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set _obedience_mult = 1&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;if $player.is_home &amp;&amp; $_mult != 0&gt;&gt;
        /* mult = 2 if working else -1 */
        /* d Obedience = mult * 10 + 1 / 10 * manipulation / 1440 dt (in minutes) */
        &lt;&lt;script&gt;&gt;
            const mult = State.variables._mult;
            var player = State.variables.player;
            var _to_advance = State.variables._to_advance;
            var delta_obedience = (mult * 15  + 1 / 10 * player.stats.manipulation) / 1440 * _to_advance;
            delta_obedience *= State.temporary.obedience_mult;
            player.slave_traits.obedience = Math.clamp(player.slave_traits.obedience + delta_obedience,
                                                        0, 100);
        &lt;&lt;/script&gt;&gt;

        /* d Willpower =  mult * - 15 + 1 / 5 * intelligence / 1440 dt (in minutes) */
        &lt;&lt;script&gt;&gt;
            const mult = State.variables._mult;
            var player = State.variables.player;
            var _to_advance = State.variables._to_advance;
            var delta_willpower = (mult * -15 + 1/5 * player.stats.intelligence) / 1440 * _to_advance;
            player.slave_traits.willpower = Math.clamp(player.slave_traits.willpower + delta_willpower,
                                                        0, 100);
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;elseif $_mult != 0&gt;&gt;
        /* If player is outside Shintani cannot observe thus obedience does not drop */
        &lt;&lt;script&gt;&gt;
            const mult = State.variables._mult;
            var player = State.variables.player;
            var _to_advance = State.variables._to_advance;
            var delta_willpower = (mult * -15 + 1/5 * player.stats.intelligence) / 1440 * _to_advance;
            player.slave_traits.willpower = Math.clamp(player.slave_traits.willpower + delta_willpower,
                                                        0, 100);
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="32" name="StoryInit" tags="" position="225,475" size="100,100">&lt;&lt;set Config.saves.version = setup.VERSION&gt;&gt;
&lt;&lt;script&gt;&gt;
    Config.saves.autosave = () =&gt; {
        return setup.locations.has(passage());
    }
    Config.history.maxStates = 1;
    Save.onSave.add((save, details) =&gt; {
        var gameDate = State.variables.gameDate;
        var locations = setup.locations;
        var player = State.variables.player;
        var passage_name = &quot;&quot;;
        if (locations.has(passage())) {
            passage_name = locations.get(passage()).name;
        } else if (State.variables.in_menu) {
            if (State.variables.last_visited != &quot;undefined&quot; &amp;&amp; locations.has(State.variables.last_visited)) {
                passage_name = locations.get(State.variables.last_visited).name;
            }
        }
        save.title = setup.titleCase(player.first_name) + &quot; | &quot; + 
            passage_name + &quot;: &quot; + 
            setup.print_time12hr(gameDate) + &quot;, &quot; + 
            setup.print_date(gameDate) + &quot; | Version &quot; + setup.VERSION;
    });
    Save.onLoad.add((save) =&gt; {
        if (setup.VERSION != save.version) {
            var str = &quot;\
                &lt;&lt;popover&gt;&gt;&lt;b&gt;As the game is very new, using old saves is currently not officially \
                supported (though it is technically built-in). Depending on the size of the last update, \
                this may break your game.&lt;/b&gt;\
            &quot;;
            str += &quot;&lt;br&gt;&lt;br&gt;&lt;b&gt;&lt;h3&gt;Mimis&#39; auto-upgrade tool:&lt;/h3&gt;&lt;/b&gt;&lt;br&gt;&quot;;
            try {
                var added = [];
                // Push in any game variables that don&#39;t exist
                for (const [key, value] of Object.entries(State.variables)) {
                    if (!(key in save.state.history[save.state.index].variables)) {
                        save.state.history[save.state.index].variables[key] = clone(value);
                        added.push(key);
                    }
                }
                // Specifically for 0.0.1.6
                if (!(&quot;finances&quot; in save.state.history[save.state.index].variables.player) || 
                    !(&quot;businesses&quot; in save.state.history[save.state.index].variables.player.finances) ||
                    !(&quot;slaves&quot; in save.state.history[save.state.index].variables.player.finances)) {
                    save.state.history[save.state.index].variables.player.finances = {
                        &quot;slaves&quot;: {},
                        &quot;businesses&quot;: {}
                    };
                    str += &quot;Finances added to player. Assignments need to be reset for effect to take place.&lt;br&gt;&quot;
                }
                str += &quot;Added in story variables: &quot; + added.join(&quot;, &quot;) + &quot;&lt;br&gt;&quot;;
                // Update the version
                str += &quot;Version updated to &quot; + setup.VERSION + &quot; (not verified).&lt;br&gt;&quot;
                str += &quot;This is not an error. Auto-migration suceeded. Please save to update changes.&quot;
            } catch (ex) {
                str += &quot;FAILED. &lt;br&gt;Stack trace:&lt;br&gt;&quot; + ex.stack;
            }
            str += &quot;&lt;&lt;/popover&gt;&gt;&quot;;
            $.wiki(str);
        }
        SimpleAudio.stop();
        try {
            if (SimpleAudio) {
                if (typeof SimpleAudio.volume === &#39;function&#39;) {
                    SimpleAudio.volume(save.state.history[save.state.index].variables.volume);
                } else {
                    SimpleAudio.volume = save.state.history[save.state.index].variables.volume;
                }
            } else {
                throw new Error(&#39;Cannot access audio API.&#39;);
            }
        } catch (err) {
            // fall back to the wikifier if we have to
            console.error(err.message, err);
            $.wiki(&#39;&lt;&lt;masteraudio volume &#39; + save.state.history[save.state.index].variables.volume + &#39;&gt;&gt;&#39;);
        }
    });
&lt;&lt;/script&gt;&gt;

&lt;&lt;preload &quot;resources/images/backgrounds/paper_border.jpg&quot;&gt;&gt;
&lt;&lt;preload &quot;resources/images/backgrounds/blackwood.jpg&quot;&gt;&gt;

/* Master volume */
&lt;&lt;set $volume = 100&gt;&gt;

/* Difficulty */
&lt;&lt;set $difficulty = 0&gt;&gt;

/* Text speed */
&lt;&lt;set $words_per_sec = 5.5&gt;&gt;

/* Whether or not the game as started */
&lt;&lt;set $game_started = false&gt;&gt;

/* Password */
&lt;&lt;set $testing_password = &quot;password&quot;&gt;&gt;

/* Initialize tutorials */
&lt;&lt;include initTutorials&gt;&gt;

/* Initliaze player */
&lt;&lt;include initPlayer&gt;&gt;

/* Health and stamina bars */
&lt;&lt;include initBars&gt;&gt;

/* Initialize keybinds */
&lt;&lt;include initKeybinds&gt;&gt;

/* Initialize locations */
&lt;&lt;include initLocations&gt;&gt;

/* Initialize audio sources */
&lt;&lt;include initAudio&gt;&gt;

/* Initialize Shintani&#39;s slaves */
&lt;&lt;include initCharacters&gt;&gt;

/* Initialize inventories */
&lt;&lt;include initInventories&gt;&gt;

/* Initialize quest object */
&lt;&lt;include initQuests&gt;&gt;

/* Initialize world prices for commodities */
&lt;&lt;include initCommodities&gt;&gt;</tw-passagedata><tw-passagedata pid="33" name="initAudio" tags="" position="350,475" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;cacheaudio &quot;bgm_intro_track&quot; &quot;resources/audio/music/Special - Intro.flac&quot;&gt;&gt;
&lt;&lt;createplaylist &quot;bgm_intro&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_intro_track&quot;&gt;&gt;
&lt;&lt;/createplaylist&gt;&gt;

/* Shintani&#39;s home should be wistful */
&lt;&lt;cacheaudio &quot;bgm_shintaniHome_track1&quot; &quot;resources/audio/music/World Explore - Deceptive Peace - Truegerischer Frieden.flac&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;bgm_shintaniHome_track2&quot; &quot;resources/audio/music/World Explore - In the Twilight - Im Zwielicht.flac&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;bgm_shintaniHome_track3&quot; &quot;resources/audio/music/World Explore - The Land Is Grey And Cold.flac&quot;&gt;&gt;
&lt;&lt;createplaylist &quot;bgm_shintaniHome&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_shintaniHome_track1&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_shintaniHome_track2&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_shintaniHome_track3&quot;&gt;&gt;
&lt;&lt;/createplaylist&gt;&gt;

/* Nipon itself should be hopeful */
&lt;&lt;cacheaudio &quot;bgm_nipon_track2&quot; &quot;resources/audio/music/City Explore - Home Of The Blessed.flac&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;bgm_nipon_track3&quot; &quot;resources/audio/music/City Explore - Homecoming.flac&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;bgm_nipon_track4&quot; &quot;resources/audio/music/City Explore - Lampman.flac&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;bgm_nipon_track5&quot; &quot;resources/audio/music/City Explore - Sunrise over the City.flac&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;bgm_nipon_track6&quot; &quot;resources/audio/music/City Explore - Trade Roads - Handelswege.flac&quot;&gt;&gt;
&lt;&lt;createplaylist &quot;bgm_nipon&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_nipon_track2&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_nipon_track3&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_nipon_track4&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_nipon_track5&quot;&gt;&gt;
    &lt;&lt;track &quot;bgm_nipon_track6&quot;&gt;&gt;
&lt;&lt;/createplaylist&gt;&gt;

/* Current playing main-track */
&lt;&lt;set $playing = &quot;none&quot;&gt;&gt;

/* Whether or not to enable music */
&lt;&lt;set $enable_music = true&gt;&gt;

/* Sounds */
&lt;&lt;cacheaudio &quot;wooden_door_sound&quot; &quot;resources/audio/sounds/wooden_door.wav&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;wooden_container_sound&quot; &quot;resources/audio/sounds/wooden_container.wav&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;coins_sound&quot; &quot;resources/audio/sounds/coins.wav&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;quest_added_sound&quot; &quot;resources/audio/sounds/quest_add.mp3&quot;&gt;&gt;
&lt;&lt;cacheaudio &quot;click_sound&quot; &quot;resources/audio/sounds/small_click.wav&quot;&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="34" name="initBars" tags="" position="475,475" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;newmeter &quot;player_health_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Health ($player.round.conditions.health)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;player_stamina_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Stamina ($player.round.conditions.stamina)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;player_arousal_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Arousal ($player.round.mental_conditions.arousal)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;player_dexterity_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Dexterity ($player.round.stats.dexterity)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

/* Char bars */
&lt;&lt;newmeter &quot;char_health_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Health (_char.round.conditions.health)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;char_stamina_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Stamina (_char.round.conditions.stamina)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;char_anger_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Anger&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;char_arousal_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Arousal&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;char_discomfort_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Discomfort&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;char_suspicion_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Suspicion&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;char_willpower_bar&quot; 1&gt;&gt;
    &lt;&lt;label &quot;Willpower&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

/* Player slave bars */
&lt;&lt;newmeter &quot;player_willpower_bar&quot; 0&gt;&gt;
    &lt;&lt;label &quot;Willpower ($player.round.slave_traits.willpower)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;player_trust_bar&quot; 0&gt;&gt;
    &lt;&lt;label &quot;Trust ($player.round.slave_traits.trust)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

&lt;&lt;newmeter &quot;player_obedience_bar&quot; 0&gt;&gt;
    &lt;&lt;label &quot;Obedience ($player.round.slave_traits.obedience)&quot;&gt;&gt;
    &lt;&lt;colors &quot;#e6dd9a&quot; &quot;#e6dd9a&quot;&gt;&gt;
&lt;&lt;/newmeter&gt;&gt;

/* Generated rounded values for display */
&lt;&lt;include round&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="35" name="initCharacters" tags="" position="600,475" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Dynamic list of characters that need to be simulated by gameclock engine */
&lt;&lt;set $to_simulate = new Set()&gt;&gt;

/* Dynamic list of characters that need to be simulated day by day by sleep engine */
&lt;&lt;set $to_simulate_day = new Set()&gt;&gt;

&lt;&lt;set $characters = {&quot;shintani_hiroyuki&quot;: new setup.Character(&quot;shintani_hiroyuki&quot;, true, 80),
                     &quot;himari_hironaka&quot;: new setup.Character(&quot;himari_hironaka&quot;, true, 60),
                     &quot;mei_hironaka&quot;: new setup.Character(&quot;mei_hironaka&quot;, true, 20),
                     &quot;jae_hironaka&quot;: new setup.Character(&quot;jae_hironaka&quot;, true, 40),
                     &quot;lia_hiroyuki&quot;: new setup.Character(&quot;lia_hiroyuki&quot;, true, 80),
                     &quot;emily_namm&quot;: new setup.Character(&quot;emily_namm&quot;, true, 50)}&gt;&gt;

/* Shintani */
&lt;&lt;set $characters.shintani_hiroyuki.set_properties(
    new Date(200 - 35, 12, 10),
    0,
    &quot;Shintani&quot;,
    &quot;Hiroyuki&quot;
)&gt;&gt;
&lt;&lt;set $characters.shintani_hiroyuki.stats = {
    &#39;dexterity&#39;: 20,
    &#39;intelligence&#39;: 63,
    &#39;manipulation&#39;: 89,
    &#39;strength&#39;: 34,
    &#39;tact&#39;: 53
}&gt;&gt;
&lt;&lt;set $characters.shintani_hiroyuki.physical_traits = {
    &#39;beauty&#39;: 54,
    &#39;weight&#39;: 5,
    &#39;height&#39;: 175,
    &#39;eye_color&#39;: &quot;brown&quot;,
    &#39;hair_color&#39;: &quot;black&quot;,
    &#39;ethnicity&#39;: &quot;japanese&quot;,
    &#39;skin_color&#39;: &quot;light&quot;
}&gt;&gt;
&lt;&lt;set $characters.shintani_hiroyuki.slave_traits.willpower = 100&gt;&gt;
&lt;&lt;set $characters.shintani_hiroyuki.status = &quot;rich citizen&quot;&gt;&gt;
&lt;&lt;set $characters.shintani_hiroyuki.slaves = [
    &quot;himari_hironaka&quot;,
    &quot;mei_hironaka&quot;,
    &quot;jae_hironaka&quot;
]&gt;&gt;
&lt;&lt;set $characters.shintani_hiroyuki.slave_traits.obedience = 30&gt;&gt;
&lt;&lt;set $characters.shintani_hiroyuki.quest_progress = 0&gt;&gt;

/* Himari */
&lt;&lt;set $characters.himari_hironaka.set_properties(
    new Date(200 - 23, 5, 3),
    1,
    &quot;Himari&quot;,
    &quot;Hironaka&quot;,
    true,
    &quot;shintani_hiroyuki&quot;
)&gt;&gt;
&lt;&lt;set $characters.himari_hironaka.stats = {
    &#39;dexterity&#39;: 20,
    &#39;intelligence&#39;: 50,
    &#39;manipulation&#39;: 10,
    &#39;strength&#39;: 24,
    &#39;tact&#39;: 72
}&gt;&gt;
&lt;&lt;set $characters.himari_hironaka.physical_traits = {
    &#39;beauty&#39;: 80,
    &#39;weight&#39;: -8,
    &#39;height&#39;: 165,
    &#39;eye_color&#39;: &quot;brown&quot;,
    &#39;hair_color&#39;: &quot;black&quot;,
    &#39;ethnicity&#39;: &quot;Japanese&quot;,
    &#39;skin_color&#39;: &quot;very fair&quot;
}&gt;&gt;
/* This is towards the player */
&lt;&lt;set $characters.himari_hironaka.slave_traits.willpower = 100&gt;&gt;
&lt;&lt;set $characters.himari_hironaka.status = &quot;high_slave&quot;&gt;&gt;

/* Mei */
&lt;&lt;set $characters.mei_hironaka.set_properties(
    new Date(200 - 21, 11, 23),
    1,
    &quot;Mei&quot;,
    &quot;Hironaka&quot;,
    true,
    &quot;shintani_hiroyuki&quot;
)&gt;&gt;
&lt;&lt;set $characters.mei_hironaka.stats = {
    &#39;dexterity&#39;: 31,
    &#39;intelligence&#39;: 20,
    &#39;manipulation&#39;: 29,
    &#39;strength&#39;: 24,
    &#39;tact&#39;: 23
}&gt;&gt;
&lt;&lt;set $characters.mei_hironaka.physical_traits = {
    &#39;beauty&#39;: 60,
    &#39;weight&#39;: 2,
    &#39;height&#39;: 172,
    &#39;eye_color&#39;: &quot;brown&quot;,
    &#39;hair_color&#39;: &quot;black&quot;,
    &#39;ethnicity&#39;: &quot;Chinese&quot;,
    &#39;skin_color&#39;: &quot;fair&quot;
}&gt;&gt;
&lt;&lt;set $characters.mei_hironaka.slave_traits.willpower = 78&gt;&gt;
&lt;&lt;set $characters.mei_hironaka.status = &quot;low_slave&quot;&gt;&gt;

/* Hina */
&lt;&lt;set $characters.jae_hironaka.set_properties(
    new Date(200 - 19, 10, 2),
    1,
    &quot;Jae&quot;,
    &quot;Hironaka&quot;,
    true,
    &quot;shintani_hiroyuki&quot;
)&gt;&gt;
&lt;&lt;set $characters.jae_hironaka.stats = {
    &#39;dexterity&#39;: 5,
    &#39;intelligence&#39;: 10,
    &#39;manipulation&#39;: 78,
    &#39;strength&#39;: 15,
    &#39;tact&#39;: 12
}&gt;&gt;
&lt;&lt;set $characters.jae_hironaka.physical_traits = {
    &#39;beauty&#39;: 70,
    &#39;weight&#39;: -8,
    &#39;height&#39;: 151,
    &#39;eye_color&#39;: &quot;green&quot;,
    &#39;hair_color&#39;: &quot;blonde&quot;,
    &#39;skin_color&#39;: &quot;light&quot;,
    &#39;ethnicity&#39;: &quot;Korean&quot;
}&gt;&gt;
&lt;&lt;set $characters.jae_hironaka.slave_traits.willpower = 90&gt;&gt;
&lt;&lt;set $characters.jae_hironaka.status = &quot;slave&quot;&gt;&gt;


/* Lia */
&lt;&lt;set $characters.lia_hiroyuki.set_properties(
    new Date(200 - 24, 11, 4),
    1,
    &quot;Lia&quot;,
    &quot;Hiroyuki&quot;
)&gt;&gt;
&lt;&lt;set $characters.lia_hiroyuki.stats = {
    &#39;dexterity&#39;: 20,
    &#39;intelligence&#39;: 76,
    &#39;manipulation&#39;: 32,
    &#39;strength&#39;: 22,
    &#39;tact&#39;: 76
}&gt;&gt;
&lt;&lt;set $characters.lia_hiroyuki.physical_traits = {
    &#39;beauty&#39;: 97,
    &#39;weight&#39;: -7,
    &#39;height&#39;: 160,
    &#39;eye_color&#39;: &quot;blue&quot;,
    &#39;hair_color&#39;: &quot;black&quot;,
    &#39;ethnicity&#39;: &quot;chinese&quot;,
    &#39;skin_color&#39;: &quot;pale&quot;
}&gt;&gt;
&lt;&lt;set $characters.lia_hiroyuki.slave_traits.obedience = 50&gt;&gt;
&lt;&lt;set $characters.lia_hiroyuki.slave_traits.willpower = 100&gt;&gt;
&lt;&lt;set $characters.lia_hiroyuki.status = &quot;rich citizen&quot;&gt;&gt;

/* Emily */
&lt;&lt;set $characters.emily_namm.set_properties(
    new Date(200 - 26, 7, 22),
    1,
    &quot;Emily&quot;,
    &quot;Namm&quot;
)&gt;&gt;
&lt;&lt;set $characters.emily_namm.stats = {
    &#39;dexterity&#39;: 68,
    &#39;intelligence&#39;: 36,
    &#39;manipulation&#39;: 22,
    &#39;strength&#39;: 74,
    &#39;tact&#39;: 12
}&gt;&gt;
&lt;&lt;set $characters.emily_namm.physical_traits = {
    &#39;beauty&#39;: 58,
    &#39;weight&#39;: 7,
    &#39;height&#39;: 160,
    &#39;eye_color&#39;: &quot;brown&quot;,
    &#39;hair_color&#39;: &quot;light brown&quot;,
    &#39;ethnicity&#39;: &quot;caucasian&quot;,
    &#39;skin_color&#39;: &quot;olive&quot;
}&gt;&gt;
&lt;&lt;set $characters.emily_namm.slave_traits.obedience = 30&gt;&gt;
&lt;&lt;set $characters.emily_namm.slave_traits.willpower = 100&gt;&gt;
&lt;&lt;set $characters.emily_namm.status = &quot;citizen&quot;&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="36" name="initCommodities" tags="" position="725,475" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set $commodities = {
    &quot;gold&quot;: {
        &quot;name&quot;: &quot;Gold Ingots&quot;,
        &quot;type&quot;: &quot;semi-stable&quot;,
        &quot;stable_price&quot;: 500,
        &quot;price&quot;: 500,
        &quot;mu_phase&quot;: 0,
        &quot;sigma_ratio&quot;: 0.1
    },
    &quot;silver&quot;: {
        &quot;name&quot;: &quot;Silver Ingots&quot;,
        &quot;type&quot;: &quot;semi-stable&quot;,
        &quot;stable_price&quot;: 200,
        &quot;price&quot;: 200,
        &quot;mu_phase&quot;: 0.01,
        &quot;sigma_ratio&quot;: 0.15
    },
    &quot;iron&quot;: {
        &quot;name&quot;: &quot;Iron Ingots&quot;,
        &quot;type&quot;: &quot;semi-stable&quot;,
        &quot;stable_price&quot;: 20,
        &quot;price&quot;: 20,
        &quot;mu_phase&quot;: 1,
        &quot;sigma_ratio&quot;: 0.12
    },
}&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="37" name="initEquities" tags="" position="850,475" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set $equities = {
    &quot;SOS&quot;: {
        &quot;name&quot;: &quot;Slave Owner Shares&quot;,
        &quot;type&quot;: &quot;stochastic&quot;,
        &quot;price&quot;: 100,
        &quot;sigma&quot;: 12
    }
    &quot;TUS&quot;: {
        &quot;name&quot;: &quot;Trade Union Shares&quot;,
        &quot;type&quot;: &quot;stochastic&quot;,
        &quot;price&quot;: 200,
        &quot;sigma&quot;: 10
    },
}&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="38" name="initInventories" tags="" position="975,475" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Initialize player inventory */
&lt;&lt;set $player.inventory = &quot;inventory&quot;&gt;&gt;
&lt;&lt;run UInv.CreateBag(&quot;inventory&quot;)&gt;&gt;
&lt;&lt;run UInv.SetBagPropertyValue(&quot;inventory&quot;, &quot;maxCarryWeight&quot;, $player.stats.strength)&gt;&gt;

/* Initialize character inventories (no max carry weight) */
&lt;&lt;for _key, _val range $characters&gt;&gt;
    &lt;&lt;set _val.inventory = _val.key&gt;&gt;
    &lt;&lt;run UInv.CreateBag(_val.key)&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="39" name="initKeybinds" tags="" position="1100,475" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set $last_visited = &quot;&quot;&gt;&gt;
&lt;&lt;set $enable_menu = false&gt;&gt;
&lt;&lt;on &quot;keydown&quot;&gt;&gt;
&lt;&lt;which 67&gt;&gt;
    &lt;&lt;if $game_started&gt;&gt;
        /* Key binding to see controls (C) */
        &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
        &lt;&lt;popover&gt;&gt;
            &lt;&lt;include controls&gt;&gt;
        &lt;&lt;/popover&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;which 69&gt;&gt;
    /* Key binding to go to character menu (E) */
    &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
    &lt;&lt;if $enable_menu &amp;&amp; $game_started&gt;&gt;
        &lt;&lt;if !$in_menu&gt;&gt;
            &lt;&lt;set $last_visited = passage()&gt;&gt;
            &lt;&lt;set $in_menu = true&gt;&gt;
            &lt;&lt;saveVars&gt;&gt;
            &lt;&lt;goto playerMenu&gt;&gt;
        &lt;&lt;elseif passage() != &quot;playerMenu&quot;&gt;&gt;
            &lt;&lt;goto playerMenu&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $in_menu = false&gt;&gt;
            &lt;&lt;goto $last_visited&gt;&gt;
            &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;which 81&gt;&gt;
    &lt;&lt;if $game_started&gt;&gt;
        /* Key binding for quest journal (Q) */
        &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
        &lt;&lt;popover&gt;&gt;
            &lt;&lt;include questMenu&gt;&gt;
        &lt;&lt;/popover&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;which 83&gt;&gt;
    &lt;&lt;if $game_started&gt;&gt;
        /* Key binding for saves (S) */
        &lt;&lt;if $enable_menu&gt;&gt;
            &lt;&lt;ui &quot;saves&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;which 84&gt;&gt;
    &lt;&lt;if $game_started&gt;&gt;
        /* Key binding to see tutorial for passage (T) */
        &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
        &lt;&lt;if passage() in $tutorials&gt;&gt;
            &lt;&lt;popover&gt;&gt;
                &lt;&lt;include $tutorials[passage()]&gt;&gt;
            &lt;&lt;/popover&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;which 27&gt;&gt;
    /* Key binding to go to save and settings menu (ESC / X) */
    &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
    &lt;&lt;if $enable_menu &amp;&amp; $game_started&gt;&gt;
        &lt;&lt;if !$in_menu&gt;&gt;
            &lt;&lt;set $last_visited = passage()&gt;&gt;
            &lt;&lt;set $in_menu = true&gt;&gt;
            &lt;&lt;saveVars&gt;&gt;
            &lt;&lt;goto settingsMenu&gt;&gt;
        &lt;&lt;elseif passage() != &quot;settingsMenu&quot;&gt;&gt;
            &lt;&lt;goto settingsMenu&gt;&gt; 
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $in_menu = false&gt;&gt;
            &lt;&lt;goto $last_visited&gt;&gt;
            &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt;   
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;which 88&gt;&gt;
    /* Key binding to go to save and settings menu (ESC / X) */
    &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
    &lt;&lt;if $enable_menu &amp;&amp; $game_started&gt;&gt;
        &lt;&lt;if !$in_menu&gt;&gt;
            &lt;&lt;set $last_visited = passage()&gt;&gt;
            &lt;&lt;set $in_menu = true&gt;&gt;
            &lt;&lt;saveVars&gt;&gt;
            &lt;&lt;goto settingsMenu&gt;&gt;
        &lt;&lt;elseif passage() != &quot;settingsMenu&quot;&gt;&gt;
            &lt;&lt;goto settingsMenu&gt;&gt; 
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set $in_menu = false&gt;&gt;
            &lt;&lt;goto $last_visited&gt;&gt;
            &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt;   
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/on&gt;&gt;

/* Click listener for speeding up dialogue */
&lt;&lt;on &quot;click&quot;&gt;&gt;
    &lt;&lt;if def _in_dialogue &amp;&amp; _in_dialogue &amp;&amp; def _timeout_id&gt;&gt;
        &lt;&lt;run triggerTimeout(_timeout_id)&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/on&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="40" name="initLocations" tags="" position="1225,475" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Set of locations the player has access to */
&lt;&lt;set $has_access = new Set([
    &quot;shintaniHome&quot;,
    &quot;niponAcademy&quot;,
    &quot;niponArena&quot;,
    &quot;niponBarracks&quot;,
    &quot;niponCentralDocks&quot;,
    &quot;solBrothel&quot;,
    &quot;niponTownHall&quot;,
    &quot;yukisGourmet&quot;,
    &quot;niponMarket&quot;,
    &quot;niponAuctionHouse&quot;,
    &quot;niponBlacksmith&quot;,
    &quot;niponFarms&quot;,
    &quot;niponMarketDocks&quot;,
    &quot;niponMines&quot;,
    &quot;niponStalls&quot;,
    &quot;niponTheater&quot;,
    &quot;niponTradeUnion&quot;,
    &quot;niponSlums&quot;,
    &quot;niponCampGrounds&quot;,
    &quot;divineTouchBrothel&quot;,
    &quot;sonderVille&quot;,
    &quot;valeCommunity&quot;
])&gt;&gt;
/* Location-Status key-pair */
&lt;&lt;set $location_status = {
    &quot;nipon&quot;: &quot;low_slave&quot;
}&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="41" name="initPlayer" tags="" position="100,600" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Player dictionary to store information */
&lt;&lt;set $player = new setup.Character(&quot;player&quot;)&gt;&gt;

/* Player titles */
&lt;&lt;set $player[&#39;titles&#39;] = new Set()&gt;&gt;

/* Player conditions */
&lt;&lt;set $base_cond = 100&gt;&gt;
&lt;&lt;for _i = 0; _i lt setup.CONDITIONS.length; _i++&gt;&gt;
    &lt;&lt;set $player[&#39;conditions&#39;][&quot;max_&quot; + setup.CONDITIONS[_i]] = $base_cond&gt;&gt;
    &lt;&lt;set $player[&#39;conditions&#39;][setup.CONDITIONS[_i]] = $base_cond&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Player stats */
&lt;&lt;set $base_stat = 10&gt;&gt;
&lt;&lt;for _i = 0; _i lt setup.STATS.length; _i++&gt;&gt;
    &lt;&lt;set $player[&#39;stats&#39;][setup.STATS[_i]] = $base_stat&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Player skills */
&lt;&lt;set $base_skill = 5&gt;&gt;
&lt;&lt;for _i = 0; _i lt setup.SKILLS.length; _i++&gt;&gt;
    &lt;&lt;set $player[&#39;skills&#39;][setup.SKILLS[_i]] = $base_skill&gt;&gt;
&lt;&lt;/for&gt;&gt;
&lt;&lt;for _i = 0; _i lt setup.SEX_SKILLS.length; _i++&gt;&gt;
    &lt;&lt;set $player[&#39;sex_skills&#39;][setup.SEX_SKILLS[_i]] = $base_skill&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Whether or not we are a slave */
&lt;&lt;set $player.is_slave = true&gt;&gt;

/* Player slave dynamics */
&lt;&lt;for _i = 0; _i lt setup.SLAVE_TRAITS.length; _i++&gt;&gt;
    &lt;&lt;set $player.slave_traits[setup.SLAVE_TRAITS[_i]] = 2 * $base_stat&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Whether or not player is sleeping */
&lt;&lt;set $player.is_sleeping = false&gt;&gt;
/* Whether or not player is working */
&lt;&lt;set $player.is_working = false&gt;&gt;
/* Whether or not the player is slaving */
&lt;&lt;set $player.is_slaving = false&gt;&gt;
/* Whether or not the player is home */
&lt;&lt;set $player.is_home = false&gt;&gt;
/* Whether or not the player is outside */
&lt;&lt;set $player.is_outside = false&gt;&gt;
/* Time awake */
&lt;&lt;set $time_awake = 0&gt;&gt;
/* Hours worked per day */
&lt;&lt;set $player.hours_worked = 0&gt;&gt;

/* Player slaves */
&lt;&lt;set $player.slaves = []&gt;&gt;

/* Player finance tracking */
&lt;&lt;set $player.finances = {}&gt;&gt;
&lt;&lt;set $player.finances.businesses = {}&gt;&gt;
&lt;&lt;set $player.finances.slaves = {}&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="42" name="initQuests" tags="" position="225,600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set $quest_journal = {&quot;ongoing&quot;: [], &quot;completed&quot;: []}&gt;&gt;

&lt;&lt;set $quests = {}&gt;&gt;
&lt;&lt;for _key, _val range setup.quests&gt;&gt;
    &lt;&lt;set $quests[_key] = {
        &quot;stage&quot;: 0,
        &quot;added&quot;: false,
        &quot;data&quot;: {}
    }&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="43" name="initTutorials" tags="" position="350,600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set $in_tutorial = false&gt;&gt;
&lt;&lt;set $tutorials = {}&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="44" name="finalization" tags="black" position="475,600" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Add in stat and condition changes from titles */
&lt;&lt;for _i, _title range $player.titles&gt;&gt;
    &lt;&lt;for _key, _val range setup.titles[_title][&#39;stat_changes&#39;]&gt;&gt;
        &lt;&lt;set $player.stats[_key] += _val&gt;&gt;
    &lt;&lt;/for&gt;&gt;
    &lt;&lt;for _key, _val range setup.titles[_title][&#39;condition_changes&#39;]&gt;&gt;
        &lt;&lt;set $player.conditions[_key] += _val&gt;&gt;
        &lt;&lt;set $player.conditions[&quot;max_&quot; + _key] += _val&gt;&gt;
    &lt;&lt;/for&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
&lt;div class=&quot;main container threeCol twoRow&quot;&gt;
    &lt;div class=&quot;subbackground&quot; style=&quot;grid-row: 1 / span 2; grid-column: 1&quot;&gt;
        &lt;center&gt;
            &lt;h3 style=&quot;margin-bottom: 0; padding-bottom: 0&quot;&gt;$player[&#39;first_name&#39;] Hironaka&lt;/h3&gt;
            &lt;&lt;if $player[&#39;last_name&#39;] != &quot;Hironaka&quot;&gt;&gt;
                &lt;span style=&quot;font-size: smaller&quot;&gt;(&lt;&lt;= $player[&#39;last_name&#39;]&gt;&gt;)&lt;/span&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;/center&gt;
        &lt;hr&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                Sex &lt;br&gt;
                Age &lt;br&gt;
                &lt;&lt;for _i = 0; _i lt setup.CONDITIONS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.CONDITIONS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
                &lt;br&gt;
                &lt;&lt;for _i = 0; _i lt setup.STATS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.STATS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;

            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;if $player.gender == 0&gt;&gt;
                    Male
                &lt;&lt;else&gt;&gt;
                    Female
                &lt;&lt;/if&gt;&gt; &lt;br&gt;
                &lt;&lt;= $player.age()&gt;&gt; &lt;br&gt;
                &lt;&lt;for _i = 0; _i lt setup.CONDITIONS.length; _i++&gt;&gt;
                    &lt;&lt;= $player.conditions[setup.CONDITIONS[_i]].toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
                &lt;br&gt;
                &lt;&lt;for _i = 0; _i lt setup.STATS.length; _i++&gt;&gt;
                    (&lt;&lt;= setup.show_change($base_stat, $player.stats[setup.STATS[_i]])&gt;&gt;) 
                    &lt;&lt;= $player.stats[setup.STATS[_i]].toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;center&gt;Titles
            &lt;hr&gt;
            &lt;div id=&quot;titles&quot;&gt;&lt;/div&gt;

            /* Prints all titles and assigns a unique div id to them */
            &lt;&lt;set $done_setup = false&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setTimeout(function(){
                    var html = &quot;&quot;;
                    var titles = Array.from(State.variables.player.titles);
                    for (var i = 0; i &lt; titles.length; i++) {
                        html += (&quot;\
                            &lt;div id=\&quot;char_&quot; + titles[i] + &quot;\&quot; class=\&quot;tooltip\&quot;&gt;&quot; +
                                setup.titleCase(titles[i])
                            + &quot;&lt;/div&gt;&lt;br&gt;\
                        &quot;);
                    }
                    document.getElementById(&quot;titles&quot;).innerHTML = html;

                    State.variables.done_setup = true;
                }, 1);
            &lt;&lt;/script&gt;&gt;

            /* Creates artificial event-listener for setup of script above */
            &lt;&lt;repeat 10ms&gt;&gt;
                &lt;&lt;if $done_setup&gt;&gt;
                    &lt;&lt;for _idx, _title range $player.titles&gt;&gt;
                        &lt;&lt;capture _title&gt;&gt;
                            &lt;&lt;script&gt;&gt;
                                var title = State.temporary.title;
                                $(&quot;#char_&quot; + title).click(
                                    function(){
                                        State.variables.selected_title = title;
                                        $.wiki(&quot;&lt;&lt;popover&gt;&gt;&lt;&lt;include titleTutorial&gt;&gt;&lt;&lt;/popover&gt;&gt;&quot;)
                                    }
                                );
                            &lt;&lt;/script&gt;&gt;
                        &lt;&lt;/capture&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                    &lt;&lt;unset $done_setup&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/repeat&gt;&gt;
        &lt;/center&gt;
    &lt;/div&gt;
    &lt;&lt;set _difficulties = [&quot;Very Easy&quot;, &quot;Easy&quot;, &quot;Normal&quot;, &quot;Hard&quot;, &quot;Very Hard&quot;]&gt;&gt;
    &lt;&lt;set _contents = [&quot;Economic&quot;, &quot;Domestic&quot;, &quot;Submissive&quot;]&gt;&gt;
    &lt;&lt;set $selected_difficulty = _difficulties[$difficulty + 2]&gt;&gt;
    &lt;&lt;set $selected_content = _contents[$tasks]&gt;&gt;
    &lt;div id=&quot;finalization_summary&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 1 / span 1; grid-column: 2 / span 2&quot;&gt;
        &lt;div class=&quot;textpassage&quot; style=&quot;margin-top: 20px; margin-bottom: 20px&quot;&gt;
            You are a 
            &lt;&lt;if $player.gender == 0&gt;&gt;
                man
            &lt;&lt;else&gt;&gt;
                woman
            &lt;&lt;/if&gt;&gt; of age &lt;&lt;= $player.age()&gt;&gt; who is &lt;&lt;= setup.get($player, &quot;height&quot;)&gt;&gt;cm tall with 
            &lt;&lt;= setup.get($player, &quot;hair_color&quot;)&gt;&gt; hair and &lt;&lt;= setup.get($player, &quot;eye_color&quot;)&gt;&gt; eyes.
            You are ethnically &lt;&lt;= setup.get($player, &quot;ethnicity&quot;)&gt;&gt;. You are set to be a slave serving under 
            //Shintani Hiroyuki// in 
            &lt;&lt;if $difficulty == -1&gt;&gt;
                an 
            &lt;&lt;else&gt;&gt;
                a 
            &lt;&lt;/if&gt;&gt; 
            &#39;&#39;$selected_difficulty&#39;&#39; world in the settlement of //Nipon// where the focus is &#39;&#39;$selected_content&#39;&#39; 
            slavery.
            &lt;&lt;for _idx, _title range $player.titles&gt;&gt;
                &lt;br&gt;&lt;br&gt;
                &lt;&lt;= setup.titles[_title].preposition&gt;&gt; &lt;b&gt;&lt;&lt;= setup.titleCase(_title)&gt;&gt;&lt;/b&gt;, 
                &lt;&lt;= setup.titles[_title].flavor_text&gt;&gt;
            &lt;&lt;/for&gt;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;subbackground&quot; style=&quot;grid-row: 2 / span 1; grid-column: 2 / span 2&quot;&gt;
        &lt;center&gt;&lt;h3&gt;Game Settings&lt;/h3&gt;
            Difficulty: $selected_difficulty
            &lt;br&gt;
            Starting Content: $selected_content
            &lt;br&gt;&lt;br&gt;&lt;br&gt;
            &lt;center&gt;
                &lt;&lt;button &quot;Confirm&quot; shintaniHome&gt;&gt;
                    /* Stop playing intro music */
                    &lt;&lt;audio &quot;:all&quot; stop&gt;&gt;
                    &lt;&lt;set $game_started = true&gt;&gt;

                    /* Initialize things that depend on the player */
                    &lt;&lt;run setup.init_influence()&gt;&gt;
                    
                &lt;&lt;/button&gt;&gt;
                &lt;&lt;button &quot;Reset&quot; intro1&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/center&gt;
        &lt;/center&gt;
    &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="45" name="intro1" tags="black" position="600,600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;center id=&quot;logo&quot; style=&quot;display: none&quot;&gt;
&lt;img class=&quot;logo&quot; src=&quot;resources/images/Mimus Studios-logos_white_presents.png&quot;&gt;
&lt;/center&gt;

&lt;h1 id=&quot;title&quot; class=&quot;logo&quot;&gt;Free Cities: Origins&lt;/h1&gt;

/* Reset player to base state */
&lt;&lt;include initPlayer&gt;&gt;
&lt;&lt;playlist &quot;bgm_intro&quot; loop shuffle play&gt;&gt;
&lt;div id=&quot;background&quot; class=&quot;paper_border&quot; style=&quot;display: none&quot;&gt;
    &lt;center&gt;&lt;h1&gt;In the Beginning&lt;/h1&gt;&lt;/center&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
    With the crumbling of sea walls and destruction of major infrastructure, the growing fear of
    annihilation strengthened between the major powers. All it took was one misjudged detonation
    for the tenents of mutually assured destruction to get thrown out the window. Alliances that
    were formed in the golden-age of humanity saw their last signs of life, as the black clouds
    of soot clouded the atmosphere and chilled the earth, it was as if time itself was at a 
    standstill.
    &lt;/p&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
    From these shattered nations arose settlements that were independantly managed by either luck,
    fortune, or talent. These settlements were terrible exuses for societies, often more dangerous
    than the shanky slums that dotted the world. This is the world you find yourself in; one of despair, 
    starvation, and fear.
    &lt;/p&gt;
    &lt;p class=&quot;textpassage&quot;&gt;&lt;div class=&quot;tooltip&quot;&gt;How bad was it?
        &lt;span class=&quot;tooltiptext right&quot; style=&quot;top: -170%&quot;&gt;
        Determines the difficulty of the game as well as the predictability. An easier game will have
        less randomness as well as some bonuses while a harder game will have less predictability
        and some penalities.
        &lt;/span&gt;
    &lt;/div&gt;&lt;/p&gt;
    &lt;br&gt;
    
    &lt;center class=&quot;option&quot;&gt;
    &lt;&lt;button &quot;It was barely noticable&quot; intro2&gt;&gt;&lt;&lt;set $difficulty = -2&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;button &quot;It was not that bad&quot; intro2&gt;&gt;&lt;&lt;set $difficulty = -1&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;button &quot;It was as bad as they say&quot; intro2&gt;&gt;&lt;&lt;set $difficulty = 0&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;button &quot;It was a bit worse&quot; intro2&gt;&gt;&lt;&lt;set $difficulty = 1&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;button &quot;It was way worse&quot; intro2&gt;&gt;&lt;&lt;set $difficulty = 2&gt;&gt;&lt;&lt;/button&gt;&gt;

    &lt;/center&gt;
&lt;/div&gt;

&lt;&lt;script&gt;&gt;
    setTimeout(function() {
        $(&quot;#logo&quot;).fadeIn(2000);
        $(&quot;#logo&quot;).fadeOut(1000);
        setTimeout(function() {
            $(&quot;#title&quot;).fadeIn(2000);
            $(&quot;#title&quot;).fadeOut(1000);
            setTimeout(function() {
                $(&quot;#background&quot;).fadeIn(2000);
            }, 3000);
        }, 3000);
    }, 10);
&lt;&lt;/script&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="46" name="intro2" tags="black" position="725,600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border&quot;&gt;
    &lt;center&gt;&lt;h1&gt;But then There Came&lt;/h1&gt;&lt;/center&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
    A crack in the cold ashen dirt allowing a sprout of hope to emerge. You are a 
    &lt;&lt;cycle &quot;$player.gender&quot;&gt;&gt;
        &lt;&lt;option &quot;man&quot; 0 selected&gt;&gt;
        &lt;&lt;option &quot;woman&quot; 1&gt;&gt;
    &lt;&lt;/cycle&gt;&gt;
    who found yourself amid this chaotic world as a
    &lt;&lt;cycle &quot;$player.birthdate&quot;&gt;&gt;
        &lt;&lt;option &quot;young&quot; `new Date(200 - 18, 1, 1, 12, 0)` selected&gt;&gt;
        &lt;&lt;option &quot;mid&quot; `new Date(200 - 30, 1, 1, 12, 0)`&gt;&gt;
        &lt;&lt;option &quot;old&quot; `new Date(200 - 45, 1, 1, 12, 0)`&gt;&gt;
    &lt;&lt;/cycle&gt;&gt; 
    &lt;span class=&quot;tooltip&quot;&gt;aged
        &lt;span class=&quot;tooltiptext bottom&quot;&gt;
        Young age favors ability to learn while old age favors higher intellect and respect.
        &lt;/span&gt;
    &lt;/span&gt; person of interest. As you stumble across the land in search of yourself, you
    think back and remember the teachings of your long deceased relatives. They not only
    taught you about the world, but also set you up for your next journey in life.
    &lt;/p&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
        &lt;&lt;link &quot;They were scholars who studied the vast developing cultures of the world.&quot; intro3&gt;&gt;
        &lt;&lt;set $player[&#39;titles&#39;].add(&#39;past_scholar&#39;)&gt;&gt;
        &lt;&lt;/link&gt;&gt;
        &lt;br&gt;
        &lt;&lt;link &quot;They were slavers who saved and reveled in the fates of the less fortunate.&quot; intro3&gt;&gt;
        &lt;&lt;set $player[&#39;titles&#39;].add(&#39;past_slaver&#39;)&gt;&gt;
        &lt;&lt;/link&gt;&gt;
        &lt;br&gt;
        &lt;&lt;link &quot;They were mercenaries who only looked out for their pockets and family.&quot; intro3&gt;&gt;
        &lt;&lt;set $player[&#39;titles&#39;].add(&#39;past_mercenary&#39;)&gt;&gt;
        &lt;&lt;/link&gt;&gt;
        &lt;br&gt;
        &lt;&lt;link &quot;They were slaves who did anything to avoid the wrath of their masters.&quot; intro3&gt;&gt;
        &lt;&lt;set $player[&#39;titles&#39;].add(&#39;past_slave&#39;)&gt;&gt;
        &lt;&lt;/link&gt;&gt;
        &lt;br&gt;
        &lt;&lt;link &quot;They were fallen royalty from the bygones of past national states.&quot; intro3&gt;&gt;
        &lt;&lt;set $player[&#39;titles&#39;].add(&#39;past_royal&#39;)&gt;&gt;
        &lt;&lt;/link&gt;&gt;
    &lt;/p&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="47" name="intro3" tags="black" position="850,600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border&quot;&gt;
    &lt;center&gt;&lt;h1&gt;You Reflect&lt;/h1&gt;&lt;/center&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
    And your mind fills with images of who you are. You recall that in this world every part of 
    who you are is not only tested, but constantly judged. The humans of the world, without any 
    larger meaning, cling onto anything that could differentiate them from others. This had led, 
    for example, to rampant racism, bandit gangs who only admit people with blonde hair, and 
    persecution against people with green eyes. Among this reality of indiscriminate discrimination, 
    who are you?
    &lt;/p&gt;
    &lt;br&gt;
    &lt;div class=&quot;container twoCol&quot; style=&quot;row-gap: 5%;&quot;&gt;
        &lt;center&gt;&#39;&#39;Height (cm)&#39;&#39;&lt;/center&gt;
        &lt;center&gt;&#39;&#39;Hair Color&#39;&#39;&lt;/center&gt;
        &lt;&lt;textbox &quot;$player.physical_traits.height&quot; &quot;170&quot;&gt;&gt;
        &lt;&lt;textbox &quot;$player.physical_traits.hair_color&quot; &quot;Brown&quot;&gt;&gt;
        &lt;center&gt;&#39;&#39;Eye Color&#39;&#39;&lt;/center&gt;
        &lt;center&gt;&#39;&#39;Ethnicity&#39;&#39;&lt;/center&gt;
        &lt;&lt;textbox &quot;$player.physical_traits.eye_color&quot; &quot;Brown&quot;&gt;&gt;
        &lt;&lt;textbox &quot;$player.physical_traits.ethnicity&quot; &quot;Stateless&quot;&gt;&gt;
    &lt;/div&gt;
    &lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
    &lt;center&gt;
        &lt;&lt;button &quot;Next&quot;&gt;&gt;
            &lt;&lt;set _success = true&gt;&gt;
            &lt;&lt;if Number.isInteger(Number($player.physical_traits.height))&gt;&gt;
                &lt;&lt;set $player.physical_traits.height = Number($player.physical_traits.height)&gt;&gt;
                &lt;&lt;if $player.physical_traits.height lte 0&gt;&gt;
                    &lt;&lt;set _success = false&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _success = false&gt;&gt;
            &lt;&lt;/if&gt;&gt;

            &lt;&lt;set $player.physical_traits.hair_color = $player.physical_traits.hair_color.trim().toLowerCase()&gt;&gt;
            &lt;&lt;set $player.physical_traits.eye_color = $player.physical_traits.eye_color.trim().toLowerCase()&gt;&gt;
            &lt;&lt;set $player.physical_traits.ethnicity = $player.physical_traits.ethnicity.trim().toLowerCase()&gt;&gt;

            &lt;&lt;if $player.physical_traits.hair_color.length == 0 || 
                 $player.physical_traits.eye_color.length == 0 ||
                 $player.physical_traits.ethnicity.length == 0&gt;&gt;
                &lt;&lt;set _success = false&gt;&gt;
            &lt;&lt;/if&gt;&gt;

            &lt;&lt;if _success&gt;&gt;
                &lt;&lt;run Engine.play(&quot;intro4&quot;)&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;
                    Invalid values!
                &lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/center&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="48" name="intro4" tags="black" position="975,600" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;background&quot; class=&quot;paper_border&quot;&gt;
    &lt;center&gt;&lt;h1&gt;The Spark in You Shined&lt;/h1&gt;&lt;/center&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
    Brighter than the simplicity of your upbringing. While you know it is your actions that determines
    who you are, unbeknownst to you, you carry with you the fate of humanity. What do you get in exchange 
    for carrying such a burden? (Choose up to two).
    &lt;/p&gt;

    &lt;&lt;set _titles_to_add = []&gt;&gt;
    &lt;&lt;set _num_selected = 0&gt;&gt;

    &lt;div id=&quot;attribute_selection&quot;&gt;
        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Hearty&#39;&#39;&lt;br&gt;
            +10 Health&lt;br&gt;
            +5 Stamina&lt;br&gt;
            @@#1;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#1 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#1 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;hearty&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    /* Disables all buttons */
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Nimble&#39;&#39;&lt;br&gt;
            +5 Dexterity&lt;br&gt;
            -5 Stamina&lt;br&gt;
            @@#2;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#2 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#2 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;nimble&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Silver Tongued&#39;&#39;&lt;br&gt;
            +2 Manipulation&lt;br&gt;
            +2 Tact&lt;br&gt;
            @@#3;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#3 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#3 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;silver_tongued&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Sharpshooter&#39;&#39;&lt;br&gt;
            +5 Ranged&lt;br&gt;&lt;br&gt;
            @@#4;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#4 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#4 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;sharpshooter&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Curious&#39;&#39;&lt;br&gt;
            +2 Intelligence&lt;br&gt;
            +2 Tact&lt;br&gt;
            @@#5;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#5 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#5 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;curious&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Lost Knowledge&#39;&#39;&lt;br&gt;
            Start with knowledge of the lost tongues&lt;br&gt;
            @@#6;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#6 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#6 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;lost_knowledge&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Well Connected&#39;&#39;&lt;br&gt;
            -50% spread when trading commodities&lt;br&gt;
            @@#7;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#7 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#7 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;well_connected&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Sloth&#39;&#39;&lt;br&gt;
            Lose and gain obedience twice as slow&lt;br&gt;
            @@#8;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#8 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#8 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;sloth&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Thief&#39;&#39;&lt;br&gt;
            Find more loot when stealing&lt;br&gt;
            @@#9;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#9 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#9 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;thief&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass `&quot;#reset button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;

        &lt;div class=&quot;subbackground&quot;&gt;
            &#39;&#39;Night Fox&#39;&#39;&lt;br&gt;
            -20% likelyhood to get caught molesting&lt;br&gt;
            @@#10;&lt;&lt;button &quot;Select&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#10 button&quot; &quot;selected&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#10 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;set _titles_to_add.push(&quot;night_fox&quot;)&gt;&gt;
                &lt;&lt;set _num_selected += 1&gt;&gt;
                &lt;&lt;if _num_selected gte 2&gt;&gt;
                    &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                        &lt;&lt;addclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                        &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;removeclass &quot;#reset button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;center class=&quot;fiveQuarters&quot;&gt;
        &lt;br&gt;
        &lt;&lt;disable&gt;&gt;
            @@#reset;&lt;&lt;button &quot;Reset&quot;&gt;&gt;
                /* Removes titles */
                &lt;&lt;set _titles_to_add = []&gt;&gt;
                &lt;&lt;set _num_selected = 0&gt;&gt;
                &lt;&lt;for _i = 1; _i lte 10; _i++&gt;&gt;
                    /* Enables all buttons */
                    &lt;&lt;removeclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    /* Remove selection */
                    &lt;&lt;removeclass `&quot;#&quot; + _i + &quot; button&quot;` &quot;selected&quot;&gt;&gt;
                &lt;&lt;/for&gt;&gt;
                &lt;&lt;addclass &quot;#reset button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#reset button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
        @@#next;&lt;&lt;button &quot;Next&quot; intro5&gt;&gt;
            &lt;&lt;for _idx, _title range _titles_to_add&gt;&gt;
                &lt;&lt;set $player.titles.add(_title)&gt;&gt;
            &lt;&lt;/for&gt;&gt;
            &lt;&lt;unset _titles_to_add&gt;&gt;
            &lt;&lt;unset _num_selected&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/center&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="49" name="intro5" tags="black" position="1100,600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border&quot;&gt;
    &lt;center&gt;&lt;h1&gt;And so You Pushed&lt;/h1&gt;&lt;/center&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
    Forwards into the vast world. Despite the notion that you are sailing the winds of 
    fate, no main character has ever been without adversity. This is the excuse you muster up 
    as you find yourself without shelter and parched in the Great Desert. As vultures begin 
    to circle overhead, you see a man approach whose porcelain white skin reflects a nobility 
    that should be long gone in this world.
    &lt;/p&gt;

    &lt;p class=&quot;textpassage&quot;&gt;
    Through your blurry vision you could barely make out 
    &lt;&lt;if $player[&#39;titles&#39;].has(&#39;past_scholar&#39;)&gt;&gt;
        his features. You thought it was impossible, as you&#39;ve learned in your extensive 
        past studies that they had all been wiped out, but a man of japanese descent now stands 
        in front of you.
    &lt;&lt;elseif $player[&#39;titles&#39;].has(&#39;past slaver&#39;)&gt;&gt;
        his whip slighting poking out of his holder on his right hip. Normally you would 
        be glad to see someone who hails from the same background as you, but you realize 
        that your current presentation might lead to unintended consequences. Apprehension 
        fills you as this man now stands next to you.
    &lt;&lt;elseif $player[&#39;titles&#39;].has(&#39;past merc&#39;)&gt;&gt;
        the glimmer of some gold poking out from a pouch fastened to his belt. Normally 
        this would be prime clientele that would provide the coin to feed your family 
        for a whole fortnight, but you realize that you are in no position to make such 
        an offer. He now stands next to you.
    &lt;&lt;elseif $player[&#39;titles&#39;].has(&#39;past slave&#39;)&gt;&gt;
        his whip slighting poking out of his holder on his right hip. Memories flood back as 
        you remember this sight before many tears, screams and beatings. Apprehension fills you
        as this man now stands next to you.
    &lt;&lt;elseif $player[&#39;titles&#39;].has(&#39;past royal&#39;)&gt;&gt;
        his seemingly polished nails and perfectly trimmed eyebrows. You are no stranger 
        to how the old world used to treat the upper class and royalty, but you had thought 
        this was a relic of the past. Regardless, he now stands next to you.
    &lt;&lt;/if&gt;&gt;
    &lt;/p&gt;

    &lt;p class=&quot;textpassage&quot;&gt;
    &quot;There isn&#39;t food or water for miles,&quot; he says as he eyes the vultures above. As you lock 
    eyes with him, a sickly smirk suddenly emerges as he says &quot;Come with me and be my slave. I 
    will save you.&quot; Not wanting your story to end here, you regrettably accept.
    &lt;/p&gt;

    &lt;p class=&quot;textpassage&quot;&gt;&lt;div class=&quot;tooltip&quot;&gt;He stards leading you to a town focusing on
        &lt;span class=&quot;tooltiptext right&quot; style=&quot;top: -250%&quot;&gt;
        Determines the content of the early game and what requests you will have to 
        fulfill as a slave. Not super important but prevents some content you might 
        not enjoy from appearing. Economics: you&#39;re basically any assistant. Domestic: 
        perform chores and tasks. Sexual: Self explainatory.
        &lt;/span&gt;
    &lt;/div&gt;&lt;/p&gt;
    &lt;br&gt;
    &lt;center class=&quot;option&quot;&gt;
    &lt;&lt;button &quot;Mainly\neconomics&quot; intro6&gt;&gt;&lt;&lt;set $tasks = 0&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;disable&gt;&gt;
        &lt;&lt;button &quot;Domestic\nslavery&quot; intro6&gt;&gt;&lt;&lt;set $tasks = 1&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;/disable&gt;&gt;
    &lt;&lt;disable&gt;&gt;
        &lt;&lt;button &quot;Sexual\nslavery&quot; intro6&gt;&gt;&lt;&lt;set $tasks = 2&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;/disable&gt;&gt;
    &lt;/center&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="50" name="intro6" tags="black" position="1225,600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border&quot;&gt;
    &lt;center&gt;&lt;h1&gt;He Speaks&lt;/h1&gt;&lt;/center&gt;
    &lt;p class=&quot;textpassage&quot;&gt;
    Ideals that seem out of place both in the past and present. &quot;Free Cities,&quot; he says as 
    he waves his hands in the air as if to allude to curtains openning on a stage. &quot;That&#39;s my 
    dream. We at Nipon are the only ones I know of that have solved the food issue. The 
    questions humans must keep asking are those of meaning.&quot; He stops and looks at your 
    puzzled face. 
    &lt;&lt;if $player[&#39;titles&#39;].has(&#39;past_scholar&#39;)&gt;&gt;
        Despite your past studies
    &lt;&lt;else&gt;&gt;
        Never have
    &lt;&lt;/if&gt;&gt; you have never thought past the next month. This world was too chaotic for that. He 
    goes on, &quot;What keeps us different from those vultures is an ability to ask for meaning.&quot;
    &lt;/p&gt;

    &lt;p class=&quot;textpassage&quot;&gt;
    He stops his monologue realizing something important, &quot;Oh right! My name is Shintani Hiroyuki, 
    but most people call me Shin. Of course, to you, I&#39;ll be master or sir.&quot; He looks you up 
    and down again, &quot;what do I call you?&quot;
    &lt;/p&gt;

    &lt;p id=&quot;name_output&quot; class=&quot;fade-out&quot; style=&quot;--time: 0.4s&quot;&gt;&lt;/p&gt;
    &lt;span id=&quot;name_confirm&quot; class=&quot;fade-out&quot; style=&quot;--time: 0.4s&quot;&gt;
        [[&quot;Continue forward.&quot;|finalization]]
    &lt;/span&gt;
    &lt;span id=&quot;name_input&quot; class=&quot;container threeCol&quot; style=&quot;--time: 0.4s&quot;&gt;
        &lt;center&gt;&#39;&#39;FIRST NAME&#39;&#39;&lt;/center&gt;
        &lt;center&gt;&#39;&#39;LAST NAME&#39;&#39;&lt;/center&gt;
        &lt;span&gt;&lt;/span&gt;
        &lt;&lt;textbox &quot;$player[&#39;first_name&#39;]&quot; &quot;&quot;&gt;&gt;
        &lt;&lt;textbox &quot;$player[&#39;last_name&#39;]&quot; &quot;&quot;&gt;&gt;
        &lt;center&gt;
            &lt;&lt;button &quot;Submit&quot;&gt;&gt;
                &lt;&lt;set $player[&#39;first_name&#39;] = $player[&#39;first_name&#39;].trim()&gt;&gt;
                &lt;&lt;set $player[&#39;last_name&#39;] = $player[&#39;last_name&#39;].trim()&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    var name_input = document.getElementById(&quot;name_input&quot;);
                    name_input.classList.add(&quot;fade-out&quot;);
                    var name_output = document.getElementById(&quot;name_output&quot;);
                    setTimeout(function(){
                        var player = State.variables.player;
                        if (player[&#39;first_name&#39;] == &quot;&quot;) {
                            player[&#39;first_name&#39;] = player[&#39;gender&#39;] == 0 ? &quot;Markus&quot; : &quot;Sierra&quot;;
                            name_output.innerHTML = &quot;\
                                \&quot;No name? Or maybe you just prefer not to tell me. Well \
                                you get the honor of bearing a name chosen by me. From here \
                                on out you will carry the name \&#39;&quot; + player[&#39;first_name&#39;] + &quot;\&#39;.&quot;;
                            if (player[&#39;last_name&#39;] == &quot;&quot;) {
                                player[&#39;last_name&#39;] = &quot;Hironaka&quot;;
                                name_output.innerHTML += &quot; \
                                    You shall also carry on my lineage with the honorable vassal surname \
                                    of Hironaka.\&quot;\
                                &quot;
                            } else {
                                name_output.innerHTML += &quot; \
                                    Your past that got you here is now irrelevant. You shall carry on \
                                    my lineage with the honorable vassal surname of Hironaka.\&quot;\
                                &quot;
                            }
                        } else {
                            player[&#39;first_name&#39;] = setup.titleCase(player[&#39;first_name&#39;]);
                            if (player[&#39;last_name&#39;] == &quot;&quot;) {
                                player[&#39;last_name&#39;] = &quot;Hironaka&quot;;
                                name_output.innerHTML+= &quot;\
                                    \&quot;Very well &quot; + player[&#39;first_name&#39;] + &quot;. You shall carry on \
                                    my lineage with the honorable vassal surname of Hironaka.\&quot;\
                                &quot;
                            } else {
                                name_output.innerHTML+= &quot;\
                                    \&quot;Very well &quot; + player[&#39;first_name&#39;] + &quot;. However, your past that \
                                    got you here is now irrelevant; you shall carry on \
                                    my lineage with the honorable vassal surname of Hironaka.\&quot;\
                                &quot;
                            }
                        }
                        name_output.classList.add(&#39;fade-in&#39;);
                        name_output.classList.remove(&#39;fade-out&#39;);
                        name_confirm.classList.add(&#39;fade-in&#39;);
                        name_confirm.classList.remove(&#39;fade-out&#39;);
                        
                        player[&#39;last_name&#39;] = setup.titleCase(player[&#39;last_name&#39;]);
                    }, 500);
                &lt;&lt;/script&gt;&gt;
                
            &lt;&lt;/button&gt;&gt;
        &lt;/center&gt;
    &lt;/span&gt;
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="51" name="characterMenuAssignment" tags="" position="100,725" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;assignment&quot; class=&quot;subbackground&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Assignment&lt;/h3&gt;&lt;/center&gt;
    &lt;&lt;if $player.slaves.contains($selected)&gt;&gt;

    &lt;&lt;elseif $player.is_slave &amp;&amp; $characters.shintani_hiroyuki.slaves.contains(_char.key)&gt;&gt;
        &lt;&lt;if _higher_status&gt;&gt;
            &lt;center id=&quot;assignment_buttons&quot; class=&quot;threeHalfs smalltext longbutton column&quot;&gt;
                
                @@#shintanisOrders;&lt;&lt;button &quot;Shintani\&#39;s Orders&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                
                @@#serveShintani;&lt;&lt;button &quot;Serve Shintani&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                @@#serveYou;&lt;&lt;button &quot;Serve You&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                @@#solBrothel;&lt;&lt;button &quot;Sol Brothel&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                @@#fuckToy;&lt;&lt;button &quot;Fuck Toy&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                &lt;hr&gt;
                &lt;h3&gt;Self Improvement&lt;/h3&gt;
                @@#freeTime;&lt;&lt;button &quot;Free Time&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                @@#study;&lt;&lt;button &quot;Study&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                @@#train;&lt;&lt;button &quot;Train&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
            &lt;/center&gt;
            &lt;center class=&quot;threeHalfs smalltext longbutton column&quot;&gt;
                &lt;hr&gt;
                &lt;&lt;button &quot;Done&quot;&gt;&gt;&lt;&lt;script&gt;&gt;
                    $(&quot;#characterMenuCenter&quot;).removeClass(&quot;hidden&quot;);
                    $(&quot;#characterMenuLeft&quot;).removeClass(&quot;hidden&quot;);
                    $(&quot;#characterMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
                &lt;&lt;/script&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/center&gt;
        &lt;&lt;else&gt;&gt;
            &lt;div class=&quot;textpassage&quot;&gt;
                You do not have a higher status than this person!
            &lt;/div&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;div class=&quot;textpassage&quot;&gt;
            This person is not your slave!
        &lt;/div&gt;
    &lt;&lt;/if&gt;&gt;
&lt;/div&gt;

&lt;&lt;silently&gt;&gt;&lt;&lt;timed 50ms&gt;&gt;
    &lt;&lt;if _char.assignment == &quot;none&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#shintanisOrders button&quot; &quot;disabled&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#shintanisOrders button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;addclass `&quot;#&quot; + _char.assignment + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#&quot; + _char.assignment + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;script&gt;&gt;
        let char = State.temporary.char;
        let player = State.variables.player;
        $(&quot;#assignment_buttons&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
            $(&quot;#assignment_buttons&quot;).find(&quot;button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#assignment_buttons&quot;).find(&quot;button&quot;).prop(&quot;disabled&quot;, false);
            var self = $(event.currentTarget);
            self.addClass(&quot;disabled&quot;);
            self.prop(&quot;disabled&quot;, true);
            var assignment = setup.camelize(self.html());
            const assignment_passage = &quot;assignment&quot; + assignment.toLocaleUpperFirst();
            if (tale.has(assignment_passage)) {
                $.wiki(&quot;&lt;&lt;include &quot; + assignment_passage + &quot;&gt;&gt;&quot;);
                $(&quot;#characterMenuCenterDetails&quot;).removeClass(&quot;hidden&quot;);
                $(&quot;#characterMenuCenter&quot;).addClass(&quot;hidden&quot;);
                $(&quot;#characterMenuLeft&quot;).addClass(&quot;hidden&quot;);
                State.temporary.char.assignment = assignment;
                if (!(char.key in player.finances.slaves)) {
                    player.finances.slaves[char.key] = {};
                }
                player.finances.slaves[char.key].assignment = -25 * setup.HEIRARCHY[char.status];
                if (&quot;cost&quot; in setup.assignments[assignment]) {
                    player.finances.slaves[char.key].assignment -= setup.assignments[assignment].cost;
                }
                if (assignment == &quot;solBrothel&quot;) {
                    if (char.owner == &quot;shintani_hiroyuki&quot;) {
                        player.finances.slaves[char.key].assignment += 0.4 * char.sex_value().clamp(0, 1000);
                    } else {
                        player.finances.slaves[char.key].assignment += char.sex_value().clamp(0, 1000);
                    }
                }
                State.variables.to_simulate_day.add(char.key);
            } else {
                $(&quot;#characterMenuCenter&quot;).removeClass(&quot;hidden&quot;);
                $(&quot;#characterMenuLeft&quot;).removeClass(&quot;hidden&quot;);
                $(&quot;#characterMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
                State.temporary.char.assignment = &quot;none&quot;;
                if (char.key in player.finances.slaves) {
                    player.finances.slaves[_char.key].assignment = 0;
                }
            }
        });
    &lt;&lt;/script&gt;&gt;
&lt;&lt;/timed&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="52" name="assignmentFreeTime" tags="" position="225,725" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Free Time&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You let &quot; + setup.titleCase(_char.first_name) + &quot; take some well deserved time off until \
        further notice. This allows &quot; + setup.titleCase(_char.first_name) + &quot; to recover from illness, \
        injury, as well as builds &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; affection for you.&quot;&gt;&gt;
    &lt;&lt;set _opportunity = 25 * setup.HEIRARCHY[_char.status]&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection: &quot; + 
                setup.show_change_html(0, 2) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower: &quot; + 
                setup.show_change_html(0, 1, false) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;Reduces negative mental effects such as anger, sadness, and suspicion.&lt;/li&gt;\
            &lt;li&gt;Opportunity cost: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + _opportunity + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
        &lt;/ul&gt;\
    &quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="53" name="assignmentFuckToy" tags="" position="350,725" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Fuck Toy&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You assigned &quot; + setup.titleCase(_char.first_name) + &quot; to be your personal fuck toy until \
        further notice. Such an action has a chance to increase &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] +
        &quot; sex skills as well as reveal her fetishes. However, if her affection is not high enough it \
        may also lower &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; sexual preferences.&quot;&gt;&gt;
    &lt;&lt;set _opportunity = 25 * setup.HEIRARCHY[_char.status]&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;Sex skills increase: &lt;span class=\&quot;success\&quot;&gt;5%&lt;/span&gt; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;if !_char.sex_prefs_know&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;Understand preferences chance: &lt;span class=\&quot;success\&quot;&gt;10%&lt;/span&gt; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;if !_char.fetishes_known&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;Understand fetishes chance: &lt;span class=\&quot;success\&quot;&gt;5%&lt;/span&gt; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;if _char.slave_traits.obedience lt 60&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;Reduce sexual preferences chance: &lt;span class=\&quot;fail\&quot;&gt;5%&lt;/span&gt; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;Increase sexual preferences chance: &lt;span class=\&quot;success\&quot;&gt;5%&lt;/span&gt; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;set _flavor_text += &quot;&lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower: &quot; + 
                setup.show_change_html(0, -2, false) + &quot; per day (bound by 40).&lt;/li&gt;\
            &lt;li&gt;Opportunity cost: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + _opportunity + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
        &lt;/ul&gt;\
    &quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="54" name="assignmentServeShintani" tags="" position="475,725" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Serve Shintani&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You assigned &quot; + setup.titleCase(_char.first_name) + &quot; to serving Shintani until \
        further notice. Such an action will help you build his trust in you, but will take &quot;
        + setup.titleCase(_char.first_name) + &quot; away from &quot; + 
        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; other duties.&quot;&gt;&gt;
    &lt;&lt;set _opportunity = 25 * setup.HEIRARCHY[_char.status]&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;Trust : &quot; + setup.show_change_html(0, 2) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;Opportunity cost : &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
            &quot;&quot; + _opportunity + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
        &lt;/ul&gt;\
    &quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="55" name="assignmentServeYou" tags="" position="600,725" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Serve You&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You assigned &quot; + setup.titleCase(_char.first_name) + &quot; to serve you as a maid until \
        further notice. Such an action will lower &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] +
        &quot; affect and willpower towards you, but of course this takes &quot;
        + setup.titleCase(_char.first_name) + &quot; away from &quot; + 
        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; other duties.&quot;&gt;&gt;
    &lt;&lt;set _opportunity = 25 * setup.HEIRARCHY[_char.status]&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection: &quot; + 
                setup.show_change_html(0, -2) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower: &quot; + 
                setup.show_change_html(0, -2, false) + &quot; per day (bound by 40).&lt;/li&gt;\
            &lt;li&gt;Opportunity cost: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + _opportunity + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
        &lt;/ul&gt;\
    &quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="56" name="assignmentSolBrothel" tags="" position="725,725" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Whore at Sol Brothel&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You assigned &quot; + setup.titleCase(_char.first_name) + &quot; work at the Sol Brothel until \
        further notice. Such an action will net you 40% of &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
        &quot; profits (the other 60% going to Shintani). &quot; + setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?his&quot;]) + 
        &quot; profitability is determined by &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + 
        &quot; beauty, sex preferences, skills, and fetishes.&quot;&gt;&gt;
    &lt;&lt;set _opportunity = 25 * setup.HEIRARCHY[_char.status]&gt;&gt;
    &lt;&lt;set _sex_value = setup.round2(_char.sex_value().clamp(0, 1000))&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;Opportunity cost: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + _opportunity + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Revenue: &lt;span class=\&quot;success\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + _sex_value + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Shintani\&#39;s cut: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + setup.round2(0.6 * _sex_value) + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
    &quot;&gt;&gt;
    &lt;&lt;if 0.4 * _sex_value gt _opportunity&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;Total profit: &lt;span class=\&quot;success\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + setup.round2(0.4 * _sex_value - _opportunity) + &quot;&lt;/span&gt; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;Total profit: &lt;span class=\&quot;fail\&quot;&gt;-&quot; + setup.LARI + 
                &quot;&quot; + Math.abs(setup.round2(0.4 * _sex_value - _opportunity)) + &quot;&lt;/span&gt; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;&lt;/ul&gt;&quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="57" name="assignmentStudy" tags="" position="850,725" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Study in Hiroyuki Library&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You make &quot; + setup.titleCase(_char.first_name) + &quot; study in Shintani\&#39;s library until \
        further notice. This allows &quot; + setup.titleCase(_char.first_name) + &quot; to gradually increase \
        &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; intelligence which will allow her to push \
        back the ideals of slavery and believe you are her savior.&quot;&gt;&gt;
    &lt;&lt;set _opportunity = 25 * setup.HEIRARCHY[_char.status]&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection: &quot; + 
                setup.show_change_html(0, 2) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Trust: &quot; + 
                setup.show_change_html(0, 1) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower: &quot; + 
                setup.show_change_html(0, 1, false) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Trust towards Shintani: &quot; + 
                setup.show_change_html(0, -1, false) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;Raise intelligence chance: &lt;span class=\&quot;success\&quot;&gt;5%&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Opportunity cost: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + _opportunity + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Learning materials: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;25&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Total Profit: &lt;span class=\&quot;fail\&quot;&gt;-&quot; + setup.LARI + 
                (_opportunity + 25) + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
        &lt;/ul&gt;\
    &quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="58" name="assignmentTrain" tags="" position="975,725" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Train at Nipon Barracks&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You make &quot; + setup.titleCase(_char.first_name) + &quot; train at the Nipon barracks until \
        further notice. This allows &quot; + setup.titleCase(_char.first_name) + &quot; to gradually increase \
        &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; strength, dexterity, and physical skills.&quot;&gt;&gt;
    &lt;&lt;set _opportunity = 25 * setup.HEIRARCHY[_char.status]&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection: &quot; + 
                setup.show_change_html(0, 2) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Trust: &quot; + 
                setup.show_change_html(0, 1) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower: &quot; + 
                setup.show_change_html(0, 1, false) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;Raise dexterity chance: &lt;span class=\&quot;success\&quot;&gt;5%&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Raise strength chance: &lt;span class=\&quot;success\&quot;&gt;5%&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Raise physical skills chance: &lt;span class=\&quot;success\&quot;&gt;5%&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Opportunity cost: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;&quot; + _opportunity + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Training fee: &lt;span class=\&quot;fail\&quot;&gt;&quot; + setup.LARI + 
                &quot;50&lt;/span&gt; per day.&lt;/li&gt;\
            &lt;li&gt;Total Profit: &lt;span class=\&quot;fail\&quot;&gt;-&quot; + setup.LARI + 
                (_opportunity + 50) + &quot;&lt;/span&gt; per day.&lt;/li&gt;\
        &lt;/ul&gt;\
    &quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="59" name="characterMenu" tags="paper" position="1100,725" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;updatestatus&gt;&gt;

&lt;&lt;set _char = $characters[$selected]&gt;&gt;
&lt;&lt;set _higher_status = ($player.get_status(&quot;nipon&quot;) == &quot;slave&quot; &amp;&amp; _char.status == &quot;low_slave&quot;) ||
    ($player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot; &amp;&amp; _char.status == &quot;slave&quot;) || 
    ($player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot; &amp;&amp; _char.status == &quot;low_slave&quot;)&gt;&gt;
&lt;&lt;set _to_round = $selected&gt;&gt;
&lt;&lt;include round&gt;&gt;

&lt;div class=&quot;charside left&quot;&gt;
    &lt;div id=&quot;description_actions&quot; class=&quot;mapaction fiveQuarters smalltext&quot;&gt;
        &lt;hr&gt;
        &lt;&lt;disable&gt;&gt;
            @@#summary_but;&lt;&lt;button &quot;Summary&quot;&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
        @@#stats_but;&lt;&lt;button &quot;Stats&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#skills_but;&lt;&lt;button &quot;Skills&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#sex_skills_but;&lt;&lt;button &quot;Sex Prefs&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;set _left_selection = &quot;summary&quot;&gt;&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
&lt;div class=&quot;main container threeCol&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
    &lt;div id=&quot;characterMenuLeft&quot;&gt;
        &lt;&lt;include characterMenuSummary&gt;&gt;
        &lt;&lt;include characterMenuStats&gt;&gt;
        &lt;&lt;include characterMenuSkills&gt;&gt;
        &lt;&lt;include characterMenuSexPrefs&gt;&gt;
    &lt;/div&gt;

    &lt;div id=&quot;characterMenuCenter&quot; class=&quot;subbackground&quot;&gt;
        &lt;center&gt;
            &lt;h2 style=&quot;margin-top:20px; margin-bottom: 20px&quot;&gt;
                &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; &lt;&lt;= setup.titleCase(_char.last_name)&gt;&gt;
            &lt;/h2&gt;
            &lt;div id=&quot;characterMenuImage&quot;&gt;&lt;/div&gt;
        &lt;/center&gt;
        &lt;&lt;script&gt;&gt;
            var char = State.temporary.char;
            setTimeout(() =&gt; {
                $(&quot;#characterMenuImage&quot;).css(&quot;background-image&quot;, 
                    &quot;url(\&quot;&quot; + char.image_folder() + char.first_name.toLowerCase() + &quot;.png\&quot;)&quot;)
            }, 20);
        &lt;&lt;/script&gt;&gt;
        
        &lt;div style=&quot;margin: 15px; margin-left: 30px; margin-right: 30px&quot;&gt;
            &lt;&lt;showmeter &quot;char_health_bar&quot; `_char.conditions.health/_char.conditions.max_health`&gt;&gt;
            &lt;&lt;showmeter &quot;char_stamina_bar&quot; `_char.conditions.stamina/_char.conditions.max_stamina`&gt;&gt;
        &lt;/div&gt;        
        &lt;center class=&quot;twoThirds&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;set $in_menu = false&gt;&gt;
            &lt;&lt;goto $last_visited&gt;&gt;
            &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt; 
        &lt;&lt;/button&gt;&gt;
        &lt;/center&gt;
    &lt;/div&gt;
    &lt;div id=&quot;characterMenuCenterDetails&quot; class=&quot;subbackground hidden centerDetails&quot;&gt;
        &lt;hr&gt;
        &lt;center&gt;&lt;h3 id=&quot;characterMenuCenterDetailsTitle&quot;&gt;Title&lt;/h3&gt;&lt;/center&gt;
        &lt;div id=&quot;characterMenuCenterDetailsBody&quot; class=&quot;textpassage&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;

    &lt;&lt;include characterMenuAssignment&gt;&gt;
    &lt;&lt;include characterMenuInventory&gt;&gt;
    &lt;&lt;include characterMenuDiet&gt;&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;charside right&quot;&gt;
    &lt;div id=&quot;slave_actions&quot; class=&quot;mapaction fiveQuarters smalltext&quot;&gt;
        &lt;hr&gt;
        &lt;&lt;disable&gt;&gt;
            @@#assignment_but;&lt;&lt;button &quot;Assignment&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
        @@#inventory_but;&lt;&lt;button &quot;Inventory&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
        @@#diet_but;&lt;&lt;button &quot;Diet&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
        @@#rules_but;&lt;&lt;button &quot;Rules&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
        @@#outfit_but;&lt;&lt;button &quot;Outfit&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
        @@#finances_but;&lt;&lt;button &quot;Finances&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
        &lt;&lt;set _right_selection = &quot;assignment&quot;&gt;&gt;
    &lt;/div&gt;
&lt;/div&gt;

/* Disable all slave_actions if they are not your slave. */

&lt;&lt;if $player.slaves.contains($selected)&gt;&gt;

&lt;&lt;elseif $player.is_slave &amp;&amp; $characters.shintani_hiroyuki.slaves.contains(_char.key)&gt;&gt;
    &lt;&lt;if !_higher_status&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setTimeout(() =&gt; {
                var buttons = $(&quot;#slave_actions&quot;).find(&quot;button&quot;);
                buttons.addClass(&quot;disabled&quot;);
                buttons.prop(&quot;disabled&quot;, true);
            }, 20);
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;script&gt;&gt;
        setTimeout(() =&gt; {
            var buttons = $(&quot;#slave_actions&quot;).find(&quot;button&quot;);
            buttons.addClass(&quot;disabled&quot;);
            buttons.prop(&quot;disabled&quot;, true);
        }, 20);
    &lt;&lt;/script&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;#description_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
            $(&quot;#description_actions&quot;).find(&quot;button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#description_actions&quot;).find(&quot;button&quot;).prop(&quot;disabled&quot;, false);
            var self = $(event.currentTarget);
            self.addClass(&quot;disabled&quot;);
            self.prop(&quot;disabled&quot;, true);
            var desc = setup.camelize(self.html());
            $(&quot;#&quot; + desc).removeClass(&quot;hidden&quot;);
            $(&quot;#characterMenuLeft&quot;).removeClass(&quot;hidden&quot;);
            $(&quot;#characterMenuCenter&quot;).removeClass(&quot;hidden&quot;);
            $(&quot;#&quot; + State.temporary.left_selection).addClass(&quot;hidden&quot;);
            State.temporary.left_selection = desc;
            $(&quot;#characterMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
        });
    $(&quot;#slave_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
            $(&quot;#slave_actions&quot;).find(&quot;button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#slave_actions&quot;).find(&quot;button&quot;).prop(&quot;disabled&quot;, false);
            var self = $(event.currentTarget);
            self.addClass(&quot;disabled&quot;);
            self.prop(&quot;disabled&quot;, true);
            var desc = setup.camelize(self.html());
            $(&quot;#&quot; + desc).removeClass(&quot;hidden&quot;);
            $(&quot;#characterMenuLeft&quot;).removeClass(&quot;hidden&quot;);
            $(&quot;#characterMenuCenter&quot;).removeClass(&quot;hidden&quot;);
            $(&quot;#&quot; + State.temporary.right_selection).addClass(&quot;hidden&quot;);
            State.temporary.right_selection = desc;
            $(&quot;#characterMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
        });
&lt;&lt;/script&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="60" name="characterMenuDiet" tags="" position="1225,725" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;diet&quot; class=&quot;subbackground hidden&quot; style=&quot;padding-bottom: 25px;&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Diet&lt;/h3&gt;&lt;/center&gt;
    &lt;&lt;if $player.slaves.contains($selected)&gt;&gt;

    &lt;&lt;elseif $player.is_slave &amp;&amp; $characters.shintani_hiroyuki.slaves.contains(_char.key)&gt;&gt;
        &lt;&lt;if _higher_status&gt;&gt;
            &lt;center id=&quot;diet_buttons&quot; class=&quot;threeHalfs smalltext longbutton column&quot;&gt;
                &lt;span class=&quot;fail&quot;&gt;(Shintani&#39;s paternalist views prevents extreme starvation or gorging)&lt;/span&gt;
                &lt;div id=&quot;diet_amount_buttons&quot;&gt;
                    &lt;&lt;disable&gt;&gt;@@#limited;&lt;&lt;button &quot;Limited&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@&lt;&lt;/disable&gt;&gt;
                    @@#regular;&lt;&lt;button &quot;Regular&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                    &lt;&lt;disable&gt;&gt;@@#abundant;&lt;&lt;button &quot;Abundant&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@&lt;&lt;/disable&gt;&gt;
                &lt;/div&gt;
                &lt;hr&gt;
                &lt;h3&gt;Additives&lt;/h3&gt;
                &lt;div id=&quot;diet_additives_buttons&quot;&gt;
                    @@#noAdditives;&lt;&lt;button &quot;None&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                    @@#cumAdded;&lt;&lt;button &quot;Cum Added&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                    @@#cumBased;&lt;&lt;button &quot;Cum Based&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                    @@#milkAdded;&lt;&lt;button &quot;Milk Added&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                    @@#milkBased;&lt;&lt;button &quot;Milk Based&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
                &lt;/div&gt;
            &lt;/center&gt;
            &lt;center class=&quot;threeHalfs smalltext longbutton column&quot;&gt;
                &lt;hr&gt;
                &lt;&lt;button &quot;Done&quot;&gt;&gt;&lt;&lt;script&gt;&gt;
                    $(&quot;#characterMenuCenter&quot;).removeClass(&quot;hidden&quot;);
                    $(&quot;#characterMenuLeft&quot;).removeClass(&quot;hidden&quot;);
                    $(&quot;#characterMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
                &lt;&lt;/script&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/center&gt;
        &lt;&lt;else&gt;&gt;
            &lt;div class=&quot;textpassage&quot;&gt;
                You do not have a higher status than this person!
            &lt;/div&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;div class=&quot;textpassage&quot;&gt;
            This person is not your slave!
        &lt;/div&gt;
    &lt;&lt;/if&gt;&gt;
&lt;/div&gt;

&lt;&lt;if $player.is_slave &amp;&amp; $characters.shintani_hiroyuki.slaves.contains(_char.key)&gt;&gt;
    &lt;&lt;silently&gt;&gt;&lt;&lt;timed 50ms&gt;&gt;
        &lt;&lt;addclass `&quot;#&quot; + _char.diet.amount + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#&quot; + _char.diet.amount + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
        &lt;&lt;if _char.diet.additives == &quot;none&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#noAdditives button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#noAdditives button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;addclass `&quot;#&quot; + _char.diet.additives + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#&quot; + _char.diet.additives + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        
        &lt;&lt;script&gt;&gt;
            var player = State.variables.player;
            var char = State.temporary.char;
            $(&quot;#diet_amount_buttons&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
                $(&quot;#diet_amount_buttons&quot;).find(&quot;button&quot;).removeClass(&quot;disabled&quot;);
                $(&quot;#diet_amount_buttons&quot;).find(&quot;button&quot;).prop(&quot;disabled&quot;, false);
                var self = $(event.currentTarget);
                self.addClass(&quot;disabled&quot;);
                self.prop(&quot;disabled&quot;, true);
                var diet_amount = setup.camelize(self.html());
                char.diet.amount = diet_amount;
            });
            $(&quot;#diet_additives_buttons&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
                $(&quot;#diet_additives_buttons&quot;).find(&quot;button&quot;).removeClass(&quot;disabled&quot;);
                $(&quot;#diet_additives_buttons&quot;).find(&quot;button&quot;).prop(&quot;disabled&quot;, false);
                var self = $(event.currentTarget);
                var diet_additives = setup.camelize(self.html());
                char.diet.additives = diet_additives;
                const diet_passage = &quot;diet&quot; + diet_additives.toLocaleUpperFirst();
                var to_notify = &quot;&quot;;
                if (diet_additives.contains(&quot;cum&quot;) &amp;&amp; player.gender == 1) {
                    to_notify = &quot;No way to produce cum!&quot;;
                } else if (diet_additives.contains(&quot;milk&quot;) &amp;&amp; player.gender == 0) {
                    to_notify = &quot;No way to produce milk!&quot;;
                }
                if (to_notify == &quot;&quot;) {
                    self.addClass(&quot;disabled&quot;);
                    self.prop(&quot;disabled&quot;, true);
                    char.diet.additives = diet_additives;
                    if (tale.has(diet_passage)) {
                        $.wiki(&quot;&lt;&lt;include &quot; + diet_passage + &quot;&gt;&gt;&quot;);
                        $(&quot;#characterMenuCenterDetails&quot;).removeClass(&quot;hidden&quot;);
                        $(&quot;#characterMenuCenter&quot;).addClass(&quot;hidden&quot;);
                        $(&quot;#characterMenuLeft&quot;).addClass(&quot;hidden&quot;);
                    } else {
                        $(&quot;#characterMenuCenter&quot;).removeClass(&quot;hidden&quot;);
                        $(&quot;#characterMenuLeft&quot;).removeClass(&quot;hidden&quot;);
                        $(&quot;#characterMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
                    }
                } else {
                    $.wiki(&quot;&lt;&lt;notify&gt;&gt;&quot; + to_notify + &quot;&lt;&lt;/notify&gt;&gt;&quot;);
                    $(&quot;#characterMenuCenter&quot;).removeClass(&quot;hidden&quot;);
                    $(&quot;#characterMenuLeft&quot;).removeClass(&quot;hidden&quot;);
                    $(&quot;#characterMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
                    $(&quot;#noAdditives button&quot;).addClass(&quot;disabled&quot;);
                    $(&quot;#noAdditives button&quot;).prop(&quot;disabled&quot;, true);
                    State.temporary.char.diet.additives = &quot;none&quot;;
                }
            });
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;/timed&gt;&gt;&lt;&lt;/silently&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="61" name="dietCumAdded" tags="" position="100,850" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Cum Added&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You secretly cum into &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s food before every meal until \
        further notice. This allows &quot; + setup.titleCase(_char.first_name) + &quot; to associate your cum with \
        sustenance and furthers&quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; cum fetish as well as addiction. \
        Unfortunately without any menial slaves of your own, you have to produce this cum yourself.&quot;&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;Stamina: &quot; + setup.show_change_html(0, -10) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Cum Addiction: &quot; + 
                setup.show_change_html(0, 1) + &quot; per day.&lt;/li&gt;\
            &lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Cum Fetish: &quot; + 
                setup.show_change_html(0, 1) + &quot; per day.&lt;/li&gt;\
        &lt;/ul&gt;\
    &quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="62" name="dietCumBased" tags="" position="225,850" size="100,100">&lt;&lt;nobr&gt;&gt;
    /* Set title */
    &lt;&lt;run $(&quot;#characterMenuCenterDetailsTitle&quot;).html(&quot;Cum Based&quot;);&gt;&gt;
    &lt;&lt;set _flavor_text = &quot;\
        You now cum throughout the day to prepare &quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s meals. \
        If &quot; + setup.titleCase(_char.first_name) + &quot; does not have a cum fetish this will severely decrease &quot; + 
        setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; affection for you as well as make them despite cum. \
        However for the cum loving this is a perfect way to build psychological addiction and happiness. \
        Unfortunately without any menial slaves of your own, \
        you have to produce this cum yourself.&quot;&gt;&gt;
    &lt;&lt;set _flavor_text += &quot;\
        &lt;ul&gt;\
            &lt;li&gt;Stamina: &quot; + setup.show_change_html(0, -30) + &quot; per day.&lt;/li&gt;&quot;&gt;&gt;

    &lt;&lt;if _char.sex_fetishes.cum gt 50&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection: &quot; + 
            setup.show_change_html(0, 1) + &quot; per day.&lt;/li&gt;&quot;&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Cum Addiction: &quot; + 
            setup.show_change_html(0, 3) + &quot; per day.&lt;/li&gt;&quot;&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Cum Fetish: &quot; + 
            setup.show_change_html(0, 2) + &quot; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection: &quot; + 
            setup.show_change_html(0, -10) + &quot; per day.&lt;/li&gt;&quot;&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Cum Addiction: &quot; + 
            setup.show_change_html(0, -3) + &quot; per day.&lt;/li&gt;&quot;&gt;&gt;
        &lt;&lt;set _flavor_text += &quot;&lt;li&gt;&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Cum Fetish: &quot; + 
            setup.show_change_html(0, -3) + &quot; per day.&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;set _flavor_text += &quot;&lt;/ul&gt;&quot;&gt;&gt;

    &lt;&lt;run $(&quot;#characterMenuCenterDetailsBody&quot;).html(_flavor_text)&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="63" name="characterMenuFinances" tags="" position="350,850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;finances&quot; class=&quot;subbackground hidden&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Finances&lt;/h3&gt;
        &lt;&lt;if $player.slaves.contains(_char.key)&gt;&gt;
            /* TODO: Implement finances */
        &lt;&lt;else&gt;&gt;
            You do not own &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; and cannot view their financial records!
        &lt;&lt;/if&gt;&gt;
    &lt;/center&gt;
&lt;/div&gt;




&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="64" name="characterMenuInventory" tags="" position="475,850" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;inventory&quot; class=&quot;subbackground hidden&quot;&gt;
        &lt;hr&gt;
        &lt;center&gt;&lt;h3&gt;Inventory&lt;/h3&gt;
            &lt;&lt;set _items = UInv.GetItemsArrayWithoutAnyItemTags(_char.key, &quot;type&quot;, 
                [&quot;money&quot;, &quot;quest_item&quot;, &quot;armor&quot;, &quot;accessory&quot;])&gt;&gt;
            &lt;div class=&quot;container twoCol&quot; style=&quot;font-weight: normal&quot;&gt;
                &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                    &lt;&lt;for _i = 0; _i lt _items.length; _i++&gt;&gt;
                        &lt;&lt;= setup.titleCase(UInv.GetItemPropertyValue(_char.key, _items[_i], &quot;name&quot;))&gt;&gt;
                        &lt;br&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;/div&gt;
                &lt;div style=&quot;text-align: right; margin-right: 20px; font-weight: normal&quot;&gt;
                    &lt;&lt;for _i = 0; _i lt _items.length; _i++&gt;&gt;
                            &lt;&lt;= UInv.BagHasItem(_char.key, _items[_i])&gt;&gt;
                            &lt;br&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/center&gt;
    &lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="65" name="characterMenuSexPrefs" tags="" position="600,850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;sexPrefs&quot; class=&quot;subbackground hidden&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Sex Preferences&lt;/h3&gt;&lt;/center&gt;
    &lt;&lt;if _char.sex_prefs_known&gt;&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SEX_PREFS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.SEX_PREFS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;

            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SEX_PREFS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.round2(_char.sex_prefs[setup.SEX_PREFS[_i]]).toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;&lt;else&gt;&gt;
        &lt;div class=&quot;textpassage&quot;&gt;
            You do not know &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt;&#39;s sex likes or dislikes!
        &lt;/div&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;if _char.fetishes_known&gt;&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SEX_FETISHES.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.SEX_FETISHES[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;

            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SEX_FETISHES.length; _i++&gt;&gt;
                    &lt;&lt;= setup.round2(_char.sex_fetishes[setup.SEX_FETISHES[_i]]).toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;&lt;else&gt;&gt;
        &lt;div class=&quot;textpassage&quot;&gt;
            You do not know &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt;&#39;s fetishes!
        &lt;/div&gt;
    &lt;&lt;/if&gt;&gt;
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="66" name="characterMenuSkills" tags="" position="725,850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;skills&quot; class=&quot;subbackground hidden&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Skills&lt;/h3&gt;&lt;/center&gt;
    &lt;&lt;if _char.skills_known&gt;&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SKILLS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.SKILLS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SKILLS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.round2(_char.skills[setup.SKILLS[_i]]).toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;hr&gt;
        &lt;center&gt;&lt;h3&gt;Sex Skills&lt;/h3&gt;&lt;/center&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SEX_SKILLS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.SEX_SKILLS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;

            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SEX_SKILLS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.round2(_char.sex_skills[setup.SEX_SKILLS[_i]]).toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;&lt;else&gt;&gt;
        &lt;div class=&quot;textpassage&quot;&gt;
            You do not know &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt;&#39;s skills!
        &lt;/div&gt;
    &lt;&lt;/if&gt;&gt;
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="67" name="characterMenuStats" tags="" position="850,850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;stats&quot; class=&quot;subbackground hidden&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Stats&lt;/h3&gt;&lt;/center&gt;
    &lt;&lt;if _char.stats_known&gt;&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                Sex &lt;br&gt;
                Age &lt;br&gt;
                &lt;br&gt;
                &lt;&lt;for _i = 0; _i lt setup.STATS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.STATS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;

            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;if _char.gender == 0&gt;&gt;
                    Male
                &lt;&lt;else&gt;&gt;
                    Female
                &lt;&lt;/if&gt;&gt; &lt;br&gt;
                &lt;&lt;= _char.age()&gt;&gt; &lt;br&gt;
                &lt;br&gt;
                &lt;&lt;for _i = 0; _i lt setup.STATS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(_char.get_descriptor(setup.STATS[_i]))&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;&lt;else&gt;&gt;
        &lt;div class=&quot;textpassage&quot;&gt;
            You do not know &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt;&#39;s stats!
        &lt;/div&gt;
    &lt;&lt;/if&gt;&gt;
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="68" name="characterMenuSummary" tags="" position="975,850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;summary&quot; class=&quot;subbackground&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Summary&lt;/h3&gt;&lt;/center&gt;
    &lt;div class=&quot;textpassage&quot;&gt;
        &lt;&lt;= _char.toString(true)&gt;&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="69" name="deathMenu" tags="black" position="1100,850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border&quot; style=&quot;position: relative&quot;&gt;
    &lt;center&gt;&lt;h1 style=&quot;color: red&quot;&gt;You Died&lt;/h1&gt;&lt;/center&gt;
    &lt;p id=&quot;death_summary&quot; class=&quot;textpassage&quot; style=&quot;display: none&quot;&gt;
        The harsh world has claimed your life whether it was exhaustion, injury, or sickness, 
        &lt;&lt;= $player.name()&gt;&gt; has perished in this land.
        &lt;br&gt;&lt;br&gt;
        &lt;center&gt;
            &lt;&lt;button Saves&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    UI.saves();
                &lt;&lt;/script&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;&lt;button Quit&gt;&gt;
                &lt;&lt;script&gt;&gt;window.close()&lt;&lt;/script&gt;&gt;
            &lt;&lt;/button&gt;&gt;
        &lt;/center&gt;
    &lt;/p&gt;
&lt;/div&gt;

&lt;&lt;script&gt;&gt;
    setTimeout(() =&gt; {
        $(&quot;#death_summary&quot;).fadeIn();
    }, 500);
&lt;&lt;/script&gt;&gt;

/* Reset awake counter */
&lt;&lt;set $time_awake = 0&gt;&gt;

&lt;&lt;include round&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="70" name="playerMenuEquip" tags="" position="1225,850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;equipOverlay&quot; class=&quot;hidden&quot; style=&quot;position: relative; width: 0; height: 0; margin-left: -5px&quot;&gt;
    &lt;div class=&quot;equipOverlay&quot;&gt;
        &lt;div id=&quot;armor&quot;&gt;
            &lt;div id=&quot;headLine&quot;&gt;&lt;/div&gt;
            &lt;div id=&quot;head&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;
            
            &lt;div id=&quot;chestLine&quot;&gt;&lt;/div&gt;
            &lt;div id=&quot;chest&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;

            &lt;div id=&quot;legsLine&quot;&gt;&lt;/div&gt;
            &lt;div id=&quot;legs&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;

            &lt;div id=&quot;feetLine&quot;&gt;&lt;/div&gt;
            &lt;div id=&quot;feet&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div id=&quot;accessories&quot;&gt;
            &lt;div id=&quot;neckLine&quot;&gt;&lt;/div&gt;
            &lt;div id=&quot;neck&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;

            &lt;div id=&quot;weaponLine&quot;&gt;&lt;/div&gt;
            &lt;div id=&quot;weapon1&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;
            &lt;div id=&quot;weapon2&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;

            &lt;div id=&quot;groinLine&quot;&gt;&lt;/div&gt;
            &lt;div id=&quot;groin1&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;
            &lt;div id=&quot;groin2&quot; class=&quot;equipButton&quot;&gt;
                &lt;&lt;button &quot;&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;script&gt;&gt;
    let player = State.variables.player;
    let equipButtons = $(&quot;.equipButton&quot;);
    for (let _i = 0; _i &lt; equipButtons.length; _i++) {
        let id = equipButtons[_i].id;
        if (player.equipment[id] != &quot;none&quot;) {
            $(equipButtons[_i]).find(&quot;button&quot;).html(&quot;E&quot;);
        }
        $(equipButtons[_i]).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
            $(&quot;.equipButton button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;.equipButton button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#equip_list&quot;).children().fadeOut(0.1);
            if (player.is_slave) {
                $(&quot;#neck button&quot;).addClass(&quot;disabled&quot;);
                $(&quot;#neck button&quot;).prop(&quot;disabled&quot;, true);
            }
            let self = $(event.currentTarget);
            self.addClass(&quot;disabled&quot;);
            self.prop(&quot;disabled&quot;, true);
            $(&quot;#default_list&quot;).fadeOut(0.1);
            State.temporary.slot = id;
            $(&quot;#&quot; + State.temporary.slot.replace(/[0-9]/g, &#39;&#39;) + &quot;_list&quot;).fadeIn(0.1);
        });
    }
    if (player.is_slave) {
        $(&quot;#neck button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#neck button&quot;).prop(&quot;disabled&quot;, true);
    }
&lt;&lt;/script&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="71" name="playerMenuEquipment" tags="" position="100,975" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;equipment&quot; class=&quot;subbackground hidden&quot;&gt;
        &lt;div id=&quot;default_list&quot;&gt;
            &lt;hr&gt;
            &lt;center&gt;&lt;h3 id=&quot;armors_title&quot; class=&quot;tool&quot;&gt;Armor&lt;/h3&gt;
                &lt;&lt;set _armors = UInv.GetItemsArrayByItemTag(&quot;inventory&quot;, &quot;type&quot;, &quot;armor&quot;)&gt;&gt;
                &lt;div id=&quot;armors_list&quot; class=&quot;list container twoCol&quot;&gt;
                    &lt;div id=&quot;armors_list_names&quot; style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                    &lt;/div&gt;
                    &lt;div style=&quot;text-align: right; margin-right: 20px; font-weight: normal&quot;&gt;
                        &lt;&lt;for _i = 0; _i lt _armors.length; _i++&gt;&gt;
                            &lt;&lt;= UInv.BagHasItem(&quot;inventory&quot;, _armors[_i])&gt;&gt;
                            &lt;br&gt;
                        &lt;&lt;/for&gt;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/center&gt;
            &lt;hr&gt;
            &lt;center&gt;&lt;h3 id=&quot;weapons_title&quot; class=&quot;tool&quot;&gt;Weapons&lt;/h3&gt;
                &lt;&lt;set _weapons = UInv.GetItemsArrayByItemTag(&quot;inventory&quot;, &quot;type&quot;, &quot;weapon&quot;)&gt;&gt;
                &lt;div id=&quot;weapons_list&quot; class=&quot;list container twoCol&quot; style=&quot;font-weight: normal&quot;&gt;
                    &lt;div id=&quot;weapons_list_names&quot; style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                    &lt;/div&gt;
                    &lt;div style=&quot;text-align: right; margin-right: 20px; font-weight: normal&quot;&gt;
                        &lt;&lt;for _i = 0; _i lt _weapons.length; _i++&gt;&gt;
                            &lt;&lt;= UInv.BagHasItem(&quot;inventory&quot;, _weapons[_i])&gt;&gt;
                            &lt;br&gt;
                        &lt;&lt;/for&gt;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/center&gt;
            &lt;hr&gt;
            &lt;center&gt;&lt;h3 id=&quot;accessories_title&quot; class=&quot;tool&quot;&gt;Accessories&lt;/h3&gt;
                &lt;&lt;set _accessories = UInv.GetItemsArrayByItemTag(&quot;inventory&quot;, &quot;type&quot;, &quot;accessory&quot;)&gt;&gt;
                &lt;div id=&quot;accessories_list&quot; class=&quot;list container twoCol&quot; style=&quot;font-weight: normal&quot;&gt;
                    &lt;div id=&quot;accessories_list_names&quot; style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                    &lt;/div&gt;
                    &lt;div style=&quot;text-align: right; margin-right: 20px; font-weight: normal&quot;&gt;
                        &lt;&lt;for _i = 0; _i lt _accessories.length; _i++&gt;&gt;
                            &lt;&lt;= UInv.BagHasItem(&quot;inventory&quot;, _accessories[_i])&gt;&gt;
                            &lt;br&gt;
                        &lt;&lt;/for&gt;&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/center&gt;
        &lt;/div&gt;
        &lt;div id=&quot;equip_list&quot;&gt;
            &lt;center id=&quot;head_list&quot;&gt;&lt;hr&gt;&lt;h3&gt;Head&lt;/h3&gt;
                &lt;div id=&quot;head_list_items&quot; style=&quot;text-align: left; margin-left: 20px; font-weight: normal;&quot;&gt;&lt;/div&gt;
            &lt;/center&gt;
            &lt;center id=&quot;chest_list&quot;&gt;&lt;hr&gt;&lt;h3&gt;Chest&lt;/h3&gt;
                &lt;div id=&quot;chest_list_items&quot; style=&quot;text-align: left; margin-left: 20px; font-weight: normal;&quot;&gt;&lt;/div&gt;
            &lt;/center&gt;
            &lt;center id=&quot;legs_list&quot;&gt;&lt;hr&gt;&lt;h3&gt;Legs&lt;/h3&gt;
                &lt;div id=&quot;legs_list_items&quot; style=&quot;text-align: left; margin-left: 20px; font-weight: normal;&quot;&gt;&lt;/div&gt;
            &lt;/center&gt;
            &lt;center id=&quot;feet_list&quot;&gt;&lt;hr&gt;&lt;h3&gt;Feet&lt;/h3&gt;
                &lt;div id=&quot;feet_list_items&quot; style=&quot;text-align: left; margin-left: 20px; font-weight: normal;&quot;&gt;&lt;/div&gt;
            &lt;/center&gt;
            &lt;center id=&quot;neck_list&quot;&gt;&lt;hr&gt;&lt;h3&gt;Neck&lt;/h3&gt;
                &lt;div id=&quot;neck_list_items&quot; style=&quot;text-align: left; margin-left: 20px; font-weight: normal;&quot;&gt;&lt;/div&gt;
            &lt;/center&gt;
            &lt;center id=&quot;weapon_list&quot;&gt;&lt;hr&gt;&lt;h3&gt;Weapons&lt;/h3&gt;
                &lt;div id=&quot;weapon_list_items&quot; style=&quot;text-align: left; margin-left: 20px; font-weight: normal;&quot;&gt;&lt;/div&gt;
            &lt;/center&gt;
            &lt;center id=&quot;groin_list&quot;&gt;&lt;hr&gt;&lt;h3&gt;Groin&lt;/h3&gt;
                &lt;div id=&quot;groin_list_items&quot; style=&quot;text-align: left; margin-left: 20px; font-weight: normal;&quot;&gt;&lt;/div&gt;
            &lt;/center&gt;
        &lt;/div&gt;
    &lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;script&gt;&gt;
    function refresh_list(place) {
        let place_list = $(&quot;#&quot; + place + &quot;_list_items&quot;);
        let item = $(&quot;&lt;div class=\&quot;tool\&quot;&gt;None&lt;/div&gt;&quot;);
        item.on(&quot;click&quot;, (event) =&gt; {
            let slot = State.temporary.slot;
            player.equipment[slot] = &quot;none&quot;;
            $(&quot;#&quot; + slot + &quot; button&quot;).html(&quot;&quot;);
            $(&quot;#equip_list&quot;).children().fadeOut(0.1);
            $(&quot;#default_list&quot;).fadeIn(0.1);
            $(&quot;.equipButton button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;.equipButton button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#equip_list&quot;).children().fadeOut(0.1);
            if (player.is_slave) {
                $(&quot;#neck button&quot;).addClass(&quot;disabled&quot;);
                $(&quot;#neck button&quot;).prop(&quot;disabled&quot;, true);
            }
            place_list.empty();
            refresh_list(place);
        });
        place_list.append(item);
        place_list.append(&quot;&lt;br&gt;&quot;);
        let items = UInv.GetItemsArrayByItemTag(&quot;inventory&quot;, &quot;place&quot;, place);
        for (let x of items) {
            let item_str = setup.titleCase(UInv.GetItemPropertyValue(&quot;inventory&quot;, x, &quot;name&quot;));
            let equipped_slot = player.has_equipped(x);
            if (equipped_slot != &quot;none&quot;) {
                item_str += &quot; (E&quot; + equipped_slot.replace(/\D/g,&#39;&#39;) + &quot;)&quot;;
            }
            let item = $(&quot;&lt;div class=\&quot;tool\&quot; title=\&quot;&quot; + x + &quot;\&quot;&gt;&quot; + item_str + &quot;&lt;/div&gt;&quot;);
            item.on(&quot;click&quot;, (event) =&gt; {
                let slot = State.temporary.slot;
                let self = $(event.currentTarget);
                player.equipment[slot] = self.prop(&quot;title&quot;);
                $(&quot;#&quot; + slot + &quot; button&quot;).html(&quot;E&quot;);
                if (equipped_slot != &quot;none&quot;) {
                    $(&quot;#&quot; + equipped_slot + &quot; button&quot;).html(&quot;&quot;);
                    player.equipment[equipped_slot] = &quot;none&quot;;
                }
                $(&quot;#equip_list&quot;).children().fadeOut(0.1);
                $(&quot;#default_list&quot;).fadeIn(0.1);
                $(&quot;.equipButton button&quot;).removeClass(&quot;disabled&quot;);
                $(&quot;.equipButton button&quot;).prop(&quot;disabled&quot;, false);
                if (player.is_slave) {
                    $(&quot;#neck button&quot;).addClass(&quot;disabled&quot;);
                    $(&quot;#neck button&quot;).prop(&quot;disabled&quot;, true);
                }
                place_list.empty();
                refresh_list(place);
            });
            place_list.append(item);
            place_list.append(&quot;&lt;br&gt;&quot;);
        }
        let types = {&quot;armor&quot;: &quot;armors&quot;, &quot;weapon&quot;: &quot;weapons&quot;, &quot;accessory&quot;: &quot;accessories&quot;};
        for (let type in types) {
            let item_list = $(&quot;#&quot; + types[type] + &quot;_list_names&quot;);
            item_list.empty();
            let items = UInv.GetItemsArrayByItemTag(&quot;inventory&quot;, &quot;type&quot;, type);
            for (let x of items) {
                let item_str = setup.titleCase(UInv.GetItemPropertyValue(&quot;inventory&quot;, x, &quot;name&quot;));
                let equipped_slot = player.has_equipped(x);
                if (equipped_slot != &quot;none&quot;) {
                    equipped_slot = equipped_slot.replace(/\D/g,&#39;&#39;);
                    item_str += &quot; (E&quot; + equipped_slot + &quot;)&quot;;
                }
                let item = $(&quot;&lt;div class=\&quot;tool\&quot;&gt;&quot; + item_str + &quot;&lt;/div&gt;&quot;);
                item.on(&quot;click&quot;, (event) =&gt; {
                    $.wiki(&quot;\
                        &lt;&lt;popover&gt;&gt;&quot; +
                            &quot;&lt;h2&gt;&quot; + UInv.GetItemPropertyValue(&quot;inventory&quot;, x, &quot;name&quot;) + &quot;&lt;/h2&gt;&quot; + 
                            UInv.GetItemPropertyValue(&quot;inventory&quot;, x, &quot;description&quot;) +
                        &quot;&lt;&lt;/popover&gt;&gt;\
                    &quot;);
                });
                item_list.append(item);
                item_list.append(&quot;&lt;br&gt;&quot;);
            }
        }
    }
    let player = State.variables.player;
    $(&quot;#armors_title&quot;).on(&quot;click&quot;, (event) =&gt; {
        $(&quot;#armors_list&quot;).fadeToggle(0.1);
    });
    $(&quot;#weapons_title&quot;).on(&quot;click&quot;, (event) =&gt; {
        $(&quot;#weapons_list&quot;).fadeToggle(0.1);
    });
    $(&quot;#accessories_title&quot;).on(&quot;click&quot;, (event) =&gt; {
        $(&quot;#accessories_list&quot;).fadeToggle(0.1);
    });
    $(&quot;#equip_list&quot;).children().fadeOut(0.1);

    let places = [&quot;head&quot;, &quot;chest&quot;, &quot;legs&quot;, &quot;feet&quot;, &quot;neck&quot;, &quot;weapon&quot;, &quot;groin&quot;];
    for (let place of places) {
        refresh_list(place);
    }
&lt;&lt;/script&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="72" name="playerMenuFinances" tags="" position="225,975" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _total_income = 0&gt;&gt;
&lt;&lt;for _key, _val range $player.finances.businesses&gt;&gt;
    &lt;&lt;set _total_income += _val&gt;&gt;
&lt;&lt;/for&gt;&gt;
&lt;&lt;for _key, _val range $player.finances.slaves&gt;&gt;
    &lt;&lt;set _slave_income = 0&gt;&gt;
    &lt;&lt;for _sub_key, _sub_val range _val&gt;&gt;
        &lt;&lt;set _slave_income += _sub_val&gt;&gt;
    &lt;&lt;/for&gt;&gt;
    &lt;&lt;set _total_income += _slave_income&gt;&gt;
    &lt;&lt;set $player.finances.slaves[_key].total = _slave_income&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;div id=&quot;finances&quot; class=&quot;subbackground hidden&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Finances&lt;/h3&gt;
        &lt;div class=&quot;container twoCol&quot; style=&quot;font-weight: normal&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                Money: &lt;br&gt;
                Passive income: &lt;br&gt;
            &lt;/div&gt;
            &lt;div style=&quot;text-align: right; margin-right: 20px; font-weight: normal&quot;&gt;
                &lt;&lt;= setup.LARI&gt;&gt;&lt;&lt;money&gt;&gt;&lt;br&gt;
                &lt;&lt;= setup.show_money_change_html(0, _total_income)&gt;&gt;&lt;br&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/center&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3 id=&quot;businesses_title&quot; class=&quot;tool&quot;&gt;Businesses&lt;/h3&gt;
        &lt;div id=&quot;businesses_list&quot; class=&quot;container twoCol&quot; style=&quot;font-weight: normal&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                &lt;&lt;for _key, _val range $player.finances.businesses&gt;&gt;
                    &lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
            &lt;div style=&quot;text-align: right; margin-right: 20px; font-weight: normal&quot;&gt;
                &lt;&lt;for _key, _val range $player.finances.businesses&gt;&gt;
                    &lt;&lt;= setup.show_money_change_html(0, _val)&gt;&gt;&lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/center&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3 id=&quot;slaves_title&quot; class=&quot;tool&quot;&gt;Slaves&lt;/h3&gt;
        &lt;div id=&quot;slaves_list&quot; class=&quot;container twoCol&quot; style=&quot;font-weight: normal&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                &lt;&lt;for _key, _val range $player.finances.slaves&gt;&gt;
                    &lt;&lt;= $characters[_key].name()&gt;&gt;: &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
            &lt;div style=&quot;text-align: right; margin-right: 20px; font-weight: normal&quot;&gt;
                &lt;&lt;for _key, _val range $player.finances.slaves&gt;&gt;
                    &lt;&lt;= setup.show_money_change_html(0, $player.finances.slaves[_key].total)&gt;&gt;&lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/center&gt;
&lt;/div&gt;


&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;#businesses_title&quot;).on(&quot;click&quot;, (event) =&gt; {
        $(&quot;#businesses_list&quot;).fadeToggle(0.1);
    });
    $(&quot;#slaves_title&quot;).on(&quot;click&quot;, (event) =&gt; {
        $(&quot;#slaves_list&quot;).fadeToggle(0.1);
    });
&lt;&lt;/script&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="73" name="playerMenuInventory" tags="" position="350,975" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;inventory&quot; class=&quot;subbackground&quot;&gt;
        &lt;hr&gt;
        &lt;center&gt;&lt;h3&gt;Inventory&lt;/h3&gt;
            &lt;&lt;set _items = UInv.GetItemsArrayWithoutAnyItemTags(&quot;inventory&quot;, &quot;type&quot;, 
                [&quot;money&quot;, &quot;quest_item&quot;, &quot;armor&quot;, &quot;accessory&quot;])&gt;&gt;
            &lt;div class=&quot;container twoCol&quot; style=&quot;font-weight: normal&quot;&gt;
                &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                    &lt;&lt;for _i = 0; _i lt _items.length; _i++&gt;&gt;
                        &lt;&lt;= setup.titleCase(UInv.GetItemPropertyValue(&quot;inventory&quot;, _items[_i], &quot;name&quot;))&gt;&gt;
                        &lt;br&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;/div&gt;
                &lt;div style=&quot;text-align: right; margin-right: 20px; font-weight: normal&quot;&gt;
                    &lt;&lt;for _i = 0; _i lt _items.length; _i++&gt;&gt;
                            &lt;&lt;= UInv.BagHasItem(&quot;inventory&quot;, _items[_i])&gt;&gt;
                            &lt;br&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/center&gt;
        &lt;&lt;set _quest_items = UInv.GetItemsArrayByItemTag(&quot;inventory&quot;, &quot;type&quot;, &quot;quest_item&quot;)&gt;&gt;
        &lt;hr&gt;
        &lt;center&gt;&lt;h3&gt;Quest Items&lt;/h3&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px; font-weight: normal&quot;&gt;
                &lt;&lt;for _i = 0; _i lt _quest_items.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(UInv.GetItemPropertyValue(&quot;inventory&quot;, _quest_items[_i], &quot;name&quot;))&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/center&gt;
    &lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="74" name="playerMenu" tags="paper" position="475,975" size="100,100">&lt;&lt;nobr&gt;&gt;

/* For updating versions */
&lt;&lt;if $player.is_slave &amp;&amp; UInv.BagHasItem(&quot;inventory&quot;, &quot;hironaka_amulet&quot;) == 0&gt;&gt;
    &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;hironaka_amulet&quot;, 1)&gt;&gt;
    &lt;&lt;set $player.equipment.neck = &quot;hironaka_amulet&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;div class=&quot;charside left&quot;&gt;
    &lt;div id=&quot;left_actions&quot; class=&quot;mapaction fiveQuarters smalltext&quot;&gt;
        &lt;hr&gt;
        &lt;&lt;disable&gt;&gt;
            @@#stats_but;&lt;&lt;button &quot;Stats&quot;&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
        @@#skills_but;&lt;&lt;button &quot;Skills&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#titles_but;&lt;&lt;button &quot;Titles&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;
&lt;/div&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;div class=&quot;main container threeCol&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div id=&quot;playerMenuLeft&quot;&gt;
            &lt;&lt;set _left_selection = &quot;stats&quot;&gt;&gt;
            &lt;&lt;include playerMenuStats&gt;&gt;
            &lt;&lt;include playerMenuSkills&gt;&gt;
            &lt;&lt;include playerMenuTitles&gt;&gt;
        &lt;/div&gt;

        &lt;div id=&quot;playerMenuCenter&quot;&gt;
            &lt;div class=&quot;subbackground&quot;&gt;
                &lt;center&gt;&lt;h3&gt;$player.first_name
                    &lt;&lt;if $player.is_slave&gt;&gt;
                        Hironaka
                    &lt;&lt;else&gt;&gt;
                        $player.last_name
                    &lt;&lt;/if&gt;&gt;
                &lt;/h3&gt;&lt;/center&gt;
                &lt;&lt;include playerMenuEquip&gt;&gt;

                &lt;div id=&quot;playerMenuImage&quot;&gt;&lt;/div&gt;
                &lt;&lt;timed 20ms&gt;&gt;
                    &lt;&lt;run $(&quot;#playerMenuImage&quot;).css(&quot;background-image&quot;, &quot;url(resources/images/characters/player/&quot; + $player.gender + &quot;.png)&quot;)&gt;&gt;
                &lt;&lt;/timed&gt;&gt;
                &lt;div style=&quot;margin: 15px; margin-left: 30px; margin-right: 30px&quot;&gt;
                    &lt;&lt;showmeter &quot;player_health_bar&quot; `$player.conditions.health/$player.conditions.max_health`&gt;&gt;
                    &lt;&lt;showmeter &quot;player_stamina_bar&quot; `$player.conditions.stamina/$player.conditions.max_stamina`&gt;&gt;
                &lt;/div&gt;
                &lt;center class=&quot;twoThirds&quot;&gt;
                &lt;&lt;button &quot;Back&quot;&gt;&gt;
                    &lt;&lt;set $in_menu = false&gt;&gt;
                    &lt;&lt;goto $last_visited&gt;&gt;
                    &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt; 
                &lt;&lt;/button&gt;&gt;
                &lt;/center&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div id=&quot;playerMenuRight&quot;&gt;
            &lt;&lt;set _right_selection = &quot;inventory&quot;&gt;&gt;
            &lt;&lt;include playerMenuInventory&gt;&gt;
            &lt;&lt;include playerMenuEquipment&gt;&gt;
            &lt;&lt;include playerMenuFinances&gt;&gt;
        &lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;charside right&quot;&gt;
    &lt;div id=&quot;right_actions&quot; class=&quot;mapaction fiveQuarters smalltext&quot;&gt;
        &lt;hr&gt;
        &lt;&lt;disable&gt;&gt;
            @@#inventory_but;&lt;&lt;button &quot;Inventory&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
        @@#equipment_but;&lt;&lt;button &quot;Equipment&quot;&gt;&gt;
            &lt;&lt;timed 60ms&gt;&gt;
                &lt;&lt;removeclass &quot;#equipOverlay&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;/timed&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#finances_but;&lt;&lt;button &quot;Finances&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@        
        &lt;&lt;set _right_selection = &quot;inventory&quot;&gt;&gt;
    &lt;/div&gt;
    &lt;div class=&quot;mapaction fiveQuarters smalltext&quot;&gt;
        @@#quests;&lt;&lt;button &quot;Quests&quot;&gt;&gt;
            &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
            &lt;&lt;popover&gt;&gt;
                &lt;&lt;include questMenu&gt;&gt;
            &lt;&lt;/popover&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#status;&lt;&lt;button &quot;Status&quot;&gt;&gt;
            &lt;&lt;set _selected_status = $player.get_status($last_visited)&gt;&gt;
            &lt;&lt;popover&gt;&gt;
                &lt;&lt;include statusTutorial&gt;&gt;
            &lt;&lt;/popover&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;
    
&lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;#left_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
        $(&quot;#left_actions&quot;).find(&quot;button&quot;).removeClass(&quot;disabled&quot;);
        $(&quot;#left_actions&quot;).find(&quot;button&quot;).prop(&quot;disabled&quot;, false);
        var self = $(event.currentTarget);
        self.addClass(&quot;disabled&quot;);
        self.prop(&quot;disabled&quot;, true);
        var desc = setup.camelize(self.html());
        $(&quot;#&quot; + desc).removeClass(&quot;hidden&quot;);
        $(&quot;#playerMenuLeft&quot;).removeClass(&quot;hidden&quot;);
        $(&quot;#playerMenuCenter&quot;).removeClass(&quot;hidden&quot;);
        $(&quot;#&quot; + State.temporary.left_selection).addClass(&quot;hidden&quot;);
        State.temporary.left_selection = desc;
        $(&quot;#playerMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
    });
    $(&quot;#right_actions&quot;).find(&quot;button&quot;).on(&quot;click&quot;, (event) =&gt; {
        $(&quot;#right_actions&quot;).find(&quot;button&quot;).removeClass(&quot;disabled&quot;);
        $(&quot;#right_actions&quot;).find(&quot;button&quot;).prop(&quot;disabled&quot;, false);
        var self = $(event.currentTarget);
        self.addClass(&quot;disabled&quot;);
        self.prop(&quot;disabled&quot;, true);
        var desc = setup.camelize(self.html());
        $(&quot;#&quot; + desc).removeClass(&quot;hidden&quot;);
        $(&quot;#playerMenuLeft&quot;).removeClass(&quot;hidden&quot;);
        $(&quot;#playerMenuCenter&quot;).removeClass(&quot;hidden&quot;);
        $(&quot;#&quot; + State.temporary.right_selection).addClass(&quot;hidden&quot;);
        State.temporary.right_selection = desc;
        $(&quot;#playerMenuCenterDetails&quot;).addClass(&quot;hidden&quot;);
        $(&quot;#equipOverlay&quot;).addClass(&quot;hidden&quot;);
    });
&lt;&lt;/script&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="75" name="playerMenuSkills" tags="" position="600,975" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;skills&quot; class=&quot;subbackground hidden&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Skills&lt;/h3&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SKILLS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.SKILLS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SKILLS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.round2($player.skills[setup.SKILLS[_i]]).toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/center&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Sex Skills&lt;/h3&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SEX_SKILLS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.SEX_SKILLS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;

            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;for _i = 0; _i lt setup.SEX_SKILLS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.round2($player.sex_skills[setup.SEX_SKILLS[_i]]).toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/center&gt;
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="76" name="playerMenuStats" tags="" position="725,975" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;stats&quot; class=&quot;subbackground&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Stats&lt;/h3&gt;
        &lt;div class=&quot;container twoCol&quot;&gt;
            &lt;div style=&quot;text-align: left; margin-left: 20px&quot;&gt;
                Sex &lt;br&gt;
                Age &lt;br&gt;
                &lt;br&gt;
                &lt;&lt;for _i = 0; _i lt setup.STATS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.titleCase(setup.STATS[_i])&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;

            &lt;div style=&quot;text-align: right; margin-right: 20px&quot;&gt;
                &lt;&lt;if $player.gender == 0&gt;&gt;
                    Male
                &lt;&lt;else&gt;&gt;
                    Female
                &lt;&lt;/if&gt;&gt; &lt;br&gt;
                &lt;&lt;= $player.age()&gt;&gt; &lt;br&gt;
                &lt;br&gt;
                &lt;&lt;for _i = 0; _i lt setup.STATS.length; _i++&gt;&gt;
                    &lt;&lt;= setup.round2($player.stats[setup.STATS[_i]]).toString().padStart(3, &#39;\u2000&#39;)&gt;&gt;
                    &lt;br&gt;
                &lt;&lt;/for&gt;&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/center&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="77" name="playerMenuTitles" tags="" position="850,975" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;titles&quot; class=&quot;subbackground hidden&quot;&gt;
    &lt;hr&gt;
    &lt;center&gt;&lt;h3&gt;Titles&lt;/h3&gt;
        /* Prints all titles and assigns a unique div id to them */
        &lt;div id=&quot;titles_body&quot;&gt;&lt;/div&gt;
        &lt;&lt;set $done_setup = false&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setTimeout(function(){
                var html = &quot;&quot;;
                var titles = Array.from(State.variables.player.titles);
                for (var i = 0; i &lt; titles.length; i++) {
                    html += (&quot;\
                        &lt;div id=\&quot;char_&quot; + titles[i] + &quot;\&quot; class=\&quot;tooltip\&quot;&gt;&quot; +
                            setup.titleCase(titles[i])
                        + &quot;&lt;/div&gt;&lt;br&gt;\
                    &quot;);
                }
                document.getElementById(&quot;titles_body&quot;).innerHTML = html;

                State.variables.done_setup = true;
            }, 1);
        &lt;&lt;/script&gt;&gt;

        /* Creates artificial event-listener for setup of script above */
        &lt;&lt;repeat 20ms&gt;&gt;
            &lt;&lt;if $done_setup&gt;&gt;
                &lt;&lt;for _idx, _title range $player.titles&gt;&gt;
                    &lt;&lt;capture _title&gt;&gt;
                        &lt;&lt;script&gt;&gt;
                            var title = State.temporary.title;
                            $(&quot;#char_&quot; + title).click(
                                function(){
                                    State.variables.selected_title = title;
                                    $.wiki(&quot;&lt;&lt;popover&gt;&gt;&lt;&lt;include titleTutorial&gt;&gt;&lt;&lt;/popover&gt;&gt;&quot;)
                                }
                            );
                        &lt;&lt;/script&gt;&gt;
                    &lt;&lt;/capture&gt;&gt;
                &lt;&lt;/for&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/repeat&gt;&gt;
    &lt;/center&gt;
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="78" name="questMenu" tags="" position="975,975" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;Quest Journal&lt;/h2&gt;
This is your quest journal and where you can view quests that are both ongoing and completed. 
Note that these quests are meant to give a general guide on your experience and are completely 
optional. Whether or not you formally get quests does not affect your ability to reap the rewards 
of completing them (unless it is a direct request from another character).
&lt;&lt;if $quest_journal.ongoing.length gt 0&gt;&gt;
    &lt;h3&gt;Active Quests&lt;/h3&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;for _idx, _val range $quest_journal.ongoing&gt;&gt;
&lt;&lt;capture _val&gt;&gt;
&lt;div class=&quot;quest&quot;&gt;
    &lt;&lt;message setup.quests[_val].name&gt;&gt;&lt;p&gt;
        &lt;div&gt;&lt;&lt;= setup.quests[_val].flavor_text&gt;&gt;&lt;/div&gt;
        &lt;br&gt;
        &lt;ul&gt;
            &lt;li&gt;&lt;&lt;= setup.quests[_val].stages[$quests[_val].stage]&gt;&gt;&lt;/li&gt;
            &lt;&lt;for _i = $quests[_val].stage - 1; _i gte 0; _i--&gt;&gt;
                &lt;&lt;capture _i&gt;&gt;
                &lt;s&gt;&lt;li&gt;&lt;&lt;= setup.quests[_val].stages[_i]&gt;&gt;&lt;/li&gt;&lt;/s&gt;
                &lt;&lt;/capture&gt;&gt;
            &lt;&lt;/for&gt;&gt;
        &lt;/ul&gt;
    &lt;/p&gt;&lt;&lt;/message&gt;&gt;&lt;br&gt;
&lt;/div&gt;
&lt;&lt;/capture&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;set _completed_keys = Object.keys($quest_journal.completed)&gt;&gt;
&lt;&lt;if _completed_keys.length gt 0&gt;&gt;
    &lt;h3&gt;Completed Quests&lt;/h3&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;for _idx, _val range $quest_journal.completed&gt;&gt;
&lt;&lt;capture _val&gt;&gt;
&lt;div class=&quot;quest&quot;&gt;
    &lt;&lt;message setup.quests[_val].name&gt;&gt;&lt;p&gt;
        &lt;div&gt;&lt;&lt;= setup.quests[_val].flavor_text&gt;&gt;&lt;/div&gt;
        &lt;br&gt;
        &lt;ul&gt;
            &lt;&lt;for _idx2, _val2 range setup.quests[_val].stages&gt;&gt;
                &lt;&lt;capture _val2&gt;&gt;
                &lt;s&gt;&lt;li&gt;&lt;&lt;= _val2&gt;&gt;&lt;/li&gt;&lt;/s&gt;
                &lt;&lt;/capture&gt;&gt;
            &lt;&lt;/for&gt;&gt;
        &lt;/ul&gt;
    &lt;/p&gt;&lt;&lt;/message&gt;&gt;&lt;br&gt;
&lt;/div&gt;
&lt;&lt;/capture&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="79" name="settingsMenu" tags="black" position="1100,975" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;center&gt;&lt;h1&gt;Settings&lt;/h1&gt;&lt;/center&gt;
    &lt;div class=&quot;container threeCol&quot;&gt;
        &lt;center id=&quot;left_col&quot; class=&quot;column longbutton smalltext fiveQuarters&quot;&gt;
            &#39;&#39;For Testers&#39;&#39;&lt;br&gt;
            &lt;&lt;textbox &quot;$testing_password&quot; `$testing_password`&gt;&gt;&lt;br&gt;&lt;br&gt;
            @@#submit_password;&lt;&lt;button &quot;Submit&quot;&gt;&gt;
                &lt;&lt;if _insert_cheats($testing_password)&gt;&gt;
                    &lt;&lt;addclass &quot;#submit_password button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#submit_password button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;/center&gt;
        &lt;center&gt;

            &#39;&#39;Text Speed&#39;&#39;
            &lt;br&gt;&lt;br&gt;
            &lt;div class=&quot;textspeed&quot;&gt;
                @@#25;&lt;&lt;button &quot;25%&quot;&gt;&gt;
                    &lt;&lt;set $words_per_sec = 1.5&gt;&gt;
                    /* Enable other options */
                    &lt;&lt;run $(&quot;#25 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#25 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#50 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#50 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#100 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#100 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#200 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#200 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#X button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#X button&quot; &quot;disabled&quot;&gt;&gt;

                &lt;&lt;/button&gt;&gt;@@@@#50;&lt;&lt;button &quot;50%&quot;&gt;&gt;
                    &lt;&lt;set $words_per_sec = 3&gt;&gt;
                    /* Enable other options */
                    &lt;&lt;run $(&quot;#25 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#25 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#50 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#50 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#100 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#100 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#200 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#200 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#X button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#X button&quot; &quot;disabled&quot;&gt;&gt;
                
                &lt;&lt;/button&gt;&gt;@@@@#100;&lt;&lt;button &quot;100%&quot;&gt;&gt;
                    &lt;&lt;set $words_per_sec = 5.5&gt;&gt;
                    /* Enable other options */
                    &lt;&lt;run $(&quot;#25 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#25 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#50 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#50 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#100 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#100 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#200 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#200 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#X button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#X button&quot; &quot;disabled&quot;&gt;&gt;
                
                &lt;&lt;/button&gt;&gt;@@@@#200;&lt;&lt;button &quot;200%&quot;&gt;&gt;
                    &lt;&lt;set $words_per_sec = 11&gt;&gt;
                    /* Enable other options */
                    &lt;&lt;run $(&quot;#25 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#25 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#50 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#50 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#100 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#100 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#200 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#200 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#X button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#X button&quot; &quot;disabled&quot;&gt;&gt;
                
                &lt;&lt;/button&gt;&gt;@@@@#X;&lt;&lt;button &quot;∞&quot;&gt;&gt;
                    &lt;&lt;set $words_per_sec = 1000000&gt;&gt;
                    /* Enable other options */
                    &lt;&lt;run $(&quot;#25 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#25 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#50 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#50 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#100 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#100 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#200 button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass &quot;#200 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#X button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#X button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;/button&gt;&gt;@@

                &lt;&lt;script&gt;&gt;
                    setTimeout(() =&gt; {
                        var words_per_sec = State.variables.words_per_sec;
                        if (words_per_sec &lt;= 1.5) {
                            $(&quot;#25 button&quot;).prop(&quot;disabled&quot;, true);
                            $(&quot;#25 button&quot;).addClass(&quot;disabled&quot;);
                        } else if (words_per_sec &lt;= 3) {
                            $(&quot;#50 button&quot;).prop(&quot;disabled&quot;, true);
                            $(&quot;#50 button&quot;).addClass(&quot;disabled&quot;);
                        } else if (words_per_sec &lt;= 5.5) {
                            $(&quot;#100 button&quot;).prop(&quot;disabled&quot;, true);
                            $(&quot;#100 button&quot;).addClass(&quot;disabled&quot;);
                        } else if (words_per_sec &lt;= 11) {
                            $(&quot;#200 button&quot;).prop(&quot;disabled&quot;, true);
                            $(&quot;#200 button&quot;).addClass(&quot;disabled&quot;);
                        } else {
                            $(&quot;#X button&quot;).prop(&quot;disabled&quot;, true);
                            $(&quot;#X button&quot;).addClass(&quot;disabled&quot;);
                        }
                    }, 10);
                &lt;&lt;/script&gt;&gt;
            &lt;/div&gt;
            &lt;br&gt;
            &lt;hr&gt;
            &#39;&#39;Music Volume&#39;&#39;
            &lt;div style=&quot;margin-left: 20px; margin-right: 20px&quot;&gt;
                &lt;&lt;volume&gt;&gt;
            &lt;/div&gt;
            &lt;hr&gt;
            &lt;&lt;button Saves&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    UI.saves();
                &lt;&lt;/script&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;&lt;button Quit&gt;&gt;
                &lt;&lt;script&gt;&gt;window.close()&lt;&lt;/script&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;hr&gt;
            &lt;br&gt;&lt;br&gt;
            &lt;&lt;button Back&gt;&gt;
                &lt;&lt;set $in_menu = false&gt;&gt;
                &lt;&lt;goto $last_visited&gt;&gt;
                &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt;   
            &lt;&lt;/button&gt;&gt;
        &lt;/center&gt;
    &lt;/div&gt;
    
&lt;/div&gt;


&lt;&lt;silently&gt;&gt;&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;script&gt;&gt;
    State.temporary.insert_cheats = function(password) {
        var success = false;
        if (Number.isInteger(Number(password.trim()))) {
            var query = BigInt(password.trim());
            var n = BigInt(15158877206447097446796853963259);
            var ciph = BigInt(3990845311326955411375403955554);
            if (setup.powMod(ciph, query, n) == BigInt(12028136228824787881037267992576)) {
                success = true;
                $(&quot;#left_col&quot;).wiki(&quot;\
                    &lt;&quot; + &quot;&lt;button \&quot;Trust 100\&quot;&gt;&gt;\
                        &lt;&lt;set $player.slave_traits.trust = 100&gt;&gt;\
                        &lt;&lt;include round&gt;&gt;\
                        &lt;&lt;include updateBars&gt;&gt;\
                    &lt;&quot; + &quot;&lt;/button&gt;&gt;&lt;br&gt;\
                    &lt;&quot; + &quot;&lt;button \&quot;Willpower 100\&quot;&gt;&gt;\
                        &lt;&lt;set $player.slave_traits.willpower = 100&gt;&gt;\
                        &lt;&lt;include round&gt;&gt;\
                        &lt;&lt;include updateBars&gt;&gt;\
                    &lt;&quot; + &quot;&lt;/button&gt;&gt;\
                    &lt;&quot; + &quot;&lt;button `setup.LARI + \&quot;1000\&quot;`&gt;&gt;\
                        &lt;&lt;addmoney 1000&gt;&gt;\
                        &lt;&lt;audio coins_sound play&gt;&gt;\
                        &lt;&lt;updatetime&gt;&gt;\
                    &lt;&quot; + &quot;&lt;/button&gt;&gt;\
                &quot;);
            }
        }
        if (!success) {
            $.wiki(&quot;&lt;&lt;notify&gt;&gt;Incorrect password!&lt;&lt;/notify&gt;&gt;&quot;)
        }
        return success;
    }
&lt;&lt;/script&gt;&gt;&lt;&lt;/timed&gt;&gt;&lt;&lt;/silently&gt;&gt;


&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="80" name="niponActions" tags="" position="1225,975" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;actions&quot; class=&quot;mapaction fiveQuarters smalltext&quot;&gt;
        &lt;hr&gt;
        &lt;&lt;set _added = 0&gt;&gt;
        &lt;&lt;for _key, _val range setup.locations.get(passage()).sublocations&gt;&gt;
            &lt;&lt;if _key == &quot;shintaniHome&quot;&gt;&gt;
                &lt;&lt;continue&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;capture _key&gt;&gt;
                &lt;&lt;set _location_button_dest = setup.locations.get(_key).passage&gt;&gt;
                &lt;&lt;include locationButton&gt;&gt;
            &lt;&lt;/capture&gt;&gt;
            &lt;&lt;set _added += 1&gt;&gt;
        &lt;&lt;/for&gt;&gt;

        /* Add 11 slots */
        &lt;&lt;for _i = _added; _i lt 11; _i++&gt;&gt;
            &lt;div class=&quot;buttonfiller fiveQuarters&quot;&gt;&lt;/div&gt;
        &lt;&lt;/for&gt;&gt;
        &lt;&lt;unset _added&gt;&gt;

        &lt;hr&gt;

        &lt;&lt;if passage() != &quot;niponCentral&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;disable&gt;&gt;
                &lt;&lt;button &quot;Central&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;&lt;/disable&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;if passage() != &quot;niponMarket&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;niponMarket&quot;&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;disable&gt;&gt;
                &lt;&lt;button &quot;Market&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;&lt;/disable&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;if passage() != &quot;niponSlums&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;niponSlums&quot;&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;disable&gt;&gt;
                &lt;&lt;button &quot;Slums&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
            &lt;&lt;/disable&gt;&gt;
        &lt;&lt;/if&gt;&gt;

        &lt;div&gt;
            &lt;&lt;set _location_button_text = &quot;Home&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;shintaniHome&quot;&gt;&gt;
            &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;/div&gt;
        &lt;hr&gt;
    &lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="81" name="liasTowerActions" tags="" position="100,1100" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;actions&quot; class=&quot;action container row col longbutton fiveQuarters&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;
    &lt;&lt;set _queue_talk = false&gt;&gt;
    &lt;&lt;button &quot;Talk&quot;&gt;&gt;
        &lt;&lt;if !_queue_talk&gt;&gt;
            &lt;&lt;set _queue_talk = true&gt;&gt;
            &lt;&lt;set _options = &quot;\
                &lt;ol&gt;\
                    &lt;li id=\&quot;li1\&quot;&gt;\&quot;Can you tell me more about Shintani?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li2\&quot;&gt;\&quot;Can you tell me more about Nipon?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li3\&quot;&gt;\&quot;Why doesn\&#39;t Shintani sell you off as well?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li4\&quot;&gt;\&quot;Why are you still in Nipon?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li5\&quot;&gt;\&quot;What do you want to see Nipon become?\&quot;&lt;/li&gt;\
            &quot;&gt;&gt;
            &lt;&lt;if $quests.power_struggles.stage == 1&gt;&gt;
                &lt;&lt;set _options += &quot;&lt;li id=\&quot;li6\&quot;&gt;\&quot;What did you need me to do again?\&quot;&lt;/li&gt;&quot;&gt;&gt;
            &lt;&lt;elseif $quests.power_struggles.stage == 3&gt;&gt;
                &lt;&lt;set _options += &quot;&lt;li id=\&quot;li6\&quot;&gt;\&quot;I got the things you asked of me.\&quot;&lt;/li&gt;&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _options = $(_options)&gt;&gt;
            &lt;&lt;set _responses = [_options.clone()]&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;/if&gt;&gt;

        &lt;&lt;set _disable_buttons = false&gt;&gt;
        &lt;&lt;disableactions _options&gt;&gt;
        
        &lt;&lt;addclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;removeclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;    

    &lt;div style=&quot;grid-row: 1; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 3; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="82" name="liasTower" tags="black" position="225,1100" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _lia = $characters.lia_hiroyuki&gt;&gt;

&lt;&lt;if $quests.power_struggles.stage == 0&gt;&gt;
    /* Add tutorial */
    &lt;&lt;if tale.has(passage() + &quot;Tutorial&quot;)&gt;&gt;
        &lt;&lt;set $tutorials[passage()] = passage() + &quot;Tutorial&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* Update quest */
    &lt;&lt;set $quests.power_struggles.stage = 1&gt;&gt;
    &lt;&lt;set $quests.power_struggles.data.side = &quot;lia&quot;&gt;&gt;

    &lt;&lt;set $_to_log = &quot;
        &lt;div&gt;You enter Lia\&#39;s tower to find her sitting and staring into the horizon. \
        She notices that you arrived and turns around to greet you.&lt;/div&gt;&lt;br&gt;&quot; + 
        $characters.lia_hiroyuki.dialogue(&quot;\
            Oh, I didn\&#39;t think you would actually come. Normally I\&#39;m not allowed to have \
            any visitors, but since you are technically property of the Hiroyuki family, you \
            are an exception. Here, have a seat.\
        &quot;) + 
        &quot;&lt;ol&gt;\
            &lt;li&gt;Take a seat.&lt;/li&gt;\
        &lt;/ol&gt;&quot;
    &gt;&gt;
    &lt;&lt;set _init_sequence = true&gt;&gt;
    &lt;&lt;timed 50ms&gt;&gt;
        &lt;&lt;removeclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;set _choices = 1&gt;&gt;
        &lt;&lt;disableactions&gt;&gt;
    &lt;&lt;/timed&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;set $_to_log = &quot;
        &lt;div&gt;You enter Lia\&#39;s tower to find her sitting and staring into the horizon. \
        She notices that you arrived and turns around to greet you.&lt;/div&gt;&lt;br&gt;&quot; + 
        $characters.lia_hiroyuki.dialogue(&quot;You\&#39;re back.&quot;)
    &gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;

/* Audio engine */
 

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;div class=&quot;main container fourCol threeRow&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div class=&quot;subbackground mainLogContainer&quot;&gt;
            &lt;&lt;include mainLog&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setTimeout(() =&gt; {
                    var lia = State.variables.characters.lia_hiroyuki;
                    $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                        &quot;url(\&quot;&quot; + lia.image_folder() + &quot;lia_sitting_&quot; + lia.get_disposition() + &quot;.png\&quot;)&quot;
                    );
                }, 10);
            &lt;&lt;/script&gt;&gt;
        &lt;/div&gt;
        &lt;&lt;include info&gt;&gt;

        &lt;div id=&quot;action_bar&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 3 / span 1; grid-column: 1 / span 3&quot;&gt;
            &lt;&lt;include liasTowerActions&gt;&gt;
            &lt;&lt;include liasTowerTalkOptions&gt;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="83" name="liasTowerTalkOptions" tags="" position="350,1100" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;events_actions&quot; class=&quot;action container row col hidden&quot;
         style=&quot;--rows: 4; --cols: 5&quot;&gt;

    @@#events1;.event_button;&lt;&lt;button &quot;1&quot;&gt;&gt;
        &lt;&lt;if def _init_sequence &amp;&amp; _init_sequence&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You take a seat across from Lia,&quot;,
                _lia.dialogue(&quot;\
                    I\&#39;m assuming you don\&#39;t know who I am right? While I\&#39;m sure you have guessed by now that \
                    I am Shin\&#39;s sister, my past is stained with blood as is the rest of our family. Shin has \
                    dishonored the Hiroyuki family name by first selling off our parents many years ago.&quot;),
                &quot;Lia pauses for a second to regain her composure,&quot;,
                _lia.dialogue(&quot;Look, if you want out of your situation, go into Shin\&#39;s office at night and \
                    bring me his transaction logs. I need everything you can find. Also I need you to go into \
                    the library and get me our family history. It might be hidden away, but look for a crest like \
                    this.&quot;),
                &quot;Lia brings out a golden pendant which has a three leaves enclosed within a circle. It resembles \
                the crest you know very well, but the entchings and geometry of one around your neck are pervertered \
                beyond recognition. Lia sees the momentary weakness within your eyes, and puts her hand on your leg,&quot;,
                _lia.dialogue(&quot;Trust me, I know your suffering better than you can imagine. Help me free you.&quot;)
            ]&gt;&gt;
            &lt;&lt;run $(&quot;.event_button button&quot;).addClass(&quot;hidden&quot;)&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;removeclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;
                &lt;&lt;unset _done_appending&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif ndef _action&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li1&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _action = 1&gt;&gt;
            &lt;&lt;set _sub_options = $(&quot;&lt;ol&gt;\
                    &lt;li id=\&quot;li1\&quot;&gt;\&quot;What was like Shintani when he was young?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li2\&quot;&gt;\&quot;What are Shintani\&#39;s true goals?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li3\&quot;&gt;\&quot;Nevermind\&quot;&lt;/li&gt;\
                &lt;/ol&gt;&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;Lia lets out a long sigh,&quot;,
                _lia.dialogue(&quot;Well... ask away, what did you want to know?&quot;),
                _sub_options.clone()
            ]&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 3&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 1&gt;&gt;
            &lt;&lt;set _sub_options.find(&quot;#li1&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;Lia is visably puzzled at why you\&#39;d inquire about that, but she obliges&quot;,
                _lia.dialogue(&quot;Being the only male heir in the Hiroyuki household, Shin was treated as royalty \
                    since the day he was born. Our father especially had always told Shin that he was special and \
                    above others. I think his many servants at the time led him to develop a control complex. When \
                    one day he could no longer control the whims of our parents, he staged a coup, taking control \
                    of Nipon, selling off our parents, and sending assassins for me. Since then he was obsessed \
                    with slavery and controlling others. If only dad had known... Oh how we all loved Shin when he \
                    was younger...&quot;),
                &quot;You see Lia\&#39;s eyes slightly glaze over as her voice breaks off,&quot;,
                _lia.dialogue(&quot;Sorry about that... anything else?&quot;),
                _sub_options.clone()
            ]&gt;&gt;
        &lt;&lt;elseif _action == 2&gt;&gt;
            &lt;&lt;set _sub_options.find(&quot;#li1&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;Lia sighs again&quot;,
                _lia.dialogue(&quot;It is very unfortunate for all of us that Nipon is so successful. The analysts at the Union \
                    have thought about this issue and our conclusion is that it\&#39;s due to Nipon great location. Because of \
                    the East Great Desert, Nipon is completely isolated from the world by land. Furthermore, my parents \
                    had the foresight to heavily invest in our docks, so we can be isolationist whilst still benefitting \
                    from the trade routes of the Union. Shin is convinced that Nipons success is all due to him and his \
                    increasingly concerning policies regarding slavery.&quot;),
                _lia.dialogue(&quot;Is that all?&quot;),
                _sub_options.clone()
            ]&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events2;.event_button;&lt;&lt;button &quot;2&quot;&gt;&gt;
        &lt;&lt;if ndef _action&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li2&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _action = 2&gt;&gt;
            &lt;&lt;set _sub_options = $(&quot;&lt;ol&gt;\
                    &lt;li id=\&quot;li1\&quot;&gt;\&quot;What makes Nipon successful?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li2\&quot;&gt;\&quot;How did Nipon start?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li3\&quot;&gt;\&quot;Why is Nipon so... oriental? Has it always been this way?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li4\&quot;&gt;\&quot;Nevermind\&quot;&lt;/li&gt;\
                &lt;/ol&gt;&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;Lia lets out a long sigh,&quot;,
                _lia.dialogue(&quot;Well... ask away, what did you want to know?&quot;),
                _sub_options.clone()
            ]&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 4&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 1&gt;&gt;
            &lt;&lt;set _sub_options.find(&quot;#li2&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                _lia.dialogue(&quot;Not freedom. He claims to want a \&quot;Free City,\&quot; but his definitions of freedom \
                    are a complete perversion of the word. He wants to give everyone freedom by removing the need \
                    to worry about choice. He wants to resolve all interpersonal conflict by performing mass eugenics \
                    to completely cull the population of anyone not of eastern Asian descent. He wants to bring his \
                    people happiness by getting them addicted to drugs and dulling their senses. Monster would be putting \
                    it lightly. This is why we at the Trade Union are making a move.&quot;),
                _lia.dialogue(&quot;Anything else you wanted to know?&quot;),
                _sub_options.clone()
            ]&gt;&gt;
        &lt;&lt;elseif _action == 2&gt;&gt;
            &lt;&lt;set _sub_options.find(&quot;#li2&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                _lia.dialogue(&quot;Well I\&#39;m sure Shin will tell you it was gifted to us by the gods, but actually our ancestors \
                    conquered Nipon from the Namm household many years ago. In fact the day that Nipon started is year 0 of the \
                    standard calendar. At that time Nipon worked hand-in-hand with the Trade Union, so the Nipon calendar was \
                    popularized through that.&quot;),
                _lia.dialogue(&quot;Anything else you wanted to know?&quot;),
                _sub_options.clone()
            ]&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events3;.event_button;&lt;&lt;button &quot;3&quot;&gt;&gt;
        &lt;&lt;if ndef _action&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li3&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                _lia.dialogue(&quot;Well actually when my parents were sold off he sent assassins after me. \
                    I guess my parents held some prestige of the Hiroyuki household thus there were buyers, \
                    but not me. I very luckily ran into the Trade Union, which as you know is an independent \
                    entity from Nipon. They took me in, and now Shin can\&#39;t touch me. He has tried everything \
                    he could from limiting my movements though, even isolating me to a tower on the outskirts of \
                    town.&quot;),
                _options.clone()
            ]&gt;&gt;
        &lt;&lt;elseif _action == 1&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;set _responses = [
                _lia.dialogue(&quot;What did you need?&quot;),
                _options.clone()
            ]&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions _options&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 2&gt;&gt;
            &lt;&lt;set _sub_options.find(&quot;#li3&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;Your question catches Lia off guard, and she chuckles a little to herself&quot;,
                _lia.dialogue(&quot;Nipon has always been a little \&quot;oriental\&quot; as you call it, because when the Hiroyuki family \
                    conquered Nipon from the Namm household we wanted to integrate our cultures as fast as possible. However \
                    Nipon as you know it now is way more extreme then it ever was before. This is due to Shin\&#39;s racial \
                    superiority. I\&#39;m pretty sure he just wants an excuse to be above others. While our parents did always \
                    teach us to appreciate our own culture due to the limited number of east Asians left today, they also \
                    always stressed the importance of diversity. Diversity is important in any system to ensure the continued \
                    survival of a species. The same is true for civilizations as well. Shin is heading down a dark path.&quot;),
                &quot;You are shocked at Lia\&#39;s depth of knowledge&quot;,
                $player.dialogue(&quot;How... do you know all this?&quot;),
                _lia.dialogue(&quot;Haha... that\&#39;s a fair response. Not even Shin knows about how Nipon came to be. I\&#39;m sure if \
                    you asked him, he\&#39;d spout some garbage about the gods as our father always told him. But, I think he only \
                    pretends to care, because this information is readily available if you search through our old books. But of \
                    course that would delegitimize Shin\&#39;s position. Anyways, anything else?&quot;),
                _sub_options.clone()
            ]&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events4;.event_button;&lt;&lt;button &quot;4&quot;&gt;&gt;
        &lt;&lt;if ndef _action&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li4&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                _lia.dialogue(&quot;As in why not leave? Well firstly despite my brother trying to limit my rights \
                    Nipon is still better than the outside world. Plus I\&#39;m still a Hiroyuki... and well I guess \
                    I also don\&#39;t want to just leave my home because of Shin. If I do that, he wins doesn\&#39;t he? \
                    I guess despite being much more intelligent than Shin I can still be irrationall sentimental \
                    at times.&quot;),
                    _options.clone()
            ]&gt;&gt;
        &lt;&lt;elseif _action == 2&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;set _responses = [
                _lia.dialogue(&quot;What did you need?&quot;),
                _options.clone()
            ]&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions _options&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events5;.event_button;&lt;&lt;button &quot;5&quot;&gt;&gt;
        &lt;&lt;set _options.find(&quot;#li5&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
        &lt;&lt;set _responses = [
            _lia.dialogue(&quot;Nipon needs to return to its origins. I want to see this trend of slavery \
                abolished not matter what, and I want to prove to people that true freedom is possible even \
                in this wretched world. And...&quot;),
            &quot;Lia\&#39;s words fade off and she turns again to stare at the horizon,&quot;,
            _lia.dialogue(&quot;I... I just want my home back. I miss my family.&quot;),
            _options.clone()
        ]&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events6;.event_button;&lt;&lt;button &quot;6&quot;&gt;&gt;
        &lt;&lt;set _options.find(&quot;#li6&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
        &lt;&lt;if $quests.power_struggles.stage == 1&gt;&gt;
            &lt;&lt;set _responses = [
                $player.dialogue(&quot;So what did you need me to do again?&quot;),
                _lia.dialogue(&quot;I need you to steal Shin\&#39;s transaction log from his office and \
                    I also need the copy of the Hiroyuki family registry from his library. Bring them \
                    to me and I will ensure your eventual freedom.&quot;),
                &quot;Lia eyes you expecting your next question,&quot;,
                _options.clone()
            ]&gt;&gt;
        &lt;&lt;elseif $quests.power_struggles.stage == 3&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;UNDER CONSTRUCTION&quot;
            ]&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events7;.event_button;&lt;&lt;button &quot;7&quot;&gt;&gt;

    &lt;&lt;/button&gt;&gt;@@
    @@#events8;.event_button;&lt;&lt;button &quot;8&quot;&gt;&gt;

    &lt;&lt;/button&gt;&gt;@@

    &lt;&lt;set $buttons = []&gt;&gt;
    &lt;&lt;for _i = 1; _i lte 8; _i++&gt;&gt;
        &lt;&lt;set $buttons.push(&quot;#events&quot; + _i)&gt;&gt;
    &lt;&lt;/for&gt;&gt;
    &lt;&lt;set $buttons_extra = [&quot;#events_actions_back&quot;, &quot;#events_actions_leave&quot;]&gt;&gt;

    /* Back button is disabled by default */
    &lt;div style=&quot;grid-row: 1; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;events_actions_back&quot; style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div id=&quot;events_actions_leave&quot; style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;.event_button button&quot;).on(&quot;click&quot;, (event) =&gt; {
        var self = $(event.currentTarget);
        self.addClass(&quot;disabled&quot;);
        self.prop(&quot;disabled&quot;, true);

        setup.mainLog_append_delayed(State.temporary.responses, 
            State.variables.buttons, 
            State.variables.buttons_extra);
        delete State.temporary.responses;
    });
&lt;&lt;/script&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/timed&gt;&gt;




&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="84" name="niponBarracksActions" tags="" position="475,1100" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;actions&quot; class=&quot;action container row col longbutton fiveQuarters&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    &lt;&lt;button &quot;Emily&quot;&gt;&gt;
        &lt;&lt;removeclass &quot;#emily_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
            &quot;url(&quot; + _emily.image_folder() + &quot;emily_neutral.png)&quot;)&gt;&gt;
        &lt;&lt;set _responses = [&quot;You walk into Emily\&#39;s quarters to find her lost in thought.&quot;]&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses);
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;/button&gt;&gt; 


    &lt;&lt;disable&gt;&gt;
        &lt;&lt;button &quot;Medic Bay&quot;&gt;&gt;

        &lt;&lt;/button&gt;&gt;
    &lt;&lt;/disable&gt;&gt;

    &lt;div style=&quot;grid-row: 1; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 3; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="85" name="niponBarracksEmilyActions" tags="" position="600,1100" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;emily_actions&quot; class=&quot;action container row col longbutton fiveQuarters hidden&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    &lt;&lt;button &quot;Talk&quot;&gt;&gt;
        &lt;&lt;set _choices = 4&gt;&gt;
        &lt;&lt;set _options = &quot;\
            &lt;ol&gt;\
                &lt;li id=\&quot;li1\&quot;&gt;\&quot;Do you work for Shintani?\&quot;&lt;/li&gt;\
                &lt;li id=\&quot;li2\&quot;&gt;\&quot;How do you like Nipon?\&quot;&lt;/li&gt;\
                &lt;li id=\&quot;li3\&quot;&gt;\&quot;What\&#39;s your background?\&quot;&lt;/li&gt;\
                &lt;li id=\&quot;li4\&quot;&gt;\&quot;Do you have any hopes or dreams?\&quot;&lt;/li&gt;\
        &quot;&gt;&gt;
        &lt;&lt;if $quests.path_to_greatness.stage == 1&gt;&gt;
            &lt;&lt;if $player.get_money() gte 300&gt;&gt;
                &lt;&lt;set _options += &quot;&lt;li id=\&quot;li5\&quot;&gt;\&quot;I\&#39;d like like to pay my equipment fee (¤300)\&quot;&lt;/li&gt;&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _options += &quot;&lt;li id=\&quot;li5\&quot;&gt;\&quot;I can\&#39;t afford the equipment fee, is there any other way?\&quot;&lt;/li&gt;&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _choices += 1&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _responses = [&quot;You approach Emily, what would you like to say?&quot; + _options]&gt;&gt;
        &lt;&lt;set _disable_buttons = false&gt;&gt;
        &lt;&lt;disableactions&gt;&gt;
        
        &lt;&lt;addclass &quot;#emily_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;removeclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
            &quot;url(&quot; + _emily.image_folder() + &quot;emily_neutral.png)&quot;)&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;set _options = $(_options)&gt;&gt;
    &lt;&lt;/button&gt;&gt; 

    &lt;&lt;disable&gt;&gt;
        @@#train;&lt;&lt;button &quot;Train&quot;&gt;&gt;
            &lt;&lt;if $gameDate.getHours() gt 16&gt;&gt;
                &lt;&lt;notify&gt;&gt;
                    Too late to train!
                &lt;&lt;/notify&gt;&gt;
            &lt;&lt;elseif $player.stats.stamina lt (4 * -180 * ((3/10 * $player.stats.strength - $time_awake / 7) - _to_advance_hr * 30 / 7) / 1440)&gt;&gt;
                &lt;&lt;notify&gt;&gt;
                    Too tired to train!
                &lt;&lt;/notify&gt;&gt;
            &lt;&lt;elseif $player.get_money() lt 50&gt;&gt;
                &lt;&lt;notify&gt;&gt;
                    Need ¤50 to train!
                &lt;&lt;/notify&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;if !$quest_journal.completed.contains(&quot;path_to_greatness&quot;)&gt;&gt;
                    &lt;&lt;set $quest_journal.completed.push(&quot;path_to_greatness&quot;)&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $_temp_to_log = &quot;You train rigorously for four hours (Dexterity &quot; + 
                    setup.show_change_html(0, 1) + &quot;, Strength &quot; + 
                    setup.show_change_html(0, 1) + &quot;)&quot;&gt;&gt;
                &lt;&lt;set $player.stats.dexterity += 1&gt;&gt;
                &lt;&lt;set $player.stats.strength += 1&gt;&gt;
                &lt;&lt;removemoney 50&gt;&gt;
                &lt;&lt;run UInv.AddItem(&quot;emily_namm&quot;, &quot;lari&quot;, 50)&gt;&gt;
                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                &lt;&lt;addhours 4&gt;&gt;
                &lt;&lt;set $player.conditions.stamina -= 40&gt;&gt;
                &lt;&lt;include round&gt;&gt;
                &lt;&lt;goto &quot;niponBarracks&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;
    &lt;&lt;timed 50ms&gt;&gt;
        &lt;&lt;if $quests.path_to_greatness.stage gt 1 || $quest_journal.completed.contains(&quot;path_to_greatness&quot;)&gt;&gt;
            &lt;&lt;removeclass &quot;#train button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#train button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/timed&gt;&gt;

    &lt;div style=&quot;grid-row: 1; grid-column: 4&quot;&gt;
        &lt;&lt;button &quot;Inspect&quot;&gt;&gt;
            &lt;&lt;set $selected = _emily.key&gt;&gt;
            &lt;&lt;set _char = _emily&gt;&gt;
            &lt;&lt;set $last_visited = passage()&gt;&gt;
            &lt;&lt;set $in_menu = true&gt;&gt;
            &lt;&lt;saveVars&gt;&gt;
            &lt;&lt;goto characterMenu&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 4&quot;&gt;
    
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 3; grid-column: 4&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#emily_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;, &quot;&quot;)&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="86" name="niponBarracks" tags="black" position="725,1100" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _emily = $characters.emily_namm&gt;&gt;

&lt;&lt;if $quests.path_to_greatness.stage == 0&gt;&gt;
    /* Add tutorial */
    &lt;&lt;if tale.has(passage() + &quot;Tutorial&quot;)&gt;&gt;
        &lt;&lt;set $tutorials[passage()] = passage() + &quot;Tutorial&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

     

    /* Update quest */
    &lt;&lt;set $quests.path_to_greatness.stage = 1&gt;&gt;

    &lt;&lt;set $_to_log = &quot;
        &lt;div&gt;The Nipon barracks carry within a distinct mood of diligence. You hear multiple \
        people training in the distance, and you can only imagine the terrors that have gone \
        on within these walls. A muscular olive skinned woman approaches you,&lt;/div&gt;&lt;br&gt;&quot; + 
        _emily.dialogue(&quot;\
            Who are you and why have you come? Are you a new recruit for the army?\
        &quot;) + &quot;\
        &lt;ol&gt;\
            &lt;li&gt;\&quot;I\&#39;m &quot; + $player.name() + &quot; and I\&#39;m looking to train along side the troops.\&quot;&lt;/li&gt;\
            &lt;li&gt;\&quot;I\&#39;m &quot; + $player.name() + &quot; and I\&#39;m just looking around.\&quot;&lt;/li&gt;\
        &quot;
    &gt;&gt;
    &lt;&lt;set _init_sequence = true&gt;&gt;
    &lt;&lt;timed 50ms&gt;&gt;
        &lt;&lt;set _choices = 2&gt;&gt;
        &lt;&lt;disableactions&gt;&gt;
        
        &lt;&lt;removeclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
            &quot;url(&quot; + _emily.image_folder() + &quot;emily_neutral.png)&quot;)&gt;&gt;
    &lt;&lt;/timed&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;set $_to_log = &quot;
        &lt;div&gt;The Nipon barracks carry within a distinct mood of diligence. You hear multiple \
        people training in the distance, and you can only imagine the terrors that have gone \
        on within these walls.&lt;/div&gt;&lt;br&gt;&quot;
    &gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;

/* Audio engine */
 

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;div class=&quot;main container fourCol threeRow&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div class=&quot;subbackground mainLogContainer&quot;&gt;
            &lt;&lt;include mainLog&gt;&gt;
        &lt;/div&gt;
        &lt;&lt;include info&gt;&gt;

        &lt;div id=&quot;action_bar&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 3 / span 1; grid-column: 1 / span 3&quot;&gt;
            &lt;&lt;include niponBarracksActions&gt;&gt;
            &lt;&lt;include niponBarracksEmilyActions&gt;&gt;
            &lt;&lt;include niponBarracksTalkOptions&gt;&gt;

        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="87" name="niponBarracksTalkOptions" tags="" position="850,1100" size="100,100">&lt;&lt;nobr&gt;&gt;

/* For ease */
&lt;&lt;set _emily = $characters.emily_namm&gt;&gt;

&lt;div id=&quot;events_actions&quot; class=&quot;action container row col hidden&quot;
         style=&quot;--rows: 4; --cols: 5&quot;&gt;

    @@#events1;&lt;&lt;button &quot;1&quot;&gt;&gt;
        &lt;&lt;if def _init_sequence &amp;&amp; _init_sequence&gt;&gt;
            &lt;&lt;unset _init_sequence&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;Emily looks you up and down,&quot;,
                _emily.dialogue(&quot;I don\&#39;t know you, and I don\&#39;t like strangers. I\&#39;m in charge of the \
                    training corp here. If you want to train with me you\&#39;ll have to pay each session \
                    as well as an initial fee of 300 lari for your equipment.&quot;),
                &quot;Emily turns around and heads back into the main quarters.&quot;
            ]&gt;&gt;
            &lt;&lt;set _done_appending = false&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;unset _done_appending&gt;&gt;
                &lt;&lt;removeclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;, &quot;&quot;)&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif ndef _action&gt;&gt;
            &lt;&lt;set _responses = [&quot;UNDER CONSTRUCTION&quot;]&gt;&gt;
        &lt;&lt;elseif _action == 5 || _subaction == 3&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;unset _subaction&gt;&gt;
            &lt;&lt;set _responses = [
                _emily.dialogue(&quot;Begging and you can\&#39;t even beg properly? Is this the quality \
                    of Shintani\&#39;s slaves these days? Disgraceful, you\&#39;ll have to pay the \
                    fee like everyone else. Why are you still here?&quot;),
                _options
            ]&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;unset _done_appending&gt;&gt;
                &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                    &quot;url(&quot; + _emily.image_folder() + &quot;emily_neutral.png)&quot;)&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses, 
                State.variables.buttons, 
                State.variables.buttons_extra);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;unset _responses&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events2;&lt;&lt;button &quot;2&quot;&gt;&gt;
        &lt;&lt;if def _init_sequence &amp;&amp; _init_sequence&gt;&gt;
            &lt;&lt;unset _init_sequence&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;Emily looks you up and down,&quot;,
                _emily.dialogue(&quot;I don\&#39;t know you, and I don\&#39;t like strangers. I\&#39;m in charge of the \
                    training corp here. If you want to train with me you\&#39;ll have to pay each session \
                    as well as an initial fee of 300 lari for your equipment, else move along we don\&#39;t like \
                    tourists here.&quot;),
                &quot;Emily turns around and heads back into the main quarters.&quot;
            ]&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;removeclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;, &quot;&quot;)&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif ndef _action&gt;&gt;
            &lt;&lt;set _responses = [&quot;UNDER CONSTRUCTION&quot;]&gt;&gt;
        &lt;&lt;elseif _action == 5 &amp;&amp; ndef _subaction&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li5&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You get down on your knees, cupping Emily\&#39;s sweaty foot in your hands and \
                starting licking. Your tongue slides in between each toes, capturing every bit \
                of saltiness. After her feet have been completely drenched in your saliva you can \
                smell her fluids through her pants.&quot;,
                _emily.dialogue(&quot;Um... okay, you can stop now... Come train with me anytime, \
                    did you need anything else?&quot;) + &quot;(Willpower &quot; + 
                    setup.show_change_html(0, -4) + &quot;) (Emily\&#39;s Foot Fetish &quot; + 
                    setup.show_change_html(0, 2) + &quot;)&quot;,
                _options.clone()
            ]&gt;&gt;
            &lt;&lt;set _emily.sex_fetishes.feet += 2&gt;&gt;
            &lt;&lt;set $player.slave_traits.willpower -= 4&gt;&gt;
            &lt;&lt;set $quests.path_to_greatness.stage = 2&gt;&gt;
            &lt;&lt;removeclass &quot;#train button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#train button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;set _done_appending = false&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;unset _done_appending&gt;&gt;
                &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                    &quot;url(&quot; + _emily.image_folder() + &quot;emily_neutral.png)&quot;)&gt;&gt;
                &lt;&lt;set _choices = 4&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 5 &amp;&amp; _subaction == 3&gt;&gt;
            &lt;&lt;unset _subaction&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li5&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You continue licking Emily\&#39;s feet covered with your cum until you clean up \
                every last drop.&quot;,
                _emily.dialogue(&quot;Good boy. Now you can train with me now. Now did you \
                    need anything else dog?&quot;) + &quot;(Willpower &quot; + 
                    setup.show_change_html(0, -4) + &quot;) (Emily\&#39;s Foot Fetish &quot; + 
                    setup.show_change_html(0, 2) + &quot;)&quot;,
                _options.clone()
            ]&gt;&gt;
            &lt;&lt;set _emily.sex_fetishes.feet += 2&gt;&gt;
            &lt;&lt;set $player.slave_traits.willpower -= 4&gt;&gt;
            &lt;&lt;set $quests.path_to_greatness.stage = 2&gt;&gt;
            &lt;&lt;removeclass &quot;#train button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#train button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;set _done_appending = false&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;unset _done_appending&gt;&gt;
                &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                    &quot;url(&quot; + _emily.image_folder() + &quot;emily_neutral.png)&quot;)&gt;&gt;
                &lt;&lt;set _choices = 4&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses, 
                State.variables.buttons, 
                State.variables.buttons_extra);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;unset _responses&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events3;&lt;&lt;button &quot;3&quot;&gt;&gt;
        &lt;&lt;if ndef _action&gt;&gt;
            &lt;&lt;set _responses = [&quot;UNDER CONSTRUCTION&quot;]&gt;&gt;
        &lt;&lt;elseif _action == 5&gt;&gt;
            &lt;&lt;set _subaction = 3&gt;&gt;
            &lt;&lt;set _responses = [
                &quot;You get down on your knees, cupping Emily\&#39;s sweaty foot in your hands and \
                starting licking. As your tongue slides in between each toes, you slide down your \
                pants and start stroking your cock. Emily doesn&#39;t say anything and looks even more \
                amused,&quot;,
                _emily.dialogue(&quot;Haha, that\&#39;s a good dog! You like this don\&#39;t you?&quot;),
                $player.dialogue(&quot;Yes mistress.&quot;),
                &quot;After her feet have been completely drenched in your saliva you can \
                smell her fluids through her pants and you cum at the same time, covering \
                her feet. (Willpower &quot; + 
                    setup.show_change_html(0, -4) + &quot;)&quot;,
                _emily.dialogue(&quot;What the fuck? You cleaned my feet just to get them dirty again? \
                    Lick it all off. NOW.&quot;),
                &quot;&lt;ol&gt;\
                    &lt;li&gt;Refuse.&lt;/li&gt;\
                    &lt;li&gt;Do as she says.&lt;/li&gt;\
                &lt;/ol&gt;&quot;
            ]&gt;&gt;
            &lt;&lt;set $player.slave_traits.willpower -= 4&gt;&gt;
            &lt;&lt;set _done_appending = false&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;unset _done_appending&gt;&gt;
                &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                    &quot;url(&quot; + _emily.image_folder() + &quot;emily_foot_cum.png)&quot;)&gt;&gt;
                &lt;&lt;set _choices = 2&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses, 
                State.variables.buttons, 
                State.variables.buttons_extra);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;unset _responses&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events4;&lt;&lt;button &quot;4&quot;&gt;&gt;
        &lt;&lt;if ndef _action&gt;&gt;
            &lt;&lt;set _responses = [&quot;UNDER CONSTRUCTION&quot;]&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses, 
                State.variables.buttons, 
                State.variables.buttons_extra);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;unset _responses&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events5;&lt;&lt;button &quot;5&quot;&gt;&gt;
        &lt;&lt;set _action = 5&gt;&gt;
        &lt;&lt;if $player.get_money() gte 300&gt;&gt;
            &lt;&lt;addclass &quot;#events5 button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#events5 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;set _responses = [
                _emily.dialogue(&quot;Thanks, I\&#39;m always up for some training, comeby whenever between \
                    7AM and 4PM to train. Each session will cost you 50 laris. Did you need anything else?&quot;)
            ]&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li5&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
            &lt;&lt;set $quests.path_to_greatness.stage = 2&gt;&gt;
            &lt;&lt;removeclass &quot;#train button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#train button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removemoney 300&gt;&gt;
            &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
            &lt;&lt;run UInv.AddItem(&quot;emily_namm&quot;, &quot;lari&quot;, 300)&gt;&gt;
            &lt;&lt;updatetime&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _choices = 3&gt;&gt;
            &lt;&lt;disableactions&gt;&gt;
            &lt;&lt;set _responses = [
                _emily.dialogue(&quot;No handouts here, go beg somewhere else... Actually, if you really \
                    are desperate, there is something you can do.&quot;),
                &quot;Emily sits down and slips of her boots&quot;,
                _emily.dialogue(&quot;Training the troops is pretty tiring, and my feet sure could use a \
                    rub...&quot;),
                &quot;You slowly reach out for her feet when she stops you&quot;,
                _emily.dialogue(&quot;With your tongue, like all dogs do.&quot;)
            ]&gt;&gt;
            &lt;&lt;set _response = &quot;\
                &lt;ol&gt;\
                    &lt;li&gt;Refuse.&lt;/li&gt;\
                    &lt;li&gt;Do as she says.&lt;/li&gt;\
            &quot;&gt;&gt;
            &lt;&lt;if $player.gender == 0&gt;&gt;
                &lt;&lt;set _response += &quot;&lt;li&gt;Do as she says and start jacking off as well.&lt;/li&gt;&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set _response += &quot;&lt;/ol&gt;&quot;&gt;&gt;
            &lt;&lt;set _responses.push(_response)&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;unset _done_appending&gt;&gt;
                &lt;&lt;run $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                    &quot;url(\&quot;&quot; + _emily.image_folder() + &quot;emily_foot.png&quot;)&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses, 
                State.variables.buttons, 
                State.variables.buttons_extra);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;unset _responses&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events6;&lt;&lt;button &quot;6&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events7;&lt;&lt;button &quot;7&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events8;&lt;&lt;button &quot;8&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@

    &lt;&lt;set $buttons = []&gt;&gt;
    &lt;&lt;for _i = 1; _i lte 8; _i++&gt;&gt;
        &lt;&lt;set $buttons.push(&quot;#events&quot; + _i)&gt;&gt;
    &lt;&lt;/for&gt;&gt;
    &lt;&lt;set $buttons_extra = [&quot;#events_actions_back&quot;, &quot;#events_actions_leave&quot;]&gt;&gt;

    /* Back button is disabled by default */
    &lt;div style=&quot;grid-row: 1; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;events_actions_back&quot; style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#emily_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div id=&quot;events_actions_leave&quot; style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="88" name="niponCentral" tags="paper" position="975,1100" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Player is outside */
&lt;&lt;set $player.is_home = false&gt;&gt;
&lt;&lt;set $player.is_outside = true&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;

/* Audio engine */
 

&lt;div class=&quot;mapside left&quot;&gt;
    &lt;&lt;include niponActions&gt;&gt;
&lt;/div&gt;

&lt;div id=&quot;background&quot; class=&quot;notext&quot; style=&quot;padding: 0px&quot;&gt;
    &lt;img src=&quot;resources/maps/niponCentralMap.jpeg&quot; usemap=&quot;#image-map&quot;&gt;
    &lt;map name=&quot;image-map&quot;&gt;
        &lt;area alt=&quot;shintaniHome&quot; coords=&quot;472,214,452,230,453,262,466,274,470,281,471,302,472,482,452,504,456,535,479,546,498,540,510,533,697,531,697,477,749,435,798,433,794,337,780,300,755,265,714,243,674,235,515,235,501,217&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponArena&quot; coords=&quot;1226,721,81&quot; shape=&quot;circle&quot;&gt;
        &lt;area alt=&quot;solBrothel&quot; coords=&quot;185,508,269,662&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;niponTownHall&quot; coords=&quot;506,611,726,780&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;yukisGourmet&quot; coords=&quot;336,308,422,447&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;niponAcademy&quot; coords=&quot;919,129,877,169,882,192,847,242,906,293,953,252,977,252,1011,200,971,158&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;liasTower&quot; coords=&quot;180,137,55&quot; shape=&quot;circle&quot;&gt;
        &lt;area alt=&quot;niponCentralDocks&quot; coords=&quot;1095,177,1095,229,1035,310,954,322,922,359,915,403,923,445,949,466,957,495,971,522,988,566,1006,564,1133,500,1155,418,1149,302,1179,218,1132,181&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponSlums&quot; coords=&quot;211,756,373,796&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;niponMarket&quot; coords=&quot;956,758,1137,796&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;niponBarracks&quot; coords=&quot;745,512,709,481,753,446,795,445,838,464,850,487,823,540,826,563,797,560,749,559,745,532&quot; shape=&quot;poly&quot;&gt;
    &lt;/map&gt;
&lt;/div&gt;

&lt;div class=&quot;mapside right&quot;&gt;
    &lt;hr&gt;
    &lt;&lt;include infoNoSubbackground&gt;&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

/* Remove quick bar and setup map */
&lt;&lt;script&gt;&gt;
    setTimeout(() =&gt; {
        $(&quot;#quickbar&quot;).addClass(&quot;hidden&quot;);
        var areas = $(&quot;map&quot;).children(&quot;area&quot;);
        for (var _i = 0; _i &lt; areas.length; _i++) {
            var obj = $(areas[_i]);
            if (!(setup.locations.has(obj.attr(&quot;alt&quot;)))) {
                continue;
            }
            var loc = setup.locations.get(obj.attr(&quot;alt&quot;));
            if (!State.variables.has_access.has(loc.key)) {
                obj.addClass(&quot;noaccess&quot;);
                obj.attr(&quot;onclick&quot;, &quot;$.wiki(&#39;&lt;&lt;notify&gt;&gt;No Access!&lt;&lt;/notify&gt;&gt;&#39;)&quot;);
                obj.attr(&quot;title&quot;, &quot;No access.&quot;);
            } else if (!loc.has_access()) {
                obj.addClass(&quot;closed&quot;);
                obj.attr(&quot;onclick&quot;, &quot;$.wiki(&#39;&lt;&lt;notify&gt;&gt;Closed!&lt;&lt;/notify&gt;&gt;&#39;)&quot;);
                var opening_time = loc.access_times[0];
                var opening_time_str = &quot;&quot;;
                if (opening_time == 0) {
                    opening_time_str = &quot;12 AM.&quot;;
                } else if (opening_time &lt; 12) {
                    opening_time_str = opening_time.toString() + &quot; AM.&quot;;
                } else if (opening_time == 12) {
                    opening_time_str = &quot;12 PM.&quot;;
                } else {
                    opening_time_str = (opening_time - 12).toString() + &quot; PM.&quot;;
                }
                obj.attr(&quot;title&quot;, &quot;Opens at &quot; + opening_time_str);
            } else {
                obj.addClass(&quot;access&quot;);
                var onclick = &quot;SugarCube.setup.locations.get(&#39;&quot; + obj.attr(&quot;alt&quot;) + &quot;&#39;).goto(&quot;;
                if (loc.inside) {
                    onclick += &quot;&#39;wooden_door_sound&#39;&quot;;
                }
                onclick += &quot;)&quot;;
                obj.attr(&quot;onclick&quot;, onclick);
            }
        }
    }, 10);
&lt;&lt;/script&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="89" name="shintaniHomeActions" tags="" position="1100,1100" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;actions&quot; class=&quot;action container row col&quot; 
         style=&quot;--rows: 4; --cols: 5&quot;&gt;
        &lt;div style=&quot;grid-row: 1; grid-column: 1&quot;&gt;
            &lt;&lt;button &quot;Work&quot;&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    $(&quot;#actions&quot;).addClass(&quot;hidden&quot;);
                    $(&quot;#work_actions&quot;).removeClass(&quot;hidden&quot;);
                &lt;&lt;/script&gt;&gt;
            &lt;&lt;/button&gt;&gt;
        &lt;/div&gt;

        &lt;div style=&quot;grid-row: 2; grid-column: 1&quot;&gt;
            &lt;&lt;button &quot;Interact&quot;&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    $(&quot;#actions&quot;).addClass(&quot;hidden&quot;);
                    $(&quot;#interact_options&quot;).removeClass(&quot;hidden&quot;);
                &lt;&lt;/script&gt;&gt;
            &lt;&lt;/button&gt;&gt;
        &lt;/div&gt;

        &lt;div style=&quot;grid-row: 3; grid-column: 1&quot;&gt;
            &lt;&lt;button &quot;Relax&quot;&gt;&gt;
                /* Temperarily disable working status while relaxing */
                &lt;&lt;set _temp_is_working = $player.is_working&gt;&gt;
                &lt;&lt;set $player.is_working = false&gt;&gt;
                &lt;&lt;addhours 1&gt;&gt;
                &lt;&lt;set $player.is_working = _temp_is_working&gt;&gt;
                &lt;&lt;unset _temp_is_working&gt;&gt;
                &lt;&lt;include round&gt;&gt;
            &lt;&lt;/button&gt;&gt;
        &lt;/div&gt;

        &lt;div style=&quot;grid-row: 4; grid-column: 1&quot;&gt;
            &lt;&lt;button &quot;Sleep&quot; shintaniHomeSleep&gt;&gt;
                &lt;&lt;set $_player = clone($player)&gt;&gt;
                &lt;&lt;set $player.is_sleeping = true&gt;&gt;
                &lt;&lt;advanceday&gt;&gt;
                &lt;&lt;set $player.is_sleeping = false&gt;&gt;
            &lt;&lt;/button&gt;&gt;
        &lt;/div&gt;

        &lt;div style=&quot;grid-row: 1; grid-column: 2&quot;&gt;
            &lt;&lt;set _location_button_text = &quot;Library&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;shintaniHomeLibrary&quot;&gt;&gt;
            &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;/div&gt;

        &lt;div style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
            &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
            &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;/div&gt;

    &lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="90" name="shintaniHomeEventsActions" tags="" position="1225,1100" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;events_actions&quot; class=&quot;action container row col hidden&quot;
         style=&quot;--rows: 4; --cols: 5&quot;&gt;

        @@#events1;&lt;&lt;button &quot;1&quot;&gt;&gt;
            &lt;&lt;set _action = 1&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#events2;&lt;&lt;button &quot;2&quot;&gt;&gt;
            &lt;&lt;set _action = 2&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#events3;&lt;&lt;button &quot;3&quot;&gt;&gt;
            &lt;&lt;set _action = 3&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#events4;&lt;&lt;button &quot;4&quot;&gt;&gt;
            &lt;&lt;set _action = 4&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#events5;&lt;&lt;button &quot;5&quot;&gt;&gt;
            &lt;&lt;set _action = 5&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#events6;&lt;&lt;button &quot;6&quot;&gt;&gt;
            &lt;&lt;set _action = 6&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#events7;&lt;&lt;button &quot;7&quot;&gt;&gt;
            &lt;&lt;set _action = 7&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
        @@#events8;&lt;&lt;button &quot;8&quot;&gt;&gt;
            &lt;&lt;set _action = 8&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@

        &lt;&lt;set $buttons = []&gt;&gt;
        &lt;&lt;for _i = 1; _i lte 8; _i++&gt;&gt;
            &lt;&lt;set $buttons.push(&quot;#events&quot; + _i)&gt;&gt;
        &lt;&lt;/for&gt;&gt;
        &lt;&lt;set $buttons_extra = [&quot;#events_actions_back&quot;, &quot;#events_actions_leave&quot;]&gt;&gt;

        /* Back button is disabled by default */
        &lt;div style=&quot;grid-row: 1; grid-column: 5&quot;&gt;&lt;/div&gt;
        &lt;div style=&quot;grid-row: 2; grid-column: 5&quot;&gt;&lt;/div&gt;
        &lt;div id=&quot;events_actions_back&quot; class=&quot;hidden&quot; style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
            &lt;&lt;set _location_button_text = &quot;Back&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;shintaniHome&quot;&gt;&gt;
            &lt;&lt;set _location_button_dur = 2&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;/div&gt;
        &lt;div id=&quot;events_actions_leave&quot; class=&quot;hidden&quot; style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
            &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
            &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;/div&gt;

    &lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="91" name="shintaniHomeEventsInteractHimariAsk" tags="" position="100,1225" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set _choices = 5&gt;&gt;
&lt;&lt;script&gt;&gt;
    var player = State.variables.player;
    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
    var html = &quot;
        You greet Himari,&lt;br&gt;&quot; +
        &quot;&lt;em&gt;&lt;b&gt;&quot; + setup.titleCase(player.first_name) + &quot;&lt;/b&gt;: \&quot;I was hoping I could \
        ask you a couple of things?\&quot;&lt;/em&gt;\
        &lt;br&gt;Himari eyes you up and down, wondering what you want.\
        &lt;br&gt;\
        What would you like to ask about?\
    &quot;;
    State.temporary.options = &quot;\
        &lt;ol&gt;\
            &lt;li id=\&quot;li1\&quot;&gt;Her background.&lt;/li&gt;\
            &lt;li id=\&quot;li2\&quot;&gt;How she feels about Shintani.&lt;/li&gt;\
            &lt;li id=\&quot;li3\&quot;&gt;How she feels about the other slaves.&lt;/li&gt;\
            &lt;li id=\&quot;li4\&quot;&gt;Her future plans.&lt;/li&gt;\
            &lt;li id=\&quot;li5\&quot;&gt;What you can do to help.&lt;/li&gt;&quot;;

    var quest_journal = State.variables.quest_journal;
    var quests = State.variables.quests;
    if (quest_journal.ongoing.contains(&quot;knowledge_is_power&quot;)) {
        if (quests.knowledge_is_power.stage == 0) {
            State.temporary.options += &quot;&lt;li id=\&quot;li6\&quot;&gt;About the library.&lt;/li&gt;&quot;;
            State.temporary.choices = 6;
        } else if (quests.knowledge_is_power.stage == 1) {
            /* TODO: Worked at brothel */
            if (false) {
                State.temporary.options += &quot;&lt;li value=\&quot;6\&quot; id=\&quot;li6\&quot;&gt;About having worked at the brothel.&lt;/li&gt;&quot;;
                State.temporary.choices = 6;
            } else if (player.get_money() &gt;= 500) {
                State.temporary.options += &quot;&lt;li value=\&quot;6\&quot; id=\&quot;li6\&quot;&gt;About paying off the debt (¤500).&lt;/li&gt;&quot;;
                State.temporary.choices = 6;
            }
        }
    }

    State.temporary.options += &quot;&lt;/ol&gt;&quot;;
    html += State.temporary.options;
    div.html(html);
    setup.mainLog_append(div);
    State.temporary.options = $(State.temporary.options);
&lt;&lt;/script&gt;&gt;

&lt;&lt;disableactions&gt;&gt;

/* Allow back and leave buttons */
&lt;&lt;removeclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
&lt;&lt;removeclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;

/* Psuedoevent listener for action */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;set _char = $characters[$selected]&gt;&gt;
        &lt;&lt;if _char.limits.ask gt 0&gt;&gt;
            &lt;&lt;set _char.limits.ask -= 1&gt;&gt;
            &lt;&lt;switch _action&gt;&gt;
                &lt;&lt;case 1&gt;&gt;
                    &lt;&lt;run $(&quot;#events1 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events1 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _response = &quot;&quot;&gt;&gt;
                    &lt;&lt;set _responses = [$player.dialogue(&quot;Can you tell me a little of your story?&quot;)]&gt;&gt;
                    &lt;&lt;if _char.mental_conditions.anger gt 0&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Himari is clearly still angry at you,&quot;)&gt;&gt;
                        &lt;&lt;set _dialogue = &quot;How about you mind your own business?&quot;&gt;&gt;
                    &lt;&lt;elseif _char.get_disposition() == &quot;scared&quot;&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Himari is too scared to answer,&quot;)&gt;&gt;
                        &lt;&lt;set _dialogue = &quot;Just leave me alone!&quot;&gt;&gt;
                    &lt;&lt;elseif (_char.slave_traits.trust gte 20) || 
                         (_char.slave_traits.obedience gte 20) ||
                         (_char.slave_traits.willpower lte 50)&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Himari is taken aback by your sudden question.&quot;)&gt;&gt;
                        &lt;&lt;set _dialogue = &quot;Well... I\&#39;ve been in the Hiroyuki household since birth. \
                            My parents, and their parents all carried the name of Hironaka. I haven\&#39;t really \
                            left Nipon before either aside from greeting important guests.\
                        &quot;&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _dialogue = &quot;How about you mind your own business?&quot;&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _responses.push(_char.dialogue(_dialogue))&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li1&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;

                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _dialogue&gt;&gt;
                &lt;&lt;case 2&gt;&gt;
                    &lt;&lt;run $(&quot;#events2 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events2 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _response = &quot;&quot;&gt;&gt;
                    &lt;&lt;set _responses = [$player.dialogue(&quot;What do you think about Shintani?&quot;)]&gt;&gt;
                    &lt;&lt;if (_char.slave_traits.trust gte 10) || 
                         (_char.slave_traits.obedience gte 15) ||
                         (_char.slave_traits.willpower lte 60)&gt;&gt;

                        /* Submissive to player and high regards for them */
                        &lt;&lt;if ((_char.slave_traits.trust gte 75) || 
                             (_char.slave_traits.obedience gte 80)) &amp;&amp;
                             (_char.slave_traits.willpower lte 5)&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Himari hesitates to look around before answering,&quot;)&gt;&gt;
                            &lt;&lt;set _dialogue = &quot;He would be but a shadow of a you if you were my master.&quot;&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(_dialogue))&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Himari looks into your eyes with absolute submission.&quot;)&gt;&gt;
                        &lt;&lt;elseif ((_char.slave_traits.trust gte 75) || 
                             (_char.slave_traits.obedience gte 80)) &amp;&amp;
                             (_char.slave_traits.willpower lte 20)&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Himari hesitates to look around before answering,&quot;)&gt;&gt;
                            &lt;&lt;set _dialogue = &quot;Well, he hasn\&#39;t been the worst master, but he hasn\&#39;t been \
                                perfect either.&quot;&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(_dialogue))&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Himari touches your hand, as if to let you know that she \
                                places you above Shintani but cannot risk saying it out loud.&quot;)&gt;&gt;
                        &lt;&lt;elseif ((_char.slave_traits.trust gte 75) || 
                                 (_char.slave_traits.obedience gte 80))&gt;&gt;
                            &lt;&lt;set _dialogue = &quot;I hold Shintani in pretty high regards. While he can be a bit \
                                childish at times, with large naive dreams, he\&#39;s a solid figure of Nipon.&quot;&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(_dialogue))&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _dialogue = &quot;I would rather give my life then serve under anyone not of the \
                                Hiroyuki household.&quot;&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(_dialogue))&gt;&gt;
                        &lt;&lt;/if&gt;&gt;

                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _dialogue = &quot;Why don\&#39;t you worry less about what I think about \
                            Shintani and more about what Shintani thinks of you?&quot;&gt;&gt;
                        &lt;&lt;set _responses.push(_char.dialogue(_dialogue))&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li2&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _dialogue&gt;&gt;
                &lt;&lt;case 3&gt;&gt;
                    &lt;&lt;run $(&quot;#events3 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events3 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li3&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses = [&quot;UNDER CONSTRUCTION.&quot;]&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _dialogue&gt;&gt;
                &lt;&lt;case 4&gt;&gt;
                    &lt;&lt;run $(&quot;#events4 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events4 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li4&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses = [&quot;UNDER CONSTRUCTION.&quot;]&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _dialogue&gt;&gt;
                &lt;&lt;case 5&gt;&gt;
                    &lt;&lt;run $(&quot;#events5 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events5 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li5&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses = [&quot;UNDER CONSTRUCTION.&quot;]&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _dialogue&gt;&gt;
                &lt;&lt;case 6&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li6&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;run $(&quot;#events6 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events6 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _responses = []&gt;&gt;
                    &lt;&lt;if $quests.knowledge_is_power.stage == 0&gt;&gt;
                        &lt;&lt;set _responses = [$player.dialogue(&quot;Can I have access to the library?&quot;)]&gt;&gt;
                        &lt;&lt;if (_char.slave_traits.trust gte 80) || 
                            (_char.slave_traits.obedience gte 90) ||
                            (_char.slave_traits.willpower lte 10)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(
                                &quot;Oh the library? Why didn\&#39;t you ask earlier? Here\&#39;s the key.&quot;
                            ))&gt;&gt;
                            &lt;&lt;set $has_access.add(&quot;shintaniHomeLibrary&quot;)&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(
                                &quot;Well, I\&#39;ve been the keeper of the library for many years now. \
                                Woudln\&#39;t it be irresponsible of me to let just anyone in?&quot;
                            ))&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;You see a sickly smile spread over Himari\&#39;s mouth.&quot;)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(
                                &quot;I have a friend who owes some debt to the owner of the Sol Brothel. \
                                Help me settle that debt, then we can talk about giving you access \
                                to the Hiroyuki library.&quot;
                            ))&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;Himari pauses and thinks for a second,&quot;)&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(&quot;500 lari should cover it.&quot;))&gt;&gt;
                            &lt;&lt;set $quests.knowledge_is_power.stage = 1&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        /* Worked at brothel */
                        &lt;&lt;if false&gt;&gt;
                            &lt;&lt;set _responses = [$player.dialogue(
                                &quot;I went to the brothel and settled the debt, now about the library...&quot;
                            )]&gt;&gt;
                            &lt;&lt;set _responses.push(_char.dialogue(
                                &quot;I heard about your exploits at Sol, it nearly made me fall \
                                out of my chair! Well if you\&#39;re willing to go that far for access to the \
                                dusty library, you deserve it.&quot;
                            ))&gt;&gt;
                            &lt;&lt;set _responses.push(&quot;(Himari\&#39;s Trust &quot; + setup.show_change_html(0, 5) + &quot;).&quot;)&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust += 5&gt;&gt;
                            &lt;&lt;set _to_round = $selected&gt;&gt;
                            &lt;&lt;include &quot;round&quot;&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses = [$player.dialogue(
                                &quot;Here\&#39;s the 500 lari, now about the library...&quot;
                            )]&gt;&gt;
                            /* Giving ¤500 */
                            &lt;&lt;set _responses.push(_char.dialogue(
                                &quot;I won\&#39;t question where you got this, but good job. Here\&#39;s the key to \
                                the dusty old library. Have fun.&quot;
                            ))&gt;&gt;
                            &lt;&lt;removemoney 500&gt;&gt;
                            &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;run UInv.AddItem(&quot;himari_hironaka&quot;, &quot;lari&quot;, 500)&gt;&gt;
                            &lt;&lt;updatetime&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set $has_access.add(&quot;shintaniHomeLibrary&quot;)&gt;&gt;
                        &lt;&lt;set _options.find(&quot;#li6&quot;).css(&quot;displau&quot;, &quot;none&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;/if&gt;&gt;

                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses,
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;

                    &lt;&lt;updatequests&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _dialogue&gt;&gt;
            &lt;&lt;/switch&gt;&gt;
            /* Advance time every time an ask is performed */
            &lt;&lt;set _roll = dice(1, 5) + 5&gt;&gt;
            &lt;&lt;addmins _roll&gt;&gt;
            &lt;&lt;unset _roll&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;notify&gt;&gt;Already asked &lt;&lt;= setup.titleCase($characters[$selected].first_name)&gt;&gt; 
            too many things today!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
        &lt;&lt;unset _char&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="92" name="shintaniHomeEventsInteractShintaniAsk" tags="" position="225,1225" size="100,100">&lt;&lt;nobr&gt;&gt;

/* For ease */
&lt;&lt;set _shintani = $characters.shintani_hiroyuki&gt;&gt;

&lt;&lt;script&gt;&gt;
    var player = State.variables.player;
    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
    var html = &quot;
        You greet &quot; + (player.is_slave ? &quot;your master,&quot; : &quot;Shintani,&quot;) + &quot;&lt;br&gt;&quot; +
        &quot;&lt;em&gt;&lt;b&gt;&quot; + setup.titleCase(player.first_name) + &quot;&lt;/b&gt;: \&quot;I was hoping I could \
        ask you a couple of things?\&quot;&lt;/em&gt;\
        &lt;br&gt;Shintani eyes you up and down, wondering what you want.\
        &lt;br&gt;\
        What would you like to talk about?\
    &quot;;
    State.temporary.options = &quot;
        &lt;ol&gt;\
            &lt;li id=\&quot;li1\&quot;&gt;How Nipon started.&lt;/li&gt;\
            &lt;li id=\&quot;li2\&quot;&gt;His dream of \&quot;Free Cities\&quot;.&lt;/li&gt;\
            &lt;li id=\&quot;li3\&quot;&gt;How he feels about his slaves.&lt;/li&gt;\
            &lt;li id=\&quot;li4\&quot;&gt;Where you can improve your skills.&lt;/li&gt;\
            &lt;li id=\&quot;li5\&quot;&gt;The library.&lt;/li&gt;\
            &lt;li id=\&quot;li6\&quot;&gt;What you can do to help.&lt;/li&gt;&quot;;
    State.temporary.choices = 6;
    let quest_journal = State.variables.quest_journal;
    let quests = State.variables.quests;
    if (quest_journal.ongoing.contains(&quot;the_nipon_economy&quot;)) {
        if (player.get_money() &gt;= 1000) {
            State.temporary.options += &quot;&lt;li id=\&quot;li7\&quot; value=\&quot;7\&quot;&gt;About successfully getting $1000.&lt;/li&gt;&quot;;
        } else {
            State.temporary.options += &quot;&lt;li id=\&quot;li7\&quot; value=\&quot;7\&quot;&gt;About giving up on testing the economy.&lt;/li&gt;&quot;;
        }
        State.temporary.choices += 1;
    }
    if (quest_journal.ongoing.contains(&quot;power_struggles&quot;) &amp;&amp; 
        (quests.power_struggles.stage == 1 || quests.power_struggles.stage == 2)) {
        State.temporary.options += &quot;&lt;li id=\&quot;li8\&quot; value=\&quot;8\&quot;&gt;Lia\&#39;s adversarial plans.&quot;
    }

    State.temporary.options += &quot;&lt;/ol&gt;&quot;;
    html += State.temporary.options;
    div.html(html);
    setup.mainLog_append(div);
    State.temporary.options = $(State.temporary.options);
&lt;&lt;/script&gt;&gt;

&lt;&lt;set _disable_buttons = false&gt;&gt;
&lt;&lt;disableactions _options&gt;&gt;

/* Psuedoevent listener for action */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;if $characters[$selected].limits.ask gt 0&gt;&gt;
            &lt;&lt;set $characters[$selected].limits.ask -= 1&gt;&gt;
            &lt;&lt;switch _action&gt;&gt;
                &lt;&lt;case 1&gt;&gt;
                    &lt;&lt;run $(&quot;#events1 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events1 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _responses = [$player.dialogue(&quot;How did Nipon come to be?&quot;)]&gt;&gt;
                    &lt;&lt;set _responses.push(&quot;Shintani smiles with a sublte sparkle in his eye.&quot;)&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        var player = State.variables.player;
                        var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
                        var html = &quot;\
                            &lt;em&gt;&lt;b&gt;Shintani&lt;/b&gt;: \&quot;I inhereted Nipon from my parents, whom \
                            I unfortunately had to sell due to some internal disputes. I was \
                            told from very little that Nipon was a settlement blessed by the gods \
                            as an apology for the destruction they laid to our world. Truthfully I\&#39;ve \
                            been trying to find out our true history for a long time, but I\&#39;ve been \
                            preoccupied with the refugees pouring in, the droughts, and\
                        &quot;;
                        if (player.get_status() == &quot;low_slave&quot;) {
                            html += &quot;...\&quot;&lt;/em&gt;\
                                &lt;br&gt;He trails off, realizing that he has said too much to a mere \
                                low slave.&quot;;
                        } else {
                            html += &quot; the incursions from other settlements. But actually, recently I\&#39;ve \
                                found some very old manuscripts in a language I cannot understand. I\&#39;ve sent \
                                them to a couple of scholars, hoping to understand them. As you can see, I\&#39;ve \
                                structured Nipon to reflect a very specific culture; one that my parents \
                                taught me. Perhaps it might be naivity, but&quot;;
                            if (player.get_status() == &quot;slave&quot;) {
                                html += &quot;...\&quot;&lt;/em&gt;\
                                    &lt;br&gt;He trails off, realizing that he has said too much to a mere \
                                    slave.&quot;;
                            } else {
                                html += &quot; I want to hold onto what I deem to be the nature of humanity that was \
                                    lost long ago in The Dusting. I believe in a world of complexity and rich culture. \
                                    We are currently in a phase where man has yet to consolidate, and thus we can change \
                                    the course of history as we know it. Whether you like it or not, we hold the reins \
                                    of tomorrow.\&quot;&lt;/em&gt;\
                                    &lt;br&gt;He catches himself in his ferver and calms down. He seems pleased that you were \
                                    interested in Nipon.&quot;;
                            }
                        }
                        div.html(html);
                        State.temporary.responses.push(div);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li1&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;run setup.mainLog_append_delayed(State.temporary.responses, State.variables.buttons, State.variables.buttons_extra)&gt;&gt;
                &lt;&lt;case 2&gt;&gt;
                    &lt;&lt;run $(&quot;#events2 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events2 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li2&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses = [$player.dialogue(&quot;When you first found me, you mentioned a \&quot;Free City\&quot;,&quot;)]&gt;&gt;
                    &lt;&lt;if $player.is_slave&gt;&gt;
                        &lt;&lt;set _responses.push(
                            &quot;You raise your hand slowly to touch the collar on your neck with the crest of the \
                            Hiroyuki household engraved in it, implying that his city is anything but free.&quot;
                        )&gt;&gt;
                        &lt;&lt;set _response.push(&quot;Shintani chuckles,&quot;)&gt;&gt;
                        &lt;&lt;set _response.push(_shintani.dialogue(
                            &quot;What is freedom really? Do we as humans desire true freedom? Freedom is you starving in the \
                            desert. It\&#39;s your death. Humans like to be told what to do. We like to wake up and have somewhere \
                            to be. We like to slowly walk the monotonous march that leads the the great equalizer... death.&quot;
                        ))&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _responses.push(&quot;Shintani pauses and considers his words,&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(&quot;Freedom is about freedom from starvation. It\&#39;s about freedom from worry. \
                        Freedom is Slavery.&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _dialogue&gt;&gt;
                &lt;&lt;case 3&gt;&gt;
                    &lt;&lt;run $(&quot;#events3 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events3 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li3&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses = [_shintani.dialogue(&quot;Well as you know numerous settlements including \
                        Nipon has been experimenting with indentured servitude, but as I\&#39;m sure you also know, \
                        that always seemed to devolve into completely inhumane behavior anyways. I wanted \
                        to introduce slavery because we as owners shouldn\&#39;t want to damage our property...&quot;),
                        &quot;Shintani smirks as you...&quot;,
                        _shintani.dialogue(&quot;Isn\&#39;t that right?&quot;),
                        &quot;He pauses for a brief moment before continuing&quot;,
                        _shintani.dialogue(&quot;My slaves are my children. They bare my vassal name of Hironaka which \
                        is known far past Nipon\&#39;s borders. We share not only our success but also failure.&quot;),
                        &quot;It seems to be obvious to everyone but Shintani how fragile his naive ideals are.&quot;]&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                    &lt;&lt;unset _dialogue&gt;&gt;
                &lt;&lt;case 4&gt;&gt;
                    &lt;&lt;run $(&quot;#events4 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events4 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _responses = [
                        $player.dialogue(&quot;Where\&#39;s a good place to improve my skills?&quot;)
                    ]&gt;&gt;
                    &lt;&lt;if $player.get_status(passage()) == &quot;low_slave&quot;&gt;&gt;
                        &lt;&lt;set _responses.push(_shintani.dialogue(&quot;Why don\&#39;t you focus on being a better \
                            slave first before thinking about useless things?&quot;))&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _response = &quot;You can tell Shintani is happy that you are taking initiative to \
                            be more useful to him&quot;&gt;&gt;
                        &lt;&lt;if !$quests.path_to_greatness.added&gt;&gt;
                            &lt;&lt;set _response += &quot; (Trust &quot; + setup.show_change_html(0, 5) + &quot;)&quot;&gt;&gt;
                            &lt;&lt;set $player.slave_traits.trust += 5&gt;&gt;
                            &lt;&lt;include round&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
                        &lt;&lt;set _responses.push(_response)&gt;&gt;
                        &lt;&lt;set _responses.push(_shintani.dialogue(&quot;You can train at the Nipon barracks with \
                            our soldiers. They might give you a thrashing if you aren\&#39;t careful though haha.&quot;))&gt;&gt;
                        &lt;&lt;if !$quests.path_to_greatness.added&gt;&gt;
                            &lt;&lt;set _add_quest = true&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li4&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;

                    /* Wait for end of dialogue to add quest */
                    &lt;&lt;if def _add_quest &amp;&amp; _add_quest&gt;&gt;
                        &lt;&lt;set _add_quest = false&gt;&gt;
                        &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                            &lt;&lt;set $quests[&quot;path_to_greatness&quot;].added = true&gt;&gt;
                            &lt;&lt;set $quest_journal.ongoing.push(&quot;path_to_greatness&quot;)&gt;&gt;
                            &lt;&lt;notify&gt;&gt;Quest &lt;em&gt;Path to Greatness&lt;/em&gt; added to journal!&lt;&lt;/notify&gt;&gt;
                            &lt;&lt;audio &quot;quest_added_sound&quot; play&gt;&gt;
                            &lt;&lt;stop&gt;&gt;
                        &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;case 5&gt;&gt;
                    &lt;&lt;run $(&quot;#events5 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events5 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _responses = [$player.dialogue(&quot;Do you think I could have access to the library?&quot;)]&gt;&gt;
                    &lt;&lt;if $has_access.has(&quot;shintaniHomeLibrary&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_shintani.dialogue(&quot;Don\&#39;t you already have access to the library?&quot;))&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;if $player.get_status() != &quot;low_slave&quot; || $player.slave_traits.trust gt 50&gt;&gt;
                            &lt;&lt;set _responses.push(_shintani.dialogue(&quot;Why don\&#39;t you ask Himari, she takes care \
                                of the library and has the key.&quot;))&gt;&gt;
                            &lt;&lt;if !$quests[&quot;knowledge_is_power&quot;].added&gt;&gt;
                                &lt;&lt;set _add_quest = true&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _responses.push(_shintani.dialogue(&quot;Why don\&#39;t you focus on being a better \
                                slave first before thinking about useless things?&quot;))&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li5&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;if def _add_quest &amp;&amp; _add_quest&gt;&gt;
                        &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                            &lt;&lt;unset _add_quest&gt;&gt;
                            &lt;&lt;set $quests[&quot;knowledge_is_power&quot;].added = true&gt;&gt;
                            &lt;&lt;set $quest_journal.ongoing.push(&quot;knowledge_is_power&quot;)&gt;&gt;
                            &lt;&lt;notify&gt;&gt;Quest &lt;em&gt;Knowledge is Power&lt;/em&gt; added to journal!&lt;&lt;/notify&gt;&gt;
                            &lt;&lt;audio &quot;quest_added_sound&quot; play&gt;&gt;
                            &lt;&lt;stop&gt;&gt;
                        &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                &lt;&lt;case 6&gt;&gt;
                    &lt;&lt;set _to_add = []&gt;&gt;
                    &lt;&lt;run $(&quot;#events6 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass &quot;#events6 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;set _responses = [$player.dialogue(&quot;Is there anything I could do to help out Nipon?&quot;)]&gt;&gt;
                    &lt;&lt;set _response = &quot;Shintani is very happy that you\&#39;d go out of your way to help Nipon&quot;&gt;&gt;
                    &lt;&lt;if $player.get_status() == &quot;low_slave&quot;&gt;&gt;
                        &lt;&lt;if !$quests[&quot;life_of_a_slave&quot;].added&gt;&gt;
                            &lt;&lt;set _add_quest = true&gt;&gt;
                            &lt;&lt;set _to_add.push(&quot;life_of_a_slave&quot;)&gt;&gt;
                            &lt;&lt;set _response += &quot; (Trust &quot; + setup.show_change_html(0, 5) +  &quot;).&quot;&gt;&gt;
                            &lt;&lt;set $player.slave_traits.trust += 5&gt;&gt;
                            &lt;&lt;include round&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _responses.push(_response)&gt;&gt;
                        &lt;&lt;set _responses.push(_shintani.dialogue(&quot;\
                            Well, I\&#39;m happy that you want to help out, but neither I nor the people \
                            of Nipon trust you at all yet. Why don\&#39;t you keep following orders for a \
                            while and we can talk.\
                        &quot;))&gt;&gt;
                    &lt;&lt;elseif $player.get_status() == &quot;slave&quot; || $player.get_status() == &quot;high_slave&quot;&gt;&gt;

                        /* Allow access to Nipon */
                        &lt;&lt;set $has_access.add(&quot;niponCentral&quot;)&gt;&gt;

                        &lt;&lt;if !$quests[&quot;life_of_a_slave&quot;].added&gt;&gt;
                            &lt;&lt;set _add_quest = true&gt;&gt;
                            &lt;&lt;set _to_add.push(&quot;life_of_a_slave&quot;)&gt;&gt;
                            &lt;&lt;set _response += &quot; (Trust &quot; + setup.show_change_html(0, 5) +  &quot;).&quot;&gt;&gt;
                            &lt;&lt;set $player.slave_traits.trust += 5&gt;&gt;
                            &lt;&lt;include round&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _response += &quot;.&quot;&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _responses.push(_response)&gt;&gt;
                        &lt;&lt;set _response = &quot;&lt;em&gt;&lt;b&gt;Shintani&lt;/b&gt;: \&quot;You\&#39;ve done well in proving to me that you are to \
                            be trusted. &quot;&gt;&gt;

                        &lt;&lt;if !$quest_journal.completed.contains(&quot;the_nipon_economy&quot;)&gt;&gt;
                            &lt;&lt;set _response += &quot;Usually, I\&#39;d still be more cautious, but there is something \
                                I need dealt with. So I\&#39;m permitting you to leave the house. Here are 200 laris, \
                                I want you to go into Nipon, and using whatever legal means necesary, turn \
                                that ¤200 into ¤1000. I also want you to record in detail how exactly you do it. \
                                This is both a test of your abilities as well as an inquiry in our local economy. \
                                If the task deems too much for you, just let me know.\&quot;&lt;/em&gt;&lt;br&gt;&quot;&gt;&gt;

                            &lt;&lt;if !$quests[&quot;the_nipon_economy&quot;].added&gt;&gt;
                                &lt;&lt;set _add_quest = true&gt;&gt;
                                &lt;&lt;set _to_add.push(&quot;the_nipon_economy&quot;)&gt;&gt;
                            &lt;&lt;/if&gt;&gt;

                            /* If the quest was removed but not completed, readd it */
                            &lt;&lt;if !$quest_journal.ongoing.contains(&quot;the_nipon_economy&quot;)&gt;&gt;
                                &lt;&lt;set _add_quest = true&gt;&gt;
                                &lt;&lt;set _to_add.push(&quot;the_nipon_economy&quot;)&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set _response += &quot;Unfortunately I don\&#39;t have anything for you right now.\&quot;&lt;/em&gt;&lt;br&gt;\&quot;&quot;&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set _responses.push(_response)&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li6&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;if def _add_quest &amp;&amp; _add_quest&gt;&gt;
                        &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                            &lt;&lt;unset _add_quest&gt;&gt;
                            &lt;&lt;if _to_add.contains(&quot;the_nipon_economy&quot;)&gt;&gt;
                                &lt;&lt;set $quest_journal.ongoing.push(&quot;the_nipon_economy&quot;)&gt;&gt;
                                &lt;&lt;notify&gt;&gt;Quest &lt;em&gt;The Nipon Economy&lt;/em&gt; added to journal!&lt;&lt;/notify&gt;&gt;
                                &lt;&lt;audio &quot;quest_added_sound&quot; play&gt;&gt;
                                &lt;&lt;if !$quests.the_nipon_economy.added&gt;&gt;
                                    /* Give player money */
                                    &lt;&lt;addmoney 200&gt;&gt;
                                    &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                                    &lt;&lt;set $quests[&quot;the_nipon_economy&quot;].added = true&gt;&gt;
                                    &lt;&lt;include round&gt;&gt;
                                    &lt;&lt;updatetime&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;if _to_add.contains(&quot;life_of_a_slave&quot;)&gt;&gt;
                                &lt;&lt;set $quests.life_of_a_slave.added = true&gt;&gt;
                                &lt;&lt;set $quest_journal.ongoing.push(&quot;life_of_a_slave&quot;)&gt;&gt;
                                &lt;&lt;notify&gt;&gt;Quest &lt;em&gt;Life of a Slave&lt;/em&gt; added to journal!&lt;&lt;/notify&gt;&gt;
                                &lt;&lt;audio &quot;quest_added_sound&quot; play&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;unset _to_add&gt;&gt;
                            &lt;&lt;stop&gt;&gt;
                        &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                &lt;&lt;case 7&gt;&gt;
                    &lt;&lt;run $(&quot;#events7 button&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;addclass &quot;#events7 button&quot; &quot;disabled&quot;&gt;&gt;
                    &lt;&lt;if $player.get_money() gte 1000&gt;&gt;
                        &lt;&lt;set _responses = [$player.dialogue(&quot;I\&#39;ve completed your task, here\&#39;s 1000 lari.&quot;)]&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;\
                            You also hand Shintani some notes that you scribbled describing \
                            how you came up with the money. A loud silence hangs over the room as he \
                            closely examines the papers. After a very long five minutes, Shintani puts \
                            the papers down and looks up to you.\
                        &quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_shintani.dialogue(&quot;\
                            Honestly I didn\&#39;t expect you to be able to do it, especially not like this,\
                        &quot;))&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;he points to the various points you laid out.&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_shintani.dialogue(&quot;\
                            Regardless, thank you for your work. You can keep that 1000 lari as a token \
                            of my appreciation. Know I rarely give rewards, perhaps that should tell you how \
                            important this was.\
                        &quot;))&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;\
                            He waves his hand to dismiss you as he puzzles over the papers you gave him. \
                            You can tell that something has been troubling him for a long time, perhaps \
                            you can ask around town about it.\
                        &quot;)&gt;&gt;
                        &lt;&lt;set $quest_journal.completed.push(&quot;the_nipon_economy&quot;)&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _responses = [$player.dialogue(&quot;I\&#39;ve tried but I don\&#39;t think I can complete the task.&quot;)]&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;Shintani looks at you with disappointment,&quot;)&gt;&gt;
                        &lt;&lt;set _responses.push(_shintani.dialogue(&quot;\
                            I can\&#39;t say I\&#39;m surprised. Let me know if you want to try again.\
                        &quot;))&gt;&gt;
                        &lt;&lt;set _responses.push(&quot;(Trust &quot; + setup.show_change_html(0, -5) + &quot;)&quot;)&gt;&gt;
                        &lt;&lt;set $player.slave_traits.trust -= 5&gt;&gt;
                        &lt;&lt;include round&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;run setup.remove_val($quest_journal.ongoing, &quot;the_nipon_economy&quot;)&gt;&gt;
                    &lt;&lt;set _options.find(&quot;#li7&quot;).css(&quot;display&quot;, &quot;none&quot;)&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, State.variables.buttons, State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
                &lt;&lt;case 8&gt;&gt;
                    /* TODO */
                    &lt;&lt;set _options.find(&quot;#li8&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
                    &lt;&lt;set _responses = [&quot;UNDER CONSTRUCTION&quot;]&gt;&gt;
                    &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, State.variables.buttons, State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;unset _response&gt;&gt;
                    &lt;&lt;unset _responses&gt;&gt;
            &lt;&lt;/switch&gt;&gt;

            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if ndef _done_appending || (def _done_appending &amp;&amp; _done_appending)&gt;&gt;
                /* Advance time every time an ask is performed */
                &lt;&lt;set _roll = dice(1, 5) + 5&gt;&gt;
                &lt;&lt;addmins _roll&gt;&gt;
                &lt;&lt;unset _roll&gt;&gt;
                /* Update quests */
                &lt;&lt;updatequests&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;notify&gt;&gt;Already asked Shintani too many things today!&lt;&lt;/notify&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="93" name="shintaniHomeEventsWorkDomesticEvents" tags="" position="350,1225" size="100,100">&lt;&lt;set _events = [

]&gt;&gt;</tw-passagedata><tw-passagedata pid="94" name="shintaniHomeEventsWorkEconomicCheckMath" tags="" position="475,1225" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;script&gt;&gt;
    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
    div.html(&quot;
        While helping Shintani in his office he hands you a couple of papers,&lt;br&gt;\
        &lt;em&gt;&lt;b&gt;Shintani&lt;/b&gt;: \&quot;Quickly check over these calculations, I need to attend \
        to more important matters.\&quot;&lt;/em&gt;\
        &lt;br&gt;Before you are around four pages of equations.\
        &lt;br&gt;\
        What do you do?\
        &lt;ol&gt;\
            &lt;li&gt;Tell him it&#39;s too complicated for you.&lt;/li&gt;\
            &lt;li&gt;Pretend to glance over it and praise his work.&lt;/li&gt;\
            &lt;li&gt;Diligently check his work.&lt;/li&gt;\
            &lt;li&gt;Purposefully add in errors.&lt;/li&gt;\
        &lt;/ol&gt;\
    &quot;);
    setup.mainLog_append(div);
&lt;&lt;/script&gt;&gt;

&lt;&lt;set _choices = 4&gt;&gt;
&lt;&lt;disableactions&gt;&gt;


/* Psuedoevent listener for action */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;switch _action&gt;&gt;
            &lt;&lt;case 1&gt;&gt;
                /* Roll */
                &lt;&lt;set _roll = dice(1, $difficulty + 6) 
                    + $player.get_status_prop(&quot;tact&quot;) 
                    + 30 / $player.get_status_prop(&quot;intelligence&quot;) 
                    - $difficulty&gt;&gt;
                &lt;&lt;if _roll gt 30&gt;&gt;
                    &lt;&lt;set _success = true&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.pass(&quot;intelligence&quot;)&gt;&gt;;
                    &lt;&lt;set $_temp_to_log += setup.pass(&quot;tact&quot;)&gt;&gt;;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _success = false&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.fail(&quot;intelligence&quot;)&gt;&gt;;
                    &lt;&lt;set $_temp_to_log += setup.fail(&quot;tact&quot;)&gt;&gt;;
                &lt;&lt;/if&gt;&gt;

                /* Reaction */
                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You stare at him blankly for a couple of seconds before \
                                            he realizes what he&#39;s asking of you.&lt;br&gt;\
                                            &lt;em&gt;&lt;b&gt;Shintani&lt;/b&gt;: \&quot;Oh nevermind,\&quot;&lt;/em&gt;\
                                            &lt;br&gt;he says \
                                            before gesturing to the door (Willpower &quot; + 
                                            setup.show_change_html(0, 1) + &quot;).&lt;/div&gt;&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.willpower += 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You tell him that this task is too difficult, but being \
                                            a seasoned slave master, Shintani knows when someone is trying to \
                                            get out of work. He eyes you for a second before dismissing you. \
                                            (Obedience &quot; + setup.show_change_html(0, -1) + &quot;, Trust &quot;+
                                            setup.show_change_html(0, -0.5) + &quot;)&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience -= 1&gt;&gt;
                    &lt;&lt;set $player.slave_traits.trust -= 0.5&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;case 2&gt;&gt;
                /* Dice roll */
                &lt;&lt;set _roll = $player.get_status_prop(&quot;tact&quot;) + dice(1, $difficulty + 6) - $difficulty&gt;&gt;
                &lt;&lt;if _roll gt 25&gt;&gt;
                    &lt;&lt;set _success = true&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.pass(&quot;tact&quot;)&gt;&gt;;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _success = false&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.fail(&quot;tact&quot;)&gt;&gt;;
                &lt;&lt;/if&gt;&gt;

                /* Reactions */
                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You look over the papers for a while, making purposeful yet \
                                            discrete grunts of agreement to yourself. After reaching the last \
                                            page, you return him the stack and tell him his work was meticulous \
                                            and well done. He smiles at you and dismisses you. (Obedience &quot; + 
                                            setup.show_change_html(0, 2) + &quot;, Trust &quot; + 
                                            setup.show_change_html(0, 0.5) + &quot;)&lt;/div&gt;&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience += 2&gt;&gt;
                    &lt;&lt;set $player.slave_traits.trust += 0.5&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You quickly look through the papers, and hand it back to him. \
                                            He dismisses you, but as you leave, you see him take the pile of papers \
                                            and move it back into his to-do stack. (Obedience &quot; + 
                                            setup.show_change_html(0, -2) + &quot;, Trust &quot; + 
                                            setup.show_change_html(0, -0.75) + &quot;).\
                                            &lt;/div&gt;&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience -= 2&gt;&gt;
                    &lt;&lt;set $player.slave_traits.trust -= 0.75&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;case 3&gt;&gt;
                &lt;&lt;set _roll = $player.get_status_prop(&quot;intelligence&quot;) + dice(1, $difficulty + 6) - $difficulty&gt;&gt;
                &lt;&lt;if _roll gt 20&gt;&gt;
                    &lt;&lt;set _success = true&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.pass(&quot;intelligence&quot;)&gt;&gt;;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.fail(&quot;intelligence&quot;)&gt;&gt;;
                    /* Sub-roll for willpower */
                    &lt;&lt;set _roll = $player.get_status_prop(&quot;willpower&quot;) + 2 * (dice(1, $difficulty + 6) - $difficulty)&gt;&gt;
                    &lt;&lt;if _roll gt 80&gt;&gt;
                        &lt;&lt;set _success = true&gt;&gt;
                        &lt;&lt;set _subroll = true&gt;&gt;
                        &lt;&lt;set $_temp_to_log += setup.pass(&quot;willpower&quot;)&gt;&gt;;
                        &lt;&lt;set $player.stats.intelligence += 0.5&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set _success = false&gt;&gt;
                        &lt;&lt;set _subroll = false&gt;&gt;
                        &lt;&lt;set $_temp_to_log += setup.fail(&quot;willpower&quot;)&gt;&gt;;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;/if&gt;&gt;

                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;Whether it was from your intelligence or pure willpower, \
                                            you were able to diligently check through Shintani&#39;s work. \
                                            After a while you spot a couple of small minor errors \
                                            and Shintani thanks you for it. &quot;&gt;&gt;
                    &lt;&lt;if _subroll&gt;&gt;
                        &lt;&lt;set $_temp_to_log += &quot;(Intelligence &quot; + setup.show_change_html(0, 0.5) + &quot;, &quot;&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set $_temp_to_log += &quot;(&quot;&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;unset _subroll&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;Obedience &quot; + setup.show_change_html(0, 2) + 
                                            &quot;, Trust &quot; + setup.show_change_html(0, 1) + &quot;).\
                                            &lt;/div&gt;&quot;&gt;&gt;

                    &lt;&lt;set $player.slave_traits.obedience += 2&gt;&gt;
                    &lt;&lt;set $player.slave_traits.trust += 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You spent a long time looking through Shintani&#39;s work, trying \
                                            to make sense what seems like completely gibberish to you. After a some \
                                            time, Shintani realizes that this task was far beyond you. He dismisses \
                                            you but not before commending your effort (Obedience &quot; 
                                            + setup.show_change_html(0, 1) + &quot;).&lt;/div&gt;&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience += 1&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;case 4&gt;&gt;
                &lt;&lt;set _roll = dice(1, $difficulty + 6) + $player.get_status_prop(&quot;intelligence&quot;) - $difficulty&gt;&gt;
                &lt;&lt;if _roll gt 35&gt;&gt;
                    &lt;&lt;set _success = true&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.pass(&quot;intelligence&quot;)&gt;&gt;;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;Knowing your way around numbers, you purposefully add in some \
                        hard-to-find errors into Shintani\&#39;s work. As you hand it off to him, he doesn\&#39;t notice \
                        at all (Willpower &quot; + setup.show_change_html(0, 10) + &quot;).&quot;&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _success = false&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.fail(&quot;intelligence&quot;)&gt;&gt;;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;Knowing your way around numbers, you purposefully add in some \
                        errors into Shintani\&#39;s work. As you hand it off to him, he notices your poor attempt of \
                        rebellion, but decides he is too busy right now to punish you \
                        (Obedience &quot; + setup.show_change_html(0, -4) + &quot;, Trust &quot; + 
                        setup.show_change_html(0, -1.5) + &quot;).&quot;&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                
                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $player.slave_traits.willpower += 10&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience -= 4&gt;&gt;
                    &lt;&lt;set $player.slave_traits.trust -= 1.5&gt;&gt;
                &lt;&lt;/if&gt;&gt;
        &lt;&lt;/switch&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
        &lt;&lt;unset _roll&gt;&gt;
        &lt;&lt;unset _success&gt;&gt;
        &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="95" name="shintaniHomeEventsWorkEconomicEvents" tags="" position="600,1225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;set _prefix = &quot;shintaniHomeEventsWorkEconomic&quot;&gt;&gt;
&lt;&lt;set _events = [
    &quot;CheckMath&quot;,
    &quot;FetchBook&quot;,
    &quot;GetTea&quot;,
    &quot;InformShintani&quot;
]&gt;&gt;

&lt;&lt;include `_prefix + either(_events)`&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="96" name="shintaniHomeEventsWorkEconomicFetchBook" tags="" position="725,1225" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;script&gt;&gt;
    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
    div.html(&quot;
        You were helping Shintani in his office when he realizes he forgot something,&lt;br&gt;\
        &lt;em&gt;&lt;b&gt;Shintani&lt;/b&gt;: \&quot;&quot; + setup.titleCase(State.variables.player.first_name) + &quot;, go \
        fetch me my log book, it should be on the second shelf on the right.\&quot;&lt;/em&gt;\
        &lt;br&gt;You look over and see the book, grabbing it. When you return to Shintani you \
        notice he is completely immersed in his work.\
        &lt;br&gt;\
        What do you do?\
        &lt;ol&gt;\
            &lt;li&gt;Give him the book.&lt;/li&gt;\
            &lt;li&gt;Give him the wrong book.&lt;/li&gt;\
            &lt;li&gt;Leave without giving him the book.&lt;/li&gt;\
        &lt;/ol&gt;\
    &quot;);
    setup.mainLog_append(div);
&lt;&lt;/script&gt;&gt;

&lt;&lt;set _choices = 3&gt;&gt;
&lt;&lt;disableactions&gt;&gt;


/* Psuedoevent listener for action */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;switch _action&gt;&gt;
            &lt;&lt;case 1&gt;&gt;
                &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You hand him the book and leave him to focus on his work \
                                        (Obedience &quot; + setup.show_change_html(0, 1, true) + &quot;, Trust &quot; + 
                                        setup.show_change_html(0, 0.5, true) + &quot;).&lt;/div&gt;&quot;&gt;&gt;
                &lt;&lt;set $player.slave_traits.obedience += 1&gt;&gt;
                &lt;&lt;set $player.slave_traits.trust += 0.5&gt;&gt;
            &lt;&lt;case 2&gt;&gt;
                /* Dice roll */
                &lt;&lt;set _roll = dice(1, $difficulty + 6) + $player.stats.intelligence&gt;&gt;
                &lt;&lt;if _roll gt 30&gt;&gt;
                    &lt;&lt;set _success = false&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.fail(&quot;intelligence&quot;)&gt;&gt;;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _success = true&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.pass(&quot;intelligence&quot;)&gt;&gt;;
                &lt;&lt;/if&gt;&gt;

                /* Reactions */
                &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You hand him the wrong book and leave him to focus on his work \
                                        (Willpower &quot; + setup.show_change_html(0, 2, true) + &quot;).&quot;&gt;&gt;
                &lt;&lt;set $player.slave_traits.willpower += 2&gt;&gt;
                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot; He notices you handed him the wrong book, but quickly remembers \
                                            you are too stupid to know any better.&lt;/div&gt;&quot;&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot; He notices you handed in the wrong book on purpose, as you \
                                            clearly are intelligent enough to know better (Obedience &quot; + 
                                            setup.show_change_html(0, -2, true) + &quot;, Trust &quot; + 
                                            setup.show_change_html(0, -0.5, true) + &quot;).\
                                            &lt;/div&gt;&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience -= 2&gt;&gt;
                    &lt;&lt;set $player.slave_traits.trust -= 0.5&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;case 3&gt;&gt;
                &lt;&lt;set _roll = dice(1, $difficulty + 6) + $player.stats.dexterity - $difficulty&gt;&gt;
                &lt;&lt;if _roll gt 30&gt;&gt;
                    &lt;&lt;set _success = true&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.pass(&quot;dexterity&quot;)&gt;&gt;;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _success = false&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.fail(&quot;dexterity&quot;)&gt;&gt;;
                &lt;&lt;/if&gt;&gt;

                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You left the room with Shintani too distracted to notice \
                                        (Willpower &quot; + setup.show_change_html(0, 1, true) + &quot;).&lt;/div&gt;&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.willpower += 1&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You left the room but on your way out bump into a chair, \
                                            Shintani is too engrossed in his work to stop you. (Obedience &quot; + 
                                            setup.show_change_html(0, -1, true) + &quot;, Trust &quot; + 
                                            setup.show_change_html(0, -0.5, true) + &quot;).\
                                            &lt;/div&gt;&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience -= 1&gt;&gt;
                    &lt;&lt;set $player.slave_traits.trust -= 0.5&gt;&gt;
                &lt;&lt;/if&gt;&gt;
        &lt;&lt;/switch&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
        &lt;&lt;unset _roll&gt;&gt;
        &lt;&lt;unset _success&gt;&gt;
        &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="97" name="shintaniHomeEventsWorkEconomicGetTea" tags="" position="850,1225" size="100,100">&lt;&lt;nobr&gt;&gt;

/* For ease */
&lt;&lt;set _char = $characters[either($characters.shintani_hiroyuki.slaves)]&gt;&gt;
&lt;&lt;set _higher_status = ($player.get_status(&quot;nipon&quot;) == &quot;slave&quot; &amp;&amp; _char.status == &quot;low_slave&quot;) ||
    ($player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot; &amp;&amp; _char.status == &quot;slave&quot;) || 
    ($player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot; &amp;&amp; _char.status == &quot;low_slave&quot;)&gt;&gt;
                                    
/* For eventual rounding and simulation */
&lt;&lt;set _to_round = _char.key&gt;&gt;
&lt;&lt;set $to_simulate.add(_char.key)&gt;&gt;

&lt;&lt;set _to_log = [
    &quot;As you were assisting &quot; + 
    setup.titleCase(_char.first_name) + &quot; with &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; duties, &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; starts to feel parched,&quot;,
    _char.dialogue(
        &quot;Go make me a cup of jasmine tea, you should be able to do that at least right?&quot;
    ),
    &quot;You go to the kitchen and open the cabinet stocking tens of different teas.&lt;br&gt;\
    What do you do?\
    &lt;ol&gt;\
        &lt;li&gt;Brew &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; a cup of jasmine tea like &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; asked.&lt;/li&gt;\
        &lt;li&gt;Brew &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; the wrong type of tea.&lt;/li&gt;\
    &lt;/ol&gt;&quot;
]&gt;&gt;
&lt;&lt;script&gt;&gt;
    setup.mainLog_append_delayed(State.temporary.to_log, 
        State.variables.buttons, 
        State.variables.buttons_extra);
&lt;&lt;/script&gt;&gt;

&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
    &lt;&lt;set _choices = 2&gt;&gt;
    &lt;&lt;disableactions&gt;&gt;
    
    &lt;&lt;stop&gt;&gt;
&lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

/* Psuedoevent listener for action */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;switch _action&gt;&gt;
            &lt;&lt;case 1&gt;&gt;
                &lt;&lt;if ndef _selected_action&gt;&gt;
                    &lt;&lt;set _selected_action = 1&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You brew &quot; + setup.titleCase(_char.first_name) + &quot; a nice cup of earl grey tea. \
                        As you inhale the soothing aroma you realize you could put something in it.&lt;br&gt;\
                        &lt;ol&gt;\
                            &lt;li&gt;Do nothing and give &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; the tea.&lt;/li&gt;\
                            &lt;li&gt;Spit in &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tea.&lt;/li&gt;&quot;
                    ]&gt;&gt;
                    &lt;&lt;set _choices = 2&gt;&gt;
                    &lt;&lt;if $player.gender == 0&gt;&gt;
                        &lt;&lt;set _responses[0] += &quot;&lt;li&gt;Cum into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tea.&lt;/li&gt;&lt;/ol&gt;&quot;&gt;&gt;
                        &lt;&lt;set _choices = 3&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;disableactions&gt;&gt;
                        
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                    &lt;&lt;set $_temp_to_log = &quot;\
                        As you walk back from the kitchen with the cup of tea, &quot; + setup.titleCase(_char.first_name) + &quot; immediately \
                        can tell from the aroma that you brewed the right tea. &quot;
                    &gt;&gt;
                &lt;&lt;elseif _selected_action == 1&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                        (Obedience &quot; + setup.show_change_html(0, 2) + &quot;).&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience += 2&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot;&gt;&gt;
                    &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
                &lt;&lt;elseif _selected_action == 2&gt;&gt;
                    &lt;&lt;set _char_disposition = _char.get_disposition()&gt;&gt;
                    &lt;&lt;switch _char_disposition&gt;&gt;
                        &lt;&lt;case &quot;submissive&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                            too submissive to protest your error \
                            (Willpower &quot; + setup.show_change_html(0, 2) + &quot;).&quot;&gt;&gt;
                        &lt;&lt;case &quot;devoted&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                too devoted to protest your error \
                                (Willpower &quot; + setup.show_change_html(0, 2) + &quot;) \
                                (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + setup.show_change_html(0, -1, false) + &quot;).&quot;&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                        &lt;&lt;case &quot;scared&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                too scared to protest your error \
                                (Willpower &quot; + setup.show_change_html(0, 2) + &quot;) \
                                (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + setup.show_change_html(0, -1, false) + &quot;).&quot;&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                        &lt;&lt;default&gt;&gt;
                            &lt;&lt;if _higher_status&gt;&gt;
                                &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                    and drinks the entire cup realizing that it would be a mistake to protest being a lower status than you. &quot;&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot; + _char.dialogue(&quot;Can\&#39;t even do something as simple \
                                    as brewing a cup of tea?&quot;) + &quot;\
                                    (Obedience &quot; + setup.show_change_html(0, -1) + 
                                    &quot;, Willpower &quot; + setup.show_change_html(0, 2) + &quot;).&quot;&gt;&gt;
                                &lt;&lt;set $player.slave_traits.obedience -= 1&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/switch&gt;&gt;
                    &lt;&lt;set $player.slave_traits.willpower += 2&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot;&gt;&gt;
                    &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;case 2&gt;&gt;
                &lt;&lt;if ndef _selected_action&gt;&gt;
                    &lt;&lt;set _selected_action = 2&gt;&gt;
                    &lt;&lt;set _responses = [
                        &quot;You brew &quot; + setup.titleCase(_char.first_name) + &quot; a nice cup of earl grey tea. As you inhale the soothing \
                        aroma you realize you could put something in it.&lt;br&gt;\
                        &lt;ol&gt;\
                            &lt;li&gt;Do nothing and give &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; the tea.&lt;/li&gt;\
                            &lt;li&gt;Spit in &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tea.&lt;/li&gt;&quot;
                    ]&gt;&gt;
                    &lt;&lt;set _choices = 2&gt;&gt;
                    &lt;&lt;if $player.gender == 0&gt;&gt;
                        &lt;&lt;set _responses[0] += &quot;&lt;li&gt;Cum into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tea.&lt;/li&gt;&lt;/ol&gt;&quot;&gt;&gt;
                        &lt;&lt;set _choices = 3&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;script&gt;&gt;
                        setup.mainLog_append_delayed(State.temporary.responses, 
                            State.variables.buttons, 
                            State.variables.buttons_extra);
                    &lt;&lt;/script&gt;&gt;
                    &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                        &lt;&lt;disableactions&gt;&gt;
                        
                        &lt;&lt;stop&gt;&gt;
                    &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
                    &lt;&lt;set $_temp_to_log = &quot;\
                        As you brew the cup of tea, &quot; + setup.titleCase(_char.first_name) + &quot; immediately can tell from the aroma that \
                        you brewed the wrong tea. &quot;
                    &gt;&gt;
                &lt;&lt;elseif _selected_action == 1&gt;&gt;
                    &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand, not \
                        noticing that you had spit in it \
                        (Obedience &quot; + setup.show_change_html(0, 1) + 
                        &quot;, Willpower &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                    &lt;&lt;set $player.slave_traits.obedience += 1&gt;&gt;
                    &lt;&lt;set $player.slave_traits.willpower += 1&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot;&gt;&gt;
                    &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
                &lt;&lt;elseif _selected_action == 2&gt;&gt;
                    &lt;&lt;set _char_disposition = _char.get_disposition()&gt;&gt;
                    &lt;&lt;switch _char_disposition&gt;&gt;
                        &lt;&lt;case &quot;submissive&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                            too submissive to protest your error \
                            (Willpower &quot; + setup.show_change_html(0, 3) + &quot;).&quot;&gt;&gt;
                        &lt;&lt;case &quot;devoted&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                too devoted to protest your error. When &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; takes a sip &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; recognizes \
                                the taste of your saliva, savoring it \
                                (Willpower &quot; + setup.show_change_html(0, 3) + &quot;) \
                                (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + setup.show_change_html(0, -1, false) + &quot;).&quot;&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                        &lt;&lt;case &quot;scared&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                too scared to protest your error \
                                (Willpower &quot; + setup.show_change_html(0, 3) + &quot;) \
                                (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Willpower &quot; + setup.show_change_html(0, -1, false) + &quot;).&quot;&gt;&gt;
                            &lt;&lt;set _char.slave_traits.willpower -= 1&gt;&gt;
                        &lt;&lt;default&gt;&gt;
                            &lt;&lt;if _higher_status&gt;&gt;
                                &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                    and drinks the entire cup realizing that it would be a mistake to protest being a lower status than you. &quot;&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot; + _char.dialogue(&quot;Can\&#39;t even do something as simple \
                                    as brewing a cup of tea?&quot;) + &quot;She dumps the tea out in front of you \
                                    (Obedience &quot; + setup.show_change_html(0, -1) + 
                                    &quot;, Willpower &quot; + setup.show_change_html(0, 3) + &quot;).&quot;&gt;&gt;
                                &lt;&lt;set $player.slave_traits.obedience -= 1&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/switch&gt;&gt;
                    &lt;&lt;set $player.slave_traits.willpower += 3&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot;&gt;&gt;
                    &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;case 3&gt;&gt;
                /* Roll for dexterity */
                &lt;&lt;set _roll = $player.stats.dexterity + dice(1, 6 + $difficulty) - $difficulty&gt;&gt;
                &lt;&lt;set _success = false&gt;&gt;
                &lt;&lt;if _roll gte 20&gt;&gt;
                    &lt;&lt;set _success = true&gt;&gt;
                &lt;&lt;/if&gt;&gt;

                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot; + setup.pass(&quot;dexterity&quot;) +
                        &quot;You successfully jack off and came directly into the cup of tea you just \
                        brewed for &quot; + setup.titleCase(_char.first_name) + &quot;. You bring it out of the kitchen and hand it to &quot; + 
                        setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;. &quot;
                    &gt;&gt;
                    &lt;&lt;if _selected_action == 1&gt;&gt;
                        &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand, and \
                            drinks the entire cup. &quot;&gt;&gt;
                        &lt;&lt;if _char.sex_fetishes.cum gte 50&gt;&gt;
                            &lt;&lt;set $_temp_to_log += &quot;Being a cum slut &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; recognizes the taste of your \
                                cum and savors it, greedily licking the bottom of the cup&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += &quot;\
                                (Obedience &quot; + setup.show_change_html(0, 1) +
                                &quot;, Willpower &quot; + setup.show_change_html(0, 4) + &quot;) \
                                (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 4) +
                                &quot;, Cum Fetish &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                        &lt;&lt;else&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(setup.PRONOUNS[_char.gender][&quot;?he&quot;]) + 
                                &quot; can tell the tea is slightly different but enjoys it&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += &quot;\
                                (Obedience &quot; + setup.show_change_html(0, 1) +
                                &quot;, Willpower &quot; + setup.show_change_html(0, 4) + &quot;) \
                                (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 1) +
                                &quot;, Cum Fetish &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.arousal += 1&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set $player.slave_traits.obedience += 1&gt;&gt;
                        &lt;&lt;set $player.slave_traits.willpower += 4&gt;&gt;
                        &lt;&lt;set _char.sex_fetishes.cum += 1&gt;&gt;
                        &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot;&gt;&gt;
                        &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
                    &lt;&lt;elseif _selected_action == 2&gt;&gt;
                        &lt;&lt;set _char_disposition = _char.get_disposition()&gt;&gt;
                        &lt;&lt;switch _char_disposition&gt;&gt;
                            &lt;&lt;case &quot;submissive&quot;&gt;&gt;
                                &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                    and drinks the entire cup, too submissive to protest your error. &quot;&gt;&gt;
                                &lt;&lt;set $player.slave_traits.willpower += 2&gt;&gt;
                            &lt;&lt;case &quot;devoted&quot;&gt;&gt;
                                &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                    and drinks the entire cup, too devoted to protest your error. &quot;&gt;&gt;
                            &lt;&lt;case &quot;scared&quot;&gt;&gt;
                                &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                    and drinks the entire cup too scared to protest your error. &quot;&gt;&gt;
                            &lt;&lt;default&gt;&gt;
                                &lt;&lt;if _higher_status&gt;&gt;
                                    &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; thanks you and takes the tea from your hand \
                                        and drinks the entire cup realizing that it would be a mistake to protest being a lower status than you. &quot;&gt;&gt;
                                &lt;&lt;else&gt;&gt;
                                    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot; + _char.dialogue(&quot;Can\&#39;t even do something as simple \
                                        as brewing a cup of tea?&quot;) + &quot;She dumps the tea out in front of you \
                                        (Obedience &quot; + setup.show_change_html(0, -1) + 
                                        &quot;, Willpower &quot; + setup.show_change_html(0, 4) + &quot;).&quot;&gt;&gt;
                                    &lt;&lt;set $player.slave_traits.obedience -= 1&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                        &lt;&lt;/switch&gt;&gt;
                        /* If &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; drank the tea */
                        &lt;&lt;if _char_disposition == &quot;submissive&quot; || 
                             _char_disposition == &quot;devoted&quot; ||
                             _char_disposition == &quot;scared&quot; || _higher_status&gt;&gt;
                            &lt;&lt;if _char.sex_fetishes.cum gte 50&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;Being a cum slut &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; recognizes the taste of your \
                                    cum and savors it, greedily licking the bottom of the cup. After &quot; + 
                                    setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot;\&#39;s done &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + 
                                    &quot; looks up at you and you can see a little of your cum dipping off &quot; + 
                                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; &quot; + _char.physical_traits.ethnicity + &quot; chin&quot;&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;\
                                    (Obedience &quot; + setup.show_change_html(0, 1) +
                                    &quot;, Willpower &quot; + setup.show_change_html(0, 4) + &quot;) \
                                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 4) +
                                    &quot;, Cum Fetish &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                                &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;She can tell the tea is slightly different but enjoys \
                                    it&quot;&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;\
                                    (Willpower &quot; + setup.show_change_html(0, 4) + &quot;) \
                                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 1) +
                                    &quot;, Cum Fetish &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                                &lt;&lt;set _char.mental_conditions.arousal += 1&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;set _char.sex_fetishes.cum += 1&gt;&gt;
                        &lt;&lt;/if&gt;&gt;
                        &lt;&lt;set $player.slave_traits.willpower += 4&gt;&gt;
                        &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot;&gt;&gt;
                        &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot; + setup.fail(&quot;dexterity&quot;) +
                        &quot;As you were jacking off in the kitchen you bump into the counter, causing \
                        &quot; + setup.titleCase(_char.first_name) + &quot; to come in. She catches you red-handed as you\&#39;re aiming your member \
                        into &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; cup of tea. &quot;
                    &gt;&gt;
                    &lt;&lt;set _char_disposition = _char.get_disposition()&gt;&gt;
                    &lt;&lt;switch _char_disposition&gt;&gt;
                        &lt;&lt;case &quot;submissive&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; is so submissive, &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; drops to &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; knees \
                                immediately and takes your member into &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; mouth. As you\&#39;re about \
                                to cum &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; aims your cock into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tea, drinking the entire thing in one \
                                gulp.&lt;br&gt;&quot;&gt;&gt;
                            &lt;&lt;if _char.sex_fetishes.cum gte 50&gt;&gt;
                                &lt;&lt;set $_temp_to_log += _char.dialogue(&quot;I love drinking your cum so much!&quot;)&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;\
                                    (Willpower &quot; + setup.show_change_html(0, 4) + &quot;) \
                                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 4) +
                                    &quot;, Cum Fetish &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                                    &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set $_temp_to_log += _char.dialogue(&quot;Thank you for the extra treat.&quot;)&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;\
                                    (Willpower &quot; + setup.show_change_html(0, 4) + &quot;) \
                                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 1) +
                                    &quot;, Cum Fetish &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                                    &lt;&lt;set _char.mental_conditions.arousal += 1&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;set $player.slave_traits.willpower += 4&gt;&gt;
                            &lt;&lt;set _char.sex_fetishes.cum += 1&gt;&gt;
                        &lt;&lt;case &quot;devoted&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += setup.titleCase(_char.first_name) + &quot; is so devoted, &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; drops to &quot; 
                                + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; knees \
                                immediately and takes your member into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; mouth. As you\&#39;re about \
                                to cum &quot; + setup.PRONOUNS[_char.gender][&quot;?he&quot;] + &quot; aims your cock into &quot; + setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; tea, drinking the entire thing in one \
                                gulp.&lt;br&gt;&quot;&gt;&gt;
                            &lt;&lt;if _char.sex_fetishes.cum gte 50&gt;&gt;
                                &lt;&lt;set $_temp_to_log += _char.dialogue(&quot;I love drinking your cum so much!&quot;)&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;\
                                    (Willpower &quot; + setup.show_change_html(0, 4) + &quot;) \
                                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 4) +
                                    &quot;, Cum Fetish &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                                    &lt;&lt;set _char.mental_conditions.arousal += 4&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set $_temp_to_log += _char.dialogue(&quot;Thank you for the extra treat.&quot;)&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;\
                                    (Willpower &quot; + setup.show_change_html(0, 4) + &quot;) \
                                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Arousal &quot; + setup.show_change_html(0, 1) +
                                    &quot;, Cum Fetish &quot; + setup.show_change_html(0, 1) + &quot;).&quot;&gt;&gt;
                                    &lt;&lt;set _char.mental_conditions.arousal += 1&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;set $player.slave_traits.willpower += 4&gt;&gt;
                            &lt;&lt;set _char.sex_fetishes.cum += 1&gt;&gt;
                        &lt;&lt;case &quot;scared&quot;&gt;&gt;
                            &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot; +
                                _char.dialogue(&quot;What the FUCK are you doing?!!&quot;) + 
                                &quot;You look &quot; + setup.titleCase(_char.first_name) + &quot; in &quot; + 
                                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes and can see that she\&#39;s terrified,&lt;br&gt;&quot; +
                                _char.dialogue(&quot;Pl...please don\&#39;t make me drink that.&quot;) + 
                                &quot;You don\&#39;t break eye contact and quickly finish into the tea, handing \
                                it to &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;. She takes the cup, shaking and slowly sips the tea until it\&#39;s \
                                empty &quot;&gt;&gt;
                            &lt;&lt;if !_higher_status&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;(Obedience &quot; + setup.show_change_html(0, -3) + &quot;, &quot;&gt;&gt;
                                &lt;&lt;set $player.slave_traits.obedience -= 3&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;(&quot;&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                            &lt;&lt;set $_temp_to_log += &quot;Willpower &quot; + setup.show_change_html(0, 5) + &quot;) \
                                (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -10) + 
                                &quot;, Anger &quot; + setup.show_change_html(0, 10, false) +
                                &quot;, Fear &quot; + setup.show_change_html(0, 5, false) + 
                                &quot;, Willpower &quot; + setup.show_change_html(0, -3, false) + &quot;).&quot;&gt;&gt;
                            &lt;&lt;set $player.slave_traits.willpower += 5&gt;&gt;
                            &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                            &lt;&lt;set _char.slave_traits.trust -= 5&gt;&gt;
                            &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                        &lt;&lt;default&gt;&gt;
                            &lt;&lt;if _higher_status&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot; +
                                    _char.dialogue(&quot;What the FUCK are you doing?!!&quot;) + 
                                    &quot;You look &quot; + setup.titleCase(_char.first_name) + &quot; in &quot; + 
                                    setup.PRONOUNS[_char.gender][&quot;?his&quot;] + &quot; eyes to remind &quot; + 
                                    setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot; of your higher status \
                                    and can see that she\&#39;s terrified,&lt;br&gt;&quot; +
                                    _char.dialogue(&quot;Pl...please don\&#39;t make me drink that.&quot;) + 
                                    &quot;You don\&#39;t break eye contact and quickly finish into the tea, handing \
                                    it to &quot; + setup.PRONOUNS[_char.gender][&quot;?him&quot;] + &quot;. She takes the cup, shaking and slowly sips the tea until it\&#39;s \
                                    empty \
                                    (Willpower &quot; + setup.show_change_html(0, 5) + &quot;) \
                                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -10) + 
                                    &quot;, Anger &quot; + setup.show_change_html(0, 10, false) +
                                    &quot;, Fear &quot; + setup.show_change_html(0, 5, false) + 
                                    &quot;, Willpower &quot; + setup.show_change_html(0, -3, false) + &quot;).&quot;&gt;&gt;
                                &lt;&lt;set $player.slave_traits.willpower += 5&gt;&gt;
                                &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                                &lt;&lt;set _char.slave_traits.trust -= 5&gt;&gt;
                                &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                            &lt;&lt;else&gt;&gt;
                                &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot; +
                                    _char.dialogue(&quot;What the FUCK are you doing?!!&quot;) + 
                                    &quot;You quickly escape from the kitchen as fast as you could \
                                    (Obedience &quot; + setup.show_change_html(0, -3) +
                                    &quot;, Willpower &quot; + setup.show_change_html(0, 5) + &quot;) \
                                    (&quot; + setup.titleCase(_char.first_name) + &quot;\&#39;s Affection &quot; + setup.show_change_html(0, -10) + 
                                    &quot;, Anger &quot; + setup.show_change_html(0, 10, false) +
                                    &quot;, Trust &quot; + setup.show_change_html(0, -5) + &quot;).&quot;&gt;&gt;
                                &lt;&lt;set $player.slave_traits.obedience -= 3&gt;&gt;
                                &lt;&lt;set $player.slave_traits.willpower += 5&gt;&gt;
                                &lt;&lt;set _char.slave_traits.obedience -= 10&gt;&gt;
                                /* Do not induce fear */
                                &lt;&lt;if _char.slave_traits.trust gt 0&gt;&gt;
                                    &lt;&lt;set _char.slave_traits.trust = Math.clamp(_char.slave_traits.trust - 5, 0, 100)&gt;&gt;
                                &lt;&lt;/if&gt;&gt;
                                &lt;&lt;set _char.mental_conditions.anger += 10&gt;&gt;
                            &lt;&lt;/if&gt;&gt;
                    &lt;&lt;/switch&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot;&gt;&gt;
                    &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
                &lt;&lt;/if&gt;&gt;
        &lt;&lt;/switch&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
        &lt;&lt;unset _roll&gt;&gt;
        &lt;&lt;unset _success&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="98" name="shintaniHomeEventsWorkEconomicInformShintani" tags="" position="975,1225" size="100,100">&lt;&lt;nobr&gt;&gt;

/* For ease */
&lt;&lt;set _himari = $characters.himari_hironaka&gt;&gt;
&lt;&lt;set _to_round = _himari.key&gt;&gt;
&lt;&lt;set _shintani = $characters.shintani_hiroyuki&gt;&gt;

&lt;&lt;set _to_log = [
    &quot;As you were assisting Himari with her duties, she realizes she forgot something,&quot;,
    _himari.dialogue(
        &quot;Oh I just remembered I needed to tell Shintani about the arrival of the Hoxel \
        caravan. I\&#39;m a bit busy right now, can you tell him for me?&quot;
    ),
    &quot;You enter Shintani\&#39;s office and he looks up at you wondering what you need\
    &lt;ol&gt;\
        &lt;li&gt;Tell him about the arrival of the Hoxel caravan like Himari told you to.&lt;/li&gt;\
        &lt;li&gt;Lie and say Himari told you to tell him about the arrival of the Fox Tail caravan.&lt;/li&gt;\
    &lt;/ol&gt;&quot;
]&gt;&gt;
&lt;&lt;script&gt;&gt;
    setup.mainLog_append_delayed(State.temporary.to_log, 
        State.variables.buttons, 
        State.variables.buttons_extra);
&lt;&lt;/script&gt;&gt;

&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
    &lt;&lt;set _choices = 2&gt;&gt;
    &lt;&lt;disableactions&gt;&gt;
    
    &lt;&lt;stop&gt;&gt;
&lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

/* Psuedoevent listener for action */
&lt;&lt;silently&gt;&gt;&lt;&lt;repeat 10ms&gt;&gt;
    &lt;&lt;if _action !== undefined&gt;&gt;
        &lt;&lt;switch _action&gt;&gt;
            &lt;&lt;case 1&gt;&gt;
                &lt;&lt;set $_temp_to_log = &quot;\
                    You approach Shintani and relay what Himari told you,&lt;br&gt;&quot; +
                    _shintani.dialogue(&quot;Thanks for letting me know.&quot;) + 
                    &quot;(Obedience &quot; + setup.show_change_html(0, 1) +
                    &quot;, Trust &quot; + setup.show_change_html(0, 0.5) + &quot;).&quot;
                &gt;&gt;
                &lt;&lt;set $player.slave_traits.obedience += 1&gt;&gt;
                &lt;&lt;set $player.slave_traits.trust += 0.5&gt;&gt;
            &lt;&lt;case 2&gt;&gt;
                &lt;&lt;set _roll = $player.get_status_prop(&quot;manipulation&quot;) + dice(1, 6 + $difficulty) - $difficulty&gt;&gt;
                &lt;&lt;if _roll gte 25&gt;&gt;
                    &lt;&lt;set _success = true&gt;&gt;
                    &lt;&lt;set $_temp_to_log = setup.pass(&quot;manipulation&quot;)&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set _success = false&gt;&gt;
                    &lt;&lt;set $_temp_to_log = setup.fail(&quot;manipulation&quot;)&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $_temp_to_log += &quot;You approach Shintani and relay false information from \
                    Himari,&lt;br&gt;&quot; +
                    $player.dialogue(&quot;Himari wanted me to inform you about the arrival of the Fox \
                        Tail caravan.&quot;)&gt;&gt;
                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $_temp_to_log += _shintani.dialogue(&quot;The Fox Tail caravan? They arrived \
                        last week... I\&#39;ll have to have a talk with Himari.&quot;) +
                        &quot;(&quot;&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += _shintani.dialogue(&quot;The Fox Tail caravan? They arrived \
                        last week... I think you better work on your listening skills.&quot;) +
                        &quot;(Trust &quot; + setup.show_change_html(0, -0.5) + &quot;, &quot;&gt;&gt;
                        &lt;&lt;set $player.slave_traits.trust -= 0.5&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $_temp_to_log += &quot;Willpower &quot; + setup.show_change_html(0, 2) + &quot;) &quot;&gt;&gt;
                &lt;&lt;set $player.slave_traits.willpower += 2&gt;&gt;
                &lt;&lt;if _success&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;(Himari Affection &quot; + setup.show_change_html(0, -1) +
                        &quot;, Trust &quot; + setup.show_change_html(0, -1) + 
                        &quot;, Willpower &quot; + setup.show_change_html(0, -1, false) + &quot;)&quot;&gt;&gt;
                    &lt;&lt;set _himari.slave_traits.obedience -= 1&gt;&gt;
                    &lt;&lt;if _himari.slave_traits.trust gt 0&gt;&gt;
                        &lt;&lt;set _himari.slave_traits.trust = Math.clamp(_himari.slave_traits.trust - 1, 0, 100)&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;set _himari.slave_traits.willpower -= 1&gt;&gt;
                &lt;&lt;/if&gt;&gt;
        &lt;&lt;/switch&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&quot;&gt;&gt;
        &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="99" name="shintaniHomeEventsWorkSexualEvents" tags="" position="1100,1225" size="100,100">&lt;&lt;set _events = [

]&gt;&gt;</tw-passagedata><tw-passagedata pid="100" name="shintaniHomeInteractActions" tags="" position="1225,1225" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;interact_actions&quot; class=&quot;action container row col hidden&quot; 
        style=&quot;--rows: 4; --cols: 5&quot;&gt;

    /* Fill up 5th column to prevent overflow */
    &lt;div style=&quot;grid-row: 1; grid-column: 5&quot;&gt;
        &lt;&lt;button &quot;Inspect&quot;&gt;&gt;
            &lt;&lt;set $last_visited = passage()&gt;&gt;
            &lt;&lt;set $in_menu = true&gt;&gt;
            &lt;&lt;saveVars&gt;&gt;
            &lt;&lt;goto characterMenu&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Back&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;shintaniHome&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

    &lt;&lt;button &quot;Ask&quot;&gt;&gt;
        &lt;&lt;set _ask_passage = &quot;shintaniHomeEventsInteract&quot; + 
            setup.titleCase($characters[$selected].first_name) + 
            &quot;Ask&quot;&gt;&gt;
        &lt;&lt;if tale.has(_ask_passage)&gt;&gt;
            &lt;&lt;include _ask_passage&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;include &quot;defaultAsk&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;script&gt;&gt;
            $(&quot;#interact_actions&quot;).addClass(&quot;hidden&quot;);
            $(&quot;#events_actions&quot;).removeClass(&quot;hidden&quot;);
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;/button&gt;&gt;

    &lt;&lt;button &quot;Influence&quot;&gt;&gt;
        &lt;&lt;if $selected == &quot;shintani_hiroyuki&quot;&gt;&gt;
            &lt;&lt;set _request_passage = &quot;shintaniHomeEventsInteract&quot; + 
                setup.titleCase($characters[$selected].first_name) + 
                &quot;Influence&quot;&gt;&gt;
            &lt;&lt;if tale.has(_request_passage)&gt;&gt;
                &lt;&lt;include _request_passage&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;if !$in_menu&gt;&gt;
                    &lt;&lt;set $last_visited = passage()&gt;&gt;
                    &lt;&lt;set $in_menu = true&gt;&gt;
                    &lt;&lt;saveVars&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;goto WIPMenu&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;include influenceEngine&gt;&gt;
            &lt;&lt;addclass &quot;#interact_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;

    &lt;&lt;button &quot;Manipulate&quot;&gt;&gt;
        &lt;&lt;set _manipulate_passage = &quot;shintaniHomeEventsInteract&quot; + 
            setup.titleCase($characters[$selected].first_name) + 
            &quot;Manipulate&quot;&gt;&gt;
        &lt;&lt;if tale.has(_manipulate_passage)&gt;&gt;
            &lt;&lt;include _manipulate_passage&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;if !$in_menu&gt;&gt;
                &lt;&lt;set $last_visited = passage()&gt;&gt;
                &lt;&lt;set $in_menu = true&gt;&gt;
                &lt;&lt;saveVars&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;goto WIPMenu&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;

    &lt;&lt;button &quot;Sex&quot;&gt;&gt;
        &lt;&lt;if $selected == &quot;shintani_hiroyuki&quot;&gt;&gt;
            &lt;&lt;set _request_passage = &quot;shintaniHomeEventsInteract&quot; + 
                setup.titleCase($characters[$selected].first_name) + 
                &quot;Influence&quot;&gt;&gt;
            &lt;&lt;if tale.has(_request_passage)&gt;&gt;
                &lt;&lt;include _request_passage&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;if !$in_menu&gt;&gt;
                    &lt;&lt;set $last_visited = passage()&gt;&gt;
                    &lt;&lt;set $in_menu = true&gt;&gt;
                    &lt;&lt;saveVars&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;goto WIPMenu&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;if $characters[$selected].limits.fuck gt 0&gt;&gt;
                &lt;&lt;include sexEngine&gt;&gt;
                &lt;&lt;addclass &quot;#info&quot; &quot;hidden&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#interact_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;
                    Already had sex with &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; 
                    today!
                &lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="101" name="shintaniHomeInteractAsleepActions" tags="" position="100,1350" size="100,100">&lt;&lt;nobr&gt;&gt;
/* For engines */
&lt;div id=&quot;interact_asleep_actions&quot; class=&quot;action container row col hidden&quot; 
        style=&quot;--rows: 4; --cols: 5&quot;&gt;

    /* Fill up 5th column to prevent overflow */
    &lt;div style=&quot;grid-row: 1; grid-column: 5&quot;&gt;
        &lt;&lt;button &quot;Inspect&quot;&gt;&gt;
            &lt;&lt;set $last_visited = passage()&gt;&gt;
            &lt;&lt;set $in_menu = true&gt;&gt;
            &lt;&lt;saveVars&gt;&gt;
            &lt;&lt;goto characterMenu&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Back&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;shintaniHome&quot;&gt;&gt;
        &lt;&lt;set _location_button_dur = 2&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

    &lt;&lt;button &quot;Search&quot;&gt;&gt;
        &lt;&lt;set _modifier = (_char.is_slave ? 20 : 0)&gt;&gt;
        &lt;&lt;if $player.get_status_prop(&quot;willpower&quot;) gt 50 + _modifier&gt;&gt;
            &lt;&lt;if _char.limits.search gt 0&gt;&gt;
                &lt;&lt;include searchEngine&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;
                    Already searched &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; 
                    today!
                &lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _to_notify = &quot;Your willpower is too low!&quot;&gt;&gt;
            &lt;&lt;notify&gt;&gt;_to_notify&lt;&lt;/notify&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;unset _modifier&gt;&gt;
    &lt;&lt;/button&gt;&gt;

    &lt;&lt;button &quot;Molest&quot;&gt;&gt;
        &lt;&lt;set _modifier = (_char.is_slave ? 0 : 10)&gt;&gt;
        &lt;&lt;if $player.get_status_prop(&quot;willpower&quot;) gt 60 + _modifier&gt;&gt;
            &lt;&lt;if _char.limits.molest gt 0&gt;&gt;
                &lt;&lt;include molestEngine&gt;&gt;
                &lt;&lt;addclass &quot;#interact_asleep_actions&quot; &quot;hidden&quot;&gt;&gt;
                &lt;&lt;addclass &quot;#info&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;notify&gt;&gt;
                    Already molested &lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; 
                    today!
                &lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _to_notify = &quot;Your willpower is too low!&quot;&gt;&gt;
            &lt;&lt;notify&gt;&gt;_to_notify&lt;&lt;/notify&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;unset _modifier&gt;&gt;
    &lt;&lt;/button&gt;&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="102" name="shintaniHomeInteractOptions" tags="" position="225,1350" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;interact_options&quot; class=&quot;action container row col hidden&quot; 
        style=&quot;--rows: 4; --cols: 5&quot;&gt;

    &lt;div style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;script&gt;&gt;
                $(&quot;#interact_options&quot;).addClass(&quot;hidden&quot;);
                $(&quot;#actions&quot;).removeClass(&quot;hidden&quot;);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

    /* Fill up 5th column to prevent overflow */
    &lt;div style=&quot;grid-row: 1; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 5&quot;&gt;&lt;/div&gt;

    &lt;div style=&quot;grid-row: 1; grid-column: 1&quot;&gt;
        &lt;&lt;button &quot;Shintani&quot;&gt;&gt;
            &lt;&lt;set $selected = &quot;shintani_hiroyuki&quot;&gt;&gt;
            &lt;&lt;set _char = $characters[$selected]&gt;&gt;
            &lt;&lt;script&gt;&gt;
                $(&quot;#interact_options&quot;).addClass(&quot;hidden&quot;);
                var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
                var char = State.variables.characters.shintani_hiroyuki;
                var gameDate = State.variables.gameDate;
                if (gameDate.getHours() &lt;= 5 || gameDate.getHours() &gt;= 22) {
                    var str = &quot;
                        You make your way over to Shintani\&#39;s quarters to find him \
                        peacefully asleep.&lt;br&gt;\
                    &quot;;
                    if (char.mental_conditions.suspicion &gt; 0) {
                        str += &quot;&lt;span class=\&quot;fail\&quot;&gt;(&quot; + setup.titleCase(char.first_name) + 
                            &quot; will be harder to steal from or molest since they are suspicious)&lt;/span&gt;&quot;
                    }
                    div.html(str);
                    $(&quot;#interact_asleep_actions&quot;).removeClass(&quot;hidden&quot;);
                    $(&quot;#mainLogImage&quot;).css(&quot;background-image&quot;,
                        &quot;url(\&quot;resources/images/places/shintaniHomeShintaniNightImage.png\&quot;)&quot;
                    );
                } else {
                    div.html(&quot;
                        You approach Shintani in his office.&lt;br&gt;&quot;
                    );
                    $(&quot;#interact_actions&quot;).removeClass(&quot;hidden&quot;);
                    $(&quot;#mainLogImage&quot;).css(&quot;background-image&quot;,
                        &quot;url(\&quot;resources/images/places/shintaniHomeOfficeImage.png\&quot;)&quot;
                    );
                    $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                        &quot;url(\&quot;&quot; + char.image_folder() + 
                        char.first_name.toLowerCase() + &quot;_neutral.png\&quot;)&quot;
                    );
                }
                setup.mainLog_append(div);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;addmins `dice(1, 5) + 5`&gt;&gt;
            &lt;&lt;audio &quot;wooden_door_sound&quot; play&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;

    &lt;&lt;set _iter = $characters.shintani_hiroyuki.slaves&gt;&gt;
    &lt;&lt;for _i = 0; _i lt _iter.length; _i++&gt;&gt;
        &lt;div&gt;
            &lt;&lt;capture _i&gt;&gt;
            &lt;&lt;button `setup.titleCase($characters[_iter[_i]].first_name)`&gt;&gt;
                &lt;&lt;set $selected = _iter[_i]&gt;&gt;
                &lt;&lt;set _char = $characters[$selected]&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    var char = State.variables.characters[State.variables.selected];
                    $(&quot;#interact_options&quot;).addClass(&quot;hidden&quot;);
                    
                    var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
                    var gameDate = State.variables.gameDate;
                    if (gameDate.getHours() &lt;= 5 || gameDate.getHours() &gt;= 22) {
                        var str = &quot;
                            You make your way over to &quot; + char.name() + &quot;\&#39;s room to find &quot; +
                            setup.PRONOUNS[char.gender][&quot;?him&quot;] + &quot; peacefully asleep.&lt;br&gt;\
                        &quot;;
                        if (char.mental_conditions.suspicion &gt; 0) {
                            str += &quot;&lt;span class=\&quot;fail\&quot;&gt;(&quot; + setup.titleCase(char.first_name) + 
                                &quot; will be harder to steal from or molest since they are suspicious)&lt;/span&gt;&quot;
                        }
                        div.html(str);
                        $(&quot;#interact_asleep_actions&quot;).removeClass(&quot;hidden&quot;);
                        $(&quot;#mainLogImage&quot;).css(&quot;background-image&quot;,
                            &quot;url(\&quot;resources/images/places/shintaniHome&quot; + 
                            setup.titleCase(char.first_name)
                            + &quot;NightImage.png\&quot;)&quot;
                        );
                        
                        State.temporary.play_sound = true;
                    } else {
                        div.html(&quot;
                            You spot &quot; + char.name() + &quot; working and approach her.&lt;br&gt;&quot; +
                            char.toString()
                        );
                        $(&quot;#interact_actions&quot;).removeClass(&quot;hidden&quot;);
                        $(&quot;#mainLogImage&quot;).css(&quot;background-image&quot;,
                            &quot;url(\&quot;resources/images/places/shintaniHome&quot; + 
                            setup.titleCase(char.first_name)
                            + &quot;DayImage.png\&quot;)&quot;
                        );
                        $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                            &quot;url(\&quot;&quot; + char.image_folder() + 
                            char.first_name.toLowerCase() + &quot;_&quot; +
                            char.get_disposition() + &quot;.png\&quot;)&quot;
                        );
                        State.temporary.play_sound = false;
                    }
                    setup.mainLog_append(div);
                &lt;&lt;/script&gt;&gt;
                /* Forward time by 5 - 10 minutes */
                &lt;&lt;addmins `dice(1, 5) + 5`&gt;&gt;
                &lt;&lt;if _play_sound&gt;&gt;
                    &lt;&lt;audio &quot;wooden_door_sound&quot; play&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;unset _play_sound&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;&lt;/capture&gt;&gt;
        &lt;/div&gt;
    &lt;&lt;/for&gt;&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="103" name="shintaniHomeLibraryActions" tags="" position="350,1350" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;actions&quot; class=&quot;action container row col&quot; 
         style=&quot;--rows: 4; --cols: 5&quot;&gt;

         &lt;&lt;button &quot;Study&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#info_title&quot;).html(&quot;Study in the Hiroyuki Library&quot;)&gt;&gt;
            &lt;&lt;set _default_info = $(&quot;&lt;div&gt;\
                &lt;div id=\&quot;normal_study\&quot;&gt;\
                The shelves in the Hiroyuki library are stuffed to the brim with knowledge \
                just waiting to be learned.\
                &lt;ul id=\&quot;change_list\&quot;&gt;\
                    &lt;li id=\&quot;li1\&quot;&gt;3% per hour chance to gain intelligence (capped at 40).&lt;/li&gt;\
                    &lt;li id=\&quot;li2\&quot; class=\&quot;hidden\&quot;&gt;&lt;/li&gt;\
                    &lt;li id=\&quot;li3\&quot; class=\&quot;hidden\&quot;&gt;&lt;/li&gt;\
                &lt;/ul&gt;&lt;/div&gt;\
                &lt;div id=\&quot;subject_study\&quot;&gt;\
                You could also expend some extra effort to focus on a specific topic if you\&#39;d like.\
                &lt;ul&gt;\
                    &lt;li id=\&quot;li4\&quot;&gt;(intelligence/20)% per hour chance to increase subject stat.&lt;/li&gt;\
                    &lt;li id=\&quot;li5\&quot;&gt;-3 additional stamina per hour.&lt;/li&gt;\
                &lt;/ul&gt;&lt;/div&gt;\
            &lt;/div&gt;&quot;)&gt;&gt;
            &lt;&lt;run $(&quot;#infoLogBody&quot;).html(&quot;&quot;)&gt;&gt;
            &lt;&lt;run $(&quot;#infoLogBody&quot;).append(_default_info.clone())&gt;&gt;
            &lt;&lt;removeclass &quot;#study_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#infoLog&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#mainLog&quot; &quot;hidden&quot;&gt;&gt;
            /* Reset study buttons */
            &lt;&lt;script&gt;&gt;
                $(&quot;.study button&quot;).removeClass(&quot;disabled&quot;);
                $(&quot;.study button&quot;).prop(&quot;disabled&quot;, false);
                $(&quot;.study_option button&quot;).addClass(&quot;disabled&quot;);
                $(&quot;.study_option button&quot;).prop(&quot;disabled&quot;, true);
                $(&quot;#studyStart button&quot;).addClass(&quot;disabled&quot;);
                $(&quot;#studyStart button&quot;).prop(&quot;disabled&quot;, true);
            &lt;&lt;/script&gt;&gt;
         &lt;&lt;/button&gt;&gt;

         &lt;&lt;button &quot;Search&quot; `passage()`&gt;&gt;
            &lt;&lt;if $quests.power_struggles.stage == 1&gt;&gt;
                &lt;&lt;set $_temp_to_log = &quot;You searched the library for an hour and found a tattered old book with \
                    the symbol that Lia showed you. &quot;&gt;&gt;
                &lt;&lt;if $player.titles.has(&quot;lost_knowledge&quot;)&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;As you openned the book you were immediately greated with what you \
                        recognized as a \&quot;long tongue\&quot;, specifically an eastern variety. It seems the book \
                        describes the different births and deaths spanning since the beginning of time at year 0. &quot;&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log += &quot;As you openned the book you were immediately greated with cryptic \
                        symbols that did not resemble any writing system you\&#39;ve ever seen. &quot;&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;set $_temp_to_log += &quot;On the inside of the cover you see another symbol that looks extremely familiar.&quot;&gt;&gt;
                &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&lt;span class=\&quot;success\&quot;&gt;(Acquired Hiroyuki Family Registry)&lt;/span&gt;&quot;&gt;&gt;
                &lt;&lt;set $quests.power_struggles.stage = 2&gt;&gt;
                &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;hiroyuki_book&quot;, 1)&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;if $player.titles.has(&quot;lost_knowledge&quot;)&gt;&gt;
                    &lt;&lt;set $_temp_to_log = &quot;You searched the library for an hour but only found unimportant \
                        documents.&quot;&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $_temp_to_log = &quot;You searched the library for an hour but only found either unimportant \
                        documents or scrolls with cryptic symbols on them. Perhaps you might be able to find \
                        someone who could decipher them.&quot;&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;addhours 1&gt;&gt;
         &lt;&lt;/button&gt;&gt;
        
        &lt;div style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
            &lt;&lt;set _location_button_text = &quot;Back&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;shintaniHome&quot;&gt;&gt;
            &lt;&lt;set _location_button_dur = 2&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;/div&gt;

        &lt;div style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
            &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
            &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
            &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
            &lt;&lt;include locationButton&gt;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="104" name="shintaniHomeLibrary" tags="black" position="475,1350" size="100,100">&lt;&lt;nobr&gt;&gt;
/* Add tutorial for shintaniHome as well as trigger on first enterance */
&lt;&lt;if !(passage() in $tutorials)&gt;&gt;
    &lt;&lt;set $tutorials[passage()] = passage() + &quot;Tutorial&quot;&gt;&gt;

    /* First interaction */
    &lt;&lt;set $_to_log = &quot;\
        &lt;div&gt;You enter a library that seems to have been untouched for many years. While \
        you realize that looking through everything will take a long time, you are sure that \
        this room hides some answers to your curiosities and eventual escape from slavery.&lt;/div&gt;&lt;br&gt;\
    &quot;&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;set $_to_log = &quot;&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;set $_to_log += &quot;
    &lt;div&gt;The library spans multiple floors and seems to be frozen in time, as if it were \
    quickly abandoned due to some emergency.&lt;/div&gt;&lt;br&gt;\
&quot;&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;
 

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;div class=&quot;main container fourCol threeRow&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div class=&quot;subbackground mainLogContainer&quot;&gt;
            &lt;&lt;include mainLog&gt;&gt;
            &lt;&lt;include infoLog&gt;&gt;
        &lt;/div&gt;
        &lt;&lt;include info&gt;&gt;

        &lt;div id=&quot;action_bar&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 3 / span 1; grid-column: 1 / span 3&quot;&gt;
            &lt;&lt;include shintaniHomeLibraryActions&gt;&gt;
            &lt;&lt;include shintaniHomeLibraryStudyActions&gt;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;


&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="105" name="shintaniHomeLibraryStudyActions" tags="" position="600,1350" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;study_actions&quot; class=&quot;action container row col fiveQuarters smalltext longbutton hidden&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    
    /* How long we want to work for */
    &lt;div style=&quot;grid-row: 1; grid-column: 1&quot;&gt;
        @@#study1Hr;.study;&lt;&lt;button &quot;1 Hour&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 1; grid-column: 2&quot;&gt;
        @@#study4Hr;.study;&lt;&lt;button &quot;4 Hours&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 1; grid-column: 3&quot;&gt;
        @@#study8Hr;.study;&lt;&lt;button &quot;8 Hours&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;


    &lt;div style=&quot;grid-row: 1; grid-column: 4&quot;&gt;
        &lt;&lt;disable&gt;&gt;
            @@#studyStart;&lt;&lt;button &quot;Start&quot;&gt;&gt;
                &lt;&lt;include shintaniHomeLibraryStudyEngine&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
    &lt;/div&gt;

    &lt;&lt;disable&gt;&gt;
        @@#manipulation;.study_option;&lt;&lt;button &quot;Manipulation&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;
    &lt;&lt;disable&gt;&gt;
        @@#tact;.study_option;&lt;&lt;button &quot;Tact&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;

    &lt;div style=&quot;grid-row: 3; grid-column: 4&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#study_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#mainLog&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#infoLog&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;

&lt;&lt;timed 50ms&gt;&gt;&lt;&lt;silently&gt;&gt;&lt;&lt;script&gt;&gt;
    $(&quot;.study button&quot;).on(&quot;click&quot;, (event) =&gt; {
        let player = State.variables.player;
        $(&quot;.study button&quot;).removeClass(&quot;disabled&quot;);
        $(&quot;.study button&quot;).prop(&quot;disabled&quot;, false);
        
        let self = $(event.currentTarget);
        let study_time = parseInt(self.html().replace(/\D/g,&#39;&#39;));
        State.temporary.to_advance_hr = study_time;
        if (Math.abs(setup.project_stamina_change(60 * study_time)) &lt; player.conditions.stamina) {
            self.addClass(&quot;disabled&quot;);
            self.prop(&quot;disabled&quot;, true);
            $(&quot;.study_option button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;.study_option button&quot;).prop(&quot;disabled&quot;, false);
            State.temporary.study_subject = &quot;none&quot;;
            $(&quot;#subject_study&quot;).addClass(&quot;hidden&quot;);
            let intell_perc = 3;
            if (player.stats.intelligence &gt; 40) {
                intell_perc = 0;
            }
            $(&quot;#li1&quot;).html(intell_perc * study_time + &quot;% change to gain intelligence.&quot;);
            $(&quot;#li2&quot;).addClass(&quot;hidden&quot;);
            $(&quot;#li3&quot;).addClass(&quot;hidden&quot;);
            $(&quot;#studyStart button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#studyStart button&quot;).prop(&quot;disabled&quot;, false);
        } else {
            let str = &quot;&lt;&lt;popover&gt;&gt;You are too tired to study &quot; + study_time + &quot; &quot;;
            if (study_time == 1) {
                str += &quot;hour.&quot;;
            } else {
                str += &quot;hours.&quot;;
            }
            str += &quot;&lt;&lt;/popover&gt;&gt;&quot;;
            $.wiki(str);
            $(&quot;.study_option button&quot;).addClass(&quot;disabled&quot;);
            $(&quot;.study_option button&quot;).prop(&quot;disabled&quot;, true);
            $(&quot;#studyStart button&quot;).addClass(&quot;disabled&quot;);
            $(&quot;#studyStart button&quot;).prop(&quot;disabled&quot;, true);
            $(&quot;#infoLogBody&quot;).html(&quot;&quot;);
            $(&quot;#infoLogBody&quot;).append(State.temporary.default_info.clone());
        }
    });
    $(&quot;.study_option button&quot;).on(&quot;click&quot;, (event) =&gt; {
        let player = State.variables.player;
        let study_time = State.temporary.to_advance_hr;
        if (3 * study_time + Math.abs(setup.project_stamina_change(60 * study_time)) &lt; player.conditions.stamina) {
            $(&quot;.study_option button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;.study_option button&quot;).prop(&quot;disabled&quot;, false);
            let self = $(event.currentTarget);
            self.addClass(&quot;disabled&quot;);
            self.prop(&quot;disabled&quot;, true);
            let study_subject = self.html().toLowerCase();
            State.temporary.study_subject = study_subject;
            let raise_perc = player.stats.intelligence / 20 * study_time;
            $(&quot;#li2&quot;).html(raise_perc + &quot;% change to increase &quot; + study_subject + &quot;.&quot;);
            $(&quot;#li2&quot;).removeClass(&quot;hidden&quot;);
            $(&quot;#li3&quot;).html(-3 * study_time + &quot; additional stamina.&quot;);
            $(&quot;#li3&quot;).removeClass(&quot;hidden&quot;);
        } else {
            $.wiki(&quot;&lt;&lt;popover&gt;&gt;You are too tired to study an additional subject.&lt;&lt;/popover&gt;&gt;&quot;);
        }
    })
&lt;&lt;/script&gt;&gt;&lt;&lt;/silently&gt;&gt;&lt;&lt;/timed&gt;&gt;


&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="106" name="shintaniHomeLibraryStudyEngine" tags="" position="725,1350" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Information about work */
&lt;&lt;set $_temp_to_log = &quot;\
    &lt;div&gt;You spent time intensely studying in the Hiroyuki library.&lt;/div&gt;\
&quot;&gt;&gt;

/* Get clone of player to display changes */
&lt;&lt;set _player = clone($player)&gt;&gt;

/* Forward time along with dynamics */
&lt;&lt;set $player.is_working = true&gt;&gt;
&lt;&lt;addhours _to_advance_hr&gt;&gt;
&lt;&lt;set $player.is_working = false&gt;&gt;

/* Simulate intelligence roll */
&lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
&lt;&lt;set _thresh = _to_advance_hr * 3 / 100&gt;&gt;
&lt;&lt;if $player.stats.intelligence gte 40&gt;&gt;
    &lt;&lt;set _thresh = 0&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;if _roll lt _thresh&gt;&gt;
    &lt;&lt;set $player.stats.intelligence += 1&gt;&gt;
    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You studied the perfect combination of subjects, resulting in clear \
        mental growth (Intelligence &quot; + setup.show_change_html(0, 1) + &quot;)&lt;/div&gt;&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Simulate subject learning */
&lt;&lt;if _study_subject != &quot;none&quot;&gt;&gt;
    &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
    &lt;&lt;set _thresh = (_to_advance_hr * $player.stats.intelligence / 20) / 100&gt;&gt;
    &lt;&lt;if _roll lt _thresh&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;Your study of &quot; + _study_subject + &quot; was extremely successful and informative \
            (&quot; + setup.titleCase(_study_subject) + &quot; &quot; + setup.show_change_html(0, 1) + &quot;)&lt;/div&gt;&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;set $player.stats[_study_subject] += 1&gt;&gt;
    &lt;&lt;set $player.conditions.stamina -= 3 * _to_advance_hr&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Round off and clamp */
&lt;&lt;include round&gt;&gt;

&lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&lt;b&gt;Study total stat changes:&lt;/b&gt;&quot;&gt;&gt;
&lt;&lt;set $_temp_to_log += &quot;&lt;ul&gt;&quot;&gt;&gt;

/* Add in stats changes */
&lt;&lt;for _key, _val range _player.stats&gt;&gt;
    &lt;&lt;if _val != $player.stats[_key]&gt;&gt;
        &lt;&lt;set $_temp_to_log += (&quot;&lt;li&gt;&quot; + setup.titleCase(_key) + &quot;: &quot; +
            setup.show_change_html(_val, $player.stats[_key], true) +  &quot;&lt;/li&gt;&quot;)&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Add in condition changes */
&lt;&lt;for _key, _val range _player.conditions&gt;&gt;
    &lt;&lt;if _val != $player.conditions[_key]&gt;&gt;
        &lt;&lt;set $_temp_to_log += (&quot;&lt;li&gt;&quot; + setup.titleCase(_key) + &quot;: &quot; +
            setup.show_change_html(_val, $player.conditions[_key], true) +  &quot;&lt;/li&gt;&quot;)&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Add in slave trait changes */
&lt;&lt;for _key, _val range _player.slave_traits&gt;&gt;
    &lt;&lt;if _val != $player.slave_traits[_key]&gt;&gt;
        &lt;&lt;set $_temp_to_log += (&quot;&lt;li&gt;&quot; + setup.titleCase(_key) + &quot;: &quot; +
            setup.show_change_html(_val, $player.slave_traits[_key], true) +  &quot;&lt;/li&gt;&quot;)&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Close off changes */
&lt;&lt;set $_temp_to_log += &quot;&lt;/ul&gt;&quot;&gt;&gt;

/* Unset variables */
&lt;&lt;unset _changes&gt;&gt;
&lt;&lt;unset _to_advance_hr&gt;&gt;
&lt;&lt;unset $_player&gt;&gt;

/* Re-enable menu */
&lt;&lt;set $enable_menu = true&gt;&gt;

&lt;&lt;goto `passage()`&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="107" name="shintaniHome" tags="black" position="850,1350" size="100,100">&lt;&lt;nobr&gt;&gt;
/* Add tutorial for shintaniHome as well as trigger on first enterance */
&lt;&lt;if !(passage() in $tutorials)&gt;&gt;
    /* Enable menu keybinds */
    &lt;&lt;set $enable_menu = true&gt;&gt;
    &lt;&lt;set $tutorials[passage()] = &quot;shintaniHomeTutorial&quot;&gt;&gt;
    &lt;&lt;popover &quot;noclick&quot;&gt;&gt;
        &lt;&lt;include welcome&gt;&gt;
    &lt;&lt;/popover&gt;&gt;

    /* First interaction */
    &lt;&lt;set $_to_log = &quot;\
        &lt;div&gt;Shintani brings you to a quite well-embellished mansion, and shows you to \
        your dusty room. \&quot;I&#39;ll give you a bit of time to settle in. You can report \
        to Himari for work,\&quot; he gestures to a slim woman across the hall staring \
        daggers at you. He notices your fixed gaze on the large ornate door that led \
        inside. \&quot;Don&#39;t think about leaving this place for now. We need to make sure \
        you&#39;re to be trusted first.\&quot; Finally he puts a necklace around your neck that \
        seems to tighten in place once released, \&quot;This will let everyone know that you \
        are a Hironaka, you won\&#39;t be able to take it off without my permission.\&quot;&lt;/div&gt;&lt;br&gt;\
    &quot;&gt;&gt;

    /* Give player Hironaka Symbol */
    &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;hironaka_amulet&quot;, 1)&gt;&gt;
    &lt;&lt;set $player.equipment.neck = &quot;hironaka_amulet&quot;&gt;&gt;

&lt;&lt;else&gt;&gt;
    &lt;&lt;set $_to_log = &quot;&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;set $_to_log += &quot;
    &lt;div&gt;The Hiroyuki Household is quiet but holds an eerie sense of providence, as if \
    something world-changing could occur at any moment.&lt;/div&gt;&lt;br&gt;\
&quot;&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt; 

/* Player back inside */
&lt;&lt;set $player.is_home = true&gt;&gt;
&lt;&lt;set $player.is_outside = false&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;div class=&quot;main container fourCol threeRow&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div class=&quot;subbackground mainLogContainer&quot;&gt;
            &lt;&lt;include mainLog&gt;&gt;
        &lt;/div&gt;

        &lt;&lt;include info&gt;&gt;
        &lt;&lt;include molestInfo&gt;&gt;
        &lt;&lt;include sexInfo&gt;&gt;

        &lt;div id=&quot;action_bar&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 3 / span 1; grid-column: 1 / span 3&quot;&gt;
            /* Main actions */
            &lt;&lt;include shintaniHomeActions&gt;&gt;
            
            /* Work actions */
            &lt;&lt;include shintaniHomeWorkActions&gt;&gt;

            /* Event actions */
            &lt;&lt;include shintaniHomeEventsActions&gt;&gt;

            /* Interact options */
            &lt;&lt;include shintaniHomeInteractOptions&gt;&gt;

            /* Interact actions */
            &lt;&lt;include shintaniHomeInteractActions&gt;&gt;
            &lt;&lt;include shintaniHomeInteractAsleepActions&gt;&gt;

            /* Molest actions */
            &lt;&lt;include molestActions&gt;&gt;
            &lt;&lt;include molestCumActions&gt;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="108" name="shintaniHomeSleep" tags="black" position="975,1350" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Check for fill or emptied slave_traits */
&lt;&lt;set _player_extra_changes = &quot;&quot;&gt;&gt;
&lt;&lt;if $player.is_slave&gt;&gt;
    /* If trust falls to zero lower status */
    &lt;&lt;if $player.slave_traits.trust == 0&gt;&gt;
        &lt;&lt;if $player.get_status(&quot;shintaniHome&quot;) == &quot;slave&quot;&gt;&gt;
            &lt;&lt;set $location_status[&quot;nipon&quot;] = &quot;low_slave&quot;&gt;&gt;
            &lt;&lt;updatestatus&gt;&gt;
            &lt;&lt;set _player_extra_changes += &quot;\
                You\&#39;re low trust with Shintani has caused your status to drop within Nipon.\
            &quot;&gt;&gt;
            &lt;&lt;if $has_access.has(&quot;niponCentral&quot;)&gt;&gt;
                &lt;&lt;set $has_access.delete(&quot;niponCentral&quot;)&gt;&gt;
                &lt;&lt;set _player_extra_changes += &quot;\
                    Due to your status as a low slave, Shintani has decided to revoke your privledges \
                    to leave the household.\
                &quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;set $player.slave_traits.trust = 50&gt;&gt;
            /* Prevent change from showing */
            &lt;&lt;set $_player.slave_traits.trust = 50&gt;&gt;
            /* Modify Shintani&#39;s view of the player */
            &lt;&lt;set $characters.shintani_hiroyuki.slave_traits.obedience = 30&gt;&gt;
            &lt;&lt;set $characters.shintani_hiroyuki.slave_traits.trust = 0&gt;&gt;
        &lt;&lt;elseif $player.get_status(&quot;shintaniHome&quot;) == &quot;high_slave&quot;&gt;&gt;
            &lt;&lt;set $location_status[&quot;nipon&quot;] = &quot;slave&quot;&gt;&gt;
            &lt;&lt;updatestatus&gt;&gt;
            &lt;&lt;set _player_extra_changes += &quot;\
                You\&#39;re low trust with Shintani has caused your status to drop within Nipon.\
            &quot;&gt;&gt;
            &lt;&lt;set $player.slave_traits.trust = 50&gt;&gt;
            /* Prevent change from showing */
            &lt;&lt;set $_player.slave_traits.trust = 50&gt;&gt;
            /* Modify Shintani&#39;s view of the player */
            &lt;&lt;set $characters.shintani_hiroyuki.slave_traits.obedience = 50&gt;&gt;
            &lt;&lt;set $characters.shintani_hiroyuki.slave_traits.trust = 25&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* If obedience falls to zero, give beating */
    &lt;&lt;if $player.slave_traits.obedience == 0&gt;&gt;
        &lt;&lt;set _player_extra_changes += &quot;\
            You\&#39;re low obedience in the Hiroyuki household now shows in the new lash marks \
            now on your back. This severly affects your health and may lead to long-term consequences \
            (&quot;&gt;&gt;
        &lt;&lt;set $player.slave_traits.trust -= 10&gt;&gt;
        &lt;&lt;set $player.slave_traits.obedience = 20&gt;&gt;
        /* Prevent change from showing */
        &lt;&lt;set $_player.slave_traits.obedience = 20&gt;&gt;

        /* Roll to see whether or not dex / strength is reduced */
        &lt;&lt;set _probability = setup.sigmoid($difficulty)&gt;&gt;
        &lt;&lt;set _roll = Math.random()&gt;&gt;
        &lt;&lt;if _roll lt _probability&gt;&gt;
            &lt;&lt;set _player_extra_changes += &quot;Dexterity &quot; + setup.show_change_html(0, -1) + &quot;, &quot;&gt;&gt;
            &lt;&lt;set $player.stats.dexterity -= 1&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _roll = Math.random()&gt;&gt;
        &lt;&lt;if _roll lt _probability&gt;&gt;
            &lt;&lt;set _player_extra_changes += &quot;Strength &quot; + setup.show_change_html(0, -1) + &quot;, &quot;&gt;&gt;
            &lt;&lt;set $player.stats.strength -= 1&gt;&gt;
        &lt;&lt;/if&gt;&gt;

        /* Roll to see how much health is lost */
        &lt;&lt;set _roll = 10 * dice(1, $difficulty + 6) - $player.stats.strength&gt;&gt;
        &lt;&lt;set _player_extra_changes += &quot;Health &quot; + setup.show_change_html(0, -1 * _roll) + &quot;, &quot;&gt;&gt;
        &lt;&lt;set $player.conditions.health -= _roll&gt;&gt;

        &lt;&lt;set _player_extra_changes += &quot;Trust &quot; + setup.show_change_html(0, -10) + &quot;).&quot;&gt;&gt;

        &lt;&lt;unset _probability&gt;&gt;
        &lt;&lt;unset _roll&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* If obedience &gt; 90, build trust */
    &lt;&lt;if $player.slave_traits.obedience gt 90&gt;&gt;
        &lt;&lt;if $player.get_status(&quot;nipon&quot;) == &quot;low_slave&quot;&gt;&gt;
            &lt;&lt;set _to_add = 15&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _to_add = 5&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _player_extra_changes += &quot;\
            Shintani has taken notice to your good behavior lately, building his trust in you \
            (Trust &quot; + setup.show_change_html(0, _to_add) + &quot;).&quot;&gt;&gt;
        &lt;&lt;set $player.slave_traits.trust += _to_add&gt;&gt;
        &lt;&lt;unset _to_add&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* If trust reaches 100, raise status */
    &lt;&lt;if $player.slave_traits.trust gte 100&gt;&gt;
        &lt;&lt;if $player.get_status(&quot;shintaniHome&quot;) == &quot;low_slave&quot;&gt;&gt;
            &lt;&lt;set $location_status[&quot;nipon&quot;] = &quot;slave&quot;&gt;&gt;
            &lt;&lt;updatestatus&gt;&gt;
            &lt;&lt;set _player_extra_changes += &quot;\
                You\&#39;re high trust with Shintani has caused your status to rise within Nipon.\
            &quot;&gt;&gt;
            &lt;&lt;set $player.slave_traits.trust = 5&gt;&gt;
            /* Prevent change from showing */
            &lt;&lt;set $_player.slave_traits.trust = 5&gt;&gt;
            /* Modify Shintani&#39;s view of the player */
            &lt;&lt;set $characters.shintani_hiroyuki.slave_traits.obedience = 50&gt;&gt;
            &lt;&lt;set $characters.shintani_hiroyuki.slave_traits.trust = 25&gt;&gt;
        &lt;&lt;elseif $player.get_status(&quot;shintaniHome&quot;) == &quot;slave&quot;&gt;&gt;
            &lt;&lt;set $location_status[&quot;nipon&quot;] = &quot;high_slave&quot;&gt;&gt;
            &lt;&lt;updatestatus&gt;&gt;
            &lt;&lt;set _player_extra_changes += &quot;\
                You\&#39;re high trust with Shintani has caused your status to rise within Nipon.\
            &quot;&gt;&gt;
            &lt;&lt;set $player.slave_traits.trust = 5&gt;&gt;
            /* Prevent change from showing */
            &lt;&lt;set $_player.slave_traits.trust = 5&gt;&gt;
            /* Modify Shintani&#39;s view of the player */
            &lt;&lt;set $characters.shintani_hiroyuki.slave_traits.obedience = 60&gt;&gt;
            &lt;&lt;set $characters.shintani_hiroyuki.slave_traits.trust = 50&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Update quest journal */
&lt;&lt;updatequests&gt;&gt;

/* Simulate slaves */
&lt;&lt;include slaveEngine&gt;&gt;

/* Remove money from player */
&lt;&lt;if _afford&gt;&gt;
    &lt;&lt;if _total_profit gt 0&gt;&gt;
        &lt;&lt;addmoney `setup.round2(_total_profit)`&gt;&gt;
    &lt;&lt;elseif _total_profit lt 0&gt;&gt;
        &lt;&lt;removemoney `Math.abs(setup.round2(_total_profit))`&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;paper_border&quot; style=&quot;position: relative&quot;&gt;
    &lt;center&gt;&lt;h1&gt;Another Day Passes in Nipon&lt;/h1&gt;&lt;/center&gt;
    &lt;div style=&quot;overflow-y: auto; height: 450px; padding: 10px&quot;&gt;
    &lt;p id=&quot;sleep_summary&quot; class=&quot;textpassage&quot; style=&quot;display: none&quot;&gt;
        &lt;&lt;message &quot;Player Summary&quot;&gt;&gt;
            You slept for &lt;&lt;= parseInt($_to_advance / 60)&gt;&gt; hours and &lt;&lt;= parseInt($_to_advance % 60)&gt;&gt; 
            minutes until the break of dawn when all slaves in the Hiroyuki household are told to wake 
            up; 7:00 AM.
            &lt;&lt;if !$_obedient_sleep &amp;&amp; $player.is_slave&gt;&gt;
                Since you went to bed despite not being very tired, Shintani took it as you 
                lazying off (&lt;span style=&quot;color: red&quot;&gt;-Obedience&lt;/span&gt;).
            &lt;&lt;/if&gt;&gt;
            &lt;br&gt;
            &#39;&#39;Sleep total stat changes:&#39;&#39;
            &lt;ul&gt;

            /* Add in stat changes */
            &lt;&lt;for _key, _val range $_player.stats&gt;&gt;
                &lt;&lt;if _val != $player.stats[_key]&gt;&gt;
                    &lt;li&gt; &lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;&lt;= setup.show_change_html(_val, $player.stats[_key], true)&gt;&gt;&lt;/li&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/for&gt;&gt;

            /* Add in condition changes */
            &lt;&lt;for _key, _val range $_player.conditions&gt;&gt;
                &lt;&lt;if _val != $player.conditions[_key]&gt;&gt;
                    &lt;li&gt; &lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;&lt;= setup.show_change_html(_val, $player.conditions[_key], true)&gt;&gt;&lt;/li&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/for&gt;&gt;

            /* Add in slave trait changes */
            &lt;&lt;for _key, _val range $_player.slave_traits&gt;&gt;
                &lt;&lt;if _val != $player.slave_traits[_key]&gt;&gt;
                    &lt;li&gt; &lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;&lt;= setup.show_change_html(_val, $player.slave_traits[_key], true)&gt;&gt;&lt;/li&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/for&gt;&gt;

            &lt;&lt;if _afford &amp;&amp; _total_profit != 0&gt;&gt;
                &lt;li&gt;Profit: &lt;&lt;= setup.show_money_change_html(0, _total_profit)&gt;&gt;&lt;/li&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;/ul&gt;
        &lt;&lt;/message&gt;&gt;&lt;br&gt;
        &lt;&lt;message &quot;Slave Summary&quot;&gt;&gt;
            &lt;&lt;if $to_simulate_day.size == 0&gt;&gt;
                You do not have any slaves on assignment right now.
            &lt;&lt;else&gt;&gt;
                &lt;&lt;if _afford&gt;&gt;
                    &lt;&lt;for _key, _val range _slave_changes&gt;&gt;
                        &lt;&lt;set _char = $characters[_key]&gt;&gt;
                        &lt;&lt;capture _char, _key, _val&gt;&gt;
                            &lt;&lt;message _char.name()&gt;&gt;
                                &lt;&lt;= _val.flavor_text&gt;&gt;&lt;br&gt;
                                &#39;&#39;&lt;&lt;= setup.titleCase(_char.first_name)&gt;&gt; Changes&#39;&#39;
                                &lt;ul&gt;
                                &lt;&lt;for _sub_key, _sub_val range _slave_changes[_key].self&gt;&gt;
                                    &lt;&lt;for _sub_sub_key, _sub_sub_val range _sub_val&gt;&gt;
                                        &lt;&lt;if _sub_sub_val == 0&gt;&gt;
                                            &lt;&lt;continue&gt;&gt;
                                        &lt;&lt;/if&gt;&gt;
                                        &lt;&lt;if _sub_key == &quot;sex_fetishes&quot;&gt;&gt;
                                            &lt;&lt;set _tit = setup.titleCase(_sub_sub_key) + &quot; Fetish&quot;&gt;&gt;
                                        &lt;&lt;elseif _sub_key == &quot;sex_skills&quot;&gt;&gt;
                                            &lt;&lt;set _tit = setup.titleCase(_sub_sub_key) + &quot; Skill&quot;&gt;&gt;
                                        &lt;&lt;elseif _sub_key == &quot;sex_prefs&quot;&gt;&gt;
                                            &lt;&lt;set _tit = setup.titleCase(_sub_sub_key) + &quot; Preference&quot;&gt;&gt;
                                        &lt;&lt;elseif _sub_key == &quot;slave_traits&quot; &amp;&amp; _sub_sub_key == &quot;obedience&quot;&gt;&gt;
                                            &lt;&lt;set _tit = &quot;Affection&quot;&gt;&gt;
                                        &lt;&lt;else&gt;&gt;
                                            &lt;&lt;set _tit = setup.titleCase(_sub_sub_key)&gt;&gt;
                                        &lt;&lt;/if&gt;&gt;
                                        &lt;li&gt;_tit: 
                                            &lt;&lt;if _sub_sub_key in setup.POSITIVES.character&gt;&gt;
                                                &lt;&lt;= setup.show_change_html(0, _sub_sub_val, setup.POSITIVES.character[_sub_sub_key])&gt;&gt;
                                            &lt;&lt;else&gt;&gt;
                                                &lt;&lt;= setup.show_change(0, _sub_sub_val)&gt;&gt;
                                            &lt;&lt;/if&gt;&gt;
                                        &lt;/li&gt;
                                    &lt;&lt;/for&gt;&gt;
                                &lt;&lt;/for&gt;&gt;
                                &lt;&lt;for _idx, _sub_val range _slave_changes[_key].special&gt;&gt;
                                    &lt;li&gt;&lt;&lt;= _sub_val&gt;&gt;&lt;/li&gt;
                                &lt;&lt;/for&gt;&gt;
                                &lt;li&gt;Profit: &lt;&lt;= setup.show_money_change_html(0, -1 * _slave_changes[_key].cost)&gt;&gt;&lt;/li&gt;
                                &lt;/ul&gt;
                            &lt;&lt;/message&gt;&gt;&lt;br&gt;
                        &lt;&lt;/capture&gt;&gt;
                    &lt;&lt;/for&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    Your assigned slaves cost you 
                    &lt;span class=&quot;fail&quot;&gt;&lt;&lt;= setup.LARI&gt;&gt;&lt;&lt;= Math.abs(_total_profit)&gt;&gt;&lt;/span&gt;
                    which is more than you have. Thus they ignored all their assignments for 
                    the day and returned to their default roles.
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/message&gt;&gt;&lt;br&gt;
        &lt;&lt;message &quot;World Summary&quot;&gt;&gt;
            You do not have any way to gather intelligence about the world right now.
        &lt;&lt;/message&gt;&gt;
    &lt;/p&gt;
    &lt;/div&gt;
    &lt;div id=&quot;cont_button&quot; style=&quot;position: absolute; bottom: 100px; left: calc(50% - 82px); display: none&quot;&gt;
        &lt;&lt;button &quot;Continue&quot; shintaniHome&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;script&gt;&gt;
    setTimeout(() =&gt; {
        var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
        div.html(State.temporary.player_extra_changes);
        $(&quot;#sleep_summary&quot;).prepend(div);
        $(&quot;#sleep_summary&quot;).fadeIn();
        $(&quot;#cont_button&quot;).fadeIn();
    }, 500);
&lt;&lt;/script&gt;&gt;

/* Reset awake counter */
&lt;&lt;set $time_awake = 0&gt;&gt;

/* Reset work status */
&lt;&lt;set $player.hours_worked = 0&gt;&gt;

&lt;&lt;include round&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="109" name="shintaniHomeWorkActions" tags="" position="1100,1350" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;work_actions&quot; class=&quot;action container row col hidden&quot; 
        style=&quot;--rows: 4; --cols: 5&quot;&gt;

    /* How long we want to work for */
    &lt;div style=&quot;grid-row: 1; grid-column: 1&quot;&gt;
        @@#work1Hr;&lt;&lt;button &quot;1 Hour&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;addclass &quot;#workStartButton button&quot; &quot;disabled&quot;&gt;&gt;

            /* Enable other options */
            &lt;&lt;run $(&quot;#work4Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work4Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#work8Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work8Hr button&quot; &quot;disabled&quot;&gt;&gt;

            &lt;&lt;set _to_advance_hr = 1&gt;&gt;
            /* Enable start */
            &lt;&lt;if $player.conditions.stamina gt (_to_advance_hr * -180 * ((3/10 * $player.stats.strength - $time_awake / 7) - _to_advance_hr * 30 / 7) / 1440)&gt;&gt;
                &lt;&lt;run $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;removeclass &quot;#workStartButton button&quot; &quot;disabled&quot;&gt;&gt;
                /* Disable self */
                &lt;&lt;run $(&quot;#work1Hr button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#work1Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _to_notify = (&quot;You are too tired to work &quot; + _to_advance_hr + &quot; hour.&quot;)&gt;&gt;
                &lt;&lt;notify&gt;&gt;&lt;&lt;= _to_notify&gt;&gt;&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 1; grid-column: 2&quot;&gt;
        @@#work4Hr;&lt;&lt;button &quot;4 Hours&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;addclass &quot;#workStartButton button&quot; &quot;disabled&quot;&gt;&gt;

            /* Enable other options */
            &lt;&lt;run $(&quot;#work1Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work1Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#work8Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work8Hr button&quot; &quot;disabled&quot;&gt;&gt;

            &lt;&lt;set _to_advance_hr = 4&gt;&gt;
            /* Enable start */
            &lt;&lt;if $player.conditions.stamina gt (_to_advance_hr * -180 * ((3/10 * $player.stats.strength - $time_awake / 7) - _to_advance_hr * 30 / 7) / 1440)&gt;&gt;
                &lt;&lt;run $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;removeclass &quot;#workStartButton button&quot; &quot;disabled&quot;&gt;&gt;
                /* Disable self */
                &lt;&lt;run $(&quot;#work4Hr button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#work4Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _to_notify = (&quot;You are too tired to work &quot; + _to_advance_hr + &quot; hours.&quot;)&gt;&gt;
                &lt;&lt;notify&gt;&gt;&lt;&lt;= _to_notify&gt;&gt;&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 1; grid-column: 3&quot;&gt;
        @@#work8Hr;&lt;&lt;button &quot;8 Hours&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;addclass &quot;#workStartButton button&quot; &quot;disabled&quot;&gt;&gt;

            /* Enable other options */
            &lt;&lt;run $(&quot;#work1Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work1Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#work4Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work4Hr button&quot; &quot;disabled&quot;&gt;&gt;

            &lt;&lt;set _to_advance_hr = 8&gt;&gt;
            /* Enable start */
            &lt;&lt;if $player.conditions.stamina gt (_to_advance_hr * -180 * ((3/10 * $player.stats.strength - $time_awake / 7) - _to_advance_hr * 30 / 7) / 1440)&gt;&gt;
                &lt;&lt;run $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                &lt;&lt;removeclass &quot;#workStartButton button&quot; &quot;disabled&quot;&gt;&gt;
                /* Disable self */
                &lt;&lt;run $(&quot;#work8Hr button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#work8Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _to_notify = (&quot;You are too tired to work &quot; + _to_advance_hr + &quot; hours.&quot;)&gt;&gt;
                &lt;&lt;notify&gt;&gt;&lt;&lt;= _to_notify&gt;&gt;&lt;&lt;/notify&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;


    &lt;div style=&quot;grid-row: 1; grid-column: 5&quot;&gt;
        &lt;&lt;disable&gt;&gt;
            @@#workStartButton;&lt;&lt;button &quot;Start&quot;&gt;&gt;
                &lt;&lt;include shintaniHomeWorkEngine&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;script&gt;&gt;
                $(&quot;#work_actions&quot;).addClass(&quot;hidden&quot;);
                $(&quot;#actions&quot;).removeClass(&quot;hidden&quot;);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponCentral&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="110" name="shintaniHomeWorkEngine" tags="" position="1225,1350" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Information about work */
&lt;&lt;set $_temp_to_log = &quot;\
    &lt;div&gt;You spent time assisting Shintani with his duties.&lt;/div&gt;\
&quot;&gt;&gt;

/* Get clone of player to display changes */
&lt;&lt;set $_player = clone($player)&gt;&gt;

/* Forward time along with dynamics */
&lt;&lt;set $player.is_slaving = true&gt;&gt;
&lt;&lt;addhours _to_advance_hr&gt;&gt;
&lt;&lt;set $player.hours_worked += _to_advance_hr&gt;&gt;
&lt;&lt;include round&gt;&gt;
&lt;&lt;set $player.is_slaving = false&gt;&gt;

/* Check if work-event occurs */
&lt;&lt;set _probability = (_to_advance_hr / 12)&gt;&gt;
&lt;&lt;set _roll = Math.random()&gt;&gt;

/* Fill event pool depending on content */
&lt;&lt;set _event_pool = [&quot;shintaniHomeEventsWorkEconomicEvents&quot;]&gt;&gt;
&lt;&lt;if $tasks gt 0&gt;&gt;
    &lt;&lt;set _event_pool.push(&quot;shintaniHomeEventsWorkDomesticEvents&quot;)&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;if $tasks gt 1&gt;&gt;
    &lt;&lt;set _event_pool.push(&quot;shintaniHomeEventsWorkSexualEvents&quot;)&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if (1 - _probability) lt _roll&gt;&gt;
    /* Disable menu */
    &lt;&lt;set $enable_menu = false&gt;&gt;

    /* Trigger work event */
    &lt;&lt;include `either(_event_pool)`&gt;&gt;
    &lt;&lt;script&gt;&gt;
        $(&quot;#work_actions&quot;).addClass(&quot;hidden&quot;);
        $(&quot;#events_actions&quot;).removeClass(&quot;hidden&quot;);
    &lt;&lt;/script&gt;&gt;

    &lt;&lt;unset _probability&gt;&gt;
    &lt;&lt;unset _roll&gt;&gt;
    &lt;&lt;unset _event_pool&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;include shintaniHomeWorkEngineAfter&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="111" name="shintaniHomeWorkEngineAfter" tags="" position="100,1475" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;include round&gt;&gt;

/* Check if there were any changes at all */
&lt;&lt;set _changes = false&gt;&gt;
&lt;&lt;for _key, _val range $_player.conditions&gt;&gt;
    &lt;&lt;if _val != $player.conditions[_key]&gt;&gt;
        &lt;&lt;set _changes = true&gt;&gt;
        &lt;&lt;break&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;
&lt;&lt;for _key, _val range $_player.slave_traits&gt;&gt;
    &lt;&lt;if _val != $player.slave_traits[_key]&gt;&gt;
        &lt;&lt;set _changes = true&gt;&gt;
        &lt;&lt;break&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;if _changes&gt;&gt;
    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&lt;b&gt;Work total stat changes:&lt;/b&gt;&quot;&gt;&gt;
    &lt;&lt;set $_temp_to_log += &quot;&lt;ul&gt;&quot;&gt;&gt;

    /* Add in condition changes */
    &lt;&lt;for _key, _val range $_player.conditions&gt;&gt;
        &lt;&lt;if _val != $player.conditions[_key]&gt;&gt;
            &lt;&lt;set $_temp_to_log += (&quot;&lt;li&gt;&quot; + setup.titleCase(_key) + &quot;: &quot; +
                setup.show_change_html(_val, $player.conditions[_key], true) +  &quot;&lt;/li&gt;&quot;)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    /* Add in slave trait changes */
    &lt;&lt;for _key, _val range $_player.slave_traits&gt;&gt;
        &lt;&lt;if _val != $player.slave_traits[_key]&gt;&gt;
            &lt;&lt;set $_temp_to_log += (&quot;&lt;li&gt;&quot; + setup.titleCase(_key) + &quot;: &quot; +
                setup.show_change_html(_val, $player.slave_traits[_key], true) +  &quot;&lt;/li&gt;&quot;)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    &lt;&lt;set $_temp_to_log += &quot;&lt;/ul&gt;&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Unset variables */
&lt;&lt;unset _changes&gt;&gt;
&lt;&lt;unset _to_advance_hr&gt;&gt;
&lt;&lt;unset $_player&gt;&gt;

/* Re-enable menu */
&lt;&lt;set $enable_menu = true&gt;&gt;

&lt;&lt;script&gt;&gt;Engine.play(&quot;shintaniHome&quot;);&lt;&lt;/script&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="112" name="niponMarket" tags="paper" position="225,1475" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;if setup.is_day($gameDate)&gt;&gt;
    &lt;&lt;set $_to_log += &quot;
        &lt;div&gt;The market district&#39;s bustling cacophony of civilization rings in your ears.&lt;/div&gt;&lt;br&gt;\
    &quot;&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;set $_to_log += &quot;
        &lt;div&gt;The market district rests quietly with the rest of the people.&lt;/div&gt;&lt;br&gt;\
    &quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Player is outside */
&lt;&lt;set $player.is_home = false&gt;&gt;
&lt;&lt;set $player.is_outside = true&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;

/* Audio engine */
 

&lt;div class=&quot;mapside left&quot;&gt;
    &lt;&lt;include niponActions&gt;&gt;
&lt;/div&gt;

&lt;div id=&quot;background&quot; class=&quot;notext&quot; style=&quot;padding: 0px&quot;&gt;
    &lt;img src=&quot;resources/maps/niponMarketMap.jpeg&quot; usemap=&quot;#image-map&quot;&gt;
    &lt;map name=&quot;image-map&quot;&gt;
        &lt;area alt=&quot;niponMarketDocks&quot; coords=&quot;90,112,116,127,128,104,184,128,181,137,218,151,225,132,279,144,289,127,368,28,75,27&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponTradeUnion&quot; coords=&quot;806,473,995,590&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;niponFarms&quot; coords=&quot;592,628,699,631,729,695,645,752,557,749,501,749,363,749,367,650,437,610&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponStalls&quot; coords=&quot;173,200,230,174,296,204,314,246,374,261,416,294,420,364,415,403,363,469,260,410,162,340,136,278,143,228&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponBlacksmith&quot; coords=&quot;440,334,442,413,487,444,546,460,608,449,646,434,646,406,611,335,556,290&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponTheater&quot; coords=&quot;394,233,453,278,519,277,520,198,472,163,403,154,377,172,362,195&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponMines&quot; coords=&quot;679,283,678,321,666,337,689,356,705,377,708,406,739,429,807,450,845,459,893,458,905,451,951,445,951,431,988,421,1009,411,1007,366,972,333,971,287,941,231,870,224,766,243,730,263&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponAuctionHouse&quot; coords=&quot;71,394,158,365,230,409,230,445,165,483,65,459&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponCentral&quot; coords=&quot;27,25,68,212&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;niponSlums&quot; coords=&quot;30,229,64,401&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;east&quot; coords=&quot;1368,400,1217,525,1135,650,1040,739,956,802,1371,802&quot; shape=&quot;poly&quot;&gt;
    &lt;/map&gt;
&lt;/div&gt;

&lt;div class=&quot;mapside right&quot;&gt;
    &lt;hr&gt;
    &lt;&lt;include infoNoSubbackground&gt;&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

/* Remove quick bar and setup map */
&lt;&lt;script&gt;&gt;
    setTimeout(() =&gt; {
        $(&quot;#quickbar&quot;).addClass(&quot;hidden&quot;);
        var areas = $(&quot;map&quot;).children(&quot;area&quot;);
        for (var _i = 0; _i &lt; areas.length; _i++) {
            var obj = $(areas[_i]);
            if (!(setup.locations.has(obj.attr(&quot;alt&quot;)))) {
                continue;
            }
            var loc = setup.locations.get(obj.attr(&quot;alt&quot;));
            if (!State.variables.has_access.has(loc.key)) {
                obj.addClass(&quot;noaccess&quot;);
                obj.attr(&quot;onclick&quot;, &quot;$.wiki(&#39;&lt;&lt;notify&gt;&gt;No Access!&lt;&lt;/notify&gt;&gt;&#39;)&quot;);
                obj.attr(&quot;title&quot;, &quot;No access.&quot;);
            } else if (!loc.has_access()) {
                obj.addClass(&quot;closed&quot;);
                obj.attr(&quot;onclick&quot;, &quot;$.wiki(&#39;&lt;&lt;notify&gt;&gt;Closed!&lt;&lt;/notify&gt;&gt;&#39;)&quot;);
                var opening_time = loc.access_times[0];
                var opening_time_str = &quot;&quot;;
                if (opening_time == 0) {
                    opening_time_str = &quot;12 AM.&quot;;
                } else if (opening_time &lt; 12) {
                    opening_time_str = opening_time.toString() + &quot; AM.&quot;;
                } else if (opening_time == 12) {
                    opening_time_str = &quot;12 PM.&quot;;
                } else {
                    opening_time_str = (opening_time - 12).toString() + &quot; PM.&quot;;
                }
                obj.attr(&quot;title&quot;, &quot;Opens at &quot; + opening_time_str);
            } else {
                obj.addClass(&quot;access&quot;);
                var onclick = &quot;SugarCube.setup.locations.get(&#39;&quot; + obj.attr(&quot;alt&quot;) + &quot;&#39;).goto(&quot;;
                if (loc.inside) {
                    onclick += &quot;&#39;wooden_door_sound&#39;&quot;;
                }
                onclick += &quot;)&quot;;
                obj.attr(&quot;onclick&quot;, onclick);
            }
        }
    }, 10);
&lt;&lt;/script&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="113" name="niponMinesActions" tags="" position="350,1475" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;actions&quot; class=&quot;action container row col longbutton fiveQuarters&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    &lt;&lt;button &quot;Work&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#info_title&quot;).html(&quot;Working at the Nipon Mines&quot;)&gt;&gt;
        &lt;&lt;set _default_info = $(&quot;&lt;div&gt;\
            &lt;div id=\&quot;normal_job\&quot;&gt;\
            It seems like there\&#39;s never enough hands on deck at the Nipon mines. You could \
            work here for a while and gain some lari if you wanted.\
            &lt;ul id=\&quot;change_list\&quot;&gt;\
                &lt;li id=\&quot;li1\&quot;&gt;&quot; + setup.LARI + &quot;10 per hour.&lt;/li&gt;\
                &lt;li id=\&quot;li2\&quot;&gt;3% per hour chance to gain strength (capped at 30).&lt;/li&gt;\
                &lt;li id=\&quot;li3\&quot;&gt;1% per hour chance of injury.&lt;/li&gt;\
            &lt;/ul&gt;&lt;/div&gt;\
            &lt;div id=\&quot;explore_job\&quot;&gt;\
            You also see some smaller crevasses that seem completely unexplored. If you wanted \
            you could pick up a pickaxe lying about and go exploring for ore to keep for yourself.\
            &lt;ul&gt;\
                &lt;li id=\&quot;li3\&quot;&gt;3% per hour chance to obtain iron.&lt;/li&gt;\
                &lt;li id=\&quot;li4\&quot;&gt;1% per hour chance to obtain silver.&lt;/li&gt;\
                &lt;li id=\&quot;li6\&quot;&gt;Additional 3% per hour chance of injury.&lt;/li&gt;\
            &lt;/ul&gt;&lt;/div&gt;\
        &lt;/div&gt;&quot;)&gt;&gt;
        &lt;&lt;run $(&quot;#infoLogBody&quot;).html(&quot;&quot;)&gt;&gt;
        &lt;&lt;run $(&quot;#infoLogBody&quot;).append(_default_info.clone())&gt;&gt;
        &lt;&lt;removeclass &quot;#work_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;removeclass &quot;#infoLog&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#mainLog&quot; &quot;hidden&quot;&gt;&gt;
        /* Reset all button states */
        &lt;&lt;run $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
        &lt;&lt;addclass &quot;#workStartButton button&quot; &quot;disabled&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#explore button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
        &lt;&lt;addclass &quot;#explore button&quot; &quot;disabled&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#work1Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
        &lt;&lt;removeclass &quot;#work1Hr button&quot; &quot;disabled&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#work4Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
        &lt;&lt;removeclass &quot;#work4Hr button&quot; &quot;disabled&quot;&gt;&gt;
        &lt;&lt;run $(&quot;#work8Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
        &lt;&lt;removeclass &quot;#work8Hr button&quot; &quot;disabled&quot;&gt;&gt;
        &lt;&lt;set _explore = false&gt;&gt;
    &lt;&lt;/button&gt;&gt;

    &lt;&lt;disable&gt;&gt;
        &lt;&lt;button &quot;Assignment&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;/disable&gt;&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponMarket&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="114" name="niponMines" tags="black" position="475,1475" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;if $quests.the_nipon_economy.stage == 0&gt;&gt;
    /* Add tutorial */
    &lt;&lt;if tale.has(passage() + &quot;Tutorial&quot;)&gt;&gt;
        &lt;&lt;set $tutorials[passage()] = passage() + &quot;Tutorial&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* Forward Nipon Economy quest */
    &lt;&lt;if !$quest_journal.completed.contains(&quot;the_nipon_economy&quot;) &amp;&amp; $quests.the_nipon_economy.added &amp;&amp; $quests.the_nipon_economy.stage lt 1&gt;&gt;
        &lt;&lt;set $quests.the_nipon_economy.stage = 1&gt;&gt;
    &lt;&lt;/if&gt;&gt;
     
&lt;&lt;/if&gt;&gt;
&lt;&lt;set $_to_log = &quot;
    &lt;div&gt;You find yourself at the northern Nipon river delta where there is a distict smell \
    of smoke. Within the valley there are dozens of operating mines filled with workers with \
    hollow eyes.&lt;/div&gt;&lt;br&gt;\
&quot;&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;

/* Audio engine */
 

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;div class=&quot;main container fourCol threeRow&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div class=&quot;subbackground mainLogContainer&quot;&gt;
            &lt;&lt;include mainLog&gt;&gt;
            &lt;&lt;include infoLog&gt;&gt;
        &lt;/div&gt;
        &lt;&lt;include info&gt;&gt;

        &lt;div id=&quot;action_bar&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 3 / span 1; grid-column: 1 / span 3&quot;&gt;
            &lt;&lt;include niponMinesActions&gt;&gt;
            &lt;&lt;include niponMinesWorkActions&gt;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="115" name="niponMinesWorkActions" tags="" position="600,1475" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;work_actions&quot; class=&quot;action container row col fiveQuarters smalltext longbutton hidden&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    &lt;&lt;script&gt;&gt;
        State.temporary.button_func = (adv) =&gt; {
            var v = State.variables;
            var _t = State.temporary;
            var player = v.player;
            if (_t.explore) {
                $(&quot;#infoLogBody&quot;).html(&quot;&quot;);
                $(&quot;#infoLogBody&quot;).append(_t.default_info.clone());
            }
            _t.explore = false;
            _t.to_advance_hr = adv;
            $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, true);
            $(&quot;#workStartButton button&quot;).addClass(&quot;disabled&quot;);
            $(&quot;#explore button&quot;).prop(&quot;disabled&quot;, true);
            $(&quot;#explore button&quot;).addClass(&quot;disabled&quot;);
            if (player.conditions.stamina &gt; (adv * -180 * ((3/10 * player.stats.strength - v.time_awake / 7) - adv * 60 / 14) / 1440)) {
                $(&quot;#explore button&quot;).prop(&quot;disabled&quot;, false);
                $(&quot;#explore button&quot;).removeClass(&quot;disabled&quot;);
                $(&quot;#workStartButton button&quot;).prop(&quot;disabled&quot;, false);
                $(&quot;#workStartButton button&quot;).removeClass(&quot;disabled&quot;);
                $(&quot;#work&quot; + adv + &quot;Hr button&quot;).prop(&quot;disabled&quot;, true);
                $(&quot;#work&quot; + adv + &quot;Hr button&quot;).addClass(&quot;disabled&quot;);
                $(&quot;#explore_job&quot;).addClass(&quot;hidden&quot;);
                $(&quot;#li1&quot;).html(setup.LARI + (10 * adv).toString());
                var _strength_perc = 3;
                if (player.stats.strength &gt;= 30) {
                    _strength_perc = 0;
                }
                $(&quot;#li2&quot;).html((_strength_perc * adv).toString() + &quot;% chance to gain strength.&quot;);
                $(&quot;#li3&quot;).html((1 * adv).toString() + &quot;% chance of injury.&quot;);
            } else {
                $(&quot;#infoLogBody&quot;).html(&quot;&quot;);
                $(&quot;#infoLogBody&quot;).append(_t.default_info.clone());
                var _to_notify = &quot;You are too tired to work &quot; + adv;
                if (adv == 1) {
                    _to_notify += &quot; hour.&quot;;
                } else {
                    _to_notify += &quot; hours.&quot;;
                }
                $.wiki(&quot;&lt;&lt;notify&gt;&gt;&quot; + _to_notify + &quot;&lt;&lt;/notify&gt;&gt;&quot;);
            }
        }
    &lt;&lt;/script&gt;&gt;

    /* How long we want to work for */
    &lt;div style=&quot;grid-row: 1; grid-column: 1&quot;&gt;
        @@#work1Hr;&lt;&lt;button &quot;1 Hour&quot;&gt;&gt;
            /* Enable other options */
            &lt;&lt;run $(&quot;#work4Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work4Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#work8Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work8Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run _button_func(1)&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 1; grid-column: 2&quot;&gt;
        @@#work4Hr;&lt;&lt;button &quot;4 Hours&quot;&gt;&gt;
            /* Enable other options */
            &lt;&lt;run $(&quot;#work1Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work1Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#work8Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work8Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run _button_func(4)&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 1; grid-column: 3&quot;&gt;
        @@#work8Hr;&lt;&lt;button &quot;8 Hours&quot;&gt;&gt;
            /* Enable other options */
            &lt;&lt;run $(&quot;#work1Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work1Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run $(&quot;#work4Hr button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass &quot;#work4Hr button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;run _button_func(8)&gt;&gt;
        &lt;&lt;/button&gt;&gt;@@
    &lt;/div&gt;

    &lt;div&gt;
        &lt;&lt;disable&gt;&gt;
            @@#explore;&lt;&lt;button &quot;Explore&quot;&gt;&gt;
                &lt;&lt;run $(&quot;#explore button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#explore button&quot; &quot;disabled&quot;&gt;&gt;
                &lt;&lt;set _explore = true&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    var adv = State.temporary.to_advance_hr;
                    $(&quot;#li3&quot;).html((4 * adv).toString() + &quot;% chance of injury&quot;);
                    $(&quot;#change_list&quot;).append($(&quot;&lt;li&gt;&quot; + (3 * adv).toString() + 
                        &quot;% chance to obtain iron.&lt;/li&gt;&quot;));
                    $(&quot;#change_list&quot;).append($(&quot;&lt;li&gt;&quot; + (1 * adv).toString() + 
                        &quot;% chance to obtain silver.&lt;/li&gt;&quot;));
                &lt;&lt;/script&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
    &lt;/div&gt;


    &lt;div style=&quot;grid-row: 1; grid-column: 4&quot;&gt;
        &lt;&lt;disable&gt;&gt;
            @@#workStartButton;&lt;&lt;button &quot;Start&quot;&gt;&gt;
                &lt;&lt;include niponMinesWorkEngine&gt;&gt;
            &lt;&lt;/button&gt;&gt;@@
        &lt;&lt;/disable&gt;&gt;
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 3; grid-column: 4&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#work_actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#mainLog&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#infoLog&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponMarket&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="116" name="niponMinesWorkEngine" tags="" position="725,1475" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Information about work */
&lt;&lt;set $_temp_to_log = &quot;\
    &lt;div&gt;You spent time working at the Nipon mines.&lt;/div&gt;\
&quot;&gt;&gt;

/* Get clone of player to display changes */
&lt;&lt;set _player = clone($player)&gt;&gt;

/* Forward time along with dynamics */
&lt;&lt;set $player.is_working = true&gt;&gt;
&lt;&lt;addhours _to_advance_hr&gt;&gt;
&lt;&lt;set $player.is_working = false&gt;&gt;

/* Calculate pay */
&lt;&lt;set _pay = 10 * _to_advance_hr&gt;&gt;
&lt;&lt;addmoney _pay&gt;&gt;
&lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
&lt;&lt;include round&gt;&gt;

/* Simulate strength roll */
&lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
&lt;&lt;set _thresh = _to_advance_hr * 3 / 100&gt;&gt;
&lt;&lt;if $player.stats.strength gte 30&gt;&gt;
    &lt;&lt;set _thresh = 0&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;if _roll lt _thresh&gt;&gt;
    &lt;&lt;set $player.stats.strength += 1&gt;&gt;
    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You worked yourself the perfect amount to build your frame (Strength &quot; + 
        setup.show_change_html(0, 1) + &quot;)&lt;/div&gt;&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Simulate injury roll */
&lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
&lt;&lt;set _thresh = _to_advance_hr * 2 / 100&gt;&gt;
&lt;&lt;if _explore&gt;&gt;
    &lt;&lt;set _thresh += _to_advance_hr * 3&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;if _roll lt _thresh&gt;&gt;
    &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
    &lt;&lt;set _to_injure = 1&gt;&gt;
    &lt;&lt;if _roll gte .5&gt;&gt;
        &lt;&lt;set _to_injure += 1&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;set $_temp_to_log += &quot;&lt;div&gt;You over-worked yourself, tripping over some rocks and twisting your ankle (Dexterity &quot; + 
        setup.show_change_html(_to_injure, 0) + &quot;)&lt;/div&gt;&quot;&gt;&gt;
    &lt;&lt;set $player.stats.dexterity -= _to_injure&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Check if there were any changes at all */
&lt;&lt;set _changes = false&gt;&gt;
&lt;&lt;for _key, _val range _player.conditions&gt;&gt;
    &lt;&lt;if _val != $player.conditions[_key]&gt;&gt;
        &lt;&lt;set _changes = true&gt;&gt;
        &lt;&lt;break&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;
&lt;&lt;for _key, _val range _player.slave_traits&gt;&gt;
    &lt;&lt;if _val != $player.slave_traits[_key]&gt;&gt;
        &lt;&lt;set _changes = true&gt;&gt;
        &lt;&lt;break&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;
&lt;&lt;for _key, _val range _player.stats&gt;&gt;
    &lt;&lt;if _val != $player.stats[_key]&gt;&gt;
        &lt;&lt;set _changes = true&gt;&gt;
        &lt;&lt;break&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;if _changes&gt;&gt;
    &lt;&lt;set $_temp_to_log += &quot;&lt;br&gt;&lt;b&gt;Work total stat changes:&lt;/b&gt;&quot;&gt;&gt;
    &lt;&lt;set $_temp_to_log += &quot;&lt;ul&gt;&quot;&gt;&gt;

    /* Add in stats changes */
    &lt;&lt;for _key, _val range _player.stats&gt;&gt;
        &lt;&lt;if _val != $player.stats[_key]&gt;&gt;
            &lt;&lt;set $_temp_to_log += (&quot;&lt;li&gt;&quot; + setup.titleCase(_key) + &quot;: &quot; +
                setup.show_change_html(_val, $player.stats[_key], true) +  &quot;&lt;/li&gt;&quot;)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    /* Add in condition changes */
    &lt;&lt;for _key, _val range _player.conditions&gt;&gt;
        &lt;&lt;if _val != $player.conditions[_key]&gt;&gt;
            &lt;&lt;set $_temp_to_log += (&quot;&lt;li&gt;&quot; + setup.titleCase(_key) + &quot;: &quot; +
                setup.show_change_html(_val, $player.conditions[_key], true) +  &quot;&lt;/li&gt;&quot;)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    /* Add in slave trait changes */
    &lt;&lt;for _key, _val range _player.slave_traits&gt;&gt;
        &lt;&lt;if _val != $player.slave_traits[_key]&gt;&gt;
            &lt;&lt;set $_temp_to_log += (&quot;&lt;li&gt;&quot; + setup.titleCase(_key) + &quot;: &quot; +
                setup.show_change_html(_val, $player.slave_traits[_key], true) +  &quot;&lt;/li&gt;&quot;)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    &lt;&lt;set $_temp_to_log += &quot;&lt;li&gt;Lari: &lt;span style=\&quot;color: green\&quot;&gt;&quot; + setup.LARI + _pay + &quot;&lt;/span&gt;&lt;/li&gt;&quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Simulate exploration */
&lt;&lt;if _explore&gt;&gt;
    /* Roll for iron */
    &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
    &lt;&lt;set _thresh = 3 * _to_advance_hr / 100&gt;&gt;
    &lt;&lt;if _roll lt _thresh&gt;&gt;
        &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;iron&quot;, 1)&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;&lt;li&gt;&lt;span style=\&quot;color: green\&quot;&gt;&quot; + 
            setup.show_change_html(0, 1) + &quot; Iron Ignot: &lt;/span&gt;&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* Roll for silver */
    &lt;&lt;set _roll = randomFloat(1.0)&gt;&gt;
    &lt;&lt;set _thresh = 1 * _to_advance_hr / 100&gt;&gt;
    &lt;&lt;if _roll lt _thresh&gt;&gt;
        &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;silver&quot;, 1)&gt;&gt;
        &lt;&lt;set $_temp_to_log += &quot;&lt;li&gt;&lt;span style=\&quot;color: green\&quot;&gt;&quot; + 
            setup.show_change_html(0, 1) + &quot; Silver Ignot: &lt;/span&gt;&lt;/li&gt;&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Close off changes */
&lt;&lt;set $_temp_to_log += &quot;&lt;/ul&gt;&quot;&gt;&gt;

/* Unset variables */
&lt;&lt;unset _changes&gt;&gt;
&lt;&lt;unset _to_advance_hr&gt;&gt;
&lt;&lt;unset $_player&gt;&gt;

/* Re-enable menu */
&lt;&lt;set $enable_menu = true&gt;&gt;

&lt;&lt;goto &quot;niponMines&quot;&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="117" name="niponStallsActions" tags="" position="850,1475" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;actions&quot; class=&quot;action container row col longbutton fiveQuarters&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    &lt;&lt;button &quot;Shop&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;

    &lt;&lt;button &quot;Trade&quot;&gt;&gt;
        &lt;&lt;script&gt;&gt;
            $(&quot;#actions&quot;).addClass(&quot;hidden&quot;);
            $(&quot;#trade_options&quot;).removeClass(&quot;hidden&quot;);
        &lt;&lt;/script&gt;&gt;
    &lt;&lt;/button&gt;&gt;



    &lt;&lt;disable&gt;&gt;
        &lt;&lt;button &quot;Work&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;/disable&gt;&gt;

    &lt;&lt;disable&gt;&gt;
        &lt;&lt;button &quot;Gamble&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
    &lt;&lt;/disable&gt;&gt;

    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponMarket&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="118" name="niponStalls" tags="black" position="975,1475" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;if $quests.the_nipon_economy.stage lte 1&gt;&gt;
    /* Add tutorial */
    &lt;&lt;if tale.has(passage() + &quot;Tutorial&quot;)&gt;&gt;
        &lt;&lt;set $tutorials[passage()] = passage() + &quot;Tutorial&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

     /* Forward Nipon Economy quest */
    &lt;&lt;if !$quest_journal.completed.contains(&quot;the_nipon_economy&quot;) &amp;&amp; $quests.the_nipon_economy.added &amp;&amp; $quests.the_nipon_economy.stage lt 2&gt;&gt;
        &lt;&lt;set $quests.the_nipon_economy.stage = 2&gt;&gt;
    &lt;&lt;/if&gt;&gt;

&lt;&lt;/if&gt;&gt;
&lt;&lt;set $_to_log = &quot;
    &lt;div&gt;You enter the bustling market stalls to find hundreds of people buying, selling and bartering \
    away. With the lari to your name, you can feel the heavy greed in the air.&lt;/div&gt;&lt;br&gt;\
&quot;&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;

/* Audio engine */
 

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;div class=&quot;main container fourCol threeRow&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div class=&quot;subbackground mainLogContainer&quot;&gt;
            &lt;&lt;include mainLog&gt;&gt;
            &lt;div id=&quot;commodityLog&quot; class=&quot;mainLog hidden&quot;&gt;
                &lt;center&gt;
                    &lt;div style=&quot;margin: 20px&quot;&gt;
                        &lt;b id=&quot;commodity_name&quot;&gt;&lt;/b&gt;&lt;br&gt;
                        &#39;&#39;Spread&#39;&#39;: &lt;span id=&quot;commodity_spread&quot;&gt;2%&lt;/span&gt;
                    &lt;/div&gt;
                &lt;/center&gt;
                &lt;div class=&quot;container threeCol&quot;&gt;

                    &lt;div class=&quot;container twoCol&quot;&gt;
                        &lt;p&gt;
                        Holding: &lt;br&gt;
                        Midprice: &lt;br&gt;
                        Sigma: &lt;br&gt;
                        Theta: &lt;br&gt;
                        EQ-price: &lt;br&gt;
                        EQ-trend: &lt;br&gt;
                        &lt;/p&gt;
                        &lt;p id=&quot;commodity_stats&quot; style=&quot;text-align: right&quot;&gt;
                        &lt;/p&gt;
                    &lt;/div&gt;

                    &lt;center class=&quot;smalltext&quot;&gt;
                        &lt;div&gt;
                            &#39;&#39;Buy Price&#39;&#39;: &lt;span id=&quot;commodity_buy_price&quot;&gt;$5&lt;/span&gt;
                        &lt;/div&gt;&lt;br&gt;
                        &lt;div class=&quot;column&quot;&gt;
                            @@#buy1;&lt;&lt;button &quot;Buy&quot;&gt;&gt;
                                &lt;&lt;removemoney $buy_price&gt;&gt;
                                &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, _selected)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                            @@#buy5;&lt;&lt;button &quot;Buy 5&quot;&gt;&gt;
                                &lt;&lt;set _to_pay = 5 * $buy_price&gt;&gt;
                                &lt;&lt;removemoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, _selected, 5)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                            @@#buyall;&lt;&lt;button &quot;Buy all&quot;&gt;&gt;
                                &lt;&lt;set _to_buy = parseInt($player.get_money() / $buy_price)&gt;&gt;
                                &lt;&lt;set _to_pay = _to_buy * $buy_price&gt;&gt;
                                &lt;&lt;removemoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, _selected, _to_buy)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_buy&gt;&gt;
                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                        &lt;/div&gt;
                    &lt;/center&gt;

                    &lt;center class=&quot;smalltext&quot;&gt;
                        &lt;div&gt;
                            &#39;&#39;Sell Price&#39;&#39;: &lt;span id=&quot;commodity_sell_price&quot;&gt;$5&lt;/span&gt;
                        &lt;/div&gt;&lt;br&gt;
                        &lt;div class=&quot;column&quot;&gt;
                            @@#sell1;&lt;&lt;button &quot;Sell&quot;&gt;&gt;
                                &lt;&lt;addmoney $sell_price&gt;&gt;
                                &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, _selected, 1)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                                &lt;&lt;addmins 10&gt;&gt;
                                /* TODO: kick player out of stalls if past closing time */
                            &lt;&lt;/button&gt;&gt;@@
                            @@#sell5;&lt;&lt;button &quot;Sell 5&quot;&gt;&gt;
                                &lt;&lt;set _to_pay = 5 * $sell_price&gt;&gt;
                                &lt;&lt;addmoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, _selected, 5)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                                &lt;&lt;addmins 50&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                            @@#sellall;&lt;&lt;button &quot;Sell all&quot;&gt;&gt;
                                &lt;&lt;set _to_sell = UInv.BagHasItem(&quot;inventory&quot;, _selected)&gt;&gt;
                                &lt;&lt;set _to_pay = _to_sell * $sell_price&gt;&gt;
                                &lt;&lt;addmoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, _selected, _to_sell)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_sell&gt;&gt;
                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                                &lt;&lt;addmins 10 * _to_sell&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                        &lt;/div&gt;
                    &lt;/center&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;&lt;include info&gt;&gt;

        &lt;div id=&quot;action_bar&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 3 / span 1; grid-column: 1 / span 3&quot;&gt;
            &lt;&lt;include niponStallsActions&gt;&gt;
            &lt;&lt;include niponStallsTradeOptions&gt;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="119" name="niponStallsTradeOptions" tags="" position="1100,1475" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;trade_options&quot; class=&quot;action container row col longbutton fiveQuarters hidden&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    &lt;div style=&quot;grid-row: 1; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;back_button&quot; style=&quot;grid-row: 3; grid-column: 4&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;script&gt;&gt;
                $(&quot;#actions&quot;).removeClass(&quot;hidden&quot;);
                $(&quot;#trade_options&quot;).addClass(&quot;hidden&quot;);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div id=&quot;back_to_options_button&quot; class=&quot;hidden&quot; style=&quot;grid-row: 3; grid-column: 4&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;script&gt;&gt;
                $(&quot;#commodityLog&quot;).addClass(&quot;hidden&quot;);
                $(&quot;#mainLog&quot;).removeClass(&quot;hidden&quot;);
                $(&quot;#back_to_options_button&quot;).addClass(&quot;hidden&quot;);
                $(&quot;#back_button&quot;).removeClass(&quot;hidden&quot;);
                $(&quot;.to_hide&quot;).removeClass(&quot;hidden&quot;);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponMarket&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

    &lt;&lt;for _key, _val range $commodities&gt;&gt;
        &lt;&lt;capture _key&gt;&gt;
            &lt;div class=&quot;to_hide&quot;&gt;
                &lt;&lt;button `setup.titleCase(_key)`&gt;&gt;
                    &lt;&lt;set _selected = _key&gt;&gt;
                    &lt;&lt;set _halfspread = setup.sigmoid($difficulty) * .1&gt;&gt;
                    &lt;&lt;if $player.titles.has(&quot;well_connected&quot;)&gt;&gt;
                        &lt;&lt;set _halfspread *= 0.5&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                    &lt;&lt;updatecommodities _selected&gt;&gt;
                &lt;&lt;/button&gt;&gt;
            &lt;/div&gt;
        &lt;&lt;/capture&gt;&gt;
    &lt;&lt;/for&gt;&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="120" name="niponTradeUnionActions" tags="" position="1225,1475" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;actions&quot; class=&quot;action container row col longbutton fiveQuarters&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    &lt;&lt;button &quot;Talk&quot;&gt;&gt;
        &lt;&lt;if ndef _shown_talk_options || !_shown_talk_options&gt;&gt;
            &lt;&lt;set _shown_talk_options = true&gt;&gt;
            &lt;&lt;script&gt;&gt;
                var div = $(&quot;&lt;div&gt;&lt;/div&gt;&quot;);
                var html = &quot;
                    &lt;ol&gt;\
                        &lt;li&gt;Ask about the Nipon Trade Union.&lt;/li&gt;\
                        &lt;li&gt;Ask about trading.&lt;/li&gt;\
                        &lt;li&gt;Ask about Nipon.&lt;/li&gt;\
                        &lt;li&gt;Ask about her background.&lt;/li&gt;\
                        &lt;li&gt;Patron options.&lt;/li&gt;\
                    &lt;/ol&gt;&quot;;
                div.html(html);
                setup.mainLog_append(div);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;set _choices = 5&gt;&gt;
            &lt;&lt;set _disable_buttons = false&gt;&gt;
            &lt;&lt;disableactions&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;addclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;removeclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;

    &lt;&lt;button &quot;Trade&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;removeclass &quot;#trade_options&quot; &quot;hidden&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;

    &lt;&lt;disable&gt;&gt;
        @@#office;&lt;&lt;button &quot;Office&quot;&gt;&gt;

        &lt;&lt;/button&gt;&gt;@@
    &lt;&lt;/disable&gt;&gt;
    

    &lt;div style=&quot;grid-row: 1; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 3; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponMarket&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="121" name="niponTradeUnion" tags="black" position="100,1600" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;if $quests.the_nipon_economy.stage lte 2&gt;&gt;
    /* Add tutorial */
    &lt;&lt;if tale.has(passage() + &quot;Tutorial&quot;)&gt;&gt;
        &lt;&lt;set $tutorials[passage()] = passage() + &quot;Tutorial&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    /* Forward Nipon Economy quest */
    &lt;&lt;if !$quest_journal.completed.contains(&quot;the_nipon_economy&quot;) &amp;&amp; $quests.the_nipon_economy.added &amp;&amp; $quests.the_nipon_economy.stage lt 3&gt;&gt;
        &lt;&lt;set $quests.the_nipon_economy.stage = 3&gt;&gt;
    &lt;&lt;/if&gt;&gt;
     
&lt;&lt;/if&gt;&gt;
&lt;&lt;set $_to_log = &quot;
    &lt;div&gt;You can tell the decadent trade union was one of the first buildings in Nipon. A heavy \
    feeling of self-importance lingers in the main hall. You see a beautiful woman standing at \
    the counter, and guards lining the walls of the room. She approaches you somewhat \
    apprehensively.&lt;/div&gt;&lt;br&gt;&quot; + 
    $characters.lia_hiroyuki.dialogue(&quot;Welcome to the Nipon Trade Union; how may I help you?&quot;)
&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;

/* Audio engine */
 

&lt;div id=&quot;background&quot; class=&quot;paper_border notext&quot;&gt;
    &lt;div class=&quot;main container fourCol threeRow&quot; style=&quot;height: 100%; width: 100%;&quot;&gt;
        &lt;div class=&quot;subbackground mainLogContainer&quot;&gt;
            &lt;&lt;include mainLog&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setTimeout(() =&gt; {
                    var lia = State.variables.characters.lia_hiroyuki;
                    $(&quot;#mainLogCharacterImage&quot;).css(&quot;background-image&quot;,
                        &quot;url(\&quot;&quot; + lia.image_folder() + &quot;niponTradeUnion_lia_neutral.png\&quot;)&quot;
                    );
                }, 10);
            &lt;&lt;/script&gt;&gt;
            &lt;div id=&quot;commodityLog&quot; class=&quot;mainLog hidden&quot;&gt;
                &lt;center&gt;
                    &lt;div style=&quot;margin: 20px&quot;&gt;
                        &lt;b id=&quot;commodity_name&quot;&gt;&lt;/b&gt;&lt;br&gt;
                        &#39;&#39;Spread&#39;&#39;: &lt;span id=&quot;commodity_spread&quot;&gt;&lt;/span&gt;
                    &lt;/div&gt;
                &lt;/center&gt;
                &lt;div class=&quot;container threeCol&quot;&gt;

                    &lt;div class=&quot;container twoCol&quot;&gt;
                        &lt;p&gt;
                        Holding: &lt;br&gt;
                        Midprice: &lt;br&gt;
                        Sigma: &lt;br&gt;
                        Theta: &lt;br&gt;
                        EQ-price: &lt;br&gt;
                        EQ-trend: &lt;br&gt;
                        &lt;/p&gt;
                        &lt;p id=&quot;commodity_stats&quot; style=&quot;text-align: right&quot;&gt;
                        &lt;/p&gt;
                    &lt;/div&gt;

                    &lt;center class=&quot;smalltext&quot;&gt;
                        &lt;div&gt;
                            &#39;&#39;Buy Price&#39;&#39;: &lt;span id=&quot;commodity_buy_price&quot;&gt;&lt;/span&gt;
                        &lt;/div&gt;&lt;br&gt;
                        &lt;div class=&quot;column&quot;&gt;
                            @@#buy20;&lt;&lt;button &quot;Buy 20&quot;&gt;&gt;
                                &lt;&lt;set _to_pay = 20 * $buy_price&gt;&gt;
                                &lt;&lt;removemoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, _selected, 20)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                            @@#buy50;&lt;&lt;button &quot;Buy 50&quot;&gt;&gt;
                                &lt;&lt;set _to_pay = 50 * $buy_price&gt;&gt;
                                &lt;&lt;removemoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, _selected, 50)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                            @@#buy100;&lt;&lt;button &quot;Buy 100&quot;&gt;&gt;
                                &lt;&lt;set _to_pay = 100 * $buy_price&gt;&gt;
                                &lt;&lt;removemoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, _selected, 100)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                        &lt;/div&gt;
                    &lt;/center&gt;

                    &lt;center class=&quot;smalltext&quot;&gt;
                        &lt;div&gt;
                            &#39;&#39;Sell Price&#39;&#39;: &lt;span id=&quot;commodity_sell_price&quot;&gt;&lt;/span&gt;
                        &lt;/div&gt;&lt;br&gt;
                        &lt;div class=&quot;column&quot;&gt;
                            @@#sell20;&lt;&lt;button &quot;Sell 20&quot;&gt;&gt;
                                &lt;&lt;set _to_pay = 20 * $sell_price&gt;&gt;
                                &lt;&lt;addmoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, _selected, 20)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                            @@#sell50;&lt;&lt;button &quot;Sell 50&quot;&gt;&gt;
                                &lt;&lt;set _to_pay = 50 * $sell_price&gt;&gt;
                                &lt;&lt;addmoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, _selected, 50)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                            @@#sell100;&lt;&lt;button &quot;Sell 100&quot;&gt;&gt;
                                &lt;&lt;set _to_pay = 100 * $sell_price&gt;&gt;
                                &lt;&lt;addmoney _to_pay&gt;&gt;
                                &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, _selected, 100)&gt;&gt;
                                &lt;&lt;updatecommodities _selected&gt;&gt;

                                &lt;&lt;unset _to_pay&gt;&gt;
                                &lt;&lt;audio &quot;coins_sound&quot; play&gt;&gt;
                            &lt;&lt;/button&gt;&gt;@@
                        &lt;/div&gt;
                    &lt;/center&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;&lt;include info&gt;&gt;

        &lt;div id=&quot;action_bar&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 3 / span 1; grid-column: 1 / span 3&quot;&gt;
            &lt;&lt;include niponTradeUnionActions&gt;&gt;
            &lt;&lt;include niponTradeUnionTalkOptions&gt;&gt;
            &lt;&lt;include niponTradeUnionTradeOptions&gt;&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="122" name="niponTradeUnionTalkOptions" tags="" position="225,1600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;events_actions&quot; class=&quot;action container row col hidden&quot;
         style=&quot;--rows: 4; --cols: 5&quot;&gt;

    &lt;&lt;set _main_options = &quot;\
        &lt;ol&gt;\
            &lt;li&gt;Ask about the Nipon Trade Union.&lt;/li&gt;\
            &lt;li&gt;Ask about trading.&lt;/li&gt;\
            &lt;li&gt;Ask about Nipon.&lt;/li&gt;\
            &lt;li&gt;Ask about her background.&lt;/li&gt;\
            &lt;li&gt;Patron options.&lt;/li&gt;\
        &lt;/ol&gt;\
    &quot;&gt;&gt;

    @@#events1;&lt;&lt;button &quot;1&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;set $enable_menu = false&gt;&gt;
        &lt;&lt;if ndef _action&gt;&gt;
            &lt;&lt;set _action = 1&gt;&gt;
            &lt;&lt;set _responses = [$characters.lia_hiroyuki.dialogue(
                &quot;The Trade Union is one of the last structures left in tact after the great dusting. \
                Our founders believed in free-trade and since we provide necessary resources, we yield \
                a great deal of political power within settlements. This is exacerbated by the fact that \
                we also act as a bank, providing backing for the lari. We mainly cater toward settlement \
                owners or the very affluent. Finally we are also information brokers, and have the latest \
                news of the world for our patrons.&quot;
            )]&gt;&gt;
            &lt;&lt;set _options = $(
                &quot;&lt;ol&gt;\
                    &lt;li id=\&quot;li1\&quot;&gt;\&quot;What are patrons?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li2\&quot;&gt;\&quot;So where does that put you with Nipon?\&quot;&lt;/li&gt;\
                    &lt;li id=\&quot;li3\&quot;&gt;\&quot;I see.\&quot;&lt;/li&gt;\
                &lt;/ol&gt;&quot;
            )&gt;&gt;
            &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 3&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 1&gt;&gt;
            &lt;&lt;run $(&quot;#events1 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;addclass &quot;#events1 button&quot; &quot;disabled&quot;&gt;&gt;
            /* About Nipon Trade Union -&gt; What are patrons? */
            &lt;&lt;set _responses = [$characters.lia_hiroyuki.dialogue(
                &quot;Patrons are people throughout this world who keep the Trade Union in business. By \
                supplying us with a monthly membership fee, you will have access to our information \
                network. Something one might find immediately useful is our statistics of the different \
                commodities around the world, thought they require a bit of understanding about economics.&quot;
            )]&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li1&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;elseif _action == 2&gt;&gt;
            /* About Trading -&gt; What&#39;s a semi-stable pattern? */
            &lt;&lt;run $(&quot;#events1 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;addclass &quot;#events1 button&quot; &quot;disabled&quot;&gt;&gt;
            /* About Nipon Trade Union -&gt; So where does that put you with Nipon? */
            &lt;&lt;set _responses = [$characters.lia_hiroyuki.dialogue(
                &quot;On a high level, a semi-stable pattern describes an asset where the instantaneous \
                behavior of the asset follows a mean-reverting trajectory. Specifically it follows \
                an Ornstein-Uhlenbeck process. One of the perks of being a patron of the Trade Union \
                is being able to know the parameters of this OU-process at any given time.&quot;
            )]&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li1&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;elseif _action == 3&gt;&gt;
            /* About Nipon -&gt; It&#39;s been a living hell */
            &lt;&lt;set _responses = [
                &quot;Lia quickly realizes that there were eyes all around the room \
                she leans in and whispers, (Lia\&#39;s Trust &quot; + setup.show_change_html(0, 2) + &quot;)&quot;,
                $characters.lia_hiroyuki.dialogue(
                    &quot;Meet me at my place after I get off work at 8 PM. I live in the \
                    large tower in the north west corner of Central Nipon.&quot;
                ),
                &quot;Lia resumes her normal voice,&quot;,
                $characters.lia_hiroyuki.dialogue(
                    &quot;And that\&#39;s what makes Nipon one of the best settlements in the world! \
                    Now, is there anything else you needed?&quot;
                ),
                _main_options
            ]&gt;&gt;
            &lt;&lt;set $characters.lia_hiroyuki.slave_traits.trust += 2&gt;&gt;
            &lt;&lt;set _to_round = &quot;lia_hiroyuki&quot;&gt;&gt;
            &lt;&lt;include round&gt;&gt;
            
            &lt;&lt;set $has_access.add(&quot;liasTower&quot;)&gt;&gt;
            &lt;&lt;set $quests[&quot;power_struggles&quot;].added = true&gt;&gt;
            &lt;&lt;set $quest_journal.ongoing.push(&quot;power_struggles&quot;)&gt;&gt;
            &lt;&lt;notify&gt;&gt;Quest &lt;em&gt;Power Struggles&lt;/em&gt; added to journal!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;audio &quot;quest_added_sound&quot; play&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;set $enable_menu = true&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 5&gt;&gt;
            /* Patron options -&gt; I&#39;d like to become a patron */
            /* TODO: Implement */
            &lt;&lt;set _responses = [
                $characters.lia_hiroyuki.dialogue(&quot;Is there anything else you need?&quot;),
                _main_options
            ]&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;set $enable_menu = true&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events2;&lt;&lt;button &quot;2&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;if ndef _action&gt;&gt;
            &lt;&lt;set _action = 2&gt;&gt;
            &lt;&lt;set _responses = [$characters.lia_hiroyuki.dialogue(
                &quot;The Trade Union offers trading in both commodities and equities, however we \
                only offer commodity trading in bulk. If you want to trade a low amount of commodities \
                I recommend checking out the market stalls during the day. Commodities in general follow \
                a semi-stable pattern while equities are don\&#39;t.&quot;
            )]&gt;&gt;
            &lt;&lt;set _options = $(
                &quot;&lt;ol&gt;\
                    &lt;li&gt;\&quot;What\&#39;s a semi-stable pattern?\&quot;&lt;/li&gt;\
                    &lt;li&gt;\&quot;I see.\&quot;&lt;/li&gt;\
                &lt;/ol&gt;&quot;
            )&gt;&gt;
            &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 2&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 1&gt;&gt;
            &lt;&lt;run $(&quot;#events2 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;addclass &quot;#events2 button&quot; &quot;disabled&quot;&gt;&gt;
            /* About Nipon Trade Union -&gt; So where does that put you with Nipon? */
            &lt;&lt;set _responses = [$characters.lia_hiroyuki.dialogue(
                &quot;We have a good working relationship with Nipon. As you may already know Nipon is one of the \
                best settlements currently in terms of its prosperity. Though of course it is not without its \
                own issues. We hope that the Trade Union and Nipon can continue working hand-in-hand for the \
                good of mankind.&quot;
            ),
                &quot;You can tell that everything Lia is saying is memorized, and you sense a slight tremor in her voice.&quot;,
            ]&gt;&gt;
            &lt;&lt;set _options.find(&quot;#li2&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
            &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;elseif _action == 2&gt;&gt;
            /* About Trading -&gt; I see. */
            &lt;&lt;set _responses = [
                $characters.lia_hiroyuki.dialogue(&quot;Did you need anything else?&quot;),
                _main_options
            ]&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;set $enable_menu = true&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 3&gt;&gt;
            /* About Nipon -&gt; What do you expect me to say? */
            &lt;&lt;set _responses = [
                &quot;Lia quickly realizes that there were eyes all around the room \
                she leans in and whispers, (Lia\&#39;s Trust &quot; + setup.show_change_html(0, 5) + &quot;)&quot;,
                $characters.lia_hiroyuki.dialogue(
                    &quot;Meet me at my place after I get off work at 8 PM. I live in the \
                    large tower in the north west corner of Central Nipon.&quot;
                ),
                &quot;Lia resumes her normal voice,&quot;,
                $characters.lia_hiroyuki.dialogue(
                    &quot;And that\&#39;s what makes Nipon one of the best settlements in the world! \
                    Now, is there anything else you needed?&quot;
                ),
                _main_options
            ]&gt;&gt;
            &lt;&lt;set $characters.lia_hiroyuki.slave_traits.trust += 5&gt;&gt;
            &lt;&lt;set _to_round = &quot;lia_hiroyuki&quot;&gt;&gt;
            &lt;&lt;include round&gt;&gt;

            &lt;&lt;set $has_access.add(&quot;liasTower&quot;)&gt;&gt;
            &lt;&lt;set $quests[&quot;power_struggles&quot;].added = true&gt;&gt;
            &lt;&lt;set $quest_journal.ongoing.push(&quot;power_struggles&quot;)&gt;&gt;
            &lt;&lt;notify&gt;&gt;Quest &lt;em&gt;Power Struggles&lt;/em&gt; added to journal!&lt;&lt;/notify&gt;&gt;
            &lt;&lt;audio &quot;quest_added_sound&quot; play&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;set $enable_menu = true&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 5&gt;&gt;
            /* Patron options -&gt; I&#39;d like to cancel my patronage */
            /* TODO: Implement */
            &lt;&lt;set _responses = [
                $characters.lia_hiroyuki.dialogue(&quot;Is there anything else you need?&quot;),
                _main_options
            ]&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;set $enable_menu = true&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        
    &lt;&lt;/button&gt;&gt;@@
    @@#events3;&lt;&lt;button &quot;3&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;if ndef _action&gt;&gt;
            &lt;&lt;set _action = 3&gt;&gt;
            &lt;&lt;if $player.is_slave &amp;&amp; !$quests.power_struggles.added&gt;&gt;
                &lt;&lt;set _responses = [
                    &quot;Lia\&#39;s eyes wonder over to your neck where the symbol of the Hiroyuki \
                    household rests. You see her expression soften a bit but you are unable \
                    to tell if it\&#39;s simply pity or something more.&quot;,
                    $characters.lia_hiroyuki.dialogue(&quot;
                        Well Nipon is one of the most prosperous settlements right now. Like \
                        most settlements after the great dusting, Nipon\&#39;s economy and culture \
                        is based on slavery...\
                    &quot;),
                    &quot;Lia\&#39;s voice fades off to a whisper as she locks eye contact with you,&quot;,
                    $characters.lia_hiroyuki.dialogue(&quot;
                        You\&#39;ve obviously experienced it yourself. Tell me, what do you think \
                        of being a slave in Nipon?\
                    &quot;)
                ]&gt;&gt;
                &lt;&lt;set _options = $(
                    &quot;&lt;ol&gt;\
                        &lt;li&gt;\&quot;It\&#39;s been a living hell.\&quot;&lt;/li&gt;\
                        &lt;li&gt;\&quot;What do you expect me to say to that?\&quot;&lt;/li&gt;\
                        &lt;li&gt;\&quot;It\&#39;s been great overall.\&quot;&lt;/li&gt;\
                    &lt;/ol&gt;&quot;
                )&gt;&gt;
                &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    setup.mainLog_append_delayed(State.temporary.responses, 
                        State.variables.buttons, 
                        State.variables.buttons_extra);
                &lt;&lt;/script&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;set _choices = 3&gt;&gt;
                    &lt;&lt;disableactions&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set _responses = [
                    &quot;Lia leans in and says discretely,&quot;,
                    $characters.lia_hiroyuki.dialogue(&quot;Meet me at my place after I get off work at 8 PM.&quot;),
                    &quot;Lia resumes her normal voice,&quot;,
                    $characters.lia_hiroyuki.dialogue(
                        &quot;And that\&#39;s what makes Nipon one of the best settlements in the world! \
                        Now, is there anything else you needed?&quot;
                    ),
                    _main_options
                ]&gt;&gt;
                &lt;&lt;unset _action&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    setup.mainLog_append_delayed(State.temporary.responses, 
                        State.variables.buttons, 
                        State.variables.buttons_extra);
                &lt;&lt;/script&gt;&gt;
                &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                    &lt;&lt;set _choices = 5&gt;&gt;
                    &lt;&lt;set _disable_buttons = false&gt;&gt;
                    &lt;&lt;disableactions&gt;&gt;
                    &lt;&lt;set $enable_menu = true&gt;&gt;
                    &lt;&lt;stop&gt;&gt;
                &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;elseif _action == 1&gt;&gt;
            /* About Nipon Trade Union -&gt; I see. */
            &lt;&lt;set _responses = [
                $characters.lia_hiroyuki.dialogue(&quot;Did you need anything else?&quot;),
                _main_options
            ]&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;set $enable_menu = true&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 3&gt;&gt;
            /* About Nipon -&gt; It&#39;s been great overall */
            &lt;&lt;set _responses = [
                &quot;Lia sighs and immediately forms an obviously fake smile on her face,&quot;,
                $characters.lia_hiroyuki.dialogue(
                    &quot;That\&#39;s great to hear! Nipon is built so everyone, including slaves, \
                    can thrive! Did you need anything else?&quot;
                ),
                _main_options
            ]&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;set $enable_menu = true&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;elseif _action == 5&gt;&gt;
            /* Patron options -&gt; Nevermind */
            &lt;&lt;set _responses = [
                $characters.lia_hiroyuki.dialogue(&quot;Is there anything else you need?&quot;),
                _main_options
            ]&gt;&gt;
            &lt;&lt;unset _action&gt;&gt;
            &lt;&lt;script&gt;&gt;
                setup.mainLog_append_delayed(State.temporary.responses, 
                    State.variables.buttons, 
                    State.variables.buttons_extra);
            &lt;&lt;/script&gt;&gt;
            &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
                &lt;&lt;set _choices = 5&gt;&gt;
                &lt;&lt;set _disable_buttons = false&gt;&gt;
                &lt;&lt;disableactions&gt;&gt;
                &lt;&lt;set $enable_menu = true&gt;&gt;
                &lt;&lt;stop&gt;&gt;
            &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events4;&lt;&lt;button &quot;4&quot;&gt;&gt;
        &lt;&lt;set _action = 4&gt;&gt;
        &lt;&lt;set _responses = [
            &quot;Your eyes wonder over to the name plate sitting on the counter,&quot;,
            $player.dialogue(&quot;Lia Hiroyuki... you\&#39;re Shintani\&#39;s sister?&quot;),
            &quot;You catch yourself as you realize your tone is too impolite,&quot;,
            $player.dialogue(&quot;\
                Apologies, I was caught off guard, Shintani had not told me about him having \
                any family in Nipon. If I may ask, what role do you serve in Nipon?\
            &quot;),
            &quot;Lia\&#39;s eyes drift downwards,&quot;,
            $characters.lia_hiroyuki.dialogue(
                &quot;Well yes, I am Shintani\&#39;s younger sister, but I\&#39;m afraid we don\&#39;t see eye \
                to eye on everything. When I joined the trade union Shintani sold off our parents \
                to fund what Nipon is today. If it hadn\&#39;t been for the union\&#39;s support, I\&#39;d \
                have been long gone for now.&quot;
            ),
            &quot;Lia\&#39;s voice fades and her eyes dart across the room, you can tell this isn\&#39;t a good \
            place for you to ask her these questions. After a moment, Lia remembers where she is,&quot;,
            $characters.lia_hiroyuki.dialogue(
                &quot;Sorry it\&#39;s quite complicated I\&#39;d rather not get into it right now, was there \
                anything else you needed?&quot;
            ),
            _main_options
        ]&gt;&gt;
        &lt;&lt;unset _action&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses, 
                State.variables.buttons, 
                State.variables.buttons_extra);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
            &lt;&lt;set _choices = 5&gt;&gt;
            &lt;&lt;set _disable_buttons = false&gt;&gt;
            &lt;&lt;disableactions&gt;&gt;
            &lt;&lt;set $enable_menu = true&gt;&gt;
            &lt;&lt;stop&gt;&gt;
        &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events5;&lt;&lt;button &quot;5&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;set _action = 5&gt;&gt;
        &lt;&lt;set _responses = [$characters.lia_hiroyuki.dialogue(
            &quot;There are many ways to become a patron of the trade union. Note that \
            being a patron extends not only to the trade union in Nipon, but also \
            the trade union in other settlements as well. The most common way is for \
            someone to pay 200 lari per week, however this option is only available for \
            citizens and not slaves. For a slave to get the benefits of a patron their \
            owner must be a patron, and they must have a status of high slave.&quot;
        )]&gt;&gt;
        &lt;&lt;set _options = $(
            &quot;&lt;ol&gt;\
                &lt;li id=\&quot;li1\&quot;&gt;\&quot;I\&#39;d like to become a patron (¤200).\&quot;&lt;/li&gt;\
                &lt;li id=\&quot;li2\&quot;&gt;\&quot;I\&#39;d like to cancel my patronage.\&quot;&lt;/li&gt;\
                &lt;li id=\&quot;li3\&quot;&gt;\&quot;Nevermind.\&quot;&lt;/li&gt;\
            &lt;/ol&gt;&quot;
        )&gt;&gt;
        &lt;&lt;if $player.is_slave || $player.titles.has(&quot;trade_union_patron&quot;)&gt;&gt;
            &lt;&lt;run _options.find(&quot;#li1&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;if $player.is_slave || !$player.titles.has(&quot;trade_union_patron&quot;)&gt;&gt;
            &lt;&lt;run _options.find(&quot;#li2&quot;).css(&quot;text-decoration&quot;, &quot;line-through&quot;)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _responses.push(_options.clone())&gt;&gt;
        &lt;&lt;script&gt;&gt;
            setup.mainLog_append_delayed(State.temporary.responses, 
                State.variables.buttons, 
                State.variables.buttons_extra);
        &lt;&lt;/script&gt;&gt;
        &lt;&lt;silently&gt;&gt;&lt;&lt;repeat 20ms&gt;&gt;&lt;&lt;if def _done_appending &amp;&amp; _done_appending&gt;&gt;
            &lt;&lt;set _choices = 3&gt;&gt;
            &lt;&lt;disableactions&gt;&gt;
            &lt;&lt;if $player.is_slave || $player.titles.has(&quot;trade_union_patron&quot;)&gt;&gt;
                &lt;&lt;run $(&quot;#events1 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#events1 button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;if $player.is_slave || !$player.titles.has(&quot;trade_union_patron&quot;)&gt;&gt;
                &lt;&lt;run $(&quot;#events2 button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass &quot;#events2 button&quot; &quot;disabled&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
            &lt;&lt;stop&gt;&gt;
        &lt;&lt;/if&gt;&gt;&lt;&lt;/repeat&gt;&gt;&lt;&lt;/silently&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events6;&lt;&lt;button &quot;6&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events7;&lt;&lt;button &quot;7&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@
    @@#events8;&lt;&lt;button &quot;8&quot;&gt;&gt;
    &lt;&lt;/button&gt;&gt;@@

    &lt;&lt;set $buttons = []&gt;&gt;
    &lt;&lt;for _i = 1; _i lte 8; _i++&gt;&gt;
        &lt;&lt;set $buttons.push(&quot;#events&quot; + _i)&gt;&gt;
    &lt;&lt;/for&gt;&gt;
    &lt;&lt;set $buttons_extra = [&quot;#events_actions_back&quot;, &quot;#events_actions_leave&quot;]&gt;&gt;

    /* Back button is disabled by default */
    &lt;div style=&quot;grid-row: 1; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 5&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;events_actions_back&quot; style=&quot;grid-row: 3; grid-column: 5&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#events_actions&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div id=&quot;events_actions_leave&quot; style=&quot;grid-row: 4; grid-column: 5&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponMarket&quot;&gt;&gt;
        &lt;&lt;set _location_button_sound = &quot;wooden_door_sound&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="123" name="niponTradeUnionTradeOptions" tags="" position="350,1600" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;trade_options&quot; class=&quot;action container row col longbutton fiveQuarters hidden&quot; 
        style=&quot;--rows: 4; --cols: 4&quot;&gt;

    &lt;div style=&quot;grid-row: 1; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div style=&quot;grid-row: 2; grid-column: 4&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;back_button&quot; style=&quot;grid-row: 3; grid-column: 4&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;removeclass &quot;#actions&quot; &quot;hidden&quot;&gt;&gt;
            &lt;&lt;addclass &quot;#trade_options&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div id=&quot;back_to_options_button&quot; class=&quot;hidden&quot; style=&quot;grid-row: 3; grid-column: 4&quot;&gt;
        &lt;&lt;button &quot;Back&quot;&gt;&gt;
            &lt;&lt;script&gt;&gt;
                $(&quot;#commodityLog&quot;).addClass(&quot;hidden&quot;);
                $(&quot;#mainLog&quot;).removeClass(&quot;hidden&quot;);
                $(&quot;#back_to_options_button&quot;).addClass(&quot;hidden&quot;);
                $(&quot;#back_button&quot;).removeClass(&quot;hidden&quot;);
                $(&quot;.to_hide&quot;).removeClass(&quot;hidden&quot;);
            &lt;&lt;/script&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;/div&gt;
    &lt;div style=&quot;grid-row: 4; grid-column: 4&quot;&gt;
        &lt;&lt;set _location_button_text = &quot;Leave&quot;&gt;&gt;
        &lt;&lt;set _location_button_dest = &quot;niponMarket&quot;&gt;&gt;
        &lt;&lt;include locationButton&gt;&gt;
    &lt;/div&gt;

    &lt;&lt;for _key, _val range $commodities&gt;&gt;
        &lt;&lt;capture _key&gt;&gt;
            &lt;div class=&quot;to_hide&quot;&gt;
                &lt;&lt;button `setup.titleCase(_key)`&gt;&gt;
                    &lt;&lt;set _selected = _key&gt;&gt;
                    &lt;&lt;set _halfspread = setup.sigmoid($difficulty) * .02&gt;&gt;
                    &lt;&lt;updatecommodities _selected&gt;&gt;
                &lt;&lt;/button&gt;&gt;
            &lt;/div&gt;
        &lt;&lt;/capture&gt;&gt;
    &lt;&lt;/for&gt;&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="124" name="niponSlums" tags="paper" position="475,1600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;if setup.is_day($gameDate)&gt;&gt;
    &lt;&lt;set $_to_log += &quot;
        &lt;div&gt;The slum&#39;s bustling cacophony of civilization rings in your ears.&lt;/div&gt;&lt;br&gt;\
    &quot;&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;set $_to_log += &quot;
        &lt;div&gt;The slums rests quietly with the rest of the people.&lt;/div&gt;&lt;br&gt;\
    &quot;&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Player is outside */
&lt;&lt;set $player.is_home = false&gt;&gt;
&lt;&lt;set $player.is_outside = true&gt;&gt;

/* Load in any saved variables */
&lt;&lt;loadVars&gt;&gt;

/* Audio engine */
 

&lt;div class=&quot;mapside left&quot;&gt;
    &lt;&lt;include niponActions&gt;&gt;
&lt;/div&gt;

&lt;div id=&quot;background&quot; class=&quot;notext&quot; style=&quot;padding: 0px&quot;&gt;
    &lt;img src=&quot;resources/maps/niponSlumsMap.jpeg&quot; usemap=&quot;#image-map&quot;&gt;
    &lt;map name=&quot;image-map&quot;&gt;
        &lt;area alt=&quot;sonderVille&quot; coords=&quot;763,31,747,141,763,190,789,249,810,298,865,327,1020,198,1023,175,954,120,897,78,866,31&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;valeCommunity&quot; coords=&quot;896,26,1036,159,1109,114,1143,80,1159,30&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponCampGrounds&quot; coords=&quot;934,436,996,417,1057,427,1134,401,1223,417,1237,480,1223,536,1149,581,1159,635,1133,685,1020,574,970,591,929,511&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;divineTouchBrothel&quot; coords=&quot;1049,174,1138,242,1238,175,1130,105&quot; shape=&quot;poly&quot;&gt;
        &lt;area alt=&quot;niponCentral&quot; coords=&quot;556,28,739,75&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;niponMarket&quot; coords=&quot;1182,30,1371,73&quot; shape=&quot;rect&quot;&gt;
        &lt;area alt=&quot;east&quot; coords=&quot;1153,758,1369,800&quot; shape=&quot;rect&quot;&gt;
    &lt;/map&gt;
&lt;/div&gt;

&lt;div class=&quot;mapside right&quot;&gt;
    &lt;hr&gt;
    &lt;&lt;include infoNoSubbackground&gt;&gt;
&lt;/div&gt;

&lt;&lt;updatetime&gt;&gt;

/* Remove quick bar and setup map */
&lt;&lt;script&gt;&gt;
    setTimeout(() =&gt; {
        $(&quot;#quickbar&quot;).addClass(&quot;hidden&quot;);
        var areas = $(&quot;map&quot;).children(&quot;area&quot;);
        for (var _i = 0; _i &lt; areas.length; _i++) {
            var obj = $(areas[_i]);
            if (!(setup.locations.has(obj.attr(&quot;alt&quot;)))) {
                continue;
            }
            var loc = setup.locations.get(obj.attr(&quot;alt&quot;));
            if (!State.variables.has_access.has(loc.key)) {
                obj.addClass(&quot;noaccess&quot;);
                obj.attr(&quot;onclick&quot;, &quot;$.wiki(&#39;&lt;&lt;notify&gt;&gt;No Access!&lt;&lt;/notify&gt;&gt;&#39;)&quot;);
                obj.attr(&quot;title&quot;, &quot;No access.&quot;);
            } else if (!loc.has_access()) {
                obj.addClass(&quot;closed&quot;);
                obj.attr(&quot;onclick&quot;, &quot;$.wiki(&#39;&lt;&lt;notify&gt;&gt;Closed!&lt;&lt;/notify&gt;&gt;&#39;)&quot;);
                var opening_time = loc.access_times[0];
                var opening_time_str = &quot;&quot;;
                if (opening_time == 0) {
                    opening_time_str = &quot;12 AM.&quot;;
                } else if (opening_time &lt; 12) {
                    opening_time_str = opening_time.toString() + &quot; AM.&quot;;
                } else if (opening_time == 12) {
                    opening_time_str = &quot;12 PM.&quot;;
                } else {
                    opening_time_str = (opening_time - 12).toString() + &quot; PM.&quot;;
                }
                obj.attr(&quot;title&quot;, &quot;Opens at &quot; + opening_time_str);
            } else {
                obj.addClass(&quot;access&quot;);
                var onclick = &quot;SugarCube.setup.locations.get(&#39;&quot; + obj.attr(&quot;alt&quot;) + &quot;&#39;).goto(&quot;;
                if (loc.inside) {
                    onclick += &quot;&#39;wooden_door_sound&#39;&quot;;
                }
                onclick += &quot;)&quot;;
                obj.attr(&quot;onclick&quot;, onclick);
            }
        }
    }, 10);
&lt;&lt;/script&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="125" name="PassageHeader" tags="" position="600,1600" size="100,100">&lt;&lt;include audioEngine&gt;&gt;</tw-passagedata><tw-passagedata pid="126" name="Start" tags="black, pausetimer" position="725,1600" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;div id=&quot;background&quot; class=&quot;city_border&quot; style=&quot;position: relative; padding: 80px&quot;&gt;&lt;center&gt;
    &lt;div id=&quot;banner&quot;&gt;&lt;/div&gt;
    &lt;h3 style=&quot;&quot;&gt;- GAME LOBBY -&lt;/h3&gt;

    &lt;div class=&quot;column&quot;&gt;
        &lt;&lt;button &quot;Start&quot;&gt;&gt;
            &lt;&lt;if $(&quot;html&quot;).height() lt 920 || $(&quot;html&quot;).width() lt 1850&gt;&gt;
                &lt;&lt;run _screen_check_func()&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;goto &quot;intro1&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;
        &lt;br&gt;
        &lt;&lt;button &quot;Load&quot;&gt;&gt;
            &lt;&lt;if $(&quot;html&quot;).height() lt 920 || $(&quot;html&quot;).width() lt 1850&gt;&gt;
                &lt;&lt;run _screen_check_func()&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;script&gt;&gt;
                    UI.saves();
                &lt;&lt;/script&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/button&gt;&gt;
        &lt;br&gt;
        &lt;&lt;button &quot;Credits&quot; credits&gt;&gt;&lt;&lt;/button&gt;&gt;
        &lt;br&gt;
        &lt;a href=&quot;https://discord.gg/xrynJUBksW&quot;&gt;
            &lt;&lt;button &quot;Discord&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
        &lt;/a&gt;&lt;br&gt;
        &lt;a href=&quot;https://www.subscribestar.com/mimus-studios&quot;&gt;
            &lt;&lt;button &quot;Support Us&quot;&gt;&gt;&lt;&lt;/button&gt;&gt;
        &lt;/a&gt;
    &lt;/div&gt;
    
    &lt;div class=&quot;gameversion&quot;&gt;Version: &lt;&lt;= setup.VERSION&gt;&gt;&lt;/div&gt;

&lt;/center&gt;&lt;/div&gt;

&lt;&lt;set _screen_check_func = () =&gt; {
    if ($(&quot;html&quot;).height() &gt; $(&quot;html&quot;).width()) {
        var str = &quot;\
            &lt;&lt;popover&gt;&gt;&lt;center&gt;\
                It looks like you are on a mobile device (or your screen is very weirdly porportioned. \
                While we intend to eventually support mobile devices, they are not supported right now. \
                Please play this game on a PC with a regular sized screen. Thanks!\
            &lt;/center&gt;&lt;&lt;&quot;;
        $.wiki(str += &quot;/popover&gt;&gt;&quot;);
    } else {
        $.wiki(&quot;\
            &lt;&lt;popover&gt;&gt;&lt;center&gt;\
                It seems your screensize is not properly configured for this game. Please zoom out \
                your screen (CTRL -) until it looks similar to this.\
                &lt;hr&gt;\
                &lt;div id=\&quot;sample\&quot;&gt;&lt;/div&gt;\
                &lt;hr&gt;\
                Current Screen Height: &lt;&lt;= $(\&quot;html\&quot;).css(\&quot;height\&quot;)&gt;&gt;\
                | Minimum Required Screen Height: 920px&lt;br&gt;\
                Current Screen Width: &lt;&lt;= $(\&quot;html\&quot;).css(\&quot;width\&quot;)&gt;&gt;\
                | Minimum Required Screen Width: 1850px\
            &lt;/center&gt;&lt;&lt;/popover&gt;&gt;&quot;);
    }
}&gt;&gt;

&lt;&lt;timed 50ms&gt;&gt;
    &lt;&lt;if $(&quot;html&quot;).height() lt 920 || $(&quot;html&quot;).width() lt 1850&gt;&gt;
        &lt;&lt;run _screen_check_func()&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/timed&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="127" name="controls" tags="" position="850,1600" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h3&gt;Controls&lt;/h3&gt;
There are many convenient keybinds that may help you out throughout your journey.
&lt;ul&gt;
    &lt;li&gt;&#39;&#39;C&#39;&#39;: Controls (This page)&lt;/li&gt;
    &lt;li&gt;&#39;&#39;E&#39;&#39;: Character menu&lt;/li&gt;
    &lt;li&gt;&#39;&#39;Q&#39;&#39;: Quest journal&lt;/li&gt;
    &lt;li&gt;&#39;&#39;S&#39;&#39;: Saves&lt;/li&gt;
    &lt;li&gt;&#39;&#39;T&#39;&#39;: Provides information about current location including things to 
        do as well as some lore.
    &lt;/li&gt;
    &lt;li&gt;&#39;&#39;X / ESC&#39;&#39;: Settings menu&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="128" name="niponCentralTutorial" tags="" position="975,1600" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;Nipon&#39;s Central District&lt;/h2&gt;
&lt;div&gt;
    
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="129" name="niponMarketTutorial" tags="" position="1100,1600" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;Nipon&#39;s Market District&lt;/h2&gt;
&lt;div&gt;
    
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="130" name="niponSlumsTutorial" tags="" position="1225,1600" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;Nipon Slums&lt;/h2&gt;
&lt;div&gt;
    
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="131" name="shintaniHomeLibraryTutorial" tags="" position="100,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;Shintani&#39;s Library&lt;/h2&gt;
&lt;div&gt;
    This is Shintani&#39;s Library and the central location you gain intelligence.
&lt;/div&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="132" name="shintaniHomeTutorial" tags="" position="225,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;Shintani&#39;s Home&lt;/h2&gt;
&lt;div&gt;
    This is Shintani&#39;s home and a central location of work and rest for the initial parts of 
    the story. Initially you will be spending a lot of time here, but as you gain the trust of 
    Shintani you may be able to spend more time outside. This is also where you may interact 
    with the other slaves that serve the Hiroyuki household.
&lt;/div&gt;
&lt;br&gt;
&lt;div&gt;
    There are three main stats you will have to balance and maintain as a slave: Willpower, Trust, 
    and Obedience.
&lt;/div&gt;
&lt;br&gt;
&lt;&lt;message Willpower&gt;&gt;
&lt;p&gt;
Willpower reflects your ability to resist commands from your master as well as your personal identity. 
It is very easy, and may be expected for this stat to be very low in the early game. Being stuck in 
the Hiroyuki household, always under the eye of your master, would not encourage development of self.
&lt;/p&gt;
&lt;p&gt;
Common ways to gain Willpower: Disobeying orders; Not working; Spending time outside; Learning from 
the experience of others. Common ways to lose Willpower: Working; Following commands.
&lt;/p&gt;
&lt;&lt;/message&gt;&gt;&lt;br&gt;

&lt;&lt;message Trust&gt;&gt;
&lt;p&gt;
Trust in this world is hard to comeby, and is thus one of the more important stats. Raising Trust to 
a maximum allows you to raise your status, which in-turn unlocks events and progression of the story.
&lt;/p&gt;
&lt;p&gt;
Common ways to gain Trust: Sustaining high Obedience; Obeying orders and exceeding expectations; Showing 
concern for Nipon; Complete quests. Common ways to lose Trust: Disobeying orders and sabotage; Showing 
apathy for the goodness of Nipon.
&lt;/p&gt;
&lt;&lt;/message&gt;&gt;&lt;br&gt;

&lt;&lt;message Obedience&gt;&gt;
&lt;p&gt;
Obedience represents how you are viewed as a slave. You really want to keep this value up if possible. 
The consequences for letting this value fall to zero include beatings and potentially death.
&lt;/p&gt;
&lt;p&gt;
Common ways to gain Obedience: Obeying orders; Working. Common ways to lose Obedience: Disobeying 
orders; Not working (slacking off).
&lt;/p&gt;
&lt;&lt;/message&gt;&gt;

&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="133" name="statusTutorial" tags="" position="350,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;&lt;&lt;= setup.titleCase(_selected_status)&gt;&gt;&lt;/h2&gt;
As &lt;&lt;= setup.statuses[_selected_status].article&gt;&gt; &lt;b&gt;&lt;&lt;= setup.titleCase(_selected_status)&gt;&gt;&lt;/b&gt;, 
&lt;&lt;= setup.statuses[_selected_status].flavor_text&gt;&gt;
&lt;br&gt;
&lt;h4&gt;Stat Changes&lt;/h4&gt;
&lt;ul&gt;
    &lt;&lt;for _key, _val range setup.statuses[_selected_status].condition_changes&gt;&gt;
        &lt;li&gt;&lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;&lt;= setup.show_change_html(0, _val)&gt;&gt;&lt;/li&gt;
    &lt;&lt;/for&gt;&gt;
    &lt;&lt;for _key, _val range setup.statuses[_selected_status].stat_changes&gt;&gt;
        &lt;li&gt;&lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;&lt;= setup.show_change_html(0, _val)&gt;&gt;&lt;/li&gt;
    &lt;&lt;/for&gt;&gt;
&lt;/ul&gt;
&lt;&lt;if setup.statuses[_selected_status].extra_changes.length gt 0&gt;&gt;
&lt;h4&gt;Extras&lt;/h4&gt;
&lt;ul&gt;
    &lt;&lt;for _idx, _val range setup.statuses[_selected_status].extra_changes&gt;&gt;
        &lt;li&gt;_val&lt;/li&gt;
    &lt;&lt;/for&gt;&gt;
&lt;/ul&gt;
&lt;&lt;/if&gt;&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="134" name="titleTutorial" tags="" position="475,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;&lt;&lt;= setup.titleCase($selected_title)&gt;&gt;&lt;/h2&gt;
&lt;&lt;if setup.titles[$selected_title].custom_intro&gt;&gt;
    &lt;&lt;= setup.titles[$selected_title].flavor_text&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;= setup.titles[$selected_title].preposition&gt;&gt; &lt;b&gt;&lt;&lt;= setup.titleCase($selected_title)&gt;&gt;&lt;/b&gt;, 
    &lt;&lt;= setup.titles[$selected_title].flavor_text&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;if Object.keys(setup.titles[$selected_title].condition_changes).length gt 0 ||
     Object.keys(setup.titles[$selected_title].stat_changes).length gt 0 ||
     Object.keys(setup.titles[$selected_title].skill_changes).length gt 0&gt;&gt;
    &lt;h4&gt;Stat Changes&lt;/h4&gt;
    &lt;ul&gt;
        &lt;&lt;for _key, _val range setup.titles[$selected_title].condition_changes&gt;&gt;
            &lt;li&gt;&lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;&lt;= setup.show_change_html(0, _val)&gt;&gt;&lt;/li&gt;
        &lt;&lt;/for&gt;&gt;
        &lt;&lt;for _key, _val range setup.titles[$selected_title].stat_changes&gt;&gt;
            &lt;li&gt;&lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;&lt;= setup.show_change_html(0, _val)&gt;&gt;&lt;/li&gt;
        &lt;&lt;/for&gt;&gt;
        &lt;&lt;for _key, _val range setup.titles[$selected_title].skill_changes&gt;&gt;
            &lt;li&gt;&lt;&lt;= setup.titleCase(_key)&gt;&gt;: &lt;&lt;= setup.show_change_html(0, _val)&gt;&gt;&lt;/li&gt;
        &lt;&lt;/for&gt;&gt;
    &lt;/ul&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;if setup.titles[$selected_title].extra_changes.length gt 0&gt;&gt;
    &lt;h4&gt;Extra Effects&lt;/h4&gt;
    &lt;ul&gt;
        &lt;&lt;for _idx, _val range setup.titles[$selected_title].extra_changes&gt;&gt;
            &lt;li&gt;_val&lt;/li&gt;
        &lt;&lt;/for&gt;&gt;
    &lt;/ul&gt;
&lt;&lt;/if&gt;&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="135" name="welcome" tags="" position="600,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;popuptext&quot;&gt;
&lt;h2&gt;Welcome to Free Cities: Origins&lt;/h2&gt;
Thank you for choosing to play Free Cities: Origins, a prequal to the famous 
Free Cities game that&#39;s more RPG-centric. The goal of this game is to rise from 
a slave to owning an acropolis. Along the way you will unearth pieces of the past 
and be able to influence various factions in the world. Will you create a utopia 
from the ashes of the Dusting or rebirth the hatred that ruled humanity for millenia?

&lt;br&gt;
&lt;h3&gt;Controls&lt;/h3&gt;
There are many convenient keybinds that may help you out throughout your journey.
&lt;ul&gt;
    &lt;li&gt;&#39;&#39;C&#39;&#39;: Controls&lt;/li&gt;
    &lt;li&gt;&#39;&#39;E&#39;&#39;: Character menu&lt;/li&gt;
    &lt;li&gt;&#39;&#39;Q&#39;&#39;: Quest journal&lt;/li&gt;
    &lt;li&gt;&#39;&#39;S&#39;&#39;: Saves&lt;/li&gt;
    &lt;li&gt;&#39;&#39;T&#39;&#39;: Provides information about current location including things to 
        do as well as some lore.
    &lt;/li&gt;
    &lt;li&gt;&#39;&#39;X / ESC&#39;&#39;: Settings menu&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="136" name="info" tags="" position="725,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;info&quot; class=&quot;subbackground&quot; style=&quot;grid-row: 1 / span 3; grid-column: 4 / span 1&quot;&gt;
    &lt;&lt;include infoNoSubbackground&gt;&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="137" name="infoLog" tags="" position="850,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div id=&quot;infoLog&quot; class=&quot;mainLog hidden&quot;&gt;
    &lt;center&gt;
        &lt;div style=&quot;margin: 20px&quot;&gt;
            &lt;b id=&quot;info_title&quot;&gt;&lt;/b&gt;&lt;br&gt;
        &lt;/div&gt;
    &lt;/center&gt;
    &lt;p id=&quot;infoLogBody&quot;&gt;
    &lt;/p&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="138" name="infoNoSubbackground" tags="" position="975,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;div class=&quot;container threeRow&quot; style=&quot;font-weight: normal; height: 100%; width: 100%&quot;&gt;
    &lt;center&gt;
        &lt;h3 style=&quot;margin-bottom:0&quot;&gt;&lt;&lt;= setup.locations.get(passage()).name&gt;&gt;&lt;/h3&gt;
        &lt;p style=&quot;margin: 0&quot;&gt;
            &lt;&lt;= setup.locations.get_sub_address(passage())&gt;&gt;
        &lt;/p&gt;
        &lt;br&gt;
        &lt;div id=&quot;datetime&quot;&gt;
            &lt;&lt;time12hr&gt;&gt;
            &lt;br&gt;
            &lt;&lt;date&gt;&gt;
        &lt;/div&gt;
    &lt;/center&gt;

    &lt;center&gt;
        &lt;&lt;set _selected_status = $player.get_status()&gt;&gt;
        &lt;&lt;if _selected_status == null&gt;&gt;
            &lt;&lt;set _selected_status = &quot;unknown&quot;&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &#39;&#39;Status:&#39;&#39; &lt;span id=&quot;status&quot; class=&quot;tooltip&quot;&gt;&lt;&lt;= setup.titleCase(_selected_status)&gt;&gt;&lt;/span&gt;
        &lt;&lt;on &quot;click&quot; &quot;#status&quot;&gt;&gt;
            &lt;&lt;popover&gt;&gt;
                &lt;&lt;include statusTutorial&gt;&gt;
            &lt;&lt;/popover&gt;&gt;
        &lt;&lt;/on&gt;&gt;
        &lt;br&gt;
        &lt;div id=&quot;money&quot;&gt;
            &#39;&#39;Money:&#39;&#39; ¤&lt;&lt;money&gt;&gt;
        &lt;/div&gt;
    &lt;/center&gt;

    &lt;center style=&quot;padding: 20px&quot;&gt;
        &lt;&lt;include round&gt;&gt;
        &lt;&lt;showmeter &quot;player_health_bar&quot; `$player.conditions.health/$player.conditions.max_health`&gt;&gt;
        &lt;&lt;showmeter &quot;player_stamina_bar&quot; `$player.conditions.stamina/$player.conditions.max_stamina`&gt;&gt;
        &lt;&lt;if $player.is_slave&gt;&gt;
            &lt;&lt;showmeter &quot;player_willpower_bar&quot; `$player.slave_traits.willpower/100`&gt;&gt;
            &lt;&lt;showmeter &quot;player_trust_bar&quot; `$player.slave_traits.trust/100`&gt;&gt;
            &lt;&lt;showmeter &quot;player_obedience_bar&quot; `$player.slave_traits.obedience/100`&gt;&gt;
        &lt;&lt;/if&gt;&gt;

        &lt;div id=&quot;quickbar&quot; class=&quot;menubar&quot;&gt;
            &lt;&lt;button &quot;C&quot;&gt;&gt;
                &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
                &lt;&lt;popover&gt;&gt;
                    &lt;&lt;include controls&gt;&gt;
                &lt;&lt;/popover&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;&lt;button &quot;E&quot;&gt;&gt;
                /* Go to character menu (E) */
                &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
                &lt;&lt;if $enable_menu&gt;&gt;
                    &lt;&lt;if !$in_menu&gt;&gt;
                        &lt;&lt;set $last_visited = passage()&gt;&gt;
                        &lt;&lt;set $in_menu = true&gt;&gt;
                        &lt;&lt;saveVars&gt;&gt;
                        &lt;&lt;goto playerMenu&gt;&gt;
                    &lt;&lt;elseif passage() != &quot;playerMenu&quot;&gt;&gt;
                        &lt;&lt;goto playerMenu&gt;&gt;
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set $in_menu = false&gt;&gt;
                        &lt;&lt;goto $last_visited&gt;&gt;
                        &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt;
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;&lt;button &quot;Q&quot;&gt;&gt;
                &lt;&lt;popover&gt;&gt;
                    &lt;&lt;include questMenu&gt;&gt;
                &lt;&lt;/popover&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;&lt;button &quot;S&quot;&gt;&gt;
                &lt;&lt;if $enable_menu&gt;&gt;
                    &lt;&lt;ui &quot;saves&quot;&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;&lt;button &quot;T&quot;&gt;&gt;
                /* See tutorial for passage (T) */
                &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
                &lt;&lt;if passage() in $tutorials&gt;&gt;
                    &lt;&lt;popover&gt;&gt;
                        &lt;&lt;include $tutorials[passage()]&gt;&gt;
                    &lt;&lt;/popover&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/button&gt;&gt;
            &lt;&lt;button &quot;X&quot;&gt;&gt;
                /* Go to save and settings menu (ESC) */
                &lt;&lt;script&gt;&gt;Dialog.close();&lt;&lt;/script&gt;&gt;
                &lt;&lt;if $enable_menu&gt;&gt;
                    &lt;&lt;if !$in_menu&gt;&gt;
                        &lt;&lt;set $last_visited = passage()&gt;&gt;
                        &lt;&lt;set $in_menu = true&gt;&gt;
                        &lt;&lt;saveVars&gt;&gt;
                        &lt;&lt;goto settingsMenu&gt;&gt;
                    &lt;&lt;elseif passage() != &quot;settingsMenu&quot;&gt;&gt;
                        &lt;&lt;goto settingsMenu&gt;&gt; 
                    &lt;&lt;else&gt;&gt;
                        &lt;&lt;set $in_menu = false&gt;&gt;
                        &lt;&lt;goto $last_visited&gt;&gt;
                        &lt;&lt;set $last_visited = &quot;&quot;&gt;&gt;   
                    &lt;&lt;/if&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/button&gt;&gt;
        &lt;/div&gt;

    &lt;/center&gt;
&lt;/div&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="139" name="locationButton" tags="" position="1100,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
&lt;&lt;if ndef _location_button_text&gt;&gt;
    &lt;&lt;set _location_button_text = setup.locations.get(_location_button_dest).name&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;if tale.has(_location_button_dest)&gt;&gt;
    &lt;&lt;if setup.locations.get(_location_button_dest).has_access()&gt;&gt;
        &lt;&lt;capture [_location_button_dest _location_button_sound _location_button_dur]&gt;&gt;
            &lt;&lt;button _location_button_text _location_button_dest&gt;&gt;
                &lt;&lt;if def _location_button_sound&gt;&gt;
                    &lt;&lt;audio _location_button_sound play&gt;&gt;
                &lt;&lt;/if&gt;&gt;
                &lt;&lt;if def _location_button_dur&gt;&gt;
                    &lt;&lt;set _roll = dice(1, 1 + parseInt(_location_button_dur / 4)) + _location_button_dur&gt;&gt;
                    &lt;&lt;addmins _roll&gt;&gt;
                    &lt;&lt;unset _roll&gt;&gt;
                &lt;&lt;elseif _location_button_dest in setup.locations.get(passage()).distance&gt;&gt;
                    &lt;&lt;set _location_button_dur = setup.locations.get(passage()).distance[_location_button_dest]&gt;&gt;
                    &lt;&lt;set _roll = dice(1, 1 + parseInt(_location_button_dur / 4)) + _location_button_dur&gt;&gt;
                    &lt;&lt;addmins _roll&gt;&gt;
                    &lt;&lt;unset _roll&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;/button&gt;&gt;
        &lt;&lt;/capture&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;disable&gt;&gt;
            &lt;&lt;button _location_button_text _location_button_dest&gt;&gt;&lt;&lt;/button&gt;&gt;
        &lt;&lt;/disable&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;else&gt;&gt;
    &lt;&lt;disable&gt;&gt;
        &lt;&lt;button _location_button_text&gt;&gt;
            &lt;&lt;notify&gt;&gt;Under Construction&lt;&lt;/notify&gt;&gt;
        &lt;&lt;/button&gt;&gt;
    &lt;&lt;/disable&gt;&gt;
&lt;&lt;/if&gt;&gt;
&lt;&lt;unset _location_button_text&gt;&gt;
&lt;&lt;unset _location_button_dest&gt;&gt;
&lt;&lt;unset _location_button_sound&gt;&gt;
&lt;&lt;unset _location_button_dur&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="140" name="mainLog" tags="" position="1225,1725" size="100,100">&lt;&lt;nobr&gt;&gt;
    &lt;div id=&quot;mainLogImageContainer&quot; class=&quot;mainLogImageContainer&quot;&gt;
        &lt;div id=&quot;mainLogImage&quot; class=&quot;mainLogImage&quot;&gt;&lt;/div&gt;
        &lt;div id=&quot;mainLogCharacterImage&quot; class=&quot;mainLogCharacterImage&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div id=&quot;mainLog&quot; class=&quot;mainLog&quot;&gt;
        &lt;b&gt;
            &lt;&lt;= setup.titleCase(setup.locations.get(passage()).name)&gt;&gt;:
        &lt;/b&gt;&lt;br&gt;
    &lt;/div&gt;
    &lt;&lt;script&gt;&gt;
        setTimeout(function() {
            var gameDate = State.variables.gameDate;
            var time = &quot;Day&quot;;
            if (setup.is_night(gameDate)) {
                time = &quot;Night&quot;;
            }
            setup.mainLog_append(State.variables._to_log);
            $(&quot;#mainLogImage&quot;).css(&quot;background-image&quot;, &quot;url(\&quot;resources/images/places/&quot; + 
                passage() + time + &quot;Image.png\&quot;)&quot;);
        }, 10);
    &lt;&lt;/script&gt;&gt;
&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="141" name="disableActions" tags="widget" position="100,1850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;widget &quot;disableactions&quot;&gt;&gt;
    /* Hide back and leave buttons */
    &lt;&lt;if ndef _disable_buttons || _disable_buttons&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;addclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;removeclass &quot;#events_actions_back&quot; &quot;hidden&quot;&gt;&gt;
        &lt;&lt;removeclass &quot;#events_actions_leave&quot; &quot;hidden&quot;&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;if def $args[0] &amp;&amp; $args[0] instanceof jQuery&gt;&gt;

        &lt;&lt;for _i = 1; _i lt 9; _i++&gt;&gt;
            &lt;&lt;if $args[0].find(&quot;#li&quot; + _i).length gt 0&gt;&gt;
                &lt;&lt;if $args[0].find(&quot;#li&quot; + _i).css(&quot;text-decoration&quot;) == &quot;line-through&quot;&gt;&gt;
                    &lt;&lt;run $(&quot;#events&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                    &lt;&lt;addclass `&quot;#events&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;run $(&quot;#events&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
                    &lt;&lt;removeclass `&quot;#events&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;run $(&quot;#events&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
                &lt;&lt;addclass `&quot;#events&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/for&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;for _i = 1; _i lt _choices + 1; _i++&gt;&gt;
            &lt;&lt;run $(&quot;#events&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, false)&gt;&gt;
            &lt;&lt;removeclass `&quot;#events&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
        &lt;&lt;/for&gt;&gt;

        &lt;&lt;for _i = _choices + 1; _i lt 9; _i++&gt;&gt;
            &lt;&lt;run $(&quot;#events&quot; + _i + &quot; button&quot;).prop(&quot;disabled&quot;, true)&gt;&gt;
            &lt;&lt;addclass `&quot;#events&quot; + _i + &quot; button&quot;` &quot;disabled&quot;&gt;&gt;
        &lt;&lt;/for&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;unset _choices&gt;&gt;
    &lt;&lt;unset _disable_buttons&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="142" name="money" tags="widget" position="225,1850" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Gets money that player has */
&lt;&lt;widget &quot;money&quot;&gt;&gt;&lt;&lt;= setup.round2(UInv.BagHasItem(&quot;inventory&quot;, &quot;lari&quot;) + UInv.BagHasItem(&quot;inventory&quot;, &quot;tetri&quot;) / 100)&gt;&gt;&lt;&lt;/widget&gt;&gt;

/* Converts as much tetri in lari as possible */
&lt;&lt;widget &quot;simplifymoney&quot;&gt;&gt;
    &lt;&lt;set _temp = UInv.BagHasItem(&quot;inventory&quot;, &quot;tetri&quot;)&gt;&gt;
    &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;lari&quot;, parseInt(_temp / 100))&gt;&gt;
    &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, &quot;tetri&quot;, 100 * parseInt(_temp / 100))&gt;&gt;
    &lt;&lt;unset _temp&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Converts all lari into tetri */
&lt;&lt;widget &quot;expandmoney&quot;&gt;&gt;
    &lt;&lt;set _temp = UInv.BagHasItem(&quot;inventory&quot;, &quot;lari&quot;)&gt;&gt;
    &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;tetri&quot;, _temp * 100)&gt;&gt;
    &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, &quot;lari&quot;, _temp)&gt;&gt;
    &lt;&lt;unset _temp&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Adds money to player inventory */
&lt;&lt;widget &quot;addmoney&quot;&gt;&gt;
    &lt;&lt;run UInv.AddItem(&quot;inventory&quot;, &quot;tetri&quot;, parseInt($args[0] * 100))&gt;&gt;
    &lt;&lt;set $player.finances.total_earned += parseFloat($args[0])&gt;&gt;
    &lt;&lt;simplifymoney&gt;&gt;
&lt;&lt;/widget&gt;&gt;

/* Removes money to player inventory */
&lt;&lt;widget &quot;removemoney&quot;&gt;&gt;
    &lt;&lt;expandmoney&gt;&gt;
    &lt;&lt;run UInv.DeleteItem(&quot;inventory&quot;, &quot;tetri&quot;, parseInt($args[0] * 100))&gt;&gt;
    &lt;&lt;simplifymoney&gt;&gt;
&lt;&lt;/widget&gt;&gt;


&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="143" name="round" tags="" position="350,1850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;set $player.round = {}&gt;&gt;
&lt;&lt;set $player.round.stats = {}&gt;&gt;
&lt;&lt;for _key, _val range $player.stats&gt;&gt;
    &lt;&lt;set $player.round.stats[_key] = setup.round2(_val)&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;set $player.round.conditions = {}&gt;&gt;
&lt;&lt;for _key, _val range $player.conditions&gt;&gt;
    &lt;&lt;if !_key.startsWith(&quot;max_&quot;)&gt;&gt;
        &lt;&lt;set $player.conditions[_key] = Math.clamp(_val, 0, $player.conditions[&quot;max_&quot; + _key])&gt;&gt;
    &lt;&lt;/if&gt;&gt;
    &lt;&lt;set $player.round.conditions[_key] = setup.round2($player.conditions[_key])&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;set $player.round.mental_conditions = {}&gt;&gt;
&lt;&lt;for _key, _val range $player.mental_conditions&gt;&gt;
    &lt;&lt;set $player.mental_conditions[_key] = Math.clamp(_val, 0, 100)&gt;&gt;
    &lt;&lt;set $player.round.mental_conditions[_key] = setup.round2($player.mental_conditions[_key])&gt;&gt;
&lt;&lt;/for&gt;&gt;

&lt;&lt;set $player.round.slave_traits = {}&gt;&gt;
&lt;&lt;for _key, _val range $player.slave_traits&gt;&gt;
    &lt;&lt;set $player.slave_traits[_key] = Math.clamp(_val, 0, 100)&gt;&gt;
    &lt;&lt;set $player.round.slave_traits[_key] = setup.round2($player.slave_traits[_key])&gt;&gt;
&lt;&lt;/for&gt;&gt;

/* Clamp all other character stats */
&lt;&lt;if def _to_round&gt;&gt;
    &lt;&lt;set _val = $characters[_to_round]&gt;&gt;
    &lt;&lt;set _val.round = {}&gt;&gt;
    &lt;&lt;set _val.round.conditions = {}&gt;&gt;
    &lt;&lt;for _key2, _val2 range _val.conditions&gt;&gt;
        &lt;&lt;if !_key2.startsWith(&quot;max_&quot;)&gt;&gt;
            &lt;&lt;set _val.conditions[_key2] = Math.clamp(_val2, 0, _val.conditions[&quot;max_&quot; + _key2])&gt;&gt;
            &lt;&lt;set _val.round.conditions[_key2] = setup.round2(_val.conditions[_key2])&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    &lt;&lt;set _val.round.slave_traits = {}&gt;&gt;
    &lt;&lt;for _key2, _val2 range _val.slave_traits&gt;&gt;
        &lt;&lt;if _key2 == &quot;trust&quot;&gt;&gt;
            &lt;&lt;set _val.slave_traits[_key2] = Math.clamp(_val2, -100, 100)&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;set _val.slave_traits[_key2] = Math.clamp(_val2, 0, 100)&gt;&gt;
        &lt;&lt;/if&gt;&gt;
        &lt;&lt;set _val.round.slave_traits[_key2] = setup.round2(_val.slave_traits[_key2])&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    &lt;&lt;set _val.round.mental_conditions = {}&gt;&gt;
    &lt;&lt;for _key2, _val2 range _val.mental_conditions&gt;&gt;
        &lt;&lt;set _val.mental_conditions[_key2] = Math.clamp(_val2, 0, 100)&gt;&gt;
        &lt;&lt;set _val.round.mental_conditions[_key2] = setup.round2(_val.mental_conditions[_key2])&gt;&gt;
    &lt;&lt;/for&gt;&gt;

    &lt;&lt;for _key2, _val2 range _val.physical_conditions&gt;&gt;
        &lt;&lt;set _val.physical_conditions[_key2] = Math.clamp(_val2, 0, 100)&gt;&gt;
    &lt;&lt;/for&gt;&gt;
    &lt;&lt;unset _to_round&gt;&gt;
    &lt;&lt;unset _val&gt;&gt;
&lt;&lt;/if&gt;&gt;

/* Update bars with new values */
&lt;&lt;include updateBars&gt;&gt;

/* Update max carry weight */
&lt;&lt;run UInv.SetBagPropertyValue(&quot;inventory&quot;, &quot;maxCarryWeight&quot;, $player.stats.strength)&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="144" name="saveVars" tags="widget" position="475,1850" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Saves some variables if they exist */
&lt;&lt;widget &quot;saveVars&quot;&gt;&gt;
    &lt;&lt;if !($_to_log === undefined)&gt;&gt;
        &lt;&lt;set $_temp_to_log = $_to_log&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;widget &quot;loadVars&quot;&gt;&gt;
    &lt;&lt;if !($_temp_to_log === undefined)&gt;&gt;
        &lt;&lt;set $_to_log = $_temp_to_log&gt;&gt;
        &lt;&lt;unset $_temp_to_log&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="145" name="updateBars" tags="" position="600,1850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;updatemeter &quot;player_health_bar&quot; `$player.conditions.health / $player.conditions.max_health`&gt;&gt;
&lt;&lt;updatemeter &quot;player_stamina_bar&quot; `$player.conditions.stamina / $player.conditions.max_stamina`&gt;&gt;

&lt;&lt;if $player.is_slave&gt;&gt;
    &lt;&lt;updatemeter &quot;player_willpower_bar&quot; `$player.slave_traits.willpower / 100`&gt;&gt;
    &lt;&lt;updatemeter &quot;player_trust_bar&quot; `$player.slave_traits.trust / 100`&gt;&gt;
    &lt;&lt;updatemeter &quot;player_obedience_bar&quot; `$player.slave_traits.obedience / 100`&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if def _is_molesting &amp;&amp; _is_molesting&gt;&gt;
    &lt;&lt;updatemeter &quot;player_arousal_bar&quot; `$player.mental_conditions.arousal / 50`&gt;&gt;
    &lt;&lt;updatemeter &quot;char_arousal_bar&quot; `_char.mental_conditions.arousal / 50`&gt;&gt;
    &lt;&lt;updatemeter &quot;char_suspicion_bar&quot; `_char.mental_conditions.suspicion / 50`&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;if def _is_fucking &amp;&amp; _is_fucking&gt;&gt;
    &lt;&lt;updatemeter &quot;player_arousal_bar&quot; `$player.mental_conditions.arousal / 50`&gt;&gt;
    &lt;&lt;updatemeter &quot;char_anger_bar&quot; `_char.mental_conditions.anger / 100`&gt;&gt;
    &lt;&lt;updatemeter &quot;char_arousal_bar&quot; `_char.mental_conditions.arousal / 50`&gt;&gt;
    &lt;&lt;updatemeter &quot;char_discomfort_bar&quot; `_char.mental_conditions.discomfort / 50`&gt;&gt;
    &lt;&lt;updatemeter &quot;char_stamina_bar&quot; `_char.conditions.stamina / _char.conditions.max_stamina`&gt;&gt;
    &lt;&lt;updatemeter &quot;char_willpower_bar&quot; `_char.slave_traits.willpower / 100`&gt;&gt;
&lt;&lt;/if&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="146" name="updateCommodities" tags="widget" position="725,1850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;widget &quot;updatecommodities&quot;&gt;&gt;
    &lt;&lt;set _year_start = new Date($gameDate.getFullYear(), 0, 0)&gt;&gt;
    &lt;&lt;set _diff = $gameDate - _year_start&gt;&gt;
    &lt;&lt;set _day = _diff / (1000 * 60 * 60 * 24)&gt;&gt;
    &lt;&lt;set _sigma = $commodities[$args[0]].stable_price * $commodities[$args[0]].sigma_ratio&gt;&gt;
    &lt;&lt;set _theta = Math.exp(-1 * $difficulty)&gt;&gt;
    &lt;&lt;set _mu = _sigma * Math.sin(2 * Math.PI / 356 * _day + $commodities[$args[0]].mu_phase) + $commodities[_key].stable_price&gt;&gt;
    /* dmu / dt */
    &lt;&lt;set _trend = _sigma * 2 * Math.PI / 356 * Math.cos(2 * Math.PI / 356 * _day + $commodities[$args[0]].mu_phase)&gt;&gt;

    &lt;&lt;set $buy_price = setup.round2($commodities[$args[0]].price * (1 + _halfspread))&gt;&gt;
    &lt;&lt;set $sell_price = setup.round2($commodities[$args[0]].price * (1 - _halfspread))&gt;&gt;

    &lt;&lt;set $(&quot;#commodity_name&quot;).html(setup.titleCase($commodities[$args[0]].name))&gt;&gt;
    &lt;&lt;set $(&quot;#commodity_spread&quot;).html(setup.round2(2 * _halfspread * 100) + &quot;%&quot;)&gt;&gt;
    &lt;&lt;set $(&quot;#commodity_buy_price&quot;).html(&quot;¤&quot; + $buy_price)&gt;&gt;
    &lt;&lt;set $(&quot;#commodity_sell_price&quot;).html(&quot;¤&quot; + $sell_price)&gt;&gt;

    &lt;&lt;if $player.titles.has(&quot;trade_union_patron&quot;) &amp;&amp; passage().substring(passage().length - 10) == &quot;TradeUnion&quot;&gt;&gt;
        &lt;&lt;set $(&quot;#commodity_stats&quot;).html(
            UInv.BagHasItem(&quot;inventory&quot;, $args[0]) + &quot;&lt;br&gt;&quot; +
            setup.round2($commodities[$args[0]].price) + &quot;&lt;br&gt;&quot; +
            setup.round2(_sigma) + &quot;&lt;br&gt;&quot; +
            setup.round2(_theta) + &quot;&lt;br&gt;&quot; +
            setup.round2(_mu) + &quot;&lt;br&gt;&quot; +
            setup.round2(_trend)
        )&gt;&gt;
    &lt;&lt;else&gt;&gt;
        &lt;&lt;set $(&quot;#commodity_stats&quot;).html(
            UInv.BagHasItem(&quot;inventory&quot;, $args[0]) + &quot;&lt;br&gt;&quot; +
            setup.round2($commodities[$args[0]].price) + &quot;&lt;br&gt;&quot; +
            setup.round2(_sigma) + &quot;&lt;br&gt;&quot; +
            &quot;---&lt;br&gt;&quot; +
            &quot;---&lt;br&gt;&quot; +
            &quot;---&quot;
        )&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;script&gt;&gt;
        $(&quot;#mainLog&quot;).addClass(&quot;hidden&quot;);
        $(&quot;#commodityLog&quot;).removeClass(&quot;hidden&quot;);
        $(&quot;#back_button&quot;).addClass(&quot;hidden&quot;);
        $(&quot;#back_to_options_button&quot;).removeClass(&quot;hidden&quot;);
        $(&quot;.to_hide&quot;).addClass(&quot;hidden&quot;);
    &lt;&lt;/script&gt;&gt;

    /* Disable buttons according to holding and money */
    &lt;&lt;script&gt;&gt;
        var player = State.variables.player;
        var selected = State.variables.args[0];
        var buy_price = State.variables.buy_price;
        var sell_price = State.variables.sell_price;
        $(&quot;#buy1 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#buy1 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#buy5 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#buy5 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#buy20 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#buy20 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#buy50 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#buy50 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#buy100 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#buy100 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#buyall button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#buyall button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#sell1 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#sell1 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#sell5 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#sell5 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#sell20 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#sell20 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#sell50 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#sell50 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#sell100 button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#sell100 button&quot;).addClass(&quot;disabled&quot;);
        $(&quot;#sellall button&quot;).prop(&quot;disabled&quot;, true);
        $(&quot;#sellall button&quot;).addClass(&quot;disabled&quot;);
        if (player.get_money() &gt;= buy_price) {
            $(&quot;#buy1 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#buy1 button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#buyall button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#buyall button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (player.get_money() &gt;= 5 * buy_price) {
            $(&quot;#buy5 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#buy5 button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (player.get_money() &gt;= 20 * buy_price) {
            $(&quot;#buy20 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#buy20 button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (player.get_money() &gt;= 50 * buy_price) {
            $(&quot;#buy50 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#buy50 button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (player.get_money() &gt;= 100 * buy_price) {
            $(&quot;#buy100 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#buy100 button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (UInv.BagHasItem(&quot;inventory&quot;, selected) &gt;= 1) {
            $(&quot;#sell1 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#sell1 button&quot;).removeClass(&quot;disabled&quot;);
            $(&quot;#sellall button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#sellall button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (UInv.BagHasItem(&quot;inventory&quot;, selected) &gt;= 5) {
            $(&quot;#sell5 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#sell5 button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (UInv.BagHasItem(&quot;inventory&quot;, selected) &gt;= 20) {
            $(&quot;#sell20 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#sell20 button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (UInv.BagHasItem(&quot;inventory&quot;, selected) &gt;= 50) {
            $(&quot;#sell50 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#sell50 button&quot;).removeClass(&quot;disabled&quot;);
        }
        if (UInv.BagHasItem(&quot;inventory&quot;, selected) &gt;= 100) {
            $(&quot;#sell100 button&quot;).prop(&quot;disabled&quot;, false);
            $(&quot;#sell100 button&quot;).removeClass(&quot;disabled&quot;);
        }
    &lt;&lt;/script&gt;&gt;

    &lt;&lt;updatetime&gt;&gt;

    &lt;&lt;unset _year_start&gt;&gt;
    &lt;&lt;unset _diff&gt;&gt;
    &lt;&lt;unset _day&gt;&gt;
    &lt;&lt;unset _sigma&gt;&gt;
    &lt;&lt;unset _theta&gt;&gt;
    &lt;&lt;unset _mu&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="147" name="updateQuests" tags="widget" position="850,1850" size="100,100">&lt;&lt;nobr&gt;&gt;

&lt;&lt;widget &quot;updatequests&quot;&gt;&gt;
    &lt;&lt;if !$quest_journal.completed.includes(&quot;life_of_a_slave&quot;)&gt;&gt;
        &lt;&lt;if $player.get_status(&quot;nipon&quot;) == &quot;low_slave&quot;&gt;&gt;
            &lt;&lt;set $quests.life_of_a_slave.stage = 0&gt;&gt;
        &lt;&lt;else&gt;&gt;
            &lt;&lt;if $has_access.has(&quot;niponCentral&quot;)&gt;&gt;
                &lt;&lt;if $player.get_status(&quot;nipon&quot;) == &quot;high_slave&quot;&gt;&gt;
                    &lt;&lt;run setup.remove_val($quest_journal.ongoing, &quot;life_of_a_slave&quot;)&gt;&gt;
                    &lt;&lt;set $quest_journal.completed.push(&quot;life_of_a_slave&quot;)&gt;&gt;
                &lt;&lt;else&gt;&gt;
                    &lt;&lt;set $quests.life_of_a_slave.stage = 2&gt;&gt;
                &lt;&lt;/if&gt;&gt;
            &lt;&lt;else&gt;&gt;
                &lt;&lt;set $quests.life_of_a_slave.stage = 1&gt;&gt;
            &lt;&lt;/if&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;

    &lt;&lt;if !$quest_journal.completed.includes(&quot;knowledge_is_power&quot;)&gt;&gt;
        &lt;&lt;if $has_access.has(&quot;shintaniHomeLibrary&quot;)&gt;&gt;
            &lt;&lt;set $quests.knowledge_is_power.stage = 2&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/if&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata><tw-passagedata pid="148" name="updateStatus" tags="widget" position="975,1850" size="100,100">&lt;&lt;nobr&gt;&gt;

/* Gives knowledge of all slaves of lower status */

&lt;&lt;widget &quot;updatestatus&quot;&gt;&gt;
    &lt;&lt;set _status = setup.HEIRARCHY[$player.get_status(&quot;nipon&quot;)]&gt;&gt;
    &lt;&lt;for _idx, _val range $characters.shintani_hiroyuki.slaves&gt;&gt;
        &lt;&lt;if _status gt setup.HEIRARCHY[$characters[_val].status]&gt;&gt;
            &lt;&lt;set $characters[_val].stats_known = true&gt;&gt;
            &lt;&lt;set $characters[_val].skills_known = true&gt;&gt;
        &lt;&lt;/if&gt;&gt;
    &lt;&lt;/for&gt;&gt;
&lt;&lt;/widget&gt;&gt;

&lt;&lt;/nobr&gt;&gt;</tw-passagedata></tw-storydata>
	<script id="script-sugarcube" type="text/javascript">
	/*! SugarCube JS */
	if(document.documentElement.getAttribute("data-init")==="loading"){(function(window,document,jQuery,undefined){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}var errorPrologRegExp=/^(?:(?:uncaught\s+(?:exception:\s+)?)?\w*(?:error|exception|_err):\s+)+/i,Alert=function(){function mesg(where,error,isFatal,isUncaught){var mesg="Error",nice="A".concat(isFatal?" fatal":"n"," error has occurred.");nice+=isFatal?" Aborting.":" You may be able to continue, but some parts may not work properly.";var isObject=null!==error&&"object"===_typeof(error),what=(isObject&&"message"in error?String(error.message).replace(errorPrologRegExp,""):String(error)).trim()||"unknown error";null!=where&&(mesg+=" [".concat(where,"]")),mesg+=": ".concat(what,"."),isObject&&"stack"in error&&(mesg+="\n\nStack Trace:\n".concat(error.stack)),mesg&&(nice+="\n\n".concat(mesg)),isUncaught||console[isFatal?"error":"warn"](mesg),window.alert(nice)}var origOnError;return origOnError=window.onerror,window.onerror=function(what,source,lineNum,colNum,error){"complete"===document.readyState?mesg(null,null!=error?error:what,!1,!0):(mesg(null,null!=error?error:what,!0,!0),window.onerror=origOnError,"function"==typeof window.onerror&&window.onerror.apply(this,arguments))},Object.freeze(Object.defineProperties({},{error:{value:function(where,error){mesg(where,error)}},fatal:{value:function(where,error){mesg(where,error,!0)}}}))}(),Patterns=(wsMap=new Map([[" ","\\u0020"],["\f","\\f"],["\n","\\n"],["\r","\\r"],["\t","\\t"],["\v","\\v"],[" ","\\u00a0"],[" ","\\u1680"],["᠎","\\u180e"],[" ","\\u2000"],[" ","\\u2001"],[" ","\\u2002"],[" ","\\u2003"],[" ","\\u2004"],[" ","\\u2005"],[" ","\\u2006"],[" ","\\u2007"],[" ","\\u2008"],[" ","\\u2009"],[" ","\\u200a"],["\u2028","\\u2028"],["\u2029","\\u2029"],[" ","\\u202f"],[" ","\\u205f"],["　","\\u3000"],["\ufeff","\\ufeff"]]),wsRe=/^\s$/,missing="",wsMap.forEach((function(pat,char){wsRe.test(char)||(missing+=pat)})),space=missing?"[\\s".concat(missing,"]"):"\\s",spaceNoTerminator="[\\u0020\\f\\t\\v\\u00a0\\u1680\\u180e\\u2000-\\u200a\\u202f\\u205f\\u3000\\ufeff]",notSpace="\\s"===space?"\\S":space.replace(/^\[/,"[^"),anyChar="(?:.|".concat("[\\n\\r\\u2028\\u2029]",")"),anyLetter="[0-9A-Z_a-z\\-\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u00ff\\u0150\\u0170\\u0151\\u0171]",anyLetterStrict=anyLetter.replace("\\-",""),identifier="".concat("[$A-Z_a-z]").concat("[$0-9A-Z_a-z]","*"),variable="[$_]"+identifier,htmlTagName="[A-Za-z](?:".concat(cENChar="(?:[\\x2D.0-9A-Z_a-z\\xB7\\xC0-\\xD6\\xD8-\\xF6\\xF8-\\u037D\\u037F-\\u1FFF\\u200C\\u200D\\u203F\\u2040\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD]|[\\uD800-\\uDB7F][\\uDC00-\\uDFFF])","*-").concat(cENChar,"*|[0-9A-Za-z]*)"),twStyle="(".concat(anyLetter,"+)\\(([^\\)\\|\\n]+)\\):"),cssStyle="".concat(spaceNoTerminator,"*(").concat(anyLetter,"+)").concat(spaceNoTerminator,"*:([^;\\|\\n]+);"),idOrClass="".concat(spaceNoTerminator,"*((?:").concat("[#.]").concat(anyLetter,"+").concat(spaceNoTerminator,"*)+);"),inlineCss="".concat(twStyle,"|").concat(cssStyle,"|").concat(idOrClass),Object.freeze({space:space,spaceNoTerminator:spaceNoTerminator,lineTerminator:"[\\n\\r\\u2028\\u2029]",notSpace:notSpace,anyChar:anyChar,anyLetter:anyLetter,anyLetterStrict:anyLetterStrict,identifierFirstChar:"[$A-Z_a-z]",identifierNextChar:"[$0-9A-Z_a-z]",identifier:identifier,variableSigil:"[$_]",variable:variable,macroName:"[A-Za-z][\\w-]*|[=-]",templateName:"[A-Za-z][\\w-]*",htmlTagName:htmlTagName,cssIdOrClassSigil:"[#.]",cssImage:"\\[[<>]?[Ii][Mm][Gg]\\[(?:\\s|\\S)*?\\]\\]+",inlineCss:inlineCss,url:"(?:file|https?|mailto|ftp|javascript|irc|news|data):[^\\s'\"]+"})),wsMap,wsRe,missing,cENChar,twStyle,cssStyle,idOrClass,space,spaceNoTerminator,notSpace,anyChar,anyLetter,anyLetterStrict,identifier,variable,htmlTagName,inlineCss;!function(){var startWSRe,endWSRe,_trimString=(startWSRe=new RegExp("^".concat(Patterns.space).concat(Patterns.space,"*")),endWSRe=new RegExp("".concat(Patterns.space).concat(Patterns.space,"*$")),function(str,where){var val=String(str);if(!val)return val;switch(where){case"start":return startWSRe.test(val)?val.replace(startWSRe,""):val;case"end":return endWSRe.test(val)?val.replace(endWSRe,""):val;default:throw new Error('_trimString called with incorrect where parameter value: "'.concat(where,'"'))}});function _createPadString(length,padding){var targetLength=Number.parseInt(length,10)||0;if(targetLength<1)return"";var padString=void 0===padding?"":String(padding);for(""===padString&&(padString=" ");padString.length<targetLength;){var curPadLength=padString.length,remainingLength=targetLength-curPadLength;padString+=curPadLength>remainingLength?padString.slice(0,remainingLength):padString}return padString.length>targetLength&&(padString=padString.slice(0,targetLength)),padString}Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,writable:!0,value:function flat(){if(null==this)throw new TypeError("Array.prototype.flat called on null or undefined");var depth=0===arguments.length?1:Number(arguments[0])||0;return depth<1?Array.prototype.slice.call(this):Array.prototype.reduce.call(this,(function(acc,cur){return cur instanceof Array?acc.push.apply(acc,_toConsumableArray(flat.call(cur,depth-1))):acc.push(cur),acc}),[])}}),Array.prototype.flatMap||Object.defineProperty(Array.prototype,"flatMap",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.flatMap called on null or undefined");return Array.prototype.map.apply(this,arguments).flat()}}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includes called on null or undefined");if(0===arguments.length)return!1;var length=this.length>>>0;if(0===length)return!1;var needle=arguments[0],i=Number(arguments[1])||0;for(i<0&&(i=Math.max(0,length+i));i<length;++i){var value=this[i];if(value===needle||value!=value&&needle!=needle)return!0}return!1}}),Object.entries||Object.defineProperty(Object,"entries",{configurable:!0,writable:!0,value:function(obj){if("object"!==_typeof(obj)||null===obj)throw new TypeError("Object.entries object parameter must be an object");return Object.keys(obj).map((function(key){return[key,obj[key]]}))}}),Object.fromEntries||Object.defineProperty(Object,"fromEntries",{configurable:!0,writable:!0,value:function(iter){return Array.from(iter).reduce((function(acc,pair){if(Object(pair)!==pair)throw new TypeError("Object.fromEntries iterable parameter must yield objects");return pair[0]in acc?Object.defineProperty(acc,pair[0],{configurable:!0,enumerable:!0,writable:!0,value:pair[1]}):acc[pair[0]]=pair[1],acc}),{})}}),Object.getOwnPropertyDescriptors||Object.defineProperty(Object,"getOwnPropertyDescriptors",{configurable:!0,writable:!0,value:function(obj){if(null==obj)throw new TypeError("Object.getOwnPropertyDescriptors object parameter is null or undefined");var O=Object(obj);return Reflect.ownKeys(O).reduce((function(acc,key){var desc=Object.getOwnPropertyDescriptor(O,key);return void 0!==desc&&(key in acc?Object.defineProperty(acc,key,{configurable:!0,enumerable:!0,writable:!0,value:desc}):acc[key]=desc),acc}),{})}}),Object.values||Object.defineProperty(Object,"values",{configurable:!0,writable:!0,value:function(obj){if("object"!==_typeof(obj)||null===obj)throw new TypeError("Object.values object parameter must be an object");return Object.keys(obj).map((function(key){return obj[key]}))}}),String.prototype.padStart||Object.defineProperty(String.prototype,"padStart",{configurable:!0,writable:!0,value:function(length,padding){if(null==this)throw new TypeError("String.prototype.padStart called on null or undefined");var baseString=String(this),baseLength=baseString.length,targetLength=Number.parseInt(length,10);return targetLength<=baseLength?baseString:_createPadString(targetLength-baseLength,padding)+baseString}}),String.prototype.padEnd||Object.defineProperty(String.prototype,"padEnd",{configurable:!0,writable:!0,value:function(length,padding){if(null==this)throw new TypeError("String.prototype.padEnd called on null or undefined");var baseString=String(this),baseLength=baseString.length,targetLength=Number.parseInt(length,10);return targetLength<=baseLength?baseString:baseString+_createPadString(targetLength-baseLength,padding)}}),String.prototype.trimStart||Object.defineProperty(String.prototype,"trimStart",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimStart called on null or undefined");return _trimString(this,"start")}}),String.prototype.trimLeft||Object.defineProperty(String.prototype,"trimLeft",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimLeft called on null or undefined");return _trimString(this,"start")}}),String.prototype.trimEnd||Object.defineProperty(String.prototype,"trimEnd",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimEnd called on null or undefined");return _trimString(this,"end")}}),String.prototype.trimRight||Object.defineProperty(String.prototype,"trimRight",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimRight called on null or undefined");return _trimString(this,"end")}})}(),function(){var _nativeMathRandom=Math.random,_regExpMetaCharsRe,_hasRegExpMetaCharsRe,_formatRegExp,_hasFormatRegExp;function _random(){var min,max;switch(arguments.length){case 0:throw new Error("_random called with insufficient parameters");case 1:min=0,max=arguments[0];break;default:min=arguments[0],max=arguments[1]}if(min>max){var _ref=[max,min];min=_ref[0],max=_ref[1]}return Math.floor(_nativeMathRandom()*(max-min+1))+min}function _randomIndex(length,boundsArgs){var min,max;switch(boundsArgs.length){case 1:min=0,max=length-1;break;case 2:min=0,max=Math.trunc(boundsArgs[1]);break;default:min=Math.trunc(boundsArgs[1]),max=Math.trunc(boundsArgs[2])}return Number.isNaN(min)?min=0:!Number.isFinite(min)||min>=length?min=length-1:min<0&&(min=length+min)<0&&(min=0),Number.isNaN(max)?max=0:(!Number.isFinite(max)||max>=length||max<0&&(max=length+max)<0)&&(max=length-1),_random(min,max)}function _getCodePointStartAndEnd(str,pos){var code=str.charCodeAt(pos);if(Number.isNaN(code))return{char:"",start:-1,end:-1};if(code<55296||code>57343)return{char:str.charAt(pos),start:pos,end:pos};if(code>=55296&&code<=56319){var nextPos=pos+1;if(nextPos>=str.length)throw new Error("high surrogate without trailing low surrogate");var nextCode=str.charCodeAt(nextPos);if(nextCode<56320||nextCode>57343)throw new Error("high surrogate without trailing low surrogate");return{char:str.charAt(pos)+str.charAt(nextPos),start:pos,end:nextPos}}if(0===pos)throw new Error("low surrogate without leading high surrogate");var prevPos=pos-1,prevCode=str.charCodeAt(prevPos);if(prevCode<55296||prevCode>56319)throw new Error("low surrogate without leading high surrogate");return{char:str.charAt(prevPos)+str.charAt(pos),start:prevPos,end:pos}}Object.defineProperty(Array,"random",{configurable:!0,writable:!0,value:function(array){if("object"!==_typeof(array)||null===array||!Object.prototype.hasOwnProperty.call(array,"length"))throw new TypeError("Array.random array parameter must be an array or array-lke object");var length=array.length>>>0;if(0!==length){var index=0===arguments.length?_random(0,length-1):_randomIndex(length,Array.prototype.slice.call(arguments,1));return array[index]}}}),Object.defineProperty(Array.prototype,"concatUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.concatUnique called on null or undefined");var result=Array.from(this);if(0===arguments.length)return result;var items=Array.prototype.reduce.call(arguments,(function(prev,cur){return prev.concat(cur)}),[]),addSize=items.length;if(0===addSize)return result;for(var indexOf=Array.prototype.indexOf,push=Array.prototype.push,i=0;i<addSize;++i){var value=items[i];-1===indexOf.call(result,value)&&push.call(result,value)}return result}}),Object.defineProperty(Array.prototype,"count",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.count called on null or undefined");for(var indexOf=Array.prototype.indexOf,needle=arguments[0],pos=Number(arguments[1])||0,count=0;-1!==(pos=indexOf.call(this,needle,pos));)++count,++pos;return count}}),Object.defineProperty(Array.prototype,"countWith",{configurable:!0,writable:!0,value:function(predicate,thisArg){if(null==this)throw new TypeError("Array.prototype.countWith called on null or undefined");if("function"!=typeof predicate)throw new Error("Array.prototype.countWith predicate parameter must be a function");var length=this.length>>>0;if(0===length)return 0;for(var count=0,i=0;i<length;++i)predicate.call(thisArg,this[i],i,this)&&++count;return count}}),Object.defineProperty(Array.prototype,"delete",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.delete called on null or undefined");if(0===arguments.length)return[];var length=this.length>>>0;if(0===length)return[];for(var needles=Array.prototype.concat.apply([],arguments),needlesLength=needles.length,indices=[],i=0;i<length;++i)for(var value=this[i],j=0;j<needlesLength;++j){var needle=needles[j];if(value===needle||value!=value&&needle!=needle){indices.push(i);break}}for(var result=[],_i=0,iend=indices.length;_i<iend;++_i)result[_i]=this[indices[_i]];for(var splice=Array.prototype.splice,_i2=indices.length-1;_i2>=0;--_i2)splice.call(this,indices[_i2],1);return result}}),Object.defineProperty(Array.prototype,"deleteAt",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.deleteAt called on null or undefined");if(0===arguments.length)return[];var length=this.length>>>0;if(0===length)return[];for(var splice=Array.prototype.splice,cpyIndices=_toConsumableArray(new Set(Array.prototype.concat.apply([],arguments).map((function(x){return x<0?Math.max(0,length+x):x}))).values()),delIndices=_toConsumableArray(cpyIndices).sort((function(a,b){return b-a})),result=[],i=0,iend=cpyIndices.length;i<iend;++i)result[i]=this[cpyIndices[i]];for(var _i3=0,_iend=delIndices.length;_i3<_iend;++_i3)splice.call(this,delIndices[_i3],1);return result}}),Object.defineProperty(Array.prototype,"deleteWith",{configurable:!0,writable:!0,value:function(predicate,thisArg){if(null==this)throw new TypeError("Array.prototype.deleteWith called on null or undefined");if("function"!=typeof predicate)throw new Error("Array.prototype.deleteWith predicate parameter must be a function");var length=this.length>>>0;if(0===length)return[];for(var splice=Array.prototype.splice,indices=[],result=[],i=0;i<length;++i)predicate.call(thisArg,this[i],i,this)&&(result.push(this[i]),indices.push(i));for(var _i4=indices.length-1;_i4>=0;--_i4)splice.call(this,indices[_i4],1);return result}}),Object.defineProperty(Array.prototype,"first",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.first called on null or undefined");if(0!==this.length>>>0)return this[0]}}),Object.defineProperty(Array.prototype,"includesAll",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includesAll called on null or undefined");if(1===arguments.length)return Array.isArray(arguments[0])?Array.prototype.includesAll.apply(this,arguments[0]):Array.prototype.includes.apply(this,arguments);for(var i=0,iend=arguments.length;i<iend;++i)if(!Array.prototype.some.call(this,(function(val){return val===this.val||val!=val&&this.val!=this.val}),{val:arguments[i]}))return!1;return!0}}),Object.defineProperty(Array.prototype,"includesAny",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includesAny called on null or undefined");if(1===arguments.length)return Array.isArray(arguments[0])?Array.prototype.includesAny.apply(this,arguments[0]):Array.prototype.includes.apply(this,arguments);for(var i=0,iend=arguments.length;i<iend;++i)if(Array.prototype.some.call(this,(function(val){return val===this.val||val!=val&&this.val!=this.val}),{val:arguments[i]}))return!0;return!1}}),Object.defineProperty(Array.prototype,"last",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.last called on null or undefined");var length=this.length>>>0;if(0!==length)return this[length-1]}}),Object.defineProperty(Array.prototype,"pluck",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.pluck called on null or undefined");var length=this.length>>>0;if(0!==length){var index=0===arguments.length?_random(0,length-1):_randomIndex(length,Array.prototype.slice.call(arguments));return Array.prototype.splice.call(this,index,1)[0]}}}),Object.defineProperty(Array.prototype,"pluckMany",{configurable:!0,writable:!0,value:function(wantSize){if(null==this)throw new TypeError("Array.prototype.pluckMany called on null or undefined");var length=this.length>>>0;if(0===length)return[];var want=Math.trunc(wantSize);if(!Number.isInteger(want))throw new Error("Array.prototype.pluckMany want parameter must be an integer");if(want<1)return[];want>length&&(want=length);var splice=Array.prototype.splice,result=[],max=length-1;do{result.push(splice.call(this,_random(0,max--),1)[0])}while(result.length<want);return result}}),Object.defineProperty(Array.prototype,"pushUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.pushUnique called on null or undefined");var addSize=arguments.length;if(0===addSize)return this.length>>>0;for(var indexOf=Array.prototype.indexOf,push=Array.prototype.push,i=0;i<addSize;++i){var value=arguments[i];-1===indexOf.call(this,value)&&push.call(this,value)}return this.length>>>0}}),Object.defineProperty(Array.prototype,"random",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.random called on null or undefined");var length=this.length>>>0;if(0!==length){var index=0===arguments.length?_random(0,length-1):_randomIndex(length,Array.prototype.slice.call(arguments));return this[index]}}}),Object.defineProperty(Array.prototype,"randomMany",{configurable:!0,writable:!0,value:function(wantSize){if(null==this)throw new TypeError("Array.prototype.randomMany called on null or undefined");var length=this.length>>>0;if(0===length)return[];var want=Math.trunc(wantSize);if(!Number.isInteger(want))throw new Error("Array.prototype.randomMany want parameter must be an integer");if(want<1)return[];want>length&&(want=length);var picked=new Map,result=[],max=length-1;do{var i=void 0;do{i=_random(0,max)}while(picked.has(i));picked.set(i,!0),result.push(this[i])}while(result.length<want);return result}}),Object.defineProperty(Array.prototype,"shuffle",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.shuffle called on null or undefined");var length=this.length>>>0;if(0===length)return this;for(var i=length-1;i>0;--i){var j=Math.floor(_nativeMathRandom()*(i+1));if(i!==j){var swap=this[i];this[i]=this[j],this[j]=swap}}return this}}),Object.defineProperty(Array.prototype,"unshiftUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.unshiftUnique called on null or undefined");var addSize=arguments.length;if(0===addSize)return this.length>>>0;for(var indexOf=Array.prototype.indexOf,unshift=Array.prototype.unshift,i=0;i<addSize;++i){var value=arguments[i];-1===indexOf.call(this,value)&&unshift.call(this,value)}return this.length>>>0}}),Object.defineProperty(Function.prototype,"partial",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Function.prototype.partial called on null or undefined");var slice=Array.prototype.slice,fn=this,bound=slice.call(arguments,0);return function(){for(var applied=[],argc=0,i=0;i<bound.length;++i)applied.push(bound[i]===undefined?arguments[argc++]:bound[i]);return fn.apply(this,applied.concat(slice.call(arguments,argc)))}}}),Object.defineProperty(Math,"clamp",{configurable:!0,writable:!0,value:function(num,min,max){var value=Number(num);return Number.isNaN(value)?NaN:value.clamp(min,max)}}),Object.defineProperty(Math,"easeInOut",{configurable:!0,writable:!0,value:function(num){return 1-(Math.cos(Number(num)*Math.PI)+1)/2}}),Object.defineProperty(Number.prototype,"clamp",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Number.prototype.clamp called on null or undefined");if(2!==arguments.length)throw new Error("Number.prototype.clamp called with an incorrect number of parameters");var min=Number(arguments[0]),max=Number(arguments[1]);if(min>max){var _ref2=[max,min];min=_ref2[0],max=_ref2[1]}return Math.min(Math.max(this,min),max)}}),RegExp.escape||(_regExpMetaCharsRe=/[\\^$*+?.()|[\]{}]/g,_hasRegExpMetaCharsRe=new RegExp(_regExpMetaCharsRe.source),Object.defineProperty(RegExp,"escape",{configurable:!0,writable:!0,value:function(str){var val=String(str);return val&&_hasRegExpMetaCharsRe.test(val)?val.replace(_regExpMetaCharsRe,"\\$&"):val}})),_formatRegExp=/{(\d+)(?:,([+-]?\d+))?}/g,_hasFormatRegExp=new RegExp(_formatRegExp.source),Object.defineProperty(String,"format",{configurable:!0,writable:!0,value:function(format){function padString(str,align,pad){if(!align)return str;var plen=Math.abs(align)-str.length;if(plen<1)return str;var padding=String(pad).repeat(plen);return align<0?str+padding:padding+str}if(arguments.length<2)return 0===arguments.length?"":format;var args=2===arguments.length&&Array.isArray(arguments[1])?_toConsumableArray(arguments[1]):Array.prototype.slice.call(arguments,1);return 0===args.length?format:_hasFormatRegExp.test(format)?(_formatRegExp.lastIndex=0,format.replace(_formatRegExp,(function(match,index,align){var retval=args[index];if(null==retval)return"";for(;"function"==typeof retval;)retval=retval();switch(_typeof(retval)){case"string":break;case"object":retval=JSON.stringify(retval);break;default:retval=String(retval)}return padString(retval,align?Number.parseInt(align,10):0," ")}))):format}}),Object.defineProperty(String.prototype,"contains",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.contains called on null or undefined");return-1!==String.prototype.indexOf.apply(this,arguments)}}),Object.defineProperty(String.prototype,"count",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.count called on null or undefined");var needle=String(arguments[0]||"");if(""===needle)return 0;for(var indexOf=String.prototype.indexOf,step=needle.length,pos=Number(arguments[1])||0,count=0;-1!==(pos=indexOf.call(this,needle,pos));)++count,pos+=step;return count}}),Object.defineProperty(String.prototype,"first",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.first called on null or undefined");return _getCodePointStartAndEnd(String(this),0).char}}),Object.defineProperty(String.prototype,"last",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.last called on null or undefined");var str=String(this);return _getCodePointStartAndEnd(str,str.length-1).char}}),Object.defineProperty(String.prototype,"splice",{configurable:!0,writable:!0,value:function(startAt,delCount,replacement){if(null==this)throw new TypeError("String.prototype.splice called on null or undefined");var length=this.length>>>0;if(0===length)return"";var start=Number(startAt);Number.isSafeInteger(start)?start<0&&(start+=length)<0&&(start=0):start=0,start>length&&(start=length);var count=Number(delCount);(!Number.isSafeInteger(count)||count<0)&&(count=0);var res=this.slice(0,start);return void 0!==replacement&&(res+=replacement),start+count<length&&(res+=this.slice(start+count)),res}}),Object.defineProperty(String.prototype,"splitOrEmpty",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.splitOrEmpty called on null or undefined");return""===String(this)?[]:String.prototype.split.apply(this,arguments)}}),Object.defineProperty(String.prototype,"toLocaleUpperFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.toLocaleUpperFirst called on null or undefined");var str=String(this),_getCodePointStartAnd3=_getCodePointStartAndEnd(str,0),char=_getCodePointStartAnd3.char,end=_getCodePointStartAnd3.end;return-1===end?"":char.toLocaleUpperCase()+str.slice(end+1)}}),Object.defineProperty(String.prototype,"toUpperFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.toUpperFirst called on null or undefined");var str=String(this),_getCodePointStartAnd4=_getCodePointStartAndEnd(str,0),char=_getCodePointStartAnd4.char,end=_getCodePointStartAnd4.end;return-1===end?"":char.toUpperCase()+str.slice(end+1)}}),Object.defineProperty(Date.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:date)",this.toISOString()]}}),Object.defineProperty(Function.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:eval)","(".concat(this.toString(),")")]}}),Object.defineProperty(Map.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:map)",_toConsumableArray(this)]}}),Object.defineProperty(RegExp.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:eval)",this.toString()]}}),Object.defineProperty(Set.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:set)",_toConsumableArray(this)]}}),Object.defineProperty(JSON,"reviveWrapper",{configurable:!0,writable:!0,value:function(code,data){if("string"!=typeof code)throw new TypeError("JSON.reviveWrapper code parameter must be a string");return["(revive:eval)",[code,data]]}}),Object.defineProperty(JSON,"_real_stringify",{value:JSON.stringify}),Object.defineProperty(JSON,"stringify",{configurable:!0,writable:!0,value:function(_value,replacer,space){return JSON._real_stringify(_value,(function(key,val){var value=val;if("function"==typeof replacer)try{value=replacer(key,value)}catch(ex){}return void 0===value&&(value=["(revive:eval)","undefined"]),value}),space)}}),Object.defineProperty(JSON,"_real_parse",{value:JSON.parse}),Object.defineProperty(JSON,"parse",{configurable:!0,writable:!0,value:function value(text,reviver){return JSON._real_parse(text,(function(key,val){var value=val;if(Array.isArray(value)&&2===value.length)switch(value[0]){case"(revive:set)":value=new Set(value[1]);break;case"(revive:map)":value=new Map(value[1]);break;case"(revive:date)":value=new Date(value[1]);break;case"(revive:eval)":try{if(Array.isArray(value[1])){var $ReviveData$=value[1][1];value=eval(value[1][0])}else value=eval(value[1])}catch(ex){}}else if("string"==typeof value&&"@@revive@@"===value.slice(0,10))try{value=eval(value.slice(10))}catch(ex){}if("function"==typeof reviver)try{value=reviver(key,value)}catch(ex){}return value}))}}),Object.defineProperty(Array.prototype,"contains",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.contains called on null or undefined");return Array.prototype.includes.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"containsAll",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.containsAll called on null or undefined");return Array.prototype.includesAll.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"containsAny",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.containsAny called on null or undefined");return Array.prototype.includesAny.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"flatten",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.flatten called on null or undefined");return Array.prototype.flat.call(this,1/0)}}),Object.defineProperty(String.prototype,"readBracketedList",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.readBracketedList called on null or undefined");for(var match,re=new RegExp("(?:\\[\\[((?:\\s|\\S)*?)\\]\\])|([^\"'\\s]\\S*)","gm"),names=[];null!==(match=re.exec(this));)match[1]?names.push(match[1]):match[2]&&names.push(match[2]);return names}})}();var Browser=(userAgent=navigator.userAgent.toLowerCase(),winPhone=userAgent.includes("windows phone"),isMobile=Object.freeze({Android:!winPhone&&userAgent.includes("android"),BlackBerry:/blackberry|bb10/.test(userAgent),iOS:!winPhone&&/ip(?:hone|ad|od)/.test(userAgent),Opera:!winPhone&&("object"===_typeof(window.operamini)||userAgent.includes("opera mini")),Windows:winPhone||/iemobile|wpdesktop/.test(userAgent),any:function(){return isMobile.Android||isMobile.BlackBerry||isMobile.iOS||isMobile.Opera||isMobile.Windows}}),isGecko=!isMobile.Windows&&!/khtml|trident|edge/.test(userAgent)&&userAgent.includes("gecko"),isIE=!userAgent.includes("opera")&&/msie|trident/.test(userAgent),ieVersion=isIE?(ver=/(?:msie\s+|rv:)(\d+\.\d)/.exec(userAgent))?Number(ver[1]):0:null,isOpera=userAgent.includes("opera")||userAgent.includes(" opr/"),operaVersion=isOpera?function(){var ver=new RegExp("".concat(/khtml|chrome/.test(userAgent)?"opr":"version","\\/(\\d+\\.\\d+)")).exec(userAgent);return ver?Number(ver[1]):0}():null,isVivaldi=userAgent.includes("vivaldi"),Object.freeze({userAgent:userAgent,isMobile:isMobile,isGecko:isGecko,isIE:isIE,ieVersion:ieVersion,isOpera:isOpera,operaVersion:operaVersion,isVivaldi:isVivaldi})),ver,userAgent,winPhone,isMobile,isGecko,isIE,ieVersion,isOpera,operaVersion,isVivaldi,Has=(hasAudioElement=function(){try{return"function"==typeof document.createElement("audio").canPlayType}catch(ex){}return!1}(),hasFile=function(){try{return"Blob"in window&&"File"in window&&"FileList"in window&&"FileReader"in window&&(!Browser.isOpera||Browser.operaVersion>=15)}catch(ex){}return!1}(),hasGeolocation=function(){try{return"geolocation"in navigator&&"function"==typeof navigator.geolocation.getCurrentPosition&&"function"==typeof navigator.geolocation.watchPosition}catch(ex){}return!1}(),hasMutationObserver=function(){try{return"MutationObserver"in window&&"function"==typeof window.MutationObserver}catch(ex){}return!1}(),hasPerformance=function(){try{return"performance"in window&&"function"==typeof window.performance.now}catch(ex){}return!1}(),hasTouch=function(){try{return"ontouchstart"in window||!!window.DocumentTouch&&document instanceof window.DocumentTouch||!!navigator.maxTouchPoints||!!navigator.msMaxTouchPoints}catch(ex){}return!1}(),hasTransitionEndEvent=function(){try{for(var teMap=new Map([["transition","transitionend"],["MSTransition","msTransitionEnd"],["WebkitTransition","webkitTransitionEnd"],["MozTransition","transitionend"]]),teKeys=_toConsumableArray(teMap.keys()),el=document.createElement("div"),i=0;i<teKeys.length;++i)if(el.style[teKeys[i]]!==undefined)return teMap.get(teKeys[i])}catch(ex){}return!1}(),Object.freeze({audio:hasAudioElement,fileAPI:hasFile,geolocation:hasGeolocation,mutationObserver:hasMutationObserver,performance:hasPerformance,touch:hasTouch,transitionEndEvent:hasTransitionEndEvent})),hasAudioElement,hasFile,hasGeolocation,hasMutationObserver,hasPerformance,hasTouch,hasTransitionEndEvent,Visibility=(vendor=function(){try{return Object.freeze([{hiddenProperty:"hidden",stateProperty:"visibilityState",changeEvent:"visibilitychange"},{hiddenProperty:"webkitHidden",stateProperty:"webkitVisibilityState",changeEvent:"webkitvisibilitychange"},{hiddenProperty:"mozHidden",stateProperty:"mozVisibilityState",changeEvent:"mozvisibilitychange"},{hiddenProperty:"msHidden",stateProperty:"msVisibilityState",changeEvent:"msvisibilitychange"}].find((function(vnd){return vnd.hiddenProperty in document})))}catch(ex){}return undefined}(),Object.freeze(Object.defineProperties({},{vendor:{get:function(){return vendor}},state:{get:function(){return vendor&&document[vendor.stateProperty]||"visible"}},isEnabled:{value:function(){return Boolean(vendor)}},isHidden:{value:function(){return Boolean(vendor&&document[vendor.hiddenProperty])}},hiddenProperty:{value:vendor&&vendor.hiddenProperty},stateProperty:{value:vendor&&vendor.stateProperty},changeEvent:{value:vendor&&vendor.changeEvent}}))),vendor,Fullscreen=function(){var _hasPromise,vendor=function(){try{return Object.freeze([{isEnabled:"fullscreenEnabled",element:"fullscreenElement",requestFn:"requestFullscreen",exitFn:"exitFullscreen",changeEvent:"fullscreenchange",errorEvent:"fullscreenerror"},{isEnabled:"webkitFullscreenEnabled",element:"webkitFullscreenElement",requestFn:"webkitRequestFullscreen",exitFn:"webkitExitFullscreen",changeEvent:"webkitfullscreenchange",errorEvent:"webkitfullscreenerror"},{isEnabled:"mozFullScreenEnabled",element:"mozFullScreenElement",requestFn:"mozRequestFullScreen",exitFn:"mozCancelFullScreen",changeEvent:"mozfullscreenchange",errorEvent:"mozfullscreenerror"},{isEnabled:"msFullscreenEnabled",element:"msFullscreenElement",requestFn:"msRequestFullscreen",exitFn:"msExitFullscreen",changeEvent:"MSFullscreenChange",errorEvent:"MSFullscreenError"}].find((function(vnd){return vnd.isEnabled in document})))}catch(ex){}return undefined}(),_returnsPromise=(_hasPromise=null,function(){if(null!==_hasPromise)return _hasPromise;if(_hasPromise=!1,vendor)try{var value=document.exitFullscreen();value.catch((function(){})),_hasPromise=value instanceof Promise}catch(ex){}return _hasPromise});function _selectElement(requestedEl){var selectedEl=requestedEl||document.documentElement;return selectedEl===document.documentElement&&("msRequestFullscreen"===vendor.requestFn||Browser.isOpera&&Browser.operaVersion<15)&&(selectedEl=document.body),selectedEl}function isFullscreen(){return Boolean(vendor&&document[vendor.element])}function requestFullscreen(options,requestedEl){var _this=this;if(!vendor)return Promise.reject(new Error("fullscreen not supported"));var element=_selectElement(requestedEl);if("function"!=typeof element[vendor.requestFn])return Promise.reject(new Error("fullscreen not supported"));if(isFullscreen())return Promise.resolve();if(_returnsPromise())return element[vendor.requestFn](options);var namespace=".Fullscreen_requestFullscreen";return new Promise((function(resolve,reject){jQuery(element).off(namespace).one("".concat(vendor.errorEvent).concat(namespace," ").concat(vendor.changeEvent).concat(namespace),(function(ev){jQuery(_this).off(namespace),ev.type===vendor.errorEvent?reject(new Error("unknown fullscreen request error")):resolve()})),element[vendor.requestFn](options)}))}function exitFullscreen(){var _this2=this;if(!vendor||"function"!=typeof document[vendor.exitFn])return Promise.reject(new TypeError("fullscreen not supported"));if(!isFullscreen())return Promise.reject(new TypeError("fullscreen mode not active"));if(_returnsPromise())return document[vendor.exitFn]();var namespace=".Fullscreen_exitFullscreen";return new Promise((function(resolve,reject){jQuery(document).off(namespace).one("".concat(vendor.errorEvent).concat(namespace," ").concat(vendor.changeEvent).concat(namespace),(function(ev){jQuery(_this2).off(namespace),ev.type===vendor.errorEvent?reject(new Error("unknown fullscreen exit error")):resolve()})),document[vendor.exitFn]()}))}return Object.freeze(Object.defineProperties({},{vendor:{get:function(){return vendor}},element:{get:function(){return vendor?document[vendor.element]:null}},isEnabled:{value:function(){return Boolean(vendor&&document[vendor.isEnabled])}},isFullscreen:{value:isFullscreen},request:{value:requestFullscreen},exit:{value:exitFullscreen},toggle:{value:function(options,requestedEl){return isFullscreen()?exitFullscreen():requestFullscreen(options,requestedEl)}},onChange:{value:function(handlerFn,requestedEl){if(vendor){var element=_selectElement(requestedEl);$(element).on(vendor.changeEvent,handlerFn)}}},offChange:{value:function(handlerFn,requestedEl){if(vendor){var element=_selectElement(requestedEl);handlerFn?$(element).off(vendor.changeEvent,handlerFn):$(element).off(vendor.changeEvent)}}},onError:{value:function(handlerFn,requestedEl){if(vendor){var element=_selectElement(requestedEl);$(element).on(vendor.errorEvent,handlerFn)}}},offError:{value:function(handlerFn,requestedEl){if(vendor){var element=_selectElement(requestedEl);handlerFn?$(element).off(vendor.errorEvent,handlerFn):$(element).off(vendor.errorEvent)}}}}))}(),_ref3=Object.freeze(Object.defineProperties({},{clone:{value:function clone(orig){return"object"!==_typeof(orig)||null===orig?orig:orig instanceof String?String(orig):orig instanceof Number?Number(orig):orig instanceof Boolean?Boolean(orig):"function"==typeof orig.clone?orig.clone(!0):orig.nodeType&&"function"==typeof orig.cloneNode?orig.cloneNode(!0):(orig instanceof Array?copy=new Array(orig.length):orig instanceof Date?copy=new Date(orig.getTime()):orig instanceof Map?(copy=new Map,orig.forEach((function(val,key){return copy.set(key,clone(val))}))):orig instanceof RegExp?copy=new RegExp(orig):orig instanceof Set?(copy=new Set,orig.forEach((function(val){return copy.add(clone(val))}))):copy=Object.create(Object.getPrototypeOf(orig)),Object.keys(orig).forEach((function(name){return copy[name]=clone(orig[name])})),copy);var copy}},convertBreaks:{value:function(source){for(var node,output=document.createDocumentFragment(),para=document.createElement("p");null!==(node=source.firstChild);){if(node.nodeType===Node.ELEMENT_NODE)switch(node.nodeName.toUpperCase()){case"BR":if(null!==node.nextSibling&&node.nextSibling.nodeType===Node.ELEMENT_NODE&&"BR"===node.nextSibling.nodeName.toUpperCase()){source.removeChild(node.nextSibling),source.removeChild(node),output.appendChild(para),para=document.createElement("p");continue}if(!para.hasChildNodes()){source.removeChild(node);continue}break;case"ADDRESS":case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"CENTER":case"DIV":case"DL":case"FIGURE":case"FOOTER":case"FORM":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"HEADER":case"HR":case"MAIN":case"NAV":case"OL":case"P":case"PRE":case"SECTION":case"TABLE":case"UL":para.hasChildNodes()&&(output.appendChild(para),para=document.createElement("p")),output.appendChild(node);continue}para.appendChild(node)}para.hasChildNodes()&&output.appendChild(para),source.appendChild(output)}},safeActiveElement:{value:function(){try{return document.activeElement||null}catch(ex){return null}}},setDisplayTitle:{value:function(title){if("string"!=typeof title)throw new TypeError("story display title must be a string (received: ".concat(Util.getType(title),")"));var render=document.createDocumentFragment();new Wikifier(render,title);var text=function(source){for(var node,copy=source.cloneNode(!0),frag=document.createDocumentFragment();null!==(node=copy.firstChild);){if(node.nodeType===Node.ELEMENT_NODE)switch(node.nodeName.toUpperCase()){case"BR":case"DIV":case"P":frag.appendChild(document.createTextNode(" "))}frag.appendChild(node)}return frag.textContent}(render).trim();document.title=Config.passages.displayTitles&&""!==State.passage&&State.passage!==Config.passages.start?"".concat(State.passage," | ").concat(text):text;var storyTitle=document.getElementById("story-title");null!==storyTitle&&jQuery(storyTitle).empty().append(render)}},setPageElement:{value:function(idOrElement,titles,defaultText){var el="object"===_typeof(idOrElement)?idOrElement:document.getElementById(idOrElement);if(null==el)return null;var ids=Array.isArray(titles)?titles:[titles];jQuery(el).empty();for(var i=0,iend=ids.length;i<iend;++i)if(Story.has(ids[i]))return new Wikifier(el,Story.get(ids[i]).processText().trim()),el;if(null!=defaultText){var text=String(defaultText).trim();""!==text&&new Wikifier(el,text)}return el}},throwError:{value:function(place,message,source){var $wrapper=jQuery(document.createElement("div")),$toggle=jQuery(document.createElement("button")),$source=jQuery(document.createElement("pre")),mesg="".concat(L10n.get("errorTitle"),": ").concat(message||"unknown error");return $toggle.addClass("error-toggle").ariaClick({label:L10n.get("errorToggle")},(function(){$toggle.hasClass("enabled")?($toggle.removeClass("enabled"),$source.attr({"aria-hidden":!0,hidden:"hidden"})):($toggle.addClass("enabled"),$source.removeAttr("aria-hidden hidden"))})).appendTo($wrapper),jQuery(document.createElement("span")).addClass("error").text(mesg).appendTo($wrapper),jQuery(document.createElement("code")).text(source).appendTo($source),$source.addClass("error-source").attr({"aria-hidden":!0,hidden:"hidden"}).appendTo($wrapper),$wrapper.addClass("error-view").appendTo(place),console.warn("".concat(mesg,"\n\t").concat(source.replace(/\n/g,"\n\t"))),!1}},stringFrom:{value:function stringFrom(value){switch(_typeof(value)){case"function":return"[function]";case"number":if(Number.isNaN(value))return"[number NaN]";break;case"object":if(null===value)return"[null]";if(value instanceof Array)return value.map((function(val){return stringFrom(val)})).join(", ");if(value instanceof Set)return Array.from(value).map((function(val){return stringFrom(val)})).join(", ");if(value instanceof Map){var result=Array.from(value).map((function(_ref4){var _ref5=_slicedToArray(_ref4,2),key=_ref5[0],val=_ref5[1];return"".concat(stringFrom(key)," → ").concat(stringFrom(val))}));return"{ ".concat(result.join(", ")," }")}if(value instanceof Date)return value.toLocaleString();if(value instanceof Element){if(value===document.documentElement||value===document.head||value===document.body)throw new Error("illegal operation; attempting to convert the <html>, <head>, or <body> tags to string is not allowed");return value.outerHTML}return value instanceof Node?value.textContent:"function"==typeof value.toString?value.toString():Object.prototype.toString.call(value);case"symbol":var desc=void 0!==value.description?' "'.concat(value.description,'"'):"";return"[symbol".concat(desc,"]");case"undefined":return"[undefined]"}return String(value)}}})),clone=_ref3.clone,convertBreaks=_ref3.convertBreaks,safeActiveElement=_ref3.safeActiveElement,setDisplayTitle=_ref3.setDisplayTitle,setPageElement=_ref3.setPageElement,throwError=_ref3.throwError,stringFrom=_ref3.stringFrom;!function(){function onKeypressFn(ev){13!==ev.which&&32!==ev.which||(ev.preventDefault(),jQuery(safeActiveElement()||this).trigger("click"))}function onClickFnWrapper(fn){return function(){var $this=jQuery(this);$this.ariaIsDisabled()||($this.is("[aria-pressed]")&&$this.attr("aria-pressed","true"===$this.attr("aria-pressed")?"false":"true"),fn.apply(this,arguments))}}function oneClickFnWrapper(fn){return onClickFnWrapper((function(){jQuery(this).off(".aria-clickable").removeAttr("role tabindex aria-controls aria-pressed").filter("button").prop("disabled",!0),fn.apply(this,arguments)}))}jQuery.fn.extend({ariaClick:function(options,handler){if(0===this.length||0===arguments.length)return this;var opts=options,fn=handler;return null==fn&&(fn=opts,opts=undefined),"string"!=typeof(opts=jQuery.extend({namespace:undefined,one:!1,selector:undefined,data:undefined,role:undefined,controls:undefined,pressed:undefined,label:undefined},opts)).namespace?opts.namespace="":"."!==opts.namespace[0]&&(opts.namespace=".".concat(opts.namespace)),"boolean"==typeof opts.pressed&&(opts.pressed=opts.pressed?"true":"false"),this.filter("button").prop("type","button"),null!=opts.role?this.attr("role",opts.role):this.not("[role]").filter("a,[data-passage]").attr("role","link").end().not("a").not("[data-passage]").attr("role","button").end().end().end(),this.attr("tabindex",0),null!=opts.controls&&this.attr("aria-controls",opts.controls),null!=opts.pressed&&this.attr("aria-pressed",opts.pressed),null!=opts.label&&this.attr({"aria-label":opts.label,title:opts.label}),this.not("button").on("keypress.aria-clickable".concat(opts.namespace),opts.selector,onKeypressFn),this.on("click.aria-clickable".concat(opts.namespace),opts.selector,opts.data,opts.one?oneClickFnWrapper(fn):onClickFnWrapper(fn)),this},ariaDisabled:function(disable){if(0===this.length||0===arguments.length)return this;var $nonDisableable=this.not("button,fieldset,input,menuitem,optgroup,option,select,textarea"),$disableable=this.filter("button,fieldset,input,menuitem,optgroup,option,select,textarea");return disable?($nonDisableable.each((function(){this.setAttribute("disabled",""),this.setAttribute("aria-disabled","true")})),$disableable.each((function(){this.disabled=!0,this.setAttribute("aria-disabled","true")}))):($nonDisableable.each((function(){this.removeAttribute("disabled"),this.removeAttribute("aria-disabled")})),$disableable.each((function(){this.disabled=!1,this.removeAttribute("aria-disabled")}))),this},ariaIsDisabled:function(){return this.is("[disabled]")}})}(),jQuery.extend({wikiWithOptions:function(options){for(var _len=arguments.length,sources=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)sources[_key-1]=arguments[_key];if(0!==sources.length){var frag=document.createDocumentFragment();sources.forEach((function(content){return new Wikifier(frag,content,options)}));var errors=_toConsumableArray(frag.querySelectorAll(".error")).map((function(errEl){return errEl.textContent.replace(errorPrologRegExp,"")}));if(errors.length>0)throw new Error(errors.join("; "))}},wiki:function(){for(var _len2=arguments.length,sources=new Array(_len2),_key2=0;_key2<_len2;_key2++)sources[_key2]=arguments[_key2];this.wikiWithOptions.apply(this,[undefined].concat(sources))}}),jQuery.fn.extend({wikiWithOptions:function(options){for(var _len3=arguments.length,sources=new Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++)sources[_key3-1]=arguments[_key3];if(0===this.length||0===sources.length)return this;var frag=document.createDocumentFragment();return sources.forEach((function(content){return new Wikifier(frag,content,options)})),this.append(frag),this},wiki:function(){for(var _len4=arguments.length,sources=new Array(_len4),_key4=0;_key4<_len4;_key4++)sources[_key4]=arguments[_key4];return this.wikiWithOptions.apply(this,[undefined].concat(sources))}});var Util=function(){var toString,utilGetType="[object Object]"===(toString=Object.prototype.toString).call(new Map)?function(O){if(null===O)return"null";if(O instanceof Map)return"Map";if(O instanceof Set)return"Set";var baseType=_typeof(O);return"object"===baseType?toString.call(O).slice(8,-1):baseType}:function(O){if(null===O)return"null";var baseType=_typeof(O);return"object"===baseType?toString.call(O).slice(8,-1):baseType};function utilToEnum(obj){var pEnum=Object.create(null);if(obj instanceof Array)obj.forEach((function(val,i){return pEnum[String(val)]=i}));else if(obj instanceof Set)Array.from(obj).forEach((function(val,i){return pEnum[String(val)]=i}));else if(obj instanceof Map)obj.forEach((function(val,key){return pEnum[String(key)]=val}));else{if("object"!==_typeof(obj)||null===obj||Object.getPrototypeOf(obj)!==Object.prototype)throw new TypeError("Util.toEnum obj parameter must be an Array, Map, Set, or generic object");Object.assign(pEnum,obj)}return Object.freeze(pEnum)}function utilToStringTag(obj){return Object.prototype.toString.call(obj).slice(8,-1)}var _illegalSlugCharsRe=/[\x00-\x20!-/:-@[-^`{-\x9f]+/g,_isInvalidSlugRe=/^-*$/;var _illegalFilenameCharsRE=/[\x00-\x1f"#$%&'*+,/:;<=>?\\^`|\x7f-\x9f]+/g;var _markupCharsRe=/[!"#$&'*\-/<=>?@[\\\]^_`{|}~]/g,_hasMarkupCharsRe=new RegExp(_markupCharsRe.source),_markupCharsMap=utilToEnum({"!":"&#33;",'"':"&quot;","#":"&#35;",$:"&#36;","&":"&amp;","'":"&#39;","*":"&#42;","-":"&#45;","/":"&#47;","<":"&lt;","=":"&#61;",">":"&gt;","?":"&#63;","@":"&#64;","[":"&#91;","\\":"&#92;","]":"&#93;","^":"&#94;",_:"&#95;","`":"&#96;","{":"&#123;","|":"&#124;","}":"&#125;","~":"&#126;"});var _htmlCharsRe=/[&<>"'`]/g,_hasHtmlCharsRe=new RegExp(_htmlCharsRe.source),_htmlCharsMap=utilToEnum({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"});function utilEscape(str){if(null==str)return"";var val=String(str);return val&&_hasHtmlCharsRe.test(val)?val.replace(_htmlCharsRe,(function(ch){return _htmlCharsMap[ch]})):val}var _escapedHtmlRe=/&(?:amp|#38|#x26|lt|#60|#x3c|gt|#62|#x3e|quot|#34|#x22|apos|#39|#x27|#96|#x60);/gi,_hasEscapedHtmlRe=new RegExp(_escapedHtmlRe.source,"i"),_escapedHtmlMap=utilToEnum({"&amp;":"&","&#38;":"&","&#x26;":"&","&lt;":"<","&#60;":"<","&#x3c;":"<","&gt;":">","&#62;":">","&#x3e;":">","&quot;":'"',"&#34;":'"',"&#x22;":'"',"&apos;":"'","&#39;":"'","&#x27;":"'","&#96;":"`","&#x60;":"`"});function utilUnescape(str){if(null==str)return"";var val=String(str);return val&&_hasEscapedHtmlRe.test(val)?val.replace(_escapedHtmlRe,(function(entity){return _escapedHtmlMap[entity.toLowerCase()]})):val}var _nowSource=Has.performance?performance:Date;var _cssTimeRe=/^([+-]?(?:\d*\.)?\d+)([Mm]?[Ss])$/;var utilScrubEventKey=function(){var separatorKey,decimalKey;if("undefined"!=typeof Intl&&"function"==typeof Intl.NumberFormat){var match=(new Intl.NumberFormat).format(111111.5).match(/(\D*)\d+(\D*)/);match&&(separatorKey=match[1],decimalKey=match[2])}return separatorKey||decimalKey||(separatorKey=",",decimalKey="."),function(key){switch(key){case"Scroll":return"ScrollLock";case"Spacebar":return" ";case"Left":return"ArrowLeft";case"Right":return"ArrowRight";case"Up":return"ArrowUp";case"Down":return"ArrowDown";case"Del":return"Delete";case"Crsel":return"CrSel";case"Exsel":return"ExSel";case"Esc":return"Escape";case"Apps":return"ContextMenu";case"Nonconvert":return"NonConvert";case"MediaNextTrack":return"MediaTrackNext";case"MediaPreviousTrack":return"MediaTrackPrevious";case"VolumeUp":return"AudioVolumeUp";case"VolumeDown":return"AudioVolumeDown";case"VolumeMute":return"AudioVolumeMute";case"Zoom":return"ZoomToggle";case"SelectMedia":case"MediaSelect":return"LaunchMediaPlayer";case"Add":return"+";case"Divide":return"/";case"Multiply":return"*";case"Subtract":return"-";case"Decimal":return decimalKey;case"Separator":return separatorKey}return key}}(),utilHasMediaQuery="function"!=typeof window.matchMedia?function(){return!1}:function(mediaQuery){return window.matchMedia(mediaQuery).matches};return Object.freeze(Object.defineProperties({},{getType:{value:utilGetType},isBoolean:{value:function(obj){return"boolean"==typeof obj||"string"==typeof obj&&("true"===obj||"false"===obj)}},isIterable:{value:function(obj){return null!=obj&&"function"==typeof obj[Symbol.iterator]}},isNumeric:{value:function(obj){var num;switch(_typeof(obj)){case"number":num=obj;break;case"string":num=Number(obj);break;default:return!1}return!Number.isNaN(num)&&Number.isFinite(num)}},sameValueZero:{value:function(a,b){return a===b||a!=a&&b!=b}},toEnum:{value:utilToEnum},toStringTag:{value:utilToStringTag},slugify:{value:function(str){var base=String(str).trim(),_legacy=base.replace(/[^\w\s\u2013\u2014-]+/g,"").replace(/[_\s\u2013\u2014-]+/g,"-").toLocaleLowerCase();return _isInvalidSlugRe.test(_legacy)?base.replace(_illegalSlugCharsRe,"").replace(/[_\s\u2013\u2014-]+/g,"-"):_legacy}},sanitizeFilename:{value:function(str){return String(str).trim().replace(_illegalFilenameCharsRE,"")}},escapeMarkup:{value:function(str){if(null==str)return"";var val=String(str);return val&&_hasMarkupCharsRe.test(val)?val.replace(_markupCharsRe,(function(ch){return _markupCharsMap[ch]})):val}},escape:{value:utilEscape},unescape:{value:utilUnescape},charAndPosAt:{value:function(text,position){var str=String(text),pos=Math.trunc(position),code=str.charCodeAt(pos);if(Number.isNaN(code))return{char:"",start:-1,end:-1};var retval={char:str.charAt(pos),start:pos,end:pos};if(code<55296||code>57343)return retval;if(code>=55296&&code<=56319){var nextPos=pos+1;if(nextPos>=str.length)return retval;var nextCode=str.charCodeAt(nextPos);return nextCode<56320||nextCode>57343||(retval.char=retval.char+str.charAt(nextPos),retval.end=nextPos),retval}if(0===pos)return retval;var prevPos=pos-1,prevCode=str.charCodeAt(prevPos);return prevCode<55296||prevCode>56319||(retval.char=str.charAt(prevPos)+retval.char,retval.start=prevPos),retval}},now:{value:function(){return _nowSource.now()}},fromCssTime:{value:function(cssTime){var match=_cssTimeRe.exec(String(cssTime));if(null===match)throw new SyntaxError('invalid time value syntax: "'.concat(cssTime,'"'));var msec=Number(match[1]);if(1===match[2].length&&(msec*=1e3),Number.isNaN(msec)||!Number.isFinite(msec))throw new RangeError('invalid time value: "'.concat(cssTime,'"'));return msec}},toCssTime:{value:function(msec){if("number"!=typeof msec||Number.isNaN(msec)||!Number.isFinite(msec)){var what;switch(_typeof(msec)){case"string":what='"'.concat(msec,'"');break;case"number":what=String(msec);break;default:what=utilToStringTag(msec)}throw new Error("invalid milliseconds: ".concat(what))}return"".concat(msec,"ms")}},fromCssProperty:{value:function(cssName){if(!cssName.includes("-"))switch(cssName){case"bgcolor":return"backgroundColor";case"float":return"cssFloat";default:return cssName}return("-ms-"===cssName.slice(0,4)?cssName.slice(1):cssName).split("-").map((function(part,i){return 0===i?part:part.toUpperFirst()})).join("")}},parseUrl:{value:function(url){var el=document.createElement("a"),queryObj=Object.create(null);el.href=url,el.search&&el.search.replace(/^\?/,"").splitOrEmpty(/(?:&(?:amp;)?|;)/).forEach((function(query){var _query$split2=_slicedToArray(query.split("="),2),key=_query$split2[0],value=_query$split2[1];queryObj[key]=value}));var pathname=el.host&&"/"!==el.pathname[0]?"/".concat(el.pathname):el.pathname;return{href:el.href,protocol:el.protocol,host:el.host,hostname:el.hostname,port:el.port,path:"".concat(pathname).concat(el.search),pathname:pathname,query:el.search,search:el.search,queries:queryObj,searches:queryObj,hash:el.hash}}},newExceptionFrom:{value:function(original,exceptionType,override){if("object"!==_typeof(original)||null===original)throw new Error("Util.newExceptionFrom original parameter must be an object");if("function"!=typeof exceptionType)throw new Error("Util.newExceptionFrom exceptionType parameter must be an error type constructor");var ex=new exceptionType(original.message);void 0!==original.name&&(ex.name=original.name),void 0!==original.code&&(ex.code=original.code),void 0!==original.columnNumber&&(ex.columnNumber=original.columnNumber),void 0!==original.description&&(ex.description=original.description),void 0!==original.fileName&&(ex.fileName=original.fileName),void 0!==original.lineNumber&&(ex.lineNumber=original.lineNumber),void 0!==original.number&&(ex.number=original.number),void 0!==original.stack&&(ex.stack=original.stack);var overrideType=_typeof(override);if("undefined"!==overrideType)if("object"===overrideType&&null!==override)Object.assign(ex,override);else{if("string"!==overrideType)throw new Error("Util.newExceptionFrom override parameter must be an object or string");ex.message=override}return ex}},scrubEventKey:{value:utilScrubEventKey},hasMediaQuery:{value:utilHasMediaQuery},random:{value:Math.random},entityEncode:{value:utilEscape},entityDecode:{value:utilUnescape},evalExpression:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}},evalStatements:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}}}))}(),SimpleStore=(_adapters=[],_initialized=null,Object.freeze(Object.defineProperties({},{adapters:{value:_adapters},create:{value:function(storageId,persistent){if(_initialized)return _initialized.create(storageId,persistent);for(var i=0;i<_adapters.length;++i)if(_adapters[i].init(storageId,persistent))return(_initialized=_adapters[i]).create(storageId,persistent);throw new Error("no valid storage adapters found")}}}))),_adapters,_initialized,_ok,_WebStorageAdapter;SimpleStore.adapters.push((_ok=!1,_WebStorageAdapter=function(){function _WebStorageAdapter(storageId,persistent){_classCallCheck(this,_WebStorageAdapter);var prefix="".concat(storageId,"."),engine=null,name=null;persistent?(engine=window.localStorage,name="localStorage"):(engine=window.sessionStorage,name="sessionStorage"),Object.defineProperties(this,{_engine:{value:engine},_prefix:{value:prefix},_prefixRe:{value:new RegExp("^".concat(RegExp.escape(prefix)))},name:{value:name},id:{value:storageId},persistent:{value:!!persistent}})}return _createClass(_WebStorageAdapter,[{key:"length",get:function(){return this.keys().length}},{key:"size",value:function(){return this.keys().length}},{key:"keys",value:function(){for(var keys=[],i=0;i<this._engine.length;++i){var key=this._engine.key(i);this._prefixRe.test(key)&&keys.push(key.replace(this._prefixRe,""))}return keys}},{key:"has",value:function(key){return!("string"!=typeof key||!key)&&this._engine.hasOwnProperty(this._prefix+key)}},{key:"get",value:function(key){if("string"!=typeof key||!key)return null;var value=this._engine.getItem(this._prefix+key);return null==value?null:_WebStorageAdapter._deserialize(value)}},{key:"set",value:function(key,value){if("string"!=typeof key||!key)return!1;try{this._engine.setItem(this._prefix+key,_WebStorageAdapter._serialize(value))}catch(ex){if(/quota.?(?:exceeded|reached)/i.test(ex.name+ex.message))throw Util.newExceptionFrom(ex,Error,"".concat(this.name," quota exceeded"));throw ex}return!0}},{key:"delete",value:function(key){return!("string"!=typeof key||!key||(this._engine.removeItem(this._prefix+key),0))}},{key:"clear",value:function(){for(var keys=this.keys(),i=0,iend=keys.length;i<iend;++i)this.delete(keys[i]);return!0}}],[{key:"_serialize",value:function(obj){return LZString.compressToUTF16(JSON.stringify(obj))}},{key:"_deserialize",value:function(str){return JSON.parse(LZString.decompressFromUTF16(str))}}]),_WebStorageAdapter}(),Object.freeze(Object.defineProperties({},{init:{value:function(){function hasWebStorage(storeId){try{var store=window[storeId],tid="_sc_".concat(String(Date.now()));store.setItem(tid,tid);var result=store.getItem(tid)===tid;return store.removeItem(tid),result}catch(ex){}return!1}return _ok=hasWebStorage("localStorage")&&hasWebStorage("sessionStorage")}},create:{value:function(storageId,persistent){if(!_ok)throw new Error("adapter not initialized");return new _WebStorageAdapter(storageId,persistent)}}})))),SimpleStore.adapters.push(function(){var _MAX_EXPIRY="Tue, 19 Jan 2038 03:14:07 GMT",_MIN_EXPIRY="Thu, 01 Jan 1970 00:00:00 GMT",_ok=!1,_CookieAdapter=function(){function _CookieAdapter(storageId,persistent){_classCallCheck(this,_CookieAdapter);var prefix="".concat(storageId).concat(persistent?"!":"*",".");Object.defineProperties(this,{_prefix:{value:prefix},_prefixRe:{value:new RegExp("^".concat(RegExp.escape(prefix)))},name:{value:"cookie"},id:{value:storageId},persistent:{value:!!persistent}})}return _createClass(_CookieAdapter,[{key:"length",get:function(){return this.keys().length}},{key:"size",value:function(){return this.keys().length}},{key:"keys",value:function(){if(""===document.cookie)return[];for(var cookies=document.cookie.split(/;\s*/),keys=[],i=0;i<cookies.length;++i){var kvPair=cookies[i].split("="),key=decodeURIComponent(kvPair[0]);if(this._prefixRe.test(key))""!==decodeURIComponent(kvPair[1])&&keys.push(key.replace(this._prefixRe,""))}return keys}},{key:"has",value:function(key){return!("string"!=typeof key||!key)&&null!==_CookieAdapter._getCookie(this._prefix+key)}},{key:"get",value:function(key){if("string"!=typeof key||!key)return null;var value=_CookieAdapter._getCookie(this._prefix+key);return null===value?null:_CookieAdapter._deserialize(value)}},{key:"set",value:function(key,value){if("string"!=typeof key||!key)return!1;try{if(_CookieAdapter._setCookie(this._prefix+key,_CookieAdapter._serialize(value),this.persistent?"Tue, 19 Jan 2038 03:14:07 GMT":undefined),!this.has(key))throw new Error("unknown validation error during set")}catch(ex){throw Util.newExceptionFrom(ex,Error,"cookie error: ".concat(ex.message))}return!0}},{key:"delete",value:function(key){if("string"!=typeof key||!key||!this.has(key))return!1;try{if(_CookieAdapter._setCookie(this._prefix+key,undefined,_MIN_EXPIRY),this.has(key))throw new Error("unknown validation error during delete")}catch(ex){throw Util.newExceptionFrom(ex,Error,"cookie error: ".concat(ex.message))}return!0}},{key:"clear",value:function(){for(var keys=this.keys(),i=0,iend=keys.length;i<iend;++i)this.delete(keys[i]);return!0}}],[{key:"_getCookie",value:function(prefixedKey){if(!prefixedKey||""===document.cookie)return null;for(var cookies=document.cookie.split(/;\s*/),i=0;i<cookies.length;++i){var kvPair=cookies[i].split("=");if(prefixedKey===decodeURIComponent(kvPair[0]))return decodeURIComponent(kvPair[1])||null}return null}},{key:"_setCookie",value:function(prefixedKey,value,expiry){if(prefixedKey){var payload="".concat(encodeURIComponent(prefixedKey),"=");null!=value&&(payload+=encodeURIComponent(value)),null!=expiry&&(payload+="; expires=".concat(expiry)),payload+="; path=/",document.cookie=payload}}},{key:"_serialize",value:function(obj){return LZString.compressToBase64(JSON.stringify(obj))}},{key:"_deserialize",value:function(str){return JSON.parse(LZString.decompressFromBase64(str))}}]),_CookieAdapter}();return Object.freeze(Object.defineProperties({},{init:{value:function(storageId){try{var tid="_sc_".concat(String(Date.now()));_CookieAdapter._setCookie(tid,_CookieAdapter._serialize(tid),undefined),_ok=_CookieAdapter._deserialize(_CookieAdapter._getCookie(tid))===tid,_CookieAdapter._setCookie(tid,undefined,_MIN_EXPIRY)}catch(ex){_ok=!1}return _ok&&function(storageId){if(""===document.cookie)return;for(var oldPrefix="".concat(storageId,"."),oldPrefixRe=new RegExp("^".concat(RegExp.escape(oldPrefix))),persistPrefix="".concat(storageId,"!."),sessionPrefix="".concat(storageId,"*."),sessionTestRe=/\.(?:state|rcWarn)$/,cookies=document.cookie.split(/;\s*/),i=0;i<cookies.length;++i){var kvPair=cookies[i].split("="),key=decodeURIComponent(kvPair[0]);if(oldPrefixRe.test(key)){var value=decodeURIComponent(kvPair[1]);""!==value&&function(){var persist=!sessionTestRe.test(key);_CookieAdapter._setCookie(key,undefined,_MIN_EXPIRY),_CookieAdapter._setCookie(key.replace(oldPrefixRe,(function(){return persist?persistPrefix:sessionPrefix})),value,persist?_MAX_EXPIRY:undefined)}()}}}(storageId),_ok}},create:{value:function(storageId,persistent){if(!_ok)throw new Error("adapter not initialized");return new _CookieAdapter(storageId,persistent)}}}))}());var DebugView=function(){function DebugView(parent,type,name,title){_classCallCheck(this,DebugView),Object.defineProperties(this,{parent:{value:parent},view:{value:document.createElement("span")},break:{value:document.createElement("wbr")}}),jQuery(this.view).attr({title:title,"aria-label":title,"data-type":null!=type?type:"","data-name":null!=name?name:""}).addClass("debug"),jQuery(this.break).addClass("debug hidden"),this.parent.appendChild(this.view),this.parent.appendChild(this.break)}return _createClass(DebugView,[{key:"output",get:function(){return this.view}},{key:"type",get:function(){return this.view.getAttribute("data-type")},set:function(type){this.view.setAttribute("data-type",null!=type?type:"")}},{key:"name",get:function(){return this.view.getAttribute("data-name")},set:function(name){this.view.setAttribute("data-name",null!=name?name:"")}},{key:"title",get:function(){return this.view.title},set:function(title){this.view.title=title}},{key:"append",value:function(el){return jQuery(this.view).append(el),this}},{key:"modes",value:function(options){if(null==options){var current={};return this.view.className.splitOrEmpty(/\s+/).forEach((function(name){"debug"!==name&&(current[name]=!0)})),current}if("object"===_typeof(options))return Object.keys(options).forEach((function(name){this[options[name]?"addClass":"removeClass"](name)}),jQuery(this.view)),this;throw new Error("DebugView.prototype.modes options parameter must be an object or null/undefined")}},{key:"remove",value:function(){var $view=jQuery(this.view);this.view.hasChildNodes()&&$view.contents().appendTo(this.parent),$view.remove(),jQuery(this.break).remove()}}],[{key:"isEnabled",value:function(){return"enabled"===jQuery(document.documentElement).attr("data-debug-view")}},{key:"enable",value:function(){jQuery(document.documentElement).attr("data-debug-view","enabled"),jQuery.event.trigger(":debugviewupdate")}},{key:"disable",value:function(){jQuery(document.documentElement).removeAttr("data-debug-view"),jQuery.event.trigger(":debugviewupdate")}},{key:"toggle",value:function(){"enabled"===jQuery(document.documentElement).attr("data-debug-view")?DebugView.disable():DebugView.enable()}}]),DebugView}(),NodeTyper=function(){var NodeTyper=function(){function NodeTyper(config){if(_classCallCheck(this,NodeTyper),"object"!==_typeof(config)||null===config)throw new Error("config parameter must be an object (received: ".concat(Util.getType(config),")"));if(!(config.hasOwnProperty("targetNode")&&config.targetNode instanceof Node))throw new Error('config parameter object "targetNode" property must be a node');Object.defineProperties(this,{node:{value:config.targetNode},childNodes:{value:[]},nodeValue:{writable:!0,value:""},appendTo:{writable:!0,value:config.parentNode||null},classNames:{writable:!0,value:config.classNames||null},finished:{writable:!0,value:!1}});var childNode,node=this.node;for(node.nodeValue&&(this.nodeValue=node.nodeValue,node.nodeValue="");null!==(childNode=node.firstChild);)this.childNodes.push(new NodeTyper({targetNode:childNode,parentNode:node,classNames:this.classNames})),node.removeChild(childNode)}return _createClass(NodeTyper,[{key:"finish",value:function(){for(;this.type(!0););return!1}},{key:"type",value:function(flush){if(this.finished)return!1;if(this.appendTo){if(this.appendTo.appendChild(this.node),this.appendTo=null,this.node.nodeType!==Node.ELEMENT_NODE&&this.node.nodeType!==Node.TEXT_NODE||"none"===jQuery(this.node.parentNode).css("display"))return this.finish();this.node.parentNode&&this.classNames&&jQuery(this.node.parentNode).addClass(this.classNames)}if(this.nodeValue){if(flush)this.node.nodeValue+=this.nodeValue,this.nodeValue="";else{var _Util$charAndPosAt=Util.charAndPosAt(this.nodeValue,0),char=_Util$charAndPosAt.char,start=_Util$charAndPosAt.start,end=_Util$charAndPosAt.end;this.node.nodeValue+=char,this.nodeValue=this.nodeValue.slice(1+end-start)}return!0}this.classNames&&(jQuery(this.node.parentNode).removeClass(this.classNames),this.classNames=null);for(var childNodes=this.childNodes;childNodes.length>0;){if(childNodes[0].type())return!0;childNodes.shift()}return this.finished=!0,!1}}]),NodeTyper}();return NodeTyper}(),PRNGWrapper=function(){function PRNGWrapper(seed,useEntropy){_classCallCheck(this,PRNGWrapper),Object.defineProperties(this,new Math.seedrandom(seed,useEntropy,(function(prng,seed){return{_prng:{value:prng},seed:{writable:!0,value:seed},pull:{writable:!0,value:0},random:{value:function(){return++this.pull,this._prng()}}}})))}return _createClass(PRNGWrapper,null,[{key:"marshal",value:function(prng){if(!prng||!prng.hasOwnProperty("seed")||!prng.hasOwnProperty("pull"))throw new Error("PRNG is missing required data");return{seed:prng.seed,pull:prng.pull}}},{key:"unmarshal",value:function(prngObj){if(!prngObj||!prngObj.hasOwnProperty("seed")||!prngObj.hasOwnProperty("pull"))throw new Error("PRNG object is missing required data");for(var prng=new PRNGWrapper(prngObj.seed,!1),i=prngObj.pull;i>0;--i)prng.random();return prng}}]),PRNGWrapper}(),StyleWrapper=(_imageMarkupRe=new RegExp(Patterns.cssImage,"g"),_hasImageMarkupRe=new RegExp(Patterns.cssImage),function(){function StyleWrapper(style){if(_classCallCheck(this,StyleWrapper),null==style)throw new TypeError("StyleWrapper style parameter must be an HTMLStyleElement object");Object.defineProperties(this,{style:{value:style}})}return _createClass(StyleWrapper,[{key:"isEmpty",value:function(){return 0===this.style.cssRules.length}},{key:"set",value:function(rawCss){this.clear(),this.add(rawCss)}},{key:"add",value:function(rawCss){var css=rawCss;_hasImageMarkupRe.test(css)&&(_imageMarkupRe.lastIndex=0,css=css.replace(_imageMarkupRe,(function(wikiImage){var markup=Wikifier.helpers.parseSquareBracketedMarkup({source:wikiImage,matchStart:0});if(markup.hasOwnProperty("error")||markup.pos<wikiImage.length)return wikiImage;var source=markup.source;if("data:"!==source.slice(0,5)&&Story.has(source)){var passage=Story.get(source);passage.tags.includes("Twine.image")&&(source=passage.text.trim())}return'url("'.concat(source.replace(/"/g,"%22"),'")')}))),this.style.styleSheet?this.style.styleSheet.cssText+=css:this.style.appendChild(document.createTextNode(css))}},{key:"clear",value:function(){this.style.styleSheet?this.style.styleSheet.cssText="":jQuery(this.style).empty()}}]),StyleWrapper}()),_imageMarkupRe,_hasImageMarkupRe,Diff=(Op=Util.toEnum({Delete:0,SpliceArray:1,Copy:2,CopyDate:3}),Object.freeze(Object.defineProperties({},{Op:{value:Op},diff:{value:function diff(orig,dest){for(var aOpRef,objToString=Object.prototype.toString,origIsArray=orig instanceof Array,keys=[].concat(Object.keys(orig),Object.keys(dest)).sort().filter((function(val,i,arr){return 0===i||arr[i-1]!==val})),diffed={},keyIsAOpRef=function(key){return key===aOpRef},i=0,klen=keys.length;i<klen;++i){var key=keys[i],origP=orig[key],destP=dest[key];if(orig.hasOwnProperty(key))if(dest.hasOwnProperty(key)){if(origP===destP)continue;if(_typeof(origP)===_typeof(destP))if("function"==typeof origP)origP.toString()!==destP.toString()&&(diffed[key]=[Op.Copy,destP]);else if("object"!==_typeof(origP)||null===origP)diffed[key]=[Op.Copy,destP];else{var origPType=objToString.call(origP);if(origPType===objToString.call(destP))if(origP instanceof Date)Number(origP)!==Number(destP)&&(diffed[key]=[Op.Copy,clone(destP)]);else if(origP instanceof Map)diffed[key]=[Op.Copy,clone(destP)];else if(origP instanceof RegExp)origP.toString()!==destP.toString()&&(diffed[key]=[Op.Copy,clone(destP)]);else if(origP instanceof Set)diffed[key]=[Op.Copy,clone(destP)];else if("[object Object]"!==origPType)diffed[key]=[Op.Copy,clone(destP)];else{var recurse=diff(origP,destP);null!==recurse&&(diffed[key]=recurse)}else diffed[key]=[Op.Copy,clone(destP)]}else diffed[key]=[Op.Copy,"object"!==_typeof(destP)||null===destP?destP:clone(destP)]}else if(origIsArray&&Util.isNumeric(key)){var nKey=Number(key);if(!aOpRef){aOpRef="";do{aOpRef+="~"}while(keys.some(keyIsAOpRef));diffed[aOpRef]=[Op.SpliceArray,nKey,nKey]}nKey<diffed[aOpRef][1]&&(diffed[aOpRef][1]=nKey),nKey>diffed[aOpRef][2]&&(diffed[aOpRef][2]=nKey)}else diffed[key]=Op.Delete;else diffed[key]=[Op.Copy,"object"!==_typeof(destP)||null===destP?destP:clone(destP)]}return Object.keys(diffed).length>0?diffed:null}},patch:{value:function patch(orig,diffed){for(var keys=Object.keys(diffed||{}),patched=clone(orig),i=0,klen=keys.length;i<klen;++i){var key=keys[i],diffedP=diffed[key];if(diffedP===Op.Delete)delete patched[key];else if(diffedP instanceof Array)switch(diffedP[0]){case Op.SpliceArray:patched.splice(diffedP[1],diffedP[2]-diffedP[1]+1);break;case Op.Copy:patched[key]=clone(diffedP[1]);break;case Op.CopyDate:patched[key]=new Date(diffedP[1])}else patched[key]=patch(patched[key],diffedP)}return patched}}}))),Op,L10n=(_patternRe=/\{\w+\}/g,_hasPatternRe=new RegExp(_patternRe.source),Object.freeze(Object.defineProperties({},{init:{value:function(){strings&&Object.keys(strings).length>0&&Object.keys(l10nStrings).forEach((function(id){try{var value;switch(id){case"identity":value=strings.identity;break;case"aborting":value=strings.aborting;break;case"cancel":value=strings.cancel;break;case"close":value=strings.close;break;case"ok":value=strings.ok;break;case"errorTitle":value=strings.errors.title;break;case"errorNonexistentPassage":value=strings.errors.nonexistentPassage;break;case"errorSaveMissingData":value=strings.errors.saveMissingData;break;case"errorSaveIdMismatch":value=strings.errors.saveIdMismatch;break;case"warningDegraded":value=strings.warnings.degraded;break;case"debugViewTitle":value=strings.debugView.title;break;case"debugViewToggle":value=strings.debugView.toggle;break;case"uiBarToggle":value=strings.uiBar.toggle;break;case"uiBarBackward":value=strings.uiBar.backward;break;case"uiBarForward":value=strings.uiBar.forward;break;case"uiBarJumpto":value=strings.uiBar.jumpto;break;case"jumptoTitle":value=strings.jumpto.title;break;case"jumptoTurn":value=strings.jumpto.turn;break;case"jumptoUnavailable":value=strings.jumpto.unavailable;break;case"savesTitle":value=strings.saves.title;break;case"savesDisallowed":value=strings.saves.disallowed;break;case"savesIncapable":value=strings.saves.incapable;break;case"savesLabelAuto":value=strings.saves.labelAuto;break;case"savesLabelDelete":value=strings.saves.labelDelete;break;case"savesLabelExport":value=strings.saves.labelExport;break;case"savesLabelImport":value=strings.saves.labelImport;break;case"savesLabelLoad":value=strings.saves.labelLoad;break;case"savesLabelClear":value=strings.saves.labelClear;break;case"savesLabelSave":value=strings.saves.labelSave;break;case"savesLabelSlot":value=strings.saves.labelSlot;break;case"savesUnavailable":value=strings.saves.unavailable;break;case"savesUnknownDate":value=strings.saves.unknownDate;break;case"settingsTitle":value=strings.settings.title;break;case"settingsOff":value=strings.settings.off;break;case"settingsOn":value=strings.settings.on;break;case"settingsReset":value=strings.settings.reset;break;case"restartTitle":value=strings.restart.title;break;case"restartPrompt":value=strings.restart.prompt;break;case"shareTitle":value=strings.share.title;break;case"alertTitle":break;case"autoloadTitle":value=strings.autoload.title;break;case"autoloadCancel":value=strings.autoload.cancel;break;case"autoloadOk":value=strings.autoload.ok;break;case"autoloadPrompt":value=strings.autoload.prompt;break;case"macroBackText":value=strings.macros.back.text;break;case"macroReturnText":value=strings.macros.return.text}value&&(l10nStrings[id]=value.replace(/%\w+%/g,(function(pat){return"{".concat(pat.slice(1,-1),"}")})))}catch(ex){}}))}},get:{value:function(ids,overrides){if(!ids)return"";var selectedId,id=((Array.isArray(ids)?ids:[ids]).some((function(id){return!!l10nStrings.hasOwnProperty(id)&&(selectedId=id,!0)})),selectedId);if(!id)return"";for(var processed=l10nStrings[id],iteration=0;_hasPatternRe.test(processed);){if(++iteration>50)throw new Error("L10n.get exceeded maximum replacement iterations, probable infinite loop");_patternRe.lastIndex=0,processed=processed.replace(_patternRe,(function(pat){var subId=pat.slice(1,-1);return overrides&&overrides.hasOwnProperty(subId)?overrides[subId]:l10nStrings.hasOwnProperty(subId)?l10nStrings[subId]:void 0}))}return processed}}}))),_patternRe,_hasPatternRe,strings={errors:{},warnings:{},debugView:{},uiBar:{},jumpto:{},saves:{},settings:{},restart:{},share:{},autoload:{},macros:{back:{},return:{}}},l10nStrings={identity:"game",aborting:"Aborting",cancel:"Cancel",close:"Close",ok:"OK",errorTitle:"Error",errorToggle:"Toggle the error view",errorNonexistentPassage:'the passage "{passage}" does not exist',errorSaveDiskLoadFailed:"failed to load save file from disk",errorSaveMissingData:"save is missing required data. Either the loaded file is not a save or the save has become corrupted",errorSaveIdMismatch:"save is from the wrong {identity}",_warningIntroLacking:"Your browser either lacks or has disabled",_warningOutroDegraded:", so this {identity} is running in a degraded mode. You may be able to continue, however, some parts may not work properly.",warningNoWebStorage:"{_warningIntroLacking} the Web Storage API{_warningOutroDegraded}",warningDegraded:"{_warningIntroLacking} some of the capabilities required by this {identity}{_warningOutroDegraded}",debugBarToggle:"Toggle the debug bar",debugBarNoWatches:"— no watches set —",debugBarAddWatch:"Add watch",debugBarDeleteWatch:"Delete watch",debugBarWatchAll:"Watch all",debugBarWatchNone:"Delete all",debugBarLabelAdd:"Add",debugBarLabelWatch:"Watch",debugBarLabelTurn:"Turn",debugBarLabelViews:"Views",debugBarViewsToggle:"Toggle the debug views",debugBarWatchToggle:"Toggle the watch panel",uiBarToggle:"Toggle the UI bar",uiBarBackward:"Go backward within the {identity} history",uiBarForward:"Go forward within the {identity} history",uiBarJumpto:"Jump to a specific point within the {identity} history",jumptoTitle:"Jump To",jumptoTurn:"Turn",jumptoUnavailable:"No jump points currently available…",savesTitle:"Saves",savesDisallowed:"Saving has been disallowed on this passage.",savesIncapable:"{_warningIntroLacking} the capabilities required to support saves, so saves have been disabled for this session.",savesLabelAuto:"Autosave",savesLabelDelete:"Delete",savesLabelExport:"Save to Disk…",savesLabelImport:"Load from Disk…",savesLabelLoad:"Load",savesLabelClear:"Delete All",savesLabelSave:"Save",savesLabelSlot:"Slot",savesUnavailable:"No save slots found…",savesUnknownDate:"unknown",settingsTitle:"Settings",settingsOff:"Off",settingsOn:"On",settingsReset:"Reset to Defaults",restartTitle:"Restart",restartPrompt:"Are you sure that you want to restart? Unsaved progress will be lost.",shareTitle:"Share",alertTitle:"Alert",autoloadTitle:"Autoload",autoloadCancel:"Go to start",autoloadOk:"Load autosave",autoloadPrompt:"An autosave exists. Load it now or go to the start?",macroBackText:"Back",macroReturnText:"Return"},Config=(_debug=!1,_addVisitedLinkClass=!1,_cleanupWikifierOutput=!1,_loadDelay=0,_audioPauseOnFadeToZero=!0,_audioPreloadMetadata=!0,_historyControls=!0,_historyMaxStates=40,_macrosIfAssignmentError=!0,_macrosMaxLoopIterations=1e3,_macrosTypeSkipKey=" ",_macrosTypeVisitedPassages=!0,_passagesDisplayTitles=!1,_passagesNobr=!1,_savesId="untitled-story",_savesSlots=8,_savesTryDiskOnMobile=!0,_uiStowBarInitially=800,_uiUpdateStoryElements=!0,_errHistoryModeDeprecated="Config.history.mode has been deprecated and is no longer used by SugarCube, please remove it from your code",Object.freeze({get debug(){return _debug},set debug(value){_debug=Boolean(value)},get addVisitedLinkClass(){return _addVisitedLinkClass},set addVisitedLinkClass(value){_addVisitedLinkClass=Boolean(value)},get cleanupWikifierOutput(){return _cleanupWikifierOutput},set cleanupWikifierOutput(value){_cleanupWikifierOutput=Boolean(value)},get loadDelay(){return _loadDelay},set loadDelay(value){if(!Number.isSafeInteger(value)||value<0)throw new RangeError("Config.loadDelay must be a non-negative integer");_loadDelay=value},audio:Object.freeze({get pauseOnFadeToZero(){return _audioPauseOnFadeToZero},set pauseOnFadeToZero(value){_audioPauseOnFadeToZero=Boolean(value)},get preloadMetadata(){return _audioPreloadMetadata},set preloadMetadata(value){_audioPreloadMetadata=Boolean(value)}}),history:Object.freeze({get controls(){return _historyControls},set controls(value){var controls=Boolean(value);if(1===_historyMaxStates&&controls)throw new Error("Config.history.controls must be false when Config.history.maxStates is 1");_historyControls=controls},get maxStates(){return _historyMaxStates},set maxStates(value){if(!Number.isSafeInteger(value)||value<1)throw new RangeError("Config.history.maxStates must be a positive integer");_historyMaxStates=value,_historyControls&&1===value&&(_historyControls=!1)},get mode(){throw new Error(_errHistoryModeDeprecated)},set mode(_){throw new Error(_errHistoryModeDeprecated)},get tracking(){throw new Error("Config.history.tracking has been deprecated, use Config.history.maxStates instead")},set tracking(_){throw new Error("Config.history.tracking has been deprecated, use Config.history.maxStates instead")}}),macros:Object.freeze({get ifAssignmentError(){return _macrosIfAssignmentError},set ifAssignmentError(value){_macrosIfAssignmentError=Boolean(value)},get maxLoopIterations(){return _macrosMaxLoopIterations},set maxLoopIterations(value){if(!Number.isSafeInteger(value)||value<1)throw new RangeError("Config.macros.maxLoopIterations must be a positive integer");_macrosMaxLoopIterations=value},get typeSkipKey(){return _macrosTypeSkipKey},set typeSkipKey(value){_macrosTypeSkipKey=String(value)},get typeVisitedPassages(){return _macrosTypeVisitedPassages},set typeVisitedPassages(value){_macrosTypeVisitedPassages=Boolean(value)}}),navigation:Object.freeze({get override(){return _navigationOverride},set override(value){if(!(null==value||value instanceof Function))throw new TypeError("Config.navigation.override must be a function or null/undefined (received: ".concat(Util.getType(value),")"));_navigationOverride=value}}),passages:Object.freeze({get descriptions(){return _passagesDescriptions},set descriptions(value){if(null!=value){var valueType=Util.getType(value);if("boolean"!==valueType&&"Object"!==valueType&&"function"!==valueType)throw new TypeError("Config.passages.descriptions must be a boolean, object, function, or null/undefined (received: ".concat(valueType,")"))}_passagesDescriptions=value},get displayTitles(){return _passagesDisplayTitles},set displayTitles(value){_passagesDisplayTitles=Boolean(value)},get nobr(){return _passagesNobr},set nobr(value){_passagesNobr=Boolean(value)},get onProcess(){return _passagesOnProcess},set onProcess(value){if(null!=value){var valueType=Util.getType(value);if("function"!==valueType)throw new TypeError("Config.passages.onProcess must be a function or null/undefined (received: ".concat(valueType,")"))}_passagesOnProcess=value},get start(){return _passagesStart},set start(value){if(null!=value){var valueType=Util.getType(value);if("string"!==valueType)throw new TypeError("Config.passages.start must be a string or null/undefined (received: ".concat(valueType,")"))}_passagesStart=value},get transitionOut(){return _passagesTransitionOut},set transitionOut(value){if(null!=value){var valueType=Util.getType(value);if("string"!==valueType&&("number"!==valueType||!Number.isSafeInteger(value)||value<0))throw new TypeError("Config.passages.transitionOut must be a string, non-negative integer, or null/undefined (received: ".concat(valueType,")"))}_passagesTransitionOut=value}}),saves:Object.freeze({get autoload(){return _savesAutoload},set autoload(value){if(null!=value){var valueType=Util.getType(value);if("boolean"!==valueType&&"string"!==valueType&&"function"!==valueType)throw new TypeError("Config.saves.autoload must be a boolean, string, function, or null/undefined (received: ".concat(valueType,")"))}_savesAutoload=value},get autosave(){return _savesAutosave},set autosave(value){if(null!=value){var valueType=Util.getType(value);if("string"===valueType)return void(_savesAutosave=[value]);if("boolean"!==valueType&&("Array"!==valueType||!value.every((function(item){return"string"==typeof item})))&&"function"!==valueType)throw new TypeError("Config.saves.autosave must be a boolean, Array<string>, function, or null/undefined (received: ".concat(valueType).concat("Array"===valueType?"<any>":"",")"))}_savesAutosave=value},get id(){return _savesId},set id(value){if("string"!=typeof value||""===value)throw new TypeError("Config.saves.id must be a non-empty string (received: ".concat(Util.getType(value),")"));_savesId=value},get isAllowed(){return _savesIsAllowed},set isAllowed(value){if(!(null==value||value instanceof Function))throw new TypeError("Config.saves.isAllowed must be a function or null/undefined (received: ".concat(Util.getType(value),")"));_savesIsAllowed=value},get slots(){return _savesSlots},set slots(value){if(!Number.isSafeInteger(value)||value<0)throw new TypeError("Config.saves.slots must be a non-negative integer (received: ".concat(Util.getType(value),")"));_savesSlots=value},get tryDiskOnMobile(){return _savesTryDiskOnMobile},set tryDiskOnMobile(value){_savesTryDiskOnMobile=Boolean(value)},get version(){return _savesVersion},set version(value){_savesVersion=value},get onLoad(){throw new Error("Config.saves.onLoad has been deprecated, use the Save.onLoad API instead")},set onLoad(value){console.warn("Config.saves.onLoad has been deprecated, use the Save.onLoad API instead"),Save.onLoad.add(value)},get onSave(){throw new Error("Config.saves.onSave has been deprecated, use the Save.onSave API instead")},set onSave(value){console.warn("Config.saves.onSave has been deprecated, use the Save.onSave API instead"),Save.onSave.add(value)}}),ui:Object.freeze({get stowBarInitially(){return _uiStowBarInitially},set stowBarInitially(value){var valueType=Util.getType(value);if("boolean"!==valueType&&("number"!==valueType||!Number.isSafeInteger(value)||value<0))throw new TypeError("Config.ui.stowBarInitially must be a boolean or non-negative integer (received: ".concat(valueType,")"));_uiStowBarInitially=value},get updateStoryElements(){return _uiUpdateStoryElements},set updateStoryElements(value){_uiUpdateStoryElements=Boolean(value)}})})),_navigationOverride,_passagesDescriptions,_passagesStart,_passagesOnProcess,_passagesTransitionOut,_savesAutoload,_savesAutosave,_savesIsAllowed,_savesVersion,_debug,_addVisitedLinkClass,_cleanupWikifierOutput,_loadDelay,_audioPauseOnFadeToZero,_audioPreloadMetadata,_historyControls,_historyMaxStates,_macrosIfAssignmentError,_macrosMaxLoopIterations,_macrosTypeSkipKey,_macrosTypeVisitedPassages,_passagesDisplayTitles,_passagesNobr,_savesId,_savesSlots,_savesTryDiskOnMobile,_uiStowBarInitially,_uiUpdateStoryElements,_errHistoryModeDeprecated,SimpleAudio=function(){var _hasPromise,_gestureEventNames=Object.freeze(["click","contextmenu","dblclick","keyup","mouseup","pointerup","touchend"]),_specialIds=Object.freeze([":not",":all",":looped",":muted",":paused",":playing"]),_formatSpecRe=/^([\w-]+)\s*\|\s*(\S.*)$/,_badIdRe=/[:\s]/,_tracks=new Map,_groups=new Map,_lists=new Map,_subscribers=new Map,_masterRate=1,_masterVolume=1,_masterMute=!1,_masterMuteOnHidden=!1,_playReturnsPromise=(_hasPromise=null,function(){if(null!==_hasPromise)return _hasPromise;if(_hasPromise=!1,Has.audio)try{var audio=document.createElement("audio");audio.muted=!0;var value=audio.play();value.catch((function(){})),_hasPromise=value instanceof Promise}catch(ex){}return _hasPromise}),AudioTrack=function(){function AudioTrack(obj){if(_classCallCheck(this,AudioTrack),obj instanceof Array)this._create(obj);else{if(!(obj instanceof AudioTrack))throw new Error("sources parameter must be either an array, of URIs or source objects, or an AudioTrack instance");this._copy(obj)}}return _createClass(AudioTrack,[{key:"_create",value:function(sourceList){var dataUriRe=/^data:\s*audio\/(?:x-)?([^;,]+)\s*[;,]/i,extRe=/\.([^./\\]+)$/,formats=AudioTrack.formats,usedSources=[],audio=document.createElement("audio");audio.preload="none",sourceList.forEach((function(src){var srcUri=null;switch(_typeof(src)){case"string":var match;if("data:"===src.slice(0,5)){if(null===(match=dataUriRe.exec(src)))throw new Error("source data URI missing media type")}else if(null===(match=extRe.exec(Util.parseUrl(src).pathname)))throw new Error("source URL missing file extension");formats[match[1]]&&(srcUri=src);break;case"object":if(null===src)throw new Error("source object cannot be null");if(!src.hasOwnProperty("src"))throw new Error('source object missing required "src" property');if(!src.hasOwnProperty("format"))throw new Error('source object missing required "format" property');formats[src.format]&&(srcUri=src.src);break;default:throw new Error("invalid source value (type: ".concat(_typeof(src),")"))}if(null!==srcUri){var source=document.createElement("source");source.src=srcUri,audio.appendChild(source),usedSources.push(srcUri)}})),audio.hasChildNodes()&&Config.audio.preloadMetadata&&(audio.preload="metadata"),this._finalize(audio,usedSources,clone(sourceList))}},{key:"_copy",value:function(obj){this._finalize(obj.audio.cloneNode(!0),clone(obj.sources),clone(obj.originals))}},{key:"_finalize",value:function(audio,sources,originals){var _this3=this;Object.defineProperties(this,{audio:{configurable:!0,value:audio},sources:{value:Object.freeze(sources)},originals:{value:Object.freeze(originals)},_error:{writable:!0,value:!1},_faderId:{writable:!0,value:null},_mute:{writable:!0,value:!1},_rate:{writable:!0,value:1},_volume:{writable:!0,value:1}}),jQuery(this.audio).on("loadstart.AudioTrack",(function(){return _this3._error=!1})).on("error.AudioTrack",(function(){return _this3._error=!0})).find("source:last-of-type").on("error.AudioTrack",(function(){return _this3._trigger("error")})),function(id,callback){if("function"!=typeof callback)throw new Error("callback parameter must be a function");_subscribers.set(id,callback)}(this,(function(mesg){if(_this3.audio)switch(mesg){case"loadwithscreen":if(_this3.hasSource()){var lockId=LoadScreen.lock();_this3.one("canplaythrough.AudioTrack_loadwithscreen error.AudioTrack_loadwithscreen",(function(){jQuery(this).off(".AudioTrack_loadwithscreen"),LoadScreen.unlock(lockId)})).load()}break;case"load":_this3.load();break;case"mute":_this3._updateAudioMute();break;case"rate":_this3._updateAudioRate();break;case"stop":_this3.stop();break;case"volume":_this3._updateAudioVolume();break;case"unload":_this3.unload()}else unsubscribe(_this3)})),this._updateAudioMute(),this._updateAudioRate(),this._updateAudioVolume()}},{key:"_trigger",value:function(eventName){jQuery(this.audio).triggerHandler(eventName)}},{key:"_destroy",value:function(){unsubscribe(this),this.audio&&(jQuery(this.audio).off(),this.unload(),this._error=!0,delete this.audio)}},{key:"clone",value:function(){return new AudioTrack(this)}},{key:"load",value:function(){var _this4=this;if(this.fadeStop(),this.audio.pause(),!this.audio.hasChildNodes()){if(0===this.sources.length)return;this.sources.forEach((function(srcUri){var source=document.createElement("source");source.src=srcUri,_this4.audio.appendChild(source)}))}"auto"!==this.audio.preload&&(this.audio.preload="auto"),this.isLoading()||this.audio.load()}},{key:"unload",value:function(){this.fadeStop(),this.stop();var audio=this.audio;for(audio.preload="none";audio.hasChildNodes();)audio.removeChild(audio.firstChild);audio.load()}},{key:"play",value:function(){var _this5=this;if(!this.hasSource())return Promise.reject(new Error("none of the candidate sources were acceptable"));if(this.isUnloaded())return Promise.reject(new Error("no sources are loaded"));if(this.isFailed())return Promise.reject(new Error("failed to load any of the sources"));"auto"!==this.audio.preload&&(this.audio.preload="auto");var namespace=".AudioTrack_play";return _playReturnsPromise()?this.audio.play():new Promise((function(resolve,reject){_this5.isPlaying()?resolve():(jQuery(_this5.audio).off(namespace).one("error".concat(namespace," playing").concat(namespace," timeupdate").concat(namespace),(function(ev){jQuery(_this5).off(namespace),"error"===ev.type?reject(new Error("unknown audio play error")):resolve()})),_this5.audio.play())}))}},{key:"playWhenAllowed",value:function(){var _this6=this;this.play().catch((function(){var gestures=_gestureEventNames.map((function(name){return"".concat(name,".AudioTrack_playWhenAllowed")})).join(" ");jQuery(document).one(gestures,(function(){jQuery(document).off(".AudioTrack_playWhenAllowed"),_this6.audio.play()}))}))}},{key:"pause",value:function(){this.audio.pause()}},{key:"stop",value:function(){this.audio.pause(),this.time(0),this._trigger(":stopped")}},{key:"fade",value:function(duration,toVol,fromVol){var _this7=this;if("number"!=typeof duration)throw new TypeError("duration parameter must be a number");if("number"!=typeof toVol)throw new TypeError("toVolume parameter must be a number");if(null!=fromVol&&"number"!=typeof fromVol)throw new TypeError("fromVolume parameter must be a number");if(!this.hasSource())return Promise.reject(new Error("none of the candidate sources were acceptable"));if(this.isUnloaded())return Promise.reject(new Error("no sources are loaded"));if(this.isFailed())return Promise.reject(new Error("failed to load any of the sources"));this.fadeStop();var from=Math.clamp(null==fromVol?this.volume():fromVol,0,1),to=Math.clamp(toVol,0,1);return from!==to?(this.volume(from),jQuery(this.audio).off("timeupdate.AudioTrack_fade").one("timeupdate.AudioTrack_fade",(function(){var min,max;from<to?(min=from,max=to):(min=to,max=from);var time=Math.max(duration,1),delta=(to-from)/(time/.025);_this7._trigger(":fading"),_this7._faderId=setInterval((function(){_this7.isPlaying()?(_this7.volume(Math.clamp(_this7.volume()+delta,min,max)),Config.audio.pauseOnFadeToZero&&0===_this7.volume()&&_this7.pause(),_this7.volume()===to&&(_this7.fadeStop(),_this7._trigger(":faded"))):_this7.fadeStop()}),25)})),this.play()):void 0}},{key:"fadeIn",value:function(duration,fromVol){return this.fade(duration,1,fromVol)}},{key:"fadeOut",value:function(duration,fromVol){return this.fade(duration,0,fromVol)}},{key:"fadeStop",value:function(){null!==this._faderId&&(clearInterval(this._faderId),this._faderId=null)}},{key:"loop",value:function(_loop){return null==_loop?this.audio.loop:(this.audio.loop=!!_loop,this)}},{key:"mute",value:function(_mute){return null==_mute?this._mute:(this._mute=!!_mute,this._updateAudioMute(),this)}},{key:"_updateAudioMute",value:function(){this.audio.muted=this._mute||_masterMute}},{key:"rate",value:function(_rate){if(null==_rate)return this._rate;if("number"!=typeof _rate)throw new TypeError("rate parameter must be a number");return this._rate=Math.clamp(_rate,.2,5),this._updateAudioRate(),this}},{key:"_updateAudioRate",value:function(){this.audio.playbackRate=Math.clamp(this._rate*_masterRate,.2,5)}},{key:"time",value:function(_time){var _this8=this;if(null==_time)return this.audio.currentTime;if("number"!=typeof _time)throw new TypeError("time parameter must be a number");return this.hasMetadata()?this.audio.currentTime=_time:jQuery(this.audio).off("loadedmetadata.AudioTrack_time").one("loadedmetadata.AudioTrack_time",(function(){return _this8.audio.currentTime=_time})),this}},{key:"volume",value:function(_volume){if(null==_volume)return this._volume;if("number"!=typeof _volume)throw new TypeError("volume parameter must be a number");return this._volume=Math.clamp(_volume,0,1),this._updateAudioVolume(),this}},{key:"_updateAudioVolume",value:function(){this.audio.volume=Math.clamp(this._volume*_masterVolume,0,1)}},{key:"duration",value:function(){return this.audio.duration}},{key:"remaining",value:function(){return this.audio.duration-this.audio.currentTime}},{key:"isFailed",value:function(){return this._error}},{key:"isLoading",value:function(){return this.audio.networkState===HTMLMediaElement.NETWORK_LOADING}},{key:"isUnloaded",value:function(){return!this.audio.hasChildNodes()}},{key:"isUnavailable",value:function(){return!this.hasSource()||this.isUnloaded()||this.isFailed()}},{key:"isPlaying",value:function(){return!this.audio.paused&&this.hasSomeData()}},{key:"isPaused",value:function(){return this.audio.paused&&(this.audio.duration===1/0||this.audio.currentTime>0)&&!this.audio.ended}},{key:"isStopped",value:function(){return this.audio.paused&&0===this.audio.currentTime}},{key:"isEnded",value:function(){return this.audio.ended}},{key:"isFading",value:function(){return null!==this._faderId}},{key:"isSeeking",value:function(){return this.audio.seeking}},{key:"hasSource",value:function(){return this.sources.length>0}},{key:"hasNoData",value:function(){return this.audio.readyState===HTMLMediaElement.HAVE_NOTHING}},{key:"hasMetadata",value:function(){return this.audio.readyState>=HTMLMediaElement.HAVE_METADATA}},{key:"hasSomeData",value:function(){return this.audio.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA}},{key:"hasData",value:function(){return this.audio.readyState===HTMLMediaElement.HAVE_ENOUGH_DATA}},{key:"on",value:function(){for(var _len5=arguments.length,args=new Array(_len5),_key5=0;_key5<_len5;_key5++)args[_key5]=arguments[_key5];return jQuery.fn.on.apply(jQuery(this.audio),args),this}},{key:"one",value:function(){for(var _len6=arguments.length,args=new Array(_len6),_key6=0;_key6<_len6;_key6++)args[_key6]=arguments[_key6];return jQuery.fn.one.apply(jQuery(this.audio),args),this}},{key:"off",value:function(){for(var _len7=arguments.length,args=new Array(_len7),_key7=0;_key7<_len7;_key7++)args[_key7]=arguments[_key7];return jQuery.fn.off.apply(jQuery(this.audio),args),this}}]),AudioTrack}();Object.defineProperties(AudioTrack,{formats:{value:function(){var audio=document.createElement("audio"),types=new Map;function canPlay(mimeType){return types.has(mimeType)||types.set(mimeType,""!==audio.canPlayType(mimeType).replace(/^no$/i,"")),types.get(mimeType)}return Object.assign(Object.create(null),{aac:canPlay("audio/aac"),caf:canPlay("audio/x-caf")||canPlay("audio/caf"),flac:canPlay("audio/x-flac")||canPlay("audio/flac"),mp3:canPlay('audio/mpeg; codecs="mp3"')||canPlay("audio/mpeg")||canPlay("audio/mp3")||canPlay("audio/mpa"),mpeg:canPlay("audio/mpeg"),m4a:canPlay("audio/x-m4a")||canPlay("audio/m4a")||canPlay("audio/aac"),mp4:canPlay("audio/x-mp4")||canPlay("audio/mp4")||canPlay("audio/aac"),ogg:canPlay("audio/ogg"),oga:canPlay("audio/ogg"),opus:canPlay('audio/ogg; codecs="opus"')||canPlay("audio/opus"),wav:canPlay('audio/wave; codecs="1"')||canPlay('audio/wav; codecs="1"')||canPlay("audio/wave")||canPlay("audio/wav"),wave:canPlay('audio/wave; codecs="1"')||canPlay('audio/wav; codecs="1"')||canPlay("audio/wave")||canPlay("audio/wav"),weba:canPlay("audio/webm"),webm:canPlay("audio/webm")})}()}});var AudioList=function(){function AudioList(obj){if(_classCallCheck(this,AudioList),obj instanceof Array)this._create(obj);else{if(!(obj instanceof AudioList))throw new Error("tracks parameter must be either an array, of track objects, or an AudioTrack instance");this._copy(obj)}}return _createClass(AudioList,[{key:"_create",value:function(trackList){var _this9=this;this._finalize(trackList.map((function(trackObj){if("object"!==_typeof(trackObj))throw new Error("tracks parameter array members must be objects");var own,rate,track,volume;if(trackObj instanceof AudioTrack)own=!0,rate=trackObj.rate(),track=trackObj.clone(),volume=trackObj.volume();else{if(!trackObj.hasOwnProperty("track"))throw new Error('track object missing required "track" property');if(!(trackObj.track instanceof AudioTrack))throw new Error('track object\'s "track" property must be an AudioTrack object');own=trackObj.hasOwnProperty("own")&&trackObj.own,rate=trackObj.hasOwnProperty("rate")?trackObj.rate:trackObj.track.rate(),track=trackObj.track,volume=trackObj.hasOwnProperty("volume")?trackObj.volume:trackObj.track.volume()}return track.stop(),track.loop(!1),track.mute(!1),track.rate(rate),track.volume(volume),track.on("ended.AudioList",(function(){return _this9._onEnd()})),{own:own,track:track,volume:volume,rate:rate}})))}},{key:"_copy",value:function(obj){this._finalize(clone(obj.tracks))}},{key:"_finalize",value:function(tracks){Object.defineProperties(this,{tracks:{configurable:!0,value:Object.freeze(tracks)},queue:{configurable:!0,value:[]},current:{writable:!0,value:null},_rate:{writable:!0,value:1},_volume:{writable:!0,value:1},_mute:{writable:!0,value:!1},_loop:{writable:!0,value:!1},_shuffle:{writable:!0,value:!1}})}},{key:"_destroy",value:function(){this.stop(),this.tracks.filter((function(trackObj){return trackObj.own})).forEach((function(trackObj){return trackObj.track._destroy()})),delete this.tracks,delete this.queue}},{key:"load",value:function(){this.tracks.forEach((function(trackObj){return trackObj.track.load()}))}},{key:"unload",value:function(){this.stop(),this.tracks.forEach((function(trackObj){return trackObj.track.unload()}))}},{key:"play",value:function(){return null!==this.current&&!this.current.track.isUnavailable()&&!this.current.track.isEnded()||(0===this.queue.length&&this._fillQueue(),this._next())?this.current.track.play():Promise.reject(new Error("no tracks were available"))}},{key:"playWhenAllowed",value:function(){var _this10=this;this.play().catch((function(){var gestures=_gestureEventNames.map((function(name){return"".concat(name,".AudioList_playWhenAllowed")})).join(" ");jQuery(document).one(gestures,(function(){jQuery(document).off(".AudioList_playWhenAllowed"),_this10.play()}))}))}},{key:"pause",value:function(){null!==this.current&&this.current.track.pause()}},{key:"stop",value:function(){null!==this.current&&(this.current.track.stop(),this.current=null),this._drainQueue()}},{key:"skip",value:function(){this._next()?this.current.track.play():this._loop&&this.play()}},{key:"fade",value:function(duration,toVol,fromVol){if("number"!=typeof duration)throw new TypeError("duration parameter must be a number");if("number"!=typeof toVol)throw new TypeError("toVolume parameter must be a number");if(null!=fromVol&&"number"!=typeof fromVol)throw new TypeError("fromVolume parameter must be a number");if(0===this.queue.length&&this._fillQueue(),null!==this.current&&!this.current.track.isUnavailable()&&!this.current.track.isEnded()||this._next()){var adjFromVol,adjToVol=Math.clamp(toVol,0,1)*this.current.volume;return null!=fromVol&&(adjFromVol=Math.clamp(fromVol,0,1)*this.current.volume),this._volume=toVol,this.current.track.fade(duration,adjToVol,adjFromVol)}}},{key:"fadeIn",value:function(duration,fromVol){return this.fade(duration,1,fromVol)}},{key:"fadeOut",value:function(duration,fromVol){return this.fade(duration,0,fromVol)}},{key:"fadeStop",value:function(){null!==this.current&&this.current.track.fadeStop()}},{key:"loop",value:function(_loop2){return null==_loop2?this._loop:(this._loop=!!_loop2,this)}},{key:"mute",value:function(_mute2){return null==_mute2?this._mute:(this._mute=!!_mute2,null!==this.current&&this.current.track.mute(this._mute),this)}},{key:"rate",value:function(_rate2){if(null==_rate2)return this._rate;if("number"!=typeof _rate2)throw new TypeError("rate parameter must be a number");return this._rate=Math.clamp(_rate2,.2,5),null!==this.current&&this.current.track.rate(this._rate*this.current.rate),this}},{key:"shuffle",value:function(_shuffle){var _this11=this;if(null==_shuffle)return this._shuffle;if(this._shuffle=!!_shuffle,this.queue.length>0&&(this._fillQueue(),!this._shuffle&&null!==this.current&&this.queue.length>1)){var _this$queue,firstIdx=this.queue.findIndex((function(trackObj){return trackObj===_this11.current}));if(-1!==firstIdx)(_this$queue=this.queue).push.apply(_this$queue,_toConsumableArray(this.queue.splice(0,firstIdx+1)))}return this}},{key:"volume",value:function(_volume2){if(null==_volume2)return this._volume;if("number"!=typeof _volume2)throw new TypeError("volume parameter must be a number");return this._volume=Math.clamp(_volume2,0,1),null!==this.current&&this.current.track.volume(this._volume*this.current.volume),this}},{key:"duration",value:function(){if(arguments.length>0)throw new Error("duration takes no parameters");return this.tracks.map((function(trackObj){return trackObj.track.duration()})).reduce((function(prev,cur){return prev+cur}),0)}},{key:"remaining",value:function(){if(arguments.length>0)throw new Error("remaining takes no parameters");var remainingTime=this.queue.map((function(trackObj){return trackObj.track.duration()})).reduce((function(prev,cur){return prev+cur}),0);return null!==this.current&&(remainingTime+=this.current.track.remaining()),remainingTime}},{key:"time",value:function(){if(arguments.length>0)throw new Error("time takes no parameters");return this.duration()-this.remaining()}},{key:"isPlaying",value:function(){return null!==this.current&&this.current.track.isPlaying()}},{key:"isPaused",value:function(){return null===this.current||this.current.track.isPaused()}},{key:"isStopped",value:function(){return 0===this.queue.length&&null===this.current}},{key:"isEnded",value:function(){return 0===this.queue.length&&(null===this.current||this.current.track.isEnded())}},{key:"isFading",value:function(){return null!==this.current&&this.current.track.isFading()}},{key:"_next",value:function(){var nextTrack;for(null!==this.current&&(this.current.track.stop(),this.current=null);nextTrack=this.queue.shift();)if(!nextTrack.track.isUnavailable()){this.current=nextTrack;break}return null!==this.current&&(this.current.track.mute(this._mute),this.current.track.rate(this._rate*this.current.rate),this.current.track.volume(this._volume*this.current.volume),this.current.track.loop(!1),!0)}},{key:"_onEnd",value:function(){if(0===this.queue.length){if(!this._loop)return;this._fillQueue()}this._next()&&this.current.track.play()}},{key:"_drainQueue",value:function(){this.queue.splice(0)}},{key:"_fillQueue",value:function(){var _this$queue2;this._drainQueue(),(_this$queue2=this.queue).push.apply(_this$queue2,_toConsumableArray(this.tracks.filter((function(trackObj){return!trackObj.track.isUnavailable()})))),0!==this.queue.length&&this._shuffle&&(this.queue.shuffle(),this.queue.length>1&&this.queue[0]===this.current&&this.queue.push(this.queue.shift()))}}]),AudioList}(),AudioRunner=function(){function AudioRunner(list){if(_classCallCheck(this,AudioRunner),!(list instanceof Set||list instanceof AudioRunner))throw new TypeError("list parameter must be a Set or a AudioRunner instance");Object.defineProperties(this,{trackIds:{value:new Set(list instanceof AudioRunner?list.trackIds:list)}})}return _createClass(AudioRunner,[{key:"load",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.load)}},{key:"unload",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.unload)}},{key:"play",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.play)}},{key:"playWhenAllowed",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.playWhenAllowed)}},{key:"pause",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.pause)}},{key:"stop",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.stop)}},{key:"fade",value:function(duration,toVol,fromVol){if(null==duration||null==toVol)throw new Error("fade requires parameters");AudioRunner._run(this.trackIds,AudioTrack.prototype.fade,duration,toVol,fromVol)}},{key:"fadeIn",value:function(duration,fromVol){if(null==duration)throw new Error("fadeIn requires a parameter");AudioRunner._run(this.trackIds,AudioTrack.prototype.fadeIn,duration,fromVol)}},{key:"fadeOut",value:function(duration,fromVol){if(null==duration)throw new Error("fadeOut requires a parameter");AudioRunner._run(this.trackIds,AudioTrack.prototype.fadeOut,duration,fromVol)}},{key:"fadeStop",value:function(){AudioRunner._run(this.trackIds,AudioTrack.prototype.fadeStop)}},{key:"loop",value:function(_loop3){if(null==_loop3)throw new Error("loop requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.loop,_loop3),this}},{key:"mute",value:function(_mute3){if(null==_mute3)throw new Error("mute requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.mute,_mute3),this}},{key:"rate",value:function(_rate3){if(null==_rate3)throw new Error("rate requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.rate,_rate3),this}},{key:"time",value:function(_time2){if(null==_time2)throw new Error("time requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.time,_time2),this}},{key:"volume",value:function(_volume3){if(null==_volume3)throw new Error("volume requires a parameter");return AudioRunner._run(this.trackIds,AudioTrack.prototype.volume,_volume3),this}},{key:"on",value:function(){for(var _len8=arguments.length,args=new Array(_len8),_key8=0;_key8<_len8;_key8++)args[_key8]=arguments[_key8];return AudioRunner._run.apply(AudioRunner,[this.trackIds,AudioTrack.prototype.on].concat(args)),this}},{key:"one",value:function(){for(var _len9=arguments.length,args=new Array(_len9),_key9=0;_key9<_len9;_key9++)args[_key9]=arguments[_key9];return AudioRunner._run.apply(AudioRunner,[this.trackIds,AudioTrack.prototype.one].concat(args)),this}},{key:"off",value:function(){for(var _len10=arguments.length,args=new Array(_len10),_key10=0;_key10<_len10;_key10++)args[_key10]=arguments[_key10];return AudioRunner._run.apply(AudioRunner,[this.trackIds,AudioTrack.prototype.off].concat(args)),this}}],[{key:"_run",value:function(ids,fn){for(var _len11=arguments.length,args=new Array(_len11>2?_len11-2:0),_key11=2;_key11<_len11;_key11++)args[_key11-2]=arguments[_key11];ids.forEach((function(id){var track=_tracks.get(id);track&&fn.apply(track,args)}))}}]),AudioRunner}();var _runnerParseSelector=function(){var notWsRe=/\S/g,parenRe=/[()]/g;function processNegation(str,startPos){var match;if(notWsRe.lastIndex=startPos,null===(match=notWsRe.exec(str))||"("!==match[0])throw new Error('invalid ":not()" syntax: missing parentheticals');parenRe.lastIndex=notWsRe.lastIndex;for(var start=notWsRe.lastIndex,result={str:"",nextMatch:-1},depth=1;null!==(match=parenRe.exec(str));)if("("===match[0]?++depth:--depth,depth<1){result.nextMatch=parenRe.lastIndex,result.str=str.slice(start,result.nextMatch-1);break}return result}return function parseSelector(idArg){for(var match,ids=[],idRe=/:?[^\s:()]+/g;null!==(match=idRe.exec(idArg));){var id=match[0];if(":not"===id){if(0===ids.length)throw new Error('invalid negation: no group ID preceded ":not()"');var parent=ids[ids.length-1];if(":"!==parent.id[0])throw new Error('invalid negation of track "'.concat(parent.id,'": only groups may be negated with ":not()"'));var negation=processNegation(idArg,idRe.lastIndex);if(-1===negation.nextMatch)throw new Error('unknown error parsing ":not()"');idRe.lastIndex=negation.nextMatch,parent.not=parseSelector(negation.str)}else ids.push({id:id})}return ids}}();function masterMute(mute){if(null==mute)return _masterMute;publish("mute",_masterMute=!!mute)}function unsubscribe(id){_subscribers.delete(id)}function publish(mesg,data){_subscribers.forEach((function(fn){return fn(mesg,data)}))}function _newTrack(sources){return new AudioTrack(sources.map((function(source){if("data:"!==source.slice(0,5)&&Story.has(source)){var passage=Story.get(source);if(passage.tags.includes("Twine.audio"))return passage.text.trim()}var match=_formatSpecRe.exec(source);return null===match?source:{format:match[1],src:match[2]}})))}return Object.freeze(Object.defineProperties({},{tracks:{value:Object.freeze(Object.defineProperties({},{add:{value:function(){if(arguments.length<2){var errors=[];throw arguments.length<1&&errors.push("track ID"),arguments.length<2&&errors.push("sources"),new Error("no ".concat(errors.join(" or ")," specified"))}var id=String(arguments[0]).trim(),what='track ID "'.concat(id,'"');if(_badIdRe.test(id))throw new Error("invalid ".concat(what,": track IDs must not contain colons or whitespace"));var track,sources=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1);try{track=_newTrack(sources)}catch(ex){throw new Error("".concat(what,": error during track initialization: ").concat(ex.message))}if(Config.debug&&!track.hasSource())throw new Error("".concat(what,": no supported audio sources found"));_tracks.has(id)&&_tracks.get(id)._destroy(),_tracks.set(id,track)}},delete:{value:function(id){return _tracks.has(id)&&_tracks.get(id)._destroy(),_tracks.delete(id)}},clear:{value:function(){_tracks.forEach((function(track){return track._destroy()})),_tracks.clear()}},has:{value:function(id){return _tracks.has(id)}},get:{value:function(id){return _tracks.get(id)||null}}}))},groups:{value:Object.freeze(Object.defineProperties({},{add:{value:function(){if(arguments.length<2){var errors=[];throw arguments.length<1&&errors.push("group ID"),arguments.length<2&&errors.push("track IDs"),new Error("no ".concat(errors.join(" or ")," specified"))}var id=String(arguments[0]).trim(),what='group ID "'.concat(id,'"');if(":"!==id[0]||_badIdRe.test(id.slice(1)))throw new Error("invalid ".concat(what,": group IDs must start with a colon and must not contain colons or whitespace"));if(_specialIds.includes(id))throw new Error("cannot clobber special ".concat(what));var group,trackIds=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1);try{group=new Set(trackIds.map((function(trackId){if(!_tracks.has(trackId))throw new Error('track "'.concat(trackId,'" does not exist'));return trackId})))}catch(ex){throw new Error("".concat(what,": error during group initialization: ").concat(ex.message))}_groups.set(id,Object.freeze(Array.from(group)))}},delete:{value:function(id){return _groups.delete(id)}},clear:{value:function(){_groups.clear()}},has:{value:function(id){return _groups.has(id)}},get:{value:function(id){return _groups.get(id)||null}}}))},lists:{value:Object.freeze(Object.defineProperties({},{add:{value:function(){if(arguments.length<2){var errors=[];throw arguments.length<1&&errors.push("list ID"),arguments.length<2&&errors.push("track IDs"),new Error("no ".concat(errors.join(" or ")," specified"))}var id=String(arguments[0]).trim(),what='list ID "'.concat(id,'"');if(_badIdRe.test(id))return this.error("invalid ".concat(what,": list IDs must not contain colons or whitespace"));var list,descriptors=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1);try{list=new AudioList(descriptors.map((function(desc){if(null===desc)throw new Error("track descriptor must be a string or object (type: null)");switch(_typeof(desc)){case"string":desc={id:desc};break;case"object":if(!desc.hasOwnProperty("id")&&!desc.hasOwnProperty("sources"))throw new Error('track descriptor must contain one of either an "id" or a "sources" property');if(desc.hasOwnProperty("id")&&desc.hasOwnProperty("sources"))throw new Error('track descriptor must contain either an "id" or a "sources" property, not both');break;default:throw new Error("track descriptor must be a string or object (type: ".concat(_typeof(desc),")"))}var own,track,volume;if(desc.hasOwnProperty("id")){if("string"!=typeof desc.id)throw new Error('"id" property must be a string');if(!_tracks.has(desc.id))throw new Error('track "'.concat(desc.id,'" does not exist'));track=_tracks.get(desc.id)}else if(desc.hasOwnProperty("sources")){if(!Array.isArray(desc.sources)||0===desc.sources.length)throw new Error('"sources" property must be a non-empty array');if(desc.hasOwnProperty("own"))throw new Error('"own" property is not allowed with the "sources" property');try{track=_newTrack(desc.sources),own=!0}catch(ex){throw new Error("error during track initialization: ".concat(ex.message))}if(Config.debug&&!track.hasSource())throw new Error("no supported audio sources found")}if(desc.hasOwnProperty("own")){if("boolean"!=typeof desc.own)throw new Error('"own" property must be a boolean');(own=desc.own)&&(track=track.clone())}if(desc.hasOwnProperty("volume")){if("number"!=typeof desc.volume||Number.isNaN(desc.volume)||!Number.isFinite(desc.volume)||desc.volume<0)throw new Error('"volume" property must be a non-negative finite number');volume=desc.volume}return{own:null!=own&&own,track:track,volume:null!=volume?volume:track.volume()}})))}catch(ex){throw new Error("".concat(what,": error during playlist initialization: ").concat(ex.message))}_lists.has(id)&&_lists.get(id)._destroy(),_lists.set(id,list)}},delete:{value:function(id){return _lists.has(id)&&_lists.get(id)._destroy(),_lists.delete(id)}},clear:{value:function(){_lists.forEach((function(list){return list._destroy()})),_lists.clear()}},has:{value:function(id){return _lists.has(id)}},get:{value:function(id){return _lists.get(id)||null}}}))},select:{value:function(){if(0===arguments.length)throw new Error("no track selector specified");var selector=String(arguments[0]).trim(),trackIds=new Set;try{var renderIds=function renderIds(idObj){var ids,id=idObj.id;switch(id){case":all":ids=allIds;break;case":looped":ids=allIds.filter((function(id){return _tracks.get(id).loop()}));break;case":muted":ids=allIds.filter((function(id){return _tracks.get(id).mute()}));break;case":paused":ids=allIds.filter((function(id){return _tracks.get(id).isPaused()}));break;case":playing":ids=allIds.filter((function(id){return _tracks.get(id).isPlaying()}));break;default:ids=":"===id[0]?_groups.get(id):[id]}if(idObj.hasOwnProperty("not")){var negated=idObj.not.map((function(idObj){return renderIds(idObj)})).flat(1/0);ids=ids.filter((function(id){return!negated.includes(id)}))}return ids},allIds=Array.from(_tracks.keys());_runnerParseSelector(selector).forEach((function(idObj){return renderIds(idObj).forEach((function(id){if(!_tracks.has(id))throw new Error('track "'.concat(id,'" does not exist'));trackIds.add(id)}))}))}catch(ex){throw new Error("error during runner initialization: ".concat(ex.message))}return new AudioRunner(trackIds)}},load:{value:function(){publish("load")}},loadWithScreen:{value:function(){publish("loadwithscreen")}},mute:{value:masterMute},muteOnHidden:{value:function(mute){if(!Visibility.isEnabled())return!1;if(null==mute)return _masterMuteOnHidden;var namespace=".SimpleAudio_masterMuteOnHidden";if(_masterMuteOnHidden=!!mute){var visibilityChange="".concat(Visibility.changeEvent).concat(namespace);jQuery(document).off(namespace).on(visibilityChange,(function(){return masterMute(Visibility.isHidden())})),Visibility.isHidden()&&masterMute(!0)}else jQuery(document).off(namespace)}},rate:{value:function(rate){if(null==rate)return _masterRate;if("number"!=typeof rate||Number.isNaN(rate)||!Number.isFinite(rate))throw new Error("rate must be a finite number");publish("rate",_masterRate=Math.clamp(rate,.2,5))}},stop:{value:function(){publish("stop")}},unload:{value:function(){publish("unload")}},volume:{value:function(volume){if(null==volume)return _masterVolume;if("number"!=typeof volume||Number.isNaN(volume)||!Number.isFinite(volume))throw new Error("volume must be a finite number");publish("volume",_masterVolume=Math.clamp(volume,0,1))}}}))}(),State=function(){var _history=[],_active=momentCreate(),_activeIndex=-1,_expired=[],_prng=null,_tempVariables={};function stateMarshal(noDelta){var stateObj={index:_activeIndex};return noDelta?stateObj.history=clone(_history):stateObj.delta=historyDeltaEncode(_history),_expired.length>0&&(stateObj.expired=_toConsumableArray(_expired)),null!==_prng&&(stateObj.seed=_prng.seed),stateObj}function stateUnmarshal(stateObj,noDelta){if(null==stateObj)throw new Error("state object is null or undefined");if(!stateObj.hasOwnProperty(noDelta?"history":"delta")||0===stateObj[noDelta?"history":"delta"].length)throw new Error("state object has no history or history is empty");if(!stateObj.hasOwnProperty("index"))throw new Error("state object has no index");if(null!==_prng&&!stateObj.hasOwnProperty("seed"))throw new Error("state object has no seed, but PRNG is enabled");if(null===_prng&&stateObj.hasOwnProperty("seed"))throw new Error("state object has seed, but PRNG is disabled");_history=noDelta?clone(stateObj.history):historyDeltaDecode(stateObj.delta),_activeIndex=stateObj.index,_expired=stateObj.hasOwnProperty("expired")?_toConsumableArray(stateObj.expired):[],stateObj.hasOwnProperty("seed")&&(_prng.seed=stateObj.seed),momentActivate(_activeIndex)}function momentCreate(title,variables){return{title:null==title?"":String(title),variables:null==variables?{}:clone(variables)}}function momentActivate(moment){if(null==moment)throw new Error("moment activation attempted with null or undefined");switch(_typeof(moment)){case"object":_active=clone(moment);break;case"number":if(historyIsEmpty())throw new Error("moment activation attempted with index on empty history");if(moment<0||moment>=historySize())throw new RangeError("moment activation attempted with out-of-bounds index; need [0, ".concat(historySize()-1,"], got ").concat(moment));_active=clone(_history[moment]);break;default:throw new TypeError('moment activation attempted with a "'.concat(_typeof(moment),'"; must be an object or valid history stack index'))}return null!==_prng&&(_prng=PRNGWrapper.unmarshal({seed:_prng.seed,pull:_active.pull})),session.set("state",stateMarshal()),jQuery.event.trigger(":historyupdate"),_active}function historyLength(){return _activeIndex+1}function historySize(){return _history.length}function historyIsEmpty(){return 0===_history.length}function historyTop(){return _history.length>0?_history[_history.length-1]:null}function historyGoTo(index){return!(null==index||index<0||index>=historySize()||index===_activeIndex)&&(momentActivate(_activeIndex=index),!0)}function historyDeltaEncode(historyArr){if(!Array.isArray(historyArr))return null;if(0===historyArr.length)return[];for(var delta=[historyArr[0]],i=1,iend=historyArr.length;i<iend;++i)delta.push(Diff.diff(historyArr[i-1],historyArr[i]));return delta}function historyDeltaDecode(delta){if(!Array.isArray(delta))return null;if(0===delta.length)return[];for(var historyArr=[clone(delta[0])],i=1,iend=delta.length;i<iend;++i)historyArr.push(Diff.patch(historyArr[i-1],delta[i]));return historyArr}function prngInit(seed,useEntropy){var scriptSection;if(!historyIsEmpty())throw scriptSection="the Story JavaScript",new Error("State.prng.init must be called during initialization, within either ".concat(scriptSection," or the StoryInit special passage"));_prng=new PRNGWrapper(seed,useEntropy),_active.pull=_prng.pull}function metadataDelete(key){if("string"!=typeof key)throw new TypeError("State.metadata.delete key parameter must be a string (received: ".concat(_typeof(key),")"));var store=storage.get("metadata");store&&store.hasOwnProperty(key)&&(1===Object.keys(store).length?storage.delete("metadata"):(delete store[key],storage.set("metadata",store)))}return Object.freeze(Object.defineProperties({},{reset:{value:function(){session.delete("state"),_history=[],_active=momentCreate(),_activeIndex=-1,_expired=[],_prng=null===_prng?null:new PRNGWrapper(_prng.seed,!1)}},restore:{value:function(){if(session.has("state")){var stateObj=session.get("state");return null!=stateObj&&(stateUnmarshal(stateObj),!0)}return!1}},marshalForSave:{value:function(){return stateMarshal(!0)}},unmarshalForSave:{value:function(stateObj){return stateUnmarshal(stateObj,!0)}},expired:{get:function(){return _expired}},turns:{get:function(){return _expired.length+historyLength()}},passages:{get:function(){return _expired.concat(_history.slice(0,historyLength()).map((function(moment){return moment.title})))}},hasPlayed:{value:function(title){return null!=title&&""!==title&&(!!_expired.includes(title)||!!_history.slice(0,historyLength()).some((function(moment){return moment.title===title})))}},active:{get:function(){return _active}},activeIndex:{get:function(){return _activeIndex}},passage:{get:function(){return _active.title}},variables:{get:function(){return _active.variables}},history:{get:function(){return _history}},length:{get:historyLength},size:{get:historySize},isEmpty:{value:historyIsEmpty},current:{get:function(){return _history.length>0?_history[_activeIndex]:null}},top:{get:historyTop},bottom:{get:function(){return _history.length>0?_history[0]:null}},index:{value:function(index){return historyIsEmpty()||index<0||index>_activeIndex?null:_history[index]}},peek:{value:function(offset){if(historyIsEmpty())return null;var lengthOffset=1+(offset?Math.abs(offset):0);return lengthOffset>historyLength()?null:_history[historyLength()-lengthOffset]}},has:{value:function(title){if(historyIsEmpty()||null==title||""===title)return!1;for(var i=_activeIndex;i>=0;--i)if(_history[i].title===title)return!0;return!1}},create:{value:function(title){for(0,historyLength()<historySize()&&_history.splice(historyLength(),historySize()-historyLength()),_history.push(momentCreate(title,_active.variables)),_prng&&(historyTop().pull=_prng.pull);historySize()>Config.history.maxStates;)_expired.push(_history.shift().title);return momentActivate(_activeIndex=historySize()-1),historyLength()}},goTo:{value:historyGoTo},go:{value:function(offset){return null!=offset&&0!==offset&&historyGoTo(_activeIndex+offset)}},deltaEncode:{value:historyDeltaEncode},deltaDecode:{value:historyDeltaDecode},prng:{value:Object.freeze(Object.defineProperties({},{init:{value:prngInit},isEnabled:{value:function(){return null!==_prng}},pull:{get:function(){return _prng?_prng.pull:NaN}},seed:{get:function(){return _prng?_prng.seed:null}}}))},random:{value:function(){return _prng?_prng.random():Math.random()}},clearTemporary:{value:function(){TempVariables=_tempVariables={}}},temporary:{get:function(){return _tempVariables}},getVar:{value:function(varExpression){try{return Scripting.evalTwineScript(varExpression)}catch(ex){}}},setVar:{value:function(varExpression,value){try{return Scripting.evalTwineScript("".concat(varExpression," = evalTwineScript$Data$"),null,value),!0}catch(ex){}return!1}},metadata:{value:Object.freeze(Object.defineProperties({},{clear:{value:function(){storage.delete("metadata")}},delete:{value:metadataDelete},entries:{value:function(){var store=storage.get("metadata");return store&&Object.entries(store)}},get:{value:function(key){if("string"!=typeof key)throw new TypeError("State.metadata.get key parameter must be a string (received: ".concat(_typeof(key),")"));var store=storage.get("metadata");return store&&store.hasOwnProperty(key)?store[key]:undefined}},has:{value:function(key){if("string"!=typeof key)throw new TypeError("State.metadata.has key parameter must be a string (received: ".concat(_typeof(key),")"));var store=storage.get("metadata");return store&&store.hasOwnProperty(key)}},keys:{value:function(){var store=storage.get("metadata");return store&&Object.keys(store)}},set:{value:function(key,value){if("string"!=typeof key)throw new TypeError("State.metadata.set key parameter must be a string (received: ".concat(_typeof(key),")"));if(void 0===value)metadataDelete(key);else{var store=storage.get("metadata")||{};store[key]=value,storage.set("metadata",store)}}},size:{get:function(){var store=storage.get("metadata");return store?Object.keys(store).length:0}}}))},initPRNG:{value:prngInit},restart:{value:function(){return Engine.restart()}},backward:{value:function(){return Engine.backward()}},forward:{value:function(){return Engine.forward()}},display:{value:function(){return Engine.display.apply(Engine,arguments)}},show:{value:function(){return Engine.show.apply(Engine,arguments)}},play:{value:function(){return Engine.play.apply(Engine,arguments)}}}))}(),Scripting=function(){function addAccessibleClickHandler(targets,selector,handler,one,namespace){if(arguments.length<2)throw new Error("addAccessibleClickHandler insufficient number of parameters");var fn,opts;if("function"==typeof selector?(fn=selector,opts={namespace:one,one:!!handler}):(fn=handler,opts={namespace:namespace,one:!!one,selector:selector}),"function"!=typeof fn)throw new TypeError("addAccessibleClickHandler handler parameter must be a function");return jQuery(targets).ariaClick(opts,fn)}function insertElement(place,type,id,classNames,text,title){var $el=jQuery(document.createElement(type));return id&&$el.attr("id",id),classNames&&$el.addClass(classNames),title&&$el.attr("title",title),text&&$el.text(text),place&&$el.appendTo(place),$el[0]}function insertText(place,text){jQuery(place).append(document.createTextNode(text))}function removeChildren(node){jQuery(node).empty()}function removeElement(node){jQuery(node).remove()}function fade(el,options){var current,intervalId,direction="in"===options.fade?1:-1,proxy=el.cloneNode(!0);function setOpacity(el,opacity){el.style.zoom=1,el.style.filter="alpha(opacity=".concat(Math.floor(100*opacity),")"),el.style.opacity=opacity}el.parentNode.replaceChild(proxy,el),"in"===options.fade?(current=0,proxy.style.visibility="visible"):current=1,setOpacity(proxy,current),intervalId=window.setInterval((function(){current+=.05*direction,setOpacity(proxy,Math.easeInOut(current)),(1===direction&&current>=1||-1===direction&&current<=0)&&(el.style.visibility="in"===options.fade?"visible":"hidden",proxy.parentNode.replaceChild(el,proxy),proxy=null,window.clearInterval(intervalId),options.onComplete&&options.onComplete())}),25)}function scrollWindowTo(el,incrementBy){var increment=null!=incrementBy?Number(incrementBy):.1;Number.isNaN(increment)||!Number.isFinite(increment)||increment<0?increment=.1:increment>1&&(increment=1);var intervalId,start=window.scrollY?window.scrollY:document.body.scrollTop,end=function(el){var posTop=function(el){var curtop=0;for(;el.offsetParent;)curtop+=el.offsetTop,el=el.offsetParent;return curtop}(el),posBottom=posTop+el.offsetHeight,winTop=window.scrollY?window.scrollY:document.body.scrollTop,winHeight=window.innerHeight?window.innerHeight:document.body.clientHeight,winBottom=winTop+winHeight;return posTop>=winTop&&posBottom>winBottom&&el.offsetHeight<winHeight?posTop-(winHeight-el.offsetHeight)+20:posTop}(el),distance=Math.abs(start-end),direction=start>end?-1:1,progress=0;intervalId=window.setInterval((function(){progress+=increment,window.scroll(0,start+direction*(distance*Math.easeInOut(progress))),progress>=1&&window.clearInterval(intervalId)}),25)}function toStringOrDefault(value){return stringFrom(value)}function either(){if(0!==arguments.length)return Array.prototype.concat.apply([],arguments).random()}function forget(key){if("string"!=typeof key)throw new TypeError("forget key parameter must be a string (received: ".concat(Util.getType(key),")"));State.metadata.delete(key)}function hasVisited(){if(0===arguments.length)throw new Error("hasVisited called with insufficient parameters");if(State.isEmpty())return!1;for(var needles=Array.prototype.concat.apply([],arguments),played=State.passages,i=0,iend=needles.length;i<iend;++i)if(!played.includes(needles[i]))return!1;return!0}function lastVisited(){if(0===arguments.length)throw new Error("lastVisited called with insufficient parameters");if(State.isEmpty())return-1;for(var needles=Array.prototype.concat.apply([],arguments),played=State.passages,uBound=played.length-1,turns=State.turns,i=0,iend=needles.length;i<iend&&turns>-1;++i){var lastIndex=played.lastIndexOf(needles[i]);turns=Math.min(turns,-1===lastIndex?-1:uBound-lastIndex)}return turns}function memorize(key,value){if("string"!=typeof key)throw new TypeError("memorize key parameter must be a string (received: ".concat(Util.getType(key),")"));State.metadata.set(key,value)}function passage(){return State.passage}function previous(){var passages=State.passages;if(arguments.length>0){var offset=Number(arguments[0]);if(!Number.isSafeInteger(offset)||offset<1)throw new RangeError("previous offset parameter must be a positive integer greater than zero");return passages.length>offset?passages[passages.length-1-offset]:""}for(var i=passages.length-2;i>=0;--i)if(passages[i]!==State.passage)return passages[i];return""}function random(){var min,max;switch(arguments.length){case 0:throw new Error("random called with insufficient parameters");case 1:min=0,max=Math.trunc(arguments[0]);break;default:min=Math.trunc(arguments[0]),max=Math.trunc(arguments[1])}if(!Number.isInteger(min))throw new Error("random min parameter must be an integer");if(!Number.isInteger(max))throw new Error("random max parameter must be an integer");if(min>max){var _ref6=[max,min];min=_ref6[0],max=_ref6[1]}return Math.floor(State.random()*(max-min+1))+min}function randomFloat(){var min,max;switch(arguments.length){case 0:throw new Error("randomFloat called with insufficient parameters");case 1:min=0,max=Number(arguments[0]);break;default:min=Number(arguments[0]),max=Number(arguments[1])}if(Number.isNaN(min)||!Number.isFinite(min))throw new Error("randomFloat min parameter must be a number");if(Number.isNaN(max)||!Number.isFinite(max))throw new Error("randomFloat max parameter must be a number");if(min>max){var _ref7=[max,min];min=_ref7[0],max=_ref7[1]}return State.random()*(max-min)+min}function recall(key,defaultValue){if("string"!=typeof key)throw new TypeError("recall key parameter must be a string (received: ".concat(Util.getType(key),")"));return State.metadata.has(key)?State.metadata.get(key):defaultValue}function tags(){if(0===arguments.length)return Story.get(State.passage).tags.slice(0);for(var passages=Array.prototype.concat.apply([],arguments),tags=[],i=0,iend=passages.length;i<iend;++i)tags=tags.concat(Story.get(passages[i]).tags);return tags}function temporary(){return State.temporary}function time(){return null===Engine.lastPlay?0:Util.now()-Engine.lastPlay}function turns(){return State.turns}function variables(){return State.variables}function visited(){if(State.isEmpty())return 0;for(var needles=Array.prototype.concat.apply([],0===arguments.length?[State.passage]:arguments),played=State.passages,count=State.turns,i=0,iend=needles.length;i<iend&&count>0;++i)count=Math.min(count,played.count(needles[i]));return count}function visitedTags(){if(0===arguments.length)throw new Error("visitedTags called with insufficient parameters");if(State.isEmpty())return 0;for(var needles=Array.prototype.concat.apply([],arguments),nLength=needles.length,played=State.passages,seen=new Map,count=0,i=0,iend=played.length;i<iend;++i){var title=played[i];if(seen.has(title))seen.get(title)&&++count;else{var _tags2=Story.get(title).tags;if(_tags2.length>0){for(var found=0,j=0;j<nLength;++j)_tags2.includes(needles[j])&&++found;found===nLength?(++count,seen.set(title,!0)):seen.set(title,!1)}}}return count}var _ref8=function(){function slugifyUrl(url){return Util.parseUrl(url).path.replace(/^[^\w]+|[^\w]+$/g,"").replace(/[^\w]+/g,"-").toLocaleLowerCase()}function addScript(url){return new Promise((function(resolve,reject){jQuery(document.createElement("script")).one("load abort error",(function(ev){jQuery(ev.target).off(),"load"===ev.type?resolve(ev.target):reject(new Error('importScripts failed to load the script "'.concat(url,'".')))})).appendTo(document.head).attr({id:"script-imported-".concat(slugifyUrl(url)),type:"text/javascript",src:url})}))}function addStyle(url){return new Promise((function(resolve,reject){jQuery(document.createElement("link")).one("load abort error",(function(ev){jQuery(ev.target).off(),"load"===ev.type?resolve(ev.target):reject(new Error('importStyles failed to load the stylesheet "'.concat(url,'".')))})).appendTo(document.head).attr({id:"style-imported-".concat(slugifyUrl(url)),rel:"stylesheet",href:url})}))}function sequence(callbacks){return callbacks.reduce((function(seq,fn){return seq.then(fn)}),Promise.resolve())}return{importScripts:function(){for(var _len12=arguments.length,urls=new Array(_len12),_key12=0;_key12<_len12;_key12++)urls[_key12]=arguments[_key12];return Promise.all(urls.map((function(oneOrSeries){return Array.isArray(oneOrSeries)?sequence(oneOrSeries.map((function(url){return function(){return addScript(url)}}))):addScript(oneOrSeries)})))},importStyles:function(){for(var _len13=arguments.length,urls=new Array(_len13),_key13=0;_key13<_len13;_key13++)urls[_key13]=arguments[_key13];return Promise.all(urls.map((function(oneOrSeries){return Array.isArray(oneOrSeries)?sequence(oneOrSeries.map((function(url){return function(){return addStyle(url)}}))):addStyle(oneOrSeries)})))}}}(),importScripts=_ref8.importScripts,importStyles=_ref8.importStyles,parse=function(){var tokenTable=Util.toEnum({$:"State.variables.",_:"State.temporary.",to:"=",eq:"==",neq:"!=",is:"===",isnot:"!==",gt:">",gte:">=",lt:"<",lte:"<=",and:"&&",or:"||",not:"!",def:'"undefined" !== typeof',ndef:'"undefined" === typeof'}),parseRe=new RegExp(["(?:\"\"|''|``)",'(?:"(?:\\\\.|[^"\\\\])+")',"(?:'(?:\\\\.|[^'\\\\])+')","(`(?:\\\\.|[^`\\\\])+`)","(?:[=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}]+)","([^\"'=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}\\s]+)"].join("|"),"g"),notSpaceRe=/\S/,varTest=new RegExp("^".concat(Patterns.variable)),withColonTestRe=/^\s*:/,withNotTestRe=/^\s+not\b/;function parse(rawCodeString){if(0!==parseRe.lastIndex)throw new RangeError("Scripting.parse last index is non-zero at start");for(var match,code=rawCodeString;null!==(match=parseRe.exec(code));)if(match[1]){var rawTemplate=match[1],parsedTemplate=parseTemplate(rawTemplate);parsedTemplate!==rawTemplate&&(code=code.splice(match.index,rawTemplate.length,parsedTemplate),parseRe.lastIndex+=parsedTemplate.length-rawTemplate.length)}else if(match[2]){var token=match[2];if("$"===token||"_"===token)continue;if(varTest.test(token))token=token[0];else if("is"===token){var start=parseRe.lastIndex,ahead=code.slice(start);withNotTestRe.test(ahead)&&(code=code.splice(start,ahead.search(notSpaceRe)),token="isnot")}else{var _ahead=code.slice(parseRe.lastIndex);if(withColonTestRe.test(_ahead))continue}tokenTable[token]&&(code=code.splice(match.index,token.length,tokenTable[token]),parseRe.lastIndex+=tokenTable[token].length-token.length)}return code}var templateGroupStartRe=/\$\{/g,templateGroupParseRe=new RegExp(["(?:\"\"|'')",'(?:"(?:\\\\.|[^"\\\\])+")',"(?:'(?:\\\\.|[^'\\\\])+')","(\\{)","(\\})"].join("|"),"g");function parseTemplate(rawTemplateLiteral){if(0!==templateGroupStartRe.lastIndex)throw new RangeError("Scripting.parse last index is non-zero at start of template literal");for(var startMatch,template=rawTemplateLiteral;null!==(startMatch=templateGroupStartRe.exec(template));){var startIdx=startMatch.index+2,endIdx=startIdx,depth=1,endMatch=void 0;for(templateGroupParseRe.lastIndex=startIdx;null!==(endMatch=templateGroupParseRe.exec(template));)if(endMatch[1]?++depth:endMatch[2]&&--depth,0===depth){endIdx=endMatch.index;break}if(endIdx>startIdx){var parseIndex=parseRe.lastIndex,rawGroup=template.slice(startIdx,endIdx);parseRe.lastIndex=0;var parsedGroup=parse(rawGroup);parseRe.lastIndex=parseIndex,template=template.splice(startIdx,rawGroup.length,parsedGroup),templateGroupStartRe.lastIndex+=parsedGroup.length-rawGroup.length}}return template}return parse}();function evalJavaScript(code,output,data){return function(code,output,evalJavaScript$Data$){return eval(code)}.call(output?{output:output}:null,String(code),output,data)}function evalTwineScript(code,output,data){return function(code,output,evalTwineScript$Data$){return eval(code)}.call(output?{output:output}:null,parse(String(code)),output,data)}return Object.freeze(Object.defineProperties({},{parse:{value:parse},evalJavaScript:{value:evalJavaScript},evalTwineScript:{value:evalTwineScript}}))}(),_ref9=function(){var Lexer=function(){function Lexer(source,initialState){if(_classCallCheck(this,Lexer),arguments.length<2)throw new Error("Lexer constructor called with too few parameters (source:string , initialState:function)");Object.defineProperties(this,{source:{value:source},initial:{value:initialState},state:{writable:!0,value:initialState},start:{writable:!0,value:0},pos:{writable:!0,value:0},depth:{writable:!0,value:0},items:{writable:!0,value:[]},data:{writable:!0,value:{}}})}return _createClass(Lexer,[{key:"reset",value:function(){this.state=this.initial,this.start=0,this.pos=0,this.depth=0,this.items=[],this.data={}}},{key:"run",value:function(){for(;null!==this.state;)this.state=this.state(this);return this.items}},{key:"nextItem",value:function(){for(;0===this.items.length&&null!==this.state;)this.state=this.state(this);return this.items.shift()}},{key:"next",value:function(){return this.pos>=this.source.length?-1:this.source[this.pos++]}},{key:"peek",value:function(){return this.pos>=this.source.length?-1:this.source[this.pos]}},{key:"backup",value:function(num){this.pos-=num||1}},{key:"forward",value:function(num){this.pos+=num||1}},{key:"ignore",value:function(){this.start=this.pos}},{key:"accept",value:function(valid){var ch=this.next();return-1!==ch&&(!!valid.includes(ch)||(this.backup(),!1))}},{key:"acceptRe",value:function(validRe){var ch=this.next();return-1!==ch&&(!!validRe.test(ch)||(this.backup(),!1))}},{key:"acceptRun",value:function(valid){for(;;){var ch=this.next();if(-1===ch)return;if(!valid.includes(ch))break}this.backup()}},{key:"acceptRunRe",value:function(validRe){for(;;){var ch=this.next();if(-1===ch)return;if(!validRe.test(ch))break}this.backup()}},{key:"emit",value:function(type){this.items.push({type:type,text:this.source.slice(this.start,this.pos),start:this.start,pos:this.pos}),this.start=this.pos}},{key:"error",value:function(type,message){if(arguments.length<2)throw new Error("Lexer.prototype.error called with too few parameters (type:number , message:string)");return this.items.push({type:type,message:message,text:this.source.slice(this.start,this.pos),start:this.start,pos:this.pos}),null}}],[{key:"enumFromNames",value:function(names){var obj=names.reduce((function(obj,name,i){return obj[name]=i,obj}),{});return Object.freeze(Object.assign(Object.create(null),obj))}}]),Lexer}();return{EOF:-1,Lexer:Lexer}}(),EOF=_ref9.EOF,Lexer=_ref9.Lexer,Wikifier=function(){var _optionsStack,lookaheadRe,idOrClassRe,_callDepth=0,Wikifier=function(){function Wikifier(destination,source,options){_classCallCheck(this,Wikifier),Wikifier.Parser.Profile.isEmpty()&&Wikifier.Parser.Profile.compile(),Object.defineProperties(this,{source:{value:String(source)},options:{writable:!0,value:Object.assign({profile:"all"},options)},nextMatch:{writable:!0,value:0},output:{writable:!0,value:null},_rawArgs:{writable:!0,value:""}}),null==destination?this.output=document.createDocumentFragment():destination.jquery?this.output=destination[0]:this.output=destination;try{++_callDepth,this.subWikify(this.output),1===_callDepth&&Config.cleanupWikifierOutput&&convertBreaks(this.output)}finally{--_callDepth}}return _createClass(Wikifier,[{key:"subWikify",value:function(output,terminator,options){var newOptions,oldOptions,oldOutput=this.output;this.output=output,Wikifier.Option.length>0&&(newOptions=Object.assign(newOptions||{},Wikifier.Option.options)),null!==options&&"object"===_typeof(options)&&(newOptions=Object.assign(newOptions||{},options)),newOptions&&(oldOptions=this.options,this.options=Object.assign({},this.options,newOptions));var terminatorMatch,parserMatch,parsersProfile=Wikifier.Parser.Profile.get(this.options.profile),terminatorRegExp=terminator?new RegExp("(?:".concat(terminator,")"),this.options.ignoreTerminatorCase?"gim":"gm"):null;do{if(parsersProfile.parserRegExp.lastIndex=this.nextMatch,terminatorRegExp&&(terminatorRegExp.lastIndex=this.nextMatch),parserMatch=parsersProfile.parserRegExp.exec(this.source),(terminatorMatch=terminatorRegExp?terminatorRegExp.exec(this.source):null)&&(!parserMatch||terminatorMatch.index<=parserMatch.index))return terminatorMatch.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,terminatorMatch.index),this.matchStart=terminatorMatch.index,this.matchLength=terminatorMatch[0].length,this.matchText=terminatorMatch[0],this.nextMatch=terminatorRegExp.lastIndex,this.output=oldOutput,void(oldOptions&&(this.options=oldOptions));if(parserMatch){parserMatch.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,parserMatch.index),this.matchStart=parserMatch.index,this.matchLength=parserMatch[0].length,this.matchText=parserMatch[0],this.nextMatch=parsersProfile.parserRegExp.lastIndex;for(var matchingParser=void 0,i=1,iend=parserMatch.length;i<iend;++i)if(parserMatch[i]){matchingParser=i-1;break}if(parsersProfile.parsers[matchingParser].handler(this),null!=TempState.break)break}}while(terminatorMatch||parserMatch);null==TempState.break?this.nextMatch<this.source.length&&(this.outputText(this.output,this.nextMatch,this.source.length),this.nextMatch=this.source.length):this.output.lastChild&&this.output.lastChild.nodeType===Node.ELEMENT_NODE&&"BR"===this.output.lastChild.nodeName.toUpperCase()&&jQuery(this.output.lastChild).remove(),this.output=oldOutput,oldOptions&&(this.options=oldOptions)}},{key:"outputText",value:function(destination,startPos,endPos){jQuery(destination).append(document.createTextNode(this.source.substring(startPos,endPos)))}},{key:"rawArgs",value:function(){return this._rawArgs}},{key:"fullArgs",value:function(){return Scripting.parse(this._rawArgs)}}],[{key:"wikifyEval",value:function(text){var output=document.createDocumentFragment();new Wikifier(output,text);var errors=output.querySelector(".error");if(null!==errors)throw new Error(errors.textContent.replace(errorPrologRegExp,""));return output}},{key:"createInternalLink",value:function(destination,passage,text,callback){var $link=jQuery(document.createElement("a"));return null!=passage&&($link.attr("data-passage",passage),Story.has(passage)?($link.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(passage)&&$link.addClass("link-visited")):$link.addClass("link-broken"),$link.ariaClick({one:!0},(function(){"function"==typeof callback&&callback(),Engine.play(passage)}))),text&&$link.append(document.createTextNode(text)),destination&&$link.appendTo(destination),$link[0]}},{key:"createExternalLink",value:function(destination,url,text){var $link=jQuery(document.createElement("a")).attr("target","_blank").addClass("link-external").text(text).appendTo(destination);return null!=url&&$link.attr({href:url,tabindex:0}),$link[0]}},{key:"isExternalLink",value:function(link){return!Story.has(link)&&(new RegExp("^".concat(Patterns.url),"gim").test(link)||/[/.?#]/.test(link))}}]),Wikifier}();return Object.defineProperty(Wikifier,"Option",{value:(_optionsStack=[],Object.freeze(Object.defineProperties({},{length:{get:function(){return _optionsStack.length}},options:{get:function(){return Object.assign.apply(Object,[{}].concat(_toConsumableArray(_optionsStack)))}},clear:{value:function(){_optionsStack=[]}},get:{value:function(idx){return _optionsStack[idx]}},pop:{value:function(){return _optionsStack.pop()}},push:{value:function(options){if("object"!==_typeof(options)||null===options)throw new TypeError("Wikifier.Option.push options parameter must be an object (received: ".concat(Util.getType(options),")"));return _optionsStack.push(options)}}})))}),Object.defineProperty(Wikifier,"Parser",{value:function(){var _profiles,_parsers=[];function parsersHas(name){return!!_parsers.find((function(parser){return parser.name===name}))}return Object.freeze(Object.defineProperties({},{parsers:{get:function(){return _parsers}},add:{value:function(parser){if("object"!==_typeof(parser))throw new Error("Wikifier.Parser.add parser parameter must be an object");if(!parser.hasOwnProperty("name"))throw new Error('parser object missing required "name" property');if("string"!=typeof parser.name)throw new Error('parser object "name" property must be a string');if(!parser.hasOwnProperty("match"))throw new Error('parser object missing required "match" property');if("string"!=typeof parser.match)throw new Error('parser object "match" property must be a string');if(!parser.hasOwnProperty("handler"))throw new Error('parser object missing required "handler" property');if("function"!=typeof parser.handler)throw new Error('parser object "handler" property must be a function');if(parser.hasOwnProperty("profiles")&&!Array.isArray(parser.profiles))throw new Error('parser object "profiles" property must be an array');if(parsersHas(parser.name))throw new Error('cannot clobber existing parser "'.concat(parser.name,'"'));_parsers.push(parser)}},delete:{value:function(name){var parser=_parsers.find((function(parser){return parser.name===name}));parser&&_parsers.delete(parser)}},isEmpty:{value:function(){return 0===_parsers.length}},has:{value:parsersHas},get:{value:function(name){return _parsers.find((function(parser){return parser.name===name}))||null}},Profile:{value:Object.freeze(Object.defineProperties({},{profiles:{get:function(){return _profiles}},compile:{value:function(){var all=_parsers,core=all.filter((function(parser){return!Array.isArray(parser.profiles)||parser.profiles.includes("core")}));return _profiles=Object.freeze({all:{parsers:all,parserRegExp:new RegExp(all.map((function(parser){return"(".concat(parser.match,")")})).join("|"),"gm")},core:{parsers:core,parserRegExp:new RegExp(core.map((function(parser){return"(".concat(parser.match,")")})).join("|"),"gm")}})}},isEmpty:{value:function(){return"object"!==_typeof(_profiles)||0===Object.keys(_profiles).length}},has:{value:function(profile){return"object"===_typeof(_profiles)&&_profiles.hasOwnProperty(profile)}},get:{value:function(profile){if("object"!==_typeof(_profiles)||!_profiles.hasOwnProperty(profile))throw new Error('nonexistent parser profile "'.concat(profile,'"'));return _profiles[profile]}}}))}}))}()}),Object.defineProperties(Wikifier,{helpers:{value:{}},getValue:{value:State.getVar},setValue:{value:State.setVar},parse:{value:Scripting.parse},evalExpression:{value:Scripting.evalTwineScript},evalStatements:{value:Scripting.evalTwineScript},textPrimitives:{value:Patterns}}),Object.defineProperties(Wikifier.helpers,{inlineCss:{value:(lookaheadRe=new RegExp(Patterns.inlineCss,"gm"),idOrClassRe=new RegExp("(".concat(Patterns.cssIdOrClassSigil,")(").concat(Patterns.anyLetter,"+)"),"g"),function(w){var matched,css={classes:[],id:"",styles:{}};do{lookaheadRe.lastIndex=w.nextMatch;var match=lookaheadRe.exec(w.source);if(matched=match&&match.index===w.nextMatch){if(match[1])css.styles[Util.fromCssProperty(match[1])]=match[2].trim();else if(match[3])css.styles[Util.fromCssProperty(match[3])]=match[4].trim();else if(match[5]){var subMatch=void 0;for(idOrClassRe.lastIndex=0;null!==(subMatch=idOrClassRe.exec(match[5]));)"."===subMatch[1]?css.classes.push(subMatch[2]):css.id=subMatch[2]}w.nextMatch=lookaheadRe.lastIndex}}while(matched);return css})},evalText:{value:function(text){var result;try{switch(_typeof(result=Scripting.evalTwineScript(text))){case"string":""===result.trim()&&(result=text);break;case"number":result=String(result);break;default:result=text}}catch(ex){result=text}return result}},evalPassageId:{value:function(passage){return null==passage||Story.has(passage)?passage:Wikifier.helpers.evalText(passage)}},hasBlockContext:{value:function(nodes){for(var hasGCS="function"==typeof window.getComputedStyle,i=nodes.length-1;i>=0;--i){var node=nodes[i];switch(node.nodeType){case Node.ELEMENT_NODE:var tagName=node.nodeName.toUpperCase();if("BR"===tagName)return!0;var styles=hasGCS?window.getComputedStyle(node,null):node.currentStyle;if(styles&&styles.display){if("none"===styles.display)continue;return"block"===styles.display}switch(tagName){case"ADDRESS":case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"CENTER":case"DIV":case"DL":case"FIGURE":case"FOOTER":case"FORM":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"HEADER":case"HR":case"MAIN":case"NAV":case"OL":case"P":case"PRE":case"SECTION":case"TABLE":case"UL":return!0}return!1;case Node.COMMENT_NODE:continue;default:return!1}}return!0}},createShadowSetterCallback:{value:function(){var macroParser=null;function getMacroContextShadowView(){for(var macro=macroParser||function(){if(!macroParser&&!(macroParser=Wikifier.Parser.get("macro")))throw new Error('cannot find "macro" parser');return macroParser}(),view=new Set,context=macro.context;null!==context;context=context.parent)context._shadows&&context._shadows.forEach((function(name){return view.add(name)}));return _toConsumableArray(view)}return function(code){var shadowStore={};return getMacroContextShadowView().forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;shadowStore[varName]=store[varKey]})),function(){var shadowNames=Object.keys(shadowStore),valueCache=shadowNames.length>0?{}:null;try{return shadowNames.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;store.hasOwnProperty(varKey)&&(valueCache[varKey]=store[varKey]),store[varKey]=shadowStore[varName]})),Scripting.evalJavaScript(code)}finally{shadowNames.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;shadowStore[varName]=store[varKey],valueCache.hasOwnProperty(varKey)?store[varKey]=valueCache[varKey]:delete store[varKey]}))}}}}()},parseSquareBracketedMarkup:{value:function(){var Item=Lexer.enumFromNames(["Error","DelimLTR","DelimRTL","InnerMeta","ImageMeta","LinkMeta","Link","RightMeta","Setter","Source","Text"]),Delim=Lexer.enumFromNames(["None","LTR","RTL"]);function slurpQuote(lexer,endQuote){loop:for(;;)switch(lexer.next()){case"\\":var ch=lexer.next();if(ch!==EOF&&"\n"!==ch)break;case EOF:case"\n":return EOF;case endQuote:break loop}return lexer.pos}function lexLeftMeta(lexer){if(!lexer.accept("["))return lexer.error(Item.Error,"malformed square-bracketed markup");if(lexer.accept("["))lexer.data.isLink=!0,lexer.emit(Item.LinkMeta);else{if(lexer.accept("<>"),!(lexer.accept("Ii")&&lexer.accept("Mm")&&lexer.accept("Gg")&&lexer.accept("[")))return lexer.error(Item.Error,"malformed square-bracketed markup");lexer.data.isLink=!1,lexer.emit(Item.ImageMeta)}return lexer.depth=2,lexCoreComponents}function lexCoreComponents(lexer){for(var what=lexer.data.isLink?"link":"image",delim=Delim.None;;)switch(lexer.next()){case EOF:case"\n":return lexer.error(Item.Error,"unterminated ".concat(what," markup"));case'"':if(slurpQuote(lexer,'"')===EOF)return lexer.error(Item.Error,"unterminated double quoted string in ".concat(what," markup"));break;case"|":delim===Delim.None&&(delim=Delim.LTR,lexer.backup(),lexer.emit(Item.Text),lexer.forward(),lexer.emit(Item.DelimLTR));break;case"-":delim===Delim.None&&">"===lexer.peek()&&(delim=Delim.LTR,lexer.backup(),lexer.emit(Item.Text),lexer.forward(2),lexer.emit(Item.DelimLTR));break;case"<":delim===Delim.None&&"-"===lexer.peek()&&(delim=Delim.RTL,lexer.backup(),lexer.emit(lexer.data.isLink?Item.Link:Item.Source),lexer.forward(2),lexer.emit(Item.DelimRTL));break;case"[":++lexer.depth;break;case"]":if(--lexer.depth,1===lexer.depth)switch(lexer.peek()){case"[":return++lexer.depth,lexer.backup(),delim===Delim.RTL?lexer.emit(Item.Text):lexer.emit(lexer.data.isLink?Item.Link:Item.Source),lexer.forward(2),lexer.emit(Item.InnerMeta),lexer.data.isLink?lexSetter:lexImageLink;case"]":return--lexer.depth,lexer.backup(),delim===Delim.RTL?lexer.emit(Item.Text):lexer.emit(lexer.data.isLink?Item.Link:Item.Source),lexer.forward(2),lexer.emit(Item.RightMeta),null;default:return lexer.error(Item.Error,"malformed ".concat(what," markup"))}}}function lexImageLink(lexer){for(var what=lexer.data.isLink?"link":"image";;)switch(lexer.next()){case EOF:case"\n":return lexer.error(Item.Error,"unterminated ".concat(what," markup"));case'"':if(slurpQuote(lexer,'"')===EOF)return lexer.error(Item.Error,"unterminated double quoted string in ".concat(what," markup link component"));break;case"[":++lexer.depth;break;case"]":if(--lexer.depth,1===lexer.depth)switch(lexer.peek()){case"[":return++lexer.depth,lexer.backup(),lexer.emit(Item.Link),lexer.forward(2),lexer.emit(Item.InnerMeta),lexSetter;case"]":return--lexer.depth,lexer.backup(),lexer.emit(Item.Link),lexer.forward(2),lexer.emit(Item.RightMeta),null;default:return lexer.error(Item.Error,"malformed ".concat(what," markup"))}}}function lexSetter(lexer){for(var what=lexer.data.isLink?"link":"image";;)switch(lexer.next()){case EOF:case"\n":return lexer.error(Item.Error,"unterminated ".concat(what," markup"));case'"':if(slurpQuote(lexer,'"')===EOF)return lexer.error(Item.Error,"unterminated double quoted string in ".concat(what," markup setter component"));break;case"'":if(slurpQuote(lexer,"'")===EOF)return lexer.error(Item.Error,"unterminated single quoted string in ".concat(what," markup setter component"));break;case"[":++lexer.depth;break;case"]":if(--lexer.depth,1===lexer.depth)return"]"!==lexer.peek()?lexer.error(Item.Error,"malformed ".concat(what," markup")):(--lexer.depth,lexer.backup(),lexer.emit(Item.Setter),lexer.forward(2),lexer.emit(Item.RightMeta),null)}}return function(w){var lexer=new Lexer(w.source,lexLeftMeta);lexer.start=lexer.pos=w.matchStart;var markup={},items=lexer.run(),last=items.last();return last&&last.type===Item.Error?markup.error=last.message:items.forEach((function(item){var text=item.text.trim();switch(item.type){case Item.ImageMeta:markup.isImage=!0,"<"===text[1]?markup.align="left":">"===text[1]&&(markup.align="right");break;case Item.LinkMeta:markup.isLink=!0;break;case Item.Link:"~"===text[0]?(markup.forceInternal=!0,markup.link=text.slice(1)):markup.link=text;break;case Item.Setter:markup.setter=text;break;case Item.Source:markup.source=text;break;case Item.Text:markup.text=text}})),markup.pos=lexer.pos,markup}}()}}),Wikifier}();!function(){function _verbatimTagHandler(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);match&&match.index===w.matchStart&&(w.nextMatch=this.lookahead.lastIndex,jQuery(document.createDocumentFragment()).append(match[1]).appendTo(w.output))}Wikifier.Parser.add({name:"quoteByBlock",profiles:["block"],match:"^<<<\\n",terminator:"^<<<\\n",handler:function(w){Wikifier.helpers.hasBlockContext(w.output.childNodes)?w.subWikify(jQuery(document.createElement("blockquote")).appendTo(w.output).get(0),this.terminator):jQuery(w.output).append(document.createTextNode(w.matchText))}}),Wikifier.Parser.add({name:"quoteByLine",profiles:["block"],match:"^>+",lookahead:/^>+/gm,terminator:"\\n",handler:function(w){if(Wikifier.helpers.hasBlockContext(w.output.childNodes)){var matched,i,destStack=[w.output],curLevel=0,newLevel=w.matchLength;do{if(newLevel>curLevel)for(i=curLevel;i<newLevel;++i)destStack.push(jQuery(document.createElement("blockquote")).appendTo(destStack[destStack.length-1]).get(0));else if(newLevel<curLevel)for(i=curLevel;i>newLevel;--i)destStack.pop();curLevel=newLevel,w.subWikify(destStack[destStack.length-1],this.terminator),jQuery(document.createElement("br")).appendTo(destStack[destStack.length-1]),this.lookahead.lastIndex=w.nextMatch;var match=this.lookahead.exec(w.source);(matched=match&&match.index===w.nextMatch)&&(newLevel=match[0].length,w.nextMatch+=match[0].length)}while(matched)}else jQuery(w.output).append(document.createTextNode(w.matchText))}}),Wikifier.Parser.add({name:"macro",profiles:["core"],match:"<<",lookahead:new RegExp("<<(/?".concat(Patterns.macroName,")(?:\\s*)((?:(?:/\\*[^*]*\\*+(?:[^/*][^*]*\\*+)*/)|(?://.*\\n)|(?:`(?:\\\\.|[^`\\\\])*`)|(?:\"(?:\\\\.|[^\"\\\\])*\")|(?:'(?:\\\\.|[^'\\\\])*')|(?:\\[(?:[<>]?[Ii][Mm][Gg])?\\[[^\\r\\n]*?\\]\\]+)|[^>]|(?:>(?!>)))*)>>"),"gm"),working:{source:"",name:"",arguments:"",index:0},context:null,handler:function(w){var matchStart=this.lookahead.lastIndex=w.matchStart;if(this.parseTag(w)){var macro,nextMatch=w.nextMatch,name=this.working.name,rawArgs=this.working.arguments;try{if(!(macro=Macro.get(name))){if(Macro.tags.has(name)){var tags=Macro.tags.get(name);return throwError(w.output,"child tag <<".concat(name,">> was found outside of a call to its parent macro").concat(1===tags.length?"":"s"," <<").concat(tags.join(">>, <<"),">>"),w.source.slice(matchStart,w.nextMatch))}return throwError(w.output,"macro <<".concat(name,">> does not exist"),w.source.slice(matchStart,w.nextMatch))}var payload=null;if(void 0!==macro.tags&&!(payload=this.parseBody(w,macro)))return w.nextMatch=nextMatch,throwError(w.output,"cannot find a closing tag for macro <<".concat(name,">>"),"".concat(w.source.slice(matchStart,w.nextMatch),"…"));if("function"!=typeof macro.handler)return throwError(w.output,"macro <<".concat(name,">> handler function ").concat(void 0===macro.handler?"does not exist":"is not a function"),w.source.slice(matchStart,w.nextMatch));var args=payload?payload[0].args:this.createArgs(rawArgs,this.skipArgs(macro,macro.name));if(void 0!==macro._MACRO_API){this.context=new MacroContext({macro:macro,name:name,args:args,payload:payload,source:w.source.slice(matchStart,w.nextMatch),parent:this.context,parser:w});try{macro.handler.call(this.context)}finally{this.context=this.context.parent}}else{var prevRawArgs=w._rawArgs;w._rawArgs=rawArgs;try{macro.handler(w.output,name,args,w,payload)}finally{w._rawArgs=prevRawArgs}}}catch(ex){return throwError(w.output,"cannot execute ".concat(macro&&macro.isWidget?"widget":"macro"," <<").concat(name,">>: ").concat(ex.message),w.source.slice(matchStart,w.nextMatch))}finally{this.working.source="",this.working.name="",this.working.arguments="",this.working.index=0}}else w.outputText(w.output,w.matchStart,w.nextMatch)},parseTag:function(w){var match=this.lookahead.exec(w.source);return!(!match||match.index!==w.matchStart||!match[1])&&(w.nextMatch=this.lookahead.lastIndex,this.working.source=w.source.slice(match.index,this.lookahead.lastIndex),this.working.name=match[1],this.working.arguments=match[2],this.working.index=match.index,!0)},parseBody:function(w,macro){for(var openTag=this.working.name,closeTag="/".concat(openTag),closeAlt="end".concat(openTag),bodyTags=!!Array.isArray(macro.tags)&&macro.tags,payload=[],end=-1,opened=1,curSource=this.working.source,curTag=this.working.name,curArgument=this.working.arguments,contentStart=w.nextMatch;-1!==(w.matchStart=w.source.indexOf(this.match,w.nextMatch));)if(this.parseTag(w)){var tagSource=this.working.source,tagName=this.working.name,tagArgs=this.working.arguments,tagBegin=this.working.index,tagEnd=w.nextMatch,hasArgs=""!==tagArgs.trim();switch(tagName){case openTag:++opened;break;case closeAlt:case closeTag:if(hasArgs)throw w.nextMatch=tagBegin+2+tagName.length,new Error('malformed closing tag: "'.concat(tagSource,'"'));--opened;break;default:if(hasArgs&&(tagName.startsWith("/")||tagName.startsWith("end"))){this.lookahead.lastIndex=w.nextMatch=tagBegin+2+tagName.length;continue}if(1===opened&&bodyTags)for(var i=0,iend=bodyTags.length;i<iend;++i)tagName===bodyTags[i]&&(payload.push({source:curSource,name:curTag,arguments:curArgument,args:this.createArgs(curArgument,this.skipArgs(macro,curTag)),contents:w.source.slice(contentStart,tagBegin)}),curSource=tagSource,curTag=tagName,curArgument=tagArgs,contentStart=tagEnd)}if(0===opened){payload.push({source:curSource,name:curTag,arguments:curArgument,args:this.createArgs(curArgument,this.skipArgs(macro,curTag)),contents:w.source.slice(contentStart,tagBegin)}),end=tagEnd;break}}else this.lookahead.lastIndex=w.nextMatch=w.matchStart+this.match.length;return-1!==end?(w.nextMatch=end,payload):null},createArgs:function(rawArgsString,skipArgs){var args=skipArgs?[]:this.parseArgs(rawArgsString);return Object.defineProperties(args,{raw:{value:rawArgsString},full:{value:Scripting.parse(rawArgsString)}}),args},skipArgs:function(macro,tagName){if(void 0!==macro.skipArgs){var sa=macro.skipArgs;return"boolean"==typeof sa&&sa||Array.isArray(sa)&&sa.includes(tagName)}return void 0!==macro.skipArg0&&(macro.skipArg0&&macro.name===tagName)},parseArgs:function(){var Item=Lexer.enumFromNames(["Error","Bareword","Expression","String","SquareBracket"]),spaceRe=new RegExp(Patterns.space),notSpaceRe=new RegExp(Patterns.notSpace),varTest=new RegExp("^".concat(Patterns.variable));function slurpQuote(lexer,endQuote){loop:for(;;)switch(lexer.next()){case"\\":var ch=lexer.next();if(ch!==EOF&&"\n"!==ch)break;case EOF:case"\n":return EOF;case endQuote:break loop}return lexer.pos}function lexSpace(lexer){var offset=lexer.source.slice(lexer.pos).search(notSpaceRe);if(offset===EOF)return null;switch(0!==offset&&(lexer.pos+=offset,lexer.ignore()),lexer.next()){case"`":return lexExpression;case'"':return lexDoubleQuote;case"'":return lexSingleQuote;case"[":return lexSquareBracket;default:return lexBareword}}function lexExpression(lexer){return slurpQuote(lexer,"`")===EOF?lexer.error(Item.Error,"unterminated backquote expression"):(lexer.emit(Item.Expression),lexSpace)}function lexDoubleQuote(lexer){return slurpQuote(lexer,'"')===EOF?lexer.error(Item.Error,"unterminated double quoted string"):(lexer.emit(Item.String),lexSpace)}function lexSingleQuote(lexer){return slurpQuote(lexer,"'")===EOF?lexer.error(Item.Error,"unterminated single quoted string"):(lexer.emit(Item.String),lexSpace)}function lexSquareBracket(lexer){var what;if(lexer.accept("<>IiMmGg")?(what="image",lexer.acceptRun("<>IiMmGg")):what="link",!lexer.accept("["))return lexer.error(Item.Error,"malformed ".concat(what," markup"));lexer.depth=2;loop:for(;;)switch(lexer.next()){case"\\":var ch=lexer.next();if(ch!==EOF&&"\n"!==ch)break;case EOF:case"\n":return lexer.error(Item.Error,"unterminated ".concat(what," markup"));case"[":++lexer.depth;break;case"]":if(--lexer.depth,lexer.depth<0)return lexer.error(Item.Error,"unexpected right square bracket ']'");if(1===lexer.depth){if("]"===lexer.next()){--lexer.depth;break loop}lexer.backup()}}return lexer.emit(Item.SquareBracket),lexSpace}function lexBareword(lexer){var offset=lexer.source.slice(lexer.pos).search(spaceRe);return lexer.pos=offset===EOF?lexer.source.length:lexer.pos+offset,lexer.emit(Item.Bareword),offset===EOF?null:lexSpace}return function(rawArgsString){var lexer=new Lexer(rawArgsString,lexSpace),args=[];return lexer.run().forEach((function(item){var arg=item.text;switch(item.type){case Item.Error:throw new Error('unable to parse macro argument "'.concat(arg,'": ').concat(item.message));case Item.Bareword:if(varTest.test(arg))arg=State.getVar(arg);else if(/^(?:settings|setup)[.[]/.test(arg))try{arg=Scripting.evalTwineScript(arg)}catch(ex){throw new Error('unable to parse macro argument "'.concat(arg,'": ').concat(ex.message))}else if("null"===arg)arg=null;else if("undefined"===arg)arg=undefined;else if("true"===arg)arg=!0;else if("false"===arg)arg=!1;else if("NaN"===arg)arg=NaN;else{var argAsNum=Number(arg);Number.isNaN(argAsNum)||(arg=argAsNum)}break;case Item.Expression:if(""===(arg=arg.slice(1,-1).trim()))arg=undefined;else try{arg=Scripting.evalTwineScript("(".concat(arg,")"))}catch(ex){throw new Error('unable to parse macro argument expression "'.concat(arg,'": ').concat(ex.message))}break;case Item.String:try{arg=Scripting.evalJavaScript(arg)}catch(ex){throw new Error('unable to parse macro argument string "'.concat(arg,'": ').concat(ex.message))}break;case Item.SquareBracket:var markup=Wikifier.helpers.parseSquareBracketedMarkup({source:arg,matchStart:0});if(markup.hasOwnProperty("error"))throw new Error('unable to parse macro argument "'.concat(arg,'": ').concat(markup.error));if(markup.pos<arg.length)throw new Error('unable to parse macro argument "'.concat(arg,'": unexpected character(s) "').concat(arg.slice(markup.pos),'" (pos: ').concat(markup.pos,")"));markup.isLink?((arg={isLink:!0}).count=markup.hasOwnProperty("text")?2:1,arg.link=Wikifier.helpers.evalPassageId(markup.link),arg.text=markup.hasOwnProperty("text")?Wikifier.helpers.evalText(markup.text):arg.link,arg.external=!markup.forceInternal&&Wikifier.isExternalLink(arg.link),arg.setFn=markup.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(markup.setter)):null):markup.isImage&&(arg=function(source){var imgObj={source:source,isImage:!0};if("data:"!==source.slice(0,5)&&Story.has(source)){var passage=Story.get(source);passage.tags.includes("Twine.image")&&(imgObj.source=passage.text,imgObj.passage=passage.title)}return imgObj}(Wikifier.helpers.evalPassageId(markup.source)),markup.hasOwnProperty("align")&&(arg.align=markup.align),markup.hasOwnProperty("text")&&(arg.title=Wikifier.helpers.evalText(markup.text)),markup.hasOwnProperty("link")&&(arg.link=Wikifier.helpers.evalPassageId(markup.link),arg.external=!markup.forceInternal&&Wikifier.isExternalLink(arg.link)),arg.setFn=markup.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(markup.setter)):null)}args.push(arg)})),args}}()}),Wikifier.Parser.add({name:"link",profiles:["core"],match:"\\[\\[[^[]",handler:function(w){var markup=Wikifier.helpers.parseSquareBracketedMarkup(w);if(markup.hasOwnProperty("error"))w.outputText(w.output,w.matchStart,w.nextMatch);else{w.nextMatch=markup.pos;var link=Wikifier.helpers.evalPassageId(markup.link),text=markup.hasOwnProperty("text")?Wikifier.helpers.evalText(markup.text):link,setFn=markup.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(markup.setter)):null,output=(Config.debug?new DebugView(w.output,"link-markup","[[link]]",w.source.slice(w.matchStart,w.nextMatch)):w).output;markup.forceInternal||!Wikifier.isExternalLink(link)?Wikifier.createInternalLink(output,link,text,setFn):Wikifier.createExternalLink(output,link,text)}}}),Wikifier.Parser.add({name:"urlLink",profiles:["core"],match:Patterns.url,handler:function(w){w.outputText(Wikifier.createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch)}}),Wikifier.Parser.add({name:"image",profiles:["core"],match:"\\[[<>]?[Ii][Mm][Gg]\\[",handler:function(w){var markup=Wikifier.helpers.parseSquareBracketedMarkup(w);if(markup.hasOwnProperty("error"))w.outputText(w.output,w.matchStart,w.nextMatch);else{var debugView;w.nextMatch=markup.pos,Config.debug&&(debugView=new DebugView(w.output,"image-markup",markup.hasOwnProperty("link")?"[img[][link]]":"[img[]]",w.source.slice(w.matchStart,w.nextMatch))).modes({block:!0});var source,setFn=markup.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(markup.setter)):null,el=(Config.debug?debugView:w).output;if(markup.hasOwnProperty("link")){var link=Wikifier.helpers.evalPassageId(markup.link);(el=markup.forceInternal||!Wikifier.isExternalLink(link)?Wikifier.createInternalLink(el,link,null,setFn):Wikifier.createExternalLink(el,link)).classList.add("link-image")}if(el=jQuery(document.createElement("img")).appendTo(el).get(0),"data:"!==(source=Wikifier.helpers.evalPassageId(markup.source)).slice(0,5)&&Story.has(source)){var passage=Story.get(source);passage.tags.includes("Twine.image")&&(el.setAttribute("data-passage",passage.title),source=passage.text.trim())}el.src=source,markup.hasOwnProperty("text")&&(el.title=Wikifier.helpers.evalText(markup.text)),markup.hasOwnProperty("align")&&(el.align=markup.align)}}}),Wikifier.Parser.add({name:"monospacedByBlock",profiles:["block"],match:"^\\{\\{\\{\\n",lookahead:/^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/gm,handler:function(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);if(match&&match.index===w.matchStart){var pre=jQuery(document.createElement("pre"));jQuery(document.createElement("code")).text(match[1]).appendTo(pre),pre.appendTo(w.output),w.nextMatch=this.lookahead.lastIndex}}}),Wikifier.Parser.add({name:"formatByChar",profiles:["core"],match:"''|//|__|\\^\\^|~~|==|\\{\\{\\{",handler:function(w){switch(w.matchText){case"''":w.subWikify(jQuery(document.createElement("strong")).appendTo(w.output).get(0),"''");break;case"//":w.subWikify(jQuery(document.createElement("em")).appendTo(w.output).get(0),"//");break;case"__":w.subWikify(jQuery(document.createElement("u")).appendTo(w.output).get(0),"__");break;case"^^":w.subWikify(jQuery(document.createElement("sup")).appendTo(w.output).get(0),"\\^\\^");break;case"~~":w.subWikify(jQuery(document.createElement("sub")).appendTo(w.output).get(0),"~~");break;case"==":w.subWikify(jQuery(document.createElement("s")).appendTo(w.output).get(0),"==");break;case"{{{":var lookahead=/\{\{\{((?:.|\n)*?)\}\}\}/gm;lookahead.lastIndex=w.matchStart;var match=lookahead.exec(w.source);match&&match.index===w.matchStart&&(jQuery(document.createElement("code")).text(match[1]).appendTo(w.output),w.nextMatch=lookahead.lastIndex)}}}),Wikifier.Parser.add({name:"customStyle",profiles:["core"],match:"@@",terminator:"@@",blockRe:/\s*\n/gm,handler:function(w){var css=Wikifier.helpers.inlineCss(w);this.blockRe.lastIndex=w.nextMatch;var blockMatch=this.blockRe.exec(w.source),blockLevel=blockMatch&&blockMatch.index===w.nextMatch,$el=jQuery(document.createElement(blockLevel?"div":"span")).appendTo(w.output);0===css.classes.length&&""===css.id&&0===Object.keys(css.styles).length?$el.addClass("marked"):(css.classes.forEach((function(className){return $el.addClass(className)})),""!==css.id&&$el.attr("id",css.id),$el.css(css.styles)),blockLevel?(w.nextMatch+=blockMatch[0].length,w.subWikify($el[0],"\\n?".concat(this.terminator))):w.subWikify($el[0],this.terminator)}}),Wikifier.Parser.add({name:"verbatimText",profiles:["core"],match:'"{3}|<[Nn][Oo][Ww][Ii][Kk][Ii]>',lookahead:/(?:"{3}((?:.|\n)*?)"{3})|(?:<[Nn][Oo][Ww][Ii][Kk][Ii]>((?:.|\n)*?)<\/[Nn][Oo][Ww][Ii][Kk][Ii]>)/gm,handler:function(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);match&&match.index===w.matchStart&&(w.nextMatch=this.lookahead.lastIndex,jQuery(document.createElement("span")).addClass("verbatim").text(match[1]||match[2]).appendTo(w.output))}}),Wikifier.Parser.add({name:"horizontalRule",profiles:["core"],match:"^----+$\\n?|<[Hh][Rr]\\s*/?>\\n?",handler:function(w){jQuery(document.createElement("hr")).appendTo(w.output)}}),Wikifier.Parser.add({name:"emdash",profiles:["core"],match:"--",handler:function(w){jQuery(document.createTextNode("—")).appendTo(w.output)}}),Wikifier.Parser.add({name:"doubleDollarSign",profiles:["core"],match:"\\${2}",handler:function(w){jQuery(document.createTextNode("$")).appendTo(w.output)}}),Wikifier.Parser.add({name:"nakedVariable",profiles:["core"],match:"".concat(Patterns.variable,"(?:(?:\\.").concat(Patterns.identifier,")|(?:\\[\\d+\\])|(?:\\[\"(?:\\\\.|[^\"\\\\])+\"\\])|(?:\\['(?:\\\\.|[^'\\\\])+'\\])|(?:\\[").concat(Patterns.variable,"\\]))*"),handler:function(w){var result=State.getVar(w.matchText);null==result?jQuery(document.createTextNode(w.matchText)).appendTo(w.output):new Wikifier((Config.debug?new DebugView(w.output,"variable",w.matchText,w.matchText):w).output,stringFrom(result))}}),Wikifier.Parser.add({name:"template",profiles:["core"],match:"\\?".concat(Patterns.templateName),handler:function(w){var name=w.matchText.slice(1),template=Template.get(name),result=null;switch(template instanceof Array&&(template=template.random()),_typeof(template)){case"function":try{result=stringFrom(template.call({name:name}))}catch(ex){return throwError(w.output,"cannot execute function template ?".concat(name,": ").concat(ex.message),w.source.slice(w.matchStart,w.nextMatch))}break;case"string":result=template}null===result?jQuery(document.createTextNode(w.matchText)).appendTo(w.output):new Wikifier((Config.debug?new DebugView(w.output,"template",w.matchText,w.matchText):w).output,result)}}),Wikifier.Parser.add({name:"heading",profiles:["block"],match:"^!{1,6}",terminator:"\\n",handler:function(w){Wikifier.helpers.hasBlockContext(w.output.childNodes)?w.subWikify(jQuery(document.createElement("h".concat(w.matchLength))).appendTo(w.output).get(0),this.terminator):jQuery(w.output).append(document.createTextNode(w.matchText))}}),Wikifier.Parser.add({name:"table",profiles:["block"],match:"^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",lookahead:/^\|([^\n]*)\|([fhck]?)$/gm,rowTerminator:"\\|(?:[cfhk]?)$\\n?",cellPattern:"(?:\\|([^\\n\\|]*)\\|)|(\\|[cfhk]?$\\n?)",cellTerminator:"(?:\\u0020*)\\|",rowTypes:{c:"caption",f:"tfoot",h:"thead","":"tbody"},handler:function(w){if(Wikifier.helpers.hasBlockContext(w.output.childNodes)){var matched,table=jQuery(document.createElement("table")).appendTo(w.output).get(0),prevColumns=[],curRowType=null,$rowContainer=null,rowCount=0;w.nextMatch=w.matchStart;do{this.lookahead.lastIndex=w.nextMatch;var match=this.lookahead.exec(w.source);if(matched=match&&match.index===w.nextMatch){var nextRowType=match[2];"k"===nextRowType?(table.className=match[1],w.nextMatch+=match[0].length+1):(nextRowType!==curRowType&&(curRowType=nextRowType,$rowContainer=jQuery(document.createElement(this.rowTypes[nextRowType])).appendTo(table)),"c"===curRowType?($rowContainer.css("caption-side",0===rowCount?"top":"bottom"),w.nextMatch+=1,w.subWikify($rowContainer[0],this.rowTerminator)):this.rowHandler(w,jQuery(document.createElement("tr")).appendTo($rowContainer).get(0),prevColumns),++rowCount)}}while(matched)}else jQuery(w.output).append(document.createTextNode(w.matchText))},rowHandler:function(w,rowEl,prevColumns){var matched,_this12=this,cellRe=new RegExp(this.cellPattern,"gm"),col=0,curColCount=1;do{cellRe.lastIndex=w.nextMatch;var cellMatch=cellRe.exec(w.source);if(matched=cellMatch&&cellMatch.index===w.nextMatch){if("~"===cellMatch[1]){var last=prevColumns[col];last&&(++last.rowCount,last.$element.attr("rowspan",last.rowCount).css("vertical-align","middle")),w.nextMatch=cellMatch.index+cellMatch[0].length-1}else if(">"===cellMatch[1])++curColCount,w.nextMatch=cellMatch.index+cellMatch[0].length-1;else{if(cellMatch[2]){w.nextMatch=cellMatch.index+cellMatch[0].length;break}!function(){++w.nextMatch;for(var css=Wikifier.helpers.inlineCss(w),spaceLeft=!1,spaceRight=!1,$cell=void 0;" "===w.source.substr(w.nextMatch,1);)spaceLeft=!0,++w.nextMatch;"!"===w.source.substr(w.nextMatch,1)?($cell=jQuery(document.createElement("th")).appendTo(rowEl),++w.nextMatch):$cell=jQuery(document.createElement("td")).appendTo(rowEl),prevColumns[col]={rowCount:1,$element:$cell},curColCount>1&&($cell.attr("colspan",curColCount),curColCount=1),w.subWikify($cell[0],_this12.cellTerminator)," "===w.matchText.substr(w.matchText.length-2,1)&&(spaceRight=!0),css.classes.forEach((function(className){return $cell.addClass(className)})),""!==css.id&&$cell.attr("id",css.id),spaceLeft&&spaceRight?css.styles["text-align"]="center":spaceLeft?css.styles["text-align"]="right":spaceRight&&(css.styles["text-align"]="left"),$cell.css(css.styles),w.nextMatch=w.nextMatch-1}()}++col}}while(matched)}}),Wikifier.Parser.add({name:"list",profiles:["block"],match:"^(?:(?:\\*+)|(?:#+))",lookahead:/^(?:(\*+)|(#+))/gm,terminator:"\\n",handler:function(w){if(Wikifier.helpers.hasBlockContext(w.output.childNodes)){w.nextMatch=w.matchStart;var matched,i,destStack=[w.output],curType=null,curLevel=0;do{this.lookahead.lastIndex=w.nextMatch;var match=this.lookahead.exec(w.source);if(matched=match&&match.index===w.nextMatch){var newType=match[2]?"ol":"ul",newLevel=match[0].length;if(w.nextMatch+=match[0].length,newLevel>curLevel)for(i=curLevel;i<newLevel;++i)destStack.push(jQuery(document.createElement(newType)).appendTo(destStack[destStack.length-1]).get(0));else if(newLevel<curLevel)for(i=curLevel;i>newLevel;--i)destStack.pop();else newLevel===curLevel&&newType!==curType&&(destStack.pop(),destStack.push(jQuery(document.createElement(newType)).appendTo(destStack[destStack.length-1]).get(0)));curLevel=newLevel,curType=newType,w.subWikify(jQuery(document.createElement("li")).appendTo(destStack[destStack.length-1]).get(0),this.terminator)}}while(matched)}else jQuery(w.output).append(document.createTextNode(w.matchText))}}),Wikifier.Parser.add({name:"commentByBlock",profiles:["core"],match:"(?:/(?:%|\\*))|(?:\x3c!--)",lookahead:/(?:\/(%|\*)(?:(?:.|\n)*?)\1\/)|(?:<!--(?:(?:.|\n)*?)-->)/gm,handler:function(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);match&&match.index===w.matchStart&&(w.nextMatch=this.lookahead.lastIndex)}}),Wikifier.Parser.add({name:"lineContinuation",profiles:["core"],match:"\\\\".concat(Patterns.spaceNoTerminator,"*\\n|\\n").concat(Patterns.spaceNoTerminator,"*\\\\|\\n?\\\\").concat(Patterns.spaceNoTerminator,"*$|^").concat(Patterns.spaceNoTerminator,"*\\\\\\n?"),handler:function(w){w.nextMatch=w.matchStart+w.matchLength}}),Wikifier.Parser.add({name:"lineBreak",profiles:["core"],match:"\\n|<[Bb][Rr]\\s*/?>",handler:function(w){w.options.nobr||jQuery(document.createElement("br")).appendTo(w.output)}}),Wikifier.Parser.add({name:"htmlCharacterReference",profiles:["core"],match:"(?:(?:&#?[0-9A-Za-z]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9A-Fa-f]|1D[C-Fc-f][0-9A-Fa-f]|20[D-Fd-f][0-9A-Fa-f]|FE2[0-9A-Fa-f])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[0-9A-Za-z]{2,8};)",handler:function(w){jQuery(document.createDocumentFragment()).append(w.matchText).appendTo(w.output)}}),Wikifier.Parser.add({name:"xmlProlog",profiles:["core"],match:"<\\?[Xx][Mm][Ll][^>]*\\?>",handler:function(w){w.nextMatch=w.matchStart+w.matchLength}}),Wikifier.Parser.add({name:"verbatimHtml",profiles:["core"],match:"<[Hh][Tt][Mm][Ll]>",lookahead:/<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/gm,handler:_verbatimTagHandler}),Wikifier.Parser.add({name:"verbatimScriptTag",profiles:["core"],match:"<[Ss][Cc][Rr][Ii][Pp][Tt][^>]*>",lookahead:/(<[Ss][Cc][Rr][Ii][Pp][Tt]*>(?:.|\n)*?<\/[Ss][Cc][Rr][Ii][Pp][Tt]>)/gm,handler:_verbatimTagHandler}),Wikifier.Parser.add({name:"styleTag",profiles:["core"],match:"<[Ss][Tt][Yy][Ll][Ee][^>]*>",lookahead:/(<[Ss][Tt][Yy][Ll][Ee]*>)((?:.|\n)*?)(<\/[Ss][Tt][Yy][Ll][Ee]>)/gm,imageMarkup:new RegExp(Patterns.cssImage,"g"),hasImageMarkup:new RegExp(Patterns.cssImage),handler:function(w){this.lookahead.lastIndex=w.matchStart;var match=this.lookahead.exec(w.source);if(match&&match.index===w.matchStart){w.nextMatch=this.lookahead.lastIndex;var css=match[2];this.hasImageMarkup.test(css)&&(this.imageMarkup.lastIndex=0,css=css.replace(this.imageMarkup,(function(wikiImage){var markup=Wikifier.helpers.parseSquareBracketedMarkup({source:wikiImage,matchStart:0});if(markup.hasOwnProperty("error")||markup.pos<wikiImage.length)return wikiImage;var source=markup.source;if("data:"!==source.slice(0,5)&&Story.has(source)){var passage=Story.get(source);passage.tags.includes("Twine.image")&&(source=passage.text)}return'url("'.concat(source.replace(/"/g,"%22"),'")')}))),jQuery(document.createDocumentFragment()).append(match[1]+css+match[3]).appendTo(w.output)}}}),Wikifier.Parser.add({name:"svgTag",profiles:["core"],match:"<[Ss][Vv][Gg][^>]*>",lookahead:/<(\/?)[Ss][Vv][Gg][^>]*>/gm,namespace:"http://www.w3.org/2000/svg",handler:function(w){var _this13=this;this.lookahead.lastIndex=w.nextMatch;for(var match,depth=1;depth>0&&null!==(match=this.lookahead.exec(w.source));)depth+="/"===match[1]?-1:1;if(0===depth){w.nextMatch=this.lookahead.lastIndex;var svgTag=w.source.slice(w.matchStart,this.lookahead.lastIndex),$frag=jQuery(document.createDocumentFragment()).append(svgTag);$frag.find("a[data-passage],image[data-passage]").each((function(_,el){var tagName=el.tagName.toLowerCase();try{_this13.processAttributeDirectives(el)}catch(ex){return throwError(w.output,"svg|<".concat(tagName,">: ").concat(ex.message),"".concat(w.matchText,"…"))}el.hasAttribute("data-passage")&&_this13.processDataAttributes(el,tagName)})),$frag.appendTo(w.output)}},processAttributeDirectives:function(el){_toConsumableArray(el.attributes).forEach((function(_ref10){var name=_ref10.name,value=_ref10.value,evalShorthand="@"===name[0];if(evalShorthand||name.startsWith("sc-eval:")){var result,newName=name.slice(evalShorthand?1:8);if("data-setter"===newName)throw new Error('evaluation directive is not allowed on the data-setter attribute: "'.concat(name,'"'));try{result=Scripting.evalTwineScript(value)}catch(ex){throw new Error('bad evaluation from attribute directive "'.concat(name,'": ').concat(ex.message))}try{el.setAttribute(newName,result),el.removeAttribute(name)}catch(ex){throw new Error('cannot transform attribute directive "'.concat(name,'" into attribute "').concat(newName,'"'))}}}))},processDataAttributes:function(el,tagName){var passage=el.getAttribute("data-passage");if(null!=passage){var evaluated=Wikifier.helpers.evalPassageId(passage);if(evaluated!==passage&&(passage=evaluated,el.setAttribute("data-passage",evaluated)),""!==passage)if("image"===tagName)"data:"!==passage.slice(0,5)&&Story.has(passage)&&(passage=Story.get(passage)).tags.includes("Twine.image")&&el.setAttribute("href",passage.text.trim());else{var setFn,setter=el.getAttribute("data-setter");null!=setter&&""!==(setter=String(setter).trim())&&(setFn=Wikifier.helpers.createShadowSetterCallback(Scripting.parse(setter))),Story.has(passage)?(el.classList.add("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(passage)&&el.classList.add("link-visited")):el.classList.add("link-broken"),jQuery(el).ariaClick({one:!0},(function(){"function"==typeof setFn&&setFn.call(this),Engine.play(passage)}))}}}}),Wikifier.Parser.add({name:"htmlTag",profiles:["core"],match:"<".concat(Patterns.htmlTagName,"(?:\\s+[^\\u0000-\\u001F\\u007F-\\u009F\\s\"'>\\/=]+(?:\\s*=\\s*(?:\"[^\"]*?\"|'[^']*?'|[^\\s\"'=<>`]+))?)*\\s*\\/?>"),tagRe:new RegExp("^<(".concat(Patterns.htmlTagName,")")),mediaTags:["audio","img","source","track","video"],nobrTags:["audio","colgroup","datalist","dl","figure","meter","ol","optgroup","picture","progress","ruby","select","table","tbody","tfoot","thead","tr","ul","video"],voidTags:["area","base","br","col","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"],handler:function(w){var tagMatch=this.tagRe.exec(w.matchText),tag=tagMatch&&tagMatch[1],tagName=tag&&tag.toLowerCase();if(tagName){var terminator,terminatorMatch,isVoid=this.voidTags.includes(tagName)||w.matchText.endsWith("/>"),isNobr=this.nobrTags.includes(tagName);if(!isVoid){terminator="<\\/".concat(tagName,"\\s*>");var terminatorRe=new RegExp(terminator,"gim");terminatorRe.lastIndex=w.matchStart,terminatorMatch=terminatorRe.exec(w.source)}if(!isVoid&&!terminatorMatch)return throwError(w.output,"cannot find a closing tag for HTML <".concat(tag,">"),"".concat(w.matchText,"…"));var debugView,output=w.output,el=document.createElement(w.output.tagName);for(el.innerHTML=w.matchText;el.firstChild;)el=el.firstChild;try{this.processAttributeDirectives(el)}catch(ex){return throwError(w.output,"<".concat(tagName,">: ").concat(ex.message),"".concat(w.matchText,"…"))}if(el.hasAttribute("data-passage")&&(this.processDataAttributes(el,tagName),Config.debug&&((debugView=new DebugView(w.output,"html-".concat(tagName),tagName,w.matchText)).modes({block:"img"===tagName,nonvoid:terminatorMatch}),output=debugView.output)),terminatorMatch){try{Wikifier.Option.push({nobr:isNobr}),w.subWikify(el,terminator,{ignoreTerminatorCase:!0})}finally{Wikifier.Option.pop()}debugView&&jQuery(el).find(".debug.block").length>0&&debugView.modes({block:!0})}output.appendChild("track"===tagName?el.cloneNode(!0):el)}},processAttributeDirectives:function(el){_toConsumableArray(el.attributes).forEach((function(_ref11){var name=_ref11.name,value=_ref11.value,evalShorthand="@"===name[0];if(evalShorthand||name.startsWith("sc-eval:")){var result,newName=name.slice(evalShorthand?1:8);if("data-setter"===newName)throw new Error('evaluation directive is not allowed on the data-setter attribute: "'.concat(name,'"'));try{result=Scripting.evalTwineScript(value)}catch(ex){throw new Error('bad evaluation from attribute directive "'.concat(name,'": ').concat(ex.message))}try{el.setAttribute(newName,result),el.removeAttribute(name)}catch(ex){throw new Error('cannot transform attribute directive "'.concat(name,'" into attribute "').concat(newName,'"'))}}}))},processDataAttributes:function(el,tagName){var passage=el.getAttribute("data-passage");if(null!=passage){var evaluated=Wikifier.helpers.evalPassageId(passage);if(evaluated!==passage&&(passage=evaluated,el.setAttribute("data-passage",evaluated)),""!==passage)if(this.mediaTags.includes(tagName)){if("data:"!==passage.slice(0,5)&&Story.has(passage)){var parentName,twineTag;switch(passage=Story.get(passage),tagName){case"audio":case"video":twineTag="Twine.".concat(tagName);break;case"img":twineTag="Twine.image";break;case"track":twineTag="Twine.vtt";break;case"source":var $parent=$(el).closest("audio,picture,video");$parent.length&&(parentName=$parent.get(0).tagName.toLowerCase(),twineTag="Twine.".concat("picture"===parentName?"image":parentName))}passage.tags.includes(twineTag)&&(el["picture"===parentName?"srcset":"src"]=passage.text.trim())}}else{var setFn,setter=el.getAttribute("data-setter");null!=setter&&""!==(setter=String(setter).trim())&&(setFn=Wikifier.helpers.createShadowSetterCallback(Scripting.parse(setter))),Story.has(passage)?(el.classList.add("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(passage)&&el.classList.add("link-visited")):el.classList.add("link-broken"),jQuery(el).ariaClick({one:!0},(function(){"function"==typeof setFn&&setFn.call(this),Engine.play(passage)}))}}}})}();var Template=(_templates=new Map,_validNameRe=new RegExp("^(?:".concat(Patterns.templateName,")$")),_validType=function(template){var templateType=_typeof(template);return"function"===templateType||"string"===templateType},Object.freeze(Object.defineProperties({},{add:{value:function(name,template){if(!(_validType(template)||template instanceof Array&&template.length>0&&template.every(_validType)))throw new TypeError("invalid template type (".concat(name,"); templates must be: functions, strings, or an array of either"));(name instanceof Array?name:[name]).forEach((function(name){if(!_validNameRe.test(name))throw new Error('invalid template name "'.concat(name,'"'));if(_templates.has(name))throw new Error("cannot clobber existing template ?".concat(name));_templates.set(name,template)}))}},delete:{value:function(name){(name instanceof Array?name:[name]).forEach((function(name){return _templates.delete(name)}))}},get:{value:function(name){return _templates.has(name)?_templates.get(name):null}},has:{value:function(name){return _templates.has(name)}},size:{get:function(){return _templates.size}}}))),_templates,_validNameRe,_validType,Macro=function(){var _macros={},_tags={},_validNameRe=new RegExp("^(?:".concat(Patterns.macroName,")$"));function macrosHas(name){return _macros.hasOwnProperty(name)}function tagsRegister(parent,bodyTags){if(!parent)throw new Error("no parent specified");for(var endTags=["/".concat(parent),"end".concat(parent)],allTags=[].concat(endTags,Array.isArray(bodyTags)?bodyTags:[]),i=0;i<allTags.length;++i){var tag=allTags[i];if(macrosHas(tag))throw new Error("cannot register tag for an existing macro");tagsHas(tag)?_tags[tag].includes(parent)||(_tags[tag].push(parent),_tags[tag].sort()):_tags[tag]=[parent]}}function tagsUnregister(parent){if(!parent)throw new Error("no parent specified");Object.keys(_tags).forEach((function(tag){var i=_tags[tag].indexOf(parent);-1!==i&&(1===_tags[tag].length?delete _tags[tag]:_tags[tag].splice(i,1))}))}function tagsHas(name){return _tags.hasOwnProperty(name)}return Object.freeze(Object.defineProperties({},{add:{value:function macrosAdd(name,def){if(Array.isArray(name))name.forEach((function(name){return macrosAdd(name,def)}));else{if(!_validNameRe.test(name))throw new Error('invalid macro name "'.concat(name,'"'));if(macrosHas(name))throw new Error("cannot clobber existing macro <<".concat(name,">>"));if(tagsHas(name))throw new Error("cannot clobber child tag <<".concat(name,">> of parent macro").concat(1===_tags[name].length?"":"s"," <<").concat(_tags[name].join(">>, <<"),">>"));try{if("object"===_typeof(def))_macros[name]=Object.assign(Object.create(null),def,{_MACRO_API:!0});else{if(!macrosHas(def))throw new Error("cannot create alias of nonexistent macro <<".concat(def,">>"));_macros[name]=Object.create(_macros[def],{_ALIAS_OF:{enumerable:!0,value:def}})}Object.defineProperty(_macros,name,{writable:!1})}catch(ex){throw"TypeError"===ex.name?new Error("cannot clobber protected macro <<".concat(name,">>")):new Error("unknown error when attempting to add macro <<".concat(name,">>: [").concat(ex.name,"] ").concat(ex.message))}if(void 0!==_macros[name].tags)if(null==_macros[name].tags)tagsRegister(name);else{if(!Array.isArray(_macros[name].tags))throw new Error('bad value for "tags" property of macro <<'.concat(name,">>"));tagsRegister(name,_macros[name].tags)}}}},delete:{value:function macrosDelete(name){if(Array.isArray(name))name.forEach((function(name){return macrosDelete(name)}));else if(macrosHas(name)){void 0!==_macros[name].tags&&tagsUnregister(name);try{Object.defineProperty(_macros,name,{writable:!0}),delete _macros[name]}catch(ex){throw new Error("unknown error removing macro <<".concat(name,">>: ").concat(ex.message))}}else if(tagsHas(name))throw new Error("cannot remove child tag <<".concat(name,">> of parent macro <<").concat(_tags[name],">>"))}},isEmpty:{value:function(){return 0===Object.keys(_macros).length}},has:{value:macrosHas},get:{value:function(name){var macro=null;return macrosHas(name)&&"function"==typeof _macros[name].handler?macro=_macros[name]:macros.hasOwnProperty(name)&&"function"==typeof macros[name].handler&&(macro=macros[name]),macro}},init:{value:function(){var handler=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"init";Object.keys(_macros).forEach((function(name){"function"==typeof _macros[name][handler]&&_macros[name][handler](name)})),Object.keys(macros).forEach((function(name){"function"==typeof macros[name][handler]&&macros[name][handler](name)}))}},tags:{value:Object.freeze(Object.defineProperties({},{register:{value:tagsRegister},unregister:{value:tagsUnregister},has:{value:tagsHas},get:{value:function(name){return tagsHas(name)?_tags[name]:null}}}))},evalStatements:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}}}))}(),MacroContext=function(){var MacroContext=function(){function MacroContext(contextData){_classCallCheck(this,MacroContext);var context=Object.assign({parent:null,macro:null,name:"",displayName:"",args:null,payload:null,parser:null,source:""},contextData);if(null===context.macro||""===context.name||null===context.parser)throw new TypeError("context object missing required properties");Object.defineProperties(this,{self:{value:context.macro},name:{value:void 0===context.macro._ALIAS_OF?context.name:context.macro._ALIAS_OF},displayName:{value:context.name},args:{value:context.args},payload:{value:context.payload},source:{value:context.source},parent:{value:context.parent},parser:{value:context.parser},_output:{value:context.parser.output},_shadows:{writable:!0,value:null},_debugView:{writable:!0,value:null},_debugViewEnabled:{writable:!0,value:Config.debug}})}return _createClass(MacroContext,[{key:"output",get:function(){return this._debugViewEnabled?this.debugView.output:this._output}},{key:"shadows",get:function(){return _toConsumableArray(this._shadows)}},{key:"shadowView",get:function(){var view=new Set;return this.contextSelectAll((function(ctx){return ctx._shadows})).forEach((function(ctx){return ctx._shadows.forEach((function(name){return view.add(name)}))})),_toConsumableArray(view)}},{key:"debugView",get:function(){return this._debugViewEnabled?null!==this._debugView?this._debugView:this.createDebugView():null}},{key:"contextHas",value:function(filter){for(var context=this;null!==(context=context.parent);)if(filter(context))return!0;return!1}},{key:"contextSelect",value:function(filter){for(var context=this;null!==(context=context.parent);)if(filter(context))return context;return null}},{key:"contextSelectAll",value:function(filter){for(var result=[],context=this;null!==(context=context.parent);)filter(context)&&result.push(context);return result}},{key:"addShadow",value:function(){var _this14=this;this._shadows||(this._shadows=new Set);for(var varRe=new RegExp("^".concat(Patterns.variable,"$")),_len14=arguments.length,names=new Array(_len14),_key14=0;_key14<_len14;_key14++)names[_key14]=arguments[_key14];names.flat(1/0).forEach((function(name){if("string"!=typeof name)throw new TypeError("variable name must be a string; type: ".concat(_typeof(name)));if(!varRe.test(name))throw new Error('invalid variable name "'.concat(name,'"'));_this14._shadows.add(name)}))}},{key:"createShadowWrapper",value:function(callback,doneCallback,startCallback){var shadowStore,shadowContext=this;return"function"==typeof callback&&(shadowStore={},this.shadowView.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;shadowStore[varName]=store[varKey]}))),function(){for(var _len15=arguments.length,args=new Array(_len15),_key15=0;_key15<_len15;_key15++)args[_key15]=arguments[_key15];if("function"==typeof startCallback&&startCallback.apply(this,args),"function"==typeof callback){var contextCache,shadowNames=Object.keys(shadowStore),valueCache=shadowNames.length>0?{}:null,macroParser=Wikifier.Parser.get("macro");try{shadowNames.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;store.hasOwnProperty(varKey)&&(valueCache[varKey]=store[varKey]),store[varKey]=shadowStore[varName]})),contextCache=macroParser.context,macroParser.context=shadowContext,callback.apply(this,args)}finally{contextCache!==undefined&&(macroParser.context=contextCache),shadowNames.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;shadowStore[varName]=store[varKey],valueCache.hasOwnProperty(varKey)?store[varKey]=valueCache[varKey]:delete store[varKey]}))}}"function"==typeof doneCallback&&doneCallback.apply(this,args)}}},{key:"createDebugView",value:function(name,title){return this._debugView=new DebugView(this._output,"macro",name||this.displayName,title||this.source),null!==this.payload&&this.payload.length>0&&this._debugView.modes({nonvoid:!0}),this._debugViewEnabled=!0,this._debugView}},{key:"removeDebugView",value:function(){null!==this._debugView&&(this._debugView.remove(),this._debugView=null),this._debugViewEnabled=!1}},{key:"error",value:function(message,source){return throwError(this._output,"<<".concat(this.displayName,">>: ").concat(message),source||this.source)}}]),MacroContext}();return MacroContext}();!function(){if(Macro.add("capture",{skipArgs:!0,tags:null,tsVarRe:new RegExp("(".concat(Patterns.variable,")"),"g"),handler:function(){if(0===this.args.raw.length)return this.error("no story/temporary variable list specified");var valueCache={};try{for(var match,tsVarRe=this.self.tsVarRe;null!==(match=tsVarRe.exec(this.args.raw));){var varName=match[1],varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;store.hasOwnProperty(varKey)&&(valueCache[varKey]=store[varKey]),this.addShadow(varName)}new Wikifier(this.output,this.payload[0].contents)}finally{this.shadows.forEach((function(varName){var varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary;valueCache.hasOwnProperty(varKey)?store[varKey]=valueCache[varKey]:delete store[varKey]}))}}}),Macro.add("set",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{Scripting.evalJavaScript(this.args.full)}catch(ex){return this.error("bad evaluation: ".concat("object"===_typeof(ex)?ex.message:ex))}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("unset",{skipArgs:!0,jsVarRe:new RegExp("State\\.(variables|temporary)\\.(".concat(Patterns.identifier,")"),"g"),handler:function(){if(0===this.args.full.length)return this.error("no story/temporary variable list specified");for(var match,jsVarRe=this.self.jsVarRe;null!==(match=jsVarRe.exec(this.args.full));){var store=State[match[1]],name=match[2];store.hasOwnProperty(name)&&delete store[name]}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("remember",{skipArgs:!0,jsVarRe:new RegExp("State\\.variables\\.(".concat(Patterns.identifier,")"),"g"),handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{Scripting.evalJavaScript(this.args.full)}catch(ex){return this.error("bad evaluation: ".concat("object"===_typeof(ex)?ex.message:ex))}for(var match,remember=storage.get("remember")||{},jsVarRe=this.self.jsVarRe;null!==(match=jsVarRe.exec(this.args.full));){var name=match[1];remember[name]=State.variables[name]}if(!storage.set("remember",remember))return this.error("unknown error, cannot remember: ".concat(this.args.raw));Config.debug&&this.debugView.modes({hidden:!0})},init:function(){var remember=storage.get("remember");remember&&Object.keys(remember).forEach((function(name){return State.variables[name]=remember[name]}))}}),Macro.add("forget",{skipArgs:!0,jsVarRe:new RegExp("State\\.variables\\.(".concat(Patterns.identifier,")"),"g"),handler:function(){if(0===this.args.full.length)return this.error("no story variable list specified");for(var match,remember=storage.get("remember"),jsVarRe=this.self.jsVarRe,needStore=!1;null!==(match=jsVarRe.exec(this.args.full));){var name=match[1];State.variables.hasOwnProperty(name)&&delete State.variables[name],remember&&remember.hasOwnProperty(name)&&(needStore=!0,delete remember[name])}if(needStore)if(0===Object.keys(remember).length){if(!storage.delete("remember"))return this.error("unknown error, cannot update remember store")}else if(!storage.set("remember",remember))return this.error("unknown error, cannot update remember store");Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("run","set"),Macro.add("script",{skipArgs:!0,tags:null,handler:function(){var output=document.createDocumentFragment();try{Scripting.evalJavaScript(this.payload[0].contents,output)}catch(ex){return this.error("bad evaluation: ".concat("object"===_typeof(ex)?ex.message:ex))}Config.debug&&this.createDebugView(),output.hasChildNodes()&&this.output.appendChild(output)}}),Macro.add("include",{handler:function(){return 0===this.args.length?this.error("no passage specified"):(passage="object"===_typeof(this.args[0])?this.args[0].link:this.args[0],Story.has(passage)?(Config.debug&&this.debugView.modes({block:!0}),passage=Story.get(passage),void(this.args[1]?jQuery(document.createElement(this.args[1])).addClass("".concat(passage.domId," macro-").concat(this.name)).attr("data-passage",passage.title).appendTo(this.output):jQuery(this.output)).wiki(passage.processText())):this.error('passage "'.concat(passage,'" does not exist')));var passage}}),Macro.add("nobr",{skipArgs:!0,tags:null,handler:function(){new Wikifier(this.output,this.payload[0].contents.replace(/^\n+|\n+$/g,"").replace(/\n+/g," "))}}),Macro.add(["print","=","-"],{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{var result=stringFrom(Scripting.evalJavaScript(this.args.full));null!==result&&new Wikifier(this.output,"-"===this.name?Util.escape(result):result)}catch(ex){return this.error("bad evaluation: ".concat("object"===_typeof(ex)?ex.message:ex))}}}),Macro.add("silently",{skipArgs:!0,tags:null,handler:function(){var frag=document.createDocumentFragment();if(new Wikifier(frag,this.payload[0].contents.trim()),Config.debug)this.debugView.modes({block:!0,hidden:!0}),this.output.appendChild(frag);else{var errList=_toConsumableArray(frag.querySelectorAll(".error")).map((function(errEl){return errEl.textContent}));if(errList.length>0)return this.error("error".concat(1===errList.length?"":"s"," within contents (").concat(errList.join("; "),")"))}}}),Macro.add("type",{isAsync:!0,tags:null,typeId:0,handler:function(){if(0===this.args.length)return this.error("no speed specified");var cursor,speed=Util.fromCssTime(this.args[0]);if(speed<0)return this.error("speed time value must be non-negative (received: ".concat(this.args[0],")"));for(var elClass="",elId="",elTag="div",skipKey=Config.macros.typeSkipKey,start=400,options=this.args.slice(1);options.length>0;){var option=options.shift();switch(option){case"class":if(0===options.length)return this.error("class option missing required class name(s)");if(""===(elClass=options.shift()))throw new Error('class option class name(s) must be non-empty (received: "")');break;case"element":if(0===options.length)return this.error("element option missing required element tag name");if(""===(elTag=options.shift()))throw new Error('element option tag name must be non-empty (received: "")');break;case"id":if(0===options.length)return this.error("id option missing required ID");if(""===(elId=options.shift()))throw new Error('id option ID must be non-empty (received: "")');break;case"keep":cursor="keep";break;case"none":cursor="none";break;case"skipkey":if(0===options.length)return this.error("skipkey option missing required key value");if(""===(skipKey=options.shift()))throw new Error('skipkey option key value must be non-empty (received: "")');break;case"start":if(0===options.length)return this.error("start option missing required time value");var value=options.shift();if((start=Util.fromCssTime(value))<0)throw new Error("start option time value must be non-negative (received: ".concat(value,")"));break;default:return this.error("unknown option: ".concat(option))}}var contents=this.payload[0].contents;if(""!==contents.trim()){Config.debug&&this.debugView.modes({block:!0});var className="macro-".concat(this.name),namespace=".".concat(className),$target=jQuery(document.createElement(elTag)).addClass("".concat(className," ").concat(className,"-target")).appendTo(this.output);TempState.macroTypeQueue||(TempState.macroTypeQueue=[],$(document).off(namespace).one(":passageinit".concat(namespace),(function(){return $(document).off(namespace)})));var startTyping=0===TempState.macroTypeQueue.length,selfId=++this.self.typeId;TempState.macroTypeQueue.push({id:selfId,handler:function(){var $wrapper=jQuery(document.createElement(elTag)).addClass(className);elId&&$wrapper.attr("id",elId),elClass&&$wrapper.addClass(elClass),new Wikifier($wrapper,contents);var passage=State.passage,turn=State.turns;if(!Config.macros.typeVisitedPassages&&State.passages.slice(0,-1).some((function(title){return title===passage}))||$wrapper.find(".error").length>0)return $target.replaceWith($wrapper),TempState.macroTypeQueue.shift(),void(TempState.macroTypeQueue.length>0&&TempState.macroTypeQueue.first().handler());var typer=new NodeTyper({targetNode:$wrapper.get(0),classNames:"none"===cursor?null:"".concat(className,"-cursor")});$target.replaceWith($wrapper);var keydownAndNS="keydown".concat(namespace),typingStopAndNS="".concat(":typingstop").concat(namespace);$(document).off(keydownAndNS).on(keydownAndNS,(function(ev){Util.scrubEventKey(ev.key)!==skipKey||ev.target!==document.body&&ev.target!==document.documentElement||(ev.preventDefault(),$(document).off(keydownAndNS),typer.finish())})).one(typingStopAndNS,(function(){TempState.macroTypeQueue&&(0===TempState.macroTypeQueue.length?jQuery.event.trigger(":typingcomplete"):TempState.macroTypeQueue.first().handler())}));var typeNode=function(){var typeNodeMember=function(typeIntervalId){State.passage===passage&&State.turns===turn&&typer.type()||(typeIntervalId&&clearInterval(typeIntervalId),TempState.macroTypeQueue&&TempState.macroTypeQueue.length>0&&TempState.macroTypeQueue.first().id===selfId&&TempState.macroTypeQueue.shift(),$wrapper.trigger(":typingstop"),$wrapper.addClass("".concat(className,"-done")),"keep"===cursor&&$wrapper.addClass("".concat(className,"-cursor")))};$wrapper.trigger(":typingstart"),typeNodeMember();var typeNodeMemberId=setInterval((function(){return typeNodeMember(typeNodeMemberId)}),speed)};start?setTimeout(typeNode,start):typeNode()}}),startTyping&&(Engine.isPlaying()?$(document).one(":passageend".concat(namespace),(function(){return TempState.macroTypeQueue.first().handler()})):TempState.macroTypeQueue.first().handler())}}}),Macro.add("display","include"),Macro.add("if",{skipArgs:!0,tags:["elseif","else"],elseifWsRe:/^\s*if\b/i,ifAssignRe:/[^!=&^|<>*/%+-]=[^=>]/,handler:function(){var i;try{var len=this.payload.length,elseifWsRe=this.self.elseifWsRe,ifAssignRe=this.self.ifAssignRe;for(i=0;i<len;++i)if("else"===this.payload[i].name){if(this.payload[i].args.raw.length>0)return elseifWsRe.test(this.payload[i].args.raw)?this.error('whitespace is not allowed between the "else" and "if" in <<elseif>> clause'.concat(i>0?" (#"+i+")":"")):this.error("<<else>> does not accept a conditional expression (perhaps you meant to use <<elseif>>), invalid: ".concat(this.payload[i].args.raw));if(i+1!==len)return this.error("<<else>> must be the final clause")}else{if(0===this.payload[i].args.full.length)return this.error("no conditional expression specified for <<".concat(this.payload[i].name,">> clause").concat(i>0?" (#"+i+")":""));if(Config.macros.ifAssignmentError&&ifAssignRe.test(this.payload[i].args.full))return this.error("assignment operator found within <<".concat(this.payload[i].name,">> clause").concat(i>0?" (#"+i+")":""," (perhaps you meant to use an equality operator: ==, ===, eq, is), invalid: ").concat(this.payload[i].args.raw))}var evalJavaScript=Scripting.evalJavaScript,success=!1;for(i=0;i<len;++i){if(Config.debug&&this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1}),"else"===this.payload[i].name||evalJavaScript(this.payload[i].args.full)){success=!0,new Wikifier(this.output,this.payload[i].contents);break}Config.debug&&this.debugView.modes({hidden:!0,invalid:!0})}if(Config.debug){for(++i;i<len;++i)this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1,hidden:!0,invalid:!0});this.createDebugView("/".concat(this.name),"<</".concat(this.name,">>")).modes({nonvoid:!1,hidden:!success,invalid:!success})}}catch(ex){return this.error("bad conditional expression in <<".concat(0===i?"if":"elseif",">> clause").concat(i>0?" (#"+i+")":"",": ").concat("object"===_typeof(ex)?ex.message:ex))}}}),Macro.add("switch",{skipArgs:["switch"],tags:["case","default"],handler:function(){if(0===this.args.full.length)return this.error("no expression specified");var i,result,len=this.payload.length;if(1===len)return this.error("no cases specified");for(i=1;i<len;++i)if("default"===this.payload[i].name){if(this.payload[i].args.length>0)return this.error("<<default>> does not accept values, invalid: ".concat(this.payload[i].args.raw));if(i+1!==len)return this.error("<<default>> must be the final case")}else if(0===this.payload[i].args.length)return this.error("no value(s) specified for <<".concat(this.payload[i].name,">> (#").concat(i,")"));try{result=Scripting.evalJavaScript(this.args.full)}catch(ex){return this.error("bad evaluation: ".concat("object"===_typeof(ex)?ex.message:ex))}var debugView=this.debugView,success=!1;for(Config.debug&&debugView.modes({nonvoid:!1,hidden:!0}),i=1;i<len;++i){if(Config.debug&&this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1}),"default"===this.payload[i].name||this.payload[i].args.some((function(val){return val===result}))){success=!0,new Wikifier(this.output,this.payload[i].contents);break}Config.debug&&this.debugView.modes({hidden:!0,invalid:!0})}if(Config.debug){for(++i;i<len;++i)this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1,hidden:!0,invalid:!0});debugView.modes({nonvoid:!1,hidden:!0,invalid:!success}),this.createDebugView("/".concat(this.name),"<</".concat(this.name,">>")).modes({nonvoid:!1,hidden:!0,invalid:!success})}}}),Macro.add("for",{skipArgs:!0,tags:null,hasRangeRe:new RegExp("^\\S".concat(Patterns.anyChar,"*?\\s+range\\s+\\S").concat(Patterns.anyChar,"*?$")),rangeRe:new RegExp("^(?:State\\.(variables|temporary)\\.(".concat(Patterns.identifier,")\\s*,\\s*)?State\\.(variables|temporary)\\.(").concat(Patterns.identifier,")\\s+range\\s+(\\S").concat(Patterns.anyChar,"*?)$")),threePartRe:/^([^;]*?)\s*;\s*([^;]*?)\s*;\s*([^;]*?)$/,forInRe:/^\S+\s+in\s+\S+/i,forOfRe:/^\S+\s+of\s+\S+/i,handler:function(){var argsStr=this.args.full.trim(),payload=this.payload[0].contents.replace(/\n$/,"");if(0===argsStr.length)this.self.handleFor.call(this,payload,null,!0,null);else if(this.self.hasRangeRe.test(argsStr)){var parts=argsStr.match(this.self.rangeRe);if(null===parts)return this.error("invalid range form syntax, format: [index ,] value range collection");this.self.handleForRange.call(this,payload,{type:parts[1],name:parts[2]},{type:parts[3],name:parts[4]},parts[5])}else{var init,condition,post;if(-1===argsStr.indexOf(";")){if(this.self.forInRe.test(argsStr))return this.error("invalid syntax, for…in is not supported; see: for…range");if(this.self.forOfRe.test(argsStr))return this.error("invalid syntax, for…of is not supported; see: for…range");condition=argsStr}else{var _parts=argsStr.match(this.self.threePartRe);if(null===_parts)return this.error("invalid 3-part conditional form syntax, format: [init] ; [condition] ; [post]");init=_parts[1],condition=_parts[2].trim(),post=_parts[3],0===condition.length&&(condition=!0)}this.self.handleFor.call(this,payload,init,condition,post)}},handleFor:function(payload,init,condition,post){var evalJavaScript=Scripting.evalJavaScript,first=!0,safety=Config.macros.maxLoopIterations;Config.debug&&this.debugView.modes({block:!0});try{if(TempState.break=null,init)try{evalJavaScript(init)}catch(ex){return this.error("bad init expression: ".concat("object"===_typeof(ex)?ex.message:ex))}for(;evalJavaScript(condition);){if(--safety<0)return this.error("exceeded configured maximum loop iterations (".concat(Config.macros.maxLoopIterations,")"));if(new Wikifier(this.output,first?payload.replace(/^\n/,""):payload),first&&(first=!1),null!=TempState.break)if(1===TempState.break)TempState.break=null;else if(2===TempState.break){TempState.break=null;break}if(post)try{evalJavaScript(post)}catch(ex){return this.error("bad post expression: ".concat("object"===_typeof(ex)?ex.message:ex))}}}catch(ex){return this.error("bad conditional expression: ".concat("object"===_typeof(ex)?ex.message:ex))}finally{TempState.break=null}},handleForRange:function(payload,indexVar,valueVar,rangeExp){var rangeList,first=!0;try{rangeList=this.self.toRangeList(rangeExp)}catch(ex){return this.error(ex.message)}Config.debug&&this.debugView.modes({block:!0});try{TempState.break=null;for(var i=0;i<rangeList.length;++i)if(indexVar.name&&(State[indexVar.type][indexVar.name]=rangeList[i][0]),State[valueVar.type][valueVar.name]=rangeList[i][1],new Wikifier(this.output,first?payload.replace(/^\n/,""):payload),first&&(first=!1),null!=TempState.break)if(1===TempState.break)TempState.break=null;else if(2===TempState.break){TempState.break=null;break}}catch(ex){return this.error("object"===_typeof(ex)?ex.message:ex)}finally{TempState.break=null}},toRangeList:function(rangeExp){var value,list,evalJavaScript=Scripting.evalJavaScript;try{value=evalJavaScript("{"===rangeExp[0]?"(".concat(rangeExp,")"):rangeExp)}catch(ex){if("object"!==_typeof(ex))throw new Error("bad range expression: ".concat(ex));throw ex.message="bad range expression: ".concat(ex.message),ex}switch(_typeof(value)){case"string":list=[];for(var i=0;i<value.length;){var obj=Util.charAndPosAt(value,i);list.push([i,obj.char]),i=1+obj.end}break;case"object":if(Array.isArray(value))list=value.map((function(val,i){return[i,val]}));else if(value instanceof Set)list=_toConsumableArray(value).map((function(val,i){return[i,val]}));else if(value instanceof Map)list=_toConsumableArray(value.entries());else{if("Object"!==Util.toStringTag(value))throw new Error("unsupported range expression type: ".concat(Util.toStringTag(value)));list=Object.keys(value).map((function(key){return[key,value[key]]}))}break;default:throw new Error("unsupported range expression type: ".concat(_typeof(value)))}return list}}),Macro.add(["break","continue"],{skipArgs:!0,handler:function(){if(!this.contextHas((function(ctx){return"for"===ctx.name})))return this.error("must only be used in conjunction with its parent macro <<for>>");TempState.break="continue"===this.name?1:2,Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add(["button","link"],{isAsync:!0,tags:null,handler:function(){var _this15=this;if(0===this.args.length)return this.error("no ".concat("button"===this.name?"button":"link"," text specified"));var passage,$link=jQuery(document.createElement("button"===this.name?"button":"a"));if("object"===_typeof(this.args[0]))if(this.args[0].isImage){var $image=jQuery(document.createElement("img")).attr("src",this.args[0].source).appendTo($link);$link.addClass("link-image"),this.args[0].hasOwnProperty("passage")&&$image.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&$image.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&$image.attr("align",this.args[0].align),passage=this.args[0].link}else $link.append(document.createTextNode(this.args[0].text)),passage=this.args[0].link;else $link.wikiWithOptions({profile:"core"},this.args[0]),passage=this.args.length>1?this.args[1]:undefined;null!=passage?($link.attr("data-passage",passage),Story.has(passage)?($link.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(passage)&&$link.addClass("link-visited")):$link.addClass("link-broken")):$link.addClass("link-internal"),$link.addClass("macro-".concat(this.name)).ariaClick({namespace:".macros",role:null!=passage?"link":"button",one:null!=passage},this.createShadowWrapper(""!==this.payload[0].contents?function(){return Wikifier.wikifyEval(_this15.payload[0].contents.trim())}:null,null!=passage?function(){return Engine.play(passage)}:null)).appendTo(this.output)}}),Macro.add("checkbox",{isAsync:!0,handler:function(){if(this.args.length<3){var errors=[];return this.args.length<1&&errors.push("variable name"),this.args.length<2&&errors.push("unchecked value"),this.args.length<3&&errors.push("checked value"),this.error("no ".concat(errors.join(" or ")," specified"))}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));var varId=Util.slugify(varName),uncheckValue=this.args[1],checkValue=this.args[2],el=document.createElement("input");switch(jQuery(el).attr({id:"".concat(this.name,"-").concat(varId),name:"".concat(this.name,"-").concat(varId),type:"checkbox",tabindex:0}).addClass("macro-".concat(this.name)).on("change.macros",this.createShadowWrapper((function(){State.setVar(varName,this.checked?checkValue:uncheckValue)}))).appendTo(this.output),this.args[3]){case"autocheck":State.getVar(varName)===checkValue?el.checked=!0:State.setVar(varName,uncheckValue);break;case"checked":el.checked=!0,State.setVar(varName,checkValue);break;default:State.setVar(varName,uncheckValue)}}}),Macro.add(["cycle","listbox"],{isAsync:!0,skipArgs:["optionsfrom"],tags:["option","optionsfrom"],handler:function(){var _this16=this;if(0===this.args.length)return this.error("no variable name specified");if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));var varId=Util.slugify(varName),len=this.payload.length;if(1===len)return this.error("no options specified");for(var config={autoselect:!1,once:!1},i=1;i<this.args.length;++i){var arg=this.args[i];switch(arg){case"once":config.once=!0;break;case"autoselect":config.autoselect=!0;break;default:return this.error("unknown argument: ".concat(arg))}}for(var options=[],tagCount={option:0,optionsfrom:0},selectedIdx=-1,_i5=1;_i5<len;++_i5){var payload=this.payload[_i5];if("option"===payload.name){if(++tagCount.option,0===payload.args.length)return this.error("no arguments specified for <<".concat(payload.name,">> (#").concat(tagCount.option,")"));var option={label:String(payload.args[0])},isSelected=!1;switch(payload.args.length){case 1:option.value=payload.args[0];break;case 2:"selected"===payload.args[1]?(option.value=payload.args[0],isSelected=!0):option.value=payload.args[1];break;default:option.value=payload.args[1],"selected"===payload.args[2]&&(isSelected=!0)}if(options.push(option),isSelected){if(config.autoselect)return this.error("cannot specify both the autoselect and selected keywords");if(-1!==selectedIdx)return this.error("multiple selected keywords specified for <<".concat(payload.name,">> (#").concat(selectedIdx+1," & #").concat(tagCount.option,")"));selectedIdx=options.length-1}}else{var _ret=function(){if(++tagCount.optionsfrom,0===payload.args.full.length)return{v:_this16.error("no expression specified for <<".concat(payload.name,">> (#").concat(tagCount.optionsfrom,")"))};var result=void 0;try{var exp=payload.args.full;result=Scripting.evalJavaScript("{"===exp[0]?"(".concat(exp,")"):exp)}catch(ex){return{v:_this16.error("bad evaluation: ".concat("object"===_typeof(ex)?ex.message:ex))}}if("object"!==_typeof(result)||null===result)return{v:_this16.error("expression must yield a supported collection or generic object (type: ".concat(null===result?"null":_typeof(result),")"))};if(result instanceof Array||result instanceof Set)result.forEach((function(val){return options.push({label:String(val),value:val})}));else if(result instanceof Map)result.forEach((function(val,key){return options.push({label:String(key),value:val})}));else{var oType=Util.toStringTag(result);if("Object"!==oType)return{v:_this16.error("expression must yield a supported collection or generic object (object type: ".concat(oType,")"))};Object.keys(result).forEach((function(key){return options.push({label:key,value:result[key]})}))}}();if("object"===_typeof(_ret))return _ret.v}}if(-1===selectedIdx)if(config.autoselect){var sameValueZero=Util.sameValueZero,curValue=State.getVar(varName),curValueIdx=options.findIndex((function(opt){return sameValueZero(opt.value,curValue)}));selectedIdx=-1===curValueIdx?0:curValueIdx}else selectedIdx=0;if("cycle"===this.name){var lastIdx=options.length-1;if(config.once&&selectedIdx===lastIdx)jQuery(this.output).wikiWithOptions({profile:"core"},options[selectedIdx].label);else{var cycleIdx=selectedIdx;jQuery(document.createElement("a")).wikiWithOptions({profile:"core"},options[selectedIdx].label).attr("id","".concat(this.name,"-").concat(varId)).addClass("macro-".concat(this.name)).ariaClick({namespace:".macros",role:"button"},this.createShadowWrapper((function(){var $this=$(this);cycleIdx=(cycleIdx+1)%options.length,State.setVar(varName,options[cycleIdx].value),$this.empty().wikiWithOptions({profile:"core"},options[cycleIdx].label),config.once&&cycleIdx===lastIdx&&$this.off().contents().unwrap()}))).appendTo(this.output)}}else{var $select=jQuery(document.createElement("select"));options.forEach((function(opt,i){jQuery(document.createElement("option")).val(i).text(opt.label).appendTo($select)})),$select.attr({id:"".concat(this.name,"-").concat(varId),name:"".concat(this.name,"-").concat(varId),tabindex:0}).addClass("macro-".concat(this.name)).val(selectedIdx).on("change.macros",this.createShadowWrapper((function(){State.setVar(varName,options[Number(this.value)].value)}))).appendTo(this.output)}State.setVar(varName,options[selectedIdx].value)}}),Macro.add(["linkappend","linkprepend","linkreplace"],{isAsync:!0,tags:null,t8nRe:/^(?:transition|t8n)$/,handler:function(){var _this17=this;if(0===this.args.length)return this.error("no link text specified");var $link=jQuery(document.createElement("a")),$insert=jQuery(document.createElement("span")),transition=this.args.length>1&&this.self.t8nRe.test(this.args[1]);$link.wikiWithOptions({profile:"core"},this.args[0]).addClass("link-internal macro-".concat(this.name)).ariaClick({namespace:".macros",one:!0},this.createShadowWrapper((function(){if("linkreplace"===_this17.name?$link.remove():$link.wrap('<span class="macro-'.concat(_this17.name,'"></span>')).replaceWith((function(){return $link.html()})),""!==_this17.payload[0].contents){var frag=document.createDocumentFragment();new Wikifier(frag,_this17.payload[0].contents),$insert.append(frag)}transition&&setTimeout((function(){return $insert.removeClass("macro-".concat(_this17.name,"-in"))}),Engine.minDomActionDelay)}))).appendTo(this.output),$insert.addClass("macro-".concat(this.name,"-insert")),transition&&$insert.addClass("macro-".concat(this.name,"-in")),"linkprepend"===this.name?$insert.insertBefore($link):$insert.insertAfter($link)}}),Macro.add(["numberbox","textbox"],{isAsync:!0,handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("variable name"),this.args.length<2&&errors.push("default value"),this.error("no ".concat(errors.join(" or ")," specified"))}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));Config.debug&&this.debugView.modes({block:!0});var asNumber="numberbox"===this.name,defaultValue=asNumber?Number(this.args[1]):this.args[1];if(asNumber&&Number.isNaN(defaultValue))return this.error('default value "'.concat(this.args[1],'" is neither a number nor can it be parsed into a number'));var passage,varId=Util.slugify(varName),el=document.createElement("input"),autofocus=!1;this.args.length>3?(passage=this.args[2],autofocus="autofocus"===this.args[3]):this.args.length>2&&("autofocus"===this.args[2]?autofocus=!0:passage=this.args[2]),"object"===_typeof(passage)&&(passage=passage.link),jQuery(el).attr({id:"".concat(this.name,"-").concat(varId),name:"".concat(this.name,"-").concat(varId),type:asNumber?"number":"text",inputmode:asNumber?"decimal":"text",tabindex:0}).addClass("macro-".concat(this.name)).on("change.macros",this.createShadowWrapper((function(){State.setVar(varName,asNumber?Number(this.value):this.value)}))).on("keypress.macros",this.createShadowWrapper((function(ev){13===ev.which&&(ev.preventDefault(),State.setVar(varName,asNumber?Number(this.value):this.value),null!=passage&&Engine.play(passage))}))).appendTo(this.output),asNumber&&(el.step="any"),State.setVar(varName,defaultValue),el.value=defaultValue,autofocus&&(el.setAttribute("autofocus","autofocus"),postdisplay["#autofocus:".concat(el.id)]=function(task){delete postdisplay[task],setTimeout((function(){return el.focus()}),Engine.minDomActionDelay)})}}),Macro.add("radiobutton",{isAsync:!0,handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("variable name"),this.args.length<2&&errors.push("checked value"),this.error("no ".concat(errors.join(" or ")," specified"))}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));var varId=Util.slugify(varName),checkValue=this.args[1],el=document.createElement("input");switch(TempState.hasOwnProperty(this.name)||(TempState[this.name]={}),TempState[this.name].hasOwnProperty(varId)||(TempState[this.name][varId]=0),jQuery(el).attr({id:"".concat(this.name,"-").concat(varId,"-").concat(TempState[this.name][varId]++),name:"".concat(this.name,"-").concat(varId),type:"radio",tabindex:0}).addClass("macro-".concat(this.name)).on("change.macros",this.createShadowWrapper((function(){this.checked&&State.setVar(varName,checkValue)}))).appendTo(this.output),this.args[2]){case"autocheck":State.getVar(varName)===checkValue&&(el.checked=!0);break;case"checked":el.checked=!0,State.setVar(varName,checkValue)}}}),Macro.add("textarea",{isAsync:!0,handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("variable name"),this.args.length<2&&errors.push("default value"),this.error("no ".concat(errors.join(" or ")," specified"))}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var varName=this.args[0].trim();if("$"!==varName[0]&&"_"!==varName[0])return this.error('variable name "'.concat(this.args[0],'" is missing its sigil ($ or _)'));Config.debug&&this.debugView.modes({block:!0});var varId=Util.slugify(varName),defaultValue=this.args[1],autofocus="autofocus"===this.args[2],el=document.createElement("textarea");jQuery(el).attr({id:"".concat(this.name,"-").concat(varId),name:"".concat(this.name,"-").concat(varId),rows:4,tabindex:0}).addClass("macro-".concat(this.name)).on("change.macros",this.createShadowWrapper((function(){State.setVar(varName,this.value)}))).appendTo(this.output),State.setVar(varName,defaultValue),el.textContent=defaultValue,autofocus&&(el.setAttribute("autofocus","autofocus"),postdisplay["#autofocus:".concat(el.id)]=function(task){delete postdisplay[task],setTimeout((function(){return el.focus()}),Engine.minDomActionDelay)})}}),Macro.add("click","link"),Macro.add("actions",{handler:function(){for(var $list=jQuery(document.createElement("ul")).addClass(this.name).appendTo(this.output),i=0;i<this.args.length;++i){var passage=void 0,text=void 0,$image=void 0,setFn=void 0;if("object"===_typeof(this.args[i])?this.args[i].isImage?($image=jQuery(document.createElement("img")).attr("src",this.args[i].source),this.args[i].hasOwnProperty("passage")&&$image.attr("data-passage",this.args[i].passage),this.args[i].hasOwnProperty("title")&&$image.attr("title",this.args[i].title),this.args[i].hasOwnProperty("align")&&$image.attr("align",this.args[i].align),passage=this.args[i].link,setFn=this.args[i].setFn):(text=this.args[i].text,passage=this.args[i].link,setFn=this.args[i].setFn):text=passage=this.args[i],!(State.variables.hasOwnProperty("#actions")&&State.variables["#actions"].hasOwnProperty(passage)&&State.variables["#actions"][passage])){var $link=jQuery(Wikifier.createInternalLink(jQuery(document.createElement("li")).appendTo($list),passage,null,function(passage,fn){return function(){State.variables.hasOwnProperty("#actions")||(State.variables["#actions"]={}),State.variables["#actions"][passage]=!0,"function"==typeof fn&&fn()}}(passage,setFn))).addClass("macro-".concat(this.name)).append($image||document.createTextNode(text));$image&&$link.addClass("link-image")}}}}),Macro.add(["back","return"],{handler:function(){if(this.args.length>1)return this.error("too many arguments specified, check the documentation for details");var passage,text,$image,$link,momentIndex=-1;if(1===this.args.length&&("object"===_typeof(this.args[0])?this.args[0].isImage?($image=jQuery(document.createElement("img")).attr("src",this.args[0].source),this.args[0].hasOwnProperty("passage")&&$image.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&$image.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&$image.attr("align",this.args[0].align),this.args[0].hasOwnProperty("link")&&(passage=this.args[0].link)):(1===this.args[0].count||(text=this.args[0].text),passage=this.args[0].link):1===this.args.length&&(text=this.args[0])),null==passage){for(var i=State.length-2;i>=0;--i)if(State.history[i].title!==State.passage){momentIndex=i,passage=State.history[i].title;break}if(null==passage&&"return"===this.name)for(var _i6=State.expired.length-1;_i6>=0;--_i6)if(State.expired[_i6]!==State.passage){passage=State.expired[_i6];break}}else{if(!Story.has(passage))return this.error('passage "'.concat(passage,'" does not exist'));if("back"===this.name){for(var _i7=State.length-2;_i7>=0;--_i7)if(State.history[_i7].title===passage){momentIndex=_i7;break}if(-1===momentIndex)return this.error('cannot find passage "'.concat(passage,'" in the current story history'))}}if(null==passage)return this.error("cannot find passage");"back"!==this.name||-1!==momentIndex?($link=jQuery(document.createElement("a")).addClass("link-internal").ariaClick({one:!0},"return"===this.name?function(){return Engine.play(passage)}:function(){return Engine.goTo(momentIndex)}),$image&&$link.addClass("link-image")):$link=jQuery(document.createElement("span")).addClass("link-disabled"),$link.addClass("macro-".concat(this.name)).append($image||document.createTextNode(text||L10n.get("macro".concat(this.name.toUpperFirst(),"Text")))).appendTo(this.output)}}),Macro.add("choice",{handler:function(){if(0===this.args.length)return this.error("no passage specified");var passage,text,$image,setFn,$link,choiceId=State.passage;if(1===this.args.length?"object"===_typeof(this.args[0])?this.args[0].isImage?($image=jQuery(document.createElement("img")).attr("src",this.args[0].source),this.args[0].hasOwnProperty("passage")&&$image.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&$image.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&$image.attr("align",this.args[0].align),passage=this.args[0].link,setFn=this.args[0].setFn):(text=this.args[0].text,passage=this.args[0].link,setFn=this.args[0].setFn):text=passage=this.args[0]:(passage=this.args[0],text=this.args[1]),State.variables.hasOwnProperty("#choice")&&State.variables["#choice"].hasOwnProperty(choiceId)&&State.variables["#choice"][choiceId])return $link=jQuery(document.createElement("span")).addClass("link-disabled macro-".concat(this.name)).attr("tabindex",-1).append($image||document.createTextNode(text)).appendTo(this.output),void($image&&$link.addClass("link-image"));$link=jQuery(Wikifier.createInternalLink(this.output,passage,null,(function(){State.variables.hasOwnProperty("#choice")||(State.variables["#choice"]={}),State.variables["#choice"][choiceId]=!0,"function"==typeof setFn&&setFn()}))).addClass("macro-".concat(this.name)).append($image||document.createTextNode(text)),$image&&$link.addClass("link-image")}}),Macro.add(["addclass","toggleclass"],{handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("selector"),this.args.length<2&&errors.push("class names"),this.error("no ".concat(errors.join(" or ")," specified"))}var $targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));switch(this.name){case"addclass":$targets.addClass(this.args[1].trim());break;case"toggleclass":$targets.toggleClass(this.args[1].trim())}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("removeclass",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var $targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));this.args.length>1?$targets.removeClass(this.args[1].trim()):$targets.removeClass(),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("copy",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var $targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));jQuery(this.output).append($targets.html()),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add(["append","prepend","replace"],{tags:null,t8nRe:/^(?:transition|t8n)$/,handler:function(){var _this18=this;if(0===this.args.length)return this.error("no selector specified");var $insert,$targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));if(""!==this.payload[0].contents)switch(this.args.length>1&&this.self.t8nRe.test(this.args[1])?(($insert=jQuery(document.createElement("span"))).addClass("macro-".concat(this.name,"-insert macro-").concat(this.name,"-in")),setTimeout((function(){return $insert.removeClass("macro-".concat(_this18.name,"-in"))}),Engine.minDomActionDelay)):$insert=jQuery(document.createDocumentFragment()),$insert.wiki(this.payload[0].contents),this.name){case"replace":$targets.empty();case"append":$targets.append($insert);break;case"prepend":$targets.prepend($insert)}else"replace"===this.name&&$targets.empty();Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("remove",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var $targets=jQuery(this.args[0]);if(0===$targets.length)return this.error('no elements matched the selector "'.concat(this.args[0],'"'));$targets.remove(),Config.debug&&this.debugView.modes({hidden:!0})}}),Has.audio){var errorOnePlaybackAction=function(cur,prev){return'only one playback action allowed per invocation, "'.concat(cur,'" cannot be combined with "').concat(prev,'"')};Macro.add("audio",{handler:function(){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("track and/or group IDs"),this.args.length<2&&errors.push("actions"),this.error("no ".concat(errors.join(" or ")," specified"))}var selected;try{selected=SimpleAudio.select(this.args[0])}catch(ex){return this.error(ex.message)}for(var action,fadeTo,loop,mute,passage,time,volume,args=this.args.slice(1),fadeOver=5;args.length>0;){var arg=args.shift(),raw=void 0;switch(arg){case"load":case"pause":case"play":case"stop":case"unload":if(action)return this.error(errorOnePlaybackAction(arg,action));action=arg;break;case"fadein":if(action)return this.error(errorOnePlaybackAction(arg,action));action="fade",fadeTo=1;break;case"fadeout":if(action)return this.error(errorOnePlaybackAction(arg,action));action="fade",fadeTo=0;break;case"fadeto":if(action)return this.error(errorOnePlaybackAction(arg,action));if(0===args.length)return this.error("fadeto missing required level value");if(action="fade",raw=args.shift(),fadeTo=Number.parseFloat(raw),Number.isNaN(fadeTo)||!Number.isFinite(fadeTo))return this.error("cannot parse fadeto: ".concat(raw));break;case"fadeoverto":if(action)return this.error(errorOnePlaybackAction(arg,action));if(args.length<2){var _errors=[];return args.length<1&&_errors.push("seconds"),args.length<2&&_errors.push("level"),this.error("fadeoverto missing required ".concat(_errors.join(" and ")," value").concat(_errors.length>1?"s":""))}if(action="fade",raw=args.shift(),fadeOver=Number.parseFloat(raw),Number.isNaN(fadeOver)||!Number.isFinite(fadeOver))return this.error("cannot parse fadeoverto: ".concat(raw));if(raw=args.shift(),fadeTo=Number.parseFloat(raw),Number.isNaN(fadeTo)||!Number.isFinite(fadeTo))return this.error("cannot parse fadeoverto: ".concat(raw));break;case"volume":if(0===args.length)return this.error("volume missing required level value");if(raw=args.shift(),volume=Number.parseFloat(raw),Number.isNaN(volume)||!Number.isFinite(volume))return this.error("cannot parse volume: ".concat(raw));break;case"mute":case"unmute":mute="mute"===arg;break;case"time":if(0===args.length)return this.error("time missing required seconds value");if(raw=args.shift(),time=Number.parseFloat(raw),Number.isNaN(time)||!Number.isFinite(time))return this.error("cannot parse time: ".concat(raw));break;case"loop":case"unloop":loop="loop"===arg;break;case"goto":if(0===args.length)return this.error("goto missing required passage title");if(raw=args.shift(),passage="object"===_typeof(raw)?raw.link:raw,!Story.has(passage))return this.error('passage "'.concat(passage,'" does not exist'));break;default:return this.error("unknown action: ".concat(arg))}}try{if(null!=volume&&selected.volume(volume),null!=time&&selected.time(time),null!=mute&&selected.mute(mute),null!=loop&&selected.loop(loop),null!=passage){var nsEnded="ended.macros.macro-".concat(this.name,"_goto");selected.off(nsEnded).one(nsEnded,(function(){selected.off(nsEnded),Engine.play(passage)}))}switch(action){case"fade":selected.fade(fadeOver,fadeTo);break;case"load":selected.load();break;case"pause":selected.pause();break;case"play":selected.playWhenAllowed();break;case"stop":selected.stop();break;case"unload":selected.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(ex){return this.error("error executing action: ".concat(ex.message))}}}),Macro.add("cacheaudio",{handler:function(){var _this19=this;if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("track ID"),this.args.length<2&&errors.push("sources"),this.error("no ".concat(errors.join(" or ")," specified"))}var id=String(this.args[0]).trim(),oldFmtRe=/^format:\s*([\w-]+)\s*;\s*/i;try{SimpleAudio.tracks.add(id,this.args.slice(1).map((function(source){if(oldFmtRe.test(source)){if(Config.debug)return _this19.error('track ID "'.concat(id,'": format specifier migration required, "format:formatId;" → "formatId|"'));source=source.replace(oldFmtRe,"$1|")}return source})))}catch(ex){return this.error(ex.message)}if(Config.debug&&!SimpleAudio.tracks.get(id).hasSource())return this.error('track ID "'.concat(id,'": no supported audio sources found'));Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("createaudiogroup",{tags:["track"],handler:function(){if(0===this.args.length)return this.error("no group ID specified");if(1===this.payload.length)return this.error("no tracks defined via <<track>>");Config.debug&&this.debugView.modes({nonvoid:!1,hidden:!0});for(var groupId=String(this.args[0]).trim(),trackIds=[],i=1,len=this.payload.length;i<len;++i){if(this.payload[i].args.length<1)return this.error("no track ID specified");trackIds.push(String(this.payload[i].args[0]).trim()),Config.debug&&this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1,hidden:!0})}try{SimpleAudio.groups.add(groupId,trackIds)}catch(ex){return this.error(ex.message)}Config.debug&&this.createDebugView("/".concat(this.name),"<</".concat(this.name,">>")).modes({nonvoid:!1,hidden:!0})}}),Macro.add("createplaylist",{tags:["track"],handler:function(){if(0===this.args.length)return this.error("no list ID specified");if(1===this.payload.length)return this.error("no tracks defined via <<track>>");var playlist=Macro.get("playlist");if(null!==playlist.from&&"createplaylist"!==playlist.from)return this.error("a playlist has already been defined with <<setplaylist>>");Config.debug&&this.debugView.modes({nonvoid:!1,hidden:!0});for(var listId=String(this.args[0]).trim(),trackObjs=[],i=1,len=this.payload.length;i<len;++i){if(0===this.payload[i].args.length)return this.error("no track ID specified");for(var trackObj={id:String(this.payload[i].args[0]).trim()},args=this.payload[i].args.slice(1);args.length>0;){var arg=args.shift(),raw=void 0,parsed=void 0;switch(arg){case"copy":case"own":trackObj.own=!0;break;case"rate":args.length>0&&args.shift();break;case"volume":if(0===args.length)return this.error("volume missing required level value");if(raw=args.shift(),parsed=Number.parseFloat(raw),Number.isNaN(parsed)||!Number.isFinite(parsed))return this.error("cannot parse volume: ".concat(raw));trackObj.volume=parsed;break;default:return this.error("unknown action: ".concat(arg))}}trackObjs.push(trackObj),Config.debug&&this.createDebugView(this.payload[i].name,this.payload[i].source).modes({nonvoid:!1,hidden:!0})}try{SimpleAudio.lists.add(listId,trackObjs)}catch(ex){return this.error(ex.message)}null===playlist.from&&(playlist.from="createplaylist"),Config.debug&&this.createDebugView("/".concat(this.name),"<</".concat(this.name,">>")).modes({nonvoid:!1,hidden:!0})}}),Macro.add("masteraudio",{handler:function(){if(0===this.args.length)return this.error("no actions specified");for(var action,mute,muteOnHide,volume,args=this.args.slice(0);args.length>0;){var arg=args.shift(),raw=void 0;switch(arg){case"load":case"stop":case"unload":if(action)return this.error(errorOnePlaybackAction(arg,action));action=arg;break;case"mute":case"unmute":mute="mute"===arg;break;case"muteonhide":case"nomuteonhide":muteOnHide="muteonhide"===arg;break;case"volume":if(0===args.length)return this.error("volume missing required level value");if(raw=args.shift(),volume=Number.parseFloat(raw),Number.isNaN(volume)||!Number.isFinite(volume))return this.error("cannot parse volume: ".concat(raw));break;default:return this.error("unknown action: ".concat(arg))}}try{switch(null!=mute&&SimpleAudio.mute(mute),null!=muteOnHide&&SimpleAudio.muteOnHidden(muteOnHide),null!=volume&&SimpleAudio.volume(volume),action){case"load":SimpleAudio.load();break;case"stop":SimpleAudio.stop();break;case"unload":SimpleAudio.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(ex){return this.error("error executing action: ".concat(ex.message))}}}),Macro.add("playlist",{from:null,handler:function(){var list,args,action,from=this.self.from;if(null===from)return this.error("no playlists have been created");if("createplaylist"===from){if(this.args.length<2){var errors=[];return this.args.length<1&&errors.push("list ID"),this.args.length<2&&errors.push("actions"),this.error("no ".concat(errors.join(" or ")," specified"))}var id=String(this.args[0]).trim();if(!SimpleAudio.lists.has(id))return this.error('playlist "'.concat(id,'" does not exist'));list=SimpleAudio.lists.get(id),args=this.args.slice(1)}else{if(0===this.args.length)return this.error("no actions specified");list=SimpleAudio.lists.get("setplaylist"),args=this.args.slice(0)}for(var fadeTo,loop,mute,shuffle,volume,fadeOver=5;args.length>0;){var arg=args.shift(),raw=void 0;switch(arg){case"load":case"pause":case"play":case"skip":case"stop":case"unload":if(action)return this.error(errorOnePlaybackAction(arg,action));action=arg;break;case"fadein":if(action)return this.error(errorOnePlaybackAction(arg,action));action="fade",fadeTo=1;break;case"fadeout":if(action)return this.error(errorOnePlaybackAction(arg,action));action="fade",fadeTo=0;break;case"fadeto":if(action)return this.error(errorOnePlaybackAction(arg,action));if(0===args.length)return this.error("fadeto missing required level value");if(action="fade",raw=args.shift(),fadeTo=Number.parseFloat(raw),Number.isNaN(fadeTo)||!Number.isFinite(fadeTo))return this.error("cannot parse fadeto: ".concat(raw));break;case"fadeoverto":if(action)return this.error(errorOnePlaybackAction(arg,action));if(args.length<2){var _errors2=[];return args.length<1&&_errors2.push("seconds"),args.length<2&&_errors2.push("level"),this.error("fadeoverto missing required ".concat(_errors2.join(" and ")," value").concat(_errors2.length>1?"s":""))}if(action="fade",raw=args.shift(),fadeOver=Number.parseFloat(raw),Number.isNaN(fadeOver)||!Number.isFinite(fadeOver))return this.error("cannot parse fadeoverto: ".concat(raw));if(raw=args.shift(),fadeTo=Number.parseFloat(raw),Number.isNaN(fadeTo)||!Number.isFinite(fadeTo))return this.error("cannot parse fadeoverto: ".concat(raw));break;case"volume":if(0===args.length)return this.error("volume missing required level value");if(raw=args.shift(),volume=Number.parseFloat(raw),Number.isNaN(volume)||!Number.isFinite(volume))return this.error("cannot parse volume: ".concat(raw));break;case"mute":case"unmute":mute="mute"===arg;break;case"loop":case"unloop":loop="loop"===arg;break;case"shuffle":case"unshuffle":shuffle="shuffle"===arg;break;default:return this.error("unknown action: ".concat(arg))}}try{switch(null!=volume&&list.volume(volume),null!=mute&&list.mute(mute),null!=loop&&list.loop(loop),null!=shuffle&&list.shuffle(shuffle),action){case"fade":list.fade(fadeOver,fadeTo);break;case"load":list.load();break;case"pause":list.pause();break;case"play":list.playWhenAllowed();break;case"skip":list.skip();break;case"stop":list.stop();break;case"unload":list.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(ex){return this.error("error executing action: ".concat(ex.message))}}}),Macro.add("removeaudiogroup",{handler:function(){if(0===this.args.length)return this.error("no group ID specified");var id=String(this.args[0]).trim();if(!SimpleAudio.groups.has(id))return this.error('group "'.concat(id,'" does not exist'));SimpleAudio.groups.delete(id),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("removeplaylist",{handler:function(){if(0===this.args.length)return this.error("no list ID specified");var id=String(this.args[0]).trim();if(!SimpleAudio.lists.has(id))return this.error('playlist "'.concat(id,'" does not exist'));SimpleAudio.lists.delete(id),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("waitforaudio",{skipArgs:!0,handler:function(){SimpleAudio.loadWithScreen()}}),Macro.add("setplaylist",{handler:function(){if(0===this.args.length)return this.error("no track ID(s) specified");var playlist=Macro.get("playlist");if(null!==playlist.from&&"setplaylist"!==playlist.from)return this.error("playlists have already been defined with <<createplaylist>>");try{SimpleAudio.lists.add("setplaylist",this.args.slice(0))}catch(ex){return this.error(ex.message)}null===playlist.from&&(playlist.from="setplaylist"),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("stopallaudio",{skipArgs:!0,handler:function(){SimpleAudio.select(":all").stop(),Config.debug&&this.debugView.modes({hidden:!0})}})}else Macro.add(["audio","cacheaudio","createaudiogroup","createplaylist","masteraudio","playlist","removeaudiogroup","removeplaylist","waitforaudio","setplaylist","stopallaudio"],{skipArgs:!0,handler:function(){Config.debug&&this.debugView.modes({hidden:!0})}});Macro.add("done",{skipArgs:!0,tags:null,handler:function(){var contents=this.payload[0].contents.trim();""!==contents&&setTimeout(this.createShadowWrapper((function(){return $.wiki(contents)})),Engine.minDomActionDelay)}}),Macro.add("goto",{handler:function(){return 0===this.args.length?this.error("no passage specified"):(passage="object"===_typeof(this.args[0])?this.args[0].link:this.args[0],Story.has(passage)?void setTimeout((function(){return Engine.play(passage)}),Engine.minDomActionDelay):this.error('passage "'.concat(passage,'" does not exist')));var passage}}),Macro.add("repeat",{isAsync:!0,tags:null,timers:new Set,t8nRe:/^(?:transition|t8n)$/,handler:function(){var delay,_this20=this;if(0===this.args.length)return this.error("no time value specified");try{delay=Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.args[0]))}catch(ex){return this.error(ex.message)}Config.debug&&this.debugView.modes({block:!0});var transition=this.args.length>1&&this.self.t8nRe.test(this.args[1]),$wrapper=jQuery(document.createElement("span")).addClass("macro-".concat(this.name)).appendTo(this.output);this.self.registerInterval(this.createShadowWrapper((function(){var frag=document.createDocumentFragment();new Wikifier(frag,_this20.payload[0].contents);var $output=$wrapper;transition&&($output=jQuery(document.createElement("span")).addClass("macro-repeat-insert macro-repeat-in").appendTo($output)),$output.append(frag),transition&&setTimeout((function(){return $output.removeClass("macro-repeat-in")}),Engine.minDomActionDelay)})),delay)},registerInterval:function(callback,delay){var _this21=this;if("function"!=typeof callback)throw new TypeError("callback parameter must be a function");var passage=State.passage,turn=State.turns,timers=this.timers,timerId=null;timerId=setInterval((function(){if(State.passage!==passage||State.turns!==turn)return clearInterval(timerId),void timers.delete(timerId);var timerIdCache;try{TempState.break=null,TempState.hasOwnProperty("repeatTimerId")&&(timerIdCache=TempState.repeatTimerId),TempState.repeatTimerId=timerId,callback.call(_this21)}finally{void 0!==timerIdCache?TempState.repeatTimerId=timerIdCache:delete TempState.repeatTimerId,TempState.break=null}}),delay),timers.add(timerId),prehistory.hasOwnProperty("#repeat-timers-cleanup")||(prehistory["#repeat-timers-cleanup"]=function(task){delete prehistory[task],timers.forEach((function(timerId){return clearInterval(timerId)})),timers.clear()})}}),Macro.add("stop",{skipArgs:!0,handler:function(){if(!TempState.hasOwnProperty("repeatTimerId"))return this.error("must only be used in conjunction with its parent macro <<repeat>>");var timers=Macro.get("repeat").timers,timerId=TempState.repeatTimerId;clearInterval(timerId),timers.delete(timerId),TempState.break=2,Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("timed",{isAsync:!0,tags:["next"],timers:new Set,t8nRe:/^(?:transition|t8n)$/,handler:function(){if(0===this.args.length)return this.error("no time value specified in <<timed>>");var i,items=[];try{items.push({name:this.name,source:this.source,delay:Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.args[0])),content:this.payload[0].contents})}catch(ex){return this.error("".concat(ex.message," in <<timed>>"))}if(this.payload.length>1)try{var len;for(i=1,len=this.payload.length;i<len;++i)items.push({name:this.payload[i].name,source:this.payload[i].source,delay:0===this.payload[i].args.length?items[items.length-1].delay:Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.payload[i].args[0])),content:this.payload[i].contents})}catch(ex){return this.error("".concat(ex.message," in <<next>> (#").concat(i,")"))}Config.debug&&this.debugView.modes({block:!0});var transition=this.args.length>1&&this.self.t8nRe.test(this.args[1]),$wrapper=jQuery(document.createElement("span")).addClass("macro-".concat(this.name)).appendTo(this.output);this.self.registerTimeout(this.createShadowWrapper((function(item){var frag=document.createDocumentFragment();new Wikifier(frag,item.content);var $output=$wrapper;Config.debug&&"next"===item.name&&($output=jQuery(new DebugView($output[0],"macro",item.name,item.source).output)),transition&&($output=jQuery(document.createElement("span")).addClass("macro-timed-insert macro-timed-in").appendTo($output)),$output.append(frag),transition&&setTimeout((function(){return $output.removeClass("macro-timed-in")}),Engine.minDomActionDelay)})),items)},registerTimeout:function(callback,items){if("function"!=typeof callback)throw new TypeError("callback parameter must be a function");var passage=State.passage,turn=State.turns,timers=this.timers,timerId=null,nextItem=items.shift();timerId=setTimeout((function worker(){if(timers.delete(timerId),State.passage===passage&&State.turns===turn){var curItem=nextItem;null!=(nextItem=items.shift())&&(timerId=setTimeout(worker,nextItem.delay),timers.add(timerId)),callback.call(this,curItem)}}),nextItem.delay),timers.add(timerId),prehistory.hasOwnProperty("#timed-timers-cleanup")||(prehistory["#timed-timers-cleanup"]=function(task){delete prehistory[task],timers.forEach((function(timerId){return clearTimeout(timerId)})),timers.clear()})}}),Macro.add("widget",{tags:null,handler:function(){if(0===this.args.length)return this.error("no widget name specified");var widgetCode,widgetName=this.args[0],isNonVoid=this.args.length>1&&"container"===this.args[1];if(Macro.has(widgetName)){if(!Macro.get(widgetName).isWidget)return this.error('cannot clobber existing macro "'.concat(widgetName,'"'));Macro.delete(widgetName)}try{var widgetDef={isWidget:!0,handler:(widgetCode=this.payload[0].contents,function(){var shadowStore={};State.temporary.hasOwnProperty("args")&&(shadowStore._args=State.temporary.args),State.temporary.args=_toConsumableArray(this.args),State.temporary.args.raw=this.args.raw,State.temporary.args.full=this.args.full,this.addShadow("_args"),isNonVoid&&(State.temporary.hasOwnProperty("contents")&&(shadowStore._contents=State.temporary.contents),State.temporary.contents=this.payload[0].contents,this.addShadow("_contents")),State.variables.hasOwnProperty("args")&&(shadowStore.$args=State.variables.args),State.variables.args=State.temporary.args,this.addShadow("$args");try{var resFrag=document.createDocumentFragment(),errList=[];if(new Wikifier(resFrag,widgetCode),Array.from(resFrag.querySelectorAll(".error")).forEach((function(errEl){errList.push(errEl.textContent)})),0!==errList.length)return this.error("error".concat(errList.length>1?"s":""," within widget code (").concat(errList.join("; "),")"));this.output.appendChild(resFrag)}catch(ex){return this.error("cannot execute widget: ".concat(ex.message))}finally{shadowStore.hasOwnProperty("_args")?State.temporary.args=shadowStore._args:delete State.temporary.args,isNonVoid&&(shadowStore.hasOwnProperty("_contents")?State.temporary.contents=shadowStore._contents:delete State.temporary.contents),shadowStore.hasOwnProperty("$args")?State.variables.args=shadowStore.$args:delete State.variables.args}})};isNonVoid&&(widgetDef.tags=[]),Macro.add(widgetName,widgetDef),Config.debug&&this.debugView.modes({hidden:!0})}catch(ex){return this.error('cannot create widget macro "'.concat(widgetName,'": ').concat(ex.message))}}})}();var Dialog=function(){var _$overlay=null,_$dialog=null,_$dialogTitle=null,_$dialogBody=null,_lastActive=null,_scrollbarWidth=0,_dialogObserver=null;function dialogClose(ev){return _$dialogBody.trigger(":dialogclosing"),jQuery(document).off(".dialog-close"),_dialogObserver?(_dialogObserver.disconnect(),_dialogObserver=null):_$dialogBody.off(".dialog-resize"),jQuery(window).off(".dialog-resize"),_$dialog.removeClass("open").css({left:"",right:"",top:"",bottom:""}),jQuery("#ui-bar,#story").find("[tabindex=-2]").removeAttr("aria-hidden").attr("tabindex",0),jQuery("body>[tabindex=-3]").removeAttr("aria-hidden").removeAttr("tabindex"),_$overlay.removeClass("open"),jQuery(document.documentElement).removeAttr("data-dialog"),_$dialogTitle.empty(),_$dialogBody.empty().removeClass(),null!==_lastActive&&(jQuery(_lastActive).focus(),_lastActive=null),ev&&ev.data&&"function"==typeof ev.data.closeFn&&ev.data.closeFn(ev),_$dialogBody.trigger(":dialogclose"),_$dialogBody.trigger(":dialogclosed"),Dialog}function dialogIsOpen(classNames){return _$dialog.hasClass("open")&&(!classNames||classNames.splitOrEmpty(/\s+/).every((function(cn){return _$dialogBody.hasClass(cn)})))}function dialogOpen(options,closeFn){_$dialogBody.trigger(":dialogopening");var top=jQuery.extend({top:50},options).top;return dialogIsOpen()||(_lastActive=safeActiveElement()),jQuery(document.documentElement).attr("data-dialog","open"),_$overlay.addClass("open"),null!==_$dialogBody[0].querySelector("img")&&_$dialogBody.imagesLoaded().always((function(){return _resizeHandler({data:{top:top}})})),jQuery("body>:not(script,#store-area,tw-storydata,#ui-bar,#ui-overlay,#ui-dialog)").attr("tabindex",-3).attr("aria-hidden",!0),jQuery("#ui-bar,#story").find("[tabindex]:not([tabindex^=-])").attr("tabindex",-2).attr("aria-hidden",!0),_$dialog.css(_calcPosition(top)).addClass("open").focus(),jQuery(window).on("resize.dialog-resize",null,{top:top},jQuery.throttle(40,_resizeHandler)),Has.mutationObserver?(_dialogObserver=new MutationObserver((function(mutations){for(var i=0;i<mutations.length;++i)if("childList"===mutations[i].type){_resizeHandler({data:{top:top}});break}}))).observe(_$dialogBody[0],{childList:!0,subtree:!0}):_$dialogBody.on("DOMNodeInserted.dialog-resize DOMNodeRemoved.dialog-resize",null,{top:top},jQuery.throttle(40,_resizeHandler)),jQuery(document).one("click.dialog-close",".ui-close",{closeFn:closeFn},(function(ev){dialogClose(ev)})).one("keypress.dialog-close",".ui-close",(function(ev){13!==ev.which&&32!==ev.which||jQuery(this).trigger("click")})),_$dialogBody.trigger(":dialogopen"),_$dialogBody.trigger(":dialogopened"),Dialog}function _calcPosition(topPos){var top=null!=topPos?topPos:50,$parent=jQuery(window),dialogPos={left:"",right:"",top:"",bottom:""};_$dialog.css(dialogPos);var horzSpace=$parent.width()-_$dialog.outerWidth(!0)-1,vertSpace=$parent.height()-_$dialog.outerHeight(!0)-1;return horzSpace<=32+_scrollbarWidth&&(vertSpace-=_scrollbarWidth),vertSpace<=32+_scrollbarWidth&&(horzSpace-=_scrollbarWidth),dialogPos.left=dialogPos.right=horzSpace<=32?16:horzSpace/2>>0,dialogPos.top=vertSpace<=32?dialogPos.bottom=16:vertSpace/2>top?top:dialogPos.bottom=vertSpace/2>>0,Object.keys(dialogPos).forEach((function(key){""!==dialogPos[key]&&(dialogPos[key]+="px")})),dialogPos}function _resizeHandler(ev){var top=ev&&ev.data&&void 0!==ev.data.top?ev.data.top:50;"block"===_$dialog.css("display")&&(_$dialog.css({display:"none"}),_$dialog.css(jQuery.extend({display:""},_calcPosition(top))))}return Object.freeze(Object.defineProperties({},{append:{value:function(){var _$dialogBody2;return(_$dialogBody2=_$dialogBody).append.apply(_$dialogBody2,arguments),Dialog}},body:{value:function(){return _$dialogBody.get(0)}},close:{value:dialogClose},init:{value:function(){if(!document.getElementById("ui-dialog")){_scrollbarWidth=function(){var scrollbarWidth;try{var inner=document.createElement("p"),outer=document.createElement("div");inner.style.width="100%",inner.style.height="200px",outer.style.position="absolute",outer.style.left="0px",outer.style.top="0px",outer.style.width="100px",outer.style.height="100px",outer.style.visibility="hidden",outer.style.overflow="hidden",outer.appendChild(inner),document.body.appendChild(outer);var w1=inner.offsetWidth;outer.style.overflow="auto";var w2=inner.offsetWidth;w1===w2&&(w2=outer.clientWidth),document.body.removeChild(outer),scrollbarWidth=w1-w2}catch(ex){}return scrollbarWidth||17}();var $elems=jQuery(document.createDocumentFragment()).append('<div id="ui-overlay" class="ui-close"></div><div id="ui-dialog" tabindex="0" role="dialog" aria-labelledby="ui-dialog-title"><div id="ui-dialog-titlebar"><h1 id="ui-dialog-title"></h1>'+'<button id="ui-dialog-close" class="ui-close" tabindex="0" aria-label="'.concat(L10n.get("close"),'"></button>')+'</div><div id="ui-dialog-body"></div></div>');_$overlay=jQuery($elems.find("#ui-overlay").get(0)),_$dialog=jQuery($elems.find("#ui-dialog").get(0)),_$dialogTitle=jQuery($elems.find("#ui-dialog-title").get(0)),_$dialogBody=jQuery($elems.find("#ui-dialog-body").get(0)),$elems.insertBefore("body>script#script-sugarcube")}}},isOpen:{value:dialogIsOpen},open:{value:dialogOpen},resize:{value:function(data){return _resizeHandler("object"===_typeof(data)?{data:data}:undefined)}},setup:{value:function(title,classNames){return _$dialogBody.empty().removeClass(),null!=classNames&&_$dialogBody.addClass(classNames),_$dialogTitle.empty().append((null!=title?String(title):"")||" "),_$dialogBody.get(0)}},wiki:{value:function(){var _$dialogBody3;return(_$dialogBody3=_$dialogBody).wiki.apply(_$dialogBody3,arguments),Dialog}},addClickHandler:{value:function(targets,options,startFn,doneFn,closeFn){return jQuery(targets).ariaClick((function(ev){ev.preventDefault(),"function"==typeof startFn&&startFn(ev),dialogOpen(options,closeFn),"function"==typeof doneFn&&doneFn(ev)}))}}}))}(),Engine=function(){var States=Util.toEnum({Idle:"idle",Playing:"playing",Rendering:"rendering"}),_initDebugViews=[],_state=States.Idle,_lastPlay=null,_outlinePatch=null,_updating=null;function engineGo(offset){var succeded=State.go(offset);return succeded&&engineShow(),succeded}function engineShow(){return enginePlay(State.passage,!0)}function enginePlay(title,noHistory){var passageReadyOutput,passageDoneOutput,passageTitle=title;if(_state=States.Playing,TempState={},State.clearTemporary(),"function"==typeof Config.navigation.override)try{var overrideTitle=Config.navigation.override(passageTitle);overrideTitle&&(passageTitle=overrideTitle)}catch(ex){}var passage=Story.get(passageTitle);if(jQuery.event.trigger({type:":passageinit",passage:passage}),Object.keys(prehistory).forEach((function(task){"function"==typeof prehistory[task]&&prehistory[task].call(passage,task)})),noHistory||State.create(passage.title),document.body.className&&(document.body.className=""),_lastPlay=Util.now(),Object.keys(predisplay).forEach((function(task){"function"==typeof predisplay[task]&&predisplay[task].call(passage,task)})),Story.has("PassageReady"))try{passageReadyOutput=Wikifier.wikifyEval(Story.get("PassageReady").text)}catch(ex){console.error(ex),Alert.error("PassageReady",ex.message)}_state=States.Rendering;var dataTags=passage.tags.length>0?passage.tags.join(" "):null,passageEl=document.createElement("div");jQuery(passageEl).attr({id:passage.domId,"data-passage":passage.title,"data-tags":dataTags}).addClass("passage ".concat(passage.className)),jQuery(document.body).attr("data-tags",dataTags).addClass(passage.className),jQuery(document.documentElement).attr("data-tags",dataTags),jQuery.event.trigger({type:":passagestart",content:passageEl,passage:passage}),Object.keys(prerender).forEach((function(task){"function"==typeof prerender[task]&&prerender[task].call(passage,passageEl,task)})),Story.has("PassageHeader")&&new Wikifier(passageEl,Story.get("PassageHeader").processText()),passageEl.appendChild(passage.render()),Story.has("PassageFooter")&&new Wikifier(passageEl,Story.get("PassageFooter").processText()),jQuery.event.trigger({type:":passagerender",content:passageEl,passage:passage}),Object.keys(postrender).forEach((function(task){"function"==typeof postrender[task]&&postrender[task].call(passage,passageEl,task)}));var debugView,containerEl=document.getElementById("passages");if(containerEl.hasChildNodes()&&("number"==typeof Config.passages.transitionOut||"string"==typeof Config.passages.transitionOut&&""!==Config.passages.transitionOut&&Has.transitionEndEvent?_toConsumableArray(containerEl.childNodes).forEach((function(outgoing){var $outgoing=jQuery(outgoing);if(outgoing.nodeType===Node.ELEMENT_NODE&&$outgoing.hasClass("passage")){if($outgoing.hasClass("passage-out"))return;$outgoing.attr({id:"out-".concat($outgoing.attr("id")),"aria-live":"off"}).addClass("passage-out"),"string"==typeof Config.passages.transitionOut?$outgoing.on(Has.transitionEndEvent,(function(ev){ev.propertyName===Config.passages.transitionOut&&$outgoing.remove()})):setTimeout((function(){return $outgoing.remove()}),Math.max(40,Config.passages.transitionOut))}else $outgoing.remove()})):jQuery(containerEl).empty()),jQuery(passageEl).addClass("passage-in").appendTo(containerEl),setTimeout((function(){return jQuery(passageEl).removeClass("passage-in")}),40),Story.has("StoryDisplayTitle")?null===_updating&&Config.ui.updateStoryElements||setDisplayTitle(Story.get("StoryDisplayTitle").processText()):Config.passages.displayTitles&&passage.title!==Config.passages.start&&(document.title="".concat(passage.title," | ").concat(Story.title)),window.scroll(0,0),_state=States.Playing,Story.has("PassageDone"))try{passageDoneOutput=Wikifier.wikifyEval(Story.get("PassageDone").text)}catch(ex){console.error(ex),Alert.error("PassageDone",ex.message)}(jQuery.event.trigger({type:":passagedisplay",content:passageEl,passage:passage}),Object.keys(postdisplay).forEach((function(task){"function"==typeof postdisplay[task]&&postdisplay[task].call(passage,task)})),null!==_updating?_updating.forEach((function(pair){jQuery(pair.element).empty(),new Wikifier(pair.element,Story.get(pair.passage).processText().trim())})):Config.ui.updateStoryElements&&UIBar.update(),Config.debug)&&(null!=passageReadyOutput&&((debugView=new DebugView(document.createDocumentFragment(),"special","PassageReady","PassageReady")).modes({hidden:!0}),debugView.append(passageReadyOutput),jQuery(passageEl).prepend(debugView.output)),null!=passageDoneOutput&&((debugView=new DebugView(document.createDocumentFragment(),"special","PassageDone","PassageDone")).modes({hidden:!0}),debugView.append(passageDoneOutput),jQuery(passageEl).append(debugView.output)),1===State.turns&&_initDebugViews.length>0&&jQuery(passageEl).prepend(_initDebugViews));switch(jQuery("#story").find("a[href]:not(.link-external)").addClass("link-external").end().find("a,link,button,input,select,textarea").not("[tabindex]").attr("tabindex",0),_typeof(Config.saves.autosave)){case"boolean":Config.saves.autosave&&Save.autosave.save();break;case"object":passage.tags.some((function(tag){return Config.saves.autosave.includes(tag)}))&&Save.autosave.save();break;case"function":Config.saves.autosave()&&Save.autosave.save()}return jQuery.event.trigger({type:":passageend",content:passageEl,passage:passage}),_state=States.Idle,_lastPlay=Util.now(),passageEl}function _hideOutlines(){_outlinePatch.set("*:focus{outline:none;}")}return Object.freeze(Object.defineProperties({},{States:{value:States},minDomActionDelay:{value:40},init:{value:function(){var _lastOutlineEvent;jQuery("#init-no-js,#init-lacking").remove(),function(){var $elems=jQuery(document.createDocumentFragment()),markup=Story.has("StoryInterface")&&Story.get("StoryInterface").text.trim();if(markup){UIBar.destroy(),jQuery(document.head).find("#style-core-display").remove(),$elems.append(markup);var $passages=$elems.find("#passages");if(0===$passages.length)throw new Error('no element with ID "passages" found within "StoryInterface" special passage');$passages.empty().not("[aria-live]").attr("aria-live","polite").end(),$elems.find("[data-init-passage]").each((function(i,el){if("passages"===el.id)throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' id="passages"> must not contain a "data-init-passage" content attribute'));var passage=el.getAttribute("data-init-passage").trim();if(el.hasAttribute("data-passage"))throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' data-init-passage="').concat(passage,'"> must not contain a "data-passage" content attribute'));if(null!==el.firstElementChild)throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' data-init-passage="').concat(passage,'"> contains child elements'));Story.has(passage)&&jQuery(el).empty().wiki(Story.get(passage).processText().trim())}));var updating=[];$elems.find("[data-passage]").each((function(i,el){if("passages"===el.id)throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' id="passages"> must not contain a "data-passage" content attribute'));var passage=el.getAttribute("data-passage").trim();if(null!==el.firstElementChild)throw new Error('"StoryInterface" element <'.concat(el.nodeName.toLowerCase(),' data-passage="').concat(passage,'"> contains child elements'));Story.has(passage)&&updating.push({passage:passage,element:el})})),updating.length>0&&(_updating=updating),Config.ui.updateStoryElements=!1}else $elems.append('<div id="story" role="main"><div id="passages" aria-live="polite"></div></div>');$elems.insertBefore("body>script#script-sugarcube")}(),_outlinePatch=new StyleWrapper(jQuery(document.createElement("style")).attr({id:"style-aria-outlines",type:"text/css"}).appendTo(document.head).get(0)),_hideOutlines(),jQuery(document).on("mousedown.aria-outlines keydown.aria-outlines",(function(ev){ev.type!==_lastOutlineEvent&&(_lastOutlineEvent=ev.type,"keydown"===ev.type?_outlinePatch.clear():_hideOutlines())}))}},start:{value:function(){if(Story.getAllInit().forEach((function(passage){try{var debugBuffer=Wikifier.wikifyEval(passage.text);if(Config.debug){var debugView=new DebugView(document.createDocumentFragment(),"special","".concat(passage.title," [init-tagged]"),"".concat(passage.title," [init-tagged]"));debugView.modes({hidden:!0}),debugView.append(debugBuffer),_initDebugViews.push(debugView.output)}}catch(ex){console.error(ex),Alert.error("".concat(passage.title," [init-tagged]"),"object"===_typeof(ex)?ex.message:ex)}})),Story.has("StoryInit"))try{var debugBuffer=Wikifier.wikifyEval(Story.get("StoryInit").text);if(Config.debug){var debugView=new DebugView(document.createDocumentFragment(),"special","StoryInit","StoryInit");debugView.modes({hidden:!0}),debugView.append(debugBuffer),_initDebugViews.push(debugView.output)}}catch(ex){console.error(ex),Alert.error("StoryInit","object"===_typeof(ex)?ex.message:ex)}if(null==Config.passages.start)throw new Error("starting passage not selected");if(!Story.has(Config.passages.start))throw new Error('starting passage ("'.concat(Config.passages.start,'") not found'));if(jQuery(document.documentElement).focus(),State.restore())engineShow();else{var loadStart=!0;switch(_typeof(Config.saves.autoload)){case"boolean":Config.saves.autoload&&Save.autosave.ok()&&Save.autosave.has()&&(loadStart=!Save.autosave.load());break;case"string":"prompt"===Config.saves.autoload&&Save.autosave.ok()&&Save.autosave.has()&&(loadStart=!1,UI.buildAutoload(),Dialog.open());break;case"function":Save.autosave.ok()&&Save.autosave.has()&&Config.saves.autoload()&&(loadStart=!Save.autosave.load())}loadStart&&enginePlay(Config.passages.start)}}},restart:{value:function(){LoadScreen.show(),window.scroll(0,0),State.reset(),jQuery.event.trigger(":enginerestart"),window.location.reload()}},state:{get:function(){return _state}},isIdle:{value:function(){return _state===States.Idle}},isPlaying:{value:function(){return _state!==States.Idle}},isRendering:{value:function(){return _state===States.Rendering}},lastPlay:{get:function(){return _lastPlay}},goTo:{value:function(idx){var succeded=State.goTo(idx);return succeded&&engineShow(),succeded}},go:{value:engineGo},backward:{value:function(){return engineGo(-1)}},forward:{value:function(){return engineGo(1)}},show:{value:engineShow},play:{value:enginePlay},display:{value:function(title,link,option){var noHistory=!1;switch(option){case undefined:break;case"replace":case"back":noHistory=!0;break;default:throw new Error('Engine.display option parameter called with obsolete value "'.concat(option,'"; please notify the developer'))}enginePlay(title,noHistory)}}}))}(),Passage=(_tagsToSkip=/^(?:debug|nobr|passage|widget|twine\..*)$/i,function(){function Passage(title,el){var _this22=this;_classCallCheck(this,Passage),Object.defineProperties(this,{title:{value:Util.unescape(title)},element:{value:el||null},tags:{value:Object.freeze(el&&el.hasAttribute("tags")?Array.from(new Set(el.getAttribute("tags").trim().splitOrEmpty(/\s+/))):[])},_excerpt:{writable:!0,value:null}}),Object.defineProperties(this,{domId:{value:"passage-".concat(Util.slugify(this.title))},classes:{value:Object.freeze(0===this.tags.length?[]:_this22.tags.filter((function(tag){return!_tagsToSkip.test(tag)})).map((function(tag){return Util.slugify(tag)})))}})}return _createClass(Passage,[{key:"className",get:function(){return this.classes.join(" ")}},{key:"text",get:function(){if(null==this.element){var passage=Util.escapeMarkup(this.title),mesg="".concat(L10n.get("errorTitle"),": ").concat(L10n.get("errorNonexistentPassage",{passage:passage}));return'<div class="error-view"><span class="error">'.concat(mesg,"</span></div>")}return this.element.textContent.replace(/\r/g,"")}},{key:"description",value:function(){var descriptions=Config.passages.descriptions;switch(_typeof(descriptions)){case"boolean":if(descriptions)return this.title;break;case"object":if(descriptions.hasOwnProperty(this.title))return descriptions[this.title];break;case"function":var result=descriptions.call(this);if(result)return result}return null===this._excerpt&&(this._excerpt=Passage.getExcerptFromText(this.text)),this._excerpt}},{key:"processText",value:function(){if(null==this.element)return this.text;if(this.tags.includes("Twine.image"))return"[img[".concat(this.text,"]]");var processed=this.text;return Config.passages.onProcess&&(processed=Config.passages.onProcess.call(null,{title:this.title,tags:this.tags,text:processed})),(Config.passages.nobr||this.tags.includes("nobr"))&&(processed=processed.replace(/^\n+|\n+$/g,"").replace(/\n+/g," ")),processed}},{key:"render",value:function(options){var frag=document.createDocumentFragment();return new Wikifier(frag,this.processText(),options),this._excerpt=Passage.getExcerptFromNode(frag),frag}}],[{key:"getExcerptFromNode",value:function(node,count){if(!node.hasChildNodes())return"";var excerpt=node.textContent.trim();if(""!==excerpt){var excerptRe=new RegExp("(\\S+(?:\\s+\\S+){0,".concat(count>0?count-1:7,"})"));excerpt=excerpt.replace(/\s+/g," ").match(excerptRe)}return excerpt?"".concat(excerpt[1],"…"):"…"}},{key:"getExcerptFromText",value:function(text,count){if(""===text)return"";var excerptRe=new RegExp("(\\S+(?:\\s+\\S+){0,".concat(count>0?count-1:7,"})")),excerpt=text.replace(/<<.*?>>/g," ").replace(/<.*?>/g," ").trim().replace(/^\s*\|.*\|.*?$/gm,"").replace(/\[[<>]?img\[[^\]]*\]\]/g,"").replace(/\[\[([^|\]]*?)(?:(?:\||->|<-)[^\]]*)?\]\]/g,"$1").replace(/^\s*!+(.*?)$/gm,"$1").replace(/'{2}|\/{2}|_{2}|@{2}/g,"").trim().replace(/\s+/g," ").match(excerptRe);return excerpt?"".concat(excerpt[1],"…"):"…"}}]),Passage}()),_tagsToSkip,Save=function(){var Type=Util.toEnum({Autosave:"autosave",Disk:"disk",Serialize:"serialize",Slot:"slot"}),_slotsUBound=-1,_onLoadHandlers=new Set,_onSaveHandlers=new Set;function savesObjGet(){var saves=storage.get("saves");return null===saves?{autosave:null,slots:_appendSlots([],Config.saves.slots)}:saves}function savesObjClear(){return storage.delete("saves"),!0}function autosaveOk(){return"cookie"!==storage.name&&void 0!==Config.saves.autosave}function slotsOk(){return"cookie"!==storage.name&&-1!==_slotsUBound}function slotsCount(){if(!slotsOk())return 0;for(var saves=savesObjGet(),count=0,i=0,iend=saves.slots.length;i<iend;++i)null!==saves.slots[i]&&++count;return count}function _appendSlots(array,num){for(var i=0;i<num;++i)array.push(null);return array}function _savesObjIsEmpty(saves){for(var slots=saves.slots,isSlotsEmpty=!0,i=0,iend=slots.length;i<iend;++i)if(null!==slots[i]){isSlotsEmpty=!1;break}return null===saves.autosave&&isSlotsEmpty}function _savesObjSave(saves){return _savesObjIsEmpty(saves)?(storage.delete("saves"),!0):storage.set("saves",saves)}function _savesObjUpdate(saveObj){if(null==saveObj||"object"!==_typeof(saveObj))return!1;var updated=!1;return saveObj.hasOwnProperty("state")&&saveObj.state.hasOwnProperty("delta")&&saveObj.state.hasOwnProperty("index")||(saveObj.hasOwnProperty("data")?(delete saveObj.mode,saveObj.state={delta:State.deltaEncode(saveObj.data)},delete saveObj.data):saveObj.state.hasOwnProperty("delta")?saveObj.state.hasOwnProperty("index")||delete saveObj.state.mode:(delete saveObj.state.mode,saveObj.state.delta=State.deltaEncode(saveObj.state.history),delete saveObj.state.history),saveObj.state.index=saveObj.state.delta.length-1,updated=!0),saveObj.state.hasOwnProperty("rseed")&&(saveObj.state.seed=saveObj.state.rseed,delete saveObj.state.rseed,saveObj.state.delta.forEach((function(_,i,delta){delta[i].hasOwnProperty("rcount")&&(delta[i].pull=delta[i].rcount,delete delta[i].rcount)})),updated=!0),(saveObj.state.hasOwnProperty("expired")&&"number"==typeof saveObj.state.expired||saveObj.state.hasOwnProperty("unique")||saveObj.state.hasOwnProperty("last"))&&(saveObj.state.hasOwnProperty("expired")&&"number"==typeof saveObj.state.expired&&delete saveObj.state.expired,(saveObj.state.hasOwnProperty("unique")||saveObj.state.hasOwnProperty("last"))&&(saveObj.state.expired=[],saveObj.state.hasOwnProperty("unique")&&(saveObj.state.expired.push(saveObj.state.unique),delete saveObj.state.unique),saveObj.state.hasOwnProperty("last")&&(saveObj.state.expired.push(saveObj.state.last),delete saveObj.state.last)),updated=!0),updated}function _marshal(supplemental,details){if(null!=supplemental&&"object"!==_typeof(supplemental))throw new Error("supplemental parameter must be an object");var saveObj=Object.assign({},supplemental,{id:Config.saves.id,state:State.marshalForSave()});return Config.saves.version&&(saveObj.version=Config.saves.version),_onSaveHandlers.forEach((function(fn){return fn(saveObj,details)})),saveObj.state.delta=State.deltaEncode(saveObj.state.history),delete saveObj.state.history,saveObj}function _unmarshal(saveObj){try{if(_savesObjUpdate(saveObj),!saveObj||!saveObj.hasOwnProperty("id")||!saveObj.hasOwnProperty("state"))throw new Error(L10n.get("errorSaveMissingData"));if(saveObj.state.history=State.deltaDecode(saveObj.state.delta),delete saveObj.state.delta,_onLoadHandlers.forEach((function(fn){return fn(saveObj)})),saveObj.id!==Config.saves.id)throw new Error(L10n.get("errorSaveIdMismatch"));State.unmarshalForSave(saveObj.state),Engine.show()}catch(ex){return UI.alert("".concat(ex.message.toUpperFirst(),".</p><p>").concat(L10n.get("aborting"),".")),!1}return!0}return Object.freeze(Object.defineProperties({},{init:{value:function(){if("cookie"===storage.name)return savesObjClear(),Config.saves.autoload=undefined,Config.saves.autosave=undefined,Config.saves.slots=0,!1;var saves=savesObjGet(),updated=!1;Array.isArray(saves)&&(saves={autosave:null,slots:saves},updated=!0),Config.saves.slots!==saves.slots.length&&(Config.saves.slots<saves.slots.length?(saves.slots.reverse(),saves.slots=saves.slots.filter((function(val){return!(null===val&&this.count>0)||(--this.count,!1)}),{count:saves.slots.length-Config.saves.slots}),saves.slots.reverse()):Config.saves.slots>saves.slots.length&&_appendSlots(saves.slots,Config.saves.slots-saves.slots.length),updated=!0),_savesObjUpdate(saves.autosave)&&(updated=!0);for(var i=0;i<saves.slots.length;++i)_savesObjUpdate(saves.slots[i])&&(updated=!0);return _savesObjIsEmpty(saves)&&(storage.delete("saves"),updated=!1),updated&&_savesObjSave(saves),_slotsUBound=saves.slots.length-1,!0}},get:{value:savesObjGet},clear:{value:savesObjClear},ok:{value:function(){return autosaveOk()||slotsOk()}},autosave:{value:Object.freeze(Object.defineProperties({},{ok:{value:autosaveOk},has:{value:function(){return null!==savesObjGet().autosave}},get:{value:function(){return savesObjGet().autosave}},load:{value:function(){var saves=savesObjGet();return null!==saves.autosave&&_unmarshal(saves.autosave)}},save:{value:function(title,metadata){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return!1;var saves=savesObjGet(),supplemental={title:title||Story.get(State.passage).description(),date:Date.now()};return null!=metadata&&(supplemental.metadata=metadata),saves.autosave=_marshal(supplemental,{type:Type.Autosave}),_savesObjSave(saves)}},delete:{value:function(){var saves=savesObjGet();return saves.autosave=null,_savesObjSave(saves)}}}))},slots:{value:Object.freeze(Object.defineProperties({},{ok:{value:slotsOk},length:{get:function(){return _slotsUBound+1}},isEmpty:{value:function(){return 0===slotsCount()}},count:{value:slotsCount},has:{value:function(slot){if(slot<0||slot>_slotsUBound)return!1;var saves=savesObjGet();return!(slot>=saves.slots.length||null===saves.slots[slot])}},get:{value:function(slot){if(slot<0||slot>_slotsUBound)return null;var saves=savesObjGet();return slot>=saves.slots.length?null:saves.slots[slot]}},load:{value:function(slot){if(slot<0||slot>_slotsUBound)return!1;var saves=savesObjGet();return!(slot>=saves.slots.length||null===saves.slots[slot])&&_unmarshal(saves.slots[slot])}},save:{value:function(slot,title,metadata){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return Dialog.isOpen()?$(document).one(":dialogclosed",(function(){return UI.alert(L10n.get("savesDisallowed"))})):UI.alert(L10n.get("savesDisallowed")),!1;if(slot<0||slot>_slotsUBound)return!1;var saves=savesObjGet();if(slot>=saves.slots.length)return!1;var supplemental={title:title||Story.get(State.passage).description(),date:Date.now()};return null!=metadata&&(supplemental.metadata=metadata),saves.slots[slot]=_marshal(supplemental,{type:Type.Slot}),_savesObjSave(saves)}},delete:{value:function(slot){if(slot<0||slot>_slotsUBound)return!1;var saves=savesObjGet();return!(slot>=saves.slots.length)&&(saves.slots[slot]=null,_savesObjSave(saves))}}}))},export:{value:function(filename,metadata){if("function"!=typeof Config.saves.isAllowed||Config.saves.isAllowed()){var str,now,MM,DD,hh,mm,ss,baseName=null==filename?Story.domId:(str=filename,Util.sanitizeFilename(str).replace(/[_\s\u2013\u2014-]+/g,"-")),saveName="".concat(baseName,"-").concat((now=new Date,MM=now.getMonth()+1,DD=now.getDate(),hh=now.getHours(),mm=now.getMinutes(),ss=now.getSeconds(),MM<10&&(MM="0".concat(MM)),DD<10&&(DD="0".concat(DD)),hh<10&&(hh="0".concat(hh)),mm<10&&(mm="0".concat(mm)),ss<10&&(ss="0".concat(ss)),"".concat(now.getFullYear()).concat(MM).concat(DD,"-").concat(hh).concat(mm).concat(ss)),".save"),supplemental=null==metadata?{}:{metadata:metadata},saveObj=LZString.compressToBase64(JSON.stringify(_marshal(supplemental,{type:Type.Disk})));saveAs(new Blob([saveObj],{type:"text/plain;charset=UTF-8"}),saveName)}else Dialog.isOpen()?$(document).one(":dialogclosed",(function(){return UI.alert(L10n.get("savesDisallowed"))})):UI.alert(L10n.get("savesDisallowed"))}},import:{value:function(event){var file=event.target.files[0],reader=new FileReader;jQuery(reader).one("loadend",(function(){if(reader.error){var ex=reader.error;UI.alert("".concat(L10n.get("errorSaveDiskLoadFailed").toUpperFirst()," (").concat(ex.name,": ").concat(ex.message,").</p><p>").concat(L10n.get("aborting"),"."))}else{var saveObj;try{saveObj=JSON.parse(/\.json$/i.test(file.name)||/^\{/.test(reader.result)?reader.result:LZString.decompressFromBase64(reader.result))}catch(ex){}_unmarshal(saveObj)}})),reader.readAsText(file)}},serialize:{value:function(metadata){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return Dialog.isOpen()?$(document).one(":dialogclosed",(function(){return UI.alert(L10n.get("savesDisallowed"))})):UI.alert(L10n.get("savesDisallowed")),null;var supplemental=null==metadata?{}:{metadata:metadata};return LZString.compressToBase64(JSON.stringify(_marshal(supplemental,{type:Type.Serialize})))}},deserialize:{value:function(base64Str){var saveObj;try{saveObj=JSON.parse(LZString.decompressFromBase64(base64Str))}catch(ex){}return _unmarshal(saveObj)?saveObj.metadata:null}},onLoad:{value:Object.freeze(Object.defineProperties({},{add:{value:function(handler){var valueType=Util.getType(handler);if("function"!==valueType)throw new TypeError("Save.onLoad.add handler parameter must be a function (received: ".concat(valueType,")"));_onLoadHandlers.add(handler)}},clear:{value:function(){_onLoadHandlers.clear()}},delete:{value:function(handler){return _onLoadHandlers.delete(handler)}},size:{get:function(){return _onLoadHandlers.size}}}))},onSave:{value:Object.freeze(Object.defineProperties({},{add:{value:function(handler){var valueType=Util.getType(handler);if("function"!==valueType)throw new TypeError("Save.onSave.add handler parameter must be a function (received: ".concat(valueType,")"));_onSaveHandlers.add(handler)}},clear:{value:function(){_onSaveHandlers.clear()}},delete:{value:function(handler){return _onSaveHandlers.delete(handler)}},size:{get:function(){return _onSaveHandlers.size}}}))}}))}(),Setting=function(){var Types=Util.toEnum({Header:0,Toggle:1,List:2,Range:3}),_definitions=[];function settingsCreate(){return Object.create(null)}function settingsSave(){var savedSettings=settingsCreate();return Object.keys(settings).length>0&&_definitions.filter((function(def){return def.type!==Types.Header&&settings[def.name]!==def.default})).forEach((function(def){return savedSettings[def.name]=settings[def.name]})),0===Object.keys(savedSettings).length?(storage.delete("settings"),!0):storage.set("settings",savedSettings)}function settingsLoad(){var defaultSettings=settingsCreate(),loadedSettings=storage.get("settings")||settingsCreate();_definitions.filter((function(def){return def.type!==Types.Header})).forEach((function(def){return defaultSettings[def.name]=def.default})),window.SugarCube.settings=settings=Object.assign(defaultSettings,loadedSettings)}function settingsClear(){return window.SugarCube.settings=settings=settingsCreate(),storage.delete("settings"),!0}function definitionsAdd(type,name,def){if(arguments.length<3){var errors=[];throw arguments.length<1&&errors.push("type"),arguments.length<2&&errors.push("name"),arguments.length<3&&errors.push("definition"),new Error("missing parameters, no ".concat(errors.join(" or ")," specified"))}if("object"!==_typeof(def))throw new TypeError("definition parameter must be an object");if(definitionsHas(name))throw new Error('cannot clobber existing setting "'.concat(name,'"'));var str,pos,definition={type:type,name:name,label:"string"==typeof def.label?def.label.trim():""};if("string"==typeof def.desc){var desc=def.desc.trim();""!==desc&&(definition.desc=desc)}switch(type){case Types.Header:break;case Types.Toggle:definition.default=!!def.default;break;case Types.List:if(!def.hasOwnProperty("list"))throw new Error("no list specified");if(!Array.isArray(def.list))throw new TypeError("list must be an array");if(0===def.list.length)throw new Error("list must not be empty");if(definition.list=Object.freeze(def.list),null==def.default)definition.default=def.list[0];else{var defaultIndex=def.list.indexOf(def.default);if(-1===defaultIndex)throw new Error("list does not contain default");definition.default=def.list[defaultIndex]}break;case Types.Range:if(!def.hasOwnProperty("min"))throw new Error("no min specified");if("number"!=typeof def.min||Number.isNaN(def.min)||!Number.isFinite(def.min))throw new TypeError("min must be a finite number");if(!def.hasOwnProperty("max"))throw new Error("no max specified");if("number"!=typeof def.max||Number.isNaN(def.max)||!Number.isFinite(def.max))throw new TypeError("max must be a finite number");if(!def.hasOwnProperty("step"))throw new Error("no step specified");if("number"!=typeof def.step||Number.isNaN(def.step)||!Number.isFinite(def.step)||def.step<=0)throw new TypeError("step must be a finite number greater than zero");var stepValidate=function(value){if(fracDigits>0){var ma=Number("".concat(def.min,"e").concat(fracDigits)),sa=Number("".concat(def.step,"e").concat(fracDigits)),_va=Number("".concat(value,"e").concat(fracDigits))-ma;return Number("".concat(_va-_va%sa+ma,"e-").concat(fracDigits))}var va=value-def.min;return va-va%def.step+def.min},fracDigits=(str=String(def.step),-1===(pos=str.lastIndexOf("."))?0:str.length-pos-1);if(stepValidate(def.max)!==def.max)throw new RangeError("max (".concat(def.max,") is not a multiple of the step (").concat(def.step,") plus the min (").concat(def.min,")"));if(definition.max=def.max,definition.min=def.min,definition.step=def.step,null==def.default)definition.default=def.max;else{if("number"!=typeof def.default||Number.isNaN(def.default)||!Number.isFinite(def.default))throw new TypeError("default must be a finite number");if(def.default<def.min)throw new RangeError("default (".concat(def.default,") is less than min (").concat(def.min,")"));if(def.default>def.max)throw new RangeError("default (".concat(def.default,") is greater than max (").concat(def.max,")"));definition.default=def.default}break;default:throw new Error("unknown Setting type: ".concat(type))}"function"==typeof def.onInit&&(definition.onInit=Object.freeze(def.onInit)),"function"==typeof def.onChange&&(definition.onChange=Object.freeze(def.onChange)),_definitions.push(Object.freeze(definition))}function definitionsHas(name){return _definitions.some((function(definition){return definition.name===name}))}function definitionsGet(name){return _definitions.find((function(definition){return definition.name===name}))}return Object.freeze(Object.defineProperties({},{Types:{value:Types},init:{value:function(){if(storage.has("options")){var old=storage.get("options");null!==old&&(window.SugarCube.settings=settings=Object.assign(settingsCreate(),old)),settingsSave(),storage.delete("options")}settingsLoad(),_definitions.forEach((function(def){if(def.hasOwnProperty("onInit")){var thisArg={name:def.name,value:settings[def.name],default:def.default};def.hasOwnProperty("list")&&(thisArg.list=def.list),def.onInit.call(thisArg)}}))}},create:{value:settingsCreate},save:{value:settingsSave},load:{value:settingsLoad},clear:{value:settingsClear},reset:{value:function(name){if(0===arguments.length)settingsClear(),settingsLoad();else{if(null==name||!definitionsHas(name))throw new Error('nonexistent setting "'.concat(name,'"'));var def=definitionsGet(name);def.type!==Types.Header&&(settings[name]=def.default)}return settingsSave()}},forEach:{value:function(callback,thisArg){_definitions.forEach(callback,thisArg)}},add:{value:definitionsAdd},addHeader:{value:function(name,desc){definitionsAdd(Types.Header,name,{desc:desc})}},addToggle:{value:function(){for(var _len16=arguments.length,args=new Array(_len16),_key16=0;_key16<_len16;_key16++)args[_key16]=arguments[_key16];definitionsAdd.apply(void 0,[Types.Toggle].concat(args))}},addList:{value:function(){for(var _len17=arguments.length,args=new Array(_len17),_key17=0;_key17<_len17;_key17++)args[_key17]=arguments[_key17];definitionsAdd.apply(void 0,[Types.List].concat(args))}},addRange:{value:function(){for(var _len18=arguments.length,args=new Array(_len18),_key18=0;_key18<_len18;_key18++)args[_key18]=arguments[_key18];definitionsAdd.apply(void 0,[Types.Range].concat(args))}},isEmpty:{value:function(){return 0===_definitions.length}},has:{value:definitionsHas},get:{value:definitionsGet},delete:{value:function definitionsDelete(name){definitionsHas(name)&&delete settings[name];for(var i=0;i<_definitions.length;++i)if(_definitions[i].name===name){_definitions.splice(i,1),definitionsDelete(name);break}}}}))}(),Story=function(){var _passages={},_inits=[],_scripts=[],_styles=[],_widgets=[],_title="",_ifId="",_domId="";function _storySetTitle(rawTitle){if(null==rawTitle)throw new Error("story title must not be null or undefined");var title=Util.unescape(String(rawTitle)).trim();if(""===title)throw new Error("story title must not be empty or consist solely of whitespace");if(document.title=_title=title,""===(_domId=Util.slugify(_title)))if(""!==_ifId)_domId=_ifId;else for(var i=0,len=_title.length;i<len;++i){var _Util$charAndPosAt2=Util.charAndPosAt(_title,i),char=_Util$charAndPosAt2.char,start=_Util$charAndPosAt2.start,end=_Util$charAndPosAt2.end;_domId+=char.codePointAt(0).toString(16),i+=end-start}}return Object.freeze(Object.defineProperties({},{load:{value:function(){var validationCodeTags=["init","widget"],validationNoCodeTagPassages=["PassageDone","PassageFooter","PassageHeader","PassageReady","StoryAuthor","StoryBanner","StoryCaption","StoryInit","StoryMenu","StoryShare","StorySubtitle"];function validateStartingPassage(passage){if(passage.tags.includesAny(validationCodeTags))throw new Error('starting passage "'.concat(passage.title,'" contains special tags; invalid: "').concat(passage.tags.filter((function(tag){return validationCodeTags.includes(tag)})).sort().join('", "'),'"'))}function validateSpecialPassages(passage){if(validationNoCodeTagPassages.includes(passage.title)){for(var _len19=arguments.length,tags=new Array(_len19>1?_len19-1:0),_key19=1;_key19<_len19;_key19++)tags[_key19-1]=arguments[_key19];throw new Error('special passage "'.concat(passage.title,'" contains special tags; invalid: "').concat(tags.sort().join('", "'),'"'))}var codeTags=[].concat(validationCodeTags),foundTags=[];if(passage.tags.forEach((function(tag){codeTags.includes(tag)&&foundTags.push.apply(foundTags,_toConsumableArray(codeTags.delete(tag)))})),foundTags.length>1)throw new Error('passage "'.concat(passage.title,'" contains multiple special tags; invalid: "').concat(foundTags.sort().join('", "'),'"'))}var $storydata=jQuery("tw-storydata"),startNode=$storydata.attr("startnode")||"";Config.passages.start=null,Config.debug=/\bdebug\b/.test($storydata.attr("options")),$storydata.children("style").each((function(i){_styles.push(new Passage("tw-user-style-".concat(i),this))})),$storydata.children("script").each((function(i){_scripts.push(new Passage("tw-user-script-".concat(i),this))})),$storydata.children('tw-passagedata:not([tags~="Twine.private"],[tags~="annotation"])').each((function(){var $this=jQuery(this),pid=$this.attr("pid")||"",passage=new Passage($this.attr("name"),this);pid===startNode&&""!==startNode?(Config.passages.start=passage.title,validateStartingPassage(passage),_passages[passage.title]=passage):passage.tags.includes("init")?(validateSpecialPassages(passage,"init"),_inits.push(passage)):passage.tags.includes("widget")?(validateSpecialPassages(passage,"widget"),_widgets.push(passage)):_passages[passage.title]=passage})),_ifId=$storydata.attr("ifid"),_storySetTitle("Free Cities: Origins"),Config.saves.id=Story.domId}},init:{value:function(){var storyStyle;storyStyle=document.createElement("style"),new StyleWrapper(storyStyle).add(_styles.map((function(style){return style.text.trim()})).join("\n")),jQuery(storyStyle).appendTo(document.head).attr({id:"style-story",type:"text/css"});for(var i=0;i<_scripts.length;++i)try{Scripting.evalJavaScript(_scripts[i].text)}catch(ex){console.error(ex),Alert.error(_scripts[i].title,"object"===_typeof(ex)?ex.message:ex)}for(var _i8=0;_i8<_widgets.length;++_i8)try{Wikifier.wikifyEval(_widgets[_i8].processText())}catch(ex){console.error(ex),Alert.error(_widgets[_i8].title,"object"===_typeof(ex)?ex.message:ex)}}},title:{get:function(){return _title}},domId:{get:function(){return _domId}},ifId:{get:function(){return _ifId}},add:{value:function(passage){if(!(passage instanceof Passage))throw new TypeError("Story.add passage parameter must be an instance of Passage");var title=passage.title;return!_passages.hasOwnProperty(title)&&(_passages[title]=passage,!0)}},has:{value:function(title){var type=_typeof(title);switch(type){case"number":case"string":return _passages.hasOwnProperty(String(title));case"undefined":break;case"object":type=null===title?"null":"an object";break;default:type="a ".concat(type)}throw new TypeError("Story.has title parameter cannot be ".concat(type))}},get:{value:function(title){var type=_typeof(title);switch(type){case"number":case"string":var id=String(title);return _passages.hasOwnProperty(id)?_passages[id]:new Passage(id||"(unknown)");case"undefined":break;case"object":type=null===title?"null":"an object";break;default:type="a ".concat(type)}throw new TypeError("Story.get title parameter cannot be ".concat(type))}},getAllInit:{value:function(){return Object.freeze(Array.from(_inits))}},getAllRegular:{value:function(){return Object.freeze(Object.assign({},_passages))}},getAllScript:{value:function(){return Object.freeze(Array.from(_scripts))}},getAllStylesheet:{value:function(){return Object.freeze(Array.from(_styles))}},getAllWidget:{value:function(){return Object.freeze(Array.from(_widgets))}},lookup:{value:function(key,value){var sortKey=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"title",results=[];return Object.keys(_passages).forEach((function(name){var passage=_passages[name];"object"===_typeof(passage[key])&&null!==passage[key]?passage[key]instanceof Array&&passage[key].some((function(m){return Util.sameValueZero(m,value)}))&&results.push(passage):Util.sameValueZero(passage[key],value)&&results.push(passage)})),results.sort((function(a,b){return a[sortKey]==b[sortKey]?0:a[sortKey]<b[sortKey]?-1:1})),results}},lookupWith:{value:function(predicate){var sortKey=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"title";if("function"!=typeof predicate)throw new TypeError("Story.lookupWith predicate parameter must be a function");var results=[];return Object.keys(_passages).forEach((function(name){var passage=_passages[name];predicate(passage)&&results.push(passage)})),results.sort((function(a,b){return a[sortKey]==b[sortKey]?0:a[sortKey]<b[sortKey]?-1:1})),results}}}))}(),UI=function(){function uiAssembleLinkList(passage,listEl){var list=listEl,debugState=Config.debug,cleanState=Config.cleanupWikifierOutput;Config.debug=!1,Config.cleanupWikifierOutput=!1;try{null==list&&(list=document.createElement("ul"));var frag=document.createDocumentFragment();new Wikifier(frag,Story.get(passage).processText().trim());var errors=_toConsumableArray(frag.querySelectorAll(".error")).map((function(errEl){return errEl.textContent.replace(errorPrologRegExp,"")}));if(errors.length>0)throw new Error(errors.join("; "));for(;frag.hasChildNodes();){var node=frag.firstChild;if(node.nodeType===Node.ELEMENT_NODE&&"A"===node.nodeName.toUpperCase()){var li=document.createElement("li");list.appendChild(li),li.appendChild(node)}else frag.removeChild(node)}}finally{Config.cleanupWikifierOutput=cleanState,Config.debug=debugState}return list}function uiOpenAlert(message){jQuery(Dialog.setup(L10n.get("alertTitle"),"alert")).append("<p>".concat(message,'</p><ul class="buttons">')+'<li><button id="alert-ok" class="ui-close">'.concat(L10n.get(["alertOk","ok"]),"</button></li>")+"</ul>");for(var _len20=arguments.length,args=new Array(_len20>1?_len20-1:0),_key20=1;_key20<_len20;_key20++)args[_key20-1]=arguments[_key20];Dialog.open.apply(Dialog,args)}function uiBuildAutoload(){return jQuery(Dialog.setup(L10n.get("autoloadTitle"),"autoload")).append("<p>".concat(L10n.get("autoloadPrompt"),'</p><ul class="buttons">')+'<li><button id="autoload-ok" class="ui-close">'.concat(L10n.get(["autoloadOk","ok"]),"</button></li>")+'<li><button id="autoload-cancel" class="ui-close">'.concat(L10n.get(["autoloadCancel","cancel"]),"</button></li>")+"</ul>"),jQuery(document).one("click.autoload",".ui-close",(function(ev){var isAutoloadOk="autoload-ok"===ev.target.id;jQuery(document).one(":dialogclosed",(function(){isAutoloadOk&&Save.autosave.load()||Engine.play(Config.passages.start)}))})),!0}function uiBuildJumpto(){var list=document.createElement("ul");jQuery(Dialog.setup(L10n.get("jumptoTitle"),"jumpto list")).append(list);for(var expired=State.expired.length,i=State.size-1;i>=0;--i)if(i!==State.activeIndex){var passage=Story.get(State.history[i].title);passage&&passage.tags.includes("bookmark")&&jQuery(document.createElement("li")).append(jQuery(document.createElement("a")).ariaClick({one:!0},function(idx){return function(){return jQuery(document).one(":dialogclosed",(function(){return Engine.goTo(idx)}))}}(i)).addClass("ui-close").text("".concat(L10n.get("jumptoTurn")," ").concat(expired+i+1,": ").concat(passage.description()))).appendTo(list)}list.hasChildNodes()||jQuery(list).append("<li><a><em>".concat(L10n.get("jumptoUnavailable"),"</em></a></li>"))}function uiBuildRestart(){return jQuery(Dialog.setup(L10n.get("restartTitle"),"restart")).append("<p>".concat(L10n.get("restartPrompt"),'</p><ul class="buttons">')+'<li><button id="restart-ok">'.concat(L10n.get(["restartOk","ok"]),"</button></li>")+'<li><button id="restart-cancel" class="ui-close">'.concat(L10n.get(["restartCancel","cancel"]),"</button></li>")+"</ul>").find("#restart-ok").ariaClick({one:!0},(function(){jQuery(document).one(":dialogclosed",(function(){return Engine.restart()})),Dialog.close()})),!0}function uiBuildSaves(){var savesAllowed="function"!=typeof Config.saves.isAllowed||Config.saves.isAllowed();function createActionItem(bId,bClass,bText,bAction){var $btn=jQuery(document.createElement("button")).attr("id","saves-".concat(bId)).html(bText);return bClass&&$btn.addClass(bClass),bAction?$btn.ariaClick(bAction):$btn.ariaDisabled(!0),jQuery(document.createElement("li")).append($btn)}var $dialogBody=jQuery(Dialog.setup(L10n.get("savesTitle"),"saves")),savesOk=Save.ok(),fileOk=Has.fileAPI&&(Config.saves.tryDiskOnMobile||!Browser.isMobile.any());if(savesOk&&$dialogBody.append(function(){function createButton(bId,bClass,bText,bSlot,bAction){var $btn=jQuery(document.createElement("button")).attr("id","saves-".concat(bId,"-").concat(bSlot)).addClass(bId).html(bText);return bClass&&$btn.addClass(bClass),bAction?"auto"===bSlot?$btn.ariaClick({label:"".concat(bText," ").concat(L10n.get("savesLabelAuto"))},(function(){return bAction()})):$btn.ariaClick({label:"".concat(bText," ").concat(L10n.get("savesLabelSlot")," ").concat(bSlot+1)},(function(){return bAction(bSlot)})):$btn.ariaDisabled(!0),$btn}var saves=Save.get(),$tbody=jQuery(document.createElement("tbody"));if(Save.autosave.ok()){var $tdSlot=jQuery(document.createElement("td")),$tdLoad=jQuery(document.createElement("td")),$tdDesc=jQuery(document.createElement("td")),$tdDele=jQuery(document.createElement("td"));jQuery(document.createElement("b")).attr({title:L10n.get("savesLabelAuto"),"aria-label":L10n.get("savesLabelAuto")}).text("A").appendTo($tdSlot),saves.autosave?($tdLoad.append(createButton("load","ui-close",L10n.get("savesLabelLoad"),"auto",(function(){jQuery(document).one(":dialogclosed",(function(){return Save.autosave.load()}))}))),jQuery(document.createElement("div")).text(saves.autosave.title).appendTo($tdDesc),jQuery(document.createElement("div")).addClass("datestamp").html(saves.autosave.date?"".concat(new Date(saves.autosave.date).toLocaleString()):"<em>".concat(L10n.get("savesUnknownDate"),"</em>")).appendTo($tdDesc),$tdDele.append(createButton("delete",null,L10n.get("savesLabelDelete"),"auto",(function(){Save.autosave.delete(),uiBuildSaves()})))):($tdLoad.append(createButton("load",null,L10n.get("savesLabelLoad"),"auto")),$tdDesc.addClass("empty").text("•  •  •"),$tdDele.append(createButton("delete",null,L10n.get("savesLabelDelete"),"auto"))),jQuery(document.createElement("tr")).append($tdSlot).append($tdLoad).append($tdDesc).append($tdDele).appendTo($tbody)}for(var i=0,iend=saves.slots.length;i<iend;++i){var _$tdSlot=jQuery(document.createElement("td")),_$tdLoad=jQuery(document.createElement("td")),_$tdDesc=jQuery(document.createElement("td")),_$tdDele=jQuery(document.createElement("td"));_$tdSlot.append(document.createTextNode(i+1)),saves.slots[i]?(_$tdLoad.append(createButton("load","ui-close",L10n.get("savesLabelLoad"),i,(function(slot){jQuery(document).one(":dialogclosed",(function(){return Save.slots.load(slot)}))}))),jQuery(document.createElement("div")).text(saves.slots[i].title).appendTo(_$tdDesc),jQuery(document.createElement("div")).addClass("datestamp").html(saves.slots[i].date?"".concat(new Date(saves.slots[i].date).toLocaleString()):"<em>".concat(L10n.get("savesUnknownDate"),"</em>")).appendTo(_$tdDesc),_$tdDele.append(createButton("delete",null,L10n.get("savesLabelDelete"),i,(function(slot){Save.slots.delete(slot),uiBuildSaves()})))):(_$tdLoad.append(createButton("save","ui-close",L10n.get("savesLabelSave"),i,savesAllowed?Save.slots.save:null)),_$tdDesc.addClass("empty").text("•  •  •"),_$tdDele.append(createButton("delete",null,L10n.get("savesLabelDelete"),i))),jQuery(document.createElement("tr")).append(_$tdSlot).append(_$tdLoad).append(_$tdDesc).append(_$tdDele).appendTo($tbody)}return jQuery(document.createElement("table")).attr("id","saves-list").append($tbody)}()),savesOk||fileOk){var $btnBar=jQuery(document.createElement("ul")).addClass("buttons").appendTo($dialogBody);return fileOk&&($btnBar.append(createActionItem("export","ui-close",L10n.get("savesLabelExport"),savesAllowed?function(){return Save.export()}:null)),$btnBar.append(createActionItem("import",null,L10n.get("savesLabelImport"),(function(){return $dialogBody.find("#saves-import-file").trigger("click")}))),jQuery(document.createElement("input")).css({display:"block",visibility:"hidden",position:"fixed",left:"-9999px",top:"-9999px",width:"1px",height:"1px"}).attr({type:"file",id:"saves-import-file",tabindex:-1,"aria-hidden":!0}).on("change",(function(ev){jQuery(document).one(":dialogclosed",(function(){return Save.import(ev)})),Dialog.close()})).appendTo($dialogBody)),savesOk&&$btnBar.append(createActionItem("clear",null,L10n.get("savesLabelClear"),Save.autosave.has()||!Save.slots.isEmpty()?function(){Save.clear(),uiBuildSaves()}:null)),!0}return uiOpenAlert(L10n.get("savesIncapable")),!1}function uiBuildSettings(){var $dialogBody=jQuery(Dialog.setup(L10n.get("settingsTitle"),"settings"));return Setting.forEach((function(control){if(control.type===Setting.Types.Header){var _name=control.name,_id=Util.slugify(_name),$header=jQuery(document.createElement("div")),$heading=jQuery(document.createElement("h2"));return $header.attr("id","header-body-".concat(_id)).append($heading).appendTo($dialogBody),$heading.attr("id","header-heading-".concat(_id)).wiki(_name),void(control.desc&&jQuery(document.createElement("p")).attr("id","header-desc-".concat(_id)).wiki(control.desc).appendTo($header))}var $control,name=control.name,id=Util.slugify(name),$setting=jQuery(document.createElement("div")),$label=jQuery(document.createElement("label")),$controlBox=jQuery(document.createElement("div"));switch(jQuery(document.createElement("div")).append($label).append($controlBox).appendTo($setting),control.desc&&jQuery(document.createElement("p")).attr("id","setting-desc-".concat(id)).wiki(control.desc).appendTo($setting),$label.attr({id:"setting-label-".concat(id),for:"setting-control-".concat(id)}).wiki(control.label),null==settings[name]&&(settings[name]=control.default),control.type){case Setting.Types.Toggle:$control=jQuery(document.createElement("button")),settings[name]?$control.addClass("enabled").text(L10n.get("settingsOn")):$control.text(L10n.get("settingsOff")),$control.ariaClick((function(){settings[name]?(jQuery(this).removeClass("enabled").text(L10n.get("settingsOff")),settings[name]=!1):(jQuery(this).addClass("enabled").text(L10n.get("settingsOn")),settings[name]=!0),Setting.save(),control.hasOwnProperty("onChange")&&control.onChange.call({name:name,value:settings[name],default:control.default})}));break;case Setting.Types.List:$control=jQuery(document.createElement("select"));for(var i=0,iend=control.list.length;i<iend;++i)jQuery(document.createElement("option")).val(i).text(control.list[i]).appendTo($control);$control.val(control.list.indexOf(settings[name])).attr("tabindex",0).on("change",(function(){settings[name]=control.list[Number(this.value)],Setting.save(),control.hasOwnProperty("onChange")&&control.onChange.call({name:name,value:settings[name],default:control.default,list:control.list})}));break;case Setting.Types.Range:($control=jQuery(document.createElement("input"))).attr({type:"range",min:control.min,max:control.max,step:control.step,value:settings[name],tabindex:0}).on("change input",(function(){settings[name]=Number(this.value),Setting.save(),control.hasOwnProperty("onChange")&&control.onChange.call({name:name,value:settings[name],default:control.default,min:control.min,max:control.max,step:control.step})})).on("keypress",(function(ev){13===ev.which&&(ev.preventDefault(),$control.trigger("change"))}))}$control.attr("id","setting-control-".concat(id)).appendTo($controlBox),$setting.attr("id","setting-body-".concat(id)).appendTo($dialogBody)})),$dialogBody.append('<ul class="buttons">'+'<li><button id="settings-ok" class="ui-close">'.concat(L10n.get(["settingsOk","ok"]),"</button></li>")+'<li><button id="settings-reset">'.concat(L10n.get("settingsReset"),"</button></li>")+"</ul>").find("#settings-reset").ariaClick({one:!0},(function(){jQuery(document).one(":dialogclosed",(function(){Setting.reset(),window.location.reload()})),Dialog.close()})),!0}function uiBuildShare(){try{jQuery(Dialog.setup(L10n.get("shareTitle"),"share list")).append(uiAssembleLinkList("StoryShare"))}catch(ex){return console.error(ex),Alert.error("StoryShare",ex.message),!1}return!0}return Object.freeze(Object.defineProperties({},{assembleLinkList:{value:uiAssembleLinkList},alert:{value:uiOpenAlert},jumpto:{value:function(){uiBuildJumpto(),Dialog.open.apply(Dialog,arguments)}},restart:{value:function(){uiBuildRestart(),Dialog.open.apply(Dialog,arguments)}},saves:{value:function(){uiBuildSaves(),Dialog.open.apply(Dialog,arguments)}},settings:{value:function(){uiBuildSettings(),Dialog.open.apply(Dialog,arguments)}},share:{value:function(){uiBuildShare(),Dialog.open.apply(Dialog,arguments)}},buildAutoload:{value:uiBuildAutoload},buildJumpto:{value:uiBuildJumpto},buildRestart:{value:uiBuildRestart},buildSaves:{value:uiBuildSaves},buildSettings:{value:uiBuildSettings},buildShare:{value:uiBuildShare},stow:{value:function(){return UIBar.stow()}},unstow:{value:function(){return UIBar.unstow()}},setStoryElements:{value:function(){return UIBar.update()}},isOpen:{value:function(){return Dialog.isOpen.apply(Dialog,arguments)}},body:{value:function(){return Dialog.body()}},setup:{value:function(){return Dialog.setup.apply(Dialog,arguments)}},addClickHandler:{value:function(){return Dialog.addClickHandler.apply(Dialog,arguments)}},open:{value:function(){return Dialog.open.apply(Dialog,arguments)}},close:{value:function(){return Dialog.close.apply(Dialog,arguments)}},resize:{value:function(){return Dialog.resize()}},buildDialogAutoload:{value:uiBuildAutoload},buildDialogJumpto:{value:uiBuildJumpto},buildDialogRestart:{value:uiBuildRestart},buildDialogSaves:{value:uiBuildSaves},buildDialogSettings:{value:uiBuildSettings},buildDialogShare:{value:uiBuildShare},buildLinkListFromPassage:{value:uiAssembleLinkList}}))}(),UIBar=function(){var _$uiBar=null;function uiBarStow(noAnimation){var $story;_$uiBar&&!_$uiBar.hasClass("stowed")&&(noAnimation&&(($story=jQuery("#story")).addClass("no-transition"),_$uiBar.addClass("no-transition")),_$uiBar.addClass("stowed"),noAnimation&&setTimeout((function(){$story.removeClass("no-transition"),_$uiBar.removeClass("no-transition")}),Engine.minDomActionDelay));return this}function uiBarUpdate(){if(Story.has("StoryDisplayTitle")&&setDisplayTitle(Story.get("StoryDisplayTitle").processText()),_$uiBar){setPageElement("story-banner","StoryBanner"),setPageElement("story-subtitle","StorySubtitle"),setPageElement("story-author","StoryAuthor"),setPageElement("story-caption","StoryCaption");var menuStory=document.getElementById("menu-story");if(null!==menuStory&&(jQuery(menuStory).empty(),Story.has("StoryMenu")))try{UI.assembleLinkList("StoryMenu",menuStory)}catch(ex){console.error(ex),Alert.error("StoryMenu",ex.message)}}}return Object.freeze(Object.defineProperties({},{destroy:{value:function(){_$uiBar&&(_$uiBar.hide(),jQuery(document).off(".ui-bar"),jQuery(document.head).find("#style-ui-bar").remove(),_$uiBar.remove(),_$uiBar=null)}},hide:{value:function(){return _$uiBar&&_$uiBar.hide(),this}},init:{value:function(){if(!document.getElementById("ui-bar")){var toggleLabel,backwardLabel,jumptoLabel,forwardLabel,$backward,$forward,$elems=(toggleLabel=L10n.get("uiBarToggle"),backwardLabel=L10n.get("uiBarBackward"),jumptoLabel=L10n.get("uiBarJumpto"),forwardLabel=L10n.get("uiBarForward"),jQuery(document.createDocumentFragment()).append('<div id="ui-bar" aria-live="polite"><div id="ui-bar-tray">'+'<button id="ui-bar-toggle" tabindex="0" title="'.concat(toggleLabel,'" aria-label="').concat(toggleLabel,'"></button>')+'<div id="ui-bar-history">'+'<button id="history-backward" tabindex="0" title="'.concat(backwardLabel,'" aria-label="').concat(backwardLabel,'"></button>')+'<button id="history-jumpto" tabindex="0" title="'.concat(jumptoLabel,'" aria-label="').concat(jumptoLabel,'"></button>')+'<button id="history-forward" tabindex="0" title="'.concat(forwardLabel,'" aria-label="').concat(forwardLabel,'"></button>')+'</div></div><div id="ui-bar-body"><header id="title" role="banner"><div id="story-banner"></div><h1 id="story-title"></h1><div id="story-subtitle"></div><div id="story-title-separator"></div><p id="story-author"></p></header><div id="story-caption"></div><nav id="menu" role="navigation"><ul id="menu-story"></ul><ul id="menu-core">'+'<li id="menu-item-saves"><a tabindex="0">'.concat(L10n.get("savesTitle"),"</a></li>")+'<li id="menu-item-settings"><a tabindex="0">'.concat(L10n.get("settingsTitle"),"</a></li>")+'<li id="menu-item-restart"><a tabindex="0">'.concat(L10n.get("restartTitle"),"</a></li>")+'<li id="menu-item-share"><a tabindex="0">'.concat(L10n.get("shareTitle"),"</a></li>")+"</ul></nav></div></div>"));_$uiBar=jQuery($elems.find("#ui-bar").get(0)),$elems.insertBefore("body>script#script-sugarcube"),jQuery(document).on(":historyupdate.ui-bar",($backward=jQuery("#history-backward"),$forward=jQuery("#history-forward"),function(){$backward.ariaDisabled(State.length<2),$forward.ariaDisabled(State.length===State.size)}))}}},isHidden:{value:function(){return _$uiBar&&"none"===_$uiBar.css("display")}},isStowed:{value:function(){return _$uiBar&&_$uiBar.hasClass("stowed")}},show:{value:function(){return _$uiBar&&_$uiBar.show(),this}},start:{value:function(){_$uiBar&&(("boolean"==typeof Config.ui.stowBarInitially?Config.ui.stowBarInitially:jQuery(window).width()<=Config.ui.stowBarInitially)&&uiBarStow(!0),jQuery("#ui-bar-toggle").ariaClick({label:L10n.get("uiBarToggle")},(function(){return _$uiBar.toggleClass("stowed")})),Config.history.controls?(jQuery("#history-backward").ariaDisabled(State.length<2).ariaClick({label:L10n.get("uiBarBackward")},(function(){return Engine.backward()})),Story.lookup("tags","bookmark").length>0?jQuery("#history-jumpto").ariaClick({label:L10n.get("uiBarJumpto")},(function(){return UI.jumpto()})):jQuery("#history-jumpto").remove(),jQuery("#history-forward").ariaDisabled(State.length===State.size).ariaClick({label:L10n.get("uiBarForward")},(function(){return Engine.forward()}))):jQuery("#ui-bar-history").remove(),Story.has("StoryDisplayTitle")?setDisplayTitle(Story.get("StoryDisplayTitle").processText()):jQuery("#story-title").text(Story.title),Story.has("StoryCaption")||jQuery("#story-caption").remove(),Story.has("StoryMenu")||jQuery("#menu-story").remove(),Config.ui.updateStoryElements||uiBarUpdate(),jQuery("#menu-item-saves a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),UI.buildSaves(),Dialog.open()})).text(L10n.get("savesTitle")),Setting.isEmpty()?jQuery("#menu-item-settings").remove():jQuery("#menu-item-settings a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),UI.buildSettings(),Dialog.open()})).text(L10n.get("settingsTitle")),jQuery("#menu-item-restart a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),UI.buildRestart(),Dialog.open()})).text(L10n.get("restartTitle")),Story.has("StoryShare")?jQuery("#menu-item-share a").ariaClick({role:"button"},(function(ev){ev.preventDefault(),UI.buildShare(),Dialog.open()})).text(L10n.get("shareTitle")):jQuery("#menu-item-share").remove())}},stow:{value:uiBarStow},unstow:{value:function(noAnimation){var $story;return _$uiBar&&_$uiBar.hasClass("stowed")&&(noAnimation&&(($story=jQuery("#story")).addClass("no-transition"),_$uiBar.addClass("no-transition")),_$uiBar.removeClass("stowed"),noAnimation&&setTimeout((function(){$story.removeClass("no-transition"),_$uiBar.removeClass("no-transition")}),Engine.minDomActionDelay)),this}},update:{value:uiBarUpdate},setStoryElements:{value:uiBarUpdate}}))}(),DebugBar=function(){var _variableRe=new RegExp("^".concat(Patterns.variable,"$")),_numericKeyRe=/^\d+$/,_watchList=[],_$debugBar=null,_$watchBody=null,_$watchList=null,_$turnSelect=null,_stowed=!0;function debugBarStow(){_$debugBar.css("right","-".concat(_$debugBar.outerWidth(),"px")),_stowed=!0,_updateSession()}function debugBarUnstow(){_$debugBar.css("right",0),_stowed=!1,_updateSession()}function debugBarToggle(){_stowed?debugBarUnstow():debugBarStow()}function debugBarWatchAdd(varName){_variableRe.test(varName)&&(_watchList.pushUnique(varName),_watchList.sort(),_updateWatchBody(),_updateWatchList(),_updateSession())}function debugBarWatchAddAll(){Object.keys(State.variables).map((function(name){return _watchList.pushUnique("$".concat(name))})),Object.keys(State.temporary).map((function(name){return _watchList.pushUnique("_".concat(name))})),_watchList.sort(),_updateWatchBody(),_updateWatchList(),_updateSession()}function debugBarWatchClear(){for(var i=_watchList.length-1;i>=0;--i)_watchList.pop();_updateWatchBody(),_updateWatchList(),_updateSession()}function debugBarWatchDelete(varName){_watchList.delete(varName),_updateWatchBody(),_updateWatchList(),_updateSession()}function debugBarWatchDisable(){_debugBarWatchDisableNoUpdate(),_updateSession()}function debugBarWatchEnable(){_debugBarWatchEnableNoUpdate(),_updateSession()}function debugBarWatchIsEnabled(){return!_$watchBody.attr("hidden")}function debugBarWatchToggle(){_$watchBody.attr("hidden")?debugBarWatchEnable():debugBarWatchDisable()}function _debugBarWatchDisableNoUpdate(){_$watchBody.attr({"aria-hidden":!0,hidden:"hidden"})}function _debugBarWatchEnableNoUpdate(){_$watchBody.removeAttr("aria-hidden hidden")}function _clearSession(){session.delete("debugState")}function _hasSession(){return session.has("debugState")}function _updateSession(){session.set("debugState",{stowed:_stowed,watchList:_watchList,watchEnabled:debugBarWatchIsEnabled(),viewsEnabled:DebugView.isEnabled()})}function _updateWatchBody(){if(0!==_watchList.length){for(var delLabel=L10n.get("debugBarDeleteWatch"),$table=jQuery(document.createElement("table")),$tbody=jQuery(document.createElement("tbody")),_loop4=function(i,len){var varName=_watchList[i],varKey=varName.slice(1),store="$"===varName[0]?State.variables:State.temporary,$row=jQuery(document.createElement("tr")),$delBtn=jQuery(document.createElement("button")),$code=jQuery(document.createElement("code"));$delBtn.addClass("watch-delete").attr("data-name",varName).ariaClick({one:!0,label:delLabel},(function(){return debugBarWatchDelete(varName)})),$code.text(_toWatchString(store[varKey])),jQuery(document.createElement("td")).append($delBtn).appendTo($row),jQuery(document.createElement("td")).text(varName).appendTo($row),jQuery(document.createElement("td")).append($code).appendTo($row),$row.appendTo($tbody)},i=0,len=_watchList.length;i<len;++i)_loop4(i);$table.append($tbody),_$watchBody.empty().append($table)}else _$watchBody.empty().append("<div>".concat(L10n.get("debugBarNoWatches"),"</div>"))}function _updateWatchList(){var svn=Object.keys(State.variables),tvn=Object.keys(State.temporary);if(0!==svn.length||0!==tvn.length){var names=[].concat(_toConsumableArray(svn.map((function(name){return"$".concat(name)}))),_toConsumableArray(tvn.map((function(name){return"_".concat(name)})))).sort(),options=document.createDocumentFragment();names.delete(_watchList);for(var i=0,len=names.length;i<len;++i)jQuery(document.createElement("option")).val(names[i]).appendTo(options);_$watchList.empty().append(options)}else _$watchList.empty()}function _updateTurnSelect(){for(var histLen=State.size,expLen=State.expired.length,options=document.createDocumentFragment(),i=0;i<histLen;++i)jQuery(document.createElement("option")).val(i).text("".concat(expLen+i+1,". ").concat(Util.escape(State.history[i].title))).appendTo(options);_$turnSelect.empty().ariaDisabled(histLen<2).append(options).val(State.activeIndex)}function _toWatchString(value){if(null===value)return"null";switch(_typeof(value)){case"number":if(Number.isNaN(value))return"NaN";if(!Number.isFinite(value))return"Infinity";case"boolean":case"symbol":case"undefined":return String(value);case"string":return JSON.stringify(value);case"function":return"Function"}var objType=Util.toStringTag(value);if("Date"===objType)return"Date {".concat(value.toLocaleString(),"}");if("RegExp"===objType)return"RegExp ".concat(value.toString());var result=[];if(value instanceof Array||value instanceof Set){for(var list=value instanceof Array?value:Array.from(value),i=0,len=list.length;i<len;++i)result.push(list.hasOwnProperty(i)?_toWatchString(list[i]):"<empty>");return Object.keys(list).filter((function(key){return!_numericKeyRe.test(key)})).forEach((function(key){return result.push("".concat(_toWatchString(key),": ").concat(_toWatchString(list[key])))})),"".concat(objType,"(").concat(list.length,") [").concat(result.join(", "),"]")}return value instanceof Map?(value.forEach((function(val,key){return result.push("".concat(_toWatchString(key)," → ").concat(_toWatchString(val)))})),"".concat(objType,"(").concat(value.size,") {").concat(result.join(", "),"}")):(Object.keys(value).forEach((function(key){return result.push("".concat(_toWatchString(key),": ").concat(_toWatchString(value[key])))})),"".concat(objType," {").concat(result.join(", "),"}"))}return Object.freeze(Object.defineProperties({},{init:{value:function(){var barToggleLabel=L10n.get("debugBarToggle"),watchAddLabel=L10n.get("debugBarAddWatch"),watchAllLabel=L10n.get("debugBarWatchAll"),watchNoneLabel=L10n.get("debugBarWatchNone"),watchToggleLabel=L10n.get("debugBarWatchToggle"),viewsToggleLabel=L10n.get("debugBarViewsToggle");jQuery(document.createDocumentFragment()).append('<div id="debug-bar"><div id="debug-bar-watch">'+"<div>".concat(L10n.get("debugBarNoWatches"),"</div>>")+"</div><div>"+'<button id="debug-bar-watch-toggle" tabindex="0" title="'.concat(watchToggleLabel,'" aria-label="').concat(watchToggleLabel,'">').concat(L10n.get("debugBarLabelWatch"),"</button>")+'<label id="debug-bar-watch-label" for="debug-bar-watch-input">'.concat(L10n.get("debugBarLabelAdd"),"</label>")+'<input id="debug-bar-watch-input" name="debug-bar-watch-input" type="text" list="debug-bar-watch-list" tabindex="0"><datalist id="debug-bar-watch-list" aria-hidden="true" hidden="hidden"></datalist>'+'<button id="debug-bar-watch-add" tabindex="0" title="'.concat(watchAddLabel,'" aria-label="').concat(watchAddLabel,'"></button>')+'<button id="debug-bar-watch-all" tabindex="0" title="'.concat(watchAllLabel,'" aria-label="').concat(watchAllLabel,'"></button>')+'<button id="debug-bar-watch-none" tabindex="0" title="'.concat(watchNoneLabel,'" aria-label="').concat(watchNoneLabel,'"></button>')+"</div><div>"+'<button id="debug-bar-views-toggle" tabindex="0" title="'.concat(viewsToggleLabel,'" aria-label="').concat(viewsToggleLabel,'">').concat(L10n.get("debugBarLabelViews"),"</button>")+'<label id="debug-bar-turn-label" for="debug-bar-turn-select">'.concat(L10n.get("debugBarLabelTurn"),"</label>")+'<select id="debug-bar-turn-select" tabindex="0"></select></div>'+'<button id="debug-bar-toggle" tabindex="0" title="'.concat(barToggleLabel,'" aria-label="').concat(barToggleLabel,'"></button>')+'</div><div id="debug-bar-hint"></div>').appendTo("body"),_$debugBar=jQuery("#debug-bar"),_$watchBody=jQuery(_$debugBar.find("#debug-bar-watch").get(0)),_$watchList=jQuery(_$debugBar.find("#debug-bar-watch-list").get(0)),_$turnSelect=jQuery(_$debugBar.find("#debug-bar-turn-select").get(0));var $barToggle=jQuery(_$debugBar.find("#debug-bar-toggle").get(0)),$watchToggle=jQuery(_$debugBar.find("#debug-bar-watch-toggle").get(0)),$watchInput=jQuery(_$debugBar.find("#debug-bar-watch-input").get(0)),$watchAdd=jQuery(_$debugBar.find("#debug-bar-watch-add").get(0)),$watchAll=jQuery(_$debugBar.find("#debug-bar-watch-all").get(0)),$watchNone=jQuery(_$debugBar.find("#debug-bar-watch-none").get(0)),$viewsToggle=jQuery(_$debugBar.find("#debug-bar-views-toggle").get(0));$barToggle.ariaClick(debugBarToggle),$watchToggle.ariaClick(debugBarWatchToggle),$watchInput.on(":addwatch",(function(){debugBarWatchAdd(this.value.trim()),this.value=""})).on("keypress",(function(ev){13===ev.which&&(ev.preventDefault(),$watchInput.trigger(":addwatch"))})),$watchAdd.ariaClick((function(){return $watchInput.trigger(":addwatch")})),$watchAll.ariaClick(debugBarWatchAddAll),$watchNone.ariaClick(debugBarWatchClear),_$turnSelect.on("change",(function(){Engine.goTo(Number(this.value))})),$viewsToggle.ariaClick((function(){DebugView.toggle(),_updateSession()})),jQuery(document).on(":historyupdate.debug-bar",_updateTurnSelect).on(":passageend.debug-bar",(function(){_updateWatchBody(),_updateWatchList()})).on(":enginerestart.debug-bar",_clearSession),_hasSession()||DebugView.enable()}},isStowed:{value:function(){return _stowed}},start:{value:function(){(function(){if(!_hasSession())return!1;var debugState=session.get("debugState");_stowed=debugState.stowed,_watchList.push.apply(_watchList,_toConsumableArray(debugState.watchList)),debugState.watchEnabled?_debugBarWatchEnableNoUpdate():_debugBarWatchDisableNoUpdate();debugState.viewsEnabled?DebugView.enable():DebugView.disable()})(),_stowed?debugBarStow():debugBarUnstow(),_updateTurnSelect(),_updateWatchBody(),_updateWatchList()}},stow:{value:debugBarStow},toggle:{value:debugBarToggle},unstow:{value:debugBarUnstow},watch:{value:Object.freeze(Object.defineProperties({},{add:{value:debugBarWatchAdd},all:{value:debugBarWatchAddAll},clear:{value:debugBarWatchClear},delete:{value:debugBarWatchDelete},disable:{value:debugBarWatchDisable},enable:{value:debugBarWatchEnable},isEnabled:{value:debugBarWatchIsEnabled},toggle:{value:debugBarWatchToggle}}))}}))}(),LoadScreen=function(){var _locks=new Set,_autoId=0;function loadScreenHide(){jQuery(document.documentElement).removeAttr("data-init")}function loadScreenShow(){jQuery(document.documentElement).attr("data-init","loading")}return Object.freeze(Object.defineProperties({},{init:{value:function(){jQuery(document).on("readystatechange.SugarCube",(function(){_locks.size>0||("complete"===document.readyState?"loading"===jQuery(document.documentElement).attr("data-init")&&(Config.loadDelay>0?setTimeout((function(){0===_locks.size&&loadScreenHide()}),Math.max(Engine.minDomActionDelay,Config.loadDelay)):loadScreenHide()):loadScreenShow())}))}},clear:{value:function(){jQuery(document).off("readystatechange.SugarCube"),_locks.clear(),loadScreenHide()}},hide:{value:loadScreenHide},show:{value:loadScreenShow},lock:{value:function(){return++_autoId,_locks.add(_autoId),loadScreenShow(),_autoId}},unlock:{value:function(id){if(null==id)throw new Error("LoadScreen.unlock called with a null or undefined ID");_locks.has(id)&&_locks.delete(id),0===_locks.size&&jQuery(document).trigger("readystatechange")}}}))}(),version=Object.freeze({title:"SugarCube",major:2,minor:36,patch:1,prerelease:null,build:9717,date:new Date("2021-12-22T05:37:33.467Z"),extensions:{},toString:function(){var prerelease=this.prerelease?"-".concat(this.prerelease):"";return"".concat(this.major,".").concat(this.minor,".").concat(this.patch).concat(prerelease,"+").concat(this.build)},short:function(){var prerelease=this.prerelease?"-".concat(this.prerelease):"";return"".concat(this.title," (v").concat(this.major,".").concat(this.minor,".").concat(this.patch).concat(prerelease,")")},long:function(){return"".concat(this.title," v").concat(this.toString()," (").concat(this.date.toUTCString(),")")}}),TempState={},macros={},postdisplay={},postrender={},predisplay={},prehistory={},prerender={},session=null,settings={},setup={},storage=null,browser=Browser,config=Config,has=Has,History=State,state=State,tale=Story,TempVariables=State.temporary;window.SugarCube={},jQuery((function(){try{var lockId=LoadScreen.lock();LoadScreen.init(),document.normalize&&document.normalize(),Story.load(),storage=SimpleStore.create(Story.domId,!0),session=SimpleStore.create(Story.domId,!1),Dialog.init(),UIBar.init(),Engine.init(),Story.init(),L10n.init(),session.has("rcWarn")||"cookie"!==storage.name||(session.set("rcWarn",1),window.alert(L10n.get("warningNoWebStorage"))),Save.init(),Setting.init(),Macro.init(),Engine.start(),Config.debug&&DebugBar.init();var $window=$(window),vprCheckId=setInterval((function(){$window.width()&&(clearInterval(vprCheckId),UIBar.start(),Config.debug&&DebugBar.start(),jQuery.event.trigger({type:":storyready"}),setTimeout((function(){return LoadScreen.unlock(lockId)}),2*Engine.minDomActionDelay))}),Engine.minDomActionDelay);Object.defineProperty(window,"SugarCube",{value:Object.seal(Object.assign(Object.create(null),{Browser:Browser,Config:Config,Dialog:Dialog,Engine:Engine,Fullscreen:Fullscreen,Has:Has,L10n:L10n,Macro:Macro,Passage:Passage,Save:Save,Scripting:Scripting,Setting:Setting,SimpleAudio:SimpleAudio,State:State,Story:Story,UI:UI,UIBar:UIBar,DebugBar:DebugBar,Util:Util,Visibility:Visibility,Wikifier:Wikifier,session:session,settings:settings,setup:setup,storage:storage,version:version}))})}catch(ex){return console.error(ex),LoadScreen.clear(),Alert.fatal(null,ex.message,ex)}}))})(window,window.document,jQuery);}
	</script>
</body>
</html>
